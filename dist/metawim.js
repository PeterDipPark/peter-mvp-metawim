var MetaWim=function(){"use strict";
/**
	 * @license
	 * PlayCanvas Engine v1.52.1 revision 0f56653b1
	 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
	 */Array.prototype.fill||Object.defineProperty(Array.prototype,"fill",{value:function(t){if(null==this)throw new TypeError("this is null or not defined");for(var e=Object(this),s=e.length>>>0,i=arguments[1],n=i>>0,a=n<0?Math.max(s+n,0):Math.min(n,s),r=arguments[2],o=void 0===r?s:r>>0,l=o<0?Math.max(s+o,0):Math.min(o,s);a<l;)e[a]=t,a++;return e}}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(t){if(null==this)throw TypeError('"this" is null or not defined');var e=Object(this),s=e.length>>>0;if("function"!=typeof t)throw TypeError("predicate must be a function");for(var i=arguments[1],n=0;n<s;){var a=e[n];if(t.call(i,a,n,e))return a;n++}},configurable:!0,writable:!0}),Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(t){if(null==this)throw new TypeError('"this" is null or not defined');var e=Object(this),s=e.length>>>0;if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var i=arguments[1],n=0;n<s;){var a=e[n];if(t.call(i,a,n,e))return n;n++}return-1},configurable:!0,writable:!0}),Math.log2=Math.log2||function(t){return Math.log(t)*Math.LOG2E},Math.sign||(Math.sign=function(t){return(t>0)-(t<0)||+t}),void 0===Number.isFinite&&(Number.isFinite=function(t){return"number"==typeof t&&isFinite(t)}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t,e){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var s=Object(t),i=1;i<arguments.length;i++){var n=arguments[i];if(null!=n)for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(s[a]=n[a])}return s},writable:!0,configurable:!0}),function(){if("undefined"!=typeof navigator&&"undefined"!=typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var t=function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(t)},e=function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(t)};document.addEventListener("webkitpointerlockchange",t,!1),document.addEventListener("webkitpointerlocklost",t,!1),document.addEventListener("mozpointerlockchange",t,!1),document.addEventListener("mozpointerlocklost",t,!1),document.addEventListener("webkitpointerlockerror",e,!1),document.addEventListener("mozpointerlockerror",e,!1),Element.prototype.mozRequestPointerLock?Element.prototype.requestPointerLock=function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock=Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this,navigator.pointer.lock(this,t,e)}),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock,document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}}(),function(){if("undefined"!=typeof window){for(var t=0,e=["ms","moz","webkit","o"],s=0;s<e.length&&!window.requestAnimationFrame;++s)window.requestAnimationFrame=window[e[s]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[s]+"CancelAnimationFrame"]||window[e[s]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,s){var i=(new Date).getTime(),n=Math.max(0,16-(i-t)),a=window.setTimeout((function(){e(i+n)}),n);return t=i+n,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}}(),String.prototype.endsWith||(String.prototype.endsWith=function(t,e){return(void 0===e||e>this.length)&&(e=this.length),this.substring(e-t.length,e)===t}),String.prototype.includes||(String.prototype.includes=function(t,e){return"number"!=typeof e&&(e=0),!(e+t.length>this.length)&&-1!==this.indexOf(t,e)}),String.prototype.startsWith||(String.prototype.startsWith=function(t,e){return this.substr(!e||e<0?0:+e,t.length)===t}),Int8Array.prototype.fill||(Int8Array.prototype.fill=Array.prototype.fill),Uint8Array.prototype.fill||(Uint8Array.prototype.fill=Array.prototype.fill),Uint8ClampedArray.prototype.fill||(Uint8ClampedArray.prototype.fill=Array.prototype.fill),Int16Array.prototype.fill||(Int16Array.prototype.fill=Array.prototype.fill),Uint16Array.prototype.fill||(Uint16Array.prototype.fill=Array.prototype.fill),Int32Array.prototype.fill||(Int32Array.prototype.fill=Array.prototype.fill),Uint32Array.prototype.fill||(Uint32Array.prototype.fill=Array.prototype.fill),Float32Array.prototype.fill||(Float32Array.prototype.fill=Array.prototype.fill);var t={};function e(e,s){var i;t[e]=!0,void 0!==s&&(i=s,window.console&&window.console.error&&window.console.error(i))}var s=function t(e){var s=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(var i=0;i<this.attribs.length;i++){var n=new t.VertexAttrib(s);this.attribs[i]=n}this.maxAttrib=0};(s.VertexAttrib=function(t){this.enabled=!1,this.buffer=null,this.size=4,this.type=t.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var i=function(e){var s=this;this.gl=e,function(e){var s=e.getError;e.getError=function(){do{(i=s.apply(e))!=e.NO_ERROR&&(t[i]=!0)}while(i!=e.NO_ERROR);for(var i in t)if(t[i])return delete t[i],parseInt(i);return e.NO_ERROR}}(e);var i=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(t){return t==s.VERTEX_ARRAY_BINDING_OES?s.currentVertexArrayObject==s.defaultVertexArrayObject?null:s.currentVertexArrayObject:i.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(t){var e=s.currentVertexArrayObject;e.maxAttrib=Math.max(e.maxAttrib,t);var n=e.attribs[t];return n.enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(t){var e=s.currentVertexArrayObject;e.maxAttrib=Math.max(e.maxAttrib,t);var n=e.attribs[t];return n.enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(t,n){switch(t){case e.ARRAY_BUFFER:s.currentArrayBuffer=n;break;case e.ELEMENT_ARRAY_BUFFER:s.currentVertexArrayObject.elementArrayBuffer=n}return i.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(t,n){var a=s.currentVertexArrayObject,r=a.attribs[t];switch(n){case e.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return r.buffer;case e.VERTEX_ATTRIB_ARRAY_ENABLED:return r.enabled;case e.VERTEX_ATTRIB_ARRAY_SIZE:return r.size;case e.VERTEX_ATTRIB_ARRAY_STRIDE:return r.stride;case e.VERTEX_ATTRIB_ARRAY_TYPE:return r.type;case e.VERTEX_ATTRIB_ARRAY_NORMALIZED:return r.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(t,e,n,a,r,o){var l=s.currentVertexArrayObject;l.maxAttrib=Math.max(l.maxAttrib,t);var h=l.attribs[t];return h.buffer=s.currentArrayBuffer,h.size=e,h.type=n,h.normalized=a,h.stride=r,h.offset=o,h.recache(),i.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas.addEventListener("webglcontextrestored",(function(){var t;t="OESVertexArrayObject emulation library context restored",window.console&&window.console.log&&window.console.log(t),s.reset_()}),!0),this.reset_()};i.prototype.VERTEX_ARRAY_BINDING_OES=34229,i.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var t=0;t<this.vertexArrayObjects.length;++t)this.vertexArrayObjects.isAlive=!1;var e=this.gl;this.maxVertexAttribs=e.getParameter(e.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new s(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},i.prototype.createVertexArrayOES=function(){var t=new s(this);return this.vertexArrayObjects.push(t),t},i.prototype.deleteVertexArrayOES=function(t){t.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(t),1),this.currentVertexArrayObject==t&&this.bindVertexArrayOES(null)},i.prototype.isVertexArrayOES=function(t){return!!(t&&t instanceof s&&t.hasBeenBound&&t.ext==this)},i.prototype.bindVertexArrayOES=function(t){var s=this.gl;if(!t||t.isAlive){var i=this.original,n=this.currentVertexArrayObject;this.currentVertexArrayObject=t||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var a=this.currentVertexArrayObject;if(n!=a){n&&a.elementArrayBuffer==n.elementArrayBuffer||i.bindBuffer.call(s,s.ELEMENT_ARRAY_BUFFER,a.elementArrayBuffer);for(var r=this.currentArrayBuffer,o=Math.max(n?n.maxAttrib:0,a.maxAttrib),l=0;l<=o;l++){var h=a.attribs[l],c=n?n.attribs[l]:null;if(n&&h.enabled==c.enabled||(h.enabled?i.enableVertexAttribArray.call(s,l):i.disableVertexAttribArray.call(s,l)),h.enabled){var d=!1;n&&h.buffer==c.buffer||(r!=h.buffer&&(i.bindBuffer.call(s,s.ARRAY_BUFFER,h.buffer),r=h.buffer),d=!0),(d||h.cached!=c.cached)&&i.vertexAttribPointer.call(s,l,h.size,h.type,h.normalized,h.stride,h.offset)}}this.currentArrayBuffer!=r&&i.bindBuffer.call(s,s.ARRAY_BUFFER,this.currentArrayBuffer)}}else e(s.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")};const n=function(){const t={},e=["Array","Object","Function","Date","RegExp","Float32Array"];for(let s=0;s<e.length;s++)t["[object "+e[s]+"]"]=e[s].toLowerCase();return t}();function a(t){if(null===t)return"null";const e=typeof t;return"undefined"===e||"number"===e||"string"===e||"boolean"===e?e:n[Object.prototype.toString.call(t)]}function r(t,e){for(const s in e){const i=e[s];"object"===a(i)?t[s]=r({},i):"array"===a(i)?t[s]=r([],i):t[s]=i}return t}function o(t){return undefined!==t}class EventHandler{constructor(){this._callbacks={},this._callbackActive={}}initEventHandler(){this._callbacks={},this._callbackActive={}}_addCallback(t,e,s,i=!1){t&&"string"==typeof t&&e&&(this._callbacks[t]||(this._callbacks[t]=[]),this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].push({callback:e,scope:s||this,once:i}))}on(t,e,s){return this._addCallback(t,e,s,!1),this}off(t,e,s){if(t)this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());else for(const i in this._callbackActive)this._callbacks[i]&&this._callbacks[i]===this._callbackActive[i]&&(this._callbackActive[i]=this._callbackActive[i].slice());if(t)if(e){const i=this._callbacks[t];if(!i)return this;let n=i.length;for(let t=0;t<n;t++)i[t].callback===e&&(s&&i[t].scope!==s||(i[t--]=i[--n]));i.length=n}else this._callbacks[t]&&(this._callbacks[t]=[]);else this._callbacks={};return this}fire(t,e,s,i,n,a,r,o,l){if(!t||!this._callbacks[t])return this;let h;this._callbackActive[t]?(this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),h=this._callbacks[t].slice()):this._callbackActive[t]=this._callbacks[t];for(let c=0;(h||this._callbackActive[t])&&c<(h||this._callbackActive[t]).length;c++){const d=(h||this._callbackActive[t])[c];if(d.callback.call(d.scope,e,s,i,n,a,r,o,l),d.once){const e=this._callbacks[t],s=e?e.indexOf(d):-1;-1!==s&&(this._callbackActive[t]===e&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].splice(s,1))}}return h||(this._callbackActive[t]=null),this}once(t,e,s){return this._addCallback(t,e,s,!0),this}hasEvent(t){return this._callbacks[t]&&0!==this._callbacks[t].length||!1}}const l={attach:function(t){const e=l;return t._addCallback=e._addCallback,t.on=e.on,t.off=e.off,t.fire=e.fire,t.once=e.once,t.hasEvent=e.hasEvent,t._callbacks={},t._callbackActive={},t},_addCallback:EventHandler.prototype._addCallback,on:EventHandler.prototype.on,off:EventHandler.prototype.off,fire:EventHandler.prototype.fire,once:EventHandler.prototype.once,hasEvent:EventHandler.prototype.hasEvent},h=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))},c={delimiter:"/",join:function(){const t=arguments.length;let e=arguments[0];for(let s=0;s<t-1;++s){const t=arguments[s],i=arguments[s+1];if(!o(t)||!o(i))throw new Error("undefined argument to pc.path.join");i[0]!==c.delimiter?t&&i&&t[t.length-1]!==c.delimiter&&i[0]!==c.delimiter?e+=c.delimiter+i:e+=i:e=i}return e},normalize:function(t){const e=t.startsWith(c.delimiter),s=t.endsWith(c.delimiter),i=t.split("/");let n="",a=[];for(let r=0;r<i.length;r++)""!==i[r]&&"."!==i[r]&&(".."===i[r]&&a.length>0?a=a.slice(0,a.length-2):(r>0&&a.push(c.delimiter),a.push(i[r])));return n=a.join(""),e||n[0]!==c.delimiter||(n=n.slice(1)),s&&n[n.length-1]!==c.delimiter&&(n+=c.delimiter),n},split:function(t){const e=t.split(c.delimiter),s=e.slice(e.length-1)[0];return[e.slice(0,e.length-1).join(c.delimiter),s]},getBasename:function(t){return c.split(t)[1]},getDirectory:function(t){const e=t.split(c.delimiter);return e.slice(0,e.length-1).join(c.delimiter)},getExtension:function(t){const e=t.split("?")[0].split(".").pop();return e!==t?"."+e:""},isRelativePath:function(t){return"/"!==t.charAt(0)&&null===t.match(/:\/\//)},extractPath:function(t){let e="";const s=t.split("/");let i=0;if(s.length>1)if(c.isRelativePath(t))if("."===s[0])for(i=0;i<s.length-1;++i)e+=0===i?s[i]:"/"+s[i];else if(".."===s[0])for(i=0;i<s.length-1;++i)e+=0===i?s[i]:"/"+s[i];else for(e=".",i=0;i<s.length-1;++i)e+="/"+s[i];else for(i=0;i<s.length-1;++i)e+=0===i?s[i]:"/"+s[i];return e}};let d=!1,u=!1,p=!1,m=!1,_=!1,f=!1,g=!1,y=!1,v=!1,b=!1;if("undefined"!=typeof navigator){const t=navigator.userAgent;/(windows|mac os|linux|cros)/i.test(t)&&(d=!0),/xbox/i.test(t)&&(m=!0),/(windows phone|iemobile|wpdesktop)/i.test(t)?(d=!1,u=!0,p=!0):/android/i.test(t)?(d=!1,u=!0,_=!0):/ip([ao]d|hone)/i.test(t)&&(d=!1,u=!0,f=!0),"undefined"!=typeof window&&(g="ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),y="getGamepads"in navigator,v="undefined"!=typeof Worker;try{const t=Object.defineProperty({},"passive",{get:function(){return b=!0,!1}});window.addEventListener("testpassive",null,t),window.removeEventListener("testpassive",null,t)}catch($u){}}const x="undefined"!=typeof window?"browser":"node",S={environment:x,global:"browser"===x?window:global,browser:"browser"===x,desktop:d,mobile:u,ios:f,android:_,windows:p,xbox:m,gamepads:y,touch:g,workers:v,passiveEvents:b},w="abcdefghijklmnopqrstuvwxyz",C="ABCDEFGHIJKLMNOPQRSTUVWXYZ",T=55296,M=127462,A=127487,P=65024,E=65039;function L(t,e=0){const s=t.length;if(e<0||e>=s)return null;const i=t.charCodeAt(e);if(s>1&&i>=T&&i<=56319){const s=t.charCodeAt(e+1);if(s>=56320&&s<=57343)return{code:1024*(i-T)+s-56320+65536,long:!0}}return{code:i,long:!1}}function R(t,e,s){if(!t)return!1;const i=L(t);if(i){const t=i.code;return t>=e&&t<=s}return!1}function I(t,e){if(e===t.length-1)return 1;if(R(t[e],T,56319)){const s=t.substring(e,e+2),i=t.substring(e+2,e+4);return R(i,127995,127999)||R(s,M,A)&&R(i,M,A)?4:R(i,P,E)?3:2}return R(t[e+1],P,E)?2:1}const D={ASCII_LOWERCASE:w,ASCII_UPPERCASE:C,ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",format:function(t){for(let e=1;e<arguments.length;e++)t=t.replace("{"+(e-1)+"}",arguments[e]);return t},toBool:function(t,e=!1){if("true"===t)return!0;if(e){if("false"===t)return!1;throw new TypeError("Not a boolean string")}return!1},getCodePoint:function(t,e){const s=L(t,e);return s&&s.code},getCodePoints:function(t){if("string"!=typeof t)throw new TypeError("Not a string");let e=0;const s=[];let i;for(;i=L(t,e);)s.push(i.code),e+=i.long?2:1;return s},getSymbols:function(t){if("string"!=typeof t)throw new TypeError("Not a string");let e=0;const s=t.length,i=[];let n,a=0;for(;e<s;){if(a+=I(t,e+a),n=t[e+a],R(n,8400,8447)&&(n=t[e+a++]),R(n,P,E)&&(n=t[e+a++]),n&&8205===n.charCodeAt(0)){n=t[e+a++];continue}const s=t.substring(e,e+a);i.push(s),e+=a,a=0}return i},fromCodePoint:function(){const t=[];let e,s,i;for(let n=0;n<arguments.length;++n)e=Number(arguments[n]),s=e-65536,i=e>65535?[55296+(s>>10),s%1024+56320]:[e],t.push(String.fromCharCode.apply(null,i));return t.join("")}};class IndexedList{constructor(){this._list=[],this._index={}}push(t,e){if(this._index[t])throw Error("Key already in index "+t);const s=this._list.push(e)-1;this._index[t]=s}has(t){return void 0!==this._index[t]}get(t){const e=this._index[t];return void 0!==e?this._list[e]:null}remove(t){const e=this._index[t];if(void 0!==e){for(t in this._list.splice(e,1),delete this._index[t],this._index){const s=this._index[t];s>e&&(this._index[t]=s-1)}return!0}return!1}list(){return this._list}clear(){this._list.length=0;for(const t in this._index)delete this._index[t]}}class ReadStream{constructor(t){this.arraybuffer=t,this.dataView=new DataView(t),this.offset=0,this.stack=[]}get remainingBytes(){return this.dataView.byteLength-this.offset}reset(t=0){this.offset=t}skip(t){this.offset+=t}align(t){this.offset=this.offset+t-1&~(t-1)}_inc(t){return this.offset+=t,this.offset-t}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(t){let e="";for(let s=0;s<t;++s)e+=this.readChar();return e}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(t){for(let e=0;e<t.length;++e)t[e]=this.readU8()}readLine(){const t=this.dataView;let e="";for(;!(this.offset>=t.byteLength);){const t=String.fromCharCode(this.readU8());if("\n"===t)break;e+=t}return e}}class SortedLoopArray{constructor(t){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=t.sortBy,this._sortHandler=this._doSort.bind(this)}_binarySearch(t){let e=0,s=this.items.length-1;const i=t[this._sortBy];let n,a;for(;e<=s;)n=Math.floor((e+s)/2),a=this.items[n][this._sortBy],a<=i?e=n+1:a>i&&(s=n-1);return e}_doSort(t,e){const s=this._sortBy;return t[s]-e[s]}insert(t){const e=this._binarySearch(t);this.items.splice(e,0,t),this.length++,this.loopIndex>=e&&this.loopIndex++}append(t){this.items.push(t),this.length++}remove(t){const e=this.items.indexOf(t);e<0||(this.items.splice(e,1),this.length--,this.loopIndex>=e&&this.loopIndex--)}sort(){const t=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==t&&(this.loopIndex=this.items.indexOf(t))}}class Tags extends EventHandler{constructor(t){super(),this._index={},this._list=[],this._parent=t}add(){let t=!1;const e=this._processArguments(arguments,!0);if(!e.length)return t;for(let s=0;s<e.length;s++)this._index[e[s]]||(t=!0,this._index[e[s]]=!0,this._list.push(e[s]),this.fire("add",e[s],this._parent));return t&&this.fire("change",this._parent),t}remove(){let t=!1;if(!this._list.length)return t;const e=this._processArguments(arguments,!0);if(!e.length)return t;for(let s=0;s<e.length;s++)this._index[e[s]]&&(t=!0,delete this._index[e[s]],this._list.splice(this._list.indexOf(e[s]),1),this.fire("remove",e[s],this._parent));return t&&this.fire("change",this._parent),t}clear(){if(!this._list.length)return;const t=this._list.slice(0);this._list=[],this._index={};for(let e=0;e<t.length;e++)this.fire("remove",t[e],this._parent);this.fire("change",this._parent)}has(){return!!this._list.length&&this._has(this._processArguments(arguments))}_has(t){if(!this._list.length||!t.length)return!1;for(let e=0;e<t.length;e++)if(1===t[e].length){if(this._index[t[e][0]])return!0}else{let s=!0;for(let i=0;i<t[e].length;i++)if(!this._index[t[e][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(t,e){const s=[];let i=[];if(!t||!t.length)return s;for(let n=0;n<t.length;n++)if(t[n]instanceof Array){e||(i=[]);for(let a=0;a<t[n].length;a++)"string"==typeof t[n][a]&&(e?s.push(t[n][a]):i.push(t[n][a]));!e&&i.length&&s.push(i)}else"string"==typeof t[n]&&(e?s.push(t[n]):s.push([t[n]]));return s}get size(){return this._list.length}}const k="undefined"!=typeof window&&window.performance&&window.performance.now&&window.performance.timing?function(){return window.performance.now()}:Date.now,F=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class URI{constructor(t){const e=t.match(F);this.scheme=e[2],this.authority=e[4],this.path=e[5],this.query=e[7],this.fragment=e[9]}toString(){let t="";return this.scheme&&(t+=this.scheme+":"),this.authority&&(t+="//"+this.authority),t+=this.path,this.query&&(t+="?"+this.query),this.fragment&&(t+="#"+this.fragment),t}getQuery(){const t={};if(this.query){const e=decodeURIComponent(this.query).split("&");for(const s of e){const e=s.split("=");t[e[0]]=e[1]}}return t}setQuery(t){let e="";for(const s in t)t.hasOwnProperty(s)&&(""!==e&&(e+="&"),e+=encodeURIComponent(s)+"="+encodeURIComponent(t[s]));this.query=e}}const O={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(t,e,s){return t>=s?s:t<=e?e:t},intToBytes24:function(t){return[t>>16&255,t>>8&255,255&t]},intToBytes32:function(t){return[t>>24&255,t>>16&255,t>>8&255,255&t]},bytesToInt24:function(t,e,s){return t.length&&(s=t[2],e=t[1],t=t[0]),t<<16|e<<8|s},bytesToInt32:function(t,e,s,i){return t.length&&(i=t[3],s=t[2],e=t[1],t=t[0]),(t<<24|e<<16|s<<8|i)>>>0},lerp:function(t,e,s){return t+(e-t)*O.clamp(s,0,1)},lerpAngle:function(t,e,s){return e-t>180&&(e-=360),e-t<-180&&(e+=360),O.lerp(t,e,O.clamp(s,0,1))},powerOfTwo:function(t){return 0!==t&&!(t&t-1)},nextPowerOfTwo:function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},random:function(t,e){const s=e-t;return Math.random()*s+t},smoothstep:function(t,e,s){return s<=t?0:s>=e?1:(s=(s-t)/(e-t))*s*(3-2*s)},smootherstep:function(t,e,s){return s<=t?0:s>=e?1:(s=(s-t)/(e-t))*s*s*(s*(6*s-15)+10)},roundUp:function(t,e){return 0===e?t:Math.ceil(t/e)*e},between:function(t,e,s,i){const n=Math.min(e,s),a=Math.max(e,s);return i?t>=n&&t<=a:t>n&&t<a}};class Http{get(t,e,s){return"function"==typeof e&&(s=e,e={}),this.request("GET",t,e,s)}post(t,e,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=e,this.request("POST",t,s,i)}put(t,e,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=e,this.request("PUT",t,s,i)}del(t,e,s){return"function"==typeof e&&(s=e,e={}),this.request("DELETE",t,e,s)}request(t,e,s,i){let n,a,o,l=!1;if("function"==typeof s&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,null==s.async&&(s.async=!0),null==s.headers&&(s.headers={}),null!=s.postdata)if(s.postdata instanceof Document)o=s.postdata;else if(s.postdata instanceof FormData)o=s.postdata;else if(s.postdata instanceof Object){let t=s.headers["Content-Type"];switch(void 0===t&&(s.headers["Content-Type"]=Http.ContentType.FORM_URLENCODED,t=s.headers["Content-Type"]),t){case Http.ContentType.FORM_URLENCODED:{o="";let t=!0;for(const e in s.postdata)if(s.postdata.hasOwnProperty(e)){t?t=!1:o+="&";o+=`${encodeURIComponent(e)}=${encodeURIComponent(s.postdata[e])}`}break}default:case Http.ContentType.JSON:null==t&&(s.headers["Content-Type"]=Http.ContentType.JSON),o=JSON.stringify(s.postdata)}}else o=s.postdata;if(!1===s.cache){const t=k();n=new URI(e),n.query?n.query=n.query+"&ts="+t:n.query="ts="+t,e=n.toString()}s.query&&(n=new URI(e),a=r(n.getQuery(),s.query),n.setQuery(a),e=n.toString());const h=new XMLHttpRequest;h.open(t,e,s.async),h.withCredentials=void 0!==s.withCredentials&&s.withCredentials,h.responseType=s.responseType||this._guessResponseType(e);for(const r in s.headers)s.headers.hasOwnProperty(r)&&h.setRequestHeader(r,s.headers[r]);h.onreadystatechange=()=>{this._onReadyStateChange(t,e,s,h)},h.onerror=()=>{this._onError(t,e,s,h),l=!0};try{h.send(o)}catch($u){l||s.error(h.status,h,$u)}return h}_guessResponseType(t){const e=new URI(t),s=c.getExtension(e.path);return Http.binaryExtensions.indexOf(s)>=0?Http.ResponseType.ARRAY_BUFFER:".xml"===s?Http.ResponseType.DOCUMENT:Http.ResponseType.TEXT}_isBinaryContentType(t){return[Http.ContentType.MP4,Http.ContentType.WAV,Http.ContentType.OGG,Http.ContentType.MP3,Http.ContentType.BIN,Http.ContentType.DDS,Http.ContentType.BASIS,Http.ContentType.GLB].indexOf(t)>=0}_onReadyStateChange(t,e,s,i){if(4===i.readyState)switch(i.status){case 0:i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(t,e,s,i):this._onError(t,e,s,i);break;case 200:case 201:case 206:case 304:this._onSuccess(t,e,s,i);break;default:this._onError(t,e,s,i)}}_onSuccess(t,e,s,i){let n,a;const r=i.getResponseHeader("Content-Type");if(r){a=r.split(";")[0].trim()}try{n=a===Http.ContentType.JSON||e.split("?")[0].endsWith(".json")?JSON.parse(i.responseText):this._isBinaryContentType(a)||i.responseType===Http.ResponseType.ARRAY_BUFFER||i.responseType===Http.ResponseType.BLOB||i.responseType===Http.ResponseType.JSON?i.response:i.responseType===Http.ResponseType.DOCUMENT||a===Http.ContentType.XML?i.responseXML:i.responseText,s.callback(null,n)}catch(o){s.callback(o)}}_onError(t,e,s,i){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;const n=O.clamp(Math.pow(2,s.retries)*Http.retryDelay,0,s.maxRetryDelay||5e3);console.log(`${t}: ${e} - Error ${i.status}. Retrying in ${n} ms`),setTimeout((()=>{s.retrying=!1,this.request(t,e,s,s.callback)}),n)}else s.callback(0===i.status?"Network error":i.status,null)}}Http.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary"},Http.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},Http.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb"],Http.retryDelay=100;const V=new Http;class Color{constructor(t=0,e=0,s=0,i=1){const n=t.length;3===n||4===n?(this.r=t[0],this.g=t[1],this.b=t[2],this.a=void 0!==t[3]?t[3]:1):(this.r=t,this.g=e,this.b=s,this.a=i)}clone(){return new Color(this.r,this.g,this.b,this.a)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}equals(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}set(t,e,s,i=1){return this.r=t,this.g=e,this.b=s,this.a=i,this}lerp(t,e,s){return this.r=t.r+s*(e.r-t.r),this.g=t.g+s*(e.g-t.g),this.b=t.b+s*(e.b-t.b),this.a=t.a+s*(e.a-t.a),this}fromString(t){const e=parseInt(t.replace("#","0x"),16);let s;return t.length>7?s=O.intToBytes32(e):(s=O.intToBytes24(e),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}toString(t){let e="#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);if(!0===t){const t=Math.round(255*this.a).toString(16);this.a<16/255?e+="0"+t:e+=t}return e}}Color.BLACK=Object.freeze(new Color(0,0,0,1)),Color.BLUE=Object.freeze(new Color(0,0,1,1)),Color.CYAN=Object.freeze(new Color(0,1,1,1)),Color.GRAY=Object.freeze(new Color(.5,.5,.5,1)),Color.GREEN=Object.freeze(new Color(0,1,0,1)),Color.MAGENTA=Object.freeze(new Color(1,0,1,1)),Color.RED=Object.freeze(new Color(1,0,0,1)),Color.WHITE=Object.freeze(new Color(1,1,1,1)),Color.YELLOW=Object.freeze(new Color(1,1,0,1));class CurveEvaluator{constructor(t,e=0){this._curve=t,this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._reset(e)}evaluate(t,e=!1){let s;(e||t<this._left||t>=this._right)&&this._reset(t);const i=this._curve.type;if(5===i)s=this._p0;else{const e=0===this._recip?0:(t-this._left)*this._recip;s=0===i?O.lerp(this._p0,this._p1,e):1===i?O.lerp(this._p0,this._p1,e*e*(3-2*e)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,e)}return s}_reset(t){const e=this._curve.keys,s=e.length;if(s)if(t<e[0][0])this._left=-1/0,this._right=e[0][0],this._recip=0,this._p0=this._p1=e[0][1],this._m0=this._m1=0;else if(t>=e[s-1][0])this._left=e[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=e[s-1][1],this._m0=this._m1=0;else{let s=0;for(;t>=e[s+1][0];)s++;this._left=e[s][0],this._right=e[s+1][0];const i=1/(this._right-this._left);this._recip=isFinite(i)?i:0,this._p0=e[s][1],this._p1=e[s+1][1],this._isHermite()&&this._calcTangents(e,s)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0}_isHermite(){return 2===this._curve.type||3===this._curve.type||4===this._curve.type}_calcTangents(t,e){let s;const i=t[e],n=t[e+1];let a;if(s=0===e?[t[0][0]+(t[0][0]-t[1][0]),t[0][1]+(t[0][1]-t[1][1])]:t[e-1],a=e===t.length-2?[t[e+1][0]+(t[e+1][0]-t[e][0]),t[e+1][1]+(t[e+1][1]-t[e][1])]:t[e+2],4===this._curve.type){const t=2*(n[0]-i[0])/(n[0]-s[0]),e=2*(n[0]-i[0])/(a[0]-i[0]);this._m0=this._curve.tension*(isFinite(t)?t:0)*(n[1]-s[1]),this._m1=this._curve.tension*(isFinite(e)?e:0)*(a[1]-i[1])}else{const t=(n[0]-i[0])/(i[0]-s[0]),e=(n[0]-i[0])/(a[0]-n[0]),r=i[1]+(s[1]-i[1])*(isFinite(t)?t:0),o=n[1]+(a[1]-n[1])*(isFinite(e)?e:0),l=2===this._curve.type?.5:this._curve.tension;this._m0=l*(n[1]-r),this._m1=l*(o-i[1])}}_evaluateHermite(t,e,s,i,n){const a=n*n,r=n+n,o=1-n,l=o*o;return t*((1+r)*l)+s*(n*l)+e*(a*(3-r))+i*(a*(n-1))}}class Curve{constructor(t){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new CurveEvaluator(this),t)for(let e=0;e<t.length-1;e+=2)this.keys.push([t[e],t[e+1]]);this.sort()}get length(){return this.keys.length}add(t,e){const s=this.keys,i=s.length;let n=0;for(;n<i&&!(s[n][0]>t);n++);const a=[t,e];return this.keys.splice(n,0,a),a}get(t){return this.keys[t]}sort(){this.keys.sort((function(t,e){return t[0]-e[0]}))}value(t){return this._eval.evaluate(t,!0)}closest(t){const e=this.keys,s=e.length;let i=2,n=null;for(let a=0;a<s;a++){const s=Math.abs(t-e[a][0]);if(!(i>=s))break;i=s,n=e[a]}return n}clone(){const t=new Curve;return t.keys=r(t.keys,this.keys),t.type=this.type,t.tension=this.tension,t}quantize(t){t=Math.max(t,2);const e=new Float32Array(t),s=1/(t-1);e[0]=this._eval.evaluate(0,!0);for(let i=1;i<t;i++)e[i]=this._eval.evaluate(s*i);return e}quantizeClamped(t,e,s){const i=this.quantize(t);for(let n=0;n<i.length;++n)i[n]=Math.min(s,Math.max(e,i[n]));return i}}class CurveSet{constructor(){if(this.curves=[],this._type=1,arguments.length>1)for(let t=0;t<arguments.length;t++)this.curves.push(new Curve(arguments[t]));else if(0===arguments.length)this.curves.push(new Curve);else{const t=arguments[0];if("number"==typeof t)for(let e=0;e<t;e++)this.curves.push(new Curve);else for(let e=0;e<t.length;e++)this.curves.push(new Curve(t[e]))}}get length(){return this.curves.length}set type(t){this._type=t;for(let e=0;e<this.curves.length;e++)this.curves[e].type=t}get type(){return this._type}get(t){return this.curves[t]}value(t,e=[]){const s=this.curves.length;e.length=s;for(let i=0;i<s;i++)e[i]=this.curves[i].value(t);return e}clone(){const t=new CurveSet;t.curves=[];for(let e=0;e<this.curves.length;e++)t.curves.push(this.curves[e].clone());return t._type=this._type,t}quantize(t){t=Math.max(t,2);const e=this.curves.length,s=new Float32Array(t*e),i=1/(t-1);for(let n=0;n<e;n++){const a=new CurveEvaluator(this.curves[n]);for(let r=0;r<t;r++)s[r*e+n]=a.evaluate(i*r)}return s}quantizeClamped(t,e,s){const i=this.quantize(t);for(let n=0;n<i.length;++n)i[n]=Math.min(s,Math.max(e,i[n]));return i}}class Vec3{constructor(t=0,e=0,s=0){3===t.length?(this.x=t[0],this.y=t[1],this.z=t[2]):(this.x=t,this.y=e,this.z=s)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}clone(){return new Vec3(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}cross(t,e){const s=t.x,i=t.y,n=t.z,a=e.x,r=e.y,o=e.z;return this.x=i*o-r*n,this.y=n*a-o*s,this.z=s*r-a*i,this}distance(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return Math.sqrt(e*e+s*s+i*i)}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}normalize(){const t=this.x*this.x+this.y*this.y+this.z*this.z;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),this}project(t){const e=(this.x*t.x+this.y*t.y+this.z*t.z)/(t.x*t.x+t.y*t.y+t.z*t.z);return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}}Vec3.ZERO=Object.freeze(new Vec3(0,0,0)),Vec3.ONE=Object.freeze(new Vec3(1,1,1)),Vec3.UP=Object.freeze(new Vec3(0,1,0)),Vec3.DOWN=Object.freeze(new Vec3(0,-1,0)),Vec3.RIGHT=Object.freeze(new Vec3(1,0,0)),Vec3.LEFT=Object.freeze(new Vec3(-1,0,0)),Vec3.FORWARD=Object.freeze(new Vec3(0,0,-1)),Vec3.BACK=Object.freeze(new Vec3(0,0,1));class Mat3{constructor(){const t=new Float32Array(9);t[0]=t[4]=t[8]=1,this.data=t}clone(){return(new Mat3).copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]}isIdentity(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&1===t[4]&&0===t[5]&&0===t[6]&&0===t[7]&&1===t[8]}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this}toString(){let t="[";for(let e=0;e<9;e++)t+=this.data[e],t+=8!==e?", ":"";return t+="]",t}transpose(){const t=this.data;let e;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}setFromMat4(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[4],s[4]=e[5],s[5]=e[6],s[6]=e[8],s[7]=e[9],s[8]=e[10],this}transformVector(t,e=new Vec3){const s=this.data,i=t.x,n=t.y,a=t.z;return e.x=i*s[0]+n*s[3]+a*s[6],e.y=i*s[1]+n*s[4]+a*s[7],e.z=i*s[2]+n*s[5]+a*s[8],e}}Mat3.IDENTITY=Object.freeze(new Mat3),Mat3.ZERO=Object.freeze((new Mat3).set([0,0,0,0,0,0,0,0,0]));class Vec2{constructor(t=0,e=0){2===t.length?(this.x=t[0],this.y=t[1]):(this.x=t,this.y=e)}add(t){return this.x+=t.x,this.y+=t.y,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScalar(t){return this.x+=t,this.y+=t,this}clone(){return new Vec2(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}cross(t){return this.x*t.y-this.y*t.x}distance(t){const e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)}div(t){return this.x/=t.x,this.y/=t.y,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this}divScalar(t){return this.x/=t,this.y/=t,this}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this}mul(t){return this.x*=t.x,this.y*=t.y,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this}mulScalar(t){return this.x*=t,this.y*=t,this}normalize(){const t=this.x*this.x+this.y*this.y;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),this}set(t,e){return this.x=t,this.y=e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}subScalar(t){return this.x-=t,this.y-=t,this}toString(){return`[${this.x}, ${this.y}]`}static angleRad(t,e){return Math.atan2(t.x*e.y-t.y*e.x,t.x*e.x+t.y*e.y)}}Vec2.ZERO=Object.freeze(new Vec2(0,0)),Vec2.ONE=Object.freeze(new Vec2(1,1)),Vec2.UP=Object.freeze(new Vec2(0,1)),Vec2.DOWN=Object.freeze(new Vec2(0,-1)),Vec2.RIGHT=Object.freeze(new Vec2(1,0)),Vec2.LEFT=Object.freeze(new Vec2(-1,0));class Vec4{constructor(t=0,e=0,s=0,i=0){4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=i)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}clone(){return new Vec4(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this.w=t.w/e.w,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this.w/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this.w=t.w+s*(e.w-t.w),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this.w=t.w*e.w,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}normalize(){const t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e,this.w*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}Vec4.ZERO=Object.freeze(new Vec4(0,0,0,0)),Vec4.ONE=Object.freeze(new Vec4(1,1,1,1));const B=new Vec2,z=new Vec3,U=new Vec3,N=new Vec3,H=new Vec3;class Mat4{constructor(){const t=new Float32Array(16);t[0]=t[5]=t[10]=t[15]=1,this.data=t}static _getPerspectiveHalfSize(t,e,s,i,n){n?(t.x=i*Math.tan(e*Math.PI/360),t.y=t.x/s):(t.y=i*Math.tan(e*Math.PI/360),t.x=t.y*s)}add2(t,e){const s=t.data,i=e.data,n=this.data;return n[0]=s[0]+i[0],n[1]=s[1]+i[1],n[2]=s[2]+i[2],n[3]=s[3]+i[3],n[4]=s[4]+i[4],n[5]=s[5]+i[5],n[6]=s[6]+i[6],n[7]=s[7]+i[7],n[8]=s[8]+i[8],n[9]=s[9]+i[9],n[10]=s[10]+i[10],n[11]=s[11]+i[11],n[12]=s[12]+i[12],n[13]=s[13]+i[13],n[14]=s[14]+i[14],n[15]=s[15]+i[15],this}add(t){return this.add2(this,t)}clone(){return(new Mat4).copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],this}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]&&e[9]===s[9]&&e[10]===s[10]&&e[11]===s[11]&&e[12]===s[12]&&e[13]===s[13]&&e[14]===s[14]&&e[15]===s[15]}isIdentity(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]}mul2(t,e){const s=t.data,i=e.data,n=this.data,a=s[0],r=s[1],o=s[2],l=s[3],h=s[4],c=s[5],d=s[6],u=s[7],p=s[8],m=s[9],_=s[10],f=s[11],g=s[12],y=s[13],v=s[14],b=s[15];let x,S,w,C;return x=i[0],S=i[1],w=i[2],C=i[3],n[0]=a*x+h*S+p*w+g*C,n[1]=r*x+c*S+m*w+y*C,n[2]=o*x+d*S+_*w+v*C,n[3]=l*x+u*S+f*w+b*C,x=i[4],S=i[5],w=i[6],C=i[7],n[4]=a*x+h*S+p*w+g*C,n[5]=r*x+c*S+m*w+y*C,n[6]=o*x+d*S+_*w+v*C,n[7]=l*x+u*S+f*w+b*C,x=i[8],S=i[9],w=i[10],C=i[11],n[8]=a*x+h*S+p*w+g*C,n[9]=r*x+c*S+m*w+y*C,n[10]=o*x+d*S+_*w+v*C,n[11]=l*x+u*S+f*w+b*C,x=i[12],S=i[13],w=i[14],C=i[15],n[12]=a*x+h*S+p*w+g*C,n[13]=r*x+c*S+m*w+y*C,n[14]=o*x+d*S+_*w+v*C,n[15]=l*x+u*S+f*w+b*C,this}mulAffine2(t,e){const s=t.data,i=e.data,n=this.data,a=s[0],r=s[1],o=s[2],l=s[4],h=s[5],c=s[6],d=s[8],u=s[9],p=s[10],m=s[12],_=s[13],f=s[14];let g,y,v;return g=i[0],y=i[1],v=i[2],n[0]=a*g+l*y+d*v,n[1]=r*g+h*y+u*v,n[2]=o*g+c*y+p*v,n[3]=0,g=i[4],y=i[5],v=i[6],n[4]=a*g+l*y+d*v,n[5]=r*g+h*y+u*v,n[6]=o*g+c*y+p*v,n[7]=0,g=i[8],y=i[9],v=i[10],n[8]=a*g+l*y+d*v,n[9]=r*g+h*y+u*v,n[10]=o*g+c*y+p*v,n[11]=0,g=i[12],y=i[13],v=i[14],n[12]=a*g+l*y+d*v+m,n[13]=r*g+h*y+u*v+_,n[14]=o*g+c*y+p*v+f,n[15]=1,this}mul(t){return this.mul2(this,t)}transformPoint(t,e=new Vec3){const s=this.data,i=t.x,n=t.y,a=t.z;return e.x=i*s[0]+n*s[4]+a*s[8]+s[12],e.y=i*s[1]+n*s[5]+a*s[9]+s[13],e.z=i*s[2]+n*s[6]+a*s[10]+s[14],e}transformVector(t,e=new Vec3){const s=this.data,i=t.x,n=t.y,a=t.z;return e.x=i*s[0]+n*s[4]+a*s[8],e.y=i*s[1]+n*s[5]+a*s[9],e.z=i*s[2]+n*s[6]+a*s[10],e}transformVec4(t,e=new Vec4){const s=this.data,i=t.x,n=t.y,a=t.z,r=t.w;return e.x=i*s[0]+n*s[4]+a*s[8]+r*s[12],e.y=i*s[1]+n*s[5]+a*s[9]+r*s[13],e.z=i*s[2]+n*s[6]+a*s[10]+r*s[14],e.w=i*s[3]+n*s[7]+a*s[11]+r*s[15],e}setLookAt(t,e,s){N.sub2(t,e).normalize(),U.copy(s).normalize(),z.cross(U,N).normalize(),U.cross(N,z);const i=this.data;return i[0]=z.x,i[1]=z.y,i[2]=z.z,i[3]=0,i[4]=U.x,i[5]=U.y,i[6]=U.z,i[7]=0,i[8]=N.x,i[9]=N.y,i[10]=N.z,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}setFrustum(t,e,s,i,n,a){const r=2*n,o=e-t,l=i-s,h=a-n,c=this.data;return c[0]=r/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=r/l,c[6]=0,c[7]=0,c[8]=(e+t)/o,c[9]=(i+s)/l,c[10]=(-a-n)/h,c[11]=-1,c[12]=0,c[13]=0,c[14]=-r*a/h,c[15]=0,this}setPerspective(t,e,s,i,n){return Mat4._getPerspectiveHalfSize(B,t,e,s,n),this.setFrustum(-B.x,B.x,-B.y,B.y,s,i)}setOrtho(t,e,s,i,n,a){const r=this.data;return r[0]=2/(e-t),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2/(i-s),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=-2/(a-n),r[11]=0,r[12]=-(e+t)/(e-t),r[13]=-(i+s)/(i-s),r[14]=-(a+n)/(a-n),r[15]=1,this}setFromAxisAngle(t,e){e*=O.DEG_TO_RAD;const s=t.x,i=t.y,n=t.z,a=Math.cos(e),r=Math.sin(e),o=1-a,l=o*s,h=o*i,c=this.data;return c[0]=l*s+a,c[1]=l*i+r*n,c[2]=l*n-r*i,c[3]=0,c[4]=l*i-r*n,c[5]=h*i+a,c[6]=h*n+r*s,c[7]=0,c[8]=l*n+r*i,c[9]=h*n-s*r,c[10]=o*n*n+a,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}setTranslate(t,e,s){const i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=t,i[13]=e,i[14]=s,i[15]=1,this}setScale(t,e,s){const i=this.data;return i[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(t,e,s,i){const n=this.data;return n[0]=.5*s,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=.5*i,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=.5,n[11]=0,n[12]=t+.5*s,n[13]=e+.5*i,n[14]=.5,n[15]=1,this}invert(){const t=this.data,e=t[0],s=t[1],i=t[2],n=t[3],a=t[4],r=t[5],o=t[6],l=t[7],h=t[8],c=t[9],d=t[10],u=t[11],p=t[12],m=t[13],_=t[14],f=t[15],g=e*r-s*a,y=e*o-i*a,v=e*l-n*a,b=s*o-i*r,x=s*l-n*r,S=i*l-n*o,w=h*m-c*p,C=h*_-d*p,T=h*f-u*p,M=c*_-d*m,A=c*f-u*m,P=d*f-u*_,E=g*P-y*A+v*M+b*T-x*C+S*w;if(0===E)this.setIdentity();else{const L=1/E;t[0]=(r*P-o*A+l*M)*L,t[1]=(-s*P+i*A-n*M)*L,t[2]=(m*S-_*x+f*b)*L,t[3]=(-c*S+d*x-u*b)*L,t[4]=(-a*P+o*T-l*C)*L,t[5]=(e*P-i*T+n*C)*L,t[6]=(-p*S+_*v-f*y)*L,t[7]=(h*S-d*v+u*y)*L,t[8]=(a*A-r*T+l*w)*L,t[9]=(-e*A+s*T-n*w)*L,t[10]=(p*x-m*v+f*g)*L,t[11]=(-h*x+c*v-u*g)*L,t[12]=(-a*M+r*C-o*w)*L,t[13]=(e*M-s*C+i*w)*L,t[14]=(-p*b+m*y-_*g)*L,t[15]=(h*b-c*y+d*g)*L}return this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}setTRS(t,e,s){const i=e.x,n=e.y,a=e.z,r=e.w,o=s.x,l=s.y,h=s.z,c=i+i,d=n+n,u=a+a,p=i*c,m=i*d,_=i*u,f=n*d,g=n*u,y=a*u,v=r*c,b=r*d,x=r*u,S=this.data;return S[0]=(1-(f+y))*o,S[1]=(m+x)*o,S[2]=(_-b)*o,S[3]=0,S[4]=(m-x)*l,S[5]=(1-(p+y))*l,S[6]=(g+v)*l,S[7]=0,S[8]=(_+b)*h,S[9]=(g-v)*h,S[10]=(1-(p+f))*h,S[11]=0,S[12]=t.x,S[13]=t.y,S[14]=t.z,S[15]=1,this}transpose(){let t;const e=this.data;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}invertTo3x3(t){const e=this.data,s=t.data,i=e[0],n=e[1],a=e[2],r=e[4],o=e[5],l=e[6],h=e[8],c=e[9],d=e[10],u=d*o-l*c,p=-d*n+a*c,m=l*n-a*o,_=-d*r+l*h,f=d*i-a*h,g=-l*i+a*r,y=c*r-o*h,v=-c*i+n*h,b=o*i-n*r,x=i*u+n*_+a*y;if(0===x)return this;const S=1/x;return s[0]=S*u,s[1]=S*p,s[2]=S*m,s[3]=S*_,s[4]=S*f,s[5]=S*g,s[6]=S*y,s[7]=S*v,s[8]=S*b,this}getTranslation(t=new Vec3){return t.set(this.data[12],this.data[13],this.data[14])}getX(t=new Vec3){return t.set(this.data[0],this.data[1],this.data[2])}getY(t=new Vec3){return t.set(this.data[4],this.data[5],this.data[6])}getZ(t=new Vec3){return t.set(this.data[8],this.data[9],this.data[10])}getScale(t=new Vec3){return this.getX(z),this.getY(U),this.getZ(N),t.set(z.length(),U.length(),N.length()),t}setFromEulerAngles(t,e,s){t*=O.DEG_TO_RAD,e*=O.DEG_TO_RAD,s*=O.DEG_TO_RAD;const i=Math.sin(-t),n=Math.cos(-t),a=Math.sin(-e),r=Math.cos(-e),o=Math.sin(-s),l=Math.cos(-s),h=this.data;return h[0]=r*l,h[1]=-r*o,h[2]=a,h[3]=0,h[4]=n*o+l*i*a,h[5]=n*l-i*a*o,h[6]=-r*i,h[7]=0,h[8]=i*o-n*l*a,h[9]=l*i+n*a*o,h[10]=n*r,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this}getEulerAngles(t=new Vec3){this.getScale(H);const e=H.x,s=H.y,i=H.z;if(0===e||0===s||0===i)return t.set(0,0,0);const n=this.data,a=Math.asin(-n[2]/e),r=.5*Math.PI;let o,l;return a<r?a>-r?(o=Math.atan2(n[6]/s,n[10]/i),l=Math.atan2(n[1]/e,n[0]/e)):(l=0,o=-Math.atan2(n[4]/s,n[5]/s)):(l=0,o=Math.atan2(n[4]/s,n[5]/s)),t.set(o,a,l).mulScalar(O.RAD_TO_DEG)}toString(){let t="[";for(let e=0;e<16;e+=1)t+=this.data[e],t+=15!==e?", ":"";return t+="]",t}}Mat4.IDENTITY=Object.freeze(new Mat4),Mat4.ZERO=Object.freeze((new Mat4).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));class Quat{constructor(t=0,e=0,s=0,i=1){4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=i)}clone(){return new Quat(this.x,this.y,this.z,this.w)}conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}getAxisAngle(t){let e=2*Math.acos(this.w);const s=Math.sin(e/2);return 0!==s?(t.x=this.x/s,t.y=this.y/s,t.z=this.z/s,(t.x<0||t.y<0||t.z<0)&&(t.x*=-1,t.y*=-1,t.z*=-1,e*=-1)):(t.x=1,t.y=0,t.z=0),e*O.RAD_TO_DEG}getEulerAngles(t=new Vec3){let e,s,i;const n=this.x,a=this.y,r=this.z,o=this.w,l=2*(o*a-n*r);return l<=-.99999?(e=2*Math.atan2(n,o),s=-Math.PI/2,i=0):l>=.99999?(e=2*Math.atan2(n,o),s=Math.PI/2,i=0):(e=Math.atan2(2*(o*n+a*r),1-2*(n*n+a*a)),s=Math.asin(l),i=Math.atan2(2*(o*r+n*a),1-2*(a*a+r*r))),t.set(e,s,i).mulScalar(O.RAD_TO_DEG)}invert(){return this.conjugate().normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(t){const e=this.x,s=this.y,i=this.z,n=this.w,a=t.x,r=t.y,o=t.z,l=t.w;return this.x=n*a+e*l+s*o-i*r,this.y=n*r+s*l+i*a-e*o,this.z=n*o+i*l+e*r-s*a,this.w=n*l-e*a-s*r-i*o,this}mul2(t,e){const s=t.x,i=t.y,n=t.z,a=t.w,r=e.x,o=e.y,l=e.z,h=e.w;return this.x=a*r+s*h+i*l-n*o,this.y=a*o+i*h+n*r-s*l,this.z=a*l+n*h+s*o-i*r,this.w=a*h-s*r-i*o-n*l,this}normalize(){let t=this.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}setFromAxisAngle(t,e){e*=.5*O.DEG_TO_RAD;const s=Math.sin(e),i=Math.cos(e);return this.x=s*t.x,this.y=s*t.y,this.z=s*t.z,this.w=i,this}setFromEulerAngles(t,e,s){const i=.5*O.DEG_TO_RAD;t*=i,e*=i,s*=i;const n=Math.sin(t),a=Math.cos(t),r=Math.sin(e),o=Math.cos(e),l=Math.sin(s),h=Math.cos(s);return this.x=n*o*h-a*r*l,this.y=a*r*h+n*o*l,this.z=a*o*l-n*r*h,this.w=a*o*h+n*r*l,this}setFromMat4(t){let e,s,i,n,a,r,o,l,h,c,d,u,p,m;if(e=(t=t.data)[0],s=t[1],i=t[2],n=t[4],a=t[5],r=t[6],o=t[8],l=t[9],h=t[10],u=e*e+s*s+i*i,0===u)return this;if(u=1/Math.sqrt(u),p=n*n+a*a+r*r,0===p)return this;if(p=1/Math.sqrt(p),m=o*o+l*l+h*h,0===m)return this;m=1/Math.sqrt(m),e*=u,s*=u,i*=u,n*=p,a*=p,r*=p,o*=m,l*=m,h*=m;const _=e+a+h;return _>=0?(c=Math.sqrt(_+1),this.w=.5*c,c=.5/c,this.x=(r-l)*c,this.y=(o-i)*c,this.z=(s-n)*c):e>a?e>h?(d=e-(a+h)+1,d=Math.sqrt(d),this.x=.5*d,d=.5/d,this.w=(r-l)*d,this.y=(s+n)*d,this.z=(i+o)*d):(d=h-(e+a)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(s-n)*d,this.x=(o+i)*d,this.y=(l+r)*d):a>h?(d=a-(h+e)+1,d=Math.sqrt(d),this.y=.5*d,d=.5/d,this.w=(o-i)*d,this.z=(r+l)*d,this.x=(n+s)*d):(d=h-(e+a)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(s-n)*d,this.x=(o+i)*d,this.y=(l+r)*d),this}slerp(t,e,s){const i=t.x,n=t.y,a=t.z,r=t.w;let o=e.x,l=e.y,h=e.z,c=e.w,d=r*c+i*o+n*l+a*h;if(d<0&&(c=-c,o=-o,l=-l,h=-h,d=-d),Math.abs(d)>=1)return this.w=r,this.x=i,this.y=n,this.z=a,this;const u=Math.acos(d),p=Math.sqrt(1-d*d);if(Math.abs(p)<.001)return this.w=.5*r+.5*c,this.x=.5*i+.5*o,this.y=.5*n+.5*l,this.z=.5*a+.5*h,this;const m=Math.sin((1-s)*u)/p,_=Math.sin(s*u)/p;return this.w=r*m+c*_,this.x=i*m+o*_,this.y=n*m+l*_,this.z=a*m+h*_,this}transformVector(t,e=new Vec3){const s=t.x,i=t.y,n=t.z,a=this.x,r=this.y,o=this.z,l=this.w,h=l*s+r*n-o*i,c=l*i+o*s-a*n,d=l*n+a*i-r*s,u=-a*s-r*i-o*n;return e.x=h*l+u*-a+c*-o-d*-r,e.y=c*l+u*-r+d*-a-h*-o,e.z=d*l+u*-o+h*-r-c*-a,e}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}Quat.IDENTITY=Object.freeze(new Quat(0,0,0,1)),Quat.ZERO=Object.freeze(new Quat(0,0,0,0));const W=new Vec3,G=new Vec3,j=new Vec3,X=new Vec3,q=new Vec3;class BoundingBox{constructor(t=new Vec3,e=new Vec3(.5,.5,.5)){this.center=t,this.halfExtents=e,this._min=new Vec3,this._max=new Vec3}add(t){const e=this.center,s=e.x,i=e.y,n=e.z,a=this.halfExtents,r=a.x,o=a.y,l=a.z;let h=s-r,c=s+r,d=i-o,u=i+o,p=n-l,m=n+l;const _=t.center,f=_.x,g=_.y,y=_.z,v=t.halfExtents,b=v.x,x=v.y,S=v.z,w=f-b,C=f+b,T=g-x,M=g+x,A=y-S,P=y+S;w<h&&(h=w),C>c&&(c=C),T<d&&(d=T),M>u&&(u=M),A<p&&(p=A),P>m&&(m=P),e.x=.5*(h+c),e.y=.5*(d+u),e.z=.5*(p+m),a.x=.5*(c-h),a.y=.5*(u-d),a.z=.5*(m-p)}copy(t){this.center.copy(t.center),this.halfExtents.copy(t.halfExtents)}clone(){return new BoundingBox(this.center.clone(),this.halfExtents.clone())}intersects(t){const e=this.getMax(),s=this.getMin(),i=t.getMax(),n=t.getMin();return s.x<=i.x&&e.x>=n.x&&s.y<=i.y&&e.y>=n.y&&s.z<=i.z&&e.z>=n.z}_intersectsRay(t,e){const s=W.copy(this.getMin()).sub(t.origin),i=G.copy(this.getMax()).sub(t.origin),n=t.direction;0===n.x?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=n.x,i.x/=n.x),0===n.y?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=n.y,i.y/=n.y),0===n.z?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=n.z,i.z/=n.z);const a=j.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),r=X.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),o=Math.min(Math.min(r.x,r.y),r.z),l=Math.max(Math.max(a.x,a.y),a.z),h=o>=l&&l>=0;return h&&e.copy(t.direction).mulScalar(l).add(t.origin),h}_fastIntersectsRay(t){const e=W,s=G,i=j,n=X,a=q,r=t.direction;return e.sub2(t.origin,this.center),n.set(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z)),i.mul2(e,r),!(n.x>this.halfExtents.x&&i.x>=0)&&(!(n.y>this.halfExtents.y&&i.y>=0)&&(!(n.z>this.halfExtents.z&&i.z>=0)&&(a.set(Math.abs(r.x),Math.abs(r.y),Math.abs(r.z)),s.cross(r,e),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),!(s.x>this.halfExtents.y*a.z+this.halfExtents.z*a.y)&&(!(s.y>this.halfExtents.x*a.z+this.halfExtents.z*a.x)&&!(s.z>this.halfExtents.x*a.y+this.halfExtents.y*a.x)))))}intersectsRay(t,e){return e?this._intersectsRay(t,e):this._fastIntersectsRay(t)}setMinMax(t,e){this.center.add2(e,t).mulScalar(.5),this.halfExtents.sub2(e,t).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(t){const e=this.getMin(),s=this.getMax();return!(t.x<e.x||t.x>s.x||t.y<e.y||t.y>s.y||t.z<e.z||t.z>s.z)}setFromTransformedAabb(t,e,s=!1){const i=t.center,n=t.halfExtents,a=e.data;let r=a[0],o=a[4],l=a[8],h=a[1],c=a[5],d=a[9],u=a[2],p=a[6],m=a[10];if(s){let t=r*r+o*o+l*l;if(t>0){const e=1/Math.sqrt(t);r*=e,o*=e,l*=e}if(t=h*h+c*c+d*d,t>0){const e=1/Math.sqrt(t);h*=e,c*=e,d*=e}if(t=u*u+p*p+m*m,t>0){const e=1/Math.sqrt(t);u*=e,p*=e,m*=e}}this.center.set(a[12]+r*i.x+o*i.y+l*i.z,a[13]+h*i.x+c*i.y+d*i.z,a[14]+u*i.x+p*i.y+m*i.z),this.halfExtents.set(Math.abs(r)*n.x+Math.abs(o)*n.y+Math.abs(l)*n.z,Math.abs(h)*n.x+Math.abs(c)*n.y+Math.abs(d)*n.z,Math.abs(u)*n.x+Math.abs(p)*n.y+Math.abs(m)*n.z)}compute(t,e){if((e=void 0===e?t.length/3:e)>0){const s=W.set(t[0],t[1],t[2]),i=G.set(t[0],t[1],t[2]);for(let n=1;n<e;n++){const e=t[3*n+0],a=t[3*n+1],r=t[3*n+2];e<s.x&&(s.x=e),a<s.y&&(s.y=a),r<s.z&&(s.z=r),e>i.x&&(i.x=e),a>i.y&&(i.y=a),r>i.z&&(i.z=r)}this.setMinMax(s,i)}}intersectsBoundingSphere(t){return this._distanceToBoundingSphereSq(t)<=t.radius*t.radius}_distanceToBoundingSphereSq(t){const e=this.getMin(),s=this.getMax();let i=0;const n=["x","y","z"];for(let a=0;a<3;++a){let r=0;const o=t.center[n[a]],l=e[n[a]],h=s[n[a]];let c=0;o<l&&(c=l-o,r+=c*c),o>h&&(c=o-h,r+=c*c),i+=r}return i}_expand(t,e){W.add2(this.getMin(),t),G.add2(this.getMax(),e),this.setMinMax(W,G)}}const $=new Vec3,Y=new Vec3;class BoundingSphere{constructor(t=new Vec3,e=.5){this.center=t,this.radius=e}containsPoint(t){const e=$.sub2(t,this.center).lengthSq(),s=this.radius;return e<s*s}intersectsRay(t,e){const s=$.copy(t.origin).sub(this.center),i=s.dot(Y.copy(t.direction).normalize()),n=s.dot(s)-this.radius*this.radius;if(n>0&&i>0)return!1;const a=i*i-n;if(a<0)return!1;const r=Math.abs(-i-Math.sqrt(a));return e&&e.copy(t.direction).mulScalar(r).add(t.origin),!0}intersectsBoundingSphere(t){$.sub2(t.center,this.center);const e=t.radius+this.radius;return $.lengthSq()<=e*e}}const K="none",Z={0:"PCF3",1:"VSM8",2:"VSM16",3:"VSM32",4:"PCF5",5:"PCF1"},Q=256,J=1024,tt=2048,et=4096,st=8192,it=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3];class Frustum{constructor(){this.planes=[];for(let t=0;t<6;t++)this.planes[t]=[]}setFromMat4(t){const e=t.data;let s;const i=this.planes;s=i[0],s[0]=e[3]-e[0],s[1]=e[7]-e[4],s[2]=e[11]-e[8],s[3]=e[15]-e[12];let n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[1],s[0]=e[3]+e[0],s[1]=e[7]+e[4],s[2]=e[11]+e[8],s[3]=e[15]+e[12],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[2],s[0]=e[3]+e[1],s[1]=e[7]+e[5],s[2]=e[11]+e[9],s[3]=e[15]+e[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[3],s[0]=e[3]-e[1],s[1]=e[7]-e[5],s[2]=e[11]-e[9],s[3]=e[15]-e[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[4],s[0]=e[3]-e[2],s[1]=e[7]-e[6],s[2]=e[11]-e[10],s[3]=e[15]-e[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[5],s[0]=e[3]+e[2],s[1]=e[7]+e[6],s[2]=e[11]+e[10],s[3]=e[15]+e[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n}containsPoint(t){let e,s;for(e=0;e<6;e++)if(s=this.planes[e],s[0]*t.x+s[1]*t.y+s[2]*t.z+s[3]<=0)return!1;return!0}containsSphere(t){let e,s,i=0;const n=t.radius,a=t.center,r=a.x,o=a.y,l=a.z,h=this.planes;let c;for(s=0;s<6;s++){if(c=h[s],e=c[0]*r+c[1]*o+c[2]*l+c[3],e<=-n)return 0;e>n&&i++}return 6===i?2:1}static getPoints(t,e,s){e=e||t._nearClip,s=s||t._farClip;const i=t._fov*Math.PI/180;let n=0===t._projection?Math.tan(i/2)*e:t._orthoHeight,a=n*t._aspectRatio;const r=it;return r[0].x=a,r[0].y=-n,r[0].z=-e,r[1].x=a,r[1].y=n,r[1].z=-e,r[2].x=-a,r[2].y=n,r[2].z=-e,r[3].x=-a,r[3].y=-n,r[3].z=-e,0===t._projection&&(n=Math.tan(i/2)*s,a=n*t._aspectRatio),r[4].x=a,r[4].y=-n,r[4].z=-s,r[5].x=a,r[5].y=n,r[5].z=-s,r[6].x=-a,r[6].y=n,r[6].z=-s,r[7].x=-a,r[7].y=-n,r[7].z=-s,r}}class Ray{constructor(t=new Vec3,e=new Vec3(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}}new Ray,new Vec3,new BoundingSphere,new Mat4,new Vec3;const nt=10,at=12,rt=14,ot="POSITION",lt="NORMAL",ht="TANGENT",ct="BLENDWEIGHT",dt="BLENDINDICES",ut="COLOR",pt="TEXCOORD",mt="TEXCOORD0",_t="TEXCOORD1",ft="TEXCOORD2",gt="TEXCOORD3",yt="TEXCOORD4",vt="TEXCOORD5",bt="TEXCOORD6",xt="TEXCOORD7",St="ATTR0",wt="ATTR1",Ct="ATTR2",Tt="ATTR3",Mt="ATTR4",At="ATTR8",Pt="ATTR9",Et="ATTR10",Lt="ATTR11",Rt="ATTR12",It="ATTR13",Dt="ATTR14",kt="ATTR15",Ft="default",Ot="rgbm",Vt="rgbe",Bt="swizzleGGGR",zt="none",Ut="cube",Nt="equirect",Ht=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],Wt=[1,1,2,2,4,4,4],Gt=[Uint8Array,Uint16Array,Uint32Array],jt={POSITION:0,NORMAL:1,BLENDWEIGHT:2,BLENDINDICES:3,COLOR:4,TEXCOORD0:5,TEXCOORD1:6,TEXCOORD2:7,TEXCOORD3:8,TEXCOORD4:9,TEXCOORD5:10,TEXCOORD6:11,TEXCOORD7:12,TANGENT:13,ATTR0:0,ATTR1:1,ATTR2:2,ATTR3:3,ATTR4:4,ATTR5:5,ATTR6:6,ATTR7:7,ATTR8:8,ATTR9:9,ATTR10:10,ATTR11:11,ATTR12:12,ATTR13:13,ATTR14:14,ATTR15:15};let Xt=0;class VertexBuffer{constructor(t,e,s,i=0,n){this.device=t,this.format=e,this.numVertices=s,this.usage=i,this.id=Xt++,this._vao=null,this.instancing=!1,this.numBytes=e.verticesByteSize?e.verticesByteSize:e.size*s,t._vram.vb+=this.numBytes,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);if(-1!==e&&t.buffers.splice(e,1),this.bufferId){const e=t.gl;t.boundVao=null,e.bindVertexArray(null),e.deleteBuffer(this.bufferId),t._vram.vb-=this.storage.byteLength,this.bufferId=null}}loseContext(){this.bufferId=void 0,this._vao=null}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){const t=this.device.gl;let e;switch(this.bufferId||(this.bufferId=t.createBuffer()),this.usage){case 0:e=t.STATIC_DRAW;break;case 1:e=t.DYNAMIC_DRAW;break;case 2:e=t.STREAM_DRAW;break;case 3:e=this.device.webgl2?t.DYNAMIC_COPY:t.STATIC_DRAW}t.bindBuffer(t.ARRAY_BUFFER,this.bufferId),t.bufferData(t.ARRAY_BUFFER,this.storage,e)}setData(t){return t.byteLength===this.numBytes&&(this.storage=t,this.unlock(),!0)}}function qt(t){let e=0;for(let s=0,i=t.length;s<i;s++)e=(e<<5)-e+t.charCodeAt(s),e|=0;return e}class VertexFormat{constructor(t,e,s){this.elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=void 0===s,this.size=e.reduce(((t,e)=>t+4*Math.ceil(e.components*Wt[e.type]/4)),0);let i,n=0;for(let a=0,r=e.length;a<r;a++){const t=e[a];i=t.components*Wt[t.type],s&&(n=O.roundUp(n,i));const r={name:t.semantic,offset:s?n:t.hasOwnProperty("offset")?t.offset:n,stride:s?i:t.hasOwnProperty("stride")?t.stride:this.size,dataType:t.type,numComponents:t.components,normalize:void 0!==t.normalize&&t.normalize,size:i};this.elements.push(r),n+=s?i*s:4*Math.ceil(i/4),t.semantic===mt?this.hasUv0=!0:t.semantic===_t?this.hasUv1=!0:t.semantic===ut?this.hasColor=!0:t.semantic===ht&&(this.hasTangents=!0)}s&&(this.verticesByteSize=n),this.update()}static init(t){const e=[{semantic:Rt,components:4,type:6},{semantic:It,components:4,type:6},{semantic:Dt,components:4,type:6},{semantic:kt,components:4,type:6}];VertexFormat._defaultInstancingFormat=new VertexFormat(t,e)}static get defaultInstancingFormat(){return VertexFormat._defaultInstancingFormat}update(){this._evaluateHash()}_evaluateHash(){let t;const e=[];let s;const i=[],n=this.elements.length;for(let a=0;a<n;a++){const n=this.elements[a];t=n.name,t+=n.dataType,t+=n.numComponents,t+=n.normalize,e.push(t),s=t,s+=n.offset,s+=n.stride,s+=n.size,i.push(s)}e.sort(),this.batchingHash=qt(e.join()),this.renderingingHash=qt(i.join())}}VertexFormat._defaultInstancingFormat=null;let $t=null;const Yt={type:5,base:0,count:4,indexed:!1};function Kt(t,e,s,i,n,a=!1){if(null===$t){const e=new VertexFormat(t,[{semantic:ot,components:2,type:6}]),s=new Float32Array(8);s.set([-1,-1,1,-1,-1,1,1,1]),$t=new VertexBuffer(t,e,4,0,s)}const r=t.renderTarget;let o,l,h,c,d,u,p,m;t.setRenderTarget(e),t.updateBegin(),i?(o=i.x,l=i.y,h=i.z,c=i.w):(h=e?e.width:t.width,c=e?e.height:t.height,o=0,l=0),n?(d=n.x,u=n.y,p=n.z,m=n.w):(d=o,u=l,p=h,m=c);const _=t.vx,f=t.vy,g=t.vw,y=t.vh;t.setViewport(o,l,h,c);const v=t.sx,b=t.sy,x=t.sw,S=t.sh;t.setScissor(d,u,p,m);const w=t.getDepthTest(),C=t.getDepthWrite(),T=t.getCullMode(),M=t.writeRed,A=t.writeGreen,P=t.writeBlue,E=t.writeAlpha;t.setDepthTest(!1),t.setDepthWrite(!1),t.setCullMode(0),t.setColorWrite(!0,!0,!0,!0),a||t.setBlending(!1),t.setVertexBuffer($t,0),t.setShader(s),t.draw(Yt),t.setDepthTest(w),t.setDepthWrite(C),t.setCullMode(T),t.setColorWrite(M,A,P,E),t.updateEnd(),t.setRenderTarget(r),t.updateBegin(),t.setViewport(_,f,g,y),t.setScissor(v,b,x,S)}class Shader{constructor(t,e){this.device=t,this.definition=e,this.init(),this.device.createShader(this)}init(){this.attributes=[],this.uniforms=[],this.samplers=[],this.ready=!1,this.failed=!1}destroy(){this.device.destroyShader(this)}loseContext(){this.init()}}const Zt={alphaTestPS:"uniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"void addAmbient() {\n\tdDiffuseLight += light_globalAmbient;\n}\n",ambientEnvPS:"#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nvoid addAmbient() {\n\tvec3 dir = cubeMapRotate(dNormalW) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\tvec4 raw = texture2D(texture_envAtlas, uv);\n\tvec3 linear = $DECODE(raw);\n\tdDiffuseLight += processEnvironment(linear);\n}\n",ambientSHPS:"uniform vec3 ambientSH[9];\nvoid addAmbient() {\n\tvec3 n = cubeMapRotate(dNormalW);\n\tvec3 color =\n\t\tambientSH[0] +\n\t\tambientSH[1] * n.x +\n\t\tambientSH[2] * n.y +\n\t\tambientSH[3] * n.z +\n\t\tambientSH[4] * n.x * n.z +\n\t\tambientSH[5] * n.z * n.y +\n\t\tambientSH[6] * n.y * n.x +\n\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\nvoid applyAO() {\n\tdAo = 1.0;\n\t#ifdef MAPTEXTURE\n\tdAo *= texture2D(texture_aoMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAo *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight *= dAo;\n}\n",aoSpecOccPS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstPS:"void occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstSimplePS:"void occludeSpecular() {\n\tfloat specOcc = dAo;\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccSimplePS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",bakeDirLmEndPS:"\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\tif (bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\tdAtten = saturate(dAtten);\n\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t} else {\n\t\t\tgl_FragColor = dirLm;\n\t\t}\n\t} else {\n\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n\t}\n",bakeLmEndPS:"\tgl_FragColor.rgb = dDiffuseLight;\n\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\tgl_FragColor.rgb /= 8.0;\n\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\tgl_FragColor.rgb /= gl_FragColor.a;\n",basePS:"uniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseVS:"attribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\n",baseNineSlicedPS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",biasConstPS:"#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n\treturn maxBias;\n}\n",blurVSMPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\tfor (int i=0; i<SAMPLES; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef PACKED\n\t\tc.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n\t\t#endif\n\t\t#ifdef GAUSS\n\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\tmoments /= float(SAMPLES);\n\t#endif\n\t#ifdef PACKED\n\tgl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n\t#else\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n\t#endif\n}\n",clearCoatPS:"#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatMap;\n#endif\nvoid getClearCoat() {\n\tccSpecularity = 1.0;\n\t#ifdef MAPFLOAT\n\tccSpecularity *= material_clearCoat;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccSpecularity *= texture2D(texture_clearCoatMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",clearCoatGlossPS:"#ifdef MAPFLOAT\nuniform float material_clearCoatGlossiness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatGlossMap;\n#endif\nvoid getClearCoatGlossiness() {\n\tccGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tccGlossiness *= material_clearCoatGlossiness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatNormalMap;\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n\t#ifdef MAPTEXTURE\n\tvec3 normalMap = unpackNormal(texture2D(texture_clearCoatNormalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness));\n\tccNormalW = dTBN * normalMap;\n\t#else\n\tccNormalW = normalize(dVertexNormalW);\n\t#endif\n\tccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n}\n",clusteredLightCookiesPS:"vec3 _getCookieClustered(sampler2D tex, vec2 uv, float intensity, bool isRgb, vec4 cookieChannel) {\n\tvec4 pixel = mix(vec4(1.0), texture2D(tex, uv), intensity);\n\treturn isRgb == true ? pixel.rgb : vec3(dot(pixel, cookieChannel));\n}\nvec3 getCookie2DClustered(sampler2D tex, mat4 transform, vec3 worldPosition, float intensity, bool isRgb, vec4 cookieChannel) {\n\tvec4 projPos = transform * vec4(worldPosition, 1.0);\n\treturn _getCookieClustered(tex, projPos.xy / projPos.w, intensity, isRgb, cookieChannel);\n}\nvec3 getCookieCubeClustered(sampler2D tex, vec3 dir, float intensity, bool isRgb, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\treturn _getCookieClustered(tex, uv, intensity, isRgb, cookieChannel);\n}\n",clusteredLightShadowsPS:"#ifdef GL2\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfloat getShadowOmniClusteredPCF1(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\treturn texture(shadowMap, vec3(uv, shadowZ));\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\tfloat getShadowOmniClusteredPCF3(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\tdShadowCoord = vec3(uv, shadowZ);\n\t\treturn getShadowPCF3x3(shadowMap, shadowParams.xyz);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowOmniClusteredPCF5(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\tdShadowCoord = vec3(uv, shadowZ);\n\t\treturn getShadowPCF5x5(shadowMap, shadowParams.xyz);\n\t}\n\t#endif\n#else\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfloat getShadowOmniClusteredPCF1(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\t\tfloat depth = unpackFloat(texture2D(shadowMap, uv));\n\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\treturn depth > shadowZ ? 1.0 : 0.0;\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3) || defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowOmniClusteredPCF3(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\tdShadowCoord = vec3(uv, shadowZ);\n\t\treturn getShadowPCF3x3(shadowMap, shadowParams.xyz);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowOmniClusteredPCF5(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\t\treturn getShadowOmniClusteredPCF3(shadowMap, shadowParams, omniAtlasViewport, shadowEdgePixels, dir);\n\t}\n\t#endif\n#endif\n#ifdef GL2\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfloat getShadowSpotClusteredPCF1(sampler2DShadow shadowMap, vec4 shadowParams) {\n\t\treturn texture(shadowMap, dShadowCoord);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\tfloat getShadowSpotClusteredPCF3(sampler2DShadow shadowMap, vec4 shadowParams) {\n\t\treturn getShadowSpotPCF3x3(shadowMap, shadowParams);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowSpotClusteredPCF5(sampler2DShadow shadowMap, vec4 shadowParams) {\n\t\treturn getShadowPCF5x5(shadowMap, shadowParams.xyz);\n\t}\n\t#endif\n#else\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfloat getShadowSpotClusteredPCF1(sampler2D shadowMap, vec4 shadowParams) {\n\t\tfloat depth = unpackFloat(texture2D(shadowMap, dShadowCoord.xy));\n\t\treturn depth > dShadowCoord.z ? 1.0 : 0.0;\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3) || defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowSpotClusteredPCF3(sampler2D shadowMap, vec4 shadowParams) {\n\t\treturn getShadowSpotPCF3x3(shadowMap, shadowParams);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowSpotClusteredPCF5(sampler2D shadowMap, vec4 shadowParams) {\n\t\treturn getShadowSpotClusteredPCF3(shadowMap, shadowParams);\n\t}\n\t#endif\n#endif\n",clusteredLightUtilsPS:"vec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)\n{\n\tvec3 vAbs = abs(dir);\n\tfloat ma;\n\tvec2 uv;\n\tif (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n\t\tfaceIndex = dir.z < 0.0 ? 5.0 : 4.0;\n\t\tma = 0.5 / vAbs.z;\n\t\tuv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);\n\t\ttileOffset.x = 2.0;\n\t\ttileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;\n\t} else if(vAbs.y >= vAbs.x) {\n\t\tfaceIndex = dir.y < 0.0 ? 3.0 : 2.0;\n\t\tma = 0.5 / vAbs.y;\n\t\tuv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);\n\t\ttileOffset.x = 1.0;\n\t\ttileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;\n\t} else {\n\t\tfaceIndex = dir.x < 0.0 ? 1.0 : 0.0;\n\t\tma = 0.5 / vAbs.x;\n\t\tuv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);\n\t\ttileOffset.x = 0.0;\n\t\ttileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;\n\t}\n\treturn uv * ma + 0.5;\n}\nvec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {\n\tfloat faceIndex;\n\tvec2 tileOffset;\n\tvec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);\n\tfloat atlasFaceSize = omniAtlasViewport.z;\n\tfloat tileSize = shadowTextureResolution * atlasFaceSize;\n\tfloat offset = shadowEdgePixels / tileSize;\n\tuv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);\n\tuv *= atlasFaceSize;\n\tuv += tileOffset * atlasFaceSize;\n\tuv += omniAtlasViewport.xy;\n\treturn uv;\n}\n",clusteredLightPS:"uniform sampler2D clusterWorldTexture;\nuniform sampler2D lightsTexture8;\nuniform highp sampler2D lightsTextureFloat;\n#ifdef CLUSTER_SHADOWS\n\t#ifdef GL2\n\t\tuniform sampler2DShadow shadowAtlasTexture;\n\t#else\n\t\tuniform sampler2D shadowAtlasTexture;\n\t#endif\n#endif\n#ifdef CLUSTER_COOKIES\n\tuniform sampler2D cookieAtlasTexture;\n#endif\nuniform float clusterPixelsPerCell;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec4 lightsTextureInvSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 clusterCompressionLimit0;\nuniform vec2 shadowAtlasParams;\nfloat LTCLightValuesEvaluated = 0.0;\nstruct ClusterLightData {\n\tfloat lightV;\n\tfloat type;\n\tfloat shape;\n\tvec3 halfWidth;\n\tvec3 halfHeight;\n\tfloat falloffMode;\n\tfloat castShadows;\n\tfloat shadowBias;\n\tfloat shadowNormalBias;\n\tvec3 position;\n\tvec3 direction;\n\tfloat range;\n\tfloat innerConeAngleCos;\n\tfloat outerConeAngleCos;\n\tvec3 color;\n\tvec3 omniAtlasViewport;\n\tfloat cookie;\n\tfloat cookieRgb;\n\tfloat cookieIntensity;\n\tvec4 cookieChannelMask;\n\tfloat mask;\n};\nmat4 lightProjectionMatrix;\n#define isClusteredLightCastShadow(light) ( light.castShadows > 0.5 )\n#define isClusteredLightCookie(light) (light.cookie > 0.5 )\n#define isClusteredLightCookieRgb(light) (light.cookieRgb > 0.5 )\n#define isClusteredLightSpot(light) ( light.type > 0.5 )\n#define isClusteredLightFalloffLinear(light) ( light.falloffMode < 0.5 )\n#define isClusteredLightArea(light) ( light.shape > 0.1 )\n#define isClusteredLightRect(light) ( light.shape < 0.3 )\n#define isClusteredLightDisk(light) ( light.shape < 0.6 )\n#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n\t#define acceptLightMask(light) ( light.mask < 0.75)\n#else\n\t#define acceptLightMask(light) ( light.mask > 0.25)\n#endif\nvec4 decodeClusterLowRange4Vec4(vec4 d0, vec4 d1, vec4 d2, vec4 d3) {\n\treturn vec4(\n\t\tbytes2floatRange4(d0, -2.0, 2.0),\n\t\tbytes2floatRange4(d1, -2.0, 2.0),\n\t\tbytes2floatRange4(d2, -2.0, 2.0),\n\t\tbytes2floatRange4(d3, -2.0, 2.0)\n\t);\n}\n#ifdef SUPPORTS_TEXLOD\n\t#define textureData(texture, uv) texture2DLodEXT(texture, uv, 0.0)\n#else\n\t#define textureData(texture, uv) texture2D(texture, uv)\n#endif\nvec4 sampleLightsTexture8(const ClusterLightData clusterLightData, float index) {\n\treturn textureData(lightsTexture8, vec2(index * lightsTextureInvSize.z, clusterLightData.lightV));\n}\nvec4 sampleLightTextureF(const ClusterLightData clusterLightData, float index) {\n\treturn textureData(lightsTextureFloat, vec2(index * lightsTextureInvSize.x, clusterLightData.lightV));\n}\nvoid decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {\n\tclusterLightData.lightV = (lightIndex + 0.5) * lightsTextureInvSize.w;\n\tvec4 lightInfo = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_FLAGS);\n\tclusterLightData.type = lightInfo.x;\n\tclusterLightData.shape = lightInfo.y;\n\tclusterLightData.falloffMode = lightInfo.z;\n\tclusterLightData.castShadows = lightInfo.w;\n\tvec4 colorA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_A);\n\tvec4 colorB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_B);\n\tclusterLightData.color = vec3(bytes2float2(colorA.xy), bytes2float2(colorA.zw), bytes2float2(colorB.xy)) * clusterCompressionLimit0.y;\n\tclusterLightData.cookie = colorB.z;\n\tclusterLightData.mask = colorB.w;\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tvec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_POSITION_RANGE);\n\t\tclusterLightData.position = lightPosRange.xyz;\n\t\tclusterLightData.range = lightPosRange.w;\n\t\tvec4 lightDir_Unused = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_SPOT_DIRECTION);\n\t\tclusterLightData.direction = lightDir_Unused.xyz;\n\t#else\n\t\tvec4 encPosX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_X);\n\t\tvec4 encPosY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Y);\n\t\tvec4 encPosZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Z);\n\t\tclusterLightData.position = vec3(bytes2float4(encPosX), bytes2float4(encPosY), bytes2float4(encPosZ)) * clusterBoundsDelta + clusterBoundsMin;\n\t\tvec4 encRange = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_RANGE);\n\t\tclusterLightData.range = bytes2float4(encRange) * clusterCompressionLimit0.x;\n\t\tvec4 encDirX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_X);\n\t\tvec4 encDirY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Y);\n\t\tvec4 encDirZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Z);\n\t\tclusterLightData.direction = vec3(bytes2float4(encDirX), bytes2float4(encDirY), bytes2float4(encDirZ)) * 2.0 - 1.0;\n\t#endif\n}\nvoid decodeClusterLightSpot(inout ClusterLightData clusterLightData) {\n\tvec4 coneAngle = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_ANGLES);\n\tclusterLightData.innerConeAngleCos = bytes2float2(coneAngle.xy) * 2.0 - 1.0;\n\tclusterLightData.outerConeAngleCos = bytes2float2(coneAngle.zw) * 2.0 - 1.0;\n}\nvoid decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tclusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0).xyz;\n\t#else\n\t\tvec4 viewportA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_A);\n\t\tvec4 viewportB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_B);\n\t\tclusterLightData.omniAtlasViewport = vec3(bytes2float2(viewportA.xy), bytes2float2(viewportA.zw), bytes2float2(viewportB.xy));\n\t#endif\n}\nvoid decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tclusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_WIDTH).xyz;\n\t\tclusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_HEIGHT).xyz;\n\t#else\n\t\tvec4 areaWidthX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_X);\n\t\tvec4 areaWidthY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Y);\n\t\tvec4 areaWidthZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Z);\n\t\tclusterLightData.halfWidth = vec3(mantissaExponent2Float(areaWidthX), mantissaExponent2Float(areaWidthY), mantissaExponent2Float(areaWidthZ));\n\t\tvec4 areaHeightX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_X);\n\t\tvec4 areaHeightY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Y);\n\t\tvec4 areaHeightZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Z);\n\t\tclusterLightData.halfHeight = vec3(mantissaExponent2Float(areaHeightX), mantissaExponent2Float(areaHeightY), mantissaExponent2Float(areaHeightZ));\n\t#endif\n}\nvoid decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tvec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0);\n\t\tvec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_1);\n\t\tvec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_2);\n\t\tvec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_3);\n\t#else\n\t\tvec4 m00 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_00);\n\t\tvec4 m01 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_01);\n\t\tvec4 m02 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_02);\n\t\tvec4 m03 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_03);\n\t\tvec4 m0 = decodeClusterLowRange4Vec4(m00, m01, m02, m03);\n\t\tvec4 m10 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_10);\n\t\tvec4 m11 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_11);\n\t\tvec4 m12 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_12);\n\t\tvec4 m13 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_13);\n\t\tvec4 m1 = decodeClusterLowRange4Vec4(m10, m11, m12, m13);\n\t\tvec4 m20 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_20);\n\t\tvec4 m21 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_21);\n\t\tvec4 m22 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_22);\n\t\tvec4 m23 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_23);\n\t\tvec4 m2 = decodeClusterLowRange4Vec4(m20, m21, m22, m23);\n\t\tvec4 m30 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_30);\n\t\tvec4 m31 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_31);\n\t\tvec4 m32 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_32);\n\t\tvec4 m33 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_33);\n\t\tvec4 m3 = vec4(mantissaExponent2Float(m30), mantissaExponent2Float(m31), mantissaExponent2Float(m32), mantissaExponent2Float(m33));\n\t#endif\n\tlightProjectionMatrix = mat4(m0, m1, m2, m3);\n}\nvoid decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {\n\tvec4 biases = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SHADOW_BIAS);\n\tclusterLightData.shadowBias = bytes2floatRange2(biases.xy, -1.0, 20.0),\n\tclusterLightData.shadowNormalBias = bytes2float2(biases.zw);\n}\nvoid decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {\n\tvec4 cookieA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_A);\n\tclusterLightData.cookieIntensity = cookieA.x;\n\tclusterLightData.cookieRgb = cookieA.y;\n\tclusterLightData.cookieChannelMask = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_B);\n}\nvoid evaluateLight(ClusterLightData light) {\n\tdAtten3 = vec3(1.0);\n\tgetLightDirPoint(light.position);\n\t#ifdef CLUSTER_AREALIGHTS\n\tif (isClusteredLightArea(light)) {\n\t\tdecodeClusterLightAreaData(light);\n\t\tif (LTCLightValuesEvaluated < 0.5) {\n\t\t\tLTCLightValuesEvaluated = 1.0;\n\t\t\tcalcLTCLightValues();\n\t\t}\n\t\tif (isClusteredLightRect(light)) {\n\t\t\tcalcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\tcalcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else {\n\t\t\tcalcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t}\n\t\tdAtten = getFalloffWindow(light.range);\n\t} else\n\t#endif\n\t{\n\t\tif (isClusteredLightFalloffLinear(light))\n\t\t\tdAtten = getFalloffLinear(light.range);\n\t\telse\n\t\t\tdAtten = getFalloffInvSquared(light.range);\n\t}\n\tif (dAtten > 0.00001) {\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (isClusteredLightArea(light)) {\n\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\tdAttenD = getRectLightDiffuse() * 16.0;\n\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\tdAttenD = getDiskLightDiffuse() * 16.0;\n\t\t\t} else {\n\t\t\t\tdAttenD = getSphereLightDiffuse() * 16.0;\n\t\t\t}\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\tdAtten *= getLightDiffuse();\n\t\t}\n\t\tif (isClusteredLightSpot(light)) {\n\t\t\tdecodeClusterLightSpot(light);\n\t\t\tdAtten *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos);\n\t\t}\n\t\t#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)\n\t\tif (dAtten > 0.00001) {\n\t\t\tif (isClusteredLightCastShadow(light) || isClusteredLightCookie(light)) {\n\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\tdecodeClusterLightProjectionMatrixData(light);\n\t\t\t\t} else {\n\t\t\t\t\tdecodeClusterLightOmniAtlasViewport(light);\n\t\t\t\t}\n\t\t\t\tfloat shadowTextureResolution = shadowAtlasParams.x;\n\t\t\t\tfloat shadowEdgePixels = shadowAtlasParams.y;\n\t\t\t\t#ifdef CLUSTER_COOKIES\n\t\t\t\tif (isClusteredLightCookie(light)) {\n\t\t\t\t\tdecodeClusterLightCookieData(light);\n\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\tdAtten3 = getCookie2DClustered(cookieAtlasTexture, lightProjectionMatrix, vPositionW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdAtten3 = getCookieCubeClustered(cookieAtlasTexture, dLightDirW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef CLUSTER_SHADOWS\n\t\t\t\tif (isClusteredLightCastShadow(light)) {\n\t\t\t\t\tdecodeClusterLightShadowData(light);\n\t\t\t\t\tvec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\tgetShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tdAtten *= getShadowSpotClusteredPCF1(shadowAtlasTexture, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tdAtten *= getShadowSpotClusteredPCF3(shadowAtlasTexture, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tdAtten *= getShadowSpotClusteredPCF5(shadowAtlasTexture, shadowParams);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t} else {\n\t\t\t\t\t\tnormalOffsetPointShadow(shadowParams);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tdAtten *= getShadowOmniClusteredPCF1(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tdAtten *= getShadowOmniClusteredPCF3(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tdAtten *= getShadowOmniClusteredPCF5(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t}\n\t\t}\n\t\t#endif\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (isClusteredLightArea(light)) {\n\t\t\t{\n\t\t\t\tvec3 areaDiffuse = (dAttenD * dAtten) * light.color * dAtten3;\n\t\t\t\t#if defined(CLUSTER_SPECULAR) && defined(CLUSTER_CONSERVE_ENERGY)\n\t\t\t\t\tareaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += areaDiffuse;\n\t\t\t}\n\t\t\t#ifdef CLUSTER_SPECULAR\n\t\t\t\tfloat areaLightSpecular;\n\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\tareaLightSpecular = getRectLightSpecular();\n\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\tareaLightSpecular = getDiskLightSpecular();\n\t\t\t\t} else {\n\t\t\t\t\tareaLightSpecular = getSphereLightSpecular();\n\t\t\t\t}\n\t\t\t\tdSpecularLight += dLTCSpecFres * areaLightSpecular * dAtten * light.color * dAtten3;\n\t\t\t\t#ifdef CLUSTER_CLEAR_COAT\n\t\t\t\t\tfloat areaLightSpecularCC;\n\t\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\t\tareaLightSpecularCC = getRectLightSpecularCC();\n\t\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\t\tareaLightSpecularCC = getDiskLightSpecularCC();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tareaLightSpecularCC = getSphereLightSpecularCC();\n\t\t\t\t\t}\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * dAtten * light.color\t* dAtten3;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\t{\n\t\t\t\tvec3 punctualDiffuse = dAtten * light.color * dAtten3;\n\t\t\t\t#if defined(CLUSTER_AREALIGHTS) && defined(CLUSTER_SPECULAR) && defined(CLUSTER_CONSERVE_ENERGY)\n\t\t\t\t\tpunctualDiffuse = mix(punctualDiffuse, vec3(0), dSpecularity);\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += punctualDiffuse;\n\t\t\t}\n\t\t\t#ifdef CLUSTER_SPECULAR\n\t\t\t\t{\n\t\t\t\t\tvec3 punctualSpecular = getLightSpecular() * dAtten * light.color * dAtten3;\n\t\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t\t\tpunctualSpecular *= dSpecularity;\n\t\t\t\t\t#endif\n\t\t\t\t\tdSpecularLight += punctualSpecular;\n\t\t\t\t}\n\t\t\t\t#ifdef CLUSTER_CLEAR_COAT\n\t\t\t\t\tvec3 punctualCC = getLightSpecularCC() * dAtten * light.color * dAtten3;\n\t\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t\t\tpunctualCC *= ccSpecularity;\n\t\t\t\t\t#endif\n\t\t\t\t\tccSpecularLight += punctualCC;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t}\n\t}\n}\nvoid evaluateClusterLight(float lightIndex) {\n\tClusterLightData clusterLightData;\n\tdecodeClusterLightCore(clusterLightData, lightIndex);\n\tif (acceptLightMask(clusterLightData))\n\t\tevaluateLight(clusterLightData);\n}\nvoid addClusteredLights() {\n\tvec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\n\tif (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\t\tfloat cellIndex = dot(clusterCellsDot, cellCoords);\n\t\tfloat clusterV = floor(cellIndex * clusterTextureSize.y);\n\t\tfloat clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n\t\tclusterV = (clusterV + 0.5) * clusterTextureSize.z;\n\t\tconst float maxLightCells = 256.0 / 4.0;\n\t\tfor (float lightCellIndex = 0.5; lightCellIndex < maxLightCells; lightCellIndex++) {\n\t\t\tvec4 lightIndices = textureData(clusterWorldTexture, vec2(clusterTextureSize.y * (clusterU + lightCellIndex), clusterV));\n\t\t\tvec4 indices = lightIndices * 255.0;\n\t\t\tfor (int i = 0; i < 4; i++) {\n\t\t\t\tif (indices.x <= 0.0)\n\t\t\t\t\treturn;\n\t\t\t\tevaluateClusterLight(indices.x);\n\t\t\t\tindices = indices.yzwx;\n\t\t\t}\n\t\t\tif (lightCellIndex > clusterPixelsPerCell) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n}\n",combineClearCoatPS:"vec3 combineColorCC() {\n\treturn combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);\n}\n",combineDiffusePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight;\n}\n",combineDiffuseSpecularPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n",combineDiffuseSpecularNoConservePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n",combineDiffuseSpecularNoReflPS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n",combineDiffuseSpecularNoReflSeparateAmbientPS:"uniform vec3 material_ambient;\nvec3 combineColor() {\n\treturn (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n",combineDiffuseSpecularOldPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n",cookiePS:"vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectBoxPS:"uniform vec3 envBoxMin, envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n\tnrdir = cubeMapRotate(nrdir);\n\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\tvec3 rbminmax;\n\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\tvec3 posonbox = vPositionW + nrdir * fa;\n\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\treturn normalize(posonbox - envBoxPos);\n}\n",cubeMapProjectNonePS:"vec3 cubeMapProject(vec3 dir) {\n\treturn cubeMapRotate(dir);\n}\n",cubeMapRotatePS:"#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",detailModesPS:"vec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n",diffusePS:"#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\nvoid getAlbedo() {\n\tdAlbedo = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdAlbedo *= material_diffuse.rgb;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlbedo *= gammaCorrectInput(addAlbedoDetail(texture2D(texture_diffuseMap, $UV).$CH));\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n}\n",diffuseDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\n#endif\nvec3 addAlbedoDetail(vec3 albedo) {\n\t#ifdef MAPTEXTURE\n\tvec3 albedoDetail = vec3(texture2D(texture_diffuseDetailMap, $UV).$CH);\n\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n\t#else\n\treturn albedo;\n\t#endif\n}\n",dilatePS:"#define SHADER_NAME Dilate\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n\tvec4 c = texture2D(source, vUv0);\n\tc = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n\tgl_FragColor = c;\n}\n",bilateralDeNoisePS:"#define SHADER_NAME BilateralDeNoise\nfloat normpdf3(in vec3 v, in float sigma) {\n\treturn 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec3 color) {\n\tvec4 encoded;\n\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\tencoded.rgb *= 1.0 / 8.0;\n\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded.rgb /= encoded.a;\n\treturn encoded;\n}\n#define MSIZE 15\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nuniform vec2 sigmas;\nuniform float bZnorm;\nuniform float kernel[MSIZE];\nvoid main(void) {\n\tvec4 pixelRgbm = texture2D(source, vUv0);\n\tif (pixelRgbm.a <= 0.0) {\n\t\tgl_FragColor = pixelRgbm;\n\t\treturn ;\n\t}\n\tfloat sigma = sigmas.x;\n\tfloat bSigma = sigmas.y;\n\tvec3 pixelHdr = decodeRGBM(pixelRgbm);\n\tvec3 accumulatedHdr = vec3(0.0);\n\tfloat accumulatedFactor = 0.0;\n\tconst int kSize = (MSIZE-1)/2;\n\tfor (int i = -kSize; i <= kSize; ++i) {\n\t\tfor (int j = -kSize; j <= kSize; ++j) {\n\t\t\tvec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;\n\t\t\tvec4 rgbm = texture2D(source, coord);\n\t\t\tif (rgbm.a > 0.0) {\n\t\t\t\tvec3 hdr = decodeRGBM(rgbm);\n\t\t\t\tfloat factor = kernel[kSize + j] * kernel[kSize + i];\n\t\t\t\tfactor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;\n\t\t\t\taccumulatedHdr += factor * hdr;\n\t\t\t\taccumulatedFactor += factor;\n\t\t\t}\n\t\t}\n\t}\n\tgl_FragColor = encodeRGBM(accumulatedHdr / accumulatedFactor);\n}\n",decodePS:"vec3 decodeLinear(vec4 raw) {\n\treturn raw.rgb;\n}\nvec3 decodeGamma(vec4 raw) {\n\treturn pow(raw.xyz, vec3(2.2));\n}\nvec3 decodeRGBM(vec4 raw) {\n\tvec3 color = (8.0 * raw.a) * raw.rgb;\n\treturn color * color;\n}\nvec3 decodeRGBE(vec4 raw) {\n\tif (raw.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);\n\t}\n}\nconst float PI = 3.141592653589793;\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec2 toSphericalUv(vec3 dir) {\n\tvec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;\n\treturn vec2(uv.x, 1.0 - uv.y);\n}\nconst float atlasSize = 512.0;\nconst float seamSize = 1.0 / atlasSize;\nvec2 mapUv(vec2 uv, vec4 rect) {\n\treturn vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n\t\t\t\tmix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\nvec2 mapRoughnessUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));\n}\nvec2 mapMip(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n",emissivePS:"#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\nvec3 getEmission() {\n\tvec3 emission = vec3(1.0);\n\t#ifdef MAPFLOAT\n\temission *= material_emissiveIntensity;\n\t#endif\n\t#ifdef MAPCOLOR\n\temission *= material_emissive;\n\t#endif\n\t#ifdef MAPTEXTURE\n\temission *= $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\temission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n\treturn emission;\n}\n",endPS:"\t#ifdef CLEARCOAT\n\tgl_FragColor.rgb = combineColorCC();\n\t#else\n\tgl_FragColor.rgb = combineColor();\n\t#endif\n\tgl_FragColor.rgb += getEmission();\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\t#ifndef HDR\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n\t#endif\n",endVS:"\n",envConstPS:"vec3 processEnvironment(vec3 color) {\n\treturn color;\n}\n",envMultiplyPS:"uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n\treturn color * skyboxIntensity;\n}\n",extensionPS:"\n",extensionVS:"\n",falloffInvSquaredPS:"float getFalloffWindow(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat invRadius = 1.0 / lightRadius;\n\treturn square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\nfloat getFalloffInvSquared(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\treturn falloff;\n}\n",falloffLinearPS:"float getFalloffLinear(float lightRadius) {\n\tfloat d = length(dLightDirW);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",fixCubemapSeamsNonePS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\treturn vec3(0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec;\n}\n",fixCubemapSeamsStretchPS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\tvec3 avec = abs(vec);\n\tfloat scale = 1.0 - exp2(mipmapIndex) / 128.0;\n\tfloat M = max(max(avec.x, avec.y), avec.z);\n\tif (avec.x != M) vec.x *= scale;\n\tif (avec.y != M) vec.y *= scale;\n\tif (avec.z != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\tvec3 avec = abs(vec);\n\tfloat scale = 1.0 - 1.0 / 128.0;\n\tfloat M = max(max(avec.x, avec.y), avec.z);\n\tif (avec.x != M) vec.x *= scale;\n\tif (avec.y != M) vec.y *= scale;\n\tif (avec.z != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\tvec3 avec = abs(vec);\n\tfloat scale = invRecMipSize;\n\tfloat M = max(max(avec.x, avec.y), avec.z);\n\tif (avec.x != M) vec.x *= scale;\n\tif (avec.y != M) vec.y *= scale;\n\tif (avec.z != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\tvec3 avec = abs(vec);\n\tfloat M = max(avec.x, max(avec.y, avec.z));\n\treturn vec3(avec.x != M ? 1.0 : 0.0,\n\t\t\t\tavec.y != M ? 1.0 : 0.0,\n\t\t\t\tavec.z != M ? 1.0 : 0.0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec * (seam * -scale + vec3(1.0));\n}\n",floatUnpackingPS:"float bytes2float2(vec2 data) {\n\treturn dot(data, vec2(1.0, 1.0 / 255.0));\n}\nfloat bytes2float3(vec3 data) {\n\treturn dot(data, vec3(1.0, 1.0 / 255.0, 1.0 / 65025.0));\n}\nfloat bytes2float4(vec4 data) {\n\treturn dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\nfloat bytes2floatRange2(vec2 data, float min, float max) {\n\treturn mix(min, max, bytes2float2(data));\n}\nfloat bytes2floatRange3(vec3 data, float min, float max) {\n\treturn mix(min, max, bytes2float3(data));\n}\nfloat bytes2floatRange4(vec4 data, float min, float max) {\n\treturn mix(min, max, bytes2float4(data));\n}\nfloat mantissaExponent2Float(vec4 pack)\n{\n\tfloat value = bytes2floatRange3(pack.xyz, -1.0, 1.0);\n\tfloat exponent = floor(pack.w * 255.0 - 127.0);\n\treturn value * exp2(exponent);\n}\n",fogExpPS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogExp2PS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * depth * fog_density * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogLinearPS:"uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = (fog_end - depth) / (fog_end - fog_start);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\tfogFactor = gammaCorrectInput(fogFactor);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogNonePS:"float dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\treturn color;\n}\n",fresnelSchlickPS:"uniform float material_fresnelFactor;\nvoid getFresnel() {\n\tfloat fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n\tfloat fresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= dGlossiness * dGlossiness;\n\tdSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n\t#ifdef CLEARCOAT\n\tfresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);\n\tfresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= ccGlossiness * ccGlossiness;\n\tccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;\n\t#endif\n}\n",fullscreenQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\treturn texture2D(tex, uv);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\treturn texture2D(tex, uv, bias);\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\treturn textureCube(tex, uvw);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\treturn color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n\treturn color;\n}\nfloat gammaCorrectInput(float color) {\n\treturn color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn color;\n}\n",gamma2_2PS:"vec3 gammaCorrectInput(vec3 color) {\n\treturn pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n\treturn pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\tvec4 rgba = texture2D(tex, uv);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\tvec4 rgba = texture2D(tex, uv, bias);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\tvec4 rgba = textureCube(tex, uvw);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\t#ifdef HDR\n\treturn color;\n\t#else\n\tcolor += vec3(0.0000001);\n\treturn pow(color, vec3(0.45));\n\t#endif\n}\n",gles3PS:"#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n#define SUPPORTS_TEXLOD\n",gles3VS:"#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",glossPS:"#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tdGlossiness *= material_shininess;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",instancingVS:"attribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",lightDiffuseLambertPS:"float getLightDiffuse() {\n\treturn max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n",lightDirPointPS:"void getLightDirPoint(vec3 lightPosW) {\n\tdLightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(dLightDirW);\n\tdLightPosW = lightPosW;\n}\n",lightmapDirPS:"uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid addLightMap() {\n\tvec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\tvec3 dir = texture2D(texture_dirLightMap, $UV).xyz;\n\tif (dot(dir, vec3(1.0)) < 0.00001) {\n\t\tdDiffuseLight += color;\n\t} else {\n\t\tdLightDirNormW = normalize(dir * 2.0 - vec3(1.0));\n\t\tfloat vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n\t\tfloat flight = saturate(dot(dLightDirNormW, -dNormalW));\n\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\t\tdDiffuseLight += color * nlight * 2.0;\n\t}\n\tdSpecularLight += color * getLightSpecular();\n}\n",lightmapSinglePS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\nvoid addLightMap() {\n\tvec3 lm = vec3(1.0);\n\t#ifdef MAPTEXTURE\n\tlm *= $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tlm *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight += lm;\n}\n",lightmapSingleVertPS:"void addLightMap() {\n\tdDiffuseLight += saturate(vVertexColor.$CH);\n}\n",lightSpecularAnisoGGXPS:"float calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\tfloat anisotropy = material_anisotropy * roughness;\n\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\tvec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));\n\tfloat NoH = dot(tNormalW, h);\n\tfloat ToH = dot(dTBN[0], h);\n\tfloat BoH = dot(dTBN[1], h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(dTBN[0], dViewDirW);\n\tfloat BoV = dot(dTBN[1], dViewDirW);\n\tfloat ToL = dot(dTBN[0], -dLightDirNormW);\n\tfloat BoL = dot(dTBN[1], -dLightDirNormW);\n\tfloat NoV = dot(tNormalW, dViewDirW);\n\tfloat NoL = dot(tNormalW, -dLightDirNormW);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularBlinnPS:"float calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tvec3 h = normalize( -dLightDirNormW + dViewDirW );\n\tfloat nh = max( dot( h, tNormalW ), 0.0 );\n\tfloat specPow = exp2(tGlossiness * 11.0);\n\tspecPow = antiAliasGlossiness(specPow);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularPhongPS:"float calcLightSpecular(float tGlossiness, vec3 tReflDirW) {\n\tfloat specPow = tGlossiness;\n\tspecPow = antiAliasGlossiness(specPow);\n\treturn pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dReflDirW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccReflDirW);\n}\n",ltc:"mat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tvec3 coord0;\n\tvec3 coord1;\n\tvec3 coord2;\n\tvec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\tvec3 lightNormal = cross( v1, v2 );\n\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 =\tfactor * cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tdSphereRadius = max(length(halfWidth), length(halfHeight));\n\tvec3 f = reflect(normalize(lightPos - view_position), vNormalW);\n\tvec3 w = normalize(cross(f, halfHeight));\n\tvec3 h = normalize(cross(f, w));\n\treturn getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\nvec2 dLTCUV;\n#ifdef CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float tGlossiness, vec3 tNormalW)\n{\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\treturn LTC_Uv( tNormalW, dViewDirW, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 tSpecularity)\n{\n\tvec4 t2 = texture2D( areaLightsLutTex2, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt2 *= vec4(0.693103,1,1,1);\n\tt2 += vec4(0.306897,0,0,0);\n\t#endif\n\treturn tSpecularity * t2.x + ( vec3( 1.0 ) - tSpecularity) * t2.y;\n}\nvoid calcLTCLightValues()\n{\n\tdLTCUV = getLTCLightUV(dGlossiness, dNormalW);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, dSpecularityNoFres);\n#ifdef CLEARCOAT\n\tccLTCUV = getLTCLightUV(ccGlossiness, ccNormalW);\n\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(ccSpecularityNoFres));\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n\tfloat pi = 3.14159;\n\tCoefficient.xyz /= Coefficient.w;\n\tCoefficient.yz /= 3.0;\n\tfloat A = Coefficient.w;\n\tfloat B = Coefficient.z;\n\tfloat C = Coefficient.y;\n\tfloat D = Coefficient.x;\n\tvec3 Delta = vec3(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvec3 RootsA, RootsD;\n\tvec2 xlc, xsc;\n\t{\n\t\tfloat A_a = 1.0;\n\t\tfloat C_a = Delta.x;\n\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xl;\n\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\txl = x_1a;\n\t\telse\n\t\t\txl = x_3a;\n\t\txlc = vec2(xl - B, A);\n\t}\n\t{\n\t\tfloat A_d = D;\n\t\tfloat C_d = Delta.z;\n\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xs;\n\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\txs = x_1d;\n\t\telse\n\t\t\txs = x_3d;\n\t\txsc = vec2(-D, xs + C);\n\t}\n\tfloat E =\txlc.y * xsc.y;\n\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tfloat G =\txlc.x * xsc.x;\n\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z)\n\t\tRoot.xyz = Root.yxz;\n\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\tRoot.xyz = Root.xzy;\n\treturn Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\tvec3 T1, T2;\n\tT1 = normalize(V - N * dot(V, N));\n\tT2 = cross(N, T1);\n\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\tvec3 L_[ 3 ];\n\tL_[ 0 ] = R * ( points.coord0 - P );\n\tL_[ 1 ] = R * ( points.coord1 - P );\n\tL_[ 2 ] = R * ( points.coord2 - P );\n\tvec3 Lo_i = vec3(0);\n\tvec3 C\t= 0.5 * (L_[0] + L_[2]);\n\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\tC\t= Minv * C;\n\tV1 = Minv * V1;\n\tV2 = Minv * V2;\n\tfloat a, b;\n\tfloat d11 = dot(V1, V1);\n\tfloat d22 = dot(V2, V2);\n\tfloat d12 = dot(V1, V2);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t{\n\t\tfloat tr = d11 + d22;\n\t\tfloat det = -d12 * d12 + d11 * d22;\n\t\tdet = sqrt(det);\n\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\tfloat e_max = (u + v) * (u + v);\n\t\tfloat e_min = (u - v) * (u - v);\n\t\tvec3 V1_, V2_;\n\t\tif (d11 > d22)\n\t\t{\n\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t}\n\telse\n\t{\n\t\ta = 1.0 / dot(V1, V1);\n\t\tb = 1.0 / dot(V2, V2);\n\t\tV1 *= sqrt(a);\n\t\tV2 *= sqrt(b);\n\t}\n\tvec3 V3 = cross(V1, V2);\n\tif (dot(C, V3) < 0.0)\n\t\tV3 *= -1.0;\n\tfloat L\t= dot(V3, C);\n\tfloat x0 = dot(V1, C) / L;\n\tfloat y0 = dot(V2, C) / L;\n\tfloat E1 = inversesqrt(a);\n\tfloat E2 = inversesqrt(b);\n\ta *= L * L;\n\tb *= L * L;\n\tfloat c0 = a * b;\n\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\tfloat c3 = 1.0;\n\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\tfloat e1 = roots.x;\n\tfloat e2 = roots.y;\n\tfloat e3 = roots.z;\n\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\tmat3 rotate = mat3(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tfloat L1 = sqrt(-e2 / e3);\n\tfloat L2 = sqrt(-e2 / e1);\n\tfloat formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv*LUT_SCALE + LUT_BIAS;\n\tfloat scale = texture2D( areaLightsLutTex2, uv ).w;\n\treturn formFactor*scale;\n}\nfloat getRectLightDiffuse() {\n\treturn LTC_EvaluateRect( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse() {\n\treturn LTC_EvaluateDisk( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getSphereLightDiffuse() {\n\tfloat falloff = dSphereRadius / (dot(dLightDirW, dLightDirW) + dSphereRadius);\n\treturn getLightDiffuse()*falloff;\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\tvec4 t1 = texture2D( areaLightsLutTex1, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);\n\tt1 += vec4(0.0, -0.2976, -0.01381, 0.0);\n\t#endif\n\treturn mat3(\n\t\tvec3( t1.x, 0, t1.y ),\n\t\tvec3(\t0, 1,\t0 ),\n\t\tvec3( t1.z, 0, t1.w )\n\t);\n}\nfloat calcRectLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular() {\n\treturn calcRectLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getRectLightSpecularCC() {\n\treturn calcRectLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat calcDiskLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getDiskLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat getSphereLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getSphereLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\n",metalnessPS:"void processMetalness(float metalness) {\n\tconst float dielectricF0 = 0.04;\n\tdSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n\tdAlbedo *= 1.0 - metalness;\n}\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\nvoid getSpecularity() {\n\tfloat metalness = 1.0;\n\t#ifdef MAPFLOAT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tmetalness *= texture2D(texture_metalnessMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tmetalness *= saturate(vVertexColor.$VC);\n\t#endif\n\tprocessMetalness(metalness);\n}\n",msdfPS:"uniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\nvec4 applyMsdf(vec4 color) {\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\tfloat smoothingMax = 0.2;\n\t#ifdef USE_FWIDTH\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);\n\t#else\n\tfloat font_size = 16.0;\n\tfloat smoothing = clamp(font_pxrange / font_size, 0.0, smoothingMax);\n\t#endif\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\treturn tcolor;\n}\n",normalVS:"#ifdef MORPHING_TEXTURE_BASED_NORMAL\nuniform highp sampler2D morphNormalTex;\n#endif\nvec3 getNormal() {\n\t#ifdef SKIN\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t#elif defined(INSTANCING)\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t#else\n\tdNormalMatrix = matrix_normal;\n\t#endif\n\tvec3 tempNormal = vertex_normal;\n\t#ifdef MORPHING\n\t#ifdef MORPHING_NRM03\n\ttempNormal += morph_weights_a[0] * morph_nrm0;\n\ttempNormal += morph_weights_a[1] * morph_nrm1;\n\ttempNormal += morph_weights_a[2] * morph_nrm2;\n\ttempNormal += morph_weights_a[3] * morph_nrm3;\n\t#endif\n\t#ifdef MORPHING_NRM47\n\ttempNormal += morph_weights_b[0] * morph_nrm4;\n\ttempNormal += morph_weights_b[1] * morph_nrm5;\n\ttempNormal += morph_weights_b[2] * morph_nrm6;\n\ttempNormal += morph_weights_b[3] * morph_nrm7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_NORMAL\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n\ttempNormal += morphNormal;\n\t#endif\n\treturn normalize(dNormalMatrix * tempNormal);\n}\n",normalDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\tn1 += vec3(0, 0, 1);\n\tn2 *= vec3(-1, -1, 1);\n\treturn normalize(n1*dot(n1, n2)/n1.z - n2);\n}\n#endif\nvec3 addNormalDetail(vec3 normalMap) {\n\t#ifdef MAPTEXTURE\n\tvec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap, $UV));\n\tnormalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));\n\treturn blendNormals(normalMap, normalDetailMap);\n\t#else\n\treturn normalMap;\n\t#endif\n}\n",normalInstancedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalMapPS:"uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n}\n",normalMapFastPS:"uniform sampler2D texture_normalMap;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n}\n",normalSkinnedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalVertexPS:"void getNormal() {\n\tdNormalW = normalize(dVertexNormalW);\n}\n",normalXYPS:"vec3 unpackNormal(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\treturn normal;\n}\n",normalXYZPS:"vec3 unpackNormal(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\nvoid getOpacity() {\n\tdAlpha = 1.0;\n\t#ifdef MAPFLOAT\n\tdAlpha *= material_opacity;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlpha *= texture2D(texture_opacityMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t#endif\n}\n",outputAlphaPS:"gl_FragColor.a = dAlpha;\n",outputAlphaOpaquePS:"gl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",outputCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec4 color) {\n\tcolor.rgb = pow(color.rgb, vec3(0.5));\n\tcolor.rgb *= 1.0 / 8.0;\n\tcolor.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n\tcolor.a = ceil(color.a * 255.0) / 255.0;\n\tcolor.rgb /= color.a;\n\treturn color;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tgl_FragColor = textureCube(source, vec);\n\tif (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n",outputTex2DPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",packDepthPS:"vec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask\t= vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",packDepthMaskPS:"vec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask\t= vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres.x = 0.0;\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",parallaxPS:"uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2D(texture_heightMap, $UV).$CH;\n\theight = height * parallaxScale - parallaxScale*0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"varying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\n#endif\nvoid main(void) {\n\tvec4 tex\t= texture2DSRGB(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));\n\tvec4 ramp = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n\tramp.rgb *= colorMult;\n\tramp.a += texCoordsAlphaLife.z;\n\tvec3 rgb = tex.rgb * ramp.rgb;\n\tfloat a\t= tex.a * ramp.a;\n",particleVS:"vec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {\n\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex,tc);\n\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\tfloat c = fract(tc.x*graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t#ifdef SCREEN_SPACE\n\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t#else\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t#endif\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvec2 safeNormalize(vec2 v) {\n\tfloat l = length(v);\n\treturn (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n\tvec3 meshLocalPos = particle_vertexData.xyz;\n\tfloat id = floor(particle_vertexData.w);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\tfloat uv = id / numParticlesPot;\n\treadInput(uv);\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n\tfloat particleLifetime = lifetime;\n\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\tvec2 quadXY = meshLocalPos.xy;\n\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\tvec3 paramDiv;\n\tvec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat scale = params.y;\n\tfloat scaleDiv = paramDiv.x;\n\tfloat alphaDiv = paramDiv.z;\n\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\tvec3 particlePos = inPos;\n\tvec3 particlePosMoved = vec3(0.0);\n\tmat2 rotMatrix;\n",particleAnimFrameClampVS:"\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\tfloat animationIndex;\n\tif (animTexIndexParams.y == 1.0) {\n\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t} else {\n\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t}\n\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\tatlasX = fract(atlasX);\n\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"void readInput(float uv) {\n\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\tinPos = tex.xyz;\n\tinVel = tex2.xyz;\n\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\tinShow = tex.w >= 0.0;\n\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n\treturn dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\tinVel = tex2.xyz;\n\tinVel = (inVel - vec3(0.5)) * maxVel;\n\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\tinShow = tex2.a > 0.5;\n\tinLife = decodeFloatRGBA(tex3);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"void writeOutput() {\n\tif (gl_FragCoord.y<1.0) {\n\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t} else {\n\t\tgl_FragColor = vec4(outVel, outLife);\n\t}\n}\n",particleOutputRgba8PS:"uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\treturn enc;\n}\nvoid writeOutput() {\n\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\toutAngle = fract(outAngle / PI2);\n\toutVel = (outVel / maxVel) + vec3(0.5);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\tif (gl_FragCoord.y < 1.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t} else if (gl_FragCoord.y < 2.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t} else if (gl_FragCoord.y < 3.0) {\n\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t} else {\n\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t}\n}\n",particleUpdaterAABBPS:"uniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tvec3 pos = inBounds - vec3(0.5);\n\tvec3 posAbs = abs(pos);\n\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n\treturn emitterPos + spawnBounds * pos;\n#else\n\treturn spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\twriteOutput();\n}\n",particleUpdaterInitPS:"varying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = -1.0;\n\t}\n",particleUpdaterOnStopPS:"\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = 1.0;\n\t}\n\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"uniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tfloat rnd4 = fract(rndFactor * 1000.0);\n\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\treturn norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"float saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex, tc);\n\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\tfloat c = fract(tc.x * graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\tp4 += dot(p4, p4.wzxy+19.19);\n\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n\tif (gl_FragCoord.x > numParticles) discard;\n\treadInput(vUv0.x);\n\tvisMode = inShow? 1.0 : -1.0;\n\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\toutLife = inLife + delta;\n\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\tvec3 localVelocityDiv;\n\tvec3 velocityDiv;\n\tvec3 paramDiv;\n\tvec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n\tvec3 velocity =\t\ttex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n\tvec3 params =\t\ttex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat rotSpeed = params.x;\n\tfloat rotSpeedDiv = paramDiv.y;\n\tvec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n\tfloat radialSpeed = radialParams.x;\n\tfloat radialSpeedDiv = radialParams.y;\n\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n\tvec3 radialVel = inPos - emitterPos;\n#else\n\tvec3 radialVel = inPos;\n#endif\n\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\tlocalVelocity +=\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\tvelocity +=\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\trotSpeed +=\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\taddInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\toutPos = inPos + outVel * delta;\n\toutAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\tdBlendModeFogFactor = 0.0;\n\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\trgb = mix(vec3(1.0), rgb, vec3(a));\n\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\tif (a < 0.01) discard;\n",particle_cpuVS:"attribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvoid main(void)\n{\n\tvec3 particlePos = particle_vertexData.xyz;\n\tvec3 inPos = particlePos;\n\tvec3 vertPos = particle_vertexData3.xyz;\n\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\tfloat id = floor(particle_vertexData4);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n\tvec2 quadXY = vertPos.xy;\n#ifdef USE_MESH\n\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#else\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\tmat2 rotMatrix;\n\tfloat inAngle = particle_vertexData2.x;\n\tvec3 particlePosMoved = vec3(0.0);\n\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\tlocalPos *= particle_vertexData2.y * emitterScale;\n\tlocalPos += particlePos;\n\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\trgb = addFog(rgb);\n\trgb = toneMap(rgb);\n\trgb = gammaCorrectOutput(rgb);\n\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\tlocalPos *= scale * emitterScale;\n\tlocalPos += particlePos;\n\t#ifdef SCREEN_SPACE\n\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t#else\n\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t#endif\n",particle_halflambertPS:"\tvec3 negNormal = normal*0.5+0.5;\n\tvec3 posNormal = -normal*0.5+0.5;\n\tnegNormal *= negNormal;\n\tposNormal *= posNormal;\n",particle_initVS:"attribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\tvec3 negNormal = max(normal, vec3(0.0));\n\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\trgb *= light;\n",particle_localShiftVS:"\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\tvec3 localPos = meshLocalPos;\n\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\tbillboard(particlePos, quadXY);\n",particle_normalVS:"\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\tvec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);\n\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\tinAngle = atan(velocityV.x, velocityV.y);\n",particle_softPS:"\tfloat depth = getLinearScreenDepth();\n\tfloat particleDepth = vDepth;\n\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\ta *= depthDiff;\n",particle_softVS:"\tvDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\tvec3 moveDir = inVel * stretch;\n\tvec3 posPrev = particlePos - moveDir;\n\tposPrev += particlePosMoved;\n\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\tvec3 origParticlePos = particlePos;\n\tparticlePos -= matrix_model[3].xyz;\n\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\tparticlePos += matrix_model[3].xyz;\n\tparticlePosMoved = particlePos - origParticlePos;\n",precisionTestPS:"void main(void) {\n\tgl_FragColor = vec4(2147483648.0);\n}\n",precisionTest2PS:"uniform sampler2D source;\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask\t= vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\nvoid main(void) {\n\tfloat c = texture2D(source, vec2(0.0)).r;\n\tfloat diff = abs(c - 2147483648.0) / 2147483648.0;\n\tgl_FragColor = packFloat(diff);\n}\n",reflDirPS:"void getReflDir() {\n\tdReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n",reflDirAnisoPS:"void getReflDir() {\n\tfloat roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n\tfloat anisotropy = material_anisotropy * roughness;\n\tvec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n\tvec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tvec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n\tdReflDirW = reflect(-dViewDirW, bentNormal);\n}\n",reflectionCCPS:"#ifdef CLEARCOAT\nuniform float material_clearCoatReflectivity;\nvoid addReflectionCC() {\n\tccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity);\n}\n#endif\n",reflectionCubePS:"uniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n\tlookupVec.x *= -1.0;\n\treturn $DECODE(textureCube(texture_cubeMap, lookupVec));\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionEnvPS:"#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform float material_reflectivity;\nfloat shinyMipLevel(vec2 uv) {\n\tvec2 dx = dFdx(uv);\n\tvec2 dy = dFdy(uv);\n\tvec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);\n\tvec2 dx2 = dFdx(uv2);\n\tvec2 dy2 = dFdy(uv2);\n\tfloat maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n\treturn clamp(0.5 * log2(maxd) - 1.0, 0.0, 6.0);\n}\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 dir = cubeMapProject(tReflDirW) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - tGlossiness) * 5.0;\n\tfloat ilevel = floor(level);\n\tfloat level2 = shinyMipLevel(uv * atlasSize);\n\tfloat ilevel2 = floor(level2);\n\tvec2 uv0, uv1;\n\tfloat weight;\n\tif (ilevel == 0.0) {\n\t\tuv0 = mapMip(uv, ilevel2);\n\t\tuv1 = mapMip(uv, ilevel2 + 1.0);\n\t\tweight = level2 - ilevel2;\n\t} else {\n\t\tuv0 = uv1 = mapRoughnessUv(uv, ilevel);\n\t\tweight = 0.0;\n\t}\n\tvec3 linearA = $DECODE(texture2D(texture_envAtlas, uv0));\n\tvec3 linearB = $DECODE(texture2D(texture_envAtlas, uv1));\n\tvec3 linear0 = mix(linearA, linearB, weight);\n\tvec3 linear1 = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(linear0, linear1, level - ilevel));\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSpherePS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn $DECODE(texture2D(texture_sphereMap, sphereMapUv));\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSphereLowPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = vNormalV;\n\tvec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n\treturn $DECODE(texture2D(texture_sphereMap, sphereMapUv));\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",refractionPS:"uniform float material_refraction, material_refractionIndex;\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n\tfloat vn = dot(viewVec, Normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n\treturn refrVec;\n}\nvoid addRefraction() {\n\tvec3 tmp = dReflDirW;\n\tvec4 tmp2 = dReflection;\n\tdReflection = vec4(0.0);\n\tdReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n\taddReflection();\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n\tdReflDirW = tmp;\n\tdReflection = tmp2;\n}\n",reprojectPS:"varying vec2 vUv0;\nuniform sampler2D sourceTex;\nuniform samplerCube sourceCube;\nuniform sampler2D samplesTex;\nuniform vec2 samplesTexInverseSize;\nuniform vec4 params;\nuniform vec2 params2;\nfloat targetFace() { return params.x; }\nfloat specularPower() { return params.y; }\nfloat sourceCubeSeamScale() { return params.z; }\nfloat targetCubeSeamScale() { return params.w; }\nfloat targetTotalPixels() { return params2.x; }\nfloat sourceTotalPixels() { return params2.y; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 decodeLinear(vec4 source) {\n\treturn source.rgb;\n}\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec3 decodeGamma(vec4 source) {\n\treturn pow(source.xyz, vec3(2.2));\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec3 decodeRGBE(vec4 source) {\n\tif (source.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn source.xyz * pow(2.0, source.w * 255.0 - 128.0);\n\t}\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\nvec3 modifySeams(vec3 dir, float scale) {\n\tvec3 adir = abs(dir);\n\tfloat M = max(max(adir.x, adir.y), adir.z);\n\treturn dir / M * vec3(\n\t\tadir.x == M ? 1.0 : scale,\n\t\tadir.y == M ? 1.0 : scale,\n\t\tadir.z == M ? 1.0 : scale\n\t);\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * sin(uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * cos(uv.x));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nvec4 sampleEquirect(vec2 sph) {\n\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n}\nvec4 sampleEquirect(vec3 dir) {\n\treturn sampleEquirect(toSpherical(dir));\n}\nvec4 sampleCubemap(vec3 dir) {\n\treturn textureCube(sourceCube, modifySeams(dir, 1.0 - sourceCubeSeamScale()));\n}\nvec4 sampleCubemap(vec2 sph) {\n\treturn sampleCubemap(fromSpherical(sph));\n}\nvec4 sampleEquirect(vec2 sph, float mipLevel) {\n\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n#ifdef SUPPORTS_TEXLOD\n\treturn texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n#else\n\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n#endif\n}\nvec4 sampleEquirect(vec3 dir, float mipLevel) {\n\treturn sampleEquirect(toSpherical(dir), mipLevel);\n}\nvec4 sampleCubemap(vec3 dir, float mipLevel) {\n#ifdef SUPPORTS_TEXLOD\n\treturn textureCubeLodEXT(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()), mipLevel);\n#else\n\treturn textureCube(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()));\n#endif\n}\nvec4 sampleCubemap(vec2 sph, float mipLevel) {\n\treturn sampleCubemap(fromSpherical(sph), mipLevel);\n}\nfloat signNotZero(float k){\n\treturn(k >= 0.0) ? 1.0 : -1.0;\n}\nvec2 signNotZero(vec2 v) {\n\treturn vec2(signNotZero(v.x), signNotZero(v.y));\n}\nvec3 octDecode(vec2 o) {\n\tvec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\tif (v.y < 0.0) {\n\t\tv.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n\t}\n\treturn normalize(v);\n}\nvec3 getDirectionOctahedral() {\n\treturn octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\nvec2 octEncode(in vec3 v) {\n\tfloat l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\tvec2 result = v.xz * (1.0 / l1norm);\n\tif (v.y < 0.0) {\n\t\tresult = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n\t}\n\treturn result;\n}\nvec4 sampleOctahedral(vec3 dir) {\n\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n}\nvec4 sampleOctahedral(vec2 sph) {\n\treturn sampleOctahedral(fromSpherical(sph));\n}\nvec4 sampleOctahedral(vec3 dir, float mipLevel) {\n\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n#ifdef SUPPORTS_TEXLOD\n\treturn texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n#else\n\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n#endif\n}\nvec4 sampleOctahedral(vec2 sph, float mipLevel) {\n\treturn sampleOctahedral(fromSpherical(sph), mipLevel);\n}\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = targetFace();\n\tvec3 vec;\n\tif (face == 0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\treturn normalize(modifySeams(vec, 1.0 / (1.0 - targetCubeSeamScale())));\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n\tvec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);\n\tvec3 x = normalize(cross(up, n));\n\tvec3 y = cross(n, x);\n\treturn mat3(x, y, n);\n}\nvec4 reproject() {\n\tif (NUM_SAMPLES <= 1) {\n\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t} else {\n\t\tvec2 sph = toSpherical(TARGET_FUNC());\n\t\tvec2 sphu = dFdx(sph);\n\t\tvec2 sphv = dFdy(sph);\n\t\tconst float NUM_SAMPLES_SQRT = sqrt(float(NUM_SAMPLES));\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {\n\t\t\tfor (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(sph +\n\t\t\t\t\t\t\t\t\t\t\t\t\tsphu * (u / NUM_SAMPLES_SQRT - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t\tsphv * (v / NUM_SAMPLES_SQRT - 0.5)));\n\t\t\t}\n\t\t}\n\t\treturn ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));\n\t}\n}\nvec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\nvoid unpackSample(int i, out vec3 L, out float mipLevel) {\n\tfloat u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;\n\tfloat v = (floor(u) + 0.5) * samplesTexInverseSize.y;\n\tvec4 raw;\n\traw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\traw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\traw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\traw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);\n\tL.xyz = raw.xyz * 2.0 - 1.0;\n\tmipLevel = raw.w * 8.0;\n}\nvec4 prefilterSamples() {\n\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\tvec3 L;\n\tfloat mipLevel;\n\tvec3 result = vec3(0.0);\n\tfloat totalWeight = 0.0;\n\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\tunpackSample(i, L, mipLevel);\n\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel)) * L.z;\n\t\ttotalWeight += L.z;\n\t}\n\treturn ENCODE_FUNC(result / totalWeight);\n}\nvec4 prefilterSamplesUnweighted() {\n\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\tvec3 L;\n\tfloat mipLevel;\n\tvec3 result = vec3(0.0);\n\tfloat totalWeight = 0.0;\n\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\tunpackSample(i, L, mipLevel);\n\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel));\n\t}\n\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n}\nvoid main(void) {\n\tgl_FragColor = PROCESS_FUNC();\n}\n",rgbmPS:"vec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n\treturn decodeRGBM(texture2D(tex, uv));\n}\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n\treturn decodeRGBM(textureCube(tex, uvw));\n}\n",screenDepthPS:"uniform highp sampler2D uDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\tz = z * 2.0 - 1.0;\n\treturn 1.0 / (camera_params.z * z + camera_params.w);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef GL2\n\treturn linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n\t#else\n\treturn unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n\t#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\treturn getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"const float maxCascades = 4.0;\nmat4 cascadeShadowMat;\nvoid getShadowCascadeMatrix(mat4 shadowMatrixPalette[4], float shadowCascadeDistances[4], float shadowCascadeCount) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tfloat cascadeIndex = 0.0;\n\tfor (float i = 0.0; i < maxCascades; i++) {\n\t\tif (depth < shadowCascadeDistances[int(i)]) {\n\t\t\tcascadeIndex = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\tcascadeIndex = min(cascadeIndex, shadowCascadeCount - 1.0);\n\t#ifdef GL2\n\t\tcascadeShadowMat = shadowMatrixPalette[int(cascadeIndex)];\n\t#else\n\t\tif (cascadeIndex == 0.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[0];\n\t\t}\n\t\telse if (cascadeIndex == 1.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[1];\n\t\t}\n\t\telse if (cascadeIndex == 2.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[2];\n\t\t}\n\t\telse {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[3];\n\t\t}\n\t#endif\n}\nvoid fadeShadow(float shadowCascadeDistances[4]) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tif (depth > shadowCascadeDistances[int(maxCascades - 1.0)]) {\n\t\tdShadowCoord.z = -9999999.0;\n\t}\n}\n",shadowCommonPS:"void normalOffsetPointShadow(vec4 shadowParams) {\n\tfloat distScale = length(dLightDirW);\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - dLightPosW;\n\tdLightDirW = dir;\n}\n",shadowCoordPS:"void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tdShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xy /= projPos.w;\n\tdShadowCoord.xy = projPos.xy;\n\tdShadowCoord.z = length(dLightDirW) * shadowParams.w;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",shadowCoordPerspZbufferPS:"void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\tdShadowCoord = projPos.xyz;\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n",shadowEVSMPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2D(tex, texCoords).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowEVSMnPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tfloat pixelSize = 1.0 / resolution;\n\ttexCoords -= vec2(pixelSize);\n\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\tvec2 fr = fract(texCoords * resolution);\n\tvec3 h0 = mix(s00, s10, fr.x);\n\tvec3 h1 = mix(s01, s11, fr.x);\n\tvec3 moments = mix(h0, h1, fr.y);\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowStandardPS:"vec3 lessThan2(vec3 a, vec3 b) {\n\treturn clamp((b - a)*1000.0, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#ifdef GL2\nfloat _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#else\nfloat _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n\tmat3 shadowKernel;\n\tvec3 shadowCoord = dShadowCoord;\n\tvec3 shadowZ = vec3(shadowCoord.z);\n\tshadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\tvec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\tvec3 shadowCoord = dShadowCoord;\n\tfloat xoffset = 1.0 / shadowParams.x;\n\tfloat dx0 = -xoffset;\n\tfloat dx1 = xoffset;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n\tdepthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n\tdepthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n\tdepthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n\tdepthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n\tdepthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n\tdepthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n\tdepthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n\tdepthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\treturn _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n}\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#endif\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\tvec3 tc = normalize(dir);\n\tvec3 tcAbs = abs(tc);\n\tvec4 dirX = vec4(1,0,0, tc.x);\n\tvec4 dirY = vec4(0,1,0, tc.y);\n\tfloat majorAxisLength = tc.z;\n\tif ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n\t\tdirX = vec4(0,0,1, tc.z);\n\t\tdirY = vec4(0,1,0, tc.y);\n\t\tmajorAxisLength = tc.x;\n\t} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n\t\tdirX = vec4(1,0,0, tc.x);\n\t\tdirY = vec4(0,0,1, tc.z);\n\t\tmajorAxisLength = tc.y;\n\t}\n\tfloat shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\tvec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n\tvec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n\tvec3 dx0 = -xoffset;\n\tvec3 dy0 = -yoffset;\n\tvec3 dx1 = xoffset;\n\tvec3 dy1 = yoffset;\n\tmat3 shadowKernel;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n\tdepthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n\tdepthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n\tdepthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n\tdepthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n\tdepthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n\tdepthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n\tdepthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n\tdepthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\tvec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\tshadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\tvec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\tvec2 fractionalCoord = fract( uv * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n\treturn _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n",shadowStandardGL2PS:"float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = gammaCorrectInput(sum);\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",shadowVSM8PS:"float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * Z;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec4 c = texture2D(tex, texCoords);\n\tvec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n\treturn calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",shadowVSM_commonPS:"float linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n\t return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",skinBatchConstVS:"attribute float vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nmat4 getBoneMatrix(const in float i) {\n\tvec4 v1 = matrix_pose[int(3.0 * i)];\n\tvec4 v2 = matrix_pose[int(3.0 * i + 1.0)];\n\tvec4 v3 = matrix_pose[int(3.0 * i + 2.0)];\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinBatchTexVS:"attribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinConstVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tv1 = matrix_pose[int(3.0 * i)];\n\tv2 = matrix_pose[int(3.0 * i + 1.0)];\n\tv3 = matrix_pose[int(3.0 * i + 2.0)];\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skinTexVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxEnvPS:"varying vec3 vViewDir;\nuniform sampler2D texture_envAtlas;\nuniform float mipLevel;\nvoid main(void) {\n\tvec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(normalize(dir));\n\tvec3 linear = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));\n\tgl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n}\n",skyboxHDRPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n\tvec3 dir=vViewDir;\n\tdir.x *= -1.0;\n\tvec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)).rgb);\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",skyboxVS:"attribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nuniform mat3 cubeMapRotationMatrix;\nvarying vec3 vViewDir;\nvoid main(void) {\n\tmat4 view = matrix_view;\n\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\tgl_Position.z = gl_Position.w - 0.00001;\n\tvViewDir = aPosition * cubeMapRotationMatrix;\n}\n",specularPS:"#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\nvoid getSpecularity() {\n\tdSpecularity = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdSpecularity *= material_specular;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdSpecularity *= texture2D(texture_specularMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",specularAaNonePS:"float antiAliasGlossiness(float power) {\n\treturn power;\n}\n",specularAaToksvigPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * mix(1.0, toksvig, material_bumpiness);\n}\n",specularAaToksvigFastPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * toksvig;\n}\n",spotPS:"float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n\tfloat cosAngle = dot(dLightDirNormW, lightSpotDirW);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"void main(void) {\n\tdDiffuseLight = vec3(0);\n\tdSpecularLight = vec3(0);\n\tdReflection = vec4(0);\n\tdSpecularity = vec3(0);\n\t#ifdef CLEARCOAT\n\tccSpecularLight = vec3(0);\n\tccReflection = vec4(0);\n\t#endif\n",startVS:"void main(void) {\n\tgl_Position = getPosition();\n",startNineSlicedPS:"\tnineSlicedUv = vUv0;\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",startNineSlicedTiledPS:"\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n\tvec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n\tvec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",storeEVSMPS:"float exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =\texp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"vec3 getTangent() {\n\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\nvec3 getObjectSpaceUp() {\n\treturn normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n",TBNPS:"void getTBN() {\n\tdTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n",TBNderivativePS:"uniform float tbnBasis;\nvoid getTBN() {\n\tvec2 uv = $UV;\n\tvec3 dp1 = dFdx( vPositionW );\n\tvec3 dp2 = dFdy( vPositionW );\n\tvec2 duv1 = dFdx( uv );\n\tvec2 duv2 = dFdy( uv );\n\tvec3 dp2perp = cross( dp2, dVertexNormalW );\n\tvec3 dp1perp = cross( dVertexNormalW, dp1 );\n\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\tfloat denom = max( dot(T,T), dot(B,B) );\n\tfloat invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );\n\tdTBN = mat3(T * invmax, -B * invmax, dVertexNormalW );\n}\n",TBNfastPS:"void getTBN() {\n\tdTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n",TBNObjectSpacePS:"void getTBN() {\n\tvec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n\tvec3 T = cross(dVertexNormalW, B);\n\tif (dot(B,B)==0.0)\n\t{\n\t\tfloat major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n\t\tif (dVertexNormalW.x==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,1,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.y==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,0,1));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.z==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(1,0,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t}\n\tdTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n",tonemappingAcesPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"uniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,\t1.10813, -0.00605,\n\t-0.00327, -0.07276,\t1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",tonemappingFilmicPS:"const float A =\t0.15;\nconst float B =\t0.50;\nconst float C =\t0.10;\nconst float D =\t0.20;\nconst float E =\t0.02;\nconst float F =\t0.30;\nconst float W =\t11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n\t return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float\tA = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNonePS:"vec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n#ifdef MORPHING_TEXTURE_BASED\nuniform vec4 morph_tex_params;\nvec2 getTextureMorphCoords() {\n\tfloat vertexId = morph_vertex_id;\n\tvec2 textureSize = morph_tex_params.xy;\n\tvec2 invTextureSize = morph_tex_params.zw;\n\tfloat morphGridV = floor(vertexId * invTextureSize.x);\n\tfloat morphGridU = vertexId - (morphGridV * textureSize.x);\n\treturn (vec2(morphGridU, morphGridV) * invTextureSize) + (0.5 * invTextureSize);\n}\n#endif\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\nmat4 getModelMatrix() {\n\t#ifdef DYNAMICBATCH\n\treturn getBoneMatrix(vertex_boneIndices);\n\t#elif defined(SKIN)\n\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t#elif defined(INSTANCING)\n\treturn mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n\t#else\n\treturn matrix_model;\n\t#endif\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec3 localPos = vertex_position;\n\t#ifdef NINESLICED\n\tlocalPos.xz *= outerScale;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\tlocalPos.xz *= -0.5;\n\tlocalPos = localPos.xzy;\n\t#endif\n\t#ifdef MORPHING\n\t#ifdef MORPHING_POS03\n\tlocalPos.xyz += morph_weights_a[0] * morph_pos0;\n\tlocalPos.xyz += morph_weights_a[1] * morph_pos1;\n\tlocalPos.xyz += morph_weights_a[2] * morph_pos2;\n\tlocalPos.xyz += morph_weights_a[3] * morph_pos3;\n\t#endif\n\t#ifdef MORPHING_POS47\n\tlocalPos.xyz += morph_weights_b[0] * morph_pos4;\n\tlocalPos.xyz += morph_weights_b[1] * morph_pos5;\n\tlocalPos.xyz += morph_weights_b[2] * morph_pos6;\n\tlocalPos.xyz += morph_weights_b[3] * morph_pos7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_POSITION\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n\tlocalPos += morphPos;\n\t#endif\n\tvec4 posW = dModelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t#else\n\t#ifdef SCREENSPACE\n\tscreenPos = posW;\n\t#else\n\tscreenPos = matrix_viewProjection * posW;\n\t#endif\n\t#ifdef PIXELSNAP\n\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\tscreenPos.xy *= uScreenSize.xy;\n\tscreenPos.xy = floor(screenPos.xy);\n\tscreenPos.xy *= uScreenSize.zw;\n\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",transformDeclVS:"attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n",uv0VS:"#ifdef NINESLICED\nvec2 getUv0() {\n\tvec2 uv = vertex_position.xz;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tuv = uv * -0.5 + 0.5;\n\tuv = uv * atlasRect.zw + atlasRect.xy;\n\tvMask = vertex_texCoord0.xy;\n\treturn uv;\n}\n#else\nvec2 getUv0() {\n\treturn vertex_texCoord0;\n}\n#endif\n",uv1VS:"vec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",viewDirPS:"void getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n\treturn mat3(matrix_view) * vNormalW;\n}\n"};function Qt(t,e){return e||(e=Zt),1===t||2===t?e.gamma2_2PS?e.gamma2_2PS:Zt.gamma2_2PS:3===t?"#define HDR\n"+(e.gamma2_2PS?e.gamma2_2PS:Zt.gamma2_2PS):e.gamma1_0PS?e.gamma1_0PS:Zt.gamma1_0PS}function Jt(t,e){return e||(e=Zt),1===t?e.tonemappingFilmicPS?e.tonemappingFilmicPS:Zt.tonemappingFilmicPS:0===t?e.tonemappingLinearPS?e.tonemappingLinearPS:Zt.tonemappingLinearPS:2===t?e.tonemappingHejlPS?e.tonemappingHejlPS:Zt.tonemappingHejlPS:3===t?e.tonemappingAcesPS?e.tonemappingAcesPS:Zt.tonemappingAcesPS:4===t?e.tonemappingAces2PS?e.tonemappingAces2PS:Zt.tonemappingAces2PS:e.tonemapingNonePS?e.tonemapingNonePS:Zt.tonemappingNonePS}function te(t,e){return e||(e=Zt),"linear"===t?e.fogLinearPS?e.fogLinearPS:Zt.fogLinearPS:"exp"===t?e.fogExpPS?e.fogExpPS:Zt.fogExpPS:"exp2"===t?e.fogExp2PS?e.fogExp2PS:Zt.fogExp2PS:e.fogNonePS?e.fogNonePS:Zt.fogNonePS}function ee(t,e){return e||(e=Zt),t.supportsBoneTextures?e.skinTexVS:"#define BONE_LIMIT "+t.getBoneLimit()+"\n"+e.skinConstVS}function se(t){let e="precision "+t.precision+" float;\n";return t.webgl2&&(e+="#ifdef GL2\nprecision "+t.precision+" sampler2DShadow;\n#endif\n"),e}function ie(t){return t.webgl2?"#version 300 es\n":""}function ne(){return"void main(void) {gl_FragColor = vec4(0.0);}"}function ae(){return"void main(void)\n{\n"}function re(){return"}\n"}const oe={vertex_position:ot,vertex_normal:lt,vertex_tangent:ht,vertex_texCoord0:mt,vertex_texCoord1:_t,vertex_texCoord2:ft,vertex_texCoord3:gt,vertex_texCoord4:yt,vertex_texCoord5:vt,vertex_texCoord6:bt,vertex_texCoord7:xt,vertex_color:ut,vertex_boneIndices:dt,vertex_boneWeights:ct};function le(t){const e={};let s=0,i=t.indexOf("attribute");for(;i>=0&&!(i>0&&"/"===t[i-1]);){const n=t.indexOf(";",i),a=t.lastIndexOf(" ",n),r=t.substr(a+1,n-(a+1)),o=oe[r];void 0!==o?e[r]=o:(e[r]="ATTR"+s,s++),i=t.indexOf("attribute",i+1)}return e}function he(t,e,s,i,n=!1,a=""){const r=t.programLib._cache,o=r[i];if(void 0!==o)return o;s=se(t)+"\n"+(s||"void main(void) {gl_FragColor = vec4(0.0);}");const l=le(e);return t.webgl2&&(e=ie(t)+Zt.gles3VS+e,s=ie(t)+Zt.gles3PS+s),r[i]=new Shader(t,{attributes:l,vshader:e,fshader:a+s,useTransformFeedback:n}),r[i]}Zt.collectAttribs=le,Zt.createShader=function(t,e,s,i=!1){let n=Zt[e],a=se(t)+"\n"+Zt[s];const r=le(n);return t.webgl2&&(n=ie(t)+Zt.gles3VS+n,a=ie(t)+Zt.gles3PS+a),new Shader(t,{attributes:r,vshader:n,fshader:a,useTransformFeedback:i})},Zt.createShaderFromCode=he;const ce={generateKey:function(t){let e="basic";return t.fog&&(e+="_fog"),t.alphaTest&&(e+="_atst"),t.vertexColors&&(e+="_vcol"),t.diffuseMap&&(e+="_diff"),t.skin&&(e+="_skin"),t.screenSpace&&(e+="_ss"),t.useInstancing&&(e+="_inst"),t.useMorphPosition&&(e+="_morphp"),t.useMorphNormal&&(e+="_morphn"),t.useMorphTextureBased&&(e+="_morpht"),e+="_"+t.pass,e},createShaderDefinition:function(t,e){const s={vertex_position:ot};e.skin&&(s.vertex_boneWeights=ct,s.vertex_boneIndices=dt),e.vertexColors&&(s.vertex_color=ut),e.diffuseMap&&(s.vertex_texCoord0=mt);let i="";i+=Zt.transformDeclVS,e.skin?(i+=ee(t),i+=Zt.transformSkinnedVS):i+=Zt.transformVS,e.vertexColors&&(i+="attribute vec4 vertex_color;\n",i+="varying vec4 vColor;\n"),e.diffuseMap&&(i+="attribute vec2 vertex_texCoord0;\n",i+="varying vec2 vUv0;\n"),2===e.pass&&(i+="varying float vDepth;\n",i+="#ifndef VIEWMATRIX\n",i+="#define VIEWMATRIX\n",i+="uniform mat4 matrix_view;\n",i+="#endif\n",i+="#ifndef CAMERAPLANES\n",i+="#define CAMERAPLANES\n",i+="uniform vec4 camera_params;\n\n",i+="#endif\n"),i+="void main(void)\n{\n",i+="\t gl_Position = getPosition();\n",2===e.pass&&(i+="\t\tvDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n"),e.vertexColors&&(i+="\t\tvColor = vertex_color;\n"),e.diffuseMap&&(i+="\t\tvUv0 = vertex_texCoord0;\n"),i+="}\n";const n=i;i=se(t),e.vertexColors?i+="varying vec4 vColor;\n":i+="uniform vec4 uColor;\n",e.diffuseMap&&(i+="varying vec2 vUv0;\n",i+="uniform sampler2D texture_diffuseMap;\n"),e.fog&&(i+=te(e.fog)),e.alphatest&&(i+=Zt.alphaTestPS),2===e.pass&&(i+="varying float vDepth;\n",i+=Zt.packDepthPS),i+="void main(void)\n{\n",e.vertexColors?i+="\t\tgl_FragColor = vColor;\n":i+="\t\tgl_FragColor = uColor;\n",e.diffuseMap&&(i+="\t\tgl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n"),e.alphatest&&(i+="\t alphaTest(gl_FragColor.a);\n"),18!==e.pass&&(2===e.pass?i+="\t\tgl_FragColor = packFloat(vDepth);\n":e.fog&&(i+="\t glFragColor.rgb = addFog(gl_FragColor.rgb);\n")),i+="}\n";return{attributes:s,vshader:n,fshader:i}}},de={generateKey:function(t){let e="particle";for(const s in t)t.hasOwnProperty(s)&&(e+=t[s]);return e},_animTex:function(t){let e="";return e+=t.animTexLoop?Zt.particleAnimFrameLoopVS:Zt.particleAnimFrameClampVS,e+=Zt.particleAnimTexVS,e},createShaderDefinition:function(t,e){let s="",i=se(t)+"\n";i+="#define PARTICLE\n",t.webgl2&&(s+="#define GL2\n",i+="#define GL2\n"),s+="#define VERTEXSHADER\n",e.mesh&&(s+="#define USE_MESH\n"),e.localSpace&&(s+="#define LOCAL_SPACE\n"),e.screenSpace&&(s+="#define SCREEN_SPACE\n"),e.animTex&&(s+="\nuniform vec2 animTexTilesParams;\n"),e.animTex&&(s+="\nuniform vec4 animTexParams;\n"),e.animTex&&(s+="\nuniform vec2 animTexIndexParams;\n"),2===e.normal&&(s+="\nvarying mat3 ParticleMat;\n"),1===e.normal&&(s+="\nvarying vec3 Normal;\n"),e.soft&&(s+="\nvarying float vDepth;\n");const n=e.customFace?Zt.particle_customFaceVS:Zt.particle_billboardVS;e.useCpu?(e.soft>0&&(s+=Zt.screenDepthPS),s+=Zt.particle_cpuVS,e.localSpace&&(s+=Zt.particle_localShiftVS),e.animTex&&(s+=this._animTex(e)),e.alignToMotion&&(s+=Zt.particle_pointAlongVS),s+=e.mesh?Zt.particle_meshVS:n,1===e.normal&&(s+=Zt.particle_normalVS),2===e.normal&&(s+=Zt.particle_TBNVS),e.stretch>0&&(s+=Zt.particle_stretchVS),s+=Zt.particle_cpu_endVS,e.soft>0&&(s+=Zt.particle_softVS)):(s+=Zt.particle_initVS,s+=e.pack8?Zt.particleInputRgba8PS:Zt.particleInputFloatPS,e.soft>0&&(s+=Zt.screenDepthPS),s+=Zt.particleVS,e.localSpace&&(s+=Zt.particle_localShiftVS),e.animTex&&(s+=this._animTex(e)),e.wrap&&(s+=Zt.particle_wrapVS),e.alignToMotion&&(s+=Zt.particle_pointAlongVS),s+=e.mesh?Zt.particle_meshVS:n,1===e.normal&&(s+=Zt.particle_normalVS),2===e.normal&&(s+=Zt.particle_TBNVS),e.stretch>0&&(s+=Zt.particle_stretchVS),s+=Zt.particle_endVS,e.soft>0&&(s+=Zt.particle_softVS)),s+="}\n",e.normal>0&&(1===e.normal?i+="\nvarying vec3 Normal;\n":2===e.normal&&(i+="\nvarying mat3 ParticleMat;\n"),i+="\nuniform vec3 lightCube[6];\n"),e.soft&&(i+="\nvarying float vDepth;\n"),0===e.normal&&"none"===e.fog&&(e.srgb=!1),i+=Qt(e.gamma),i+=Jt(e.toneMap),"linear"===e.fog?i+=Zt.fogLinearPS:"exp"===e.fog?i+=Zt.fogExpPS:"exp2"===e.fog?i+=Zt.fogExp2PS:i+=Zt.fogNonePS,2===e.normal&&(i+="\nuniform sampler2D normalMap;\n"),e.soft>0&&(i+=Zt.screenDepthPS),i+=Zt.particlePS,e.soft>0&&(i+=Zt.particle_softPS),1===e.normal&&(i+="\nvec3 normal = Normal;\n"),2===e.normal&&(i+=Zt.particle_normalMapPS),e.normal>0&&(i+=e.halflambert?Zt.particle_halflambertPS:Zt.particle_lambertPS),e.normal>0&&(i+=Zt.particle_lightingPS),2===e.blend?i+=Zt.particle_blendNormalPS:1===e.blend?i+=Zt.particle_blendAddPS:5===e.blend&&(i+=Zt.particle_blendMultiplyPS),i+=Zt.particle_endPS;return{attributes:le(s),vshader:s,fshader:i}}},ue={generateKey:function(t){return"cubemap"===t.type?`skybox-${t.type}-${t.rgbm}-${t.hdr}-${t.fixSeams}-${t.toneMapping}-${t.gamma}-${t.useIntensity}-${t.mip}`:`skybox-${t.type}-${t.encoding}-${t.useIntensity}-${t.gamma}-${t.toneMapping}`},createShaderDefinition:function(t,e){let s;if("cubemap"===e.type){const i=[128,64,16,8,4,2];s=se(t),s+=e.mip?Zt.fixCubemapSeamsStretchPS:Zt.fixCubemapSeamsNonePS,s+=e.useIntensity?Zt.envMultiplyPS:Zt.envConstPS,s+=Qt(e.gamma),s+=Jt(e.toneMapping),s+=Zt.decodePS,s+=Zt.rgbmPS,s+=Zt.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,e.rgbm?"textureCubeRGBM":e.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/i[e.mip]+"")}else{const i={rgbm:"decodeRGBM",rgbe:"decodeRGBE",linear:"decodeLinear"};s=se(t),s+=e.useIntensity?Zt.envMultiplyPS:Zt.envConstPS,s+=Qt(e.gamma),s+=Jt(e.toneMapping),s+=Zt.decodePS,s+=Zt.skyboxEnvPS.replace(/\$DECODE/g,i[e.encoding]||"decodeGamma")}return{attributes:{aPosition:ot},vshader:Zt.skyboxVS,fshader:s}}},pe=1/255,me=new Float32Array(1),_e=new Int32Array(me.buffer);class FloatPacking{static float2Half(t){me[0]=t;const e=_e[0];let s=e>>16&32768,i=e>>12&2047;const n=e>>23&255;return n<103?s:n>142?(s|=31744,s|=(255===n?0:1)&&8388607&e,s):n<113?(i|=2048,s|=(i>>114-n)+(i>>113-n&1),s):(s|=n-112<<10|i>>1,s+=1&i,s)}static float2Bytes(t,e,s,i){const n=255*t%1;if(e[s+0]=Math.round(255*(t%1-pe*n)),i>1){const a=65025*t%1;if(e[s+1]=Math.round(255*(n-pe*a)),i>2){const n=16581375*t%1;e[s+2]=Math.round(255*(a-pe*n)),i>3&&(e[s+3]=Math.round(255*n))}}}static float2BytesRange(t,e,s,i,n,a){t=O.clamp((t-i)/(n-i),0,1),FloatPacking.float2Bytes(t,e,s,a)}static float2MantissaExponent(t,e,s,i){const n=Math.floor(Math.log2(Math.abs(t)))+1;t/=Math.pow(2,n),FloatPacking.float2BytesRange(t,e,s,-1,1,i-1),e[s+i-1]=Math.round(n+127)}}let fe=null,ge=null;class Texture{constructor(t,e){this.device=t,this.name=null,this._width=4,this._height=4,this._depth=1,this._format=7,this.type=Ft,this.projection=zt,this._cubemap=!1,this._volume=!1,this.fixCubemapSeams=!1,this._flipY=!1,this._premultiplyAlpha=!1,this._isRenderTarget=!1,this._mipmaps=!0,this._minFilter=5,this._magFilter=1,this._anisotropy=1,this._addressU=0,this._addressV=0,this._addressW=0,this._compareOnRead=!1,this._compareFunc=1,void 0!==e&&(void 0!==e.name&&(this.name=e.name),this._width=void 0!==e.width?e.width:this._width,this._height=void 0!==e.height?e.height:this._height,this._format=void 0!==e.format?e.format:this._format,e.hasOwnProperty("type")?this.type=e.type:e.hasOwnProperty("rgbm")?this.type=e.rgbm?Ot:Ft:e.hasOwnProperty("swizzleGGGR")&&(this.type=e.swizzleGGGR?Bt:Ft),void 0!==e.mipmaps?this._mipmaps=e.mipmaps:this._mipmaps=void 0!==e.autoMipmap?e.autoMipmap:this._mipmaps,this._levels=e.levels,this._cubemap=void 0!==e.cubemap?e.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==e.fixCubemapSeams?e.fixCubemapSeams:this.fixCubemapSeams,this._cubemap?this.projection=Ut:e.projection&&e.projection!==Ut&&(this.projection=e.projection),this._minFilter=void 0!==e.minFilter?e.minFilter:this._minFilter,this._magFilter=void 0!==e.magFilter?e.magFilter:this._magFilter,this._anisotropy=void 0!==e.anisotropy?e.anisotropy:this._anisotropy,this._addressU=void 0!==e.addressU?e.addressU:this._addressU,this._addressV=void 0!==e.addressV?e.addressV:this._addressV,this._compareOnRead=void 0!==e.compareOnRead?e.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==e._compareFunc?e._compareFunc:this._compareFunc,this._flipY=void 0!==e.flipY?e.flipY:this._flipY,this._premultiplyAlpha=void 0!==e.premultiplyAlpha?e.premultiplyAlpha:this._premultiplyAlpha,t.webgl2&&(this._depth=void 0!==e.depth?e.depth:this._depth,this._volume=void 0!==e.volume?e.volume:this._volume,this._addressW=void 0!==e.addressW?e.addressW:this._addressW)),this._compressed=8===this._format||9===this._format||this._format===nt||this._format>=21,this._invalid=!1,this._lockedLevel=-1,this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.dirtyAll(),this._gpuSize=0}set minFilter(t){this._minFilter!==t&&(this._minFilter=t,this._parameterFlags|=1)}get minFilter(){return this._minFilter}set magFilter(t){this._magFilter!==t&&(this._magFilter=t,this._parameterFlags|=2)}get magFilter(){return this._magFilter}set addressU(t){this._addressU!==t&&(this._addressU=t,this._parameterFlags|=4)}get addressU(){return this._addressU}set addressV(t){this._addressV!==t&&(this._addressV=t,this._parameterFlags|=8)}get addressV(){return this._addressV}set addressW(t){this.device.webgl2&&this._volume&&t!==this._addressW&&(this._addressW=t,this._parameterFlags|=16)}get addressW(){return this._addressW}set compareOnRead(t){this._compareOnRead!==t&&(this._compareOnRead=t,this._parameterFlags|=32)}get compareOnRead(){return this._compareOnRead}set compareFunc(t){this._compareFunc!==t&&(this._compareFunc=t,this._parameterFlags|=64)}get compareFunc(){return this._compareFunc}set anisotropy(t){this._anisotropy!==t&&(this._anisotropy=t,this._parameterFlags|=128)}get anisotropy(){return this._anisotropy}set autoMipmap(t){this._mipmaps=t}get autoMipmap(){return this._mipmaps}set mipmaps(t){this._mipmaps!==t&&(this._mipmaps=t,t&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const t=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return Texture.calcGpuSize(this._width,this._height,this._depth,this._format,t,this._cubemap)}get volume(){return this._volume}set flipY(t){this._flipY!==t&&(this._flipY=t,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(t){this._premultiplyAlpha!==t&&(this._premultiplyAlpha=t,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return O.powerOfTwo(this._width)&&O.powerOfTwo(this._height)}get encoding(){return this.type===Ot?"rgbm":this.type===Vt?"rgbe":this.format===at||this.format===rt?"linear":"srgb"}static calcGpuSize(t,e,s,i,n,a){fe||(fe=[],fe[0]=1,fe[1]=1,fe[2]=2,fe[3]=2,fe[4]=2,fe[5]=2,fe[6]=4,fe[7]=4,fe[11]=8,fe[12]=8,fe[13]=16,fe[14]=16,fe[15]=4,fe[16]=4,fe[17]=4,fe[18]=4,fe[19]=4,fe[20]=4),ge||(ge=[],ge[21]=8,ge[22]=8,ge[24]=8,ge[25]=8,ge[26]=8,ge[27]=8,ge[8]=8,ge[29]=8,ge[23]=16,ge[9]=16,ge[10]=16,ge[28]=16,ge[30]=16);const r=fe.hasOwnProperty(i)?fe[i]:0,o=ge.hasOwnProperty(i)?ge[i]:0;let l=0;for(;;){if(r>0)l+=t*e*s*r;else{let n=Math.floor((t+3)/4);const a=Math.floor((e+3)/4),r=Math.floor((s+3)/4);24!==i&&25!==i||(n=Math.max(Math.floor(n/2),1)),l+=n*a*r*o}if(!n||1===t&&1===e&&1===s)break;t=Math.max(Math.floor(t/2),1),e=Math.max(Math.floor(e/2),1),s=Math.max(Math.floor(s/2),1)}return l*(a?6:1)}destroy(){this.device&&this.device.destroyTexture(this),this.device=null,this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255}lock(t={}){if(void 0===t.level&&(t.level=0),void 0===t.face&&(t.face=0),void 0===t.mode&&(t.mode=2),this._lockedLevel=t.level,null===this._levels[t.level])switch(this._format){case 0:case 1:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth);break;case 2:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case 3:case 4:case 5:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth);break;case 6:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case 7:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case 8:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case 9:case nt:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case 11:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case 13:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*3);break;case at:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case rt:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[t.level]}setSource(t,e=0){let s,i,n=!1;if(this._cubemap){if(t[0]){s=t[0].width||0,i=t[0].height||0;for(let e=0;e<6;e++){const a=t[e];if(!a||a.width!==s||a.height!==i||!this.device._isBrowserInterface(a)){n=!0;break}}}else n=!0;if(!n)for(let s=0;s<6;s++)this._levels[e][s]!==t[s]&&(this._levelsUpdated[e][s]=!0)}else this.device._isBrowserInterface(t)||(n=!0),n||(t!==this._levels[e]&&(this._levelsUpdated[e]=!0),s=t.width,i=t.height);if(n)if(this._width=4,this._height=4,this._cubemap)for(let a=0;a<6;a++)this._levels[e][a]=null,this._levelsUpdated[e][a]=!0;else this._levels[e]=null,this._levelsUpdated[e]=!0;else 0===e&&(this._width=s,this._height=i),this._levels[e]=t;this._invalid===n&&n||(this._invalid=n,this.upload())}getSource(t=0){return this._levels[t]}unlock(){this._lockedLevel,this.upload(),this._lockedLevel=-1}upload(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps}getDds(){let t=128,e=0;for(;this._levels[e];){if(this.cubemap)for(let s=0;s<6;s++){if(!this._levels[e][s])return;const i=this._levels[e][s].length;if(!i)return;t+=i}else{const s=this._levels[e].length;if(!s)return;t+=s}t+=this._levels[e].length,e++}const s=new ArrayBuffer(t),i=new Uint32Array(s,0,32);let n=528391;this._levels.length>1&&(n|=131072);let a=4096;this._levels.length>1&&(a|=4194304),(this._levels.length>1||this.cubemap)&&(a|=8);const r=this.cubemap?65024:0;i[0]=542327876,i[1]=124,i[2]=n,i[3]=this.height,i[4]=this.width,i[5]=this.width*this.height*4,i[6]=0,i[7]=this._levels.length;for(let l=0;l<11;l++)i[8+l]=0;i[19]=32,i[20]=65,i[21]=0,i[22]=32,i[23]=16711680,i[24]=65280,i[25]=255,i[26]=4278190080,i[27]=a,i[28]=r,i[29]=0,i[30]=0,i[31]=0;let o=128;if(this.cubemap)for(let l=0;l<6;l++)for(let t=0;t<this._levels.length;t++){const e=this._levels[t][l],i=new Uint8Array(s,o,e.length);for(let t=0;t<e.length;t++)i[t]=e[t];o+=e.length}else for(let l=0;l<this._levels.length;l++){const t=this._levels[l],e=new Uint8Array(s,o,t.length);for(let s=0;s<t.length;s++)e[s]=t[s];o+=t.length}return s}}const ye=new Vec3,ve=new Vec3,be=new Vec3,xe=new Mat4;class Camera{constructor(){this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new Color(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullingMask=4294967295,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[0,1,2,4,3],this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new Vec4(0,0,1,1),this._renderTarget=null,this._scissorRect=new Vec4(0,0,1,1),this._scissorRectClear=!1,this._vrDisplay=null,this._projMat=new Mat4,this._projMatDirty=!0,this._projMatSkybox=new Mat4,this._viewMat=new Mat4,this._viewMatDirty=!0,this._viewProjMat=new Mat4,this._viewProjMatDirty=!0,this.frustum=new Frustum}set aspectRatio(t){this._aspectRatio!==t&&(this._aspectRatio=t,this._projMatDirty=!0)}get aspectRatio(){return this._aspectRatio}set aspectRatioMode(t){this._aspectRatioMode!==t&&(this._aspectRatioMode=t,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(t){this._calculateProjection=t,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(t){this._calculateTransform=t}get calculateTransform(){return this._calculateTransform}set clearColor(t){this._clearColor.copy(t)}get clearColor(){return this._clearColor}set clearColorBuffer(t){this._clearColorBuffer=t}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(t){this._clearDepth=t}get clearDepth(){return this._clearDepth}set clearDepthBuffer(t){this._clearDepthBuffer=t}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(t){this._clearStencil=t}get clearStencil(){return this._clearStencil}set clearStencilBuffer(t){this._clearStencilBuffer=t}get clearStencilBuffer(){return this._clearStencilBuffer}set cullingMask(t){this._cullingMask=t}get cullingMask(){return this._cullingMask}set cullFaces(t){this._cullFaces=t}get cullFaces(){return this._cullFaces}set farClip(t){this._farClip!==t&&(this._farClip=t,this._projMatDirty=!0)}get farClip(){return this._farClip}set flipFaces(t){this._flipFaces=t}get flipFaces(){return this._flipFaces}set fov(t){this._fov!==t&&(this._fov=t,this._projMatDirty=!0)}get fov(){return this._fov}set frustumCulling(t){this._frustumCulling=t}get frustumCulling(){return this._frustumCulling}set horizontalFov(t){this._horizontalFov!==t&&(this._horizontalFov=t,this._projMatDirty=!0)}get horizontalFov(){return this._horizontalFov}set layers(t){this._layers=t.slice(0)}get layers(){return this._layers}set nearClip(t){this._nearClip!==t&&(this._nearClip=t,this._projMatDirty=!0)}get nearClip(){return this._nearClip}set node(t){this._node=t}get node(){return this._node}set orthoHeight(t){this._orthoHeight!==t&&(this._orthoHeight=t,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(t){this._projection!==t&&(this._projection=t,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(t){this._rect.copy(t)}get rect(){return this._rect}set renderTarget(t){this._renderTarget=t}get renderTarget(){return this._renderTarget}set scissorRect(t){this._scissorRect.copy(t)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){const t=this._node.getWorldTransform();this._viewMat.copy(t).invert(),this._viewMatDirty=!1}return this._viewMat}set vrDisplay(t){this._vrDisplay=t,t&&(t._camera=this)}get vrDisplay(){return this._vrDisplay}clone(){return(new Camera).copy(this)}copy(t){return this.aspectRatio=t.aspectRatio,this.aspectRatioMode=t.aspectRatioMode,this.calculateProjection=t.calculateProjection,this.calculateTransform=t.calculateTransform,this.clearColor=t.clearColor,this.clearColorBuffer=t.clearColorBuffer,this.clearDepth=t.clearDepth,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencil=t.clearStencil,this.clearStencilBuffer=t.clearStencilBuffer,this.cullFaces=t.cullFaces,this.cullingMask=t.cullingMask,this.farClip=t.farClip,this.flipFaces=t.flipFaces,this.fov=t.fov,this.frustumCulling=t.frustumCulling,this.horizontalFov=t.horizontalFov,this.layers=t.layers,this.nearClip=t.nearClip,this.orthoHeight=t.orthoHeight,this.projection=t.projection,this.rect=t.rect,this.renderTarget=t.renderTarget,this.scissorRect=t.scissorRect,this.vrDisplay=t.vrDisplay,this}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(t,e,s,i=new Vec3){this._updateViewProjMat(),this._viewProjMat.transformPoint(t,i);const n=this._viewProjMat.data,a=t.x*n[3]+t.y*n[7]+t.z*n[11]+1*n[15];return i.x=.5*(i.x/a+1)*e,i.y=.5*(1-i.y/a)*s,i}screenToWorld(t,e,s,i,n,a=new Vec3){const r=this._farClip-this._nearClip;if(ye.set(t/i,(n-e)/n,s/r),ye.mulScalar(2),ye.sub(Vec3.ONE),0===this._projection){Mat4._getPerspectiveHalfSize(ve,this._fov,this._aspectRatio,this._nearClip,this._horizontalFov),ve.x*=ye.x,ve.y*=ye.y;const t=this._node.getWorldTransform();ve.z=-this._nearClip,t.transformPoint(ve,be);const e=this._node.getPosition();a.sub2(be,e),a.normalize(),a.mulScalar(s),a.add(e)}else this._updateViewProjMat(),xe.copy(this._viewProjMat).invert(),xe.transformPoint(ye,a);return a}_evaluateProjectionMatrix(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip,this._horizontalFov),this._projMatSkybox.copy(this._projMat);else{const t=this._orthoHeight,e=t*this._aspectRatio;this._projMat.setOrtho(-e,e,-t,t,this._nearClip,this._farClip),this._projMatSkybox.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getScreenSize(t){if(0===this._projection){const e=this._node.getPosition().distance(t.center);if(e<t.radius)return 1;const s=Math.asin(t.radius/e),i=Math.tan(s),n=Math.tan(this._fov/2*O.DEG_TO_RAD);return Math.min(i/n,1)}return O.clamp(t.radius/this._orthoHeight,0,1)}}const Se=new Mat4,we=new Vec3,Ce=new Quat,Te=new Quat,Me=new Vec3,Ae=new Vec3,Pe=new Mat4,Ee=new Quat,Le=new Vec3,Re=new Mat4,Ie=new Quat,De=new Quat,ke=new Mat4,Fe=new Vec3,Oe=new Vec3;class GraphNode extends EventHandler{constructor(t="Untitled"){super(),this.name=t,this.tags=new Tags(this),this._labels={},this.localPosition=new Vec3,this.localRotation=new Quat,this.localScale=new Vec3(1,1,1),this.localEulerAngles=new Vec3,this.position=new Vec3,this.rotation=new Quat,this.eulerAngles=new Vec3,this._scale=null,this.localTransform=new Mat4,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new Mat4,this._dirtyWorld=!1,this.normalMatrix=new Mat3,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1}get right(){return this._right||(this._right=new Vec3),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new Vec3),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new Vec3),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}set enabled(t){this._enabled!==t&&(this._enabled=t,this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,t))}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let t=this._parent;if(!t)return"";let e=this.name;for(;t&&t._parent;)e=`${t.name}/${e}`,t=t._parent;return e}get root(){let t=this;for(;t._parent;)t=t._parent;return t}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(t,e){t._onHierarchyStateChanged(e);const s=t._children;for(let i=0,n=s.length;i<n;i++)s[i]._enabled&&this._notifyHierarchyStateChanged(s[i],e)}_onHierarchyStateChanged(t){this._enabledInHierarchy=t,t&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(t){t.name=this.name;const e=this.tags._list;t.tags.clear();for(let s=0;s<e.length;s++)t.tags.add(e[s]);t._labels=Object.assign({},this._labels),t.localPosition.copy(this.localPosition),t.localRotation.copy(this.localRotation),t.localScale.copy(this.localScale),t.localEulerAngles.copy(this.localEulerAngles),t.position.copy(this.position),t.rotation.copy(this.rotation),t.eulerAngles.copy(this.eulerAngles),t.localTransform.copy(this.localTransform),t._dirtyLocal=this._dirtyLocal,t.worldTransform.copy(this.worldTransform),t._dirtyWorld=this._dirtyWorld,t._dirtyNormal=this._dirtyNormal,t._aabbVer=this._aabbVer+1,t._enabled=this._enabled,t.scaleCompensation=this.scaleCompensation,t._enabledInHierarchy=!1}clone(){const t=new GraphNode;return this._cloneInternal(t),t}copy(t){return t._cloneInternal(this),this}find(t,e){let s,i=[];const n=this._children.length;if(t instanceof Function){const e=t;s=e(this),s&&i.push(this);for(let t=0;t<n;t++){const s=this._children[t].find(e);s.length&&(i=i.concat(s))}}else{let s;this[t]&&(s=this[t]instanceof Function?this[t]():this[t],s===e&&i.push(this));for(let a=0;a<n;++a){const s=this._children[a].find(t,e);s.length&&(i=i.concat(s))}}return i}findOne(t,e){const s=this._children.length;let i=null;if(t instanceof Function){const e=t;if(i=e(this),i)return this;for(let t=0;t<s;t++)if(i=this._children[t].findOne(e),i)return i}else{let n;if(this[t]&&(n=this[t]instanceof Function?this[t]():this[t],n===e))return this;for(let a=0;a<s;a++)if(i=this._children[a].findOne(t,e),null!==i)return i}return null}findByTag(){const t=arguments,e=[],s=(i,n)=>{n&&i.tags.has(...t)&&e.push(i);for(let t=0;t<i._children.length;t++)s(i._children[t],!0)};return s(this,!1),e}findByName(t){if(this.name===t)return this;for(let e=0;e<this._children.length;e++){const s=this._children[e].findByName(t);if(null!==s)return s}return null}findByPath(t){const e=Array.isArray(t)?t:t.split("/");let s=this;for(let i=0,n=e.length;i<n;++i)if(s=s.children.find((t=>t.name===e[i])),!s)return null;return s}forEach(t,e){t.call(e,this);const s=this._children;for(let i=0;i<s.length;i++)s[i].forEach(t,e)}isDescendantOf(t){let e=this._parent;for(;e;){if(e===t)return!0;e=e._parent}return!1}isAncestorOf(t){return t.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new Vec3),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform}reparent(t,e){const s=this._parent;s&&s.removeChild(this),t&&(e>=0?t.insertChild(this,e):t.addChild(this))}setLocalEulerAngles(t,e,s){t instanceof Vec3?this.localRotation.setFromEulerAngles(t.x,t.y,t.z):this.localRotation.setFromEulerAngles(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(t,e,s){t instanceof Vec3?this.localPosition.copy(t):this.localPosition.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(t,e,s,i){t instanceof Quat?this.localRotation.copy(t):this.localRotation.set(t,e,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(t,e,s){t instanceof Vec3?this.localScale.copy(t):this.localScale.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let t=this._parent;for(;t;)t._frozen=!1,t=t._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let t=0;t<this._children.length;t++)this._children[t]._dirtyWorld||this._children[t]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._aabbVer++}setPosition(t,e,s){t instanceof Vec3?Le.copy(t):Le.set(t,e,s),null===this._parent?this.localPosition.copy(Le):(Re.copy(this._parent.getWorldTransform()).invert(),Re.transformPoint(Le,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(t,e,s,i){if(t instanceof Quat?Ie.copy(t):Ie.set(t,e,s,i),null===this._parent)this.localRotation.copy(Ie);else{const t=this._parent.getRotation();De.copy(t).invert(),this.localRotation.copy(De).mul(Ie)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(t,e,s){if(t instanceof Vec3?this.localRotation.setFromEulerAngles(t.x,t.y,t.z):this.localRotation.setFromEulerAngles(t,e,s),null!==this._parent){const t=this._parent.getRotation();De.copy(t).invert(),this.localRotation.mul2(De,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(t){if(null!==t._parent)throw new Error("GraphNode is already parented");this._children.push(t),this._onInsertChild(t)}addChildAndSaveTransform(t){const e=t.getPosition(),s=t.getRotation(),i=t._parent;i&&i.removeChild(t),t.setPosition(Pe.copy(this.worldTransform).invert().transformPoint(e)),t.setRotation(Ee.copy(this.getRotation()).invert().mul(s)),this._children.push(t),this._onInsertChild(t)}insertChild(t,e){if(null!==t._parent)throw new Error("GraphNode is already parented");this._children.splice(e,0,t),this._onInsertChild(t)}_fireOnHierarchy(t,e,s){this.fire(t,s);for(let i=0;i<this._children.length;i++)this._children[i]._fireOnHierarchy(e,e,s)}_onInsertChild(t){t._parent=this;const e=t._enabled&&this.enabled;t._enabledInHierarchy!==e&&(t._enabledInHierarchy=e,t._notifyHierarchyStateChanged(t,e)),t._updateGraphDepth(),t._dirtifyWorld(),this._frozen&&t._unfreezeParentToRoot(),t._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",t)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let t=0,e=this._children.length;t<e;t++)this._children[t]._updateGraphDepth()}removeChild(t){const e=this._children.indexOf(t);-1!==e&&(this._children.splice(e,1),t._parent=null,t._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",t))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let t;const e=this._parent;let s=this.localScale,i=e;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent,i&&(t=i.worldTransform.getScale(),Me.mul2(t,this.localScale),s=Me))}Te.setFromMat4(e.worldTransform),Ce.mul2(Te,this.localRotation);let n=e.worldTransform;e.scaleCompensation&&(Ae.mul2(t,e.getLocalScale()),Se.setTRS(e.worldTransform.getTranslation(we),Te,Ae),n=Se),n.transformPoint(this.localPosition,we),this.worldTransform.setTRS(we,Ce,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled)return;if(this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const t=this._children;for(let e=0,s=t.length;e<s;e++)t[e].syncHierarchy()}lookAt(t,e,s,i=0,n=1,a=0){if(t instanceof Vec3)Fe.copy(t),e instanceof Vec3?Oe.copy(e):Oe.copy(Vec3.UP);else{if(void 0===s)return;Fe.set(t,e,s),Oe.set(i,n,a)}ke.setLookAt(this.getPosition(),Fe,Oe),Ie.setFromMat4(ke),this.setRotation(Ie)}translate(t,e,s){t instanceof Vec3?Le.copy(t):Le.set(t,e,s),Le.add(this.getPosition()),this.setPosition(Le)}translateLocal(t,e,s){t instanceof Vec3?Le.copy(t):Le.set(t,e,s),this.localRotation.transformVector(Le,Le),this.localPosition.add(Le),this._dirtyLocal||this._dirtifyLocal()}rotate(t,e,s){if(t instanceof Vec3?Ie.setFromEulerAngles(t.x,t.y,t.z):Ie.setFromEulerAngles(t,e,s),null===this._parent)this.localRotation.mul2(Ie,this.localRotation);else{const t=this.getRotation(),e=this._parent.getRotation();De.copy(e).invert(),Ie.mul2(De,Ie),this.localRotation.mul2(Ie,t)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(t,e,s){t instanceof Vec3?Ie.setFromEulerAngles(t.x,t.y,t.z):Ie.setFromEulerAngles(t,e,s),this.localRotation.mul(Ie),this._dirtyLocal||this._dirtifyLocal()}}const Ve=new Mat4,Be=new Mat4,ze=new Mat4;class LightCamera{static create(t,e,s){const i=new Camera;switch(i.node=new GraphNode(t),i.aspectRatio=1,i.aspectRatioMode=1,i._scissorRectClear=!0,e){case 1:i.node.setRotation(LightCamera.pointLightRotations[s]),i.fov=90,i.projection=0;break;case 2:i.projection=0;break;case 0:i.projection=1}return i}static evalSpotCookieMatrix(t){let e=LightCamera._spotCookieCamera;e||(e=LightCamera.create("SpotCookieCamera",2),LightCamera._spotCookieCamera=e),e.fov=2*t._outerConeAngle;const s=e._node;s.setPosition(t._node.getPosition()),s.setRotation(t._node.getRotation()),s.rotateLocal(-90,0,0),Ve.setTRS(s.getPosition(),s.getRotation(),Vec3.ONE).invert(),Be.mul2(e.projectionMatrix,Ve);const i=t.cookieMatrix,n=t.atlasViewport;return ze.setViewport(n.x,n.y,n.z,n.w),i.mul2(ze,Be),i}}LightCamera.pointLightRotations=[(new Quat).setFromEulerAngles(0,90,180),(new Quat).setFromEulerAngles(0,-90,180),(new Quat).setFromEulerAngles(90,0,0),(new Quat).setFromEulerAngles(-90,0,0),(new Quat).setFromEulerAngles(0,180,180),(new Quat).setFromEulerAngles(0,0,180)],LightCamera._spotCookieCamera=null;const Ue=new Vec3,Ne=new Float32Array(6),He=new Vec3(-.5,0,0),We=new Vec3(0,0,.5),Ge={FLAGS:0,COLOR_A:1,COLOR_B:2,SPOT_ANGLES:3,SHADOW_BIAS:4,COOKIE_A:5,COOKIE_B:6,COUNT_ALWAYS:7,POSITION_X:7,POSITION_Y:8,POSITION_Z:9,RANGE:10,SPOT_DIRECTION_X:11,SPOT_DIRECTION_Y:12,SPOT_DIRECTION_Z:13,PROJ_MAT_00:14,ATLAS_VIEWPORT_A:14,PROJ_MAT_01:15,ATLAS_VIEWPORT_B:15,PROJ_MAT_02:16,PROJ_MAT_03:17,PROJ_MAT_10:18,PROJ_MAT_11:19,PROJ_MAT_12:20,PROJ_MAT_13:21,PROJ_MAT_20:22,PROJ_MAT_21:23,PROJ_MAT_22:24,PROJ_MAT_23:25,PROJ_MAT_30:26,PROJ_MAT_31:27,PROJ_MAT_32:28,PROJ_MAT_33:29,AREA_DATA_WIDTH_X:30,AREA_DATA_WIDTH_Y:31,AREA_DATA_WIDTH_Z:32,AREA_DATA_HEIGHT_X:33,AREA_DATA_HEIGHT_Y:34,AREA_DATA_HEIGHT_Z:35,COUNT:36},je={POSITION_RANGE:0,SPOT_DIRECTION:1,PROJ_MAT_0:2,ATLAS_VIEWPORT:2,PROJ_MAT_1:3,PROJ_MAT_2:4,PROJ_MAT_3:5,AREA_DATA_WIDTH:6,AREA_DATA_HEIGHT:7,COUNT:8};class LightsBuffer{static initShaderDefines(){const t=LightsBuffer.lightTextureFormat===LightsBuffer.FORMAT_FLOAT?"FLOAT":"8BIT";LightsBuffer.shaderDefines=`\n\t\t\t\t\t\t\n#define CLUSTER_TEXTURE_${t}\n\t\t\t\t\t\t${LightsBuffer.buildShaderDefines(Ge,"CLUSTER_TEXTURE_8_")}\n\t\t\t\t\t\t${LightsBuffer.buildShaderDefines(je,"CLUSTER_TEXTURE_F_")}\n\t\t\t\t`}static buildShaderDefines(t,e){let s="";return Object.keys(t).forEach((i=>{s+=`\n#define ${e}${i} ${t[i]}.5`})),s}static init(t){LightsBuffer.lightTextureFormat=t.extTextureFloat&&t.maxTextures>8?LightsBuffer.FORMAT_FLOAT:LightsBuffer.FORMAT_8BIT,LightsBuffer.initShaderDefines()}static createTexture(t,e,s,i,n){return new Texture(t,{name:n,width:e,height:s,mipmaps:!1,format:i,addressU:1,addressV:1,type:Ft,magFilter:0,minFilter:0,anisotropy:1})}constructor(t){this.device=t,this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;let e=Ge.COUNT_ALWAYS,s=0;LightsBuffer.lightTextureFormat===LightsBuffer.FORMAT_FLOAT?s=je.COUNT:e=Ge.COUNT,this.lights8=new Uint8ClampedArray(4*e*this.maxLights),this.lightsTexture8=LightsBuffer.createTexture(this.device,e,this.maxLights,7,"LightsTexture8"),this._lightsTexture8Id=this.device.scope.resolve("lightsTexture8"),s?(this.lightsFloat=new Float32Array(4*s*this.maxLights),this.lightsTextureFloat=LightsBuffer.createTexture(this.device,s,this.maxLights,rt,"LightsTextureFloat"),this._lightsTextureFloatId=this.device.scope.resolve("lightsTextureFloat")):(this.lightsFloat=null,this.lightsTextureFloat=null,this._lightsTextureFloatId=void 0),this._lightsTextureInvSizeId=this.device.scope.resolve("lightsTextureInvSize"),this._lightsTextureInvSizeData=new Float32Array(4),this._lightsTextureInvSizeData[0]=s?1/this.lightsTextureFloat.width:0,this._lightsTextureInvSizeData[1]=s?1/this.lightsTextureFloat.height:0,this._lightsTextureInvSizeData[2]=1/this.lightsTexture8.width,this._lightsTextureInvSizeData[3]=1/this.lightsTexture8.height,this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new Vec3,this.boundsDelta=new Vec3}destroy(){this.lightsTexture8&&(this.lightsTexture8.destroy(),this.lightsTexture8=null),this.lightsTextureFloat&&(this.lightsTextureFloat.destroy(),this.lightsTextureFloat=null)}setCompressionRanges(t,e){this.invMaxColorValue=1/e,this.invMaxAttenuation=1/t}setBounds(t,e){this.boundsMin.copy(t),this.boundsDelta.copy(e)}uploadTextures(){this.lightsTextureFloat&&(this.lightsTextureFloat.lock().set(this.lightsFloat),this.lightsTextureFloat.unlock()),this.lightsTexture8.lock().set(this.lights8),this.lightsTexture8.unlock()}updateUniforms(){this._lightsTexture8Id.setValue(this.lightsTexture8),LightsBuffer.lightTextureFormat===LightsBuffer.FORMAT_FLOAT&&this._lightsTextureFloatId.setValue(this.lightsTextureFloat),this._lightsTextureInvSizeId.setValue(this._lightsTextureInvSizeData)}getSpotDirection(t,e){e._node.getWorldTransform().getY(t).mulScalar(-1),t.normalize()}getLightAreaSizes(t){const e=t._node.getWorldTransform();return e.transformVector(He,Ue),Ne[0]=Ue.x,Ne[1]=Ue.y,Ne[2]=Ue.z,e.transformVector(We,Ue),Ne[3]=Ue.x,Ne[4]=Ue.y,Ne[5]=Ue.z,Ne}addLightDataFlags(t,e,s,i,n){t[e+0]=i?255:0,t[e+1]=64*s._shape,t[e+2]=255*s._falloffMode,t[e+3]=n?255:0}addLightDataColor(t,e,s,i,n){const a=this.invMaxColorValue,r=i?s._linearFinalColor:s._finalColor;FloatPacking.float2Bytes(r[0]*a,t,e+0,2),FloatPacking.float2Bytes(r[1]*a,t,e+2,2),FloatPacking.float2Bytes(r[2]*a,t,e+4,2),t[e+6]=n?255:0;const o=!!(1&s.mask),l=!!(2&s.mask);t[e+7]=o&&l?127:l?255:0}addLightDataSpotAngles(t,e,s){FloatPacking.float2Bytes(.499999*s._innerConeAngleCos+.5,t,e+0,2),FloatPacking.float2Bytes(.499999*s._outerConeAngleCos+.5,t,e+2,2)}addLightDataShadowBias(t,e,s){const i=s.getRenderData(null,0),n=s._getUniformBiasValues(i);FloatPacking.float2BytesRange(n.bias,t,e,-1,20,2),FloatPacking.float2Bytes(n.normalBias,t,e+2,2)}addLightDataPositionRange(t,e,s,i){const n=Ue.sub2(i,this.boundsMin).div(this.boundsDelta);FloatPacking.float2Bytes(n.x,t,e+0,4),FloatPacking.float2Bytes(n.y,t,e+4,4),FloatPacking.float2Bytes(n.z,t,e+8,4),FloatPacking.float2Bytes(s.attenuationEnd*this.invMaxAttenuation,t,e+12,4)}addLightDataSpotDirection(t,e,s){this.getSpotDirection(Ue,s),FloatPacking.float2Bytes(.499999*Ue.x+.5,t,e+0,4),FloatPacking.float2Bytes(.499999*Ue.y+.5,t,e+4,4),FloatPacking.float2Bytes(.499999*Ue.z+.5,t,e+8,4)}addLightDataLightProjMatrix(t,e,s){const i=s.data;for(let n=0;n<12;n++)FloatPacking.float2BytesRange(i[n],t,e+4*n,-2,2,4);for(let n=12;n<16;n++)FloatPacking.float2MantissaExponent(i[n],t,e+4*n,4)}addLightDataCookies(t,e,s){const i="rgb"===s._cookieChannel;if(t[e+0]=Math.floor(255*s.cookieIntensity),t[e+1]=i?255:0,!i){const i=s._cookieChannel;t[e+4]="rrr"===i?255:0,t[e+5]="ggg"===i?255:0,t[e+6]="bbb"===i?255:0,t[e+7]="aaa"===i?255:0}}addLightAtlasViewport(t,e,s){FloatPacking.float2Bytes(s.x,t,e+0,2),FloatPacking.float2Bytes(s.y,t,e+2,2),FloatPacking.float2Bytes(s.z/3,t,e+4,2)}addLightAreaSizes(t,e,s){const i=this.getLightAreaSizes(s);for(let n=0;n<6;n++)FloatPacking.float2MantissaExponent(i[n],t,e+4*n,4)}addLightData(t,e,s){const i=2===t._type,n=t.atlasViewportAllocated,a=this.cookiesEnabled&&!!t._cookie&&n,r=this.areaLightsEnabled&&0!==t.shape,o=this.shadowsEnabled&&t.castShadows&&n,l=t._node.getPosition();let h=null,c=null;if(i)if(o){h=t.getRenderData(null,0).shadowMatrix}else a&&(h=LightCamera.evalSpotCookieMatrix(t));else(o||a)&&(c=t.atlasViewport);const d=this.lights8,u=e*this.lightsTexture8.width*4;if(this.addLightDataFlags(d,u+4*Ge.FLAGS,t,i,o),this.addLightDataColor(d,u+4*Ge.COLOR_A,t,s,a),i&&this.addLightDataSpotAngles(d,u+4*Ge.SPOT_ANGLES,t),t.castShadows&&this.addLightDataShadowBias(d,u+4*Ge.SHADOW_BIAS,t),a&&this.addLightDataCookies(d,u+4*Ge.COOKIE_A,t),LightsBuffer.lightTextureFormat===LightsBuffer.FORMAT_FLOAT){const s=this.lightsFloat,n=e*this.lightsTextureFloat.width*4;if(s[n+4*je.POSITION_RANGE+0]=l.x,s[n+4*je.POSITION_RANGE+1]=l.y,s[n+4*je.POSITION_RANGE+2]=l.z,s[n+4*je.POSITION_RANGE+3]=t.attenuationEnd,i&&(this.getSpotDirection(Ue,t),s[n+4*je.SPOT_DIRECTION+0]=Ue.x,s[n+4*je.SPOT_DIRECTION+1]=Ue.y,s[n+4*je.SPOT_DIRECTION+2]=Ue.z),h){const t=h.data;for(let e=0;e<16;e++)s[n+4*je.PROJ_MAT_0+e]=t[e]}if(c&&(s[n+4*je.ATLAS_VIEWPORT+0]=c.x,s[n+4*je.ATLAS_VIEWPORT+1]=c.y,s[n+4*je.ATLAS_VIEWPORT+2]=c.z/3),r){const e=this.getLightAreaSizes(t);s[n+4*je.AREA_DATA_WIDTH+0]=e[0],s[n+4*je.AREA_DATA_WIDTH+1]=e[1],s[n+4*je.AREA_DATA_WIDTH+2]=e[2],s[n+4*je.AREA_DATA_HEIGHT+0]=e[3],s[n+4*je.AREA_DATA_HEIGHT+1]=e[4],s[n+4*je.AREA_DATA_HEIGHT+2]=e[5]}}else this.addLightDataPositionRange(d,u+4*Ge.POSITION_X,t,l),i&&this.addLightDataSpotDirection(d,u+4*Ge.SPOT_DIRECTION_X,t),h&&this.addLightDataLightProjMatrix(d,u+4*Ge.PROJ_MAT_00,h),c&&this.addLightAtlasViewport(d,u+4*Ge.ATLAS_VIEWPORT_A,c),r&&this.addLightAreaSizes(d,u+4*Ge.AREA_DATA_WIDTH_X,t)}}LightsBuffer.FORMAT_FLOAT=0,LightsBuffer.FORMAT_8BIT=1,LightsBuffer.lightTextureFormat=LightsBuffer.FORMAT_8BIT,LightsBuffer.shaderDefines="";const Xe=[],qe={rgbm:"decodeRGBM",rgbe:"decodeRGBE",linear:"decodeLinear"},$e={optionsContext:{},optionsContextMin:{},generateKey:function(t){const e=function(t){const e=[];for(const s in t)t.hasOwnProperty(s)&&"chunks"!==s&&"lights"!==s&&e.push(s);return e.sort()};let s;t===this.optionsContextMin?(this.propsMin||(this.propsMin=e(t)),s=this.propsMin):t===this.optionsContext?(this.props||(this.props=e(t)),s=this.props):s=e(t);let i="standard";for(let n=0;n<s.length;n++)t[s[n]]&&(i+=s[n]+t[s[n]]);if(t.chunks){const e=[];for(const s in t.chunks)t.chunks.hasOwnProperty(s)&&e.push(s+t.chunks[s]);e.sort(),i+=e}if(t.lights){const e=t.clusteredLightingEnabled;for(let s=0;s<t.lights.length;s++){const n=t.lights[s];e&&0!==n._type||(i+=n.key)}}return qt(i)},_correctChannel:function(t,e){if(Xe[t]>0){if(Xe[t]<e.length)return e.substring(0,Xe[t]);if(Xe[t]>e.length){let s=e;const i=s.charAt(s.length-1),n=Xe[t]-s.length;for(let t=0;t<n;t++)s+=i;return s}return e}},_setMapTransform:function(t,e,s,i){const n=`texture_${e}MapTransform`,a=s+100*i;return t[0]+=`uniform vec3 ${n}0;\n`,t[0]+=`uniform vec3 ${n}1;\n`,t[3][a]||(t[1]+=`varying vec2 vUV${i}_${s};\n`,t[2]+=`\t vUV${i}_${s} = vec2(dot(vec3(uv${i}, 1), ${n}0), dot(vec3(uv${i}, 1), ${n}1));\n`,t[3][a]=!0),t},_getUvSourceExpression:function(t,e,s){const i=s[t],n=s[e],a=0===s.pass||1===s.pass;let r;return a&&1===s.nineSlicedMode?r="nineSlicedUv":a&&2===s.nineSlicedMode?r="nineSlicedUv, -1000.0":(r=0===i?"vUv"+n:"vUV"+n+"_"+i,s.heightMap&&"heightMapTransform"!==t&&(r+=" + dUvOffset")),r},_addMapDef:function(t,e){let s="\n#undef "+t+"\n";return e&&(s+=" #define "+t+"\n"),s},_addMapDefs:function(t,e,s,i){let n="";return n+=this._addMapDef("MAPFLOAT",t),n+=this._addMapDef("MAPCOLOR",e),n+=this._addMapDef("MAPVERTEX",s),n+=this._addMapDef("MAPTEXTURE",i),n},_addMap:function(t,e,s,i,n){const a=t+"Map",r=a+"Uv",o=a+"Transform",l=a+"Channel",h=t+"VertexColorChannel",c=t+"VertexColor",d=t+"Mode",u=s[t+"Tint"],p=s[c],m=s[a],_=s[d];let f=i[e];if(m){const t=this._getUvSourceExpression(o,r,s);if(f=f.replace(/\$UV/g,t).replace(/\$CH/g,s[l]),void 0!==n){const t=0===n?"texture2DSRGB":1===n?"texture2DRGBM":"texture2D";f=f.replace(/\$texture2DSAMPLE/g,t)}}p&&(f=f.replace(/\$VC/g,s[h])),_&&(f=f.replace(/\$DETAILMODE/g,_));const g=!!(1&u),y=!!(2&u);return f=this._addMapDefs(g,y,p,m)+f,f.replace(/\$/g,"")},_directionalShadowMapProjection:function(t,e,s,i,n){let a="";return t.numCascades>1&&(a+=`getShadowCascadeMatrix(light${i}_shadowMatrixPalette, light${i}_shadowCascadeDistances, light${i}_shadowCascadeCount);\n`,e=`(cascadeShadowMat, ${s});\n`),a+=n+e,a+=`fadeShadow(light${i}_shadowCascadeDistances);\n`,a},_nonPointShadowMapProjection:function(t,e,s,i,n){const a=`(${s}, ${i});\n`;return!e._normalOffsetBias||e._isVsm?2===e._type?e._isPcf&&(t.webgl2||t.extStandardDerivatives)?"\t\t\t getShadowCoordPerspZbuffer"+a:"\t\t\t getShadowCoordPersp"+a:this._directionalShadowMapProjection(e,a,i,n,"getShadowCoordOrtho"):2===e._type?e._isPcf&&(t.webgl2||t.extStandardDerivatives)?"\t\t\t getShadowCoordPerspZbufferNormalOffset"+a:"\t\t\t getShadowCoordPerspNormalOffset"+a:this._directionalShadowMapProjection(e,a,i,n,"getShadowCoordOrthoNormalOffset")},_addVaryingIfNeeded:function(t,e,s){return t.indexOf(s)>=0?"varying "+e+" "+s+";\n":""},_getLightSourceShapeString:function(t){switch(t){case 1:return"Rect";case 2:return"Disk";case 3:return"Sphere";default:return""}},_getPassDefineString:function(t){return 18===t?"#define PICK_PASS\n":2===t?"#define DEPTH_PASS\n":t>=3&&t<=17?"#define SHADOW_PASS\n":""},_vsAddTransformCode:function(t,e,s,i){return t+=s.transformVS},_vsAddBaseCode:function(t,e,s,i){return t+=s.baseVS,1!==i.nineSlicedMode&&2!==i.nineSlicedMode||(t+=s.baseNineSlicedVS),t},_fsAddBaseCode:function(t,e,s,i){return t+=s.basePS,1===i.nineSlicedMode?t+=s.baseNineSlicedPS:2===i.nineSlicedMode&&(t+=s.baseNineSlicedTiledPS),t},_decodeFunc:function(t){return qe[t]||"decodeGamma"},_fsAddStartCode:function(t,e,s,i){return t+=s.startPS,1===i.nineSlicedMode?t+=s.startNineSlicedPS:2===i.nineSlicedMode&&(t+=s.startNineSlicedTiledPS),t},_buildShadowPassFragmentCode:function(t,e,s,i,n){const a=i.pass-3,r=Math.floor(a/6),o=a-6*r;e.extStandardDerivatives&&!e.webgl2&&(t+="uniform vec2 polygonOffset;\n"),3===o?e.textureFloatHighPrecision?t+="#define VSM_EXPONENT 15.0\n\n":t+="#define VSM_EXPONENT 5.54\n\n":2===o&&(t+="#define VSM_EXPONENT 5.54\n\n"),0!==r&&(t+="uniform vec3 view_position;\n",t+="uniform float light_radius;\n"),t+=n,i.alphaTest&&(t+="float dAlpha;\n",t+=this._addMap("opacity","opacityPS",i,s),t+=s.alphaTestPS),0!==o||e.webgl2&&1!==r?1===o&&(t+="vec2 encodeFloatRG( float v ) {\n",t+="\t\tvec2 enc = vec2(1.0, 255.0) * v;\n",t+="\t\tenc = fract(enc);\n",t+="\t\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",t+="\t\treturn enc;\n",t+="}\n\n"):t+=s.packDepthPS,t+="void main(void)\n{\n",i.alphaTest&&(t+="\t getOpacity();\n",t+="\t alphaTest(dAlpha);\n");return t+=1===r||(1===o||2===o||3===o)&&0!==r?"\t float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":"\t float depth = gl_FragCoord.z;\n",0!==o||e.webgl2&&(1!==r||i.clusteredLightingEnabled)?0===o||4===o?(t+="\t gl_FragColor = vec4(1.0);\n",i.clusteredLightingEnabled&&1===r&&e.webgl2&&(t+="\t gl_FragDepth = depth;\n")):t+=1===o?"\t gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":s.storeEVSMPS:e.extStandardDerivatives&&!e.webgl2?(t+="\t float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",t+="\t depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n",t+="\t gl_FragColor = packFloat(depth);\n"):t+="\t gl_FragColor = packFloat(depth);\n",t+="}\n"},createShaderDefinition:function(t,e){let s=e.lights.length>0;e.dirLightMap&&(s=!0),e.clusteredLightingEnabled&&(s=!0),0===e.shadingModel?(e.fresnelModel=0,e.specularAntialias=!1,e.ambientSH=!1):e.fresnelModel=0===e.fresnelModel?2:e.fresnelModel;const i=!!e.reflectionSource;e.useSpecular||(e.specularMap=e.glossMap=null);const n=e.pass>=3&&e.pass<=17,a=s||i||e.ambientSH||e.heightMap||e.enableGGXSpecular||e.clusteredLightingEnabled&&!n||e.clearCoatNormalMap;this.options=e;let r,o,l="",h="",c="",d=Zt;const u={vertex_position:ot};if(e.chunks){const t={};for(const s in d)d.hasOwnProperty(s)&&(e.chunks[s]?(o=e.chunks[s],o.indexOf("vertex_normal")>=0&&(u.vertex_normal=lt),o.indexOf("vertex_tangent")>=0&&(u.vertex_tangent=ht),o.indexOf("vertex_texCoord0")>=0&&(u.vertex_texCoord0=mt),o.indexOf("vertex_texCoord1")>=0&&(u.vertex_texCoord1=_t),o.indexOf("vertex_color")>=0&&(u.vertex_color=ut),o.indexOf("vertex_boneWeights")>=0&&(u.vertex_boneWeights=ct),o.indexOf("vertex_boneIndices")>=0&&(u.vertex_boneIndices=dt),t[s]=o):t[s]=d[s]);d=t}l+=this._getPassDefineString(e.pass),l=this._vsAddBaseCode(l,t,d,e),h+="\t vPositionW\t\t= getWorldPosition();\n",2===e.pass&&(l+="varying float vDepth;\n",l+="#ifndef VIEWMATRIX\n",l+="#define VIEWMATRIX\n",l+="uniform mat4 matrix_view;\n",l+="#endif\n",l+="#ifndef CAMERAPLANES\n",l+="#define CAMERAPLANES\n",l+="uniform vec4 camera_params;\n\n",l+="#endif\n",h+="\t\tvDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n"),e.useInstancing&&(u.instance_line1=Rt,u.instance_line2=It,u.instance_line3=Dt,u.instance_line4=kt,l+=d.instancingVS),a&&(u.vertex_normal=lt,h+="\t vNormalW = getNormal();\n","sphereMap"===e.reflectionSource&&t.fragmentUniformsCount<=16&&(l+=d.viewNormalVS,h+="\t vNormalV\t\t= getViewNormal();\n"),(e.heightMap||e.normalMap||e.enableGGXSpecular)&&e.hasTangents?(u.vertex_tangent=ht,l+=d.tangentBinormalVS,h+="\t vTangentW\t = getTangent();\n",h+="\t vBinormalW\t= getBinormal();\n"):e.enableGGXSpecular&&(l+=d.tangentBinormalVS,h+="\t vObjectSpaceUpW\t= getObjectSpaceUp();\n"));const p=[],m=[];for(const U in Xe){const t=U+"Map";if(e[U+"VertexColor"]){const t=U+"VertexColorChannel";e[t]=this._correctChannel(U,e[t])}if(e[t]){const s=t+"Channel",i=t+"Transform",n=t+"Uv";e[n]=Math.min(e[n],1),e[s]=this._correctChannel(U,e[s]);const a=e[n];p[a]=!0,m[a]=m[a]||e[t]&&!e[i]}}e.forceUv1&&(p[1]=!0,m[1]=void 0===m[1]||m[1]);for(let U=0;U<2;U++)p[U]&&(u["vertex_texCoord"+U]="TEXCOORD"+U,l+=d["uv"+U+"VS"],h+="\t vec2 uv"+U+" = getUv"+U+"();\n"),m[U]&&(h+="\t vUv"+U+" = uv"+U+";\n");const _=[l,c,h,[]];for(const U in Xe){const t=U+"Map";if(e[t]){const s=t+"Transform";if(e[s]){const i=t+"Uv";this._setMapTransform(_,U,e[s],e[i])}}}l=_[0],c=_[1],h=_[2],e.vertexColors&&(u.vertex_color=ut,h+="\t vVertexColor = vertex_color;\n"),(e.useMorphPosition||e.useMorphNormal)&&(e.useMorphTextureBased?(l+="#define MORPHING_TEXTURE_BASED\n",e.useMorphPosition&&(l+="#define MORPHING_TEXTURE_BASED_POSITION\n"),e.useMorphNormal&&(l+="#define MORPHING_TEXTURE_BASED_NORMAL\n"),u.morph_vertex_id=kt,l+="attribute float morph_vertex_id;\n"):(l+="#define MORPHING\n",e.useMorphPosition?(u.morph_pos0=At,u.morph_pos1=Pt,u.morph_pos2=Et,u.morph_pos3=Lt,l+="#define MORPHING_POS03\n",l+="attribute vec3 morph_pos0;\n",l+="attribute vec3 morph_pos1;\n",l+="attribute vec3 morph_pos2;\n",l+="attribute vec3 morph_pos3;\n"):e.useMorphNormal&&(u.morph_nrm0=At,u.morph_nrm1=Pt,u.morph_nrm2=Et,u.morph_nrm3=Lt,l+="#define MORPHING_NRM03\n",l+="attribute vec3 morph_nrm0;\n",l+="attribute vec3 morph_nrm1;\n",l+="attribute vec3 morph_nrm2;\n",l+="attribute vec3 morph_nrm3;\n"),e.useMorphNormal?(u.morph_nrm4=Rt,u.morph_nrm5=It,u.morph_nrm6=Dt,u.morph_nrm7=kt,l+="#define MORPHING_NRM47\n",l+="attribute vec3 morph_nrm4;\n",l+="attribute vec3 morph_nrm5;\n",l+="attribute vec3 morph_nrm6;\n",l+="attribute vec3 morph_nrm7;\n"):(u.morph_pos4=Rt,u.morph_pos5=It,u.morph_pos6=Dt,u.morph_pos7=kt,l+="#define MORPHING_POS47\n",l+="attribute vec3 morph_pos4;\n",l+="attribute vec3 morph_pos5;\n",l+="attribute vec3 morph_pos6;\n",l+="attribute vec3 morph_pos7;\n"))),e.skin?(u.vertex_boneWeights=ct,u.vertex_boneIndices=dt,l+=ee(t,d),l+="#define SKIN\n"):e.useInstancing&&(l+="#define INSTANCING\n"),e.screenSpace&&(l+="#define SCREENSPACE\n"),e.pixelSnap&&(l+="#define PIXELSNAP\n"),l=this._vsAddTransformCode(l,t,d,e),a&&(l+=d.normalVS),l+="\n",l+=d.startVS,l+=h,l+=d.endVS,l+="}";let f=l;const g=c;c="",c+=this._addVaryingIfNeeded(l,"vec4","vVertexColor"),c+=this._addVaryingIfNeeded(l,"vec3","vPositionW"),c+=this._addVaryingIfNeeded(l,"vec3","vNormalV"),c+=this._addVaryingIfNeeded(l,"vec3","vNormalW"),c+=this._addVaryingIfNeeded(l,"vec3","vTangentW"),c+=this._addVaryingIfNeeded(l,"vec3","vBinormalW"),c+=this._addVaryingIfNeeded(l,"vec3","vObjectSpaceUpW"),c+=this._addVaryingIfNeeded(l,"vec2","vUv0"),c+=this._addVaryingIfNeeded(l,"vec2","vUv1"),c+=g,f=c+f;let y,v="";if(t.webgl2?(v=ie(t),d.extensionVS&&(v+=d.extensionVS+"\n"),f=v+d.gles3VS+f):(d.extensionVS&&(v=d.extensionVS+"\n"),f=v+f),e.forceFragmentPrecision&&"highp"!==e.forceFragmentPrecision&&"mediump"!==e.forceFragmentPrecision&&"lowp"!==e.forceFragmentPrecision&&(e.forceFragmentPrecision=null),e.forceFragmentPrecision&&("highp"===e.forceFragmentPrecision&&"highp"!==t.maxPrecision&&(e.forceFragmentPrecision="mediump"),"mediump"===e.forceFragmentPrecision&&"lowp"===t.maxPrecision&&(e.forceFragmentPrecision="lowp")),l="",t.webgl2&&(l+=ie(t)),t.webgl2||(t.extStandardDerivatives&&(l+="#extension GL_OES_standard_derivatives : enable\n"),t.extTextureLod&&(l+="#extension GL_EXT_shader_texture_lod : enable\n",l+="#define SUPPORTS_TEXLOD\n")),d.extensionPS&&(l+=d.extensionPS+"\n"),t.webgl2&&(l+=d.gles3PS),l+=e.forceFragmentPrecision?"precision "+e.forceFragmentPrecision+" float;\n\n":se(t),l+=this._getPassDefineString(e.pass),18===e.pass)return l+="uniform vec4 uColor;\n",l+=c,e.alphaTest&&(l+="float dAlpha;\n",l+=this._addMap("opacity","opacityPS",e,d),l+=d.alphaTestPS),l+="void main(void)\n{\n",e.alphaTest&&(l+="\t getOpacity();\n",l+="\t alphaTest(dAlpha);\n"),l+="\t\tgl_FragColor = uColor;\n",l+="}\n",{attributes:u,vshader:f,fshader:l};if(2===e.pass)return l+="varying float vDepth;\n",l+=c,l+=d.packDepthPS,e.alphaTest&&(l+="float dAlpha;\n",l+=this._addMap("opacity","opacityPS",e,d),l+=d.alphaTestPS),l+="void main(void)\n{\n",e.alphaTest&&(l+="\t getOpacity();\n",l+="\t alphaTest(dAlpha);\n"),l+="\t\tgl_FragColor = packFloat(vDepth);\n",l+="}\n",{attributes:u,vshader:f,fshader:l};if(n)return{attributes:u,vshader:f,fshader:this._buildShadowPassFragmentCode(l,t,d,e,c)};if(e.customFragmentShader)return y=l+e.customFragmentShader,{attributes:u,vshader:f,fshader:y,tag:1};l+=c,l=this._fsAddBaseCode(l,t,d,e),e.detailModes&&(l+=d.detailModesPS);const b=l;l="",e.clearCoat>0&&(l+="#define CLEARCOAT\n",l+="#define CLUSTER_CLEAR_COAT\n"),!1===e.opacityFadesSpecular&&(l+="uniform float material_alphaFade;\n");let x=0;const S=[];let w,C=!1,T=!1,M=!1,A=e.lights.some((function(t){return t._shape&&0!==t._shape}));e.clusteredLightingEnabled&&e.clusteredLightingAreaLightsEnabled&&(A=!0),7===t.areaLightLutFormat?(l+="#define AREA_R8_G8_B8_A8_LUTS\n",l+="#define AREA_LUTS_PRECISION lowp\n"):l+="#define AREA_LUTS_PRECISION highp\n",(A||e.clusteredLightingEnabled)&&(l+="#define AREA_LIGHTS\n",l+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex1;\n",l+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex2;\n");for(let U=0;U<e.lights.length;U++){const s=e.lights[U],i=s._type;if(e.clusteredLightingEnabled&&0!==i)continue;l+="uniform vec3 light"+U+"_color;\n",0===i?l+="uniform vec3 light"+U+"_direction;\n":(l+="uniform vec3 light"+U+"_position;\n",l+="uniform float light"+U+"_radius;\n",2===i&&(l+="uniform vec3 light"+U+"_direction;\n",l+="uniform float light"+U+"_innerConeAngle;\n",l+="uniform float light"+U+"_outerConeAngle;\n")),0!==(A&&s._shape?s._shape:0)&&(0===i&&(l+="uniform vec3 light"+U+"_position;\n"),l+="uniform vec3 light"+U+"_halfWidth;\n",l+="uniform vec3 light"+U+"_halfHeight;\n"),s.castShadows&&!e.noShadow&&(l+="uniform mat4 light"+U+"_shadowMatrix;\n",0===i&&(l+="uniform mat4 light"+U+"_shadowMatrixPalette[4];\n",l+="uniform float light"+U+"_shadowCascadeDistances[4];\n",l+="uniform float light"+U+"_shadowCascadeCount;\n"),0!==i?l+="uniform vec4 light"+U+"_shadowParams;\n":(C=!0,l+="uniform vec3 light"+U+"_shadowParams;\n"),1===i?l+="uniform samplerCube light"+U+"_shadowMap;\n":s._isPcf&&t.webgl2?l+="uniform sampler2DShadow light"+U+"_shadowMap;\n":l+="uniform sampler2D light"+U+"_shadowMap;\n",x++,S[s._shadowType]=!0,s._isVsm&&(T=!0),s._isPcf&&(t.webgl2||t.extStandardDerivatives)&&2===i&&(M=!0)),s._cookie&&(s._cookie._cubemap?1===i&&(l+="uniform samplerCube light"+U+"_cookie;\n",l+="uniform float light"+U+"_cookieIntensity;\n",s.castShadows&&!e.noShadow||(l+="uniform mat4 light"+U+"_shadowMatrix;\n")):2===i&&(l+="uniform sampler2D light"+U+"_cookie;\n",l+="uniform float light"+U+"_cookieIntensity;\n",s.castShadows&&!e.noShadow||(l+="uniform mat4 light"+U+"_shadowMatrix;\n"),s._cookieTransform&&(l+="uniform vec4 light"+U+"_cookieMatrix;\n",l+="uniform vec2 light"+U+"_cookieOffset;\n")))}if(l+="\n",w=!e.hasTangents&&t.extStandardDerivatives?d.TBNderivativePS:e.fastTbn?d.TBNfastPS:d.TBNPS,a)if(e.normalMap||e.clearCoatNormalMap){if(l+=e.packedNormal?d.normalXYPS:d.normalXYZPS,!e.hasTangents){const t=e.normalMap?"normalMap":"clearCoatNormalMap",s=this._getUvSourceExpression(`${t}Transform`,`${t}Uv`,e);w=w.replace(/\$UV/g,s)}l+=w}else e.enableGGXSpecular&&!e.heightMap&&(l+=d.normalVertexPS,l+=d.TBNObjectSpacePS);if(a)if(e.normalMap){e.normalDetail&&(l+=this._addMap("normalDetail","normalDetailMapPS",e,d));const t=this._getUvSourceExpression("normalMapTransform","normalMapUv",e);e.normalizeNormalMap?l+=d.normalMapPS.replace(/\$UV/g,t):l+=d.normalMapFastPS.replace(/\$UV/g,t)}else e.enableGGXSpecular&&!e.heightMap||(l+=d.normalVertexPS);if(l+=Qt(e.gamma,d),l+=Jt(e.toneMap,d),l+=te(e.fog,d),l+=d.decodePS,e.useRgbm&&(l+=d.rgbmPS),e.useCubeMapRotation&&(l+="#define CUBEMAP_ROTATION\n"),a&&(l+=d.cubeMapRotatePS,l+=e.cubeMapProjection>0?d.cubeMapProjectBoxPS:d.cubeMapProjectNonePS,l+=e.skyboxIntensity?d.envMultiplyPS:d.envConstPS),e.diffuseDetail&&(l+=this._addMap("diffuseDetail","diffuseDetailMapPS",e,d)),l+=this._addMap("diffuse","diffusePS",e,d),(3!==e.blendType||e.alphaTest||e.alphaToCoverage)&&(l+=this._addMap("opacity","opacityPS",e,d)),l+=this._addMap("emissive","emissivePS",e,d,e.emissiveFormat),s&&e.useSpecular||i){e.specularAntialias&&e.normalMap?e.normalizeNormalMap&&a?l+=d.specularAaToksvigPS:l+=d.specularAaToksvigFastPS:l+=d.specularAaNonePS;const t=e.useMetalness?"metalness":"specular";l+=this._addMap(t,t+"PS",e,d),l+=this._addMap("gloss","glossPS",e,d),2===e.fresnelModel&&(l+=d.fresnelSchlickPS)}if(e.clearCoat>0&&(l+=this._addMap("clearCoat","clearCoatPS",e,d),l+=this._addMap("clearCoatGloss","clearCoatGlossPS",e,d),l+=this._addMap("clearCoatNormal","clearCoatNormalPS",e,d)),e.heightMap){if(!e.normalMap){const t=this._getUvSourceExpression("heightMapTransform","heightMapUv",e);e.hasTangents||(w=w.replace(/\$UV/g,t)),l+=w}l+=this._addMap("height","parallaxPS",e,d)}const P=e.aoMap||e.aoVertexColor;if(P&&(l+=this._addMap("ao","aoPS",e,d),e.occludeSpecular&&(1===e.occludeSpecular?l+=e.occludeSpecularFloat?d.aoSpecOccSimplePS:d.aoSpecOccConstSimplePS:l+=e.occludeSpecularFloat?d.aoSpecOccPS:d.aoSpecOccConstPS)),"envAtlas"===e.reflectionSource)l+=d.reflectionEnvPS.replace(/\$DECODE/g,this._decodeFunc(e.reflectionEncoding));else if("cubeMap"===e.reflectionSource)l+=e.fixSeams?d.fixCubemapSeamsStretchPS:d.fixCubemapSeamsNonePS,l+=d.reflectionCubePS.replace(/\$DECODE/g,this._decodeFunc(e.reflectionEncoding));else if("sphereMap"===e.reflectionSource){l+=(t.fragmentUniformsCount>16?d.reflectionSpherePS:d.reflectionSphereLowPS).replace(/\$DECODE/g,this._decodeFunc(e.reflectionEncoding))}i&&(e.clearCoat>0&&(l+=d.reflectionCCPS),e.refraction&&(l+=d.refractionPS)),e.clusteredLightingEnabled&&(l+=d.clusteredLightUtilsPS,l+=d.clusteredLightCookiesPS,S[0]=!0,S[4]=!0,M=!0),(x>0||e.clusteredLightingEnabled)&&(C&&(l+=d.shadowCascadesPS),S[0]&&(l+=d.shadowStandardPS),S[4]&&t.webgl2&&(l+=d.shadowStandardGL2PS),T&&(l+=d.shadowVSM_commonPS,S[1]&&(l+=d.shadowVSM8PS),S[2]&&(l+=t.extTextureHalfFloatLinear?d.shadowEVSMPS.replace(/\$/g,"16"):d.shadowEVSMnPS.replace(/\$/g,"16")),S[3]&&(l+=t.extTextureFloatLinear?d.shadowEVSMPS.replace(/\$/g,"32"):d.shadowEVSMnPS.replace(/\$/g,"32"))),t.webgl2||t.extStandardDerivatives||(l+=d.biasConstPS),l+=d.shadowCoordPS+d.shadowCommonPS,M&&(l+=d.shadowCoordPerspZbufferPS)),e.enableGGXSpecular&&(l+="uniform float material_anisotropy;\n"),s&&(l+=d.lightDiffuseLambertPS,(A||e.clusteredLightingEnabled)&&(l+=d.ltc)),l+="\n";let E=!1;e.useSpecular?(l+="#define CLUSTER_SPECULAR\n",e.conserveEnergy&&(l+="#define CLUSTER_CONSERVE_ENERGY\n"),s&&(l+=0===e.shadingModel?d.lightSpecularPhongPS:e.enableGGXSpecular?d.lightSpecularAnisoGGXPS:d.lightSpecularBlinnPS),e.fresnelModel>0?e.conserveEnergy&&!A?l+=d.combineDiffuseSpecularPS:l+=d.combineDiffuseSpecularNoConservePS:i?l+=d.combineDiffuseSpecularOldPS:e.diffuseMap?l+=d.combineDiffuseSpecularNoReflPS:(l+=d.combineDiffuseSpecularNoReflSeparateAmbientPS,E=!0)):l+=d.combineDiffusePS,e.clearCoat>0&&(l+=d.combineClearCoatPS);let L=!0;if(e.lightMap||e.lightVertexColor){const t=e.dirLightMap&&e.useSpecular?"lightmapDirPS":"lightmapSinglePS";l+=this._addMap("light",t,e,d,e.lightMapFormat),L=e.lightMapWithoutAmbient}L&&("ambientSH"===e.ambientSource?l+=d.ambientSHPS:"envAtlas"===e.ambientSource?l+=d.ambientEnvPS.replace(/\$DECODE/g,this._decodeFunc(e.ambientEncoding)):l+=d.ambientConstantPS),e.ambientTint&&!E&&(l+="uniform vec3 material_ambient;\n"),e.alphaTest&&(l+=d.alphaTestPS),e.msdf&&(l+=d.msdfPS),a&&(l+=d.viewDirPS,e.useSpecular&&(l+=e.enableGGXSpecular?d.reflDirAnisoPS:d.reflDirPS));let R,I=!1,D=!1,k=!1,F=!1,O=!1;e.clusteredLightingEnabled&&s&&(F=!0,I=!0,D=!0,O=!0,l+=d.floatUnpackingPS,e.lightMaskDynamic&&(l+="\n#define CLUSTER_MESH_DYNAMIC_LIGHTS"),e.clusteredLightingCookiesEnabled&&(l+="\n#define CLUSTER_COOKIES"),e.clusteredLightingShadowsEnabled&&!e.noShadow&&(l+="\n#define CLUSTER_SHADOWS",l+="\n#define CLUSTER_SHADOW_TYPE_"+Z[e.clusteredLightingShadowType]),e.clusteredLightingAreaLightsEnabled&&(l+="\n#define CLUSTER_AREALIGHTS"),l+=LightsBuffer.shaderDefines,l+=d.clusteredLightShadowsPS,l+=d.clusteredLightPS),e.twoSidedLighting&&(l+="uniform float twoSidedLightingNegScaleFactor;\n"),l=this._fsAddStartCode(l,t,d,e),a&&(e.hasTangents||!t.extStandardDerivatives||e.fastTbn?e.twoSidedLighting?l+="\t dVertexNormalW = gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor;\n":l+="\t dVertexNormalW = vNormalW;\n":e.twoSidedLighting?l+="\t dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);\n":l+="\t dVertexNormalW = normalize(vNormalW);\n",(e.heightMap||e.normalMap)&&e.hasTangents&&(e.twoSidedLighting?(l+="\t dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;\n",l+="\t dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;\n"):(l+="\t dTangentW = vTangentW;\n",l+="\t dBinormalW = vBinormalW;\n")));let V=!1;3!==e.blendType||e.alphaTest||e.alphaToCoverage?e.heightMap&&e.opacityMap?V=!0:(l+="\t getOpacity();\n",e.alphaTest&&(l+="\t alphaTest(dAlpha);\n")):l+="\t dAlpha = 1.0;\n";let B=!1;if(a&&(l+="\t getViewDir();\n",(e.heightMap||e.normalMap||e.clearCoatNormalMap||e.enableGGXSpecular)&&(l+="\t getTBN();\n"),e.heightMap&&(l+="\t getParallax();\n"),V&&(l+="\t getOpacity();\n",e.alphaTest&&(l+="\t alphaTest(dAlpha);\n")),l+="\t getNormal();\n",e.useSpecular&&(s&&e.enableGGXSpecular&&(l+="\t getGlossiness();\n",B=!0),l+="\t getReflDir();\n")),l+="\t getAlbedo();\n",e.clearCoat>0&&(l+="\t getClearCoat();\n",l+="\t getClearCoatGlossiness();\n",l+="\t getClearCoatNormal();\n"),(s&&e.useSpecular||i)&&(l+="\t getSpecularity();\n",B||(l+="\t getGlossiness();\n"),A&&(l+="\t #ifdef AREA_LIGHTS\n",l+="\t dSpecularityNoFres = dSpecularity;\n",l+="\t #ifdef CLEARCOAT\n",l+="\t ccSpecularityNoFres = ccSpecularity;\n",l+="\t #endif\n",l+="\t #endif\n"),e.fresnelModel>0&&(l+="\t getFresnel();\n")),L&&(l+="\t addAmbient();\n",e.separateAmbient&&(l+="\n\t\t\t\t\t\t\t\t\t\tvec3 dAmbientLight = dDiffuseLight;\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = vec3(0);\n\t\t\t\t\t\t\t\t")),e.ambientTint&&!E&&(l+="\t dDiffuseLight *= material_ambient;\n"),P&&!e.occludeDirect&&(l+="\t\tapplyAO();\n"),(e.lightMap||e.lightVertexColor)&&(l+="\t addLightMap();\n"),s||i){i&&(e.clearCoat>0&&(l+="\t addReflectionCC();\n"),l+="\t addReflection();\n"),A&&(l+="\t ccReflection.rgb *= ccSpecularity;\n",l+="\t dReflection.rgb *= dSpecularity;\n",l+="\t dSpecularLight *= dSpecularity;\n",l+="\t float roughness = max((1.0 - dGlossiness) * (1.0 - dGlossiness), 0.001);\n",l+="\t calcLTCLightValues();\n");for(let s=0;s<e.lights.length;s++){const i=e.lights[s],n=i._type;if(e.clusteredLightingEnabled&&0!==n)continue;R=!1;const a=A&&i._shape?i.shape:0,o=A&&i._shape?this._getLightSourceShapeString(a):"";if(0!==a&&(l+="\t calc"+o+"LightValues(light"+s+"_position, light"+s+"_halfWidth, light"+s+"_halfHeight);\n"),0===n?(l+="\t dLightDirNormW = light"+s+"_direction;\n",l+="\t dAtten = 1.0;\n"):(i._cookie&&(2!==n||i._cookie._cubemap?1===n&&i._cookie._cubemap&&(O=!0,R=!0):(O=!0,R=!0)),l+="\t getLightDirPoint(light"+s+"_position);\n",I=!0,R&&(l+=2===n?"\t dAtten3 = getCookie2D"+(i._cookieFalloff?"":"Clip")+(i._cookieTransform?"Xform":"")+"(light"+s+"_cookie, light"+s+"_shadowMatrix, light"+s+"_cookieIntensity"+(i._cookieTransform?", light"+s+"_cookieMatrix, light"+s+"_cookieOffset":"")+")."+i._cookieChannel+";\n":"\t dAtten3 = getCookieCube(light"+s+"_cookie, light"+s+"_shadowMatrix, light"+s+"_cookieIntensity)."+i._cookieChannel+";\n"),0===a?0===i._falloffMode?(l+="\t dAtten = getFalloffLinear(light"+s+"_radius);\n",D=!0):(l+="\t dAtten = getFalloffInvSquared(light"+s+"_radius);\n",k=!0):(l+="\t dAtten = getFalloffWindow(light"+s+"_radius);\n",k=!0),l+="\t if (dAtten > 0.00001) {\n",2===n&&(R&&!i._cookieFalloff||(l+="\t\t\t dAtten *= getSpotEffect(light"+s+"_direction, light"+s+"_innerConeAngle, light"+s+"_outerConeAngle);\n",F=!0))),l+=0!==a?0===n?"\t\t\t dAttenD = getLightDiffuse();\n":"\t\t\t dAttenD = get"+o+"LightDiffuse() * 16.0;\n":"\t\t\t dAtten *= getLightDiffuse();\n",i.castShadows&&!e.noShadow){let a,o=null;if(1===i._shadowType?(o="VSM8",a="0.0"):2===i._shadowType?(o="VSM16",a="5.54"):3===i._shadowType?(o="VSM32",a=t.textureFloatHighPrecision?"15.0":"5.54"):o=4===i._shadowType?"PCF5x5":"PCF3x3",null!==o)if(1===n)r="(light"+s+"_shadowMap, light"+s+"_shadowParams);\n",i._normalOffsetBias&&(l+="\t\t\t normalOffsetPointShadow(light"+s+"_shadowParams);\n"),l+="\t\t\t dAtten *= getShadowPoint"+o+r;else{const r=`light${s}_shadowMatrix`,h=`light${s}_shadowParams`;l+=this._nonPointShadowMapProjection(t,e.lights[s],r,h,s),2===n&&(o="Spot"+o),l+="\t\t\t dAtten *= getShadow"+o+"(light"+s+"_shadowMap, light"+s+"_shadowParams"+(i._isVsm?", "+a:"")+");\n"}}0!==a?e.conserveEnergy&&e.useSpecular?l+="\t\t\t dDiffuseLight += mix((dAttenD * dAtten) * light"+s+"_color"+(R?" * dAtten3":"")+", vec3(0), dLTCSpecFres);\n":l+="\t\t\t dDiffuseLight += (dAttenD * dAtten) * light"+s+"_color"+(R?" * dAtten3":"")+";\n":A&&e.conserveEnergy&&e.useSpecular?l+="\t\t\t dDiffuseLight += mix(dAtten * light"+s+"_color"+(R?" * dAtten3":"")+", vec3(0), dSpecularity);\n":l+="\t\t\t dDiffuseLight += dAtten * light"+s+"_color"+(R?" * dAtten3":"")+";\n",0!==a?(e.clearCoat>0&&(l+="\t\t\t ccSpecularLight += ccLTCSpecFres * get"+o+"LightSpecularCC() * dAtten * light"+s+"_color"+(R?" * dAtten3":"")+";\n"),e.useSpecular&&(l+="\t\t\t dSpecularLight += dLTCSpecFres * get"+o+"LightSpecular() * dAtten * light"+s+"_color"+(R?" * dAtten3":"")+";\n")):A?(e.clearCoat>0&&(l+="\t\t\t ccSpecularLight += ccSpecularity * getLightSpecularCC() * dAtten * light"+s+"_color"+(R?" * dAtten3":"")+";\n"),e.useSpecular&&(l+="\t\t\t dSpecularLight += dSpecularity * getLightSpecular() * dAtten * light"+s+"_color"+(R?" * dAtten3":"")+";\n")):(e.clearCoat>0&&(l+="\t\t\t ccSpecularLight += getLightSpecularCC() * dAtten * light"+s+"_color"+(R?" * dAtten3":"")+";\n"),e.useSpecular&&(l+="\t\t\t dSpecularLight += getLightSpecular() * dAtten * light"+s+"_color"+(R?" * dAtten3":"")+";\n")),0!==n&&(l+="\t }\n"),l+="\n"}e.clusteredLightingEnabled&&s&&(D=!0,k=!0,I=!0,l+="\t addClusteredLights();\n"),A&&(e.clearCoat>0&&(l+="\t ccSpecularity = 1.0;\n"),e.useSpecular&&(l+="\t dSpecularity = vec3(1);\n")),i&&e.refraction&&(l+="\t addRefraction();\n")}l+="\n",P&&(e.occludeDirect&&(l+="\t\tapplyAO();\n"),e.occludeSpecular&&(l+="\t\toccludeSpecular();\n")),!1===e.opacityFadesSpecular&&(2!==e.blendType&&4!==e.blendType||(l+="float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n",l+="#ifdef CLEARCOAT\n specLum += dot(ccSpecularLight * ccSpecularity + ccReflection.rgb * ccReflection.a * ccSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n#endif\n",l+="dAlpha = clamp(dAlpha + gammaCorrectInput(specLum), 0.0, 1.0);\n"),l+="dAlpha *= material_alphaFade;\n"),l+=d.endPS,2===e.blendType||6===e.blendType||e.alphaToCoverage?l+=d.outputAlphaPS:4===e.blendType?l+=d.outputAlphaPremulPS:l+=d.outputAlphaOpaquePS,e.msdf&&(l+="\t gl_FragColor = applyMsdf(gl_FragColor);\n"),l+="\n",l+="}\n",I&&(l=d.lightDirPointPS+l),D&&(l=d.falloffLinearPS+l),k&&(l=d.falloffInvSquaredPS+l),F&&(l=d.spotPS+l),O&&(l=d.cookiePS+l);let z="";return l.includes("dReflection")&&(z+="vec4 dReflection;\n"),l.includes("dTBN")&&(z+="mat3 dTBN;\n"),l.includes("dAlbedo")&&(z+="vec3 dAlbedo;\n"),l.includes("dEmission")&&(z+="vec3 dEmission;\n"),l.includes("dNormalW")&&(z+="vec3 dNormalW;\n"),l.includes("dVertexNormalW")&&(z+="vec3 dVertexNormalW;\n"),l.includes("dTangentW")&&(z+="vec3 dTangentW;\n"),l.includes("dBinormalW")&&(z+="vec3 dBinormalW;\n"),l.includes("dViewDirW")&&(z+="vec3 dViewDirW;\n"),l.includes("dReflDirW")&&(z+="vec3 dReflDirW;\n"),l.includes("dDiffuseLight")&&(z+="vec3 dDiffuseLight;\n"),l.includes("dSpecularLight")&&(z+="vec3 dSpecularLight;\n"),l.includes("dLightDirNormW")&&(z+="vec3 dLightDirNormW;\n"),l.includes("dLightDirW")&&(z+="vec3 dLightDirW;\n"),l.includes("dLightPosW")&&(z+="vec3 dLightPosW;\n"),l.includes("dShadowCoord")&&(z+="vec3 dShadowCoord;\n"),l.includes("dNormalMap")&&(z+="vec3 dNormalMap;\n"),l.includes("dSpecularity")&&(z+="vec3 dSpecularity;\n"),l.includes("dSpecularityNoFres")&&(z+="vec3 dSpecularityNoFres;\n"),l.includes("dUvOffset")&&(z+="vec2 dUvOffset;\n"),l.includes("dGlossiness")&&(z+="float dGlossiness;\n"),l.includes("dAlpha")&&(z+="float dAlpha;\n"),l.includes("dAtten")&&(z+="float dAtten;\n"),l.includes("dAttenD")&&(z+="float dAttenD;\n"),l.includes("dAtten3")&&(z+="vec3 dAtten3;\n"),l.includes("dAo")&&(z+="float dAo;\n"),l.includes("dMsdf")&&(z+="vec4 dMsdf;\n"),l.includes("ccReflection")&&(z+="vec4 ccReflection;\n"),l.includes("ccNormalW")&&(z+="vec3 ccNormalW;\n"),l.includes("ccReflDirW")&&(z+="vec3 ccReflDirW;\n"),l.includes("ccSpecularLight")&&(z+="vec3 ccSpecularLight;\n"),l.includes("ccSpecularity")&&(z+="float ccSpecularity;\n"),l.includes("ccSpecularityNoFres")&&(z+="float ccSpecularityNoFres;\n"),l.includes("ccGlossiness")&&(z+="float ccGlossiness;\n"),l=b+z+l,y=l,{attributes:u,vshader:f,fshader:y,tag:1}}},Ye={begin:ae,dummyFragmentCode:ne,end:re,fogCode:te,gammaCode:Qt,precisionCode:se,skinCode:ee,tonemapCode:Jt,versionCode:ie,basic:ce,particle:de,skybox:ue,standard:$e},Ke=2.399963229728653,Ze=function(t,e,s){const i=e*Ke,n=Math.sqrt(e)/Math.sqrt(s);t.x=n*Math.cos(i),t.y=n*Math.sin(i)},Qe=function(t,e,s,i=0,n=1){i=1-2*i,n=1-2*n;const a=O.lerp(i,n,e/s),r=Math.sqrt(1-a*a),o=Ke*e;t.x=Math.cos(o)*r,t.y=a,t.z=Math.sin(o)*r},Je=function(t){let e=(t<<16|t>>>16)>>>0;return e=((1431655765&e)<<1|(2863311530&e)>>>1)>>>0,e=((858993459&e)<<2|(3435973836&e)>>>2)>>>0,e=((252645135&e)<<4|(4042322160&e)>>>4)>>>0,e=((16711935&e)<<8|(4278255360&e)>>>8)>>>0,2.3283064365386963e-10*e},ts=t=>{switch(t.type){case Ot:return"RGBM";case Vt:return"RGBE";default:switch(t.format){case 11:case 13:case at:case rt:return"Linear";default:return"Gamma"}}},es=t=>{switch(t===zt&&(t=Nt),t){case Ut:return"Cubemap";case Nt:return"Equirect";case"octahedral":return"Octahedral"}},ss=(t,e,s)=>{if(t<=0)e[s+0]=0,e[s+1]=0,e[s+2]=0,e[s+3]=0;else if(t>=1)e[s+0]=255,e[s+1]=0,e[s+2]=0,e[s+3]=0;else{let i=1*t%1,n=255*t%1,a=65025*t%1;const r=16581375*t%1;i-=n/255,n-=a/255,a-=r/255,e[s+0]=Math.min(255,Math.floor(256*i)),e[s+1]=Math.min(255,Math.floor(256*n)),e[s+2]=Math.min(255,Math.floor(256*a)),e[s+3]=Math.min(255,Math.floor(256*r))}},is=(t,e,s,i)=>{const n=2*s*Math.PI,a=Math.pow(1-e,1/(i+1)),r=Math.sqrt(1-a*a);t.set(Math.cos(n)*r,Math.sin(n)*r,a).normalize()},ns=(t,e,s)=>{const i=2*s*Math.PI,n=Math.sqrt(1-e),a=Math.sqrt(e);t.set(Math.cos(i)*a,Math.sin(i)*a,n).normalize()},as=(t,e,s,i)=>{const n=2*s*Math.PI,a=Math.sqrt((1-e)/(1+(i*i-1)*e)),r=Math.sqrt(1-a*a);t.set(Math.cos(n)*r,Math.sin(n)*r,a).normalize()},rs=(t,e)=>{const s=t*e,i=e/(1-t*t+s*s);return i*i*(1/Math.PI)},os={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},ls=(t,e,s)=>{const i=s/t,n=1-Math.log2(e)/11,a=n*n,r=new Vec3,o=new Vec3,l=new Vec3(0,0,1),h=[],c=((t,e)=>{const s=os[t];return s&&s[e]||t})(t,e);for(let d=0;d<c;++d){as(r,d/c,Je(d),a);const t=r.z;if(o.set(r.x,r.y,r.z).mulScalar(2*t).sub(l),o.z>0){const e=rs(Math.min(1,t),a)/4+.001,s=.5*Math.log2(i/e);h.push(o.x,o.y,o.z,s)}}for(;h.length<4*t;)h.push(0,0,0,0);return h},hs=(t,e,s)=>{const i=(t=>{const e=t.length,s=Math.min(e,512),i=Math.ceil(e/s),n=new Uint8Array(s*i*4);let a=0;for(let r=0;r<e;++r)ss(.5*t[4*r+0]+.5,n,a+0),ss(.5*t[4*r+1]+.5,n,a+4),ss(.5*t[4*r+2]+.5,n,a+8),ss(t[4*r+3]/8,n,a+12),a+=16;return{width:s,height:i,data:n}})(s);return new Texture(t,{name:e,width:i.width,height:i.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[i.data]})};class SimpleCache{constructor(){this.map=new Map}get(t,e){if(!this.map.has(t)){const s=e();return this.map.set(t,s),s}return this.map.get(t)}clear(){this.map.clear()}}const cs=new SimpleCache,ds=new class DeviceCache{constructor(){this.cache=new SimpleCache}get(t,e,s){return this.cache.get(t,(()=>{const e=new SimpleCache;return t.on("destroy",(()=>{e.map.forEach(((t,e)=>{t.destroy()})),this.cache.map.delete(t)})),e})).get(e,s)}clear(){this.cache.clear()}},us=(t,e,s)=>{const i=`lambert-samples-${e}-${s}`;return ds.get(t,i,(()=>hs(t,i,cs.get(i,(()=>((t,e)=>{const s=e/t,i=new Vec3,n=[];for(let a=0;a<t;++a){ns(i,a/t,Je(a));const e=i.z/Math.PI,r=.5*Math.log2(s/e);n.push(i.x,i.y,i.z,r)}return n})(e,s))))))},ps=(t,e,s)=>{const i=`phong-samples-${e}-${s}`;return ds.get(t,i,(()=>hs(t,i,cs.get(i,(()=>((t,e)=>{const s=new Vec3,i=[];for(let n=0;n<t;++n)is(s,n/t,Je(n),e),i.push(s.x,s.y,s.z,0);return i})(e,s))))))},ms=(t,e,s,i)=>{const n=`ggx-samples-${e}-${s}-${i}`;return ds.get(t,n,(()=>hs(t,n,cs.get(n,(()=>ls(e,s,i))))))},_s="\nattribute vec2 vertex_position;\n\nuniform vec4 uvMod;\n\nvarying vec2 vUv0;\n\nvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tvUv0 = (vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw;\n}\n";function fs(t,e,s={}){var i;t instanceof GraphicsDevice&&(t=arguments[1],e=arguments[2],s={},void 0!==arguments[3]&&(s.specularPower=arguments[3]),void 0!==arguments[4]&&(s.numSamples=arguments[4]));const n={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"},a=s.hasOwnProperty("specularPower")?s.specularPower:1,r=s.hasOwnProperty("face")?s.face:null,o=s.hasOwnProperty("distribution")?s.distribution:1===a?"none":"phong",l=n[o]||"reproject",h=`decode${ts(t)}`,c=`encode${ts(e)}`,d=`sample${es(t.projection)}`,u=`getDirection${es(e.projection)}`,p=s.hasOwnProperty("numSamples")?s.numSamples:1024,m=`${l}_${h}_${c}_${d}_${u}_${p}`,_=t.device;let f=_.programLib._cache[m];if(!f){const t=`#define PROCESS_FUNC ${l}\n#define DECODE_FUNC ${h}\n#define ENCODE_FUNC ${c}\n#define SOURCE_FUNC ${d}\n#define TARGET_FUNC ${u}\n#define NUM_SAMPLES ${p}\n`+(_.extTextureLod?"#define SUPPORTS_TEXLOD\n":"");let e="";_.webgl2||(e="#extension GL_OES_standard_derivatives: enable\n",_.extTextureLod&&(e+="#extension GL_EXT_shader_texture_lod: enable\n\n")),f=he(_,_s,`${t}\n${Zt.reprojectPS}`,m,!1,e)}const g=_.scope.resolve(t.cubemap?"sourceCube":"sourceTex");g.setValue(t);const y=_.scope.resolve("params"),v=_.scope.resolve("params2"),b=_.scope.resolve("uvMod");if(null!=(i=s)&&i.seamPixels){const t=s.seamPixels,i=(s.rect?s.rect.z:e.width)-2*t,n=(s.rect?s.rect.w:e.height)-2*t;b.setValue([(i+2*t)/i,(n+2*t)/n,-t/i,-t/n])}else b.setValue([1,1,0,0]);const x=[0,a,t.fixCubemapSeams?1/t.width:0,e.fixCubemapSeams?1/e.width:0],S=[e.width*e.height*(e.cubemap?6:1),t.width*t.height*(t.cubemap?6:1)];if(l.startsWith("prefilterSamples")){const e=t.width*t.height*(t.cubemap?6:1),s="ggx"===o?ms(_,p,a,e):"lambert"===o?us(_,p,e):ps(_,p,a);_.scope.resolve("samplesTex").setValue(s),_.scope.resolve("samplesTexInverseSize").setValue([1/s.width,1/s.height])}for(let C=0;C<(e.cubemap?6:1);C++)if(null===r||C===r){var w;const t=new RenderTarget({colorBuffer:e,face:C,depth:!1});x[0]=C,y.setValue(x),v.setValue(S),Kt(_,t,f,null==(w=s)?void 0:w.rect),t.destroy()}}const gs=(t,e)=>1+Math.floor(Math.log2(Math.max(t,e)));class EnvLighting{static generateSkyboxCubemap(t,e){const s=((t,e,s,i)=>new Texture(t,{name:`lighting-${e}`,cubemap:!0,width:e,height:e,format:s,type:7===s?Ot:Ft,addressU:1,addressV:1,fixCubemapSeams:!0,mipmaps:!!i}))(t.device,e||(t.cubemap?t.width:t.width/4),7,!1);return fs(t,s,{numSamples:1024}),s}static generateLightingSource(t){const e=t.device,s=(t=>(t=>t.extTextureHalfFloat&&t.textureHalfFloatRenderable)(t)?at:(t=>t.extTextureFloat&&t.textureFloatRenderable)(t)?rt:7)(e),i=new Texture(e,{name:"lighting-source",cubemap:!0,width:128,height:128,format:s,type:7===s?Ot:Ft,addressU:1,addressV:1,fixCubemapSeams:!1,mipmaps:!0});return fs(t,i,{numSamples:t.mipmaps?1:1024}),i}static generateAtlas(t,e){const s=t.device,i=(null==e?void 0:e.target)||new Texture(s,{width:512,height:512,format:7,type:Ot,projection:Nt,addressU:1,addressV:1,mipmaps:!1}),n=new Vec4(0,0,512,256),a=gs(i.width,i.height);for(let r=0;r<a;++r)fs(t,i,{numSamples:1,rect:n,seamPixels:1}),n.x+=n.w,n.y+=n.w,n.z=Math.max(1,Math.floor(.5*n.z)),n.w=Math.max(1,Math.floor(.5*n.w));n.set(0,256,256,128);for(let r=1;r<7;++r)fs(t,i,{numSamples:(null==e?void 0:e.numSamples)||1024,distribution:(null==e?void 0:e.distribution)||"ggx",specularPower:Math.max(1,2048>>2*r),rect:n,seamPixels:1}),n.y+=n.w,n.z=Math.max(1,Math.floor(.5*n.z)),n.w=Math.max(1,Math.floor(.5*n.w));return n.set(128,384,64,32),fs(t,i,{numSamples:(null==e?void 0:e.numSamples)||2048,distribution:"lambert",rect:n,seamPixels:1}),i}static generatePrefilteredAtlas(t,e){const s=t[0].device,i=(null==e?void 0:e.target)||new Texture(s,{width:512,height:512,format:7,type:Ot,projection:Nt,addressU:1,addressV:1,mipmaps:!1}),n=new Vec4(0,0,512,256),a=gs(i.width,i.height);for(let r=0;r<a;++r)fs(t[0],i,{numSamples:1,rect:n,seamPixels:1}),n.x+=n.w,n.y+=n.w,n.z=Math.max(1,Math.floor(.5*n.z)),n.w=Math.max(1,Math.floor(.5*n.w));n.set(0,256,256,128);for(let r=1;r<t.length;++r)fs(t[r],i,{numSamples:1,rect:n,seamPixels:1}),n.y+=n.w,n.z=Math.max(1,Math.floor(.5*n.z)),n.w=Math.max(1,Math.floor(.5*n.w));return n.set(128,384,64,32),null!=e&&e.legacyAmbient?fs(t[5],i,{numSamples:1,rect:n,seamPixels:1}):fs(t[0],i,{numSamples:(null==e?void 0:e.numSamples)||2048,distribution:"lambert",rect:n,seamPixels:1}),i}}class DefaultMaterial{static get(t){return this.cache.get(t)}static add(t,e){this.cache.set(t,e)}static remove(t){this.cache.delete(t)}}DefaultMaterial.cache=new Map;let ys=0;class Material$1{constructor(){this.name="Untitled",this.id=ys++,this._shader=null,this.variants={},this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this.blend=!1,this.blendSrc=1,this.blendDst=0,this.blendEquation=0,this.separateAlphaBlend=!1,this.blendSrcAlpha=1,this.blendDstAlpha=0,this.blendAlphaEquation=0,this.cull=1,this.depthTest=!0,this.depthWrite=!0,this.stencilFront=null,this.stencilBack=null,this.depthBias=0,this.slopeDepthBias=0,this.redWrite=!0,this.greenWrite=!0,this.blueWrite=!0,this.alphaWrite=!0,this.meshInstances=[],this._shaderVersion=0,this._scene=null,this._dirtyBlend=!1,this.dirty=!0}set shader(t){this._shader=t}get shader(){return this._shader}get transparent(){return this.blend||1!==this.blendSrc||0!==this.blendDst||0!==this.blendEquation}set blendType(t){const e=this.blend;switch(t){case 3:this.blend=!1,this.blendSrc=1,this.blendDst=0,this.blendEquation=0;break;case 2:this.blend=!0,this.blendSrc=6,this.blendDst=8,this.blendEquation=0;break;case 4:this.blend=!0,this.blendSrc=1,this.blendDst=8,this.blendEquation=0;break;case 1:this.blend=!0,this.blendSrc=1,this.blendDst=1,this.blendEquation=0;break;case 6:this.blend=!0,this.blendSrc=6,this.blendDst=1,this.blendEquation=0;break;case 7:this.blend=!0,this.blendSrc=4,this.blendDst=2,this.blendEquation=0;break;case 8:this.blend=!0,this.blendSrc=5,this.blendDst=1,this.blendEquation=0;break;case 5:this.blend=!0,this.blendSrc=4,this.blendDst=0,this.blendEquation=0;break;case 9:this.blend=!0,this.blendSrc=1,this.blendDst=1,this.blendEquation=3;break;case 10:this.blend=!0,this.blendSrc=1,this.blendDst=1,this.blendEquation=4}e!==this.blend&&(this._scene?this._scene.layers._dirtyBlend=!0:this._dirtyBlend=!0),this._updateMeshInstanceKeys()}get blendType(){return this.transparent?this.blend&&6===this.blendSrc&&8===this.blendDst&&0===this.blendEquation?2:this.blend&&1===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?1:this.blend&&6===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?6:this.blend&&4===this.blendSrc&&2===this.blendDst&&0===this.blendEquation?7:this.blend&&5===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?8:this.blend&&1===this.blendSrc&&1===this.blendDst&&3===this.blendEquation?9:this.blend&&1===this.blendSrc&&1===this.blendDst&&4===this.blendEquation?10:this.blend&&4===this.blendSrc&&0===this.blendDst&&0===this.blendEquation?5:this.blend&&1===this.blendSrc&&8===this.blendDst&&0===this.blendEquation?4:2:3}copy(t){return this.name=t.name,this.shader=t.shader,this.alphaTest=t.alphaTest,this.alphaToCoverage=t.alphaToCoverage,this.blend=t.blend,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.separateAlphaBlend=t.separateAlphaBlend,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendAlphaEquation=t.blendAlphaEquation,this.cull=t.cull,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.depthBias=t.depthBias,this.slopeDepthBias=t.slopeDepthBias,t.stencilFront&&(this.stencilFront=t.stencilFront.clone()),t.stencilBack&&(t.stencilFront===t.stencilBack?this.stencilBack=this.stencilFront:this.stencilBack=t.stencilBack.clone()),this.redWrite=t.redWrite,this.greenWrite=t.greenWrite,this.blueWrite=t.blueWrite,this.alphaWrite=t.alphaWrite,this}clone(){return(new this.constructor).copy(this)}_updateMeshInstanceKeys(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].updateKey()}updateUniforms(t,e){}updateShader(t,e,s){}update(){this.dirty=!0,this._shader&&(this._shader.failed=!1)}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants={};for(let t=0;t<this.meshInstances.length;t++){const e=this.meshInstances[t];for(let t=0;t<e._shader.length;t++)e._shader[t]=null}}getParameter(t){return this.parameters[t]}setParameter(t,e){if(void 0===e&&"object"==typeof t){const s=t;if(s.length){for(let t=0;t<s.length;t++)this.setParameter(s[t]);return}t=s.name,e=s.value}const s=this.parameters[t];s?s.data=e:this.parameters[t]={scopeId:null,data:e}}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;void 0===e&&(e=s);for(const i in e){const e=s[i];e&&(e.scopeId||(e.scopeId=t.scope.resolve(i)),e.scopeId.setValue(e.data))}}destroy(){this.variants={},this.shader=null;for(let t=0;t<this.meshInstances.length;t++){const e=this.meshInstances[t];for(let t=0;t<e._shader.length;t++)e._shader[t]=null;if(e._material=null,e.mesh){const t=DefaultMaterial.get(e.mesh.device);this!==t&&(e.material=t)}}}addMeshInstanceRef(t){this.meshInstances.push(t)}removeMeshInstanceRef(t){const e=this.meshInstances,s=e.indexOf(t);-1!==s&&e.splice(s,1)}}const vs=(t,e)=>{if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0},bs=t=>1!==t.r||1!==t.g||1!==t.b;class StandardMaterialOptionsBuilder{constructor(){this._mapXForms=null}updateMinRef(t,e,s,i,n,a,r,o){this._updateSharedOptions(t,s,i,n,r),this._updateMinOptions(t,i),this._updateUVOptions(t,i,n,!0)}updateRef(t,e,s,i,n,a,r,o){this._updateSharedOptions(t,s,i,n,r),this._updateEnvOptions(t,e,i,s),this._updateMaterialOptions(t,i),1===r&&(t.gamma&&(t.gamma=3),t.toneMap=0),t.hasTangents=n&&i.normalMap&&0!=(512&n),this._updateLightOptions(t,i,n,o,a),this._updateUVOptions(t,i,n,!1)}_updateSharedOptions(t,e,s,i,n){t.pass=n,t.alphaTest=s.alphaTest>0,t.forceFragmentPrecision=s.forceFragmentPrecision||"",t.chunks=s.chunks||"",t.blendType=s.blendType,t.forceUv1=s.forceUv1,t.separateAmbient=!1,t.screenSpace=i&&0!=(i&Q),t.skin=i&&0!=(2&i),t.useInstancing=i&&0!=(32&i),t.useMorphPosition=i&&0!=(i&J),t.useMorphNormal=i&&0!=(i&tt),t.useMorphTextureBased=i&&0!=(i&et),t.nineSlicedMode=s.nineSlicedMode||0,e.clusteredLightingEnabled&&(t.clusteredLightingEnabled=!0,t.clusteredLightingCookiesEnabled=e.lighting.cookiesEnabled,t.clusteredLightingShadowsEnabled=e.lighting.shadowsEnabled,t.clusteredLightingShadowType=e.lighting.shadowType,t.clusteredLightingAreaLightsEnabled=e.lighting.areaLightsEnabled)}_updateUVOptions(t,e,s,i){let n=!1,a=!1,r=!1;s&&(n=0!=(4&s),a=0!=(8&s),r=0!=(16&s)),t.vertexColors=!1,this._mapXForms=[];for(const o in Xe)this._updateTexOptions(t,e,o,n,a,r,i);this._mapXForms=null}_updateMinOptions(t,e){t.opacityTint=1!==e.opacity&&3!==e.blendType,t.lights=[]}_updateMaterialOptions(t,e){const s=(e.diffuseTint||!e.diffuseMap&&!e.diffuseVertexColor)&&bs(e.diffuse),i=!!(e.useMetalness||e.specularMap||e.sphereMap||e.cubeMap||(n=e.specular,0!==n.r||0!==n.g||0!==n.b)||e.enableGGXSpecular||e.clearCoat>0);var n;const a=i&&!e.useMetalness&&(e.specularTint||!e.specularMap&&!e.specularVertexColor)&&bs(e.specular),r=!e.emissiveMap||bs(e.emissive)&&e.emissiveTint,o=1!==e.emissiveIntensity,l=!!e.normalMap&&(e.normalMap.format===nt||e.normalMap.type===Bt);t.opacityTint=1!==e.opacity&&3!==e.blendType?1:0,t.blendMapsWithColors=!0,t.ambientTint=e.ambientTint,t.diffuseTint=s?2:0,t.specularTint=a?2:0,t.metalnessTint=e.useMetalness&&e.metalness<1?1:0,t.glossTint=1,t.emissiveTint=(r?2:0)+(o?1:0),t.alphaToCoverage=e.alphaToCoverage,t.normalizeNormalMap=e.normalizeNormalMap,t.ambientSH=!!e.ambientSH,t.useSpecular=i,t.emissiveFormat=e.emissiveMap?e.emissiveMap.type===Ot?1:e.emissiveMap.format===rt?2:0:null,t.lightMapFormat=e.lightMap?e.lightMap.type===Ot?1:e.lightMap.format===rt?2:0:null,t.specularAntialias=e.specularAntialias&&!!e.normalMap&&!!e.normalMap.mipmaps&&!l,t.conserveEnergy=e.conserveEnergy,t.opacityFadesSpecular=e.opacityFadesSpecular,t.alphaFade=e.alphaFade,t.occludeSpecular=e.occludeSpecular,t.occludeSpecularFloat=1!==e.occludeSpecularIntensity,t.occludeDirect=e.occludeDirect,t.shadingModel=e.shadingModel,t.fresnelModel=e.fresnelModel,t.packedNormal=l,t.fastTbn=e.fastTbn,t.cubeMapProjection=e.cubeMapProjection,t.customFragmentShader=e.customFragmentShader,t.refraction=!!e.refraction,t.useMetalness=e.useMetalness,t.enableGGXSpecular=e.enableGGXSpecular,t.msdf=!!e.msdfMap,t.twoSidedLighting=e.twoSidedLighting,t.pixelSnap=e.pixelSnap,t.aoMapUv=e.aoUvSet,t.diffuseDetail=!!e.diffuseMap,t.normalDetail=!!e.normalMap,t.diffuseDetailMode=e.diffuseDetailMode,t.detailModes=!!t.diffuseDetail,t.clearCoat=!!e.clearCoat,t.clearCoatTint=1!==e.clearCoat?1:0,t.clearCoatGlossiness=!!e.clearCoatGlossiness,t.clearCoatGlossTint=1!==e.clearCoatGlossiness?1:0}_updateEnvOptions(t,e,s,i){t.fog=s.useFog?i.fog:"none",t.gamma=s.useGammaTonemap?i.gammaCorrection:0,t.toneMap=s.useGammaTonemap?i.toneMapping:-1,t.useRgbm=s.emissiveMap&&s.emissiveMap.type===Ot||s.lightMap&&s.lightMap.type===Ot,t.fixSeams=!!s.cubeMap&&s.cubeMap.fixCubemapSeams,t.skyboxIntensity=1!==i.skyboxIntensity;const n=0===s.shadingModel;let a=!1;if(s.envAtlas&&!n?(t.reflectionSource="envAtlas",t.reflectionEncoding=s.envAtlas.encoding):s.cubeMap?(t.reflectionSource="cubeMap",t.reflectionEncoding=s.cubeMap.encoding):s.sphereMap?(t.reflectionSource="sphereMap",t.reflectionEncoding=s.sphereMap.encoding):s.useSkybox&&i.envAtlas&&!n?(t.reflectionSource="envAtlas",t.reflectionEncoding=i.envAtlas.encoding,a=!0):(t.reflectionSource=null,t.reflectionEncoding=null),s.ambientSH&&!n)t.ambientSource="ambientSH",t.ambientEncoding=null;else{const e=s.envAtlas||(s.useSkybox&&i.envAtlas?i.envAtlas:null);e&&!n?(t.ambientSource="envAtlas",t.ambientEncoding=e.encoding):(t.ambientSource="constant",t.ambientEncoding=null)}t.useCubeMapRotation=a&&i.skyboxRotation&&!i.skyboxRotation.equals(Quat.IDENTITY)}_updateLightOptions(t,e,s,i,n){if(t.lightMap=!1,t.lightMapChannel="",t.lightMapUv=0,t.lightMapTransform=0,t.lightMapWithoutAmbient=!1,t.dirLightMap=!1,s&&(t.noShadow=0!=(1&s),0!=(64&s)&&(t.lightMapFormat=1,t.lightMap=!0,t.lightMapChannel="rgb",t.lightMapUv=1,t.lightMapTransform=0,t.lightMapWithoutAmbient=!e.lightMap,t.useRgbm=!0,0!=(128&s)&&(t.dirLightMap=!0),0!=(s&st)&&(t.lightMapWithoutAmbient=!1))),e.useLighting){const e=[],a=s?s>>16:1;t.lightMaskDynamic=!!(1&a),i&&(this._collectLights(0,i[0],e,a),this._collectLights(1,i[1],e,a,n),this._collectLights(2,i[2],e,a,n)),t.lights=e}else t.lights=[];0===t.lights.length&&(t.noShadow=!0)}_updateTexOptions(t,e,s,i,n,a,r){const o=s+"Map",l=s+"VertexColor",h=s+"VertexColorChannel",c=o+"Channel",d=o+"Transform",u=o+"Uv";"light"!==s&&(t[o]=!1,t[c]="",t[d]=0,t[u]=0),t[l]=!1,t[h]="";const p="opacity"===s;if(p&&3===e.blendType&&0===e.alphaTest&&!e.alphaToCoverage)return t;if((!r||p)&&("height"!==s&&e[l]&&a&&(t[l]=e[l],t[h]=e[h],t.vertexColors=!0),e[o])){let s=!0;0!==e[u]||i||(s=!1),1!==e[u]||n||(s=!1),s&&(t[o]=!!e[o],t[d]=this._getMapTransformID(e.getUniform(d),e[u]),t[c]=e[c],t[u]=e[u])}}_collectLights(t,e,s,i,n){for(let a=0;a<e.length;a++){const n=e[a];if(n.enabled&&n.mask&i){if(0!==t&&n.isStatic)continue;s.push(n)}}if(n)for(let a=0;a<n.length;a++){const e=n[a];e._type===t&&s.push(e)}}_getMapTransformID(t,e){if(!t)return 0;let s=this._mapXForms[e];s||(s=[],this._mapXForms[e]=s);for(let i=0;i<s.length;i++)if(vs(s[i][0].value,t[0].value)&&vs(s[i][1].value,t[1].value))return i+1;return s.push(t)}}const xs={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",aoMapRotation:"number",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseMapRotation:"number",diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMapRotation:"number",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularMapRotation:"number",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",netalnessMapRotation:"number",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",glossMapRotation:"number",clearCoat:"number",clearCoatVertexColor:"boolean",clearCoatVertexColorChannel:"string",clearCoatMap:"texture",clearCoatMapChannel:"string",clearCoatMapUv:"number",clearCoatMapTiling:"vec2",clearCoatMapOffset:"vec2",clearCoatMapRotation:"number",clearCoatGlossiness:"number",clearCoatGlossVertexColor:"boolean",clearCoatGlossVertexColorChannel:"string",clearCoatGlossMap:"texture",clearCoatGlossMapChannel:"string",clearCoatGlossMapUv:"number",clearCoatGlossMapTiling:"vec2",clearCoatGlossMapOffset:"vec2",clearCoatGlossMapRotation:"number",clearCoatBumpiness:"number",clearCoatNormalMap:"texture",clearCoatNormalMapUv:"number",clearCoatNormalMapTiling:"vec2",clearCoatNormalMapOffset:"vec2",clearCoatNormalMapRotation:"number",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveMapMapRotation:"number",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapRotation:"number",normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapRotation:"number",normalDetailMapUv:"number",normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapRotation:"number",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",opacityMapRotation:"number",opacityFadesSpecular:"boolean",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",lightMapRotation:"number",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",envAtlas:"texture"},Ss=[];for(const Yu in xs){"texture"===xs[Yu]&&Ss.push(Yu)}const ws=[];for(const Yu in xs){"cubemap"===xs[Yu]&&ws.push(Yu)}const Cs={},Ts={};let Ms=new Set;class StandardMaterial extends Material$1{constructor(){super(),this._dirtyShader=!0,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new StandardMaterialOptionsBuilder,this.reset()}reset(){Object.keys(Cs).forEach((t=>{this[`_${t}`]=Cs[t].value()})),this._chunks={},this._uniformCache={}}set chunks(t){this._dirtyShader=!0,this._chunks=t}get chunks(){return this._dirtyShader=!0,this._chunks}copy(t){super.copy(t),Object.keys(Cs).forEach((e=>{this[e]=t[e]}));for(const e in t._chunks)t._chunks.hasOwnProperty(e)&&(this._chunks[e]=t._chunks[e]);return this}_setParameter(t,e){Ms.add(t),this.setParameter(t,e)}_setParameters(t){t.forEach((t=>{this._setParameter(t.name,t.value)}))}_processParameters(t){const e=this[t];e.forEach((t=>{Ms.has(t)||delete this.parameters[t]})),this[t]=Ms,Ms=e,Ms.clear()}_updateMap(t){const e=t+"Map",s=this[e];if(s){this._setParameter("texture_"+e,s);const t=e+"Transform",i=this.getUniform(t);i&&this._setParameters(i)}}_allocUniform(t,e){let s=this._uniformCache[t];return s||(s=e(),this._uniformCache[t]=s),s}getUniform(t,e,s){return Ts[t](this,e,s)}updateUniforms(t,e){const s=s=>this.getUniform(s,t,e);this._setParameter("material_ambient",s("ambient")),this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",s("diffuse")),this.useMetalness?(!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness):this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_shininess",s("shininess")),this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",s("emissive")),1!==this.emissiveIntensity&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(s("cubeMapProjectionBox"));for(const i in Xe)this._updateMap(i);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor")),this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap),this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),this._dirtyShader&&(this.shader=null,this.clearVariants())}updateEnvUniforms(t,e){const s=this.envAtlas||(this.useSkybox?e.envAtlas:null);s&&(this._setParameter("texture_envAtlas",s),this.useSkybox&&!e.skyboxRotation.equals(Quat.IDENTITY)&&e._skyboxRotationMat3&&this._setParameter("cubeMapRotationMatrix",e._skyboxRotationMat3.data)),this._processParameters("_activeLightingParams")}updateShader(t,e,s,i,n,a){this.updateEnvUniforms(t,e);const r=n>1&&n<=18;let o=r?$e.optionsContextMin:$e.optionsContext;r?this.shaderOptBuilder.updateMinRef(o,t,e,this,s,i,n,a):this.shaderOptBuilder.updateRef(o,t,e,this,s,i,n,a),this.onUpdateShader&&(o=this.onUpdateShader(o));const l=t.getProgramLibrary();this.shader=l.getProgram("standard",o),s||(this.clearVariants(),this.variants[0]=this.shader),this._dirtyShader=!1}destroy(){for(const t in this._assetReferences)this._assetReferences[t]._unbind();this._assetReferences=null,super.destroy()}}StandardMaterial.TEXTURE_PARAMETERS=Ss,StandardMaterial.CUBEMAP_PARAMETERS=ws;const As=(t,e)=>{Ts[t]=e},Ps=(t,e,s,i)=>{Object.defineProperty(StandardMaterial.prototype,t,{get:i||function(){return this[`_${t}`]},set:s}),Cs[t]={value:e}},Es=t=>{const e=`_${t.name}`,s=t.dirtyShaderFunc||(()=>!0);Ps(t.name,(()=>t.defaultValue),(function(t){const i=this[e];i!==t&&(this._dirtyShader=this._dirtyShader||s(i,t),this[e]=t)}),t.getterFunc)},Ls=t=>{const e=`_${t.name}`,s=t.dirtyShaderFunc||(()=>!0);Ps(t.name,(()=>t.defaultValue.clone()),(function(t){const i=this[e];i.equals(t)||(this._dirtyShader=this._dirtyShader||s(i,t),this[e]=i.copy(t))}),t.getterFunc)},Rs=t=>t.defaultValue&&t.defaultValue.clone?Ls(t):Es(t);function Is(t,e,s,i,n,a){Xe[t]=s,Rs({name:`${t}Map`,defaultValue:null,dirtyShaderFunc:(t,e)=>!!t!=!!e||t&&(t.type!==e.type||t.fixCubemapSeams!==e.fixCubemapSeams||t.format!==e.format)}),Rs({name:`${t}MapTiling`,defaultValue:new Vec2(1,1)}),Rs({name:`${t}MapOffset`,defaultValue:new Vec2(0,0)}),Rs({name:`${t}MapRotation`,defaultValue:0}),Rs({name:`${t}MapUv`,defaultValue:e}),s>0&&Rs({name:`${t}MapChannel`,defaultValue:i||(s>1?"rgb":"g")}),n&&(Rs({name:`${t}VertexColor`,defaultValue:!1}),s>0&&Rs({name:`${t}VertexColorChannel`,defaultValue:i||(s>1?"rgb":"g")})),a&&Rs({name:`${t}Mode`,defaultValue:"mul"});const r=`${t}MapTiling`,o=`${t}MapOffset`,l=`${t}MapRotation`,h=`${t}MapTransform`;As(h,((t,e,s)=>{const i=t[r],n=t[o],a=t[l];if(1===i.x&&1===i.y&&0===n.x&&0===n.y&&0===a)return null;const c=t._allocUniform(h,(()=>[{name:`texture_${h}0`,value:new Float32Array(3)},{name:`texture_${h}1`,value:new Float32Array(3)}])),d=Math.cos(a*O.DEG_TO_RAD),u=Math.sin(a*O.DEG_TO_RAD),p=c[0].value;p[0]=d*i.x,p[1]=-u*i.y,p[2]=n.x;const m=c[1].value;return m[0]=u*i.x,m[1]=d*i.y,m[2]=1-i.y-n.y,c}))}function Ds(t,e){Rs({name:t,defaultValue:e,getterFunc:function(){return this._dirtyShader=!0,this[`_${t}`]}}),As(t,((e,s,i)=>{const n=e._allocUniform(t,(()=>new Float32Array(3))),a=e[t];return e.useGammaTonemap&&i.gammaCorrection?(n[0]=Math.pow(a.r,2.2),n[1]=Math.pow(a.g,2.2),n[2]=Math.pow(a.b,2.2)):(n[0]=a.r,n[1]=a.g,n[2]=a.b),n}))}function ks(t,e,s){Rs({name:t,defaultValue:e,dirtyShaderFunc:(t,e)=>(0===t||1===t)!=(0===e||1===e)}),As(t,s)}function Fs(t,e){Rs({name:t,defaultValue:null,dirtyShaderFunc:(t,e)=>!!t==!!e}),As(t,e)}function Os(t,e){Rs({name:t,defaultValue:e})}!function(){Ds("ambient",new Color(.7,.7,.7)),Ds("diffuse",new Color(1,1,1)),Ds("specular",new Color(0,0,0)),Ds("emissive",new Color(0,0,0)),ks("emissiveIntensity",1),ks("shininess",25,((t,e,s)=>0===t.shadingModel?Math.pow(2,.01*t.shininess*11):.01*t.shininess)),ks("heightMapFactor",1,((t,e,s)=>.025*t.heightMapFactor)),ks("opacity",1),ks("alphaFade",1),ks("alphaTest",0),ks("bumpiness",1),ks("normalDetailMapBumpiness",1),ks("reflectivity",1),ks("occludeSpecularIntensity",1),ks("refraction",0),ks("refractionIndex",1/1.5),ks("metalness",1),ks("anisotropy",0),ks("clearCoat",0),ks("clearCoatGlossiness",1),ks("clearCoatBumpiness",1),ks("aoUvSet",0,null),Fs("ambientSH"),Fs("cubeMapProjectionBox",((t,e,s)=>{const i=t._allocUniform("cubeMapProjectionBox",(()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}])),n=t.cubeMapProjectionBox.getMin(),a=i[0].value;a[0]=n.x,a[1]=n.y,a[2]=n.z;const r=t.cubeMapProjectionBox.getMax(),o=i[1].value;return o[0]=r.x,o[1]=r.y,o[2]=r.z,i})),Os("ambientTint",!1),Os("diffuseTint",!1),Os("specularTint",!1),Os("emissiveTint",!1),Os("fastTbn",!1),Os("specularAntialias",!1),Os("useMetalness",!1),Os("enableGGXSpecular",!1),Os("occludeDirect",!1),Os("normalizeNormalMap",!0),Os("conserveEnergy",!0),Os("opacityFadesSpecular",!0),Os("occludeSpecular",1),Os("shadingModel",1),Os("fresnelModel",2),Os("cubeMapProjection",0),Os("customFragmentShader",null),Os("forceFragmentPrecision",null),Os("useFog",!0),Os("useLighting",!0),Os("useGammaTonemap",!0),Os("useSkybox",!0),Os("forceUv1",!1),Os("pixelSnap",!1),Os("twoSidedLighting",!1),Os("nineSlicedMode",void 0),Is("diffuse",0,3,"",!0),Is("specular",0,3,"",!0),Is("emissive",0,3,"",!0),Is("normal",0,-1,"",!1),Is("metalness",0,1,"",!0),Is("gloss",0,1,"",!0),Is("opacity",0,1,"a",!0),Is("height",0,1,"",!1),Is("ao",0,1,"",!0),Is("light",1,3,"",!0),Is("msdf",0,3,"",!1),Is("diffuseDetail",0,3,"",!1,!0),Is("normalDetail",0,-1,"",!1),Is("clearCoat",0,1,"",!0),Is("clearCoatGloss",0,1,"",!0),Is("clearCoatNormal",0,-1,"",!1),Fs("cubeMap"),Fs("sphereMap"),Fs("envAtlas");const t=[null,null,null,null,null,null];Ps("prefilteredCubemaps",(()=>t.slice()),(function(t){const e=this._prefilteredCubemaps;t=t||[];let s=!1,i=!0;for(let n=0;n<6;++n){const a=t[n]||null;e[n]!==a&&(e[n]=a,s=!0),i=i&&!!e[n]}s&&(i?this.envAtlas=EnvLighting.generatePrefilteredAtlas(e,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)}),(function(){return this._prefilteredCubemaps}))}();class ProgramLibrary{constructor(t){this._device=t,this._cache={},this._generators={},this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption={},this._defaultStdMatOptionMin={};const e=new StandardMaterial;e.shaderOptBuilder.updateRef(this._defaultStdMatOption,t,{},e,null,[],0,null,null),e.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,t,{},e,null,[],3,null,null)}register(t,e){this.isRegistered(t)||(this._generators[t]=e)}unregister(t){this.isRegistered(t)&&delete this._generators[t]}isRegistered(t){return void 0!==this._generators[t]}getProgram(t,e){const s=this._generators[t];if(void 0===s)return null;const i=this._device,n=s.generateKey(e);let a=this._cache[n];if(!a){let r;e.lights&&(r=e.lights,e.lights=r.map((function(t){const e=t.clone?t.clone():t;return e.key=t.key,e}))),this.storeNewProgram(t,e),e.lights&&(e.lights=r),this._precached&&console.warn(`ProgramLibrary#getProgram: Cache miss for shader ${t} key ${n} after shaders precaching`);const o=s.createShaderDefinition(i,e);a=this._cache[n]=new Shader(i,o)}return a}storeNewProgram(t,e){let s={};if("standard"===t){const t=this._getDefaultStdMatOptions(e.pass);for(const i in e)(e.hasOwnProperty(i)&&t[i]!==e[i]||"pass"===i)&&(s[i]=e[i])}else s=e;this._programsCollection.push(JSON.stringify({name:t,options:s}))}dumpPrograms(){let t="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";t+="let shaders = [",this._programsCollection[0]&&(t+="\n\t"+this._programsCollection[0]);for(let s=1;s<this._programsCollection.length;++s)t+=",\n\t"+this._programsCollection[s];t+="\n];\n",t+="device.programLib.precompile(shaders);\n",t+='if (pc.version != "1.52.1" || pc.revision != "0f56653b1")\n',t+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';const e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),e.setAttribute("download","precompile-shaders.js"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}clearCache(){const t=this._cache;this._isClearingCache=!0;for(const e in t)t.hasOwnProperty(e)&&t[e].destroy();this._cache={},this._isClearingCache=!1}removeFromCache(t){if(this._isClearingCache)return;const e=this._cache;for(const s in e)if(e.hasOwnProperty(s)&&e[s]===t){delete e[s];break}}_getDefaultStdMatOptions(t){return t>1&&t<=18?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(t){if(t){const e=new Array(t.length);for(let s=0;s<t.length;s++){if("standard"===t[s].name){const e=t[s].options,i=this._getDefaultStdMatOptions(e.pass);for(const t in i)i.hasOwnProperty(t)&&void 0===e[t]&&(e[t]=i[t])}e[s]=this.getProgram(t[s].name,t[s].options)}}this._precached=!0}}class Version{constructor(){this.globalId=0,this.revision=0}equals(t){return this.globalId===t.globalId&&this.revision===t.revision}copy(t){this.globalId=t.globalId,this.revision=t.revision}reset(){this.globalId=0,this.revision=0}}let Vs=0;class VersionedObject{constructor(){Vs++,this.version=new Version,this.version.globalId=Vs}increment(){this.version.revision++}}class ScopeId{constructor(t){this.name=t,this.value=null,this.versionObject=new VersionedObject}setValue(t){this.value=t,this.versionObject.increment()}getValue(){return this.value}}class ScopeSpace{constructor(t){this.name=t,this.variables=new Map}resolve(t){return this.variables.has(t)||this.variables.set(t,new ScopeId(t)),this.variables.get(t)}removeValue(t){for(const e in this.variables){const s=this.variables[e];s.value===t&&(s.value=null)}}}class ShaderInput{constructor(t,e,s,i){if(this.locationId=i,this.scopeId=t.scope.resolve(e),this.version=new Version,"[0]"===e.substr(e.length-3))switch(s){case 2:s=17;break;case 3:s=21;break;case 4:s=22;break;case 5:s=23}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}class GrabPass{constructor(t,e){this.device=t,this.useAlpha=e,this.useMipmaps=t.webgl2,this.texture=null,this.renderTarget=null,this.textureId=null}destroy(){this.textureId=null,this.renderTarget&&(this.renderTarget.destroy(),this.renderTarget=null),this.texture&&(this.texture.destroy(),this.texture=null)}create(){if(!this.texture){const t=new Texture(this.device,{name:"texture_grabPass",format:this.useAlpha?7:6,minFilter:this.useMipmaps?5:1,magFilter:1,addressU:1,addressV:1,mipmaps:this.useMipmaps});this.texture=t,this.renderTarget=new RenderTarget({colorBuffer:t,depth:!1}),this.textureId=this.device.scope.resolve(t.name),this.textureId.setValue(t)}}update(){const t=this.device,e=t.gl;if(!t.grabPassAvailable)return!1;const s=t.renderTarget,i=s&&s._glResolveFrameBuffer,n=this.texture,a=t.width,r=t.height;if(t.webgl2&&!t._tempMacChromeBlitFramebufferWorkaround&&a===n._width&&r===n._height){i&&s.resolve(!0);const n=s?s._glFrameBuffer:null,o=s?s._glResolveFrameBuffer||s._glFrameBuffer:null;t.initRenderTarget(this.renderTarget);const l=this.renderTarget._glFrameBuffer;e.bindFramebuffer(e.READ_FRAMEBUFFER,o),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,l),e.blitFramebuffer(0,0,a,r,0,0,a,r,e.COLOR_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,n)}else{i&&(s.resolve(!0),e.bindFramebuffer(e.FRAMEBUFFER,s._glResolveFrameBuffer));const t=n._glFormat;e.copyTexImage2D(e.TEXTURE_2D,0,t,0,0,a,r,0),n._width=a,n._height=r,i&&e.bindFramebuffer(e.FRAMEBUFFER,s._glFrameBuffer)}return!0}generateMipmaps(){this.useMipmaps&&this.device.gl.generateMipmap(this.texture._glTarget)}prepareTexture(){const t=this.update();return t&&this.generateMipmaps(),t}}const Bs="resizecanvas";function zs(t,e){const s=t.width,i=t.height;if(s>e||i>e){const n=e/Math.max(s,i),a=Math.floor(s*n),r=Math.floor(i*n),o=document.createElement("canvas");o.width=a,o.height=r;return o.getContext("2d").drawImage(t,0,0,s,i,0,0,a,r),o}return t}function Us(t,e){let s=!0;const i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,null);const n=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE&&(s=!1),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(i),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(n),s}class GraphicsDevice extends EventHandler{constructor(t,e={}){super(),this.canvas=void 0,this.gl=void 0,this.maxAnisotropy=void 0,this.maxCubeMapSize=void 0,this.maxTextureSize=void 0,this.maxVolumeSize=void 0,this.precision=void 0,this.scope=void 0,this.supportsInstancing=void 0,this.textureFloatRenderable=void 0,this.textureHalfFloatRenderable=void 0,this.webgl2=void 0,this.canvas=t,this._enableAutoInstancing=!1,this.autoInstancingMaxObjects=16384,this.defaultFramebuffer=null,this._maxPixelRatio=1,this._width=0,this._height=0,this.updateClientRect(),this.shaders=[],this.buffers=[],this.textures=[],this.targets=[],this.contextLost=!1,this._contextLostHandler=t=>{t.preventDefault(),this.contextLost=!0,this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.contextLost=!1,this.fire("devicerestored")},e.stencil=!0,e.powerPreference||(e.powerPreference="high-performance");const s=void 0===e.preferWebGl2||e.preferWebGl2?["webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"];let n=null;for(let i=0;i<s.length;i++)if(n=t.getContext(s[i],e),n){this.webgl2="webgl2"===s[i];break}if(!n)throw new Error("WebGL not supported");const a=S.browser&&!!window.chrome,r=S.browser&&-1!==navigator.appVersion.indexOf("Mac");let o,l,h,c,d;this.gl=n,this._tempEnableSafariTextureUnitWorkaround=S.browser&&!!window.safari,this._tempMacChromeBlitFramebufferWorkaround=r&&a&&!e.alpha,this.webgl2||function(t){if(t.getSupportedExtensions){if(-1!=t.getSupportedExtensions().indexOf("OES_vertex_array_object"))return}else if(t.getExtension&&t.getExtension("OES_vertex_array_object"))return;if(t.getSupportedExtensions){var e=t.getSupportedExtensions;t.getSupportedExtensions=function(){var t=e.call(this)||[];return t.push("OES_vertex_array_object"),t}}var s=t.getExtension;t.getExtension=function(e){return"OES_vertex_array_object"==e?(t.__OESVertexArrayObject||(t.__OESVertexArrayObject=new i(t)),t.__OESVertexArrayObject):s?s.call(this,e):null}}(n),t.addEventListener("webglcontextlost",this._contextLostHandler,!1),t.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.glAddress=[n.REPEAT,n.CLAMP_TO_EDGE,n.MIRRORED_REPEAT],this.glBlendEquation=[n.FUNC_ADD,n.FUNC_SUBTRACT,n.FUNC_REVERSE_SUBTRACT,this.webgl2?n.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:n.FUNC_ADD,this.webgl2?n.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:n.FUNC_ADD],this.glBlendFunction=[n.ZERO,n.ONE,n.SRC_COLOR,n.ONE_MINUS_SRC_COLOR,n.DST_COLOR,n.ONE_MINUS_DST_COLOR,n.SRC_ALPHA,n.SRC_ALPHA_SATURATE,n.ONE_MINUS_SRC_ALPHA,n.DST_ALPHA,n.ONE_MINUS_DST_ALPHA],this.glComparison=[n.NEVER,n.LESS,n.EQUAL,n.LEQUAL,n.GREATER,n.NOTEQUAL,n.GEQUAL,n.ALWAYS],this.glStencilOp=[n.KEEP,n.ZERO,n.REPLACE,n.INCR,n.INCR_WRAP,n.DECR,n.DECR_WRAP,n.INVERT],this.glClearFlag=[0,n.COLOR_BUFFER_BIT,n.DEPTH_BUFFER_BIT,n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT],this.glCull=[0,n.BACK,n.FRONT,n.FRONT_AND_BACK],this.glFilter=[n.NEAREST,n.LINEAR,n.NEAREST_MIPMAP_NEAREST,n.NEAREST_MIPMAP_LINEAR,n.LINEAR_MIPMAP_NEAREST,n.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[n.POINTS,n.LINES,n.LINE_LOOP,n.LINE_STRIP,n.TRIANGLES,n.TRIANGLE_STRIP,n.TRIANGLE_FAN],this.glType=[n.BYTE,n.UNSIGNED_BYTE,n.SHORT,n.UNSIGNED_SHORT,n.INT,n.UNSIGNED_INT,n.FLOAT],this.pcUniformType={},this.pcUniformType[n.BOOL]=0,this.pcUniformType[n.INT]=1,this.pcUniformType[n.FLOAT]=2,this.pcUniformType[n.FLOAT_VEC2]=3,this.pcUniformType[n.FLOAT_VEC3]=4,this.pcUniformType[n.FLOAT_VEC4]=5,this.pcUniformType[n.INT_VEC2]=6,this.pcUniformType[n.INT_VEC3]=7,this.pcUniformType[n.INT_VEC4]=8,this.pcUniformType[n.BOOL_VEC2]=9,this.pcUniformType[n.BOOL_VEC3]=10,this.pcUniformType[n.BOOL_VEC4]=11,this.pcUniformType[n.FLOAT_MAT2]=12,this.pcUniformType[n.FLOAT_MAT3]=13,this.pcUniformType[n.FLOAT_MAT4]=14,this.pcUniformType[n.SAMPLER_2D]=15,this.pcUniformType[n.SAMPLER_CUBE]=16,this.webgl2&&(this.pcUniformType[n.SAMPLER_2D_SHADOW]=18,this.pcUniformType[n.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[n.SAMPLER_3D]=20),this.targetToSlot={},this.targetToSlot[n.TEXTURE_2D]=0,this.targetToSlot[n.TEXTURE_CUBE_MAP]=1,this.targetToSlot[n.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[0]=function(t,e){t.value!==e&&(n.uniform1i(t.locationId,e),t.value=e)},this.commitFunction[1]=this.commitFunction[0],this.commitFunction[2]=function(t,e){t.value!==e&&(n.uniform1f(t.locationId,e),t.value=e)},this.commitFunction[3]=function(t,e){d=t.value,o=e[0],l=e[1],d[0]===o&&d[1]===l||(n.uniform2fv(t.locationId,e),d[0]=o,d[1]=l)},this.commitFunction[4]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],d[0]===o&&d[1]===l&&d[2]===h||(n.uniform3fv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h)},this.commitFunction[5]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],c=e[3],d[0]===o&&d[1]===l&&d[2]===h&&d[3]===c||(n.uniform4fv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h,d[3]=c)},this.commitFunction[6]=function(t,e){d=t.value,o=e[0],l=e[1],d[0]===o&&d[1]===l||(n.uniform2iv(t.locationId,e),d[0]=o,d[1]=l)},this.commitFunction[9]=this.commitFunction[6],this.commitFunction[7]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],d[0]===o&&d[1]===l&&d[2]===h||(n.uniform3iv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h)},this.commitFunction[10]=this.commitFunction[7],this.commitFunction[8]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],c=e[3],d[0]===o&&d[1]===l&&d[2]===h&&d[3]===c||(n.uniform4iv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h,d[3]=c)},this.commitFunction[11]=this.commitFunction[8],this.commitFunction[12]=function(t,e){n.uniformMatrix2fv(t.locationId,!1,e)},this.commitFunction[13]=function(t,e){n.uniformMatrix3fv(t.locationId,!1,e)},this.commitFunction[14]=function(t,e){n.uniformMatrix4fv(t.locationId,!1,e)},this.commitFunction[17]=function(t,e){n.uniform1fv(t.locationId,e)},this.commitFunction[21]=function(t,e){n.uniform2fv(t.locationId,e)},this.commitFunction[22]=function(t,e){n.uniform3fv(t.locationId,e)},this.commitFunction[23]=function(t,e){n.uniform4fv(t.locationId,e)},this.scope=new ScopeSpace("Device"),this.programLib=new ProgramLibrary(this);for(const i in Ye)this.programLib.register(i,Ye[i]);this.supportsBoneTextures=this.extTextureFloat&&this.maxVertexTextures>0;let u=this.vertexUniformsCount;u-=16,u-=8,u-=1,u-=16,this.boneLimit=Math.floor(u/3),this.boneLimit=Math.min(this.boneLimit,128),"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let i=0;i<=6;i++)this._primsPerFrame[i]=0;this._renderTargetCreationTime=0,this._vram={tex:0,vb:0,ib:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.constantTexSource=this.scope.resolve("source"),this.extTextureFloat?this.webgl2?this.textureFloatRenderable=!!this.extColorBufferFloat:this.textureFloatRenderable=Us(n,n.FLOAT):this.textureFloatRenderable=!1,this.extColorBufferHalfFloat?this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat:this.extTextureHalfFloat?this.webgl2?this.textureHalfFloatRenderable=!!this.extColorBufferFloat:this.textureHalfFloatRenderable=Us(n,this.extTextureHalfFloat.HALF_FLOAT_OES):this.textureHalfFloatRenderable=!1,this.supportsMorphTargetTexturesCore="highp"===this.maxPrecision&&this.maxVertexTextures>=2,this._textureFloatHighPrecision=void 0,this._textureHalfFloatUpdatable=void 0,this.grabPassAvailable=!0,this.grabPass=new GrabPass(this,e.alpha),this.grabPass.create(),VertexFormat.init(this),this.areaLightLutFormat=7,this.extTextureHalfFloat&&this.textureHalfFloatUpdatable&&this.extTextureHalfFloatLinear?this.areaLightLutFormat=at:this.extTextureFloat&&this.extTextureFloatLinear&&(this.areaLightLutFormat=rt)}destroy(){const t=this.gl;this.fire("destroy"),this.grabPass.destroy(),this.webgl2&&this.feedback&&t.deleteTransformFeedback(this.feedback),this.clearShaderCache(),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.scope=null,this.canvas=null,this.gl=null}toJSON(t){}getPrecision(){const t=this.gl;let e="highp";if(t.getShaderPrecisionFormat){const s=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),n=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),a=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),r=s.precision>0&&n.precision>0,o=i.precision>0&&a.precision>0;r||(e=o?"mediump":"lowp")}return e}initializeExtensions(){const t=this.gl,e=t.getSupportedExtensions(),s=function(){for(let s=0;s<arguments.length;s++)if(-1!==e.indexOf(arguments[s]))return t.getExtension(arguments[s]);return null};if(this.webgl2)this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=s("EXT_color_buffer_float"),this.extDisjointTimerQuery=s("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query");else{if(this.extBlendMinmax=s("EXT_blend_minmax"),this.extDrawBuffers=s("EXT_draw_buffers"),this.extInstancing=s("ANGLE_instanced_arrays"),this.extInstancing){const e=this.extInstancing;t.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),t.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),t.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)}if(this.extStandardDerivatives=s("OES_standard_derivatives"),this.extTextureFloat=s("OES_texture_float"),this.extTextureHalfFloat=s("OES_texture_half_float"),this.extTextureLod=s("EXT_shader_texture_lod"),this.extUintElement=s("OES_element_index_uint"),this.extVertexArrayObject=s("OES_vertex_array_object"),this.extVertexArrayObject){const e=this.extVertexArrayObject;t.createVertexArray=e.createVertexArrayOES.bind(e),t.deleteVertexArray=e.deleteVertexArrayOES.bind(e),t.isVertexArray=e.isVertexArrayOES.bind(e),t.bindVertexArray=e.bindVertexArrayOES.bind(e)}this.extColorBufferFloat=null,this.extDisjointTimerQuery=null}this.extDebugRendererInfo=s("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=s("OES_texture_float_linear"),this.extTextureHalfFloatLinear=s("OES_texture_half_float_linear"),this.extFloatBlend=s("EXT_float_blend"),this.extTextureFilterAnisotropic=s("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=s("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=s("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=s("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=s("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=s("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=s("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=s("KHR_parallel_shader_compile"),this.extColorBufferHalfFloat=s("EXT_color_buffer_half_float"),this.supportsInstancing=!!this.extInstancing}initializeCapabilities(){const t=this.gl;let e;this.maxPrecision=this.precision=this.getPrecision();const s=t.getContextAttributes();this.supportsMsaa=s.antialias,this.supportsStencil=s.stencil,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=t.getParameter(t.MAX_DRAW_BUFFERS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE)):(e=this.extDrawBuffers,this.maxDrawBuffers=e?t.getParameter(e.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=e?t.getParameter(e.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"",e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,this.samples=t.getParameter(t.SAMPLES),this.maxSamples=this.webgl2?t.getParameter(t.MAX_SAMPLES):1,this.supportsAreaLights=this.webgl2||!S.android,this.maxTextures<=8&&(this.supportsAreaLights=!1)}initializeRenderState(){const t=this.gl;this.blending=!1,t.disable(t.BLEND),this.blendSrc=1,this.blendDst=0,this.blendSrcAlpha=1,this.blendDstAlpha=0,this.separateAlphaBlend=!1,this.blendEquation=0,this.blendAlphaEquation=0,this.separateAlphaEquation=!1,t.blendFunc(t.ONE,t.ZERO),t.blendEquation(t.FUNC_ADD),this.writeRed=!0,this.writeGreen=!0,this.writeBlue=!0,this.writeAlpha=!0,t.colorMask(!0,!0,!0,!0),this.cullMode=1,t.enable(t.CULL_FACE),t.cullFace(t.BACK),this.depthTest=!0,t.enable(t.DEPTH_TEST),this.depthFunc=3,t.depthFunc(t.LEQUAL),this.depthWrite=!0,t.depthMask(!0),this.stencil=!1,t.disable(t.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,t.stencilFunc(t.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,t.disable(t.POLYGON_OFFSET_FILL),this.clearDepth=1,t.clearDepth(1),this.clearRed=0,this.clearBlue=0,this.clearGreen=0,this.clearAlpha=0,t.clearColor(0,0,0,0),this.clearStencil=0,t.clearStencil(0),this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.webgl2?t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST):this.extStandardDerivatives&&t.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,t.NICEST),t.enable(t.SCISSOR_TEST),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),this.unpackFlipY=!1,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_ALIGNMENT,1)}initializeContextCaches(){this.vertexShaderCache={},this.fragmentShaderCache={},this._vaoMap=new Map,this.boundVao=null,this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.renderTarget=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.textureUnits=[];for(let t=0;t<this.maxCombinedTextures;t++)this.textureUnits.push([null,null,null])}loseContext(){for(const t of this.shaders)t.loseContext();for(this.grabPass.destroy();this.textures.length>0;){const t=this.textures[0];this.destroyTexture(t),t.dirtyAll()}for(const t of this.buffers)t.loseContext();for(const t of this.targets)t.loseContext()}restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches();for(const t of this.shaders)this.compileAndLinkShader(t);for(const t of this.buffers)t.unlock();this.grabPass.create()}updateClientRect(){this.clientRect=this.canvas.getBoundingClientRect()}setViewport(t,e,s,i){this.vx===t&&this.vy===e&&this.vw===s&&this.vh===i||(this.gl.viewport(t,e,s,i),this.vx=t,this.vy=e,this.vw=s,this.vh=i)}setScissor(t,e,s,i){this.sx===t&&this.sy===e&&this.sw===s&&this.sh===i||(this.gl.scissor(t,e,s,i),this.sx=t,this.sy=e,this.sw=s,this.sh=i)}getProgramLibrary(){return this.programLib}setProgramLibrary(t){this.programLib=t}setFramebuffer(t){if(this.activeFramebuffer!==t){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t),this.activeFramebuffer=t}}_checkFbo(){const t=this.gl;switch(t.checkFramebufferStatus(t.FRAMEBUFFER)){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case t.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED");case t.FRAMEBUFFER_COMPLETE:}}copyRenderTarget(t,e,s,i){const n=this.gl;if(!this.webgl2&&i)return!1;if(s)if(e){if(!t._colorBuffer||!e._colorBuffer)return!1;if(t._colorBuffer._format!==e._colorBuffer._format)return!1}else if(!t._colorBuffer)return!1;if(i){if(!t._depthBuffer||!e._depthBuffer)return!1;if(t._depthBuffer._format!==e._depthBuffer._format)return!1}if(this.webgl2&&e){const a=this.renderTarget;this.renderTarget=e,this.updateBegin(),n.bindFramebuffer(n.READ_FRAMEBUFFER,t?t._glFrameBuffer:null),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,e._glFrameBuffer);const r=t?t.width:e.width,o=t?t.height:e.height;n.blitFramebuffer(0,0,r,o,0,0,r,o,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=a,n.bindFramebuffer(n.FRAMEBUFFER,a?a._glFrameBuffer:null)}else{const s=this.getCopyShader();this.constantTexSource.setValue(t._colorBuffer),Kt(this,e,s)}return!0}initRenderTarget(t){if(t._glFrameBuffer)return;const e=this.gl;t._glFrameBuffer=e.createFramebuffer(),this.setFramebuffer(t._glFrameBuffer);const s=t._colorBuffer;s&&(s._glTexture||(s._width=Math.min(s.width,this.maxRenderBufferSize),s._height=Math.min(s.height,this.maxRenderBufferSize),this.setTexture(s,0)),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,s._cubemap?e.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:e.TEXTURE_2D,s._glTexture,0));const i=t._depthBuffer;if(i&&this.webgl2)i._glTexture||(i._width=Math.min(i.width,this.maxRenderBufferSize),i._height=Math.min(i.height,this.maxRenderBufferSize),this.setTexture(i,0)),t._stencil?e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,i._cubemap?e.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:e.TEXTURE_2D,t._depthBuffer._glTexture,0):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,i._cubemap?e.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:e.TEXTURE_2D,t._depthBuffer._glTexture,0);else if(t._depth){t._samples>1&&this.webgl2||(t._glDepthBuffer||(t._glDepthBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,t._glDepthBuffer),t._stencil?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t._glDepthBuffer)):(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t._glDepthBuffer)),e.bindRenderbuffer(e.RENDERBUFFER,null))}this.webgl2&&t._samples>1&&(t._glResolveFrameBuffer=t._glFrameBuffer,t._glFrameBuffer=e.createFramebuffer(),this.setFramebuffer(t._glFrameBuffer),s&&(t._glMsaaColorBuffer||(t._glMsaaColorBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,t._glMsaaColorBuffer),e.renderbufferStorageMultisample(e.RENDERBUFFER,t._samples,s._glInternalFormat,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,t._glMsaaColorBuffer)),t._depth&&(t._glMsaaDepthBuffer||(t._glMsaaDepthBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,t._glMsaaDepthBuffer),t._stencil?(e.renderbufferStorageMultisample(e.RENDERBUFFER,t._samples,e.DEPTH24_STENCIL8,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t._glMsaaDepthBuffer)):(e.renderbufferStorageMultisample(e.RENDERBUFFER,t._samples,e.DEPTH_COMPONENT32F,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t._glMsaaDepthBuffer)))),this.targets.push(t)}getCopyShader(){if(!this._copyShader){const t=Zt.fullscreenQuadVS,e=Zt.outputTex2DPS;this._copyShader=he(this,t,e,"outputTex2D")}return this._copyShader}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let e=0;e<this.textureUnits.length;++e)for(let t=0;t<3;++t)this.textureUnits[e][t]=null;const t=this.renderTarget;t?t._glFrameBuffer?this.setFramebuffer(t._glFrameBuffer):this.initRenderTarget(t):this.setFramebuffer(this.defaultFramebuffer)}updateEnd(){const t=this.gl;this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null));const e=this.renderTarget;if(e){const s=e._colorBuffer;s&&s._glTexture&&s.mipmaps&&(s.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(s),t.generateMipmap(s._glTarget)),this.webgl2&&e._samples>1&&e.autoResolve&&e.resolve()}}initializeTexture(t){const e=this.gl;let s;switch(t._glTexture=e.createTexture(),t._glTarget=t._cubemap?e.TEXTURE_CUBE_MAP:t._volume?e.TEXTURE_3D:e.TEXTURE_2D,t._format){case 0:t._glFormat=e.ALPHA,t._glInternalFormat=e.ALPHA,t._glPixelType=e.UNSIGNED_BYTE;break;case 1:t._glFormat=e.LUMINANCE,t._glInternalFormat=e.LUMINANCE,t._glPixelType=e.UNSIGNED_BYTE;break;case 2:t._glFormat=e.LUMINANCE_ALPHA,t._glInternalFormat=e.LUMINANCE_ALPHA,t._glPixelType=e.UNSIGNED_BYTE;break;case 3:t._glFormat=e.RGB,t._glInternalFormat=e.RGB,t._glPixelType=e.UNSIGNED_SHORT_5_6_5;break;case 4:t._glFormat=e.RGBA,t._glInternalFormat=e.RGBA,t._glPixelType=e.UNSIGNED_SHORT_5_5_5_1;break;case 5:t._glFormat=e.RGBA,t._glInternalFormat=e.RGBA,t._glPixelType=e.UNSIGNED_SHORT_4_4_4_4;break;case 6:t._glFormat=e.RGB,t._glInternalFormat=this.webgl2?e.RGB8:e.RGB,t._glPixelType=e.UNSIGNED_BYTE;break;case 7:t._glFormat=e.RGBA,t._glInternalFormat=this.webgl2?e.RGBA8:e.RGBA,t._glPixelType=e.UNSIGNED_BYTE;break;case 8:s=this.extCompressedTextureS3TC,t._glFormat=e.RGB,t._glInternalFormat=s.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:s=this.extCompressedTextureS3TC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case nt:s=this.extCompressedTextureS3TC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:s=this.extCompressedTextureETC1,t._glFormat=e.RGB,t._glInternalFormat=s.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:s=this.extCompressedTexturePVRTC,t._glFormat=e.RGB,t._glInternalFormat=s.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:s=this.extCompressedTexturePVRTC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:s=this.extCompressedTexturePVRTC,t._glFormat=e.RGB,t._glInternalFormat=s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:s=this.extCompressedTexturePVRTC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:s=this.extCompressedTextureETC,t._glFormat=e.RGB,t._glInternalFormat=s.COMPRESSED_RGB8_ETC2;break;case 23:s=this.extCompressedTextureETC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:s=this.extCompressedTextureASTC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:s=this.extCompressedTextureATC,t._glFormat=e.RGB,t._glInternalFormat=s.COMPRESSED_RGB_ATC_WEBGL;break;case 30:s=this.extCompressedTextureATC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 11:s=this.extTextureHalfFloat,t._glFormat=e.RGB,this.webgl2?(t._glInternalFormat=e.RGB16F,t._glPixelType=e.HALF_FLOAT):(t._glInternalFormat=e.RGB,t._glPixelType=s.HALF_FLOAT_OES);break;case at:s=this.extTextureHalfFloat,t._glFormat=e.RGBA,this.webgl2?(t._glInternalFormat=e.RGBA16F,t._glPixelType=e.HALF_FLOAT):(t._glInternalFormat=e.RGBA,t._glPixelType=s.HALF_FLOAT_OES);break;case 13:t._glFormat=e.RGB,this.webgl2?t._glInternalFormat=e.RGB32F:t._glInternalFormat=e.RGB,t._glPixelType=e.FLOAT;break;case rt:t._glFormat=e.RGBA,this.webgl2?t._glInternalFormat=e.RGBA32F:t._glInternalFormat=e.RGBA,t._glPixelType=e.FLOAT;break;case 15:t._glFormat=e.RED,t._glInternalFormat=e.R32F,t._glPixelType=e.FLOAT;break;case 16:this.webgl2?(t._glFormat=e.DEPTH_COMPONENT,t._glInternalFormat=e.DEPTH_COMPONENT32F,t._glPixelType=e.FLOAT):(t._glFormat=e.DEPTH_COMPONENT,t._glInternalFormat=e.DEPTH_COMPONENT,t._glPixelType=e.UNSIGNED_SHORT);break;case 17:t._glFormat=e.DEPTH_STENCIL,t._glInternalFormat=e.DEPTH24_STENCIL8,t._glPixelType=e.UNSIGNED_INT_24_8;break;case 18:t._glFormat=e.RGB,t._glInternalFormat=e.R11F_G11F_B10F,t._glPixelType=e.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:t._glFormat=e.RGB,t._glInternalFormat=e.SRGB8,t._glPixelType=e.UNSIGNED_BYTE;break;case 20:t._glFormat=e.RGBA,t._glInternalFormat=e.SRGB8_ALPHA8,t._glPixelType=e.UNSIGNED_BYTE}this.textures.push(t)}destroyTexture(t){if(t._glTexture){const e=this.textures.indexOf(t);-1!==e&&this.textures.splice(e,1),this.scope.removeValue(t);for(let s=0;s<this.textureUnits.length;s++){const e=this.textureUnits[s];for(let s=0;s<e.length;s++)e[s]===t._glTexture&&(e[s]=null)}this.gl.deleteTexture(t._glTexture),delete t._glTexture,delete t._glTarget,delete t._glFormat,delete t._glInternalFormat,delete t._glPixelType,this._vram.tex-=t._gpuSize}}setUnpackFlipY(t){if(this.unpackFlipY!==t){this.unpackFlipY=t;const e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t)}}setUnpackPremultiplyAlpha(t){if(this.unpackPremultiplyAlpha!==t){this.unpackPremultiplyAlpha=t;const e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t)}}_isBrowserInterface(t){return"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap}uploadTexture(t){const e=this.gl;if(!t._needsUpload&&(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot))return;let s,i,n=0;const a=Math.log2(Math.max(t._width,t._height))+1;for(;t._levels[n]||0===n;)if(t._needsUpload||0!==n){if(n&&(!t._needsMipmapsUpload||!t._mipmaps))break;if(s=t._levels[n],1===n&&!t._compressed&&t._levels.length<a&&(e.generateMipmap(t._glTarget),t._mipmapsUploaded=!0),t._cubemap){let a;if(this._isBrowserInterface(s[0]))for(a=0;a<6;a++){if(!t._levelsUpdated[0][a])continue;let i=s[a];i instanceof HTMLImageElement&&(i.width>this.maxCubeMapSize||i.height>this.maxCubeMapSize)&&(i=zs(i,this.maxCubeMapSize),0===n&&(t._width=i.width,t._height=i.height)),this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,n,t._glInternalFormat,t._glFormat,t._glPixelType,i)}else for(i=1/Math.pow(2,n),a=0;a<6;a++){if(!t._levelsUpdated[0][a])continue;const r=s[a];t._compressed?e.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,n,t._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),0,r):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,n,t._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),0,t._glFormat,t._glPixelType,r))}}else t._volume?(i=1/Math.pow(2,n),t._compressed?e.compressedTexImage3D(e.TEXTURE_3D,n,t._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),Math.max(t._depth*i,1),0,s):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage3D(e.TEXTURE_3D,n,t._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),Math.max(t._depth*i,1),0,t._glFormat,t._glPixelType,s))):(this._isBrowserInterface(s)?(s instanceof HTMLImageElement&&(s.width>this.maxTextureSize||s.height>this.maxTextureSize)&&(s=zs(s,this.maxTextureSize),0===n&&(t._width=s.width,t._height=s.height)),this.setUnpackFlipY(t._flipY),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_2D,n,t._glInternalFormat,t._glFormat,t._glPixelType,s)):(i=1/Math.pow(2,n),t._compressed?e.compressedTexImage2D(e.TEXTURE_2D,n,t._glInternalFormat,Math.max(Math.floor(t._width*i),1),Math.max(Math.floor(t._height*i),1),0,s):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_2D,n,t._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),0,t._glFormat,t._glPixelType,s))),t._mipmapsUploaded=0!==n);n++}else n++;if(t._needsUpload)if(t._cubemap)for(let r=0;r<6;r++)t._levelsUpdated[0][r]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&t._mipmaps&&t._needsMipmapsUpload&&(t.pot||this.webgl2)&&1===t._levels.length&&(e.generateMipmap(t._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&(this._vram.tex-=t._gpuSize),t._gpuSize=t.gpuSize,this._vram.tex+=t._gpuSize}activeTexture(t){this.textureUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.textureUnit=t)}bindTexture(t){const e=t._glTarget,s=t._glTexture,i=this.textureUnit,n=this.targetToSlot[e];this.textureUnits[i][n]!==s&&(this.gl.bindTexture(e,s),this.textureUnits[i][n]=s)}bindTextureOnUnit(t,e){const s=t._glTarget,i=t._glTexture,n=this.targetToSlot[s];this.textureUnits[e][n]!==i&&(this.activeTexture(e),this.gl.bindTexture(s,i),this.textureUnits[e][n]=i)}setTextureParameters(t){const e=this.gl,s=t._parameterFlags,i=t._glTarget;if(1&s){let s=t._minFilter;(!t.pot&&!this.webgl2||!t._mipmaps||t._compressed&&1===t._levels.length)&&(2===s||3===s?s=0:4!==s&&5!==s||(s=1)),e.texParameteri(i,e.TEXTURE_MIN_FILTER,this.glFilter[s])}if(2&s&&e.texParameteri(i,e.TEXTURE_MAG_FILTER,this.glFilter[t._magFilter]),4&s&&(this.webgl2?e.texParameteri(i,e.TEXTURE_WRAP_S,this.glAddress[t._addressU]):e.texParameteri(i,e.TEXTURE_WRAP_S,this.glAddress[t.pot?t._addressU:1])),8&s&&(this.webgl2?e.texParameteri(i,e.TEXTURE_WRAP_T,this.glAddress[t._addressV]):e.texParameteri(i,e.TEXTURE_WRAP_T,this.glAddress[t.pot?t._addressV:1])),16&s&&this.webgl2&&e.texParameteri(i,e.TEXTURE_WRAP_R,this.glAddress[t._addressW]),32&s&&this.webgl2&&e.texParameteri(i,e.TEXTURE_COMPARE_MODE,t._compareOnRead?e.COMPARE_REF_TO_TEXTURE:e.NONE),64&s&&this.webgl2&&e.texParameteri(i,e.TEXTURE_COMPARE_FUNC,this.glComparison[t._compareFunc]),128&s){const s=this.extTextureFilterAnisotropic;s&&e.texParameterf(i,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(t._anisotropy),this.maxAnisotropy)))}}setTexture(t,e){if(t._glTexture||this.initializeTexture(t),t._parameterFlags>0||t._needsUpload||t._needsMipmapsUpload||t===this.grabPass.texture){this.activeTexture(e),this.bindTexture(t),t._parameterFlags&&(this.setTextureParameters(t),t._parameterFlags=0);t===this.grabPass.texture&&this.grabPass.prepareTexture()||!t._needsUpload&&!t._needsMipmapsUpload||(this.uploadTexture(t),t._needsUpload=!1,t._needsMipmapsUpload=!1)}else this.bindTextureOnUnit(t,e)}createVertexArray(t){let e,s;const i=t.length>1;if(i){e="";for(let s=0;s<t.length;s++){const i=t[s];e+=i.id+i.format.renderingingHash}s=this._vaoMap.get(e)}if(!s){const n=this.gl;s=n.createVertexArray(),n.bindVertexArray(s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);for(let e=0;e<t.length;e++){const s=t[e];n.bindBuffer(n.ARRAY_BUFFER,s.bufferId);const i=s.format.elements;for(let t=0;t<i.length;t++){const e=i[t],a=jt[e.name];n.vertexAttribPointer(a,e.numComponents,this.glType[e.dataType],e.normalize,e.stride,e.offset),n.enableVertexAttribArray(a),s.instancing&&n.vertexAttribDivisor(a,1)}}n.bindVertexArray(null),n.bindBuffer(n.ARRAY_BUFFER,null),i&&this._vaoMap.set(e,s)}return s}setBuffers(){const t=this.gl;let e;if(1===this.vertexBuffers.length){const t=this.vertexBuffers[0];t._vao||(t._vao=this.createVertexArray(this.vertexBuffers)),e=t._vao}else e=this.createVertexArray(this.vertexBuffers);this.boundVao!==e&&(this.boundVao=e,t.bindVertexArray(e)),this.vertexBuffers.length=0;const s=this.indexBuffer?this.indexBuffer.bufferId:null;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s)}draw(t,e,s){const i=this.gl;let n,a,r,o,l,h,c,d;const u=this.shader;if(!u)return;const p=u.samplers,m=u.uniforms;s||this.setBuffers();let _=0;for(let y=0,v=p.length;y<v;y++)if(n=p[y],a=n.scopeId.value,a)if(a instanceof Texture)r=a,this.setTexture(r,_),n.slot!==_&&(i.uniform1i(n.locationId,_),n.slot=_),_++;else{n.array.length=0,o=a.length;for(let t=0;t<o;t++)r=a[t],this.setTexture(r,_),n.array[t]=_,_++;i.uniform1iv(n.locationId,n.array)}for(let y=0,v=m.length;y<v;y++)l=m[y],h=l.scopeId,c=l.version,d=h.versionObject.version,c.globalId===d.globalId&&c.revision===d.revision||(c.globalId=d.globalId,c.revision=d.revision,null!==h.value&&this.commitFunction[l.dataType](l,h.value));this.webgl2&&this.transformFeedbackBuffer&&(i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),i.beginTransformFeedback(i.POINTS));const f=this.glPrimitive[t.type],g=t.count;if(t.indexed){const s=this.indexBuffer,n=s.glFormat,a=t.base*s.bytesPerIndex;e>0?i.drawElementsInstanced(f,g,n,a,e):i.drawElements(f,g,n,a)}else{const s=t.base;e>0?i.drawArraysInstanced(f,s,g,e):i.drawArrays(f,s,g)}this.webgl2&&this.transformFeedbackBuffer&&(i.endTransformFeedback(),i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}clear(t){const e=this.defaultClearOptions,s=null==(t=t||e).flags?e.flags:t.flags;if(0!==s){const i=this.gl;if(1&s){const s=null==t.color?e.color:t.color;this.setClearColor(s[0],s[1],s[2],s[3])}if(2&s){const s=null==t.depth?e.depth:t.depth;this.setClearDepth(s),this.depthWrite||i.depthMask(!0)}if(4&s){const s=null==t.stencil?e.stencil:t.stencil;this.setClearStencil(s)}i.clear(this.glClearFlag[s]),2&s&&(this.depthWrite||i.depthMask(!1))}}readPixels(t,e,s,i,n){const a=this.gl;a.readPixels(t,e,s,i,a.RGBA,a.UNSIGNED_BYTE,n)}setClearDepth(t){t!==this.clearDepth&&(this.gl.clearDepth(t),this.clearDepth=t)}setClearColor(t,e,s,i){t===this.clearRed&&e===this.clearGreen&&s===this.clearBlue&&i===this.clearAlpha||(this.gl.clearColor(t,e,s,i),this.clearRed=t,this.clearGreen=e,this.clearBlue=s,this.clearAlpha=i)}setClearStencil(t){t!==this.clearStencil&&(this.gl.clearStencil(t),this.clearStencil=t)}setRenderTarget(t){this.renderTarget=t}getRenderTarget(){return this.renderTarget}getDepthTest(){return this.depthTest}setDepthTest(t){if(this.depthTest!==t){const e=this.gl;t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this.depthTest=t}}setDepthFunc(t){this.depthFunc!==t&&(this.gl.depthFunc(this.glComparison[t]),this.depthFunc=t)}getDepthWrite(){return this.depthWrite}setDepthWrite(t){this.depthWrite!==t&&(this.gl.depthMask(t),this.depthWrite=t)}setColorWrite(t,e,s,i){this.writeRed===t&&this.writeGreen===e&&this.writeBlue===s&&this.writeAlpha===i||(this.gl.colorMask(t,e,s,i),this.writeRed=t,this.writeGreen=e,this.writeBlue=s,this.writeAlpha=i)}setAlphaToCoverage(t){this.webgl2&&this.alphaToCoverage!==t&&(this.alphaToCoverage=t,t?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(t){if(this.transformFeedbackBuffer!==t&&(this.transformFeedbackBuffer=t,this.webgl2)){const e=this.gl;t?(this.feedback||(this.feedback=e.createTransformFeedback()),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,this.feedback)):e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null)}}setRaster(t){this.raster!==t&&(this.raster=t,this.webgl2&&(t?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))}setDepthBias(t){this.depthBiasEnabled!==t&&(this.depthBiasEnabled=t,t?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))}setDepthBiasValues(t,e){this.gl.polygonOffset(e,t)}getBlending(){return this.blending}setBlending(t){if(this.blending!==t){const e=this.gl;t?e.enable(e.BLEND):e.disable(e.BLEND),this.blending=t}}setStencilTest(t){if(this.stencil!==t){const e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.stencil=t}}setStencilFunc(t,e,s){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==s||this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==s){this.gl.stencilFunc(this.glComparison[t],e,s),this.stencilFuncFront=this.stencilFuncBack=t,this.stencilRefFront=this.stencilRefBack=e,this.stencilMaskFront=this.stencilMaskBack=s}}setStencilFuncFront(t,e,s){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==s){const i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[t],e,s),this.stencilFuncFront=t,this.stencilRefFront=e,this.stencilMaskFront=s}}setStencilFuncBack(t,e,s){if(this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==s){const i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[t],e,s),this.stencilFuncBack=t,this.stencilRefBack=e,this.stencilMaskBack=s}}setStencilOperation(t,e,s,i){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===s&&this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===s||(this.gl.stencilOp(this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=t,this.stencilZfailFront=this.stencilZfailBack=e,this.stencilZpassFront=this.stencilZpassBack=s),this.stencilWriteMaskFront===i&&this.stencilWriteMaskBack===i||(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i)}setStencilOperationFront(t,e,s,i){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===s||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=t,this.stencilZfailFront=e,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i)}setStencilOperationBack(t,e,s,i){this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===s||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailBack=t,this.stencilZfailBack=e,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i)}setBlendFunction(t,e){(this.blendSrc!==t||this.blendDst!==e||this.separateAlphaBlend)&&(this.gl.blendFunc(this.glBlendFunction[t],this.glBlendFunction[e]),this.blendSrc=t,this.blendDst=e,this.separateAlphaBlend=!1)}setBlendFunctionSeparate(t,e,s,i){this.blendSrc===t&&this.blendDst===e&&this.blendSrcAlpha===s&&this.blendDstAlpha===i&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[t],this.glBlendFunction[e],this.glBlendFunction[s],this.glBlendFunction[i]),this.blendSrc=t,this.blendDst=e,this.blendSrcAlpha=s,this.blendDstAlpha=i,this.separateAlphaBlend=!0)}setBlendEquation(t){(this.blendEquation!==t||this.separateAlphaEquation)&&(this.gl.blendEquation(this.glBlendEquation[t]),this.blendEquation=t,this.separateAlphaEquation=!1)}setBlendEquationSeparate(t,e){this.blendEquation===t&&this.blendAlphaEquation===e&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[t],this.glBlendEquation[e]),this.blendEquation=t,this.blendAlphaEquation=e,this.separateAlphaEquation=!0)}setCullMode(t){if(this.cullMode!==t){if(0===t)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);const e=this.glCull[t];this.cullFace!==e&&(this.gl.cullFace(e),this.cullFace=e)}this.cullMode=t}}getCullMode(){return this.cullMode}setIndexBuffer(t){this.indexBuffer=t}setVertexBuffer(t){t&&this.vertexBuffers.push(t)}compileShaderSource(t,e){const s=this.gl;let i=e?this.vertexShaderCache[t]:this.fragmentShaderCache[t];return i||(i=s.createShader(e?s.VERTEX_SHADER:s.FRAGMENT_SHADER),s.shaderSource(i,t),s.compileShader(i),e?this.vertexShaderCache[t]=i:this.fragmentShaderCache[t]=i),i}compileAndLinkShader(t){const e=t.definition,s=this.compileShaderSource(e.vshader,!0),i=this.compileShaderSource(e.fshader,!1),n=this.gl,a=n.createProgram();n.attachShader(a,s),n.attachShader(a,i);const r=e.attributes;if(this.webgl2&&e.useTransformFeedback){const t=[];for(const e in r)r.hasOwnProperty(e)&&t.push("out_"+e);n.transformFeedbackVaryings(a,t,n.INTERLEAVED_ATTRIBS)}const o={};for(const l in r)if(r.hasOwnProperty(l)){const t=r[l],e=jt[t];o[e]=l,n.bindAttribLocation(a,e,l)}n.linkProgram(a),t._glVertexShader=s,t._glFragmentShader=i,t._glProgram=a}createShader(t){this.compileAndLinkShader(t),this.shaders.push(t)}destroyShader(t){const e=this.shaders.indexOf(t);-1!==e&&this.shaders.splice(e,1),t._glProgram&&(this.gl.deleteProgram(t._glProgram),t._glProgram=null,this.removeShaderFromCache(t))}_processError(t,e){if(!t)return"";const s=t.split("\n"),i={};let n="",a=0,r=s.length;if(e&&e.startsWith("ERROR:")){const t=e.match(/^ERROR:\s([0-9]+):([0-9]+):\s*(.+)/);t&&(i.message=t[3],i.line=parseInt(t[2],10),a=Math.max(0,i.line-6),r=Math.min(s.length,i.line+5))}for(let o=a;o<r;o++)n+=o+1+":\t"+s[o]+"\n";return i.source=t,[n,i]}_isShaderCompiled(t,e,s,i){const n=this.gl;if(!n.getShaderParameter(e,n.COMPILE_STATUS)){const t=n.getShaderInfoLog(e),[a,r]=this._processError(s,t),o=`Failed to compile ${i} shader:\n\n${t}\n${a}`;return console.error(o),!1}return!0}postLink(t){const e=this.gl,s=t._glProgram,i=t.definition;if(!this._isShaderCompiled(t,t._glVertexShader,i.vshader,"vertex"))return!1;if(!this._isShaderCompiled(t,t._glFragmentShader,i.fshader,"fragment"))return!1;if(!e.getProgramParameter(s,e.LINK_STATUS)){const t="Failed to link shader program. Error: "+e.getProgramInfoLog(s);return console.error(t),!1}let n,a,r,o;n=0;const l=e.getProgramParameter(s,e.ACTIVE_ATTRIBUTES);for(;n<l;)a=e.getActiveAttrib(s,n++),r=e.getAttribLocation(s,a.name),void 0===i.attributes[a.name]&&console.error(`Vertex shader attribute "${a.name}" is not mapped to a semantic in shader definition.`),o=new ShaderInput(this,i.attributes[a.name],this.pcUniformType[a.type],r),t.attributes.push(o);n=0;const h=e.getProgramParameter(s,e.ACTIVE_UNIFORMS);for(;n<h;)a=e.getActiveUniform(s,n++),r=e.getUniformLocation(s,a.name),o=new ShaderInput(this,a.name,this.pcUniformType[a.type],r),a.type===e.SAMPLER_2D||a.type===e.SAMPLER_CUBE||this.webgl2&&(a.type===e.SAMPLER_2D_SHADOW||a.type===e.SAMPLER_CUBE_SHADOW||a.type===e.SAMPLER_3D)?t.samplers.push(o):t.uniforms.push(o);return t.ready=!0,!0}setShader(t){if(t!==this.shader){if(!t.ready&&!this.postLink(t))return!1;this.shader=t,this.gl.useProgram(t._glProgram),this.attributesInvalidated=!0}return!0}getHdrFormat(){return this.textureHalfFloatRenderable?at:this.textureFloatRenderable?rt:7}getBoneLimit(){return this.boneLimit}setBoneLimit(t){this.boneLimit=t}resizeCanvas(t,e){this._width=t,this._height=e;const s=Math.min(this._maxPixelRatio,S.browser?window.devicePixelRatio:1);t=Math.floor(t*s),e=Math.floor(e*s),this.canvas.width===t&&this.canvas.height===e||(this.canvas.width=t,this.canvas.height=e,this.fire(Bs,t,e))}setResolution(t,e){this._width=t,this._height=e,this.canvas.width=t,this.canvas.height=e,this.fire(Bs,t,e)}clearShaderCache(){const t=this.gl;for(const e in this.fragmentShaderCache)t.deleteShader(this.fragmentShaderCache[e]),delete this.fragmentShaderCache[e];for(const e in this.vertexShaderCache)t.deleteShader(this.vertexShaderCache[e]),delete this.vertexShaderCache[e];this.programLib.clearCache()}clearVertexArrayObjectCache(){const t=this.gl;this._vaoMap.forEach(((e,s,i)=>{t.deleteVertexArray(e)})),this._vaoMap.clear()}removeShaderFromCache(t){this.programLib.removeFromCache(t)}get width(){return this.gl.drawingBufferWidth||this.canvas.width}get height(){return this.gl.drawingBufferHeight||this.canvas.height}set fullscreen(t){if(t){this.gl.canvas.requestFullscreen()}else document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}set enableAutoInstancing(t){this._enableAutoInstancing=t&&this.extInstancing}get enableAutoInstancing(){return this._enableAutoInstancing}set maxPixelRatio(t){this._maxPixelRatio=t,this.resizeCanvas(this._width,this._height)}get maxPixelRatio(){return this._maxPixelRatio}get textureFloatHighPrecision(){return void 0===this._textureFloatHighPrecision&&(this._textureFloatHighPrecision=function(t){if(!t.textureFloatRenderable)return!1;const e=he(t,Zt.fullscreenQuadVS,Zt.precisionTestPS,"ptest1"),s=he(t,Zt.fullscreenQuadVS,Zt.precisionTest2PS,"ptest2"),i={format:rt,width:1,height:1,mipmaps:!1,minFilter:0,magFilter:0},n=new Texture(t,i);n.name="testFHP";const a=new RenderTarget({colorBuffer:n,depth:!1});Kt(t,a,e),i.format=7;const r=new Texture(t,i);r.name="testFHP";const o=new RenderTarget({colorBuffer:r,depth:!1});t.constantTexSource.setValue(n),Kt(t,o,s);const l=t.activeFramebuffer;t.setFramebuffer(o._glFrameBuffer);const h=new Uint8Array(4);t.readPixels(0,0,1,1,h),t.setFramebuffer(l);const c=h[0]/255/16777216+h[1]/255/65536+h[2]/255/256+h[3]/255;return n.destroy(),a.destroy(),r.destroy(),o.destroy(),0===c}(this)),this._textureFloatHighPrecision}get textureHalfFloatUpdatable(){return void 0===this._textureHalfFloatUpdatable&&(this.webgl2?this._textureHalfFloatUpdatable=!0:this._textureHalfFloatUpdatable=function(t,e){let s=!0;const i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const n=new Uint16Array(16);return t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,n),t.getError()!==t.NO_ERROR&&(s=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(i),s}(this.gl,this.extTextureHalfFloat.HALF_FLOAT_OES)),this._textureHalfFloatUpdatable}}const Ns={depth:!0,face:0};class RenderTarget{constructor(t){var e,s;const i=arguments[1],n=arguments[2];if(t instanceof GraphicsDevice?(this._colorBuffer=i,t=n):this._colorBuffer=t.colorBuffer,this._colorBuffer&&(this._colorBuffer._isRenderTarget=!0),this._glFrameBuffer=null,this._glDepthBuffer=null,t=void 0!==t?t:Ns,this._depthBuffer=t.depthBuffer,this._face=void 0!==t.face?t.face:0,this._depthBuffer){const t=this._depthBuffer._format;16===t?(this._depth=!0,this._stencil=!1):17===t?(this._depth=!0,this._stencil=!0):(this._depth=!1,this._stencil=!1)}else this._depth=void 0===t.depth||t.depth,this._stencil=void 0!==t.stencil&&t.stencil;var a,r;(this._device=(null==(e=this._colorBuffer)?void 0:e.device)||(null==(s=this._depthBuffer)?void 0:s.device),this._samples=void 0!==t.samples?Math.min(t.samples,this._device.maxSamples):1,this.autoResolve=void 0===t.autoResolve||t.autoResolve,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null,this.name=t.name,this.name)||(this.name=null==(a=this._colorBuffer)?void 0:a.name);this.name||(this.name=null==(r=this._depthBuffer)?void 0:r.name);this.name||(this.name="Untitled"),this.flipY=!!t.flipY}destroy(){const t=this._device;if(t){const e=t.targets.indexOf(this);-1!==e&&t.targets.splice(e,1),this.destroyFrameBuffers()}}destroyFrameBuffers(){const t=this._device;if(t){const e=t.gl;this._glFrameBuffer&&(e.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(e.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(e.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffer&&(e.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null),this._glMsaaDepthBuffer&&(e.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}}destroyTextureBuffers(){this._depthBuffer&&(this._depthBuffer.destroy(),this._depthBuffer=null),this._colorBuffer&&(this._colorBuffer.destroy(),this._colorBuffer=null)}loseContext(){this._glFrameBuffer=void 0,this._glDepthBuffer=void 0,this._glResolveFrameBuffer=void 0,this._glMsaaColorBuffer=void 0,this._glMsaaDepthBuffer=void 0}resolve(t=!0,e=!!this._depthBuffer){if(!this._device)return;if(!this._device.webgl2)return;const s=this._device.gl;s.bindFramebuffer(s.READ_FRAMEBUFFER,this._glFrameBuffer),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer),s.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(t?s.COLOR_BUFFER_BIT:0)|(e?s.DEPTH_BUFFER_BIT:0),s.NEAREST),s.bindFramebuffer(s.FRAMEBUFFER,this._glFrameBuffer)}copy(t,e,s){if(!this._device){if(!t._device)return!1;this._device=t._device}return this._device.copyRenderTarget(t,this,e,s)}get colorBuffer(){return this._colorBuffer}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get width(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}get height(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}}class IndexBuffer{constructor(t,e,s,i=0,n){this.device=t,this.format=e,this.numIndices=s,this.usage=i;const a=this.device.gl;let r;0===e?(r=1,this.glFormat=a.UNSIGNED_BYTE):1===e?(r=2,this.glFormat=a.UNSIGNED_SHORT):2===e&&(r=4,this.glFormat=a.UNSIGNED_INT),this.bytesPerIndex=r,this.numBytes=this.numIndices*r,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),t._vram.ib+=this.numBytes,this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);if(-1!==e&&t.buffers.splice(e,1),this.bufferId){this.device.gl.deleteBuffer(this.bufferId),this.device._vram.ib-=this.storage.byteLength,this.bufferId=null,this.device.indexBuffer===this&&(this.device.indexBuffer=null)}}loseContext(){this.bufferId=void 0}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){const t=this.device.gl;let e;switch(this.bufferId||(this.bufferId=t.createBuffer()),this.usage){case 0:e=t.STATIC_DRAW;break;case 1:e=t.DYNAMIC_DRAW;break;case 2:e=t.STREAM_DRAW;break;case 3:e=this.device.webgl2?t.DYNAMIC_COPY:t.STATIC_DRAW}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.bufferId),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.storage,e)}setData(t){return t.byteLength===this.numBytes&&(this.storage=t,this.unlock(),!0)}_lockTypedArray(){const t=this.lock();return 2===this.format?new Uint32Array(t):1===this.format?new Uint16Array(t):new Uint8Array(t)}writeData(t,e){const s=this._lockTypedArray();if(t.length>e)if(ArrayBuffer.isView(t))t=t.subarray(0,e),s.set(t);else for(let i=0;i<e;i++)s[i]=t[i];else s.set(t);this.unlock()}readData(t){const e=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(t))t.set(e);else{t.length=0;for(let i=0;i<s;i++)t[i]=e[i]}return s}}function Hs(t){this.array[this.index]=t}function Ws(t,e){this.array[this.index]=t,this.array[this.index+1]=e}function Gs(t,e,s){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=s}function js(t,e,s,i){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=s,this.array[this.index+3]=i}function Xs(t,e,s){this.array[t]=e[s]}function qs(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1]}function $s(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1],this.array[t+2]=e[s+2]}function Ys(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1],this.array[t+2]=e[s+2],this.array[t+3]=e[s+3]}function Ks(t,e,s){e[s]=this.array[t]}function Zs(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1]}function Qs(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1],e[s+2]=this.array[t+2]}function Js(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1],e[s+2]=this.array[t+2],e[s+3]=this.array[t+3]}class VertexIteratorAccessor{constructor(t,e,s){switch(this.index=0,this.numComponents=e.numComponents,s.interleaved?this.array=new Ht[e.dataType](t,e.offset):this.array=new Ht[e.dataType](t,e.offset,s.vertexCount*e.numComponents),this.stride=e.stride/this.array.constructor.BYTES_PER_ELEMENT,e.numComponents){case 1:this.set=Hs,this.getToArray=Ks,this.setFromArray=Xs;break;case 2:this.set=Ws,this.getToArray=Zs,this.setFromArray=qs;break;case 3:this.set=Gs,this.getToArray=Qs,this.setFromArray=$s;break;case 4:this.set=js,this.getToArray=Js,this.setFromArray=Ys}}get(t){return this.array[this.index+t]}set(t,e,s,i){}getToArray(t,e,s){}setFromArray(t,e,s){}}class VertexIterator{constructor(t){this.vertexBuffer=t,this.vertexFormatSize=t.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const e=this.vertexBuffer.getFormat();for(let s=0;s<e.elements.length;s++){const t=e.elements[s];this.accessors[s]=new VertexIteratorAccessor(this.buffer,t,e),this.element[t.name]=this.accessors[s]}}next(t=1){let e=0;const s=this.accessors,i=this.accessors.length;for(;e<i;){const i=s[e++];i.index+=t*i.stride}}end(){this.vertexBuffer.unlock()}writeData(t,e,s){const i=this.element[t];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);const t=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let n=0;for(let a=0;a<s;a++)i.setFromArray(n,e,a*t),n+=i.stride}else if(e.length>s*t){const n=s*t;if(ArrayBuffer.isView(e))e=e.subarray(0,n),i.array.set(e);else for(let t=0;t<n;t++)i.array[t]=e[t]}else i.array.set(e)}}readData(t,e){const s=this.element[t];let i=0;if(s){let t;i=this.vertexBuffer.numVertices;const n=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(e)&&(e.length=0),s.index=0;let a=0;for(t=0;t<i;t++)s.getToArray(a,e,t*n),a+=s.stride}else if(ArrayBuffer.isView(e))e.set(s.array);else{e.length=0;const a=i*n;for(t=0;t<a;t++)e[t]=s.array[t]}}return i}}class RefCountedObject{constructor(){this._refCount=0}incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}}let ti;function ei(){return ti}function si(t){ti=t}let ii=0;class GeometryData{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(t,e){this.vertexCount||(this.vertexCount=t)}}GeometryData.DEFAULT_COMPONENTS_POSITION=3,GeometryData.DEFAULT_COMPONENTS_NORMAL=3,GeometryData.DEFAULT_COMPONENTS_UV=2,GeometryData.DEFAULT_COMPONENTS_COLORS=4;class GeometryVertexStream{constructor(t,e,s,i){this.data=t,this.componentCount=e,this.dataType=s,this.dataTypeNormalize=i}}class Mesh extends RefCountedObject{constructor(t){super(),this.id=ii++,this.device=t||ei().graphicsDevice,this.vertexBuffer=null,this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this.skin=null,this._morph=null,this._geometryData=null,this._aabb=new BoundingBox,this.boneAabb=null}set morph(t){t!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=t,t&&t.incRefCount())}get morph(){return this._morph}set aabb(t){this._aabb=t}get aabb(){return this._aabb}destroy(){const t=this.morph;t&&(this.morph=null,t.refCount<1&&t.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let e=0;e<this.indexBuffer.length;e++)this._destroyIndexBuffer(e);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(t){this.indexBuffer[t]&&(this.indexBuffer[t].destroy(),this.indexBuffer[t]=null)}_initBoneAabbs(t){let e,s,i,n,a;this.boneAabb=[],this.boneUsed=[];const r=[],o=[],l=this.boneUsed,h=this.skin.boneNames.length;let c,d,u;for(let v=0;v<h;v++)r[v]=new Vec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o[v]=new Vec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);const p=new VertexIterator(this.vertexBuffer),m=p.element.POSITION,_=p.element.BLENDWEIGHT,f=p.element.BLENDINDICES,g=this.vertexBuffer.numVertices;for(let v=0;v<g;v++){for(let h=0;h<4;h++){if(_.array[_.index+h]>0){const p=f.array[f.index+h];if(l[p]=!0,e=m.array[m.index],s=m.array[m.index+1],i=m.array[m.index+2],n=o[p],a=r[p],a.x>e&&(a.x=e),a.y>s&&(a.y=s),a.z>i&&(a.z=i),n.x<e&&(n.x=e),n.y<s&&(n.y=s),n.z<i&&(n.z=i),t){let r=c=e,o=d=s,l=u=i;for(let e=0;e<t.length;e++){const s=t[e],i=s.deltaPositions[3*v],n=s.deltaPositions[3*v+1],a=s.deltaPositions[3*v+2];i<0?r+=i:c+=i,n<0?o+=n:d+=n,a<0?l+=a:u+=a}a.x>r&&(a.x=r),a.y>o&&(a.y=o),a.z>l&&(a.z=l),n.x<c&&(n.x=c),n.y<d&&(n.y=d),n.z<u&&(n.z=u)}}}p.next()}const y=this.vertexBuffer.getFormat().elements.find((t=>t.name===ot));if(y&&y.normalize){const t=(()=>{switch(y.dataType){case 0:return t=>Math.max(t/127,-1);case 1:return t=>t/255;case 2:return t=>Math.max(t/32767,-1);case 3:return t=>t/65535;default:return t=>t}})();for(let e=0;e<h;e++)if(l[e]){const s=r[e],i=o[e];s.set(t(s.x),t(s.y),t(s.z)),i.set(t(i.x),t(i.y),t(i.z))}}for(let v=0;v<h;v++){const t=new BoundingBox;t.setMinMax(r[v],o[v]),this.boneAabb.push(t)}}_initGeometryData(){this._geometryData||(this._geometryData=new GeometryData,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(t,e,s=0,i=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=t?0:1,this._geometryData.indicesUsage=e?0:1}setVertexStream(t,e,s,i,n=6,a=!1){this._initGeometryData();const r=i||e.length/s;this._geometryData._changeVertexCount(r,t),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[t]=new GeometryVertexStream(e,s,n,a)}getVertexStream(t,e){let s=0,i=!1;if(this._geometryData){const n=this._geometryData.vertexStreamDictionary[t];n&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(e)?e.set(n.data):(e.length=0,e.push(n.data)))}if(!i&&this.vertexBuffer){s=new VertexIterator(this.vertexBuffer).readData(t,e)}return s}setPositions(t,e=GeometryData.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream(ot,t,e,s,6,!1)}setNormals(t,e=GeometryData.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream(lt,t,e,s,6,!1)}setUvs(t,e,s=GeometryData.DEFAULT_COMPONENTS_UV,i){this.setVertexStream(pt+t,e,s,i,6,!1)}setColors(t,e=GeometryData.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream(ut,t,e,s,6,!1)}setColors32(t,e){this.setVertexStream(ut,t,GeometryData.DEFAULT_COMPONENTS_COLORS,e,1,!0)}setIndices(t,e){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=t,this._geometryData.indexCount=e||t.length}getPositions(t){return this.getVertexStream(ot,t)}getNormals(t){return this.getVertexStream(lt,t)}getUvs(t,e){return this.getVertexStream(pt+t,e)}getColors(t){return this.getVertexStream(ut,t)}getIndices(t){let e=0;if(this._geometryData&&this._geometryData.indices){const s=this._geometryData.indices;e=this._geometryData.indexCount,ArrayBuffer.isView(t)?t.set(s):(t.length=0,t.push(s))}else if(this.indexBuffer.length>0&&this.indexBuffer[0]){e=this.indexBuffer[0].readData(t)}return e}update(t=4,e=!0){if(this._geometryData){if(e){const t=this._geometryData.vertexStreamDictionary.POSITION;t&&3===t.componentCount&&this._aabb.compute(t.data,this._geometryData.vertexCount)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=!0,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=t,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(t){const e=[];for(const s in this._geometryData.vertexStreamDictionary){const t=this._geometryData.vertexStreamDictionary[s];e.push({semantic:s,components:t.componentCount,type:t.dataType,normalize:t.dataTypeNormalize})}return new VertexFormat(this.device,e,t)}_updateVertexBuffer(){if(!this.vertexBuffer){const t=this._geometryData.maxVertices,e=this._buildVertexFormat(t);this.vertexBuffer=new VertexBuffer(this.device,e,t,this._geometryData.verticesUsage)}const t=new VertexIterator(this.vertexBuffer),e=this._geometryData.vertexCount;for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];t.writeData(s,i.data,e),delete this._geometryData.vertexStreamDictionary[s]}t.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){const t=this._geometryData.maxVertices>65535?2:1;this.indexBuffer[0]=new IndexBuffer(this.device,t,this._geometryData.maxIndices,this._geometryData.indicesUsage)}const t=this._geometryData.indices;if(t){this.indexBuffer[0].writeData(t,this._geometryData.indexCount),this._geometryData.indices=null}}prepareRenderState(t){1===t?this.generateWireframe():2===t&&(this.primitive[2]={type:0,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1)}generateWireframe(){this._destroyIndexBuffer(1);const t=[];let e;if(this.indexBuffer.length>0&&this.indexBuffer[0]){const s=[[0,1],[1,2],[2,0]],i=this.primitive[0].base,n=this.primitive[0].count,a=this.indexBuffer[0],r=new Gt[a.format](a.storage),o={};for(let e=i;e<i+n;e+=3)for(let i=0;i<3;i++){const n=r[e+s[i][0]],a=r[e+s[i][1]],l=n>a?a<<16|n:n<<16|a;void 0===o[l]&&(o[l]=0,t.push(n,a))}e=a.format}else{for(let e=0;e<this.vertexBuffer.numVertices;e+=3)t.push(e,e+1,e+1,e+2,e+2,e);e=t.length>65535?2:1}const s=new IndexBuffer(this.vertexBuffer.device,e,t.length);new Gt[s.format](s.storage).set(t),s.unlock(),this.primitive[1]={type:1,base:0,count:t.length,indexed:!0},this.indexBuffer[1]=s}}const ni=4/64,ai=.875,ri=[];function oi(t,e){const s=e.length/3,i=t.length/3,n=new Vec3,a=new Vec3,r=new Vec3,o=new Vec3,l=new Vec3,h=new Vec3,c=[];for(let d=0;d<t.length;d++)c[d]=0;for(let d=0;d<s;d++){const s=e[3*d],i=e[3*d+1],u=e[3*d+2];n.set(t[3*s],t[3*s+1],t[3*s+2]),a.set(t[3*i],t[3*i+1],t[3*i+2]),r.set(t[3*u],t[3*u+1],t[3*u+2]),o.sub2(a,n),l.sub2(r,n),h.cross(o,l).normalize(),c[3*s]+=h.x,c[3*s+1]+=h.y,c[3*s+2]+=h.z,c[3*i]+=h.x,c[3*i+1]+=h.y,c[3*i+2]+=h.z,c[3*u]+=h.x,c[3*u+1]+=h.y,c[3*u+2]+=h.z}for(let d=0;d<i;d++){const t=c[3*d],e=c[3*d+1],s=c[3*d+2],i=1/Math.sqrt(t*t+e*e+s*s);c[3*d]*=i,c[3*d+1]*=i,c[3*d+2]*=i}return c}function li(t,e,s,i){const n=i.length/3,a=t.length/3,r=new Vec3,o=new Vec3,l=new Vec3,h=new Vec2,c=new Vec2,d=new Vec2,u=new Vec3,p=new Vec3,m=new Float32Array(3*a),_=new Float32Array(3*a),f=[];for(let x=0;x<n;x++){const e=i[3*x],n=i[3*x+1],a=i[3*x+2];r.set(t[3*e],t[3*e+1],t[3*e+2]),o.set(t[3*n],t[3*n+1],t[3*n+2]),l.set(t[3*a],t[3*a+1],t[3*a+2]),h.set(s[2*e],s[2*e+1]),c.set(s[2*n],s[2*n+1]),d.set(s[2*a],s[2*a+1]);const f=o.x-r.x,g=l.x-r.x,y=o.y-r.y,v=l.y-r.y,b=o.z-r.z,S=l.z-r.z,w=c.x-h.x,C=d.x-h.x,T=c.y-h.y,M=d.y-h.y,A=w*M-C*T;if(0===A)u.set(0,1,0),p.set(1,0,0);else{const t=1/A;u.set((M*f-T*g)*t,(M*y-T*v)*t,(M*b-T*S)*t),p.set((w*g-C*f)*t,(w*v-C*y)*t,(w*S-C*b)*t)}m[3*e+0]+=u.x,m[3*e+1]+=u.y,m[3*e+2]+=u.z,m[3*n+0]+=u.x,m[3*n+1]+=u.y,m[3*n+2]+=u.z,m[3*a+0]+=u.x,m[3*a+1]+=u.y,m[3*a+2]+=u.z,_[3*e+0]+=p.x,_[3*e+1]+=p.y,_[3*e+2]+=p.z,_[3*n+0]+=p.x,_[3*n+1]+=p.y,_[3*n+2]+=p.z,_[3*a+0]+=p.x,_[3*a+1]+=p.y,_[3*a+2]+=p.z}const g=new Vec3,y=new Vec3,v=new Vec3,b=new Vec3;for(let x=0;x<a;x++){v.set(e[3*x],e[3*x+1],e[3*x+2]),g.set(m[3*x],m[3*x+1],m[3*x+2]),y.set(_[3*x],_[3*x+1],_[3*x+2]);const t=v.dot(g);b.copy(v).mulScalar(t),b.sub2(g,b).normalize(),f[4*x]=b.x,f[4*x+1]=b.y,f[4*x+2]=b.z,b.cross(v,g),f[4*x+3]=b.dot(y)<0?-1:1}return f}function hi(t,e,s){const i=new Mesh(t);return i.setPositions(e),s&&(s.normals&&i.setNormals(s.normals),s.tangents&&i.setVertexStream(ht,s.tangents,4),s.colors&&i.setColors32(s.colors),s.uvs&&i.setUvs(0,s.uvs),s.uvs1&&i.setUvs(1,s.uvs1),s.blendIndices&&i.setVertexStream(dt,s.blendIndices,4,s.blendIndices.length/4,1),s.blendWeights&&i.setVertexStream(ct,s.blendWeights,4),s.indices&&i.setIndices(s.indices)),i.update(),i}function ci(t,e,s,i,n,a){const r=new Vec3,o=new Vec3,l=new Vec3,h=new Vec3,c=new Vec3,d=new Vec3,u=[],p=[],m=[],_=[],f=[];let g;if(s>0)for(let y=0;y<=i;y++)for(let a=0;a<=n;a++){const g=a/n*2*Math.PI-Math.PI,v=Math.sin(g),b=Math.cos(g);c.set(v*t,-s/2,b*t),h.set(v*e,s/2,b*e),r.lerp(c,h,y/i),o.sub2(h,c).normalize(),d.set(b,0,-v),l.cross(d,o).normalize(),u.push(r.x,r.y,r.z),p.push(l.x,l.y,l.z);let x=a/n,S=y/i;m.push(x,1-S);const w=S;if(S=x,x=w,x=x*ai+ni,S=S*ai+ni,x/=3,_.push(x,1-S),y<i&&a<n){const t=y*(n+1)+a,e=y*(n+1)+(a+1),s=(y+1)*(n+1)+a,i=(y+1)*(n+1)+(a+1);f.push(t,e,s),f.push(e,i,s)}}if(a){const t=Math.floor(n/2),a=n,r=s/2;for(let s=0;s<=t;s++){const i=s*Math.PI*.5/t,n=Math.sin(i),o=Math.cos(i);for(let l=0;l<=a;l++){const i=2*l*Math.PI/a-Math.PI/2,h=Math.sin(i),c=Math.cos(i)*n,d=o,f=h*n;let g=1-l/a,y=1-s/t;u.push(c*e,d*e+r,f*e),p.push(c,d,f),m.push(g,1-y),g=g*ai+ni,y=y*ai+ni,g/=3,y/=3,g+=1/3,_.push(g,1-y)}}g=(i+1)*(n+1);for(let e=0;e<t;++e)for(let t=0;t<a;++t){const s=e*(a+1)+t,i=s+a+1;f.push(g+s+1,g+i,g+s),f.push(g+s+1,g+i+1,g+i)}for(let s=0;s<=t;s++){const i=.5*Math.PI+s*Math.PI*.5/t,n=Math.sin(i),o=Math.cos(i);for(let l=0;l<=a;l++){const i=2*l*Math.PI/a-Math.PI/2,h=Math.sin(i),c=Math.cos(i)*n,d=o,f=h*n;let g=1-l/a,y=1-s/t;u.push(c*e,d*e-r,f*e),p.push(c,d,f),m.push(g,1-y),g=g*ai+ni,y=y*ai+ni,g/=3,y/=3,g+=2/3,_.push(g,1-y)}}g=(i+1)*(n+1)+(a+1)*(t+1);for(let e=0;e<t;++e)for(let t=0;t<a;++t){const s=e*(a+1)+t,i=s+a+1;f.push(g+s+1,g+i,g+s),f.push(g+s+1,g+i+1,g+i)}}else{if(g=(i+1)*(n+1),t>0)for(let e=0;e<n;e++){const i=e/n*2*Math.PI,a=Math.sin(i),r=-s/2,o=Math.cos(i);let l=1-(a+1)/2,h=(o+1)/2;u.push(a*t,r,o*t),p.push(0,-1,0),m.push(l,1-h),l=l*ai+ni,h=h*ai+ni,l/=3,h/=3,l+=1/3,_.push(l,1-h),e>1&&f.push(g,g+e,g+e-1)}if(g+=n,e>0)for(let t=0;t<n;t++){const i=t/n*2*Math.PI,a=Math.sin(i),r=s/2,o=Math.cos(i);let l=1-(a+1)/2,h=(o+1)/2;u.push(a*e,r,o*e),p.push(0,1,0),m.push(l,1-h),l=l*ai+ni,h=h*ai+ni,l/=3,h/=3,l+=2/3,_.push(l,1-h),t>1&&f.push(g,g+t-1,g+t)}}return{positions:u,normals:p,uvs:m,uvs1:_,indices:f}}function di(t,e){const s=e&&void 0!==e.halfExtents?e.halfExtents:new Vec3(.5,.5,.5),i=e&&void 0!==e.widthSegments?e.widthSegments:1,n=e&&void 0!==e.lengthSegments?e.lengthSegments:1,a=e&&void 0!==e.heightSegments?e.heightSegments:1,r=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,o=[new Vec3(-s.x,-s.y,s.z),new Vec3(s.x,-s.y,s.z),new Vec3(s.x,s.y,s.z),new Vec3(-s.x,s.y,s.z),new Vec3(s.x,-s.y,-s.z),new Vec3(-s.x,-s.y,-s.z),new Vec3(-s.x,s.y,-s.z),new Vec3(s.x,s.y,-s.z)],l=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],h=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],c=1,d=2,u=3,p=4,m=5,_=[],f=[],g=[],y=[],v=[];let b=0;const x=(t,e,s)=>{const i=new Vec3,n=new Vec3,a=new Vec3,r=new Vec3;for(let c=0;c<=e;c++)for(let d=0;d<=s;d++){i.lerp(o[l[t][0]],o[l[t][1]],c/e),n.lerp(o[l[t][0]],o[l[t][2]],d/s),a.sub2(n,o[l[t][0]]),r.add2(i,a);let u=c/e,p=d/s;_.push(r.x,r.y,r.z),f.push(h[t][0],h[t][1],h[t][2]),g.push(u,1-p),u=u*ai+ni,p=p*ai+ni,u/=3,p/=3,u+=t%3/3,p+=Math.floor(t/3)/3,y.push(u,1-p),c<e&&d<s&&(v.push(b+s+1,b+1,b),v.push(b+s+1,b+s+2,b+1)),b++}};x(0,i,a),x(c,i,a),x(d,i,n),x(u,i,n),x(p,n,a),x(m,n,a);const S={normals:f,uvs:g,uvs1:y,indices:v};return r&&(S.tangents=li(_,f,g,v)),hi(t,_,S)}function ui(t,e){let s=null;for(let i=0;i<ri.length;i++)ri[i].type===e&&ri[i].device===t&&(s=ri[i].primData);if(!s){let i,n;switch(e){case"box":i=di(t,{halfExtents:new Vec3(.5,.5,.5)}),n={x:2,y:2,z:2,uv:2/3};break;case"capsule":i=function(t,e){const s=e&&void 0!==e.radius?e.radius:.3,i=e&&void 0!==e.height?e.height:1,n=e&&void 0!==e.heightSegments?e.heightSegments:1,a=e&&void 0!==e.sides?e.sides:20,r=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,o=ci(s,s,i-2*s,n,a,!0);return r&&(o.tangents=li(o.positions,o.normals,o.uvs,o.indices)),hi(t,o.positions,o)}(t,{radius:.5,height:2}),n={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":i=function(t,e){const s=e&&void 0!==e.baseRadius?e.baseRadius:.5,i=e&&void 0!==e.peakRadius?e.peakRadius:0,n=e&&void 0!==e.height?e.height:1,a=e&&void 0!==e.heightSegments?e.heightSegments:5,r=e&&void 0!==e.capSegments?e.capSegments:18,o=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,l=ci(s,i,n,a,r,!1);return o&&(l.tangents=li(l.positions,l.normals,l.uvs,l.indices)),hi(t,l.positions,l)}(t,{baseRadius:.5,peakRadius:0,height:1}),n={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":i=function(t,e){let s=e&&(e.radius||e.baseRadius);s=void 0!==s?s:.5;const i=e&&void 0!==e.height?e.height:1,n=e&&void 0!==e.heightSegments?e.heightSegments:5,a=e&&void 0!==e.capSegments?e.capSegments:20,r=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,o=ci(s,s,i,n,a,!1);return r&&(o.tangents=li(o.positions,o.normals,o.uvs,o.indices)),hi(t,o.positions,o)}(t,{radius:.5,height:1}),n={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":i=function(t,e){const s=e&&void 0!==e.halfExtents?e.halfExtents:new Vec2(.5,.5),i=e&&void 0!==e.widthSegments?e.widthSegments:5,n=e&&void 0!==e.lengthSegments?e.lengthSegments:5,a=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,r=[],o=[],l=[],h=[];let c=0;for(let u=0;u<=i;u++)for(let t=0;t<=n;t++){const e=-s.x+2*s.x*u/i,a=0,d=-(-s.y+2*s.y*t/n),p=u/i,m=t/n;r.push(e,a,d),o.push(0,1,0),l.push(p,1-m),u<i&&t<n&&(h.push(c+n+1,c+1,c),h.push(c+n+1,c+n+2,c+1)),c++}const d={normals:o,uvs:l,uvs1:l,indices:h};return a&&(d.tangents=li(r,o,l,h)),hi(t,r,d)}(t,{halfExtents:new Vec2(.5,.5),widthSegments:1,lengthSegments:1}),n={x:0,y:1,z:0,uv:1};break;case"sphere":i=function(t,e){const s=e&&void 0!==e.radius?e.radius:.5,i=e&&void 0!==e.latitudeBands?e.latitudeBands:16,n=e&&void 0!==e.longitudeBands?e.longitudeBands:16,a=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,r=[],o=[],l=[],h=[];for(let d=0;d<=i;d++){const t=d*Math.PI/i,e=Math.sin(t),a=Math.cos(t);for(let h=0;h<=n;h++){const t=2*h*Math.PI/n-Math.PI/2,c=Math.sin(t),u=Math.cos(t)*e,p=a,m=c*e,_=1-h/n,f=1-d/i;r.push(u*s,p*s,m*s),o.push(u,p,m),l.push(_,1-f)}}for(let d=0;d<i;++d)for(let t=0;t<n;++t){const e=d*(n+1)+t,s=e+n+1;h.push(e+1,s,e),h.push(e+1,s+1,s)}const c={normals:o,uvs:l,uvs1:l,indices:h};return a&&(c.tangents=li(r,o,l,h)),hi(t,r,c)}(t,{radius:.5}),n={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw new Error("Invalid primitive type: "+e)}i.incRefCount(),s={mesh:i,area:n},ri.push({type:e,device:t,primData:s})}return s}class BasicMaterial extends Material$1{constructor(){super(),this.color=new Color(1,1,1,1),this.colorUniform=new Float32Array(4),this.colorMap=null,this.vertexColors=!1}copy(t){return super.copy(t),this.color.copy(t.color),this.colorMap=t.colorMap,this.vertexColors=t.vertexColors,this}updateUniforms(t,e){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)}updateShader(t,e,s,i,n,a){const r={skin:s&&0!=(2&s),screenSpace:s&&0!=(s&Q),useInstancing:s&&0!=(32&s),useMorphPosition:s&&0!=(s&J),useMorphNormal:s&&0!=(s&tt),useMorphTextureBased:s&&0!=(s&et),vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:n},o=t.getProgramLibrary();this.shader=o.getProgram("basic",r)}}class Batch{constructor(t,e,s){this.origMeshInstances=t,this._aabb=new BoundingBox,this.meshInstance=null,this.dynamic=e,this.batchGroupId=s}destroy(t,e){this.meshInstance&&(this.removeFromLayers(t,e),this.meshInstance.destroy())}addToLayers(t,e){for(let s=0;s<e.length;s++){const i=t.layers.getLayerById(e[s]);i&&i.addMeshInstances([this.meshInstance])}}removeFromLayers(t,e){for(let s=0;s<e.length;s++){const i=t.layers.getLayerById(e[s]);i&&i.removeMeshInstances([this.meshInstance])}}updateBoundingBox(){this._aabb.copy(this.origMeshInstances[0].aabb);for(let t=1;t<this.origMeshInstances.length;t++)this._aabb.add(this.origMeshInstances[t].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0}}class BatchGroup{constructor(t,e,s,i,n=[0]){this.dynamic=s,this.maxAabbSize=i,this.id=t,this.name=e,this.layers=n,this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]}}}BatchGroup.MODEL="model",BatchGroup.ELEMENT="element",BatchGroup.SPRITE="sprite",BatchGroup.RENDER="render";const pi=new Mat4;class SkinInstance{constructor(t){this.bones=void 0,this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,t&&this.initSkin(t)}set rootBone(t){this._rootBone=t}get rootBone(){return this._rootBone}init(t,e){if(t.supportsBoneTextures){const s=3*e;let i=Math.ceil(Math.sqrt(s));i=O.roundUp(i,3);const n=Math.ceil(s/i);this.boneTexture=new Texture(t,{width:i,height:n,format:rt,mipmaps:!1,minFilter:0,magFilter:0}),this.boneTexture.name="skin",this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(12*e)}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(t,e){this.rootBone=t;const s=this.skin,i=[];for(let n=0;n<s.boneNames.length;n++){const a=s.boneNames[n];let r=t.findByName(a);r||(r=e),i.push(r)}this.bones=i}initSkin(t){this.skin=t,this.bones=[];const e=t.inverseBindPose.length;this.init(t.device,e),this.matrices=[];for(let s=0;s<e;s++)this.matrices[s]=new Mat4}uploadBones(t){t.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}_updateMatrices(t,e){if(this._skinUpdateIndex!==e){this._skinUpdateIndex=e,pi.copy(t.getWorldTransform()).invert();for(let t=this.bones.length-1;t>=0;t--)this.matrices[t].mulAffine2(pi,this.bones[t].getWorldTransform()),this.matrices[t].mulAffine2(this.matrices[t],this.skin.inverseBindPose[t])}}updateMatrices(t,e){this._updateBeforeCull&&this._updateMatrices(t,e)}updateMatrixPalette(t,e){this._updateMatrices(t,e);const s=this.matrixPalette,i=this.bones.length;for(let n=0;n<i;n++){const t=this.matrices[n].data,e=12*n;s[e]=t[0],s[e+1]=t[4],s[e+2]=t[8],s[e+3]=t[12],s[e+4]=t[1],s[e+5]=t[5],s[e+6]=t[9],s[e+7]=t[13],s[e+8]=t[2],s[e+9]=t[6],s[e+10]=t[10],s[e+11]=t[14]}this.uploadBones(this.skin.device)}}class SkinBatchInstance extends SkinInstance{constructor(t,e,s){super();const i=e.length;this.init(t,i),this.device=t,this.rootNode=s,this.bones=e}updateMatrices(t,e){}updateMatrixPalette(t,e){const s=this.matrixPalette,i=this.bones.length;for(let n=0;n<i;n++){const t=this.bones[n].getWorldTransform().data,e=12*n;s[e]=t[0],s[e+1]=t[4],s[e+2]=t[8],s[e+3]=t[12],s[e+4]=t[1],s[e+5]=t[5],s[e+6]=t[9],s[e+7]=t[13],s[e+8]=t[2],s[e+9]=t[6],s[e+10]=t[10],s[e+11]=t[14]}this.uploadBones(this.device)}}class LightmapCache{static incRef(t){this.cache.incRef(t)}static decRef(t){this.cache.decRef(t)}static destroy(){this.cache.destroy()}}LightmapCache.cache=new class RefCountedCache{constructor(){this.cache=new Map}destroy(){this.cache.forEach(((t,e)=>{e.destroy()})),this.cache.clear()}incRef(t){const e=(this.cache.get(t)||0)+1;this.cache.set(t,e)}decRef(t){if(t){let e=this.cache.get(t);e&&(e--,0===e?(this.cache.delete(t),t.destroy()):this.cache.set(t,e))}}};const mi=new BoundingBox,_i=new BoundingBox,fi=new BoundingSphere,gi=new Set;class InstancingData{constructor(t){this.count=t,this.vertexBuffer=null}}class MeshInstance{constructor(t,e,s=null){if(t instanceof GraphNode){const i=t;t=e,e=s,s=i}this._key=[0,0],this._shader=[null,null,null],this.isStatic=!1,this._staticLightList=null,this._staticSource=null,this.node=s,this._mesh=t,t.incRefCount(),this.material=e,this._shaderDefs=65536,this._shaderDefs|=t.vertexBuffer.format.hasUv0?4:0,this._shaderDefs|=t.vertexBuffer.format.hasUv1?8:0,this._shaderDefs|=t.vertexBuffer.format.hasColor?16:0,this._shaderDefs|=t.vertexBuffer.format.hasTangents?512:0,this._lightHash=0,this.visible=!0,this.layer=15,this._renderStyle=0,this.castShadow=!1,this._receiveShadow=!0,this._screenSpace=!1,this._noDepthDrawGl1=!1,this.cull=!0,this.pick=!0,this._updateAabb=!0,this._updateAabbFunc=null,this._calculateSortDistance=null,this.updateKey(),this._skinInstance=null,this._morphInstance=null,this.instancingData=null,this._customAabb=null,this.aabb=new BoundingBox,this._aabbVer=-1,this.drawOrder=0,this.visibleThisFrame=0,this.isVisibleFunc=null,this.parameters={},this.stencilFront=null,this.stencilBack=null,this.flipFaces=!1}set renderStyle(t){this._renderStyle=t,this.mesh.prepareRenderState(t)}get renderStyle(){return this._renderStyle}set mesh(t){t!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=t,t&&t.incRefCount())}get mesh(){return this._mesh}set aabb(t){this._aabb=t}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let t=this._customAabb,e=!!t;if(!t)if(t=mi,this.skinInstance){if(!this.mesh.boneAabb){const t=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(t)}const s=this.mesh.boneUsed;let i=!0;for(let e=0;e<this.mesh.boneAabb.length;e++)s[e]&&(_i.setFromTransformedAabb(this.mesh.boneAabb[e],this.skinInstance.matrices[e]),i?(i=!1,t.center.copy(_i.center),t.halfExtents.copy(_i.halfExtents)):t.add(_i));e=!0}else this.node._aabbVer!==this._aabbVer&&(this.mesh?(t.center.copy(this.mesh.aabb.center),t.halfExtents.copy(this.mesh.aabb.halfExtents)):(t.center.set(0,0,0),t.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph&&t._expand(this.mesh.morph.aabb.getMin(),this.mesh.morph.aabb.getMax()),e=!0,this._aabbVer=this.node._aabbVer);return e&&this._aabb.setFromTransformedAabb(t,this.node.getWorldTransform()),this._aabb}set material(t){for(let s=0;s<this._shader.length;s++)this._shader[s]=null;const e=this._material;if(e&&e.removeMeshInstanceRef(this),this._material=t,this._material){this._material.addMeshInstanceRef(this),this.updateKey();if((e&&3!==e.blendType)!==(3!==this._material.blendType)){let t=this._material._scene;!t&&e&&e._scene&&(t=e._scene),t?t.layers._dirtyBlend=!0:this._material._dirtyBlend=!0}}}get material(){return this._material}set layer(t){this._layer=t,this.updateKey()}get layer(){return this._layer}set calculateSortDistance(t){this._calculateSortDistance=t}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(t){this._receiveShadow=t,this._shaderDefs=t?-2&this._shaderDefs:1|this._shaderDefs,this._shader[0]=null,this._shader[1]=null}get receiveShadow(){return this._receiveShadow}set skinInstance(t){this._skinInstance=t,this._shaderDefs=t?2|this._shaderDefs:-3&this._shaderDefs;for(let e=0;e<this._shader.length;e++)this._shader[e]=null;this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(t){this._morphInstance=t,this._morphInstance&&(this._morphInstance.meshInstance=this),this._shaderDefs=t&&t.morph.useTextureMorph?this._shaderDefs|et:-4097&this._shaderDefs,this._shaderDefs=t&&t.morph.morphPositions?this._shaderDefs|J:-1025&this._shaderDefs,this._shaderDefs=t&&t.morph.morphNormals?this._shaderDefs|tt:-2049&this._shaderDefs;for(let e=0;e<this._shader.length;e++)this._shader[e]=null}get morphInstance(){return this._morphInstance}set screenSpace(t){this._screenSpace=t,this._shaderDefs=t?this._shaderDefs|Q:-257&this._shaderDefs,this._shader[0]=null}get screenSpace(){return this._screenSpace}set key(t){this._key[0]=t}get key(){return this._key[0]}set mask(t){const e=65535&this._shaderDefs;this._shaderDefs=e|t<<16,this._shader[0]=null,this._shader[1]=null}get mask(){return this._shaderDefs>>16}set instancingCount(t){this.instancingData&&(this.instancingData.count=t)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){const t=this.mesh;t&&(this.mesh=null,t.refCount<1&&t.destroy()),this.setRealtimeLightmap(MeshInstance.lightmapParamNames[0],null),this.setRealtimeLightmap(MeshInstance.lightmapParamNames[1],null),this._skinInstance&&(this._skinInstance.destroy(),this._skinInstance=null),this.morphInstance&&(this.morphInstance.destroy(),this.morphInstance=null),this.material=null}static _prepareRenderStyleForArray(t,e){if(t){for(let s=0;s<t.length;s++){t[s]._renderStyle=e;const i=t[s].mesh;gi.has(i)||(gi.add(i),i.prepareRenderState(e))}gi.clear()}}_isVisible(t){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(t):(fi.center=this.aabb.center,fi.radius=this._aabb.halfExtents.length(),t.frustum.containsSphere(fi)))}updateKey(){const t=this.material;var e,s,i,n;this._key[0]=(e=this.layer,s=t.alphaToCoverage||t.alphaTest?2:t.blendType,i=!1,n=t.id,(15&e)<<27|(3===s?1:0)<<26|(i?1:0)<<25|(33554431&n)<<0)}setInstancing(t){t?(this.instancingData=new InstancingData(t.numVertices),this.instancingData.vertexBuffer=t,t.instancing=!0,this.cull=!1):(this.instancingData=null,this.cull=!0)}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(t){return this.parameters[t]}setParameter(t,e,s=-262141){if(void 0===e&&"object"==typeof t){const s=t;if(s.length){for(let t=0;t<s.length;t++)this.setParameter(s[t]);return}t=s.name,e=s.value}const i=this.parameters[t];i?(i.data=e,i.passFlags=s):this.parameters[t]={scopeId:null,data:e,passFlags:s}}setRealtimeLightmap(t,e){const s=this.getParameter(t);s!==e&&(s&&LightmapCache.decRef(s.data),e?(LightmapCache.incRef(e),this.setParameter(t,e)):this.deleteParameter(t))}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;for(const i in s){const n=s[i];n.passFlags&e&&(n.scopeId||(n.scopeId=t.scope.resolve(i)),n.scopeId.setValue(n.data))}}setLightmapped(t){t?this.mask=-6&(2|this.mask):(this.setRealtimeLightmap(MeshInstance.lightmapParamNames[0],null),this.setRealtimeLightmap(MeshInstance.lightmapParamNames[1],null),this._shaderDefs&=-8385,this.mask=-7&(1|this.mask))}setCustomAabb(t){t?this._customAabb?this._customAabb.copy(t):this._customAabb=t.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}function yi(t,e){if(t&&!e)return!1;if(!t&&e)return!1;if((t=t.data)===(e=e.data))return!0;if(t instanceof Float32Array&&e instanceof Float32Array){if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!1;return!0}return!1}function vi(t,e){for(const s in t)if(t.hasOwnProperty(s)&&!yi(t[s],e[s]))return!1;for(const s in e)if(e.hasOwnProperty(s)&&!yi(e[s],t[s]))return!1;return!0}function bi(t,e){for(let s=0;s<t.length;s++)if(e.indexOf(t[s])<0)return!1;for(let s=0;s<e.length;s++)if(t.indexOf(e[s])<0)return!1;return!0}MeshInstance.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];const xi=new Mat3,Si=new Vec3,wi=new Vec3,Ci=new Vec3;function Ti(t){const e=t.node.worldTransform;return e.getX(Si),e.getY(wi),e.getZ(Ci),Si.cross(Si,wi),Si.dot(Ci)>=0?1:-1}class BatchManager{constructor(t,e,s){this.device=t,this.rootNode=e,this.scene=s,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}destroy(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]}addGroup(t,e,s,i,n){if(void 0===i&&(i=this._batchGroupCounter,this._batchGroupCounter++),this._batchGroups[i])return;const a=new BatchGroup(i,t,e,s,n);return this._batchGroups[i]=a,a}removeGroup(t){if(!this._batchGroups[t])return;const e=[];for(let s=0;s<this._batchList.length;s++)this._batchList[s].batchGroupId===t?this.destroyBatch(this._batchList[s]):e.push(this._batchList[s]);this._batchList=e,this._removeModelsFromBatchGroup(this.rootNode,t),delete this._batchGroups[t]}markGroupDirty(t){this._dirtyGroups.indexOf(t)<0&&this._dirtyGroups.push(t)}getGroupByName(t){const e=this._batchGroups;for(const s in e)if(e.hasOwnProperty(s)&&e[s].name===t)return e[s];return null}getBatches(t){const e=[],s=this._batchList.length;for(let i=0;i<s;i++){const s=this._batchList[i];s.batchGroupId===t&&e.push(s)}return e}_removeModelsFromBatchGroup(t,e){if(t.enabled){t.model&&t.model.batchGroupId===e&&(t.model.batchGroupId=-1),t.render&&t.render.batchGroupId===e&&(t.render.batchGroupId=-1),t.element&&t.element.batchGroupId===e&&(t.element.batchGroupId=-1),t.sprite&&t.sprite.batchGroupId===e&&(t.sprite.batchGroupId=-1);for(let s=0;s<t._children.length;s++)this._removeModelsFromBatchGroup(t._children[s],e)}}insert(t,e,s){const i=this._batchGroups[e];i&&i._obj[t].indexOf(s)<0&&(i._obj[t].push(s),this.markGroupDirty(e))}remove(t,e,s){const i=this._batchGroups[e];if(i){const n=i._obj[t].indexOf(s);n>=0&&(i._obj[t].splice(n,1),this.markGroupDirty(e))}}_extractRender(t,e,s,i){if(t.render){if(t.render.isStatic){const s=this.scene.drawCalls,i=t.render.meshInstances;for(let t=0;t<s.length;t++)s[t]._staticSource&&(i.indexOf(s[t]._staticSource)<0||e.push(s[t]));for(let t=0;t<i.length;t++)s.indexOf(i[t])>=0&&e.push(i[t])}else e=i[t.render.batchGroupId]=e.concat(t.render.meshInstances);t.render.removeFromLayers()}return e}_extractModel(t,e,s,i){if(t.model&&t.model.model){if(t.model.isStatic){const s=this.scene.drawCalls,i=t.model.meshInstances;for(let t=0;t<s.length;t++)s[t]._staticSource&&(i.indexOf(s[t]._staticSource)<0||e.push(s[t]));for(let t=0;t<i.length;t++)s.indexOf(i[t])>=0&&e.push(i[t])}else e=i[t.model.batchGroupId]=e.concat(t.model.meshInstances);t.model.removeModelFromLayers()}return e}_extractElement(t,e,s){if(!t.element)return;let i=!1;t.element._text&&t.element._text._model.meshInstances.length>0?(e.push(t.element._text._model.meshInstances[0]),t.element.removeModelFromLayers(t.element._text._model),i=!0):t.element._image&&(e.push(t.element._image._renderable.meshInstance),t.element.removeModelFromLayers(t.element._image._renderable.model),t.element._image._renderable.unmaskMeshInstance&&(e.push(t.element._image._renderable.unmaskMeshInstance),t.element._image._renderable.unmaskMeshInstance.stencilFront&&t.element._image._renderable.unmaskMeshInstance.stencilBack||(t.element._dirtifyMask(),t.element._onPrerender())),i=!0),i&&(s._ui=!0)}_collectAndRemoveMeshInstances(t,e){for(let s=0;s<e.length;s++){const i=e[s],n=this._batchGroups[i];if(!n)continue;let a=t[i];a||(a=t[i]=[]);for(let e=0;e<n._obj.model.length;e++)a=this._extractModel(n._obj.model[e],a,n,t);for(let e=0;e<n._obj.render.length;e++)a=this._extractRender(n._obj.render[e],a,n,t);for(let t=0;t<n._obj.element.length;t++)this._extractElement(n._obj.element[t],a,n);for(let t=0;t<n._obj.sprite.length;t++){const e=n._obj.sprite[t];e.sprite&&e.sprite._meshInstance&&(n.dynamic||0===e.sprite.sprite._renderMode)&&(a.push(e.sprite._meshInstance),e.sprite.removeModelFromLayers(),n._sprite=!0,e.sprite._batchGroup=n)}}}generate(t){const e={};t||(t=Object.keys(this._batchGroups));const s=[];for(let o=0;o<this._batchList.length;o++)t.indexOf(this._batchList[o].batchGroupId)<0?s.push(this._batchList[o]):this.destroyBatch(this._batchList[o]);if(this._batchList=s,this._collectAndRemoveMeshInstances(e,t),t===this._dirtyGroups)this._dirtyGroups.length=0;else{const e=[];for(let s=0;s<this._dirtyGroups.length;s++)t.indexOf(this._dirtyGroups[s])<0&&e.push(this._dirtyGroups[s]);this._dirtyGroups=e}let i,n,a,r;for(const o in e)if(e.hasOwnProperty(o)&&(i=e[o],a=this._batchGroups[o],a)){n=this.prepare(i,a.dynamic,a.maxAabbSize,a._ui||a._sprite);for(let t=0;t<n.length;t++)r=this.create(n[t],a.dynamic,parseInt(o,10)),r&&r.addToLayers(this.scene,a.layers)}}prepare(t,e,s=Number.POSITIVE_INFINITY,i){if(0===t.length)return[];const n=.5*s,a=this.device.supportsBoneTextures?1024:this.device.boneLimit,r=this.device.extUintElement?4294967295:65535,o=new BoundingBox,l=new BoundingBox;let h,c=null;const d=[];let u=0;i&&t.sort((function(t,e){return t.drawOrder-e.drawOrder}));let p,m=t;const _=i?function(t){c?c.add(t.aabb):c=t.aabb.clone(),p.push(t)}:function(t){p.push(t)};for(;m.length>0;){d[u]=[m[0]],p=[];const t=m[0].material,s=m[0].layer,f=m[0]._shaderDefs,g=m[0].parameters,y=m[0].stencilFront,v=m[0]._staticLightList;let b=m[0].mesh.vertexBuffer.getNumVertices();const x=m[0].drawOrder;o.copy(m[0].aabb);const S=Ti(m[0]),w=m[0].mesh.vertexBuffer.format.batchingHash,C=m[0].mesh.primitive[0].indexed;c=null;for(let T=1;T<m.length;T++){const M=m[T];if(e&&d[u].length>=a){p=p.concat(m.slice(T));break}if(t!==M.material||s!==M.layer||w!==M.mesh.vertexBuffer.format.batchingHash||C!==M.mesh.primitive[0].indexed||f!==M._shaderDefs||b+M.mesh.vertexBuffer.getNumVertices()>r){_(M);continue}if(l.copy(o),l.add(M.aabb),l.halfExtents.x>n||l.halfExtents.y>n||l.halfExtents.z>n){_(M);continue}if(y&&(!(h=M.stencilFront)||y.func!==h.func||y.zpass!==h.zpass)){_(M);continue}if(S!==Ti(M)){_(M);continue}if(!vi(g,M.parameters)){_(M);continue}const A=M._staticLightList;if(v&&A){if(!bi(v,A)){_(M);continue}}else if(v||A){_(M);continue}i&&c&&c.intersects(M.aabb)&&M.drawOrder!==x?_(M):(o.add(M.aabb),b+=M.mesh.vertexBuffer.getNumVertices(),d[u].push(M))}u++,m=p}return d}collectBatchedMeshData(t,e){let s=null,i=0,n=0,a=null;for(let r=0;r<t.length;r++)if(t[r].visible){const o=t[r].mesh;if(i+=o.vertexBuffer.numVertices,n+=o.primitive[0].indexed?o.primitive[0].count:6===o.primitive[0].type&&4===o.primitive[0].count?6:0,!s){a=t[r].material,s={};const i=o.vertexBuffer.format.elements;for(let t=0;t<i.length;t++){s[i[t].name]={numComponents:i[t].numComponents,dataType:i[t].dataType,normalize:i[t].normalize,count:0}}e&&(s.BLENDINDICES={numComponents:1,dataType:6,normalize:!1,count:0})}}return{streams:s,batchNumVerts:i,batchNumIndices:n,material:a}}create(t,e,s){if(!this._init){const t="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n";this.transformVS=t+"#define DYNAMICBATCH\n"+Zt.transformVS,this.skinTexVS=Zt.skinBatchTexVS,this.skinConstVS=Zt.skinBatchConstVS,this.vertexFormats={},this._init=!0}let i,n,a,r=null,o=null;const l=this.collectBatchedMeshData(t,e);if(l.streams){const h=l.streams;let c=l.material;const d=l.batchNumVerts,u=l.batchNumIndices;let p,m,_;o=new Batch(t,e,s),this._batchList.push(o);let f,g=0,y=0;const v=new Vec3,b=new(d<=65535?Uint16Array:Uint32Array)(u);for(i in h)r=h[i],r.typeArrayType=Ht[r.dataType],r.elementByteSize=Wt[r.dataType],r.buffer=new r.typeArrayType(d*r.numComponents);for(let s=0;s<t.length;s++)if(t[s].visible){for(i in n=t[s].mesh,a=n.vertexBuffer.numVertices,e||(f=t[s].node.getWorldTransform()),h)if(i!==dt){r=h[i];const t=new r.typeArrayType(r.buffer.buffer,r.elementByteSize*r.count),s=n.getVertexStream(i,t)*r.numComponents;if(r.count+=s,!e&&r.numComponents>=3)if(i===ot)for(let e=0;e<s;e+=r.numComponents)v.set(t[e],t[e+1],t[e+2]),f.transformPoint(v,v),t[e]=v.x,t[e+1]=v.y,t[e+2]=v.z;else if(i===lt||i===ht){f.invertTo3x3(xi),xi.transpose();for(let e=0;e<s;e+=r.numComponents)v.set(t[e],t[e+1],t[e+2]),xi.transformVector(v,v),t[e]=v.x,t[e+1]=v.y,t[e+2]=v.z}}if(e){r=h.BLENDINDICES;for(let t=0;t<a;t++)r.buffer[r.count++]=s}if(n.primitive[0].indexed){p=n.primitive[0].base,m=n.primitive[0].count;const t=n.indexBuffer[0].getFormat();_=new Gt[t](n.indexBuffer[0].storage)}else{if(6!==n.primitive[0].type||4!==n.primitive[0].count){m=0;continue}p=0,m=6,_=[0,1,3,2,3,1]}for(let t=0;t<m;t++)b[t+y]=_[p+t]+g;y+=m,g+=a}for(i in n=new Mesh(this.device),h)r=h[i],n.setVertexStream(i,r.buffer,r.numComponents,void 0,r.dataType,r.normalize);b.length>0&&n.setIndices(b),n.update(4,!1),e&&(c=c.clone(),c.chunks.transformVS=this.transformVS,c.chunks.skinTexVS=this.skinTexVS,c.chunks.skinConstVS=this.skinConstVS,c.update());const x=new MeshInstance(n,c,this.rootNode);x.castShadow=o.origMeshInstances[0].castShadow,x.parameters=o.origMeshInstances[0].parameters,x.isStatic=o.origMeshInstances[0].isStatic,x.layer=o.origMeshInstances[0].layer,x._staticLightList=o.origMeshInstances[0]._staticLightList,x._shaderDefs=o.origMeshInstances[0]._shaderDefs,x.cull=o.origMeshInstances[0].cull;const S=this._batchGroups[s];if(S&&S._ui&&(x.cull=!1),e){const t=[];for(let e=0;e<o.origMeshInstances.length;e++)t.push(o.origMeshInstances[e].node);x.skinInstance=new SkinBatchInstance(this.device,t,this.rootNode)}x._updateAabb=!1,x.drawOrder=o.origMeshInstances[0].drawOrder,x.stencilFront=o.origMeshInstances[0].stencilFront,x.stencilBack=o.origMeshInstances[0].stencilBack,x.flipFaces=Ti(o.origMeshInstances[0])<0,x.castShadow=o.origMeshInstances[0].castShadow,o.meshInstance=x,o.updateBoundingBox()}return o}updateAll(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(let t=0;t<this._batchList.length;t++)this._batchList[t].dynamic&&this._batchList[t].updateBoundingBox()}clone(t,e){const s=new Batch(e,t.dynamic,t.batchGroupId);this._batchList.push(s);const i=[];for(let n=0;n<e.length;n++)i.push(e[n].node);return s.meshInstance=new MeshInstance(t.meshInstance.mesh,t.meshInstance.material,t.meshInstance.node),s.meshInstance._updateAabb=!1,s.meshInstance.parameters=e[0].parameters,s.meshInstance.isStatic=e[0].isStatic,s.meshInstance.cull=e[0].cull,s.meshInstance.layer=e[0].layer,s.meshInstance._staticLightList=e[0]._staticLightList,t.dynamic&&(s.meshInstance.skinInstance=new SkinBatchInstance(this.device,i,this.rootNode)),s.meshInstance.castShadow=t.meshInstance.castShadow,s.meshInstance._shader=t.meshInstance._shader,s.meshInstance.castShadow=t.meshInstance.castShadow,s}destroyBatch(t){t.destroy(this.scene,this._batchGroups[t.batchGroupId].layers)}}const Mi=new Vec3,Ai=new Vec3,Pi=new Vec3,Ei=new BoundingBox,Li=1e-6;class ClusterLight{constructor(){this.light=null,this.min=new Vec3,this.max=new Vec3}}class WorldClusters{constructor(t){this.device=t,this.name="Untitled",this.reportCount=0,this.boundsMin=new Vec3,this.boundsMax=new Vec3,this.boundsDelta=new Vec3,this._cells=new Vec3(1,1,1),this._cellsLimit=new Vec3,this.cells=this._cells,this._maxCellLightCount=0,this._pixelsPerCellCount=0,this.maxCellLightCount=4,this._maxAttenuation=0,this._maxColorValue=0,this._usedLights=[],this._usedLights.push(new ClusterLight),this.lightsBuffer=new LightsBuffer(t),this.registerUniforms(t)}set maxCellLightCount(t){const e=O.roundUp(t,4);e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._pixelsPerCellCount=this._maxCellLightCount/4,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(t){Mi.copy(t).floor(),this._cells.equals(Mi)||(this._cells.copy(Mi),this._cellsLimit.copy(Mi).sub(Vec3.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(t){this._clusterWorldTextureId=t.scope.resolve("clusterWorldTexture"),this._clusterPixelsPerCellId=t.scope.resolve("clusterPixelsPerCell"),this._clusterTextureSizeId=t.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=t.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=t.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=t.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=t.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=t.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3),this._clusterCompressionLimit0Id=t.scope.resolve("clusterCompressionLimit0"),this._clusterCompressionLimit0Data=new Float32Array(2)}updateParams(t){t&&(this.cells=t.cells,this.maxCellLightCount=t.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=t.cookiesEnabled,this.lightsBuffer.shadowsEnabled=t.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=t.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;const t=this._cells.x,e=this._cells.y,s=this._cells.z,i=t*e*s,n=this._pixelsPerCellCount*i;let a=Math.ceil(Math.sqrt(n));a=O.roundUp(a,this._pixelsPerCellCount);const r=Math.ceil(n/a);this._clusterCellsMaxData[0]=t,this._clusterCellsMaxData[1]=e,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this._pixelsPerCellCount,this._clusterCellsDotData[1]=t*s*this._pixelsPerCellCount,this._clusterCellsDotData[2]=t*this._pixelsPerCellCount,this.clusters=new Uint8ClampedArray(4*n),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=a,this._clusterTextureSizeData[1]=1/a,this._clusterTextureSizeData[2]=1/r,this.releaseClusterTexture(),this.clusterTexture=LightsBuffer.createTexture(this.device,a,r,7,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture);const t=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/t.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/t.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/t.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=t.x,this._clusterBoundsDeltaData[1]=t.y,this._clusterBoundsDeltaData[2]=t.z,this._clusterCompressionLimit0Data[0]=this._maxAttenuation,this._clusterCompressionLimit0Data[1]=this._maxColorValue,this._clusterPixelsPerCellId.setValue(this._pixelsPerCellCount),this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterCompressionLimit0Id.setValue(this._clusterCompressionLimit0Data)}evalLightCellMinMax(t,e,s){e.copy(t.min),e.sub(this.boundsMin),e.div(this.boundsDelta),e.mul2(e,this.cells),e.floor(),s.copy(t.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),e.max(Vec3.ZERO),s.min(this._cellsLimit)}collectLights(t){const e=this.lightsBuffer.maxLights,s=this._usedLights;let i=1;for(let n=0;n<t.length;n++){const a=t[n],r=!!(3&a.mask);if(a.enabled&&0!==a.type&&a.visibleThisFrame&&a.intensity>0&&r){if(!(i<e)){console.warn(`Clustered lighting: more than ${e-1} lights in the frame, ignoring some.`);break}{let t;i<s.length?t=s[i]:(t=new ClusterLight,s.push(t)),t.light=a,a.getBoundingBox(Ei),t.min.copy(Ei.getMin()),t.max.copy(Ei.getMax()),i++}}}s.length=i}evaluateBounds(){const t=this._usedLights,e=this.boundsMin,s=this.boundsMax;if(t.length>1){e.copy(t[1].min),s.copy(t[1].max);for(let i=2;i<t.length;i++)e.min(t[i].min),s.max(t[i].max)}else e.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,e),this.lightsBuffer.setBounds(e,this.boundsDelta)}evaluateCompressionLimits(t){let e=0,s=0;const i=this._usedLights;for(let n=1;n<i.length;n++){const a=i[n].light;e=Math.max(a.attenuationEnd,e);const r=t?a._linearFinalColor:a._finalColor;s=Math.max(r[0],s),s=Math.max(r[1],s),s=Math.max(r[2],s)}this._maxAttenuation=e+Li,this._maxColorValue=s+Li,this.lightsBuffer.setCompressionRanges(this._maxAttenuation,this._maxColorValue)}updateClusters(t){this.counts.fill(0),this.clusters.fill(0);const e=this._cells.x,s=this._cells.z,i=this.counts,n=this._maxCellLightCount,a=this.clusters,r=this._pixelsPerCellCount,o=this._usedLights;for(let l=1;l<o.length;l++){const h=o[l],c=h.light;this.lightsBuffer.addLightData(c,l,t),this.evalLightCellMinMax(h,Ai,Pi);const d=Ai.x,u=Pi.x,p=Ai.y,m=Pi.y,_=Ai.z,f=Pi.z;for(let t=d;t<=u;t++)for(let o=_;o<=f;o++)for(let h=p;h<=m;h++){const c=t+e*(o+h*s),d=i[c];d<n&&(a[r*c*4+d]=l,i[c]=d+1)}}}update(t,e,s){this.updateParams(s),this.updateCells(),this.collectLights(t),this.evaluateBounds(),this.evaluateCompressionLimits(e),this.updateClusters(e),this.uploadTextures()}activate(){this.updateUniforms()}}const Ri=new Vec4;class CookieRenderer{constructor(t,e){this.device=t,this.lightTextureAtlas=e,this.blitShader2d=null,this.blitShaderCube=null,this.blitTextureId=null,this.invViewProjId=null}destroy(){}getShader(t,e){return this[t]||(this[t]=he(this.device,"\n\t\tattribute vec2 vertex_position;\n\t\tvarying vec2 uv0;\n\t\tvoid main(void) {\n\t\t\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\t\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t}",e,`cookie_renderer_${t}`)),this.blitTextureId||(this.blitTextureId=this.device.scope.resolve("blitTexture")),this.invViewProjId||(this.invViewProjId=this.device.scope.resolve("invViewProj")),this[t]}get shader2d(){return this.getShader("blitShader2d","\n\t\tvarying vec2 uv0;\n\t\tuniform sampler2D blitTexture;\n\t\tvoid main(void) {\n\t\t\t\tgl_FragColor = texture2D(blitTexture, uv0);\n\t\t}")}get shaderCube(){return this.getShader("blitShaderCube","\n\t\tvarying vec2 uv0;\n\t\tuniform samplerCube blitTexture;\n\t\tuniform mat4 invViewProj;\n\t\tvoid main(void) {\n\t\t\t\tvec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);\n\t\t\t\tvec4 worldPos = invViewProj * projPos;\n\t\t\t\tgl_FragColor = textureCube(blitTexture, worldPos.xyz);\n\t\t}")}static createTexture(t,e){return new Texture(t,{name:"CookieAtlas",width:e,height:e,format:7,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}initInvViewProjMatrices(){if(!CookieRenderer._invViewProjMatrices){CookieRenderer._invViewProjMatrices=[];for(let t=0;t<6;t++){const e=LightCamera.create(null,1,t),s=e.projectionMatrix,i=e.node.getLocalTransform().clone().invert();CookieRenderer._invViewProjMatrices[t]=(new Mat4).mul2(s,i).invert()}}}render(t,e){if(t.enabled&&t.cookie&&t.visibleThisFrame){const s=t.numShadowFaces,i=s>1?this.shaderCube:this.shader2d,n=this.device;s>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(t.cookie);for(let a=0;a<s;a++){if(Ri.copy(t.atlasViewport),s>1){const t=Ri.z/3,e=this.lightTextureAtlas.cubeSlotsOffsets[a];Ri.x+=t*e.x,Ri.y+=t*e.y,Ri.z=t,Ri.w=t,this.invViewProjId.setValue(CookieRenderer._invViewProjMatrices[a].data)}Ri.mulScalar(e.colorBuffer.width),Kt(n,e,i,Ri)}}}}CookieRenderer._invViewProjMatrices=null;class ShadowMap{constructor(t,e){this.texture=t,this.cached=!1,this.renderTargets=e}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);const t=this.renderTargets;for(let e=0;e<t.length;e++)t[e].destroy();this.renderTargets.length=0}static getShadowFormat(t,e){return 3===e?rt:2===e?at:4===e||0===e&&t.webgl2?16:7}static getShadowFiltering(t,e){return 0!==e||t.webgl2?3===e?t.extTextureFloatLinear?1:0:2===e?t.extTextureHalfFloatLinear?1:0:1:0}static create(t,e){let s=null;return s=1===e._type?this.createCubemap(t,e._shadowResolution):this.create2dMap(t,e._shadowResolution,e._shadowType),s}static createAtlas(t,e,s){const i=this.create2dMap(t,e,s),n=i.renderTargets,a=n[0];for(let r=0;r<5;r++)n.push(a);return i}static create2dMap(t,e,s){const i=this.getShadowFormat(t,s),n=this.getShadowFiltering(t,s),a=new Texture(t,{format:i,width:e,height:e,mipmaps:!1,minFilter:n,magFilter:n,addressU:1,addressV:1});a.name="ShadowMap2D";let r=null;return 4===s||0===s&&t.webgl2?(a.compareOnRead=!0,a.compareFunc=1,r=new RenderTarget({depthBuffer:a})):r=new RenderTarget({colorBuffer:a,depth:!0}),new ShadowMap(a,[r])}static createCubemap(t,e){const s=new Texture(t,{format:7,width:e,height:e,cubemap:!0,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});s.name="ShadowMapCube";const i=[];for(let n=0;n<6;n++){const t=new RenderTarget({colorBuffer:s,face:n,depth:!0});i.push(t)}return new ShadowMap(s,i)}}const Ii=[],Di=[],ki=new Vec4,Fi=new Vec4;class Slot{constructor(t){this.size=Math.floor(1024*t.w),this.used=!1,this.lightId=-1,this.rect=t}}class LightTextureAtlas{constructor(t){this.device=t,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=2048,this.cookieAtlas=null,this.cookieRenderTarget=null,this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new Vec2(0,0),new Vec2(0,1),new Vec2(1,0),new Vec2(1,1),new Vec2(2,0),new Vec2(2,1)],this.scissorVec=new Vec4,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){this.shadowAtlas&&(this.shadowAtlas.destroy(),this.shadowAtlas=null)}destroyCookieAtlas(){this.cookieAtlas&&(this.cookieAtlas.destroy(),this.cookieAtlas=null),this.cookieRenderTarget&&(this.cookieRenderTarget.destroy(),this.cookieRenderTarget=null)}allocateShadowAtlas(t){if(!this.shadowAtlas||this.shadowAtlas.texture.width!==t){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=ShadowMap.createAtlas(this.device,t,0),this.shadowAtlas.cached=!0;const e=4/this.shadowAtlasResolution;this.scissorVec.set(e,e,-2*e,-2*e)}}allocateCookieAtlas(t){this.cookieAtlas&&this.cookieAtlas.width===t||(this.version++,this.destroyCookieAtlas(),this.cookieAtlas=CookieRenderer.createTexture(this.device,t),this.cookieRenderTarget=new RenderTarget({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}))}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){const t=this.shadowAtlas.renderTargets[0],e=this.device.webgl2?t.depthBuffer:t.colorBuffer;this._shadowAtlasTextureId.setValue(e),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(t,e){let s=e.atlasSplit;if(!s){const e=Math.ceil(Math.sqrt(t));s=Di,s[0]=e,s.length=1}if(i=s,n=this.atlasSplit,i.length!==n.length||!i.every(((t,e)=>t===n[e]))){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);const t=this.atlasSplit[0];if(t>1){const e=1/t;for(let s=0;s<t;s++)for(let i=0;i<t;i++){const n=new Vec4(s*e,i*e,e,e),a=this.atlasSplit[1+s*t+i];if(a>1)for(let t=0;t<a;t++)for(let s=0;s<a;s++){const i=e/a,r=new Vec4(n.x+t*i,n.y+s*i,i,i);this.slots.push(new Slot(r))}else this.slots.push(new Slot(n))}}else this.slots.push(new Slot(new Vec4(0,0,1,1)));this.slots.sort(((t,e)=>e.size-t.size))}var i,n}collectLights(t,e,s){const i=s.cookiesEnabled,n=s.shadowsEnabled;let a=!1,r=!1;const o=Ii;o.length=0;const l=t=>{for(let e=0;e<t.length;e++){const s=t[e];if(s.visibleThisFrame){const t=n&&s.castShadows,e=i&&!!s.cookie;a||(a=t),r||(r=e),(t||e)&&o.push(s)}}};return(i||n)&&(l(t),l(e)),o.sort(((t,e)=>e.maxScreenSize-t.maxScreenSize)),a&&this.allocateShadowAtlas(this.shadowAtlasResolution),r&&this.allocateCookieAtlas(this.cookieAtlasResolution),(a||r)&&this.subdivide(o.length,s),o}setupSlot(t,e){t.atlasViewport.copy(e);const s=t.numShadowFaces;for(let i=0;i<s;i++)if(t.castShadows||t._cookie){if(ki.copy(e),Fi.copy(e),2===t._type&&ki.add(this.scissorVec),1===t._type){const t=ki.z/3,e=this.cubeSlotsOffsets[i];ki.x+=t*e.x,ki.y+=t*e.y,ki.z=t,ki.w=t,Fi.copy(ki)}if(t.castShadows){const e=t.getRenderData(null,i);e.shadowViewport.copy(ki),e.shadowScissor.copy(Fi)}}}assignSlot(t,e,s){t.atlasViewportAllocated=!0;const i=this.slots[e];i.lightId=t.id,i.used=!0,s&&(t.atlasSlotUpdated=!0,t.atlasVersion=this.version,t.atlasSlotIndex=e)}update(t,e,s){this.shadowAtlasResolution=s.shadowAtlasResolution,this.cookieAtlasResolution=s.cookieAtlasResolution;const i=this.collectLights(t,e,s);if(i.length>0){const t=this.slots;for(let i=0;i<t.length;i++)t[i].used=!1;const e=Math.min(i.length,t.length);for(let n=0;n<e;n++){const e=i[n];e.castShadows&&(e._shadowMap=this.shadowAtlas);const s=t[e.atlasSlotIndex];if(e.atlasVersion===this.version&&e.id===(null==s?void 0:s.lightId)){const s=t[e.atlasSlotIndex];s.size!==t[n].size||s.used||this.assignSlot(e,e.atlasSlotIndex,!1)}}let s=0;for(let n=0;n<e;n++){for(;s<t.length&&t[s].used;)s++;const e=i[n];e.atlasViewportAllocated||this.assignSlot(e,s,!0);const a=t[e.atlasSlotIndex];this.setupSlot(e,a.rect)}}this.updateUniforms()}}class ShadowMapCache{constructor(){this.shadowMapCache=new Map}destroy(){this.clear(),this.shadowMapCache=null}clear(){this.shadowMapCache.forEach((t=>{t.forEach((t=>{t.destroy()}))})),this.shadowMapCache.clear()}getKey(t){return`${1===t._type}-${t._shadowType}-${t._shadowResolution}`}get(t,e){const s=this.getKey(e),i=this.shadowMapCache.get(s);if(i&&i.length)return i.pop();const n=ShadowMap.create(t,e);return n.cached=!0,n}add(t,e){const s=this.getKey(t),i=this.shadowMapCache.get(s);i?i.push(e):this.shadowMapCache.set(s,[e])}}const Oi=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3],Vi={min:0,max:0};function Bi(t,e,s){Oi[0].x=Oi[1].x=Oi[2].x=Oi[3].x=e.x,Oi[1].y=Oi[3].y=Oi[7].y=Oi[5].y=e.y,Oi[2].z=Oi[3].z=Oi[6].z=Oi[7].z=e.z,Oi[4].x=Oi[5].x=Oi[6].x=Oi[7].x=s.x,Oi[0].y=Oi[2].y=Oi[4].y=Oi[6].y=s.y,Oi[0].z=Oi[1].z=Oi[4].z=Oi[5].z=s.z;let i=9999999999,n=-9999999999;for(let a=0;a<8;++a){t.transformPoint(Oi[a],Oi[a]);const e=Oi[a].z;e<i&&(i=e),e>n&&(n=e)}return Vi.min=i,Vi.max=n,Vi}function zi(t,e){return Math.exp(-t*t/(2*e*e))}const Ui=new BoundingBox,Ni=new Mat4,Hi=new Mat4,Wi=new Float32Array(2),Gi={x:1,y:1,z:0,w:0},ji={r:1,g:2,b:3,a:4},Xi=new Vec3,qi=new Mat4;function $i(t){const e=t.material,s=t.skinInstance?10:0;let i=0;if(e.opacityMap){const t=e.opacityMapChannel;t&&(i=ji[t])}return s+i}class ShadowRenderer{constructor(t,e){this.device=t.device,this.forwardRenderer=t,this.lightTextureAtlas=e;const s=this.device.scope;this.polygonOffsetId=s.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShaderCode=[Zt.blurVSMPS,"#define GAUSS\n"+Zt.blurVSMPS];const i="#define PACKED\n";this.blurPackedVsmShaderCode=[i+this.blurVsmShaderCode[0],i+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.shadowMapCache=new ShadowMapCache}destroy(){this.shadowMapCache.destroy(),this.shadowMapCache=null}static createShadowCamera(t,e,s,i){const n=LightCamera.create("ShadowCamera",s,i);return n.clearColor=e>=1&&e<=3?new Color(0,0,0,0):new Color(1,1,1,1),n.clearDepthBuffer=!0,n.clearStencilBuffer=!1,n}static setShadowCameraSettings(t,e,s,i,n){let a=4===s||0===s&&e.webgl2;1!==i||n||(a=!1),t.clearColorBuffer=!a}cullShadowCasters(t,e,s){let i=0;const n=t.length;for(let a=0;a<n;a++){const n=t[a];n.cull&&!n._isVisible(s)||(n.visibleThisFrame=!0,e[i]=n,i++)}e.length=i,e.sort(this.forwardRenderer.depthSortCompare)}cullLocal(t,e){const s=this.forwardRenderer.scene.clusteredLightingEnabled;t.visibleThisFrame=!0,s||t._shadowMap||(t._shadowMap=ShadowMap.create(this.device,t));const i=t._type,n=2===i?1:6;for(let a=0;a<n;a++){const n=t.getRenderData(null,a),r=n.shadowCamera;r.nearClip=t.attenuationEnd/1e3,r.farClip=t.attenuationEnd;const o=r._node,l=t._node;if(o.setPosition(l.getPosition()),2===i)r.fov=2*t._outerConeAngle,o.setRotation(l.getRotation()),o.rotateLocal(-90,0,0);else if(1===i)if(s){const e=2/(this.lightTextureAtlas.shadowAtlasResolution*t.atlasViewport.z/3)*this.lightTextureAtlas.shadowEdgePixels;r.fov=Math.atan(1+e)*O.RAD_TO_DEG*2}else r.fov=90;this.forwardRenderer.updateCameraFrustum(r),this.cullShadowCasters(e,n.visibleCasters,r)}}generateSplitDistances(t,e,s){t._shadowCascadeDistances.fill(s);for(let i=1;i<t.numCascades;i++){const n=i/t.numCascades,a=e+(s-e)*n,r=e*(s/e)**n,o=O.lerp(a,r,t.cascadeDistribution);t._shadowCascadeDistances[i-1]=o}}cullDirectional(t,e,s){t.visibleThisFrame=!0,t._shadowMap||(t._shadowMap=ShadowMap.create(this.device,t));const i=s._nearClip;this.generateSplitDistances(t,i,t.shadowDistance);for(let n=0;n<t.numCascades;n++){const a=t.getRenderData(s,n),r=a.shadowCamera;r.renderTarget=t._shadowMap.renderTargets[0],a.shadowViewport.copy(t.cascades[n]),a.shadowScissor.copy(t.cascades[n]);const o=r._node,l=t._node;o.setPosition(l.getPosition()),o.setRotation(l.getRotation()),o.rotateLocal(-90,0,0);const h=0===n?i:t._shadowCascadeDistances[n-1],c=t._shadowCascadeDistances[n],d=Frustum.getPoints(s,h,c);Xi.set(0,0,0);const u=s.node.getWorldTransform();for(let t=0;t<8;t++)u.transformPoint(d[t],d[t]),Xi.add(d[t]);Xi.mulScalar(1/8);let p=0;for(let t=0;t<8;t++){const e=d[t].sub(Xi).length();e>p&&(p=e)}const m=o.right,_=o.up,f=o.forward,g=.25*t._shadowResolution/p,y=Math.ceil(Xi.dot(_)*g)/g,v=Math.ceil(Xi.dot(m)*g)/g,b=_.mulScalar(y),x=m.mulScalar(v),S=Xi.dot(f),w=f.mulScalar(S);Xi.add2(b,x).add(w),o.setPosition(Xi),o.translateLocal(0,0,1e6),r.nearClip=0,r.farClip=2e6,r.orthoHeight=p,this.forwardRenderer.updateCameraFrustum(r),this.cullShadowCasters(e,a.visibleCasters,r);let C=!0;const T=a.visibleCasters;for(let t=0;t<T.length;t++){const e=T[t];C?(C=!1,Ui.copy(e.aabb)):Ui.add(e.aabb)}Ni.copy(o.getWorldTransform()).invert();const M=Bi(Ni,Ui.getMin(),Ui.getMax());o.translateLocal(0,0,M.max+.1),r.farClip=M.max-M.min+.2}}setupRenderState(t,e){const s=this.forwardRenderer.scene.clusteredLightingEnabled;t.webgl2?1!==e._type||s?(t.setDepthBias(!0),t.setDepthBiasValues(-1e3*e.shadowBias,-1e3*e.shadowBias)):t.setDepthBias(!1):t.extStandardDerivatives&&(1===e._type?(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset)):(this.polygonOffset[0]=-1e3*e.shadowBias,this.polygonOffset[1]=-1e3*e.shadowBias,this.polygonOffsetId.setValue(this.polygonOffset))),t.setBlending(!1),t.setDepthWrite(!0),t.setDepthTest(!0),t.setDepthFunc(3);(s?e._isPcf&&t.webgl2:e._isPcf&&t.webgl2&&1!==e._type)?t.setColorWrite(!1,!1,!1,!1):t.setColorWrite(!0,!0,!0,!0)}restoreRenderState(t){t.webgl2?t.setDepthBias(!1):t.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset))}dispatchUniforms(t,e,s,i){const n=e._node;0!==t._type&&(this.forwardRenderer.dispatchViewPos(n.getPosition()),this.shadowMapLightRadiusId.setValue(t.attenuationEnd)),Ni.setTRS(n.getPosition(),n.getRotation(),Vec3.ONE).invert(),Hi.mul2(e.projectionMatrix,Ni);const a=s.shadowViewport;e.rect=a,e.scissorRect=s.shadowScissor,qi.setViewport(a.x,a.y,a.z,a.w),s.shadowMatrix.mul2(qi,Hi),0===t._type&&t._shadowMatrixPalette.set(s.shadowMatrix.data,16*i)}submitCasters(t,e){const s=this.device,i=this.forwardRenderer,n=e._shadowType+6*e._type,a=t.length;for(let r=0;r<a;r++){const e=t[r],a=e.mesh,o=e.material;i.setBaseConstants(s,o),i.setSkinning(s,e,o),o.dirty&&(o.updateUniforms(s,i.scene),o.dirty=!1),o.chunks&&(i.setCullMode(!0,!1,e),o.setParameters(s),e.setParameters(s,8));let l=e._shader[3+n];l||(i.updateShader(e,e._shaderDefs,null,3+n),l=e._shader[3+n],e._key[1]=$i(e)),s.setShader(l),i.setVertexBuffers(s,a),i.setMorphing(s,e.morphInstance);const h=e.renderStyle;s.setIndexBuffer(a.indexBuffer[h]),r+=i.drawInstance(s,e,a,h),i._shadowDrawCalls++}}render(t,e){if(t.enabled&&t.castShadows&&0!==t.shadowUpdateMode&&t.visibleThisFrame){const s=this.device;1===t.shadowUpdateMode&&(t.shadowUpdateMode=0);const i=t._type,n=t._shadowType,a=t.numShadowFaces,r=this.forwardRenderer;r._shadowMapUpdates+=a;const o=r.scene.clusteredLightingEnabled;this.setupRenderState(s,t);for(let l=0;l<a;l++){const a=t.getRenderData(0===i?e:null,l),h=a.shadowCamera;ShadowRenderer.setShadowCameraSettings(h,s,n,i,o);const c=0===i?0:l;h.renderTarget=t._shadowMap.renderTargets[c],this.dispatchUniforms(t,h,a,l),r.setCamera(h,h.renderTarget,!0),this.submitCasters(a.visibleCasters,t)}if(t._isVsm&&t._vsmBlurSize>1){this.forwardRenderer.scene.clusteredLightingEnabled&&0!==i||this.applyVsmBlur(t,e)}this.restoreRenderState(s)}}getVsmBlurShader(t,e,s){let i=(t?this.blurPackedVsmShader:this.blurVsmShader)[e][s];if(!i){this.blurVsmWeights[s]=function(t){t>25&&(t=25);const e=(t-1)/6,s=.5*(t-1),i=new Array(t);let n=0;for(let a=0;a<t;++a)i[a]=zi(a-s,e),n+=i[a];for(let a=0;a<t;++a)i[a]/=n;return i}(s);const n=Zt.fullscreenQuadVS;let a="#define SAMPLES "+s+"\n";a+=t?this.blurPackedVsmShaderCode[e]:this.blurVsmShaderCode[e];const r="blurVsm"+e+s+t;i=he(this.device,n,a,r),t?this.blurPackedVsmShader[e][s]=i:this.blurVsmShader[e][s]=i}return i}applyVsmBlur(t,e){const s=this.device,i=t.getRenderData(0===t._type?e:null,0).shadowCamera.renderTarget,n=this.shadowMapCache.get(s,t),a=n.renderTargets[0],r=1===t._shadowType,o=t.vsmBlurMode,l=t._vsmBlurSize,h=this.getVsmBlurShader(r,o,l);Gi.z=t._shadowResolution-2,Gi.w=Gi.z,this.sourceId.setValue(i.colorBuffer),Wi[0]=1/t._shadowResolution,Wi[1]=0,this.pixelOffsetId.setValue(Wi),1===o&&this.weightId.setValue(this.blurVsmWeights[l]),Kt(s,a,h,null,Gi),this.sourceId.setValue(a.colorBuffer),Wi[1]=Wi[0],Wi[0]=0,this.pixelOffsetId.setValue(Wi),Kt(s,i,h,null,Gi),this.shadowMapCache.add(t,n)}}const Yi=new BoundingSphere;class StaticMeshes{static lightCompare(t,e){return t.key-e.key}static prepare(t,e,s,i){const n=s,a=n.length,r=[],o=new Vec3,l=new Vec3,h=new BoundingBox,c=new Mat4,d=[],u=[],p=[],m=[];for(let _=0;_<a;_++){const e=n[_];if(e.isStatic){const s=e.aabb;m.length=0;for(let t=1;t<=2;t++)for(let n=0;n<i.length;n++){const a=i[n];if(a._type===t&&(a.enabled&&a.mask&e.mask&&a.isStatic)){if(u[n]||(u[n]=new BoundingBox,a._node.getWorldTransform(),a.getBoundingSphere(Yi),u[n].center.copy(Yi.center),u[n].halfExtents.set(Yi.radius,Yi.radius,Yi.radius)),!u[n].intersects(s))continue;m.push(n)}}if(0===m.length){r.push(e);continue}const n=e.mesh,a=n.vertexBuffer,_=n.indexBuffer[e.renderStyle],f=2===_.bytesPerIndex?new Uint16Array(_.lock()):new Uint32Array(_.lock()),g=n.primitive[e.renderStyle].count/3,y=n.primitive[e.renderStyle].base,v=a.format.elements,b=a.format.size/4,x=new Float32Array(a.storage);let S;for(let t=0;t<v.length;t++)v[t].name===ot&&(S=v[t].offset/4);d.length=g;for(let t=0;t<g;t++)d[t]=0;let w=!1;p.length=6*g;for(let t=0;t<g;t++){let e=Number.MAX_VALUE,s=Number.MAX_VALUE,i=Number.MAX_VALUE,n=-Number.MAX_VALUE,a=-Number.MAX_VALUE,r=-Number.MAX_VALUE;for(let l=0;l<3;l++){let o=f[3*t+l+y];o=o*b+S;const h=x[o],c=x[o+1],d=x[o+2];h<e&&(e=h),c<s&&(s=c),d<i&&(i=d),h>n&&(n=h),c>a&&(a=c),d>r&&(r=d)}const o=6*t;p[o]=e,p[o+1]=s,p[o+2]=i,p[o+3]=n,p[o+4]=a,p[o+5]=r}for(let t=0;t<m.length;t++){const s=m[t];c.copy(e.node.worldTransform).invert(),h.setFromTransformedAabb(u[s],c);const i=h.getMin(),n=h.getMax(),a=1<<t;for(let t=0;t<g;t++){const e=6*t;p[e]<=n.x&&p[e+3]>=i.x&&p[e+1]<=n.y&&p[e+4]>=i.y&&p[e+2]<=n.z&&p[e+5]>=i.z&&(d[t]|=a,w=!0)}}if(w){const s={};for(let t=0;t<g;t++){const e=3*t+y,i=d[t];s[i]||(s[i]=[]);const n=s[i];n.push(f[e]),n.push(f[e+1]),n.push(f[e+2])}for(const n in s){const h=s[n],c=new IndexBuffer(t,_.format,h.length,_.usage);(2===c.bytesPerIndex?new Uint16Array(c.lock()):new Uint32Array(c.lock())).set(h),c.unlock();let d=Number.MAX_VALUE,u=Number.MAX_VALUE,p=Number.MAX_VALUE,f=-Number.MAX_VALUE,g=-Number.MAX_VALUE,y=-Number.MAX_VALUE;for(let t=0;t<h.length;t++){const e=h[t],s=x[e*b+S],i=x[e*b+S+1],n=x[e*b+S+2];s<d&&(d=s),i<u&&(u=i),n<p&&(p=n),s>f&&(f=s),i>g&&(g=i),n>y&&(y=n)}o.set(d,u,p),l.set(f,g,y);const v=new BoundingBox;v.setMinMax(o,l);const w=new Mesh(t);w.vertexBuffer=a,w.indexBuffer[0]=c,w.primitive[0].type=4,w.primitive[0].base=0,w.primitive[0].count=h.length,w.primitive[0].indexed=!0,w.aabb=v;const C=new MeshInstance(w,e.material,e.node);C.isStatic=e.isStatic,C.visible=e.visible,C.layer=e.layer,C.castShadow=e.castShadow,C._receiveShadow=e._receiveShadow,C.cull=e.cull,C.pick=e.pick,C.mask=e.mask,C.parameters=e.parameters,C._shaderDefs=e._shaderDefs,C._staticSource=e,e._staticLightList?C._staticLightList=e._staticLightList:C._staticLightList=[];for(let t=0;t<m.length;t++){if(n&1<<t){const e=i[m[t]];C._staticLightList.indexOf(e)<0&&C._staticLightList.push(e)}}C._staticLightList.sort(StaticMeshes.lightCompare),r.push(C)}}else r.push(e)}else r.push(e)}s.length=r.length;for(let _=0;_<r.length;_++)s[_]=r[_]}static revert(t){const e=t,s=e.length,i=[];let n;for(let a=0;a<s;a++){const t=e[a];t._staticSource?t._staticSource!==n&&(i.push(t._staticSource),n=t._staticSource):i.push(t)}t.length=i.length;for(let a=0;a<i.length;a++)t[a]=i[a]}}new Vec3(1,1,1),new Vec3(40,0,0);const Ki=new Mat4,Zi=new Mat4,Qi=new Mat3,Ji=new Mat4;let tn;const en=(new Mat4).setScale(1,-1,1),sn=new Mat4,nn=new Mat4,an=new Mat4,rn=new Mat4,on=new Mat4,ln=new Mat4,hn=new Vec3,cn=new Vec3;let dn,un;const pn=new Mat3,mn=new Mat3,_n=new Mat4,fn=new Mat4,gn=new Vec3,yn=new Vec3,vn=new Vec3,bn=new BoundingSphere,xn=[0,0,0,0];let Sn,wn,Cn,Tn,Mn,An,Pn=null,En=0;const Ln={drawCalls:[],isNewMaterial:[],lightMaskChanged:[]},Rn=new Set;class ForwardRenderer{constructor(t){this.device=t,this.scene=null,this._shadowDrawCalls=0,this._forwardDrawCalls=0,this._skinDrawCalls=0,this._numDrawCallsCulled=0,this._instancedDrawCalls=0,this._camerasRendered=0,this._materialSwitches=0,this._shadowMapUpdates=0,this._shadowMapTime=0,this._depthMapTime=0,this._forwardTime=0,this._cullTime=0,this._sortTime=0,this._skinTime=0,this._morphTime=0,this._instancingTime=0,this._removedByInstancing=0,this._layerCompositionUpdateTime=0,this._lightClustersTime=0,this._lightClusters=0;const e=this.device,s=e.getProgramLibrary();this.library=s,this.lightTextureAtlas=new LightTextureAtlas(e),this._shadowRenderer=new ShadowRenderer(this,this.lightTextureAtlas),this._cookieRenderer=new CookieRenderer(e,this.lightTextureAtlas);const i=e.scope;this.projId=i.resolve("matrix_projection"),this.projSkyboxId=i.resolve("matrix_projectionSkybox"),this.viewId=i.resolve("matrix_view"),this.viewId3=i.resolve("matrix_view3"),this.viewInvId=i.resolve("matrix_viewInverse"),this.viewProjId=i.resolve("matrix_viewProjection"),this.viewPos=new Float32Array(3),this.viewPosId=i.resolve("view_position"),this.nearClipId=i.resolve("camera_near"),this.farClipId=i.resolve("camera_far"),this.cameraParamsId=i.resolve("camera_params"),this.tbnBasis=i.resolve("tbnBasis"),this.fogColorId=i.resolve("fog_color"),this.fogStartId=i.resolve("fog_start"),this.fogEndId=i.resolve("fog_end"),this.fogDensityId=i.resolve("fog_density"),this.modelMatrixId=i.resolve("matrix_model"),this.normalMatrixId=i.resolve("matrix_normal"),this.poseMatrixId=i.resolve("matrix_pose[0]"),this.boneTextureId=i.resolve("texture_poseMap"),this.boneTextureSizeId=i.resolve("texture_poseMapSize"),this.morphWeightsA=i.resolve("morph_weights_a"),this.morphWeightsB=i.resolve("morph_weights_b"),this.morphPositionTex=i.resolve("morphPositionTex"),this.morphNormalTex=i.resolve("morphNormalTex"),this.morphTexParams=i.resolve("morph_tex_params"),this.alphaTestId=i.resolve("alpha_ref"),this.opacityMapId=i.resolve("texture_opacityMap"),this.ambientId=i.resolve("light_globalAmbient"),this.exposureId=i.resolve("exposure"),this.skyboxIntensityId=i.resolve("skyboxIntensity"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.depthMapId=i.resolve("uDepthMap"),this.screenSizeId=i.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.twoSidedLightingNegScaleFactorId=i.resolve("twoSidedLightingNegScaleFactor"),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.cameraParams=new Float32Array(4)}destroy(){this._shadowRenderer.destroy(),this._shadowRenderer=null,this._cookieRenderer.destroy(),this._cookieRenderer=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}sortCompare(t,e){if(t.layer===e.layer){if(t.drawOrder&&e.drawOrder)return t.drawOrder-e.drawOrder;if(t.zdist&&e.zdist)return e.zdist-t.zdist;if(t.zdist2&&e.zdist2)return t.zdist2-e.zdist2}return e._key[0]-t._key[0]}sortCompareMesh(t,e){if(t.layer===e.layer){if(t.drawOrder&&e.drawOrder)return t.drawOrder-e.drawOrder;if(t.zdist&&e.zdist)return e.zdist-t.zdist}return Mn=t._key[0],An=e._key[0],Mn===An&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:An-Mn}depthSortCompare(t,e){return Mn=t._key[1],An=e._key[1],Mn===An&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:An-Mn}updateCameraFrustum(t){if(t.vrDisplay&&t.vrDisplay.presenting){tn=t.vrDisplay.combinedProj;const e=t._node.parent;e?Zi.copy(e.getWorldTransform()).mul(t.vrDisplay.combinedViewInv).invert():Zi.copy(t.vrDisplay.combinedView),Ki.copy(Zi).invert(),this.viewInvId.setValue(Ki.data),Ji.mul2(tn,Zi),t.frustum.setFromMat4(Ji)}else if(t.xr&&t.xr.views.length){const e=t.xr.views[0];return Ji.mul2(e.projMat,e.viewOffMat),void t.frustum.setFromMat4(Ji)}if(tn=t.projectionMatrix,t.calculateProjection&&t.calculateProjection(tn,0),t.calculateTransform)t.calculateTransform(Ki,0);else{const e=t._node.getPosition(),s=t._node.getRotation();Ki.setTRS(e,s,Vec3.ONE),this.viewInvId.setValue(Ki.data)}Zi.copy(Ki).invert(),Ji.mul2(tn,Zi),t.frustum.setFromMat4(Ji)}setCamera(t,e,s){const i=t.vrDisplay;let n;if(i&&i.presenting){if(dn=i.leftProj,un=i.rightProj,tn=i.combinedProj,t.calculateProjection&&(t.calculateProjection(dn,1),t.calculateProjection(un,2),t.calculateProjection(tn,0)),t.calculateTransform)t.calculateTransform(an,1),t.calculateTransform(rn,2),t.calculateTransform(Ki,0),on.copy(an).invert(),ln.copy(rn).invert(),Zi.copy(Ki).invert();else{const e=t._node.parent;e?(n=e.getWorldTransform(),an.mul2(n,i.leftViewInv),rn.mul2(n,i.rightViewInv),on.copy(an).invert(),ln.copy(rn).invert(),Zi.copy(e.getWorldTransform()).mul(i.combinedViewInv).invert()):(an.copy(i.leftViewInv),rn.copy(i.rightViewInv),on.copy(i.leftView),ln.copy(i.rightView),Zi.copy(i.combinedView))}pn.setFromMat4(on),mn.setFromMat4(ln),_n.mul2(dn,on),fn.mul2(un,ln),hn.x=an.data[12],hn.y=an.data[13],hn.z=an.data[14],cn.x=rn.data[12],cn.y=rn.data[13],cn.z=rn.data[14],Ji.mul2(tn,Zi),t.frustum.setFromMat4(Ji)}else if(t.xr&&t.xr.session){const e=t._node.parent;e&&(n=e.getWorldTransform());const s=t.xr.views;for(let i=0;i<s.length;i++){const a=s[i];e?(a.viewInvOffMat.mul2(n,a.viewInvMat),a.viewOffMat.copy(a.viewInvOffMat).invert()):(a.viewInvOffMat.copy(a.viewInvMat),a.viewOffMat.copy(a.viewMat)),a.viewMat3.setFromMat4(a.viewOffMat),a.projViewOffMat.mul2(a.projMat,a.viewOffMat),a.position[0]=a.viewInvOffMat.data[12],a.position[1]=a.viewInvOffMat.data[13],a.position[2]=a.viewInvOffMat.data[14],t.frustum.setFromMat4(a.projViewOffMat)}}else{if(tn=t.projectionMatrix,t.calculateProjection&&t.calculateProjection(tn,0),this.projId.setValue(tn.data),this.projSkyboxId.setValue(t.getProjectionMatrixSkybox().data),t.calculateTransform)t.calculateTransform(Ki,0);else{const e=t._node.getPosition(),s=t._node.getRotation();Ki.setTRS(e,s,Vec3.ONE)}this.viewInvId.setValue(Ki.data),Zi.copy(Ki).invert(),this.viewId.setValue(Zi.data),Qi.setFromMat4(Zi),this.viewId3.setValue(Qi.data),Ji.mul2(tn,Zi),e&&e.flipY?(sn.mul2(en,Ji),nn.mul2(en,t.getProjectionMatrixSkybox()),this.viewProjId.setValue(sn.data),this.projSkyboxId.setValue(nn.data)):(this.viewProjId.setValue(Ji.data),this.projSkyboxId.setValue(t.getProjectionMatrixSkybox().data)),this.dispatchViewPos(t._node.getPosition()),t.frustum.setFromMat4(Ji)}this.tbnBasis.setValue(e&&e.flipY?-1:1),this.nearClipId.setValue(t._nearClip),this.farClipId.setValue(t._farClip);const a=t._nearClip,r=t._farClip;this.cameraParams[0]=1/r,this.cameraParams[1]=r,this.cameraParams[2]=.5*(1-r/a),this.cameraParams[3]=.5*(1+r/a),this.cameraParamsId.setValue(this.cameraParams),this.clearView(t,e,s,!1)}clearView(t,e,s,i,n){const a=this.device;a.setRenderTarget(e),a.updateBegin(),i&&(a.setColorWrite(!0,!0,!0,!0),a.setDepthWrite(!0));const r=e?e.width:a.width,o=e?e.height:a.height,l=t.rect;let h=Math.floor(l.x*r),c=Math.floor(l.y*o),d=Math.floor(l.z*r),u=Math.floor(l.w*o);if(a.setViewport(h,c,d,u),t._scissorRectClear){const e=t.scissorRect;h=Math.floor(e.x*r),c=Math.floor(e.y*o),d=Math.floor(e.z*r),u=Math.floor(e.w*o)}a.setScissor(h,c,d,u),s&&(n||(n=t._clearOptions),a.clear(n||{color:[t._clearColor.r,t._clearColor.g,t._clearColor.b,t._clearColor.a],depth:t._clearDepth,flags:(t._clearColorBuffer?1:0)|(t._clearDepthBuffer?2:0)|(t._clearStencilBuffer?4:0),stencil:t._clearStencil}))}dispatchGlobalLights(t){if(this.ambientColor[0]=t.ambientLight.r,this.ambientColor[1]=t.ambientLight.g,this.ambientColor[2]=t.ambientLight.b,t.gammaCorrection)for(let e=0;e<3;e++)this.ambientColor[e]=Math.pow(this.ambientColor[e],2.2);this.ambientId.setValue(this.ambientColor),this.exposureId.setValue(t.exposure),t.skyboxModel&&this.skyboxIntensityId.setValue(t.skyboxIntensity)}_resolveLight(t,e){const s="light"+e;this.lightColorId[e]=t.resolve(s+"_color"),this.lightDir[e]=new Float32Array(3),this.lightDirId[e]=t.resolve(s+"_direction"),this.lightShadowMapId[e]=t.resolve(s+"_shadowMap"),this.lightShadowMatrixId[e]=t.resolve(s+"_shadowMatrix"),this.lightShadowParamsId[e]=t.resolve(s+"_shadowParams"),this.lightRadiusId[e]=t.resolve(s+"_radius"),this.lightPos[e]=new Float32Array(3),this.lightPosId[e]=t.resolve(s+"_position"),this.lightWidth[e]=new Float32Array(3),this.lightWidthId[e]=t.resolve(s+"_halfWidth"),this.lightHeight[e]=new Float32Array(3),this.lightHeightId[e]=t.resolve(s+"_halfHeight"),this.lightInAngleId[e]=t.resolve(s+"_innerConeAngle"),this.lightOutAngleId[e]=t.resolve(s+"_outerConeAngle"),this.lightCookieId[e]=t.resolve(s+"_cookie"),this.lightCookieIntId[e]=t.resolve(s+"_cookieIntensity"),this.lightCookieMatrixId[e]=t.resolve(s+"_cookieMatrix"),this.lightCookieOffsetId[e]=t.resolve(s+"_cookieOffset"),this.shadowMatrixPaletteId[e]=t.resolve(s+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[e]=t.resolve(s+"_shadowCascadeDistances[0]"),this.shadowCascadeCountId[e]=t.resolve(s+"_shadowCascadeCount")}setLTCDirectionallLight(t,e,s,i,n){this.lightPos[e][0]=i.x-s.x*n,this.lightPos[e][1]=i.y-s.y*n,this.lightPos[e][2]=i.z-s.z*n,this.lightPosId[e].setValue(this.lightPos[e]);const a=t.transformVector(new Vec3(-.5,0,0));this.lightWidth[e][0]=a.x*n,this.lightWidth[e][1]=a.y*n,this.lightWidth[e][2]=a.z*n,this.lightWidthId[e].setValue(this.lightWidth[e]);const r=t.transformVector(new Vec3(0,0,.5));this.lightHeight[e][0]=r.x*n,this.lightHeight[e][1]=r.y*n,this.lightHeight[e][2]=r.z*n,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchDirectLights(t,e,s,i){let n=0;const a=this.device.scope;for(let r=0;r<t.length;r++){if(!(t[r].mask&s))continue;const o=t[r],l=o._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(a,n),this.lightColorId[n].setValue(e.gammaCorrection?o._linearFinalColor:o._finalColor),l.getY(o._direction).mulScalar(-1),o._direction.normalize(),this.lightDir[n][0]=o._direction.x,this.lightDir[n][1]=o._direction.y,this.lightDir[n][2]=o._direction.z,this.lightDirId[n].setValue(this.lightDir[n]),0!==o.shape&&this.setLTCDirectionallLight(l,n,o._direction,i._node.getPosition(),i.farClip),o.castShadows){const t=o.getRenderData(i,0),e=o._getUniformBiasValues(t);this.lightShadowMapId[n].setValue(t.shadowBuffer),this.lightShadowMatrixId[n].setValue(t.shadowMatrix.data),this.shadowMatrixPaletteId[n].setValue(o._shadowMatrixPalette),this.shadowCascadeDistancesId[n].setValue(o._shadowCascadeDistances),this.shadowCascadeCountId[n].setValue(o.numCascades);const s=o._shadowRenderParams;s.length=3,s[0]=o._shadowResolution,s[1]=e.normalBias,s[2]=e.bias,this.lightShadowParamsId[n].setValue(s)}n++}return n}setLTCPositionalLight(t,e){const s=t.transformVector(new Vec3(-.5,0,0));this.lightWidth[e][0]=s.x,this.lightWidth[e][1]=s.y,this.lightWidth[e][2]=s.z,this.lightWidthId[e].setValue(this.lightWidth[e]);const i=t.transformVector(new Vec3(0,0,.5));this.lightHeight[e][0]=i.x,this.lightHeight[e][1]=i.y,this.lightHeight[e][2]=i.z,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchOmniLight(t,e,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(t.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==s.shape&&this.setLTCPositionalLight(n,i),s.castShadows){const t=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(t.shadowBuffer);const e=s._getUniformBiasValues(t),n=s._shadowRenderParams;n.length=4,n[0]=s._shadowResolution,n[1]=e.normalBias,n[2]=e.bias,n[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(n)}s._cookie&&(this.lightCookieId[i].setValue(s._cookie),this.lightShadowMatrixId[i].setValue(n.data),this.lightCookieIntId[i].setValue(s.cookieIntensity))}dispatchSpotLight(t,e,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightInAngleId[i].setValue(s._innerConeAngleCos),this.lightOutAngleId[i].setValue(s._outerConeAngleCos),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(t.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==s.shape&&this.setLTCPositionalLight(n,i),n.getY(s._direction).mulScalar(-1),s._direction.normalize(),this.lightDir[i][0]=s._direction.x,this.lightDir[i][1]=s._direction.y,this.lightDir[i][2]=s._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),s.castShadows){const t=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(t.shadowBuffer),this.lightShadowMatrixId[i].setValue(t.shadowMatrix.data);const e=s._getUniformBiasValues(t),n=s._shadowRenderParams;n.length=4,n[0]=s._shadowResolution,n[1]=e.normalBias,n[2]=e.bias,n[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(n)}if(s._cookie){if(!s.castShadows){const t=LightCamera.evalSpotCookieMatrix(s);this.lightShadowMatrixId[i].setValue(t.data)}this.lightCookieId[i].setValue(s._cookie),this.lightCookieIntId[i].setValue(s.cookieIntensity),s._cookieTransform&&(s._cookieTransformUniform[0]=s._cookieTransform.x,s._cookieTransformUniform[1]=s._cookieTransform.y,s._cookieTransformUniform[2]=s._cookieTransform.z,s._cookieTransformUniform[3]=s._cookieTransform.w,this.lightCookieMatrixId[i].setValue(s._cookieTransformUniform),s._cookieOffsetUniform[0]=s._cookieOffset.x,s._cookieOffsetUniform[1]=s._cookieOffset.y,this.lightCookieOffsetId[i].setValue(s._cookieOffsetUniform))}}dispatchLocalLights(t,e,s,i,n){let a=i;const r=this.device.scope,o=t[1],l=o.length;for(let u=0;u<l;u++){const t=o[u];t.mask&s&&(t.isStatic||(this.dispatchOmniLight(e,r,t,a),a++))}let h=0;if(n){let t=n[h];for(;t&&1===t._type;)this.dispatchOmniLight(e,r,t,a),a++,h++,t=n[h]}const c=t[2],d=c.length;for(let u=0;u<d;u++){const t=c[u];t.mask&s&&(t.isStatic||(this.dispatchSpotLight(e,r,t,a),a++))}if(n){let t=n[h];for(;t&&2===t._type;)this.dispatchSpotLight(e,r,t,a),a++,h++,t=n[h]}}cull(t,e,s){let i=0;const n=e.length,a=t.cullingMask||4294967295;if(!t.frustumCulling){for(let t=0;t<n;t++){const n=e[t];(n.visible||n.command)&&(n.mask&&0==(n.mask&a)||(s[i]=n,i++,n.visibleThisFrame=!0))}return i}for(let r=0;r<n;r++){const n=e[r];if(n.command)s[i]=n,i++,n.visibleThisFrame=!0;else{if(!n.visible)continue;let e=!0;if(n.mask&&0==(n.mask&a))continue;n.cull&&(e=n._isVisible(t)),e&&(s[i]=n,i++,n.visibleThisFrame=!0)}}return i}cullLights(t,e){const s=this.scene.clusteredLightingEnabled;for(let i=0;i<e.length;i++){const n=e[i];if(n.enabled&&0!==n._type)if(n.getBoundingSphere(bn),t.frustum.containsSphere(bn)){n.visibleThisFrame=!0;const e=t.getScreenSize(bn);n.maxScreenSize=Math.max(n.maxScreenSize,e)}else s||n.castShadows&&!n.shadowMap&&(n.visibleThisFrame=!0)}}updateCpuSkinMatrices(t){En++;const e=t.length;if(0!==e)for(let s=0;s<e;s++){const e=t[s].skinInstance;e&&(e.updateMatrices(t[s].node,En),e._dirty=!0)}}updateGpuSkinMatrices(t){const e=t.length;for(let s=0;s<e;s++){if(!t[s].visibleThisFrame)continue;const e=t[s].skinInstance;e&&e._dirty&&(e.updateMatrixPalette(t[s].node,En),e._dirty=!1)}}updateMorphing(t){const e=t.length;for(let s=0;s<e;s++){const e=t[s].morphInstance;e&&e._dirty&&t[s].visibleThisFrame&&e.update()}}setBaseConstants(t,e){t.setCullMode(e.cull),e.opacityMap&&(this.opacityMapId.setValue(e.opacityMap),this.alphaTestId.setValue(e.alphaTest))}setSkinning(t,e,s){e.skinInstance&&(this._skinDrawCalls++,t.supportsBoneTextures?(Sn=e.skinInstance.boneTexture,this.boneTextureId.setValue(Sn),xn[0]=Sn.width,xn[1]=Sn.height,xn[2]=1/Sn.width,xn[3]=1/Sn.height,this.boneTextureSizeId.setValue(xn)):this.poseMatrixId.setValue(e.skinInstance.matrixPalette))}drawInstance(t,e,s,i,n){if(wn=e.instancingData,wn){if(wn.count>0&&(this._instancedDrawCalls++,t.setVertexBuffer(wn.vertexBuffer),t.draw(s.primitive[i],wn.count),wn.vertexBuffer===Pn))return this._removedByInstancing+=wn.count,e.instancingData=null,wn.count-1}else Cn=e.node.worldTransform,this.modelMatrixId.setValue(Cn.data),n&&(Tn=e.node.normalMatrix,e.node._dirtyNormal&&(Cn.invertTo3x3(Tn),Tn.transpose(),e.node._dirtyNormal=!1),this.normalMatrixId.setValue(Tn.data)),t.draw(s.primitive[i]);return 0}drawInstance2(t,e,s,i){if(wn=e.instancingData,wn){if(wn.count>0&&(this._instancedDrawCalls++,t.draw(s.primitive[i],wn.count,!0),wn.vertexBuffer===Pn))return this._removedByInstancing+=wn.count,e.instancingData=null,wn.count-1}else t.draw(s.primitive[i],void 0,!0);return 0}renderShadows(t,e){const s=this.scene.clusteredLightingEnabled,i=this.device;i.grabPassAvailable=!1;for(let n=0;n<t.length;n++){const i=t[n];if(s&&0!==i._type){if(!i.atlasViewportAllocated)continue;i.atlasSlotUpdated&&0===i.shadowUpdateMode&&(i.shadowUpdateMode=1)}this._shadowRenderer.render(i,e)}i.grabPassAvailable=!0}renderCookies(t){const e=this.lightTextureAtlas.cookieRenderTarget;for(let s=0;s<t.length;s++){const i=t[s];i.atlasViewportAllocated&&(i.atlasSlotUpdated&&this._cookieRenderer.render(i,e))}}updateShader(t,e,s,i,n){t.material._scene=this.scene,t.material._dirtyBlend&&(this.scene.layers._dirtyBlend=!0),t.material.updateShader(this.device,this.scene,e,s,i,n),t._shader[i]=t.material.shader}setCullMode(t,e,s){const i=s.material;let n=0;if(t){let t=1;if(i.cull>0&&i.cull<3){s.flipFaces&&(t*=-1),e&&(t*=-1);const i=s.node.worldTransform;i.getX(gn),i.getY(yn),i.getZ(vn),gn.cross(gn,yn),gn.dot(vn)<0&&(t*=-1)}n=t<0?2===i.cull?1:2:i.cull}if(this.device.setCullMode(n),0===n&&0===i.cull){const t=s.node.worldTransform;t.getX(gn),t.getY(yn),t.getZ(vn),gn.cross(gn,yn),gn.dot(vn)<0?this.twoSidedLightingNegScaleFactorId.setValue(-1):this.twoSidedLightingNegScaleFactorId.setValue(1)}}setVertexBuffers(t,e){t.setVertexBuffer(e.vertexBuffer)}setMorphing(t,e){if(e)if(e.morph.useTextureMorph)t.setVertexBuffer(e.morph.vertexBufferIds),this.morphPositionTex.setValue(e.texturePositions),this.morphNormalTex.setValue(e.textureNormals),this.morphTexParams.setValue(e._textureParams);else{for(let s=0;s<e._activeVertexBuffers.length;s++){const i=e._activeVertexBuffers[s];if(i){const e="ATTR"+(s+8);i.format.elements[0].name=e,i.format.elements[0].scopeId=t.scope.resolve(e),i.format.update(),t.setVertexBuffer(i)}}this.morphWeightsA.setValue(e._shaderMorphWeightsA),this.morphWeightsB.setValue(e._shaderMorphWeightsB)}}dispatchViewPos(t){const e=this.viewPos;e[0]=t.x,e[1]=t.y,e[2]=t.z,this.viewPosId.setValue(e)}renderForwardPrepareMaterials(t,e,s,i,n,a,r){const o=(t,e,s)=>{Ln.drawCalls.push(t),Ln.isNewMaterial.push(e),Ln.lightMaskChanged.push(s)};Ln.drawCalls.length=0,Ln.isNewMaterial.length=0,Ln.lightMaskChanged.length=0;const l=this.device,h=this.scene,c=a?a._lightHash:0;let d,u,p,m=null;for(let _=0;_<s;_++){const t=e[_];if(!n||!t.mask||n&t.mask)if(t.command)o(t,!1,!1);else{t.material||(t.material=DefaultMaterial.get(l));const e=t.material,s=t._shaderDefs,n=t.mask;if(e&&e===m&&s!==d&&(m=null),(t.isStatic||u)&&(m=null),e!==m&&(this._materialSwitches++,e.dirty&&(e.updateUniforms(l,h),e.dirty=!1),!t._shader[r]||t._shaderDefs!==s||t._lightHash!==c)){if(t.isStatic)this.updateShader(t,s,t._staticLightList,r,i);else{const n=r+"_"+s+"_"+c;t._shader[r]=e.variants[n],t._shader[r]||(this.updateShader(t,s,null,r,i),e.variants[n]=t._shader[r])}t._shaderDefs=s,t._lightHash=c}o(t,e!==m,!m||n!==p),m=e,d=s,p=n,u=t.isStatic}}return Ln}renderForward(t,e,s,i,n,a,r,o,l){const h=this.device,c=this.scene,d=t.vrDisplay,u=1<<n,p=.5*h.width,m=this.renderForwardPrepareMaterials(t,e,s,i,a,o,n),_=m.drawCalls.length;for(let f=0;f<_;f++){const e=m.drawCalls[f];if(e.command)e.command();else{const s=m.isNewMaterial[f],a=m.lightMaskChanged[f],o=e.material;e._shaderDefs;const g=e.mask;if(s){const s=e._shader[n];if(s.failed||h.setShader(s)||(s.failed=!0),o.setParameters(h),a){const s=this.dispatchDirectLights(i[0],c,g,t);this.dispatchLocalLights(i,c,g,s,e._staticLightList)}this.alphaTestId.setValue(o.alphaTest),h.setBlending(o.blend),o.blend&&(o.separateAlphaBlend?(h.setBlendFunctionSeparate(o.blendSrc,o.blendDst,o.blendSrcAlpha,o.blendDstAlpha),h.setBlendEquationSeparate(o.blendEquation,o.blendAlphaEquation)):(h.setBlendFunction(o.blendSrc,o.blendDst),h.setBlendEquation(o.blendEquation))),h.setColorWrite(o.redWrite,o.greenWrite,o.blueWrite,o.alphaWrite),h.setDepthWrite(o.depthWrite),o.depthWrite&&!o.depthTest?(h.setDepthFunc(7),h.setDepthTest(!0)):(h.setDepthFunc(3),h.setDepthTest(o.depthTest)),h.setAlphaToCoverage(o.alphaToCoverage),o.depthBias||o.slopeDepthBias?(h.setDepthBias(!0),h.setDepthBiasValues(o.depthBias,o.slopeDepthBias)):h.setDepthBias(!1)}this.setCullMode(t._cullFaces,l,e);const y=e.stencilFront||o.stencilFront,v=e.stencilBack||o.stencilBack;y||v?(h.setStencilTest(!0),y===v?(h.setStencilFunc(y.func,y.ref,y.readMask),h.setStencilOperation(y.fail,y.zfail,y.zpass,y.writeMask)):(y?(h.setStencilFuncFront(y.func,y.ref,y.readMask),h.setStencilOperationFront(y.fail,y.zfail,y.zpass,y.writeMask)):(h.setStencilFuncFront(7,0,255),h.setStencilOperationFront(0,0,0,255)),v?(h.setStencilFuncBack(v.func,v.ref,v.readMask),h.setStencilOperationBack(v.fail,v.zfail,v.zpass,v.writeMask)):(h.setStencilFuncBack(7,0,255),h.setStencilOperationBack(0,0,0,255)))):h.setStencilTest(!1);const b=e.mesh;e.setParameters(h,u),this.setVertexBuffers(h,b),this.setMorphing(h,e.morphInstance),this.setSkinning(h,e,o);const x=e.renderStyle;if(h.setIndexBuffer(b.indexBuffer[x]),r&&r(e,f),d&&d.presenting)h.setViewport(0,0,p,h.height),this.projId.setValue(dn.data),this.projSkyboxId.setValue(dn.data),this.viewInvId.setValue(an.data),this.viewId.setValue(on.data),this.viewId3.setValue(pn.data),this.viewProjId.setValue(_n.data),this.dispatchViewPos(hn),f+=this.drawInstance(h,e,b,x,!0),this._forwardDrawCalls++,h.setViewport(p,0,p,h.height),this.projId.setValue(un.data),this.projSkyboxId.setValue(un.data),this.viewInvId.setValue(rn.data),this.viewId.setValue(ln.data),this.viewId3.setValue(mn.data),this.viewProjId.setValue(fn.data),this.dispatchViewPos(cn),f+=this.drawInstance2(h,e,b,x),this._forwardDrawCalls++;else if(t.xr&&t.xr.session&&t.xr.views.length){const s=t.xr.views;for(let t=0;t<s.length;t++){const i=s[t];h.setViewport(i.viewport.x,i.viewport.y,i.viewport.z,i.viewport.w),this.projId.setValue(i.projMat.data),this.projSkyboxId.setValue(i.projMat.data),this.viewId.setValue(i.viewOffMat.data),this.viewInvId.setValue(i.viewInvOffMat.data),this.viewId3.setValue(i.viewMat3.data),this.viewProjId.setValue(i.projViewOffMat.data),this.viewPosId.setValue(i.position),f+=0===t?this.drawInstance(h,e,b,x,!0):this.drawInstance2(h,e,b,x),this._forwardDrawCalls++}}else f+=this.drawInstance(h,e,b,x,!0),this._forwardDrawCalls++;f<_-1&&!m.isNewMaterial[f+1]&&o.setParameters(h,e.parameters)}}h.updateEnd(),Ln.length=0}setupInstancing(t){t.enableAutoInstancing&&(Pn||(Pn=new VertexBuffer(t,VertexFormat.defaultInstancingFormat,t.autoInstancingMaxObjects,1)))}updateShaders(t,e){const s=t.length;for(let i=0;i<s;i++){const s=t[i].material;if(s&&!Rn.has(s)&&(Rn.add(s),s.updateShader!==Material$1.prototype.updateShader)){if(e&&(!s.useLighting||s.emitter&&!s.emitter.lighting))continue;s.clearVariants(),s.shader=null}}Rn.clear()}beginFrame(t,e){const s=t._meshInstances,i=this.scene;if(i.updateShaders||e){const t=!i.updateShaders&&e;this.updateShaders(s,t),i.updateShaders=!1,i._shaderVersion++}this.updateCpuSkinMatrices(s);const n=s.length;for(let o=0;o<n;o++)s[o].visibleThisFrame=!1;const a=t._lights,r=a.length;for(let o=0;o<r;o++)a[o].beginFrame()}beginLayers(t){const e=t.layerList.length;for(let n=0;n<e;n++)t.layerList[n]._postRenderCounter=0;const s=this.scene,i=s._shaderVersion;for(let n=0;n<e;n++){const e=t.layerList[n];e._shaderVersion=i,e._preRenderCalledForCameras=0,e._postRenderCalledForCameras=0;const a=t.subLayerList[n];e._postRenderCounter|=a?2:1,e._postRenderCounterMax=e._postRenderCounter;for(let t=0;t<e.cameras.length;t++)e.instances.prepare(t);e._needsStaticPrepare&&e._staticLightHash&&!this.scene.clusteredLightingEnabled&&(e._staticPrepareDone&&(StaticMeshes.revert(e.opaqueMeshInstances),StaticMeshes.revert(e.transparentMeshInstances)),StaticMeshes.prepare(this.device,s,e.opaqueMeshInstances,e._lights),StaticMeshes.prepare(this.device,s,e.transparentMeshInstances,e._lights),t._dirty=!0,s.updateShaders=!0,e._needsStaticPrepare=!1,e._staticPrepareDone=!0)}}gpuUpdate(t){this.updateGpuSkinMatrices(t),this.updateMorphing(t)}setSceneConstants(){const t=this.scene;if(this.dispatchGlobalLights(t),t.fog!==K){if(this.fogColor[0]=t.fogColor.r,this.fogColor[1]=t.fogColor.g,this.fogColor[2]=t.fogColor.b,t.gammaCorrection)for(let t=0;t<3;t++)this.fogColor[t]=Math.pow(this.fogColor[t],2.2);this.fogColorId.setValue(this.fogColor),"linear"===t.fog?(this.fogStartId.setValue(t.fogStart),this.fogEndId.setValue(t.fogEnd)):this.fogDensityId.setValue(t.fogDensity)}const e=this.device;this._screenSize[0]=e.width,this._screenSize[1]=e.height,this._screenSize[2]=1/e.width,this._screenSize[3]=1/e.height,this.screenSizeId.setValue(this._screenSize)}updateLightStats(t,e){}cullShadowmaps(t){for(let s=0;s<t._lights.length;s++){const e=t._lights[s];if(0!==e._type&&e.visibleThisFrame&&e.castShadows&&0!==e.shadowUpdateMode){const i=t._lightCompositionData[s].shadowCastersList;this._shadowRenderer.cullLocal(e,i)}}const e=t._renderActions;for(let s=0;s<e.length;s++){const i=e[s],n=i.directionalLightsIndices.length;for(let e=0;e<n;e++){const s=i.directionalLightsIndices[e],n=t._lights[s],a=t._lightCompositionData[s].shadowCastersList;this._shadowRenderer.cullDirectional(n,a,i.camera.camera)}}}cullComposition(t){const e=t._renderActions;for(let s=0;s<e.length;s++){const i=e[s],n=i.layerIndex,a=t.layerList[n];if(!a.enabled||!t.subLayerEnabled[n])continue;const r=t.subLayerList[n],o=i.cameraIndex,l=a.cameras[o];if(l){l.frameBegin(i.renderTarget),i.firstCameraUse&&(this.updateCameraFrustum(l.camera),this._camerasRendered++),this.cullLights(l.camera,a._lights);const t=a.instances,e=r?t.visibleTransparent[o]:t.visibleOpaque[o];if(!e.done){a.onPreCull&&a.onPreCull(o);const t=r?a.transparentMeshInstances:a.opaqueMeshInstances;e.length=this.cull(l.camera,t,e.list),e.done=!0,a.onPostCull&&a.onPostCull(o)}l.frameEnd()}}this.cullShadowmaps(t)}updateLightTextureAtlas(t){this.lightTextureAtlas.update(t._splitLights[2],t._splitLights[1],this.scene.lighting)}updateClusters(t){for(let e=0;e<t._worldClusters.length;e++){t._worldClusters[e].update(t._lights,this.scene.gammaCorrection,this.scene.lighting)}}renderComposition(t){const e=this.device,s=this.scene.clusteredLightingEnabled;this.scene._updateSkybox(this.device),this.beginLayers(t);const i=t._update(e,s),n=0!=(2&i);this.updateLightStats(t,i),this.beginFrame(t,n),this.setSceneConstants(),this.cullComposition(t),this.gpuUpdate(t._meshInstances),s&&(this.updateLightTextureAtlas(t),this.scene.lighting.cookiesEnabled&&(this.renderCookies(t._splitLights[2]),this.renderCookies(t._splitLights[1]))),(!s||s&&this.scene.lighting.shadowsEnabled)&&(this.renderShadows(t._splitLights[2]),this.renderShadows(t._splitLights[1])),s&&this.updateClusters(t);let a=!1;const r=t._renderActions;for(let l=0;l<r.length;l++){const i=r[l],n=i.layerIndex,h=t.layerList[n],c=t.subLayerList[n],d=i.cameraIndex,u=h.cameras[d];if(i.directionalLights.length>0&&this.renderShadows(i.directionalLights,u.camera),h.enabled&&t.subLayerEnabled[n]){if(u&&(u.frameBegin(i.renderTarget),i.firstCameraUse&&u.onPreRender&&u.onPreRender()),!c&&h.onPreRenderOpaque?h.onPreRenderOpaque(d):c&&h.onPreRenderTransparent&&h.onPreRenderTransparent(d),h._preRenderCalledForCameras&1<<d||(h.onPreRender&&h.onPreRender(d),h._preRenderCalledForCameras|=1<<d),u){var o;if(i.clearColor||i.clearDepth||i.clearStencil){const t=u.camera._clearColorBuffer,e=u.camera._clearDepthBuffer,s=u.camera._clearStencilBuffer;u.camera._clearColorBuffer=i.clearColor,u.camera._clearDepthBuffer=i.clearDepth,u.camera._clearStencilBuffer=i.clearStencil,this.clearView(u.camera,i.renderTarget,!0,!0),u.camera._clearColorBuffer=t,u.camera._clearDepthBuffer=e,u.camera._clearStencilBuffer=s}h._sortVisible(c,u.camera.node,d);const t=h.instances,n=c?t.visibleTransparent[d]:t.visibleOpaque[d];this.scene.immediate.onPreRenderLayer(h,n,c),this.scene._activeCamera=u.camera,this.setCamera(u.camera,i.renderTarget),s&&i.lightClusters&&(i.lightClusters.activate(this.lightTextureAtlas),a||this.scene.lighting.debugLayer!==h.id||(a=!0));const r=!!(u.camera._flipFaces^(null==i||null==(o=i.renderTarget)?void 0:o.flipY)),l=this._forwardDrawCalls;this.renderForward(u.camera,n.list,n.length,h._splitLights,h.shaderPass,h.cullingMask,h.onDrawCall,h,r),h._forwardDrawCalls+=this._forwardDrawCalls-l,e.setColorWrite(!0,!0,!0,!0),e.setStencilTest(!1),e.setAlphaToCoverage(!1),e.setDepthBias(!1),u.frameEnd(),i.lastCameraUse&&u.onPostRender&&u.onPostRender(),i.triggerPostprocess&&u.onPostprocessing&&u.onPostprocessing()}!c&&h.onPostRenderOpaque?h.onPostRenderOpaque(d):c&&h.onPostRenderTransparent&&h.onPostRenderTransparent(d),!h.onPostRender||h._postRenderCalledForCameras&1<<d||(h._postRenderCounter&=~(c?2:1),0===h._postRenderCounter&&(h.onPostRender(d),h._postRenderCalledForCameras|=1<<d,h._postRenderCounter=h._postRenderCounterMax))}}}}let In,Dn,kn,Fn;const On=[null,function(t,e){return t.drawOrder-e.drawOrder},function(t,e){return In=t._key[0],Dn=e._key[0],In===Dn&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:Dn-In},function(t,e){return e.zdist-t.zdist},function(t,e){return t.zdist-e.zdist}];function Vn(t,e){return e.key-t.key}let Bn=0;class VisibleInstanceList{constructor(){this.list=[],this.length=0,this.done=!1}}class InstanceList{constructor(){this.opaqueMeshInstances=[],this.transparentMeshInstances=[],this.shadowCasters=[],this.visibleOpaque=[],this.visibleTransparent=[]}prepare(t){this.visibleOpaque[t]||(this.visibleOpaque[t]=new VisibleInstanceList),this.visibleTransparent[t]||(this.visibleTransparent[t]=new VisibleInstanceList),this.visibleOpaque[t].done=!1,this.visibleTransparent[t].done=!1}delete(t){t<this.visibleOpaque.length&&this.visibleOpaque.splice(t,1),t<this.visibleTransparent.length&&this.visibleTransparent.splice(t,1)}}class Layer{constructor(t={}){void 0!==t.id?(this.id=t.id,Bn=Math.max(this.id+1,Bn)):this.id=Bn++,this.name=t.name,this._enabled=void 0===t.enabled||t.enabled,this._refCounter=this._enabled?1:0,this.opaqueSortMode=void 0===t.opaqueSortMode?2:t.opaqueSortMode,this.transparentSortMode=void 0===t.transparentSortMode?3:t.transparentSortMode,this.renderTarget=t.renderTarget,this.shaderPass=void 0===t.shaderPass?0:t.shaderPass,this.passThrough=void 0!==t.passThrough&&t.passThrough,this._clearColorBuffer=!!t.clearColorBuffer&&t.clearColorBuffer,this._clearDepthBuffer=!!t.clearDepthBuffer&&t.clearDepthBuffer,this._clearStencilBuffer=!!t.clearStencilBuffer&&t.clearStencilBuffer,this.onPreCull=t.onPreCull,this.onPreRender=t.onPreRender,this.onPreRenderOpaque=t.onPreRenderOpaque,this.onPreRenderTransparent=t.onPreRenderTransparent,this.onPostCull=t.onPostCull,this.onPostRender=t.onPostRender,this.onPostRenderOpaque=t.onPostRenderOpaque,this.onPostRenderTransparent=t.onPostRenderTransparent,this.onDrawCall=t.onDrawCall,this.onEnable=t.onEnable,this.onDisable=t.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.layerReference=t.layerReference,this.instances=t.layerReference?t.layerReference.instances:new InstanceList,this.cullingMask=t.cullingMask?t.cullingMask:4294967295,this.opaqueMeshInstances=this.instances.opaqueMeshInstances,this.transparentMeshInstances=this.instances.transparentMeshInstances,this.shadowCasters=this.instances.shadowCasters,this.customSortCallback=null,this.customCalculateSortValues=null,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this.cameras=[],this._dirty=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._lightHash=0,this._staticLightHash=0,this._needsStaticPrepare=!0,this._staticPrepareDone=!1,this._shaderVersion=-1,this._lightCube=null}set renderTarget(t){this._renderTarget=t,this._dirtyCameras=!0}get renderTarget(){return this._renderTarget}set enabled(t){t!==this._enabled&&(this._enabled=t,t?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColor(t){this._clearColor.copy(t)}get clearColor(){return this._clearColor}set clearColorBuffer(t){this._clearColorBuffer=t,this._dirtyCameras=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(t){this._clearDepthBuffer=t,this._dirtyCameras=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(t){this._clearStencilBuffer=t,this._dirtyCameras=!0}get clearStencilBuffer(){return this._clearStencilBuffer}incrementCounter(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--}addMeshInstances(t,e){const s=this._shaderVersion,i=this.shadowCasters;for(let n=0;n<t.length;n++){const a=t[n],r=a.material,o=3===r.blendType?this.opaqueMeshInstances:this.transparentMeshInstances;this.opaqueMeshInstances.indexOf(a)<0&&this.transparentMeshInstances.indexOf(a)<0&&o.push(a),!e&&a.castShadow&&i.indexOf(a)<0&&i.push(a),!this.passThrough&&s>=0&&r._shaderVersion!==s&&(r.updateShader!==Material$1.prototype.updateShader&&(r.clearVariants(),r.shader=null),r._shaderVersion=s)}this.passThrough||(this._dirty=!0)}removeMeshInstanceFromArray(t,e){let s=-1,i=0;const n=e.length;for(let a=0;a<n;a++){const n=e[a];if(n===t){s=a,i=1;break}if(n._staticSource===t)s<0&&(s=a),i++;else if(s>=0)break}s>=0&&e.splice(s,i)}removeMeshInstances(t,e){const s=this.opaqueMeshInstances,i=this.transparentMeshInstances,n=this.shadowCasters;for(let a=0;a<t.length;a++){const r=t[a];if(this.removeMeshInstanceFromArray(r,s),this.removeMeshInstanceFromArray(r,i),!e){const t=n.indexOf(r);t>=0&&n.splice(t,1)}}this._dirty=!0}clearMeshInstances(t){(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!t&&0!==this.shadowCasters.length)&&(this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,t||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0))}addLight(t){const e=t.light;this._lightsSet.has(e)||(this._lightsSet.add(e),0!==e.type&&this._clusteredLightsSet.add(e),this._lights.push(e),this._dirtyLights=!0,this._generateLightHash())}removeLight(t){const e=t.light;this._lightsSet.has(e)&&(this._lightsSet.delete(e),0!==e.type&&this._clusteredLightsSet.delete(e),this._lights.splice(this._lights.indexOf(e),1),this._dirtyLights=!0,this._generateLightHash())}clearLights(){this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this._dirtyLights=!0}get clusteredLightsSet(){return this._clusteredLightsSet}addShadowCasters(t){const e=this.shadowCasters;for(let s=0;s<t.length;s++){const i=t[s];i.castShadow&&(e.indexOf(i)<0&&e.push(i))}this._dirtyLights=!0}removeShadowCasters(t){const e=this.shadowCasters;for(let s=0;s<t.length;s++){const i=e.indexOf(t[s]);i>=0&&e.splice(i,1)}this._dirtyLights=!0}_generateLightHash(){if(this._lights.length>0){this._lights.sort(Vn);let t="",e="";for(let s=0;s<this._lights.length;s++)this._lights[s].isStatic?e+=this._lights[s].key:t+=this._lights[s].key;0===t.length?this._lightHash=0:this._lightHash=qt(t),0===e.length?this._staticLightHash=0:this._staticLightHash=qt(e)}else this._lightHash=0,this._staticLightHash=0}addCamera(t){this.cameras.indexOf(t)>=0||(this.cameras.push(t),this._dirtyCameras=!0)}removeCamera(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),this._dirtyCameras=!0,this.instances.delete(e))}clearCameras(){this.cameras.length=0,this._dirtyCameras=!0}_calculateSortDistances(t,e,s,i){for(let n=0;n<e;n++){const e=t[n];if(e.command)continue;if(e.layer<=2)continue;if(e.calculateSortDistance){e.zdist=e.calculateSortDistance(e,s,i);continue}const a=e.aabb.center,r=a.x-s.x,o=a.y-s.y,l=a.z-s.z;e.zdist=r*i.x+o*i.y+l*i.z}}_sortVisible(t,e,s){const i=this.instances,n=t?this.transparentSortMode:this.opaqueSortMode;if(0===n)return;const a=t?i.visibleTransparent[s]:i.visibleOpaque[s];5===n?(kn=e.getPosition(),Fn=e.forward,this.customCalculateSortValues&&this.customCalculateSortValues(a.list,a.length,kn,Fn),a.list.length!==a.length&&(a.list.length=a.length),this.customSortCallback&&a.list.sort(this.customSortCallback)):(3!==n&&4!==n||(kn=e.getPosition(),Fn=e.forward,this._calculateSortDistances(a.list,a.length,kn,Fn)),a.list.length!==a.length&&(a.list.length=a.length),a.list.sort(On[n]))}}const zn=function(t,e){if(t.size!==e.size)return!1;for(const s of t)if(!e.has(s))return!1;return!0};class RenderAction{constructor(){this.layerIndex=0,this.cameraIndex=0,this.camera=null,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.directionalLightsSet=new Set,this.directionalLights=[],this.directionalLightsIndices=[]}reset(){this.lightClusters=null,this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0}collectDirectionalLights(t,e,s){this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0;for(let i=0;i<e.length;i++){const n=e[i];if(n.castShadows)for(let e=0;e<t.length;e++)if(t[e]._splitLights[0].indexOf(n)>=0&&!this.directionalLightsSet.has(n)){this.directionalLightsSet.add(n),this.directionalLights.push(n);const t=s.indexOf(n);this.directionalLightsIndices.push(t)}}}}class LightCompositionData{constructor(){this.shadowCastersSet=new Set,this.shadowCastersList=[]}clearShadowCasters(){this.shadowCastersSet.clear(),this.shadowCastersList.length=0}addShadowCasters(t){for(let e=0;e<t.length;e++){const s=t[e];this.shadowCastersSet.has(s)||(this.shadowCastersSet.add(s),this.shadowCastersList.push(s))}}}const Un=new Set,Nn=[];class LayerComposition extends EventHandler{constructor(t="Untitled"){super(),this.name=t,this.logRenderActions=!1,this.layerList=[],this.subLayerList=[],this.subLayerEnabled=[],this._opaqueOrder={},this._transparentOrder={},this._dirty=!1,this._dirtyBlend=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._meshInstances=[],this._meshInstancesSet=new Set,this._lights=[],this._lightsMap=new Map,this._lightCompositionData=[],this._splitLights=[[],[],[]],this.cameras=[],this._renderActions=[],this._worldClusters=[],this._emptyWorldClusters=null}destroy(){this._emptyWorldClusters&&(this._emptyWorldClusters.destroy(),this._emptyWorldClusters=null),this._worldClusters.forEach((t=>{t.destroy()})),this._worldClusters=null}getEmptyWorldClusters(t){return this._emptyWorldClusters||(this._emptyWorldClusters=new WorldClusters(t),this._emptyWorldClusters.name="ClusterEmpty",this._emptyWorldClusters.update([],!1,null)),this._emptyWorldClusters}_splitLightsArray(t){const e=t._lights;t._splitLights[0].length=0,t._splitLights[1].length=0,t._splitLights[2].length=0;for(let s=0;s<e.length;s++){const i=e[s];i.enabled&&t._splitLights[i._type].push(i)}}_update(t,e=!1){const s=this.layerList.length;let i=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(let r=0;r<s;r++){const t=this.layerList[r];t._dirty&&(this._dirty=!0),t._dirtyLights&&(this._dirtyLights=!0),t._dirtyCameras&&(this._dirtyCameras=!0)}function n(t,e,s){let i=!1;const n=s.length;for(let a=0;a<n;a++){const n=s[a];if(!e.has(n)){e.add(n),t.push(n);const s=n.material;s&&s._dirtyBlend&&(i=!0,s._dirtyBlend=!1)}}return i}if(this._dirty){i|=1,this._meshInstances.length=0,this._meshInstancesSet.clear();for(let t=0;t<s;t++){const e=this.layerList[t];e.passThrough||(this._dirtyBlend=n(this._meshInstances,this._meshInstancesSet,e.opaqueMeshInstances)||this._dirtyBlend,this._dirtyBlend=n(this._meshInstances,this._meshInstancesSet,e.transparentMeshInstances)||this._dirtyBlend),e._dirty=!1}this._dirty=!1}function a(t,e,s){for(let n=0;n<e.length;){var i;(null==(i=e[n].material)?void 0:i.transparent)===s?(t.push(e[n]),e[n]=e[e.length-1],e.length--):n++}}if(this._dirtyBlend){i|=8;for(let t=0;t<s;t++){const e=this.layerList[t];e.passThrough||(a(e.opaqueMeshInstances,e.transparentMeshInstances,!1),a(e.transparentMeshInstances,e.opaqueMeshInstances,!0))}this._dirtyBlend=!1}if(this._dirtyLights&&(i|=2,this._dirtyLights=!1,this.updateLights()),i&&this.updateShadowCasters(),this._dirtyCameras||2&i){this._dirtyCameras=!1,i|=4,this.cameras.length=0;for(let t=0;t<s;t++){const e=this.layerList[t];e._dirtyCameras=!1;for(let t=0;t<e.cameras.length;t++){const s=e.cameras[t];this.cameras.indexOf(s)<0&&this.cameras.push(s)}}this.cameras.length>1&&this.cameras.sort(((t,e)=>t.priority-e.priority));const n=[];let a=0;for(let t=0;t<this.cameras.length;t++){const e=this.cameras[t];n.length=0;let i=!0;const r=a;let o=null,l=!1;for(let t=0;t<s;t++){const s=this.layerList[t];if(s&&s.cameras.length>0&&e.layers.indexOf(s.id)>=0){n.push(s),l||s.id!==e.disablePostEffectsLayer||(l=!0,o&&(o.triggerPostprocess=!0));const r=s.cameras.indexOf(e);r>=0&&(o=this.addRenderAction(this._renderActions,a,s,t,r,i,l),a++,i=!1)}}r<a&&(this._renderActions[r].collectDirectionalLights(n,this._splitLights[0],this._lights),o.lastCameraUse=!0),!l&&o&&(o.triggerPostprocess=!0),e.renderTarget&&e.postEffectsEnabled&&this.propagateRenderTarget(r-1,e)}this._renderActions.length=a,e&&this.allocateLightClusters(t)}return(2&i||4&i)&&this._logRenderActions(),i}updateShadowCasters(){const t=this._lights.length;for(let s=0;s<t;s++)this._lightCompositionData[s].clearShadowCasters();const e=this.layerList.length;for(let s=0;s<e;s++){const t=this.layerList[s];if(!Un.has(t)){Un.add(t);const e=t._lights;for(let s=0;s<e.length;s++)if(e[s].castShadows){const i=this._lightsMap.get(e[s]);this._lightCompositionData[i].addShadowCasters(t.shadowCasters)}}}Un.clear()}updateLights(){this._lights.length=0,this._lightsMap.clear();const t=this.layerList.length;for(let s=0;s<t;s++){const t=this.layerList[s];if(!Un.has(t)){Un.add(t);const e=t._lights;for(let t=0;t<e.length;t++){const s=e[t];let i=this._lightsMap.get(s);if(void 0===i){i=this._lights.length,this._lightsMap.set(s,i),this._lights.push(s);let t=this._lightCompositionData[i];t||(t=new LightCompositionData,this._lightCompositionData[i]=t)}}}this._splitLightsArray(t),t._dirtyLights=!1}Un.clear(),this._splitLightsArray(this);const e=this._lights.length;this._lightCompositionData.length=e}findCompatibleCluster(t,e){for(let s=0;s<e;s++){const e=this._renderActions[s],i=this.layerList[e.layerIndex];if(t===i)return e.lightClusters;if(e.lightClusters&&zn(t._clusteredLightsSet,i._clusteredLightsSet))return e.lightClusters}return null}allocateLightClusters(t){Nn.push(...this._worldClusters),this._worldClusters.length=0;const e=this._renderActions.length;for(let s=0;s<e;s++){const e=this._renderActions[s],i=this.layerList[e.layerIndex];if(i._clusteredLightsSet.size){if((this.subLayerList[e.layerIndex]?i.transparentMeshInstances:i.opaqueMeshInstances).length){let n=this.findCompatibleCluster(i,s);n||(Nn.length&&(n=Nn.pop()),n||(n=new WorldClusters(t)),n.name="Cluster-"+this._worldClusters.length,this._worldClusters.push(n)),e.lightClusters=n}}e.lightClusters||(e.lightClusters=this.getEmptyWorldClusters(t))}Nn.forEach((t=>{t.destroy()})),Nn.length=0}addRenderAction(t,e,s,i,n,a,r){let o=t[e];o||(o=t[e]=new RenderAction);let l=s.renderTarget;const h=s.cameras[n];h&&h.renderTarget&&1!==s.id&&(l=h.renderTarget);let c=!1;for(let _=e-1;_>=0;_--)if(t[_].camera===h&&t[_].renderTarget===l){c=!0;break}const d=a||!c;let u=!!d&&h.clearColorBuffer,p=!!d&&h.clearDepthBuffer,m=!!d&&h.clearStencilBuffer;return u|=s.clearColorBuffer,p|=s.clearDepthBuffer,m|=s.clearStencilBuffer,r&&h.postEffectsEnabled&&(l=null),o.reset(),o.triggerPostprocess=!1,o.layerIndex=i,o.cameraIndex=n,o.camera=h,o.renderTarget=l,o.clearColor=u,o.clearDepth=p,o.clearStencil=m,o.firstCameraUse=a,o.lastCameraUse=!1,o}propagateRenderTarget(t,e){for(let s=t;s>=0;s--){const t=this._renderActions[s],i=this.layerList[t.layerIndex];if(t.renderTarget&&1!==i.id)break;if(1===i.id)continue;const n=null==t?void 0:t.camera.camera;if(n&&(!e.camera.rect.equals(n.rect)||!e.camera.scissorRect.equals(n.scissorRect)))break;t.renderTarget=e.renderTarget}}_logRenderActions(){}_isLayerAdded(t){return this.layerList.indexOf(t)>=0}_isSublayerAdded(t,e){for(let s=0;s<this.layerList.length;s++)if(this.layerList[s]===t&&this.subLayerList[s]===e)return!0;return!1}push(t){this._isLayerAdded(t)||(this.layerList.push(t),this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insert(t,e){if(this._isLayerAdded(t))return;this.layerList.splice(e,0,t,t),this.subLayerList.splice(e,0,!1,!0);const s=this.layerList.length;this._updateOpaqueOrder(e,s-1),this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}remove(t){let e=this.layerList.indexOf(t);for(delete this._opaqueOrder[e],delete this._transparentOrder[e];e>=0;)this.layerList.splice(e,1),this.subLayerList.splice(e,1),this.subLayerEnabled.splice(e,1),e=this.layerList.indexOf(t),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("remove",t);const s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1)}pushOpaque(t){this._isSublayerAdded(t,!1)||(this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insertOpaque(t,e){if(this._isSublayerAdded(t,!1))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!1);const s=this.subLayerList.length;this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}removeOpaque(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&!this.subLayerList[e])return this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(t)<0&&this.fire("remove",t))}pushTransparent(t){this._isSublayerAdded(t,!0)||(this.layerList.push(t),this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insertTransparent(t,e){if(this._isSublayerAdded(t,!0))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!0);const s=this.subLayerList.length;this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}removeTransparent(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&this.subLayerList[e])return this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(t)<0&&this.fire("remove",t))}_getSublayerIndex(t,e){let s=this.layerList.indexOf(t);if(s<0)return-1;if(this.subLayerList[s]!==e){if(s=this.layerList.indexOf(t,s+1),s<0)return-1;if(this.subLayerList[s]!==e)return-1}return s}getOpaqueIndex(t){return this._getSublayerIndex(t,!1)}getTransparentIndex(t){return this._getSublayerIndex(t,!0)}getLayerById(t){for(let e=0;e<this.layerList.length;e++)if(this.layerList[e].id===t)return this.layerList[e];return null}getLayerByName(t){for(let e=0;e<this.layerList.length;e++)if(this.layerList[e].name===t)return this.layerList[e];return null}_updateOpaqueOrder(t,e){for(let s=t;s<=e;s++)!1===this.subLayerList[s]&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(t,e){for(let s=t;s<=e;s++)!0===this.subLayerList[s]&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(t,e,s){let i=-1,n=-1;for(let a=0,r=t.length;a<r;a++){const e=t[a];s.hasOwnProperty(e)&&(i=Math.max(i,s[e]))}for(let a=0,r=e.length;a<r;a++){const t=e[a];s.hasOwnProperty(t)&&(n=Math.max(n,s[t]))}return-1===i&&-1!==n?1:-1===n&&-1!==i?-1:n-i}sortTransparentLayers(t,e){return this._sortLayersDescending(t,e,this._transparentOrder)}sortOpaqueLayers(t,e){return this._sortLayersDescending(t,e,this._opaqueOrder)}}const Hn=new Vec3,Wn=new Vec3,Gn=new Vec3,jn={bias:0,normalBias:0},Xn={r:0,g:1,b:2,a:3},qn=[[new Vec4(0,0,1,1)],[new Vec4(0,0,.5,.5),new Vec4(0,.5,.5,.5)],[new Vec4(0,0,.5,.5),new Vec4(0,.5,.5,.5),new Vec4(.5,0,.5,.5)],[new Vec4(0,0,.5,.5),new Vec4(0,.5,.5,.5),new Vec4(.5,0,.5,.5),new Vec4(.5,.5,.5,.5)]];let $n=0;class LightRenderData{constructor(t,e,s,i){this.light=i,this.camera=e,this.shadowCamera=ShadowRenderer.createShadowCamera(t,i._shadowType,i._type,s),this.shadowMatrix=new Mat4,this.shadowViewport=new Vec4(0,0,1,1),this.shadowScissor=new Vec4(0,0,1,1),this.face=s,this.visibleCasters=[]}get shadowBuffer(){const t=this.shadowCamera.renderTarget;if(t){const e=this.light;return 1===e._type?t.colorBuffer:e._isPcf&&e.device.webgl2?t.depthBuffer:t.colorBuffer}return null}}class Light{constructor(t){this.device=t,this.id=$n++,this._type=0,this._color=new Color(.8,.8,.8),this._intensity=1,this._castShadows=!1,this._enabled=!1,this.mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this.cascadeDistribution=.5,this._shape=0,this._finalColor=new Float32Array([.8,.8,.8]);const e=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([e,e,e]),this._position=new Vec3(0,0,0),this._direction=new Vec3(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180),this._shadowMap=null,this._shadowRenderParams=[],this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this._normalOffsetBias=0,this.shadowUpdateMode=2,this._isVsm=!1,this._isPcf=!0,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._scene=null,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0}destroy(){this._destroyShadowMap(),this._renderData=null}set numCascades(t){this.cascades&&this.numCascades==t||(this.cascades=qn[t-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set shadowMap(t){this._shadowMap!==t&&(this._destroyShadowMap(),this._shadowMap=t)}get shadowMap(){return this._shadowMap}get numShadowFaces(){const t=this._type;return 0===t?this.numCascades:1===t?6:1}set type(t){if(this._type===t)return;this._type=t,this._destroyShadowMap(),this.updateKey();const e=this._shadowType;this._shadowType=null,this.shadowType=e}get type(){return this._type}set shape(t){if(this._shape===t)return;this._shape=t,this._destroyShadowMap(),this.updateKey();const e=this._shadowType;this._shadowType=null,this.shadowType=e}get shape(){return this._shape}set shadowType(t){if(this._shadowType===t)return;const e=this.device;1===this._type&&(t=0),4!==t||e.webgl2||(t=0),3!==t||e.textureFloatRenderable||(t=2),2!==t||e.textureHalfFloatRenderable||(t=1),this._isVsm=t>=1&&t<=3,this._isPcf=4===t||0===t,this._shadowType=t,this._destroyShadowMap(),this.updateKey()}get shadowType(){return this._shadowType}set enabled(t){this._enabled!==t&&(this._enabled=t,this.layersDirty())}get enabled(){return this._enabled}set castShadows(t){this._castShadows!==t&&(this._castShadows=t,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&4!==this.mask&&0!==this.mask}set shadowResolution(t){this._shadowResolution!==t&&(t=1===this._type?Math.min(t,this.device.maxCubeMapSize):Math.min(t,this.device.maxTextureSize),this._shadowResolution=t,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(t){this._vsmBlurSize!==t&&(t%2==0&&t++,this._vsmBlurSize=t)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(t){this._normalOffsetBias!==t&&((!this._normalOffsetBias&&t||this._normalOffsetBias&&!t)&&this.updateKey(),this._normalOffsetBias=t)}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(t){this._falloffMode!==t&&(this._falloffMode=t,this.updateKey())}get falloffMode(){return this._falloffMode}set innerConeAngle(t){this._innerConeAngle!==t&&(this._innerConeAngle=t,this._innerConeAngleCos=Math.cos(t*Math.PI/180))}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(t){this._outerConeAngle!==t&&(this._outerConeAngle=t,this._outerConeAngleCos=Math.cos(t*Math.PI/180))}get outerConeAngle(){return this._outerConeAngle}set intensity(t){this._intensity!==t&&(this._intensity=t,this._updateFinalColor())}get intensity(){return this._intensity}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new Mat4),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new Vec4(0,0,1,1)),this._atlasViewport}set cookie(t){this._cookie!==t&&(this._cookie=t,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(t){this._cookieFalloff!==t&&(this._cookieFalloff=t,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(t){if(this._cookieChannel!==t){if(t.length<3){const e=t.charAt(t.length-1),s=3-t.length;for(let i=0;i<s;i++)t+=e}this._cookieChannel=t,this.updateKey()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(t){this._cookieTransform!==t&&(this._cookieTransform=t,this._cookieTransformSet=!!t,t&&!this._cookieOffset&&(this.cookieOffset=new Vec2,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(t){if(this._cookieOffset===t)return;!(!this._cookieTransformSet&&!t)&&!t&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=t,this._cookieOffsetSet=!!t,t&&!this._cookieTransform&&(this.cookieTransform=new Vec4(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=0===this._type&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){this._renderData&&(this._renderData.length=0),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1)}getRenderData(t,e){for(let i=0;i<this._renderData.length;i++){const s=this._renderData[i];if(s.camera===t&&s.face===e)return s}const s=new LightRenderData(this.device,t,e,this);return this._renderData.push(s),s}clone(){const t=new Light(this.device);return t.type=this._type,t.setColor(this._color),t.intensity=this._intensity,t.castShadows=this.castShadows,t._enabled=this._enabled,t.attenuationStart=this.attenuationStart,t.attenuationEnd=this.attenuationEnd,t.falloffMode=this._falloffMode,t.shadowType=this._shadowType,t.vsmBlurSize=this._vsmBlurSize,t.vsmBlurMode=this.vsmBlurMode,t.vsmBias=this.vsmBias,t.shadowUpdateMode=this.shadowUpdateMode,t.mask=this.mask,t.innerConeAngle=this._innerConeAngle,t.outerConeAngle=this._outerConeAngle,t.numCascades=this.numCascades,t.cascadeDistribution=this.cascadeDistribution,t.shape=this._shape,t.shadowBias=this.shadowBias,t.normalOffsetBias=this._normalOffsetBias,t.shadowResolution=this._shadowResolution,t.shadowDistance=this.shadowDistance,t}_getUniformBiasValues(t){const e=t.shadowCamera._farClip;switch(this._type){case 1:jn.bias=this.shadowBias,jn.normalBias=this._normalOffsetBias;break;case 2:this._isVsm?jn.bias=-2e-4:(jn.bias=20*this.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(jn.bias*=-100)),jn.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case 0:this._isVsm?jn.bias=-2e-4:(jn.bias=this.shadowBias/e*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(jn.bias*=-100)),jn.normalBias=this._isVsm?this.vsmBias/(e/7):this._normalOffsetBias}return jn}getColor(){return this._color}getBoundingSphere(t){if(2===this._type){const e=this.attenuationEnd,s=this._outerConeAngle,i=Math.cos(s*O.DEG_TO_RAD),n=this._node;Hn.copy(n.up),Hn.mulScalar(.5*-e*i),Hn.add(n.getPosition()),t.center=Hn,Wn.copy(n.up),Wn.mulScalar(-e),Gn.copy(n.right),Gn.mulScalar(Math.sin(s*O.DEG_TO_RAD)*e),Wn.add(Gn),t.radius=.5*Wn.length()}else 1===this._type&&(t.center=this._node.getPosition(),t.radius=this.attenuationEnd)}getBoundingBox(t){if(2===this._type){const e=this.attenuationEnd,s=this._outerConeAngle,i=this._node,n=Math.abs(Math.sin(s*O.DEG_TO_RAD)*e);t.center.set(0,.5*-e,0),t.halfExtents.set(n,.5*e,n),t.setFromTransformedAabb(t,i.getWorldTransform(),!0)}else 1===this._type&&(t.center.copy(this._node.getPosition()),t.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateFinalColor(){const t=this._color,e=t.r,s=t.g,i=t.b,n=this._intensity,a=this._finalColor,r=this._linearFinalColor;a[0]=e*n,a[1]=s*n,a[2]=i*n,n>=1?(r[0]=Math.pow(e,2.2)*n,r[1]=Math.pow(s,2.2)*n,r[2]=Math.pow(i,2.2)*n):(r[0]=Math.pow(a[0],2.2),r[1]=Math.pow(a[1],2.2),r[2]=Math.pow(a[2],2.2))}setColor(){1===arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3===arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateFinalColor()}updateShadow(){2!==this.shadowUpdateMode&&(this.shadowUpdateMode=1)}layersDirty(){var t;null!=(t=this._scene)&&t.layers&&(this._scene.layers._dirtyLights=!0)}updateKey(){let t=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|Xn[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|this.numCascades-1<<8;3===this._cookieChannel.length&&(t|=Xn[this._cookieChannel.charAt(1)]<<16,t|=Xn[this._cookieChannel.charAt(2)]<<14),t!==this.key&&null!==this._scene&&this.layersDirty(),this.key=t}}class LightingParams{constructor(t,e,s){this._maxTextureSize=e,this._supportsAreaLights=t,this._dirtyLightsFnc=s,this._areaLightsEnabled=!1,this._cells=new Vec3(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.atlasSplit=null,this.debugLayer=void 0}set cells(t){this._cells.copy(t)}get cells(){return this._cells}set maxLightsPerCell(t){this._maxLightsPerCell=O.clamp(t,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(t){this._cookieAtlasResolution=O.clamp(t,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(t){this._shadowAtlasResolution=O.clamp(t,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(t){this._shadowType!==t&&(this._shadowType=t,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(t){this._cookiesEnabled!==t&&(this._cookiesEnabled=t,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(t){this._supportsAreaLights&&this._areaLightsEnabled!==t&&(this._areaLightsEnabled=t,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(t){this._shadowsEnabled!==t&&(this._shadowsEnabled=t,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}}const Yn=new BoundingSphere;class BakeLight{constructor(t,e){this.scene=t,this.light=e,this.store(),e.numCascades=1,0!==e.type&&(e._node.getWorldTransform(),e.getBoundingSphere(Yn),this.lightBounds=new BoundingBox,this.lightBounds.center.copy(Yn.center),this.lightBounds.halfExtents.set(Yn.radius,Yn.radius,Yn.radius))}store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades}restore(){const t=this.light;t.mask=this.mask,t.shadowUpdateMode=this.shadowUpdateMode,t.enabled=this.enabled,t.intensity=this.intensity,t._node.setLocalRotation(this.rotation),t.numCascades=this.numCascades}startBake(){this.light.enabled=!0,this.light._destroyShadowMap()}endBake(t){const e=this.light;e.enabled=!1,e.shadowMap&&(e.shadowMap.cached&&t.add(e,e.shadowMap),e.shadowMap=null)}}const Kn=new Vec2;class BakeLightSimple extends BakeLight{get numVirtualLights(){return 0===this.light.type?this.light.bakeNumSamples:1}prepareVirtualLight(t,e){const s=this.light;if(s._node.setLocalRotation(this.rotation),t>0){const i=s.bakeArea;Ze(Kn,t,e),Kn.mulScalar(.5*i),s._node.rotateLocal(Kn.x,0,Kn.y)}s._node.getWorldTransform();const i=this.scene.gammaCorrection?2.2:1,n=Math.pow(this.intensity,i);s.intensity=Math.pow(n/e,1/i)}}class AreaLightLuts{static createTexture(t,e,s){const i=new Texture(t,{width:s,height:s,format:e,addressU:1,addressV:1,type:Ft,magFilter:1,minFilter:0,anisotropy:1});return i.name="AreaLightLUT",i}static setUniforms(t,e,s){t.scope.resolve("areaLightsLutTex1").setValue(e),t.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(t){const e=AreaLightLuts.createTexture(t,7,2);e.lock().fill(0),e.unlock(),AreaLightLuts.setUniforms(t,e,e)}static set(t,e){function s(t,e,s){const i=AreaLightLuts.createTexture(t,s,64);return i.lock().set(e),i.unlock(),i.upload(),i}function i(t,e,s){const i=t.length,n=new Float32Array(i);for(let a=0;a<i;a++){const i=a%4;n[a]=(t[a]+e[i])*s[i]}return n}function n(t){const e=t.length,s=new Uint16Array(e),i=FloatPacking.float2Half;for(let n=0;n<e;n++)s[n]=i(t[n]);return s}function a(t){const e=t.length,s=new Uint8ClampedArray(e);for(let i=0;i<e;i++)s[i]=255*t[i];return s}const r=new Int16Array(e,0,2),o=r[0],l=r[1];if(0!==o||1!==l);else{const r=new Float32Array(e,4,16384),o=new Float32Array(e,65540,16384);let l,h;const c=t.areaLightLutFormat;if(c===rt)l=r,h=o;else if(c===at)l=n(r),h=n(o);else{const t=[-.306897,0,0,0],e=[1.442787,1,1,1];l=a(i(r,[0,.2976,.01381,0],[.999,3.08737,1.6546,.603249])),h=a(i(o,t,e))}const d=s(t,l,c),u=s(t,h,c);AreaLightLuts.setUniforms(t,d,u)}}}let Zn,Qn=1;const Jn=new Mat4,ta=new Mat4,ea=new Vec3,sa=new Vec3,ia=new Vec3,na=new Vec3,aa=new Vec3,ra=new Vec3,oa=new Vec3,la=new Vec3,ha=new Vec3,ca=new Vec3,da=new Vec3,ua=new Vec3,pa=new Vec3;function ma(t){return t-Math.floor(t)}function _a(t){return Math.max(Math.min(t,1),0)}function fa(t,e){return t-e*Math.floor(t/e)}function ga(t){let e=ma(t),s=ma(255*t);return e-=s/255,s-=s/255,[e,s]}class ParticleCPUUpdater{constructor(t){this._emitter=t}calcSpawnPosition(t,e,s,i,n){const a=this._emitter,r=Math.random(),o=Math.random(),l=Math.random(),h=Math.random();if(a.useCpu&&(t[4*n+0+2*a.numParticlesPot*4]=r,t[4*n+1+2*a.numParticlesPot*4]=o,t[4*n+2+2*a.numParticlesPot*4]=l),sa.x=r-.5,sa.y=o-.5,sa.z=l-.5,0===a.emitterShape){const t=Math.max(Math.abs(sa.x),Math.max(Math.abs(sa.y),Math.abs(sa.z))),n=t+(.5-t)*s[0],r=t+(.5-t)*s[1],o=t+(.5-t)*s[2];sa.x=n*(t===Math.abs(sa.x)?Math.sign(sa.x):2*sa.x),sa.y=r*(t===Math.abs(sa.y)?Math.sign(sa.y):2*sa.y),sa.z=o*(t===Math.abs(sa.z)?Math.sign(sa.z):2*sa.z),a.localSpace?ea.copy(e.transformPoint(sa)):ea.copy(i).add(e.transformPoint(sa))}else{sa.normalize();const t=0===a.emitterRadius?0:a.emitterRadiusInner/a.emitterRadius,e=h*(1-t)+t;a.localSpace?ea.copy(sa.mulScalar(e*a.emitterRadius)):ea.copy(i).add(sa.mulScalar(e*a.emitterRadius))}let c=-O.lerp(a.rate,a.rate2,r)*n;if(a.pack8){const e=(ea.x-a.worldBounds.center.x)/a.worldBoundsSize.x+.5,s=(ea.y-a.worldBounds.center.y)/a.worldBoundsSize.y+.5,i=(ea.z-a.worldBounds.center.z)/a.worldBoundsSize.z+.5;let o=O.lerp(a.startAngle*O.DEG_TO_RAD,a.startAngle2*O.DEG_TO_RAD,r);o=o%(2*Math.PI)/(2*Math.PI);const l=ga(e);t[4*n]=l[0],t[4*n+1]=l[1];const h=ga(s);t[4*n+2]=h[0],t[4*n+3]=h[1];const d=ga(i);t[4*n+0+4*a.numParticlesPot]=d[0],t[4*n+1+4*a.numParticlesPot]=d[1];const u=ga(o);t[4*n+2+4*a.numParticlesPot]=u[0],t[4*n+3+4*a.numParticlesPot]=u[1];const p=1;t[4*n+3+4*a.numParticlesPot*2]=p;const m=Math.max(a.lifetime,(a.numParticles-1)*Math.max(a.rate,a.rate2));c=(c+m)/(m+(a.lifetime+1));const _=function(t){let e=ma(t),s=ma(255*t),i=ma(65025*t),n=ma(160581375*t);return e-=s/255,s-=i/255,i-=n/255,n-=n/255,[e,s,i,n]}(c);t[4*n+0+4*a.numParticlesPot*3]=_[0],t[4*n+1+4*a.numParticlesPot*3]=_[1],t[4*n+2+4*a.numParticlesPot*3]=_[2],t[4*n+3+4*a.numParticlesPot*3]=_[3]}else t[4*n]=ea.x,t[4*n+1]=ea.y,t[4*n+2]=ea.z,t[4*n+3]=O.lerp(a.startAngle*O.DEG_TO_RAD,a.startAngle2*O.DEG_TO_RAD,r),t[4*n+3+4*a.numParticlesPot]=c}update(t,e,s,i,n,a,r,o){let l,h,c;const d=this._emitter;if(d.meshInstance.node){const t=d.meshInstance.node.worldTransform;for(let e=0;e<12;e++)Jn.data[e]=t.data[e];ta.copy(Jn),ta.invert(),Zn=d.meshInstance.node.localScale,Qn=Math.max(Math.max(Zn.x,Zn.y),Zn.z)}a=null===d.meshInstance.node||d.localSpace?Vec3.ZERO:d.meshInstance.node.getPosition();const u=d.camera?d.camera._node.getPosition():Vec3.ZERO,p=d.useMesh?17:15;let m,_,f,g,y,v,b,x,S;const w=d.precision-1;for(let C=0;C<d.numParticles;C++){const e=Math.floor(d.vbCPU[C*d.numParticleVerts*(d.useMesh?6:4)+3]),T=s[4*e+0+2*d.numParticlesPot*4];ia.x=T,ia.y=s[4*e+1+2*d.numParticlesPot*4],ia.z=s[4*e+2+2*d.numParticlesPot*4];const M=d.rate+(d.rate2-d.rate)*T,A=d.lifetime;let P=s[4*e+3+4*d.numParticlesPot]+r;const E=_a(P/A);let L=0,R=0;const I=0;(P-r<=0||P>=A)&&this.calcSpawnPosition(s,i,n,a,e);let D=P>0&&P<A;D&&(c=E*w,m=Math.floor(c),_=Math.ceil(c),c%=1,l=d.qRotSpeed[m],h=d.qRotSpeed[_],f=l+(h-l)*c,l=d.qRotSpeed2[m],h=d.qRotSpeed2[_],g=l+(h-l)*c,l=d.qScale[m],h=d.qScale[_],L=l+(h-l)*c,l=d.qScale2[m],h=d.qScale2[_],y=l+(h-l)*c,l=d.qAlpha[m],h=d.qAlpha[_],v=l+(h-l)*c,l=d.qAlpha2[m],h=d.qAlpha2[_],b=l+(h-l)*c,l=d.qRadialSpeed[m],h=d.qRadialSpeed[_],x=l+(h-l)*c,l=d.qRadialSpeed2[m],h=d.qRadialSpeed2[_],S=l+(h-l)*c,x+=100*T%1*(S-x),na.x=s[4*e],na.y=s[4*e+1],na.z=s[4*e+2],d.localSpace?ha.copy(na):ha.copy(na).sub(a),ha.normalize().mulScalar(x),m*=3,_*=3,l=d.qLocalVelocity[m],h=d.qLocalVelocity[_],ra.x=l+(h-l)*c,l=d.qLocalVelocity[m+1],h=d.qLocalVelocity[_+1],ra.y=l+(h-l)*c,l=d.qLocalVelocity[m+2],h=d.qLocalVelocity[_+2],ra.z=l+(h-l)*c,l=d.qLocalVelocity2[m],h=d.qLocalVelocity2[_],la.x=l+(h-l)*c,l=d.qLocalVelocity2[m+1],h=d.qLocalVelocity2[_+1],la.y=l+(h-l)*c,l=d.qLocalVelocity2[m+2],h=d.qLocalVelocity2[_+2],la.z=l+(h-l)*c,l=d.qVelocity[m],h=d.qVelocity[_],aa.x=l+(h-l)*c,l=d.qVelocity[m+1],h=d.qVelocity[_+1],aa.y=l+(h-l)*c,l=d.qVelocity[m+2],h=d.qVelocity[_+2],aa.z=l+(h-l)*c,l=d.qVelocity2[m],h=d.qVelocity2[_],oa.x=l+(h-l)*c,l=d.qVelocity2[m+1],h=d.qVelocity2[_+1],oa.y=l+(h-l)*c,l=d.qVelocity2[m+2],h=d.qVelocity2[_+2],oa.z=l+(h-l)*c,ra.x+=(la.x-ra.x)*ia.x,ra.y+=(la.y-ra.y)*ia.y,ra.z+=(la.z-ra.z)*ia.z,d.initialVelocity>0&&(1===d.emitterShape?(sa.copy(ia).mulScalar(2).sub(Vec3.ONE).normalize(),ra.add(sa.mulScalar(d.initialVelocity))):ra.add(Vec3.FORWARD.mulScalar(d.initialVelocity))),aa.x+=(oa.x-aa.x)*ia.x,aa.y+=(oa.y-aa.y)*ia.y,aa.z+=(oa.z-aa.z)*ia.z,f+=(g-f)*ia.y,L=(L+1e4*T%1*(y-L))*Qn,R=1e3*T%1*(b-v),d.meshInstance.node&&(d.localSpace?(ra.x/=Zn.x,ra.y/=Zn.y,ra.z/=Zn.z):Jn.transformPoint(ra,ra)),d.localSpace?(ta.transformPoint(aa,aa),ra.add(aa).add(ha)):(ra.add(aa.mul(Zn)),ra.add(ha.mul(Zn))),ua.copy(ra),ca.copy(na).add(ra.mulScalar(r)),da.copy(ca),s[4*e]=da.x,s[4*e+1]=da.y,s[4*e+2]=da.z,s[4*e+3]+=f*r,d.wrap&&d.wrapBounds&&(d.localSpace||da.sub(a),da.x=fa(da.x,d.wrapBounds.x)-.5*d.wrapBounds.x,da.y=fa(da.y,d.wrapBounds.y)-.5*d.wrapBounds.y,da.z=fa(da.z,d.wrapBounds.z)-.5*d.wrapBounds.z,d.localSpace||da.add(a)),d.sort>0&&(1===d.sort?(pa.copy(da).sub(u),d.particleDistance[e]=-(pa.x*pa.x+pa.y*pa.y+pa.z*pa.z)):2===d.sort?d.particleDistance[e]=P:3===d.sort&&(d.particleDistance[e]=-P))),o?P<0&&(s[4*e+3+2*d.numParticlesPot*4]=-1):(P>=A&&(P-=Math.max(A,(d.numParticles-1)*M),s[4*e+3+2*d.numParticlesPot*4]=d.loop?1:-1),P<0&&d.loop&&(s[4*e+3+2*d.numParticlesPot*4]=1)),s[4*e+3+2*d.numParticlesPot*4]<0&&(D=!1),s[4*e+3+4*d.numParticlesPot]=P;for(let i=0;i<d.numParticleVerts;i++){const n=(C*d.numParticleVerts+i)*(d.useMesh?6:4);let a=d.vbCPU[n],r=d.vbCPU[n+1],o=d.vbCPU[n+2];D||(a=r=o=0);const l=C*d.numParticleVerts*p+i*p;t[l]=da.x,t[l+1]=da.y,t[l+2]=da.z,t[l+3]=E,t[l+4]=d.alignToMotion?I:s[4*e+3],t[l+5]=L,t[l+6]=R,t[l+7]=ua.x,t[l+8]=a,t[l+9]=r,t[l+10]=o,t[l+11]=ua.y,t[l+12]=e,t[l+13]=ua.z,t[l+14]=d.vbCPU[n+3],d.useMesh&&(t[l+15]=d.vbCPU[n+4],t[l+16]=d.vbCPU[n+5])}}if(d.sort>0&&d.camera){const t=d.useMesh?6:4,s=d.particleDistance;for(let i=0;i<d.numParticles;i++)e[i][0]=i,e[i][1]=s[Math.floor(d.vbCPU[i*d.numParticleVerts*t+3])];d.vbOld.set(d.vbCPU),e.sort((function(t,e){return t[1]-e[1]}));for(let i=0;i<d.numParticles;i++){const s=e[i][0]*d.numParticleVerts*t,n=i*d.numParticleVerts*t;for(let e=0;e<d.numParticleVerts*t;e++)d.vbCPU[n+e]=d.vbOld[s+e]}}}}const ya=new Mat3,va=new Mat3,ba=new Mat3;class ParticleGPUUpdater{constructor(t,e){this._emitter=t,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=e.scope.resolve("particleTexIN"),this.constantParticleTexOUT=e.scope.resolve("particleTexOUT"),this.constantEmitterPos=e.scope.resolve("emitterPos"),this.constantEmitterScale=e.scope.resolve("emitterScale"),this.constantSpawnBounds=e.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=e.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=e.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=e.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=e.scope.resolve("initialVelocity"),this.constantFrameRandom=e.scope.resolve("frameRandom"),this.constantDelta=e.scope.resolve("delta"),this.constantRate=e.scope.resolve("rate"),this.constantRateDiv=e.scope.resolve("rateDiv"),this.constantLifetime=e.scope.resolve("lifetime"),this.constantGraphSampleSize=e.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=e.scope.resolve("graphNumSamples"),this.constantInternalTex0=e.scope.resolve("internalTex0"),this.constantInternalTex1=e.scope.resolve("internalTex1"),this.constantInternalTex2=e.scope.resolve("internalTex2"),this.constantInternalTex3=e.scope.resolve("internalTex3"),this.constantEmitterMatrix=e.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=e.scope.resolve("emitterMatrixInv"),this.constantNumParticles=e.scope.resolve("numParticles"),this.constantNumParticlesPot=e.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=e.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=e.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=e.scope.resolve("rotSpeedDivMult"),this.constantSeed=e.scope.resolve("seed"),this.constantStartAngle=e.scope.resolve("startAngle"),this.constantStartAngle2=e.scope.resolve("startAngle2"),this.constantOutBoundsMul=e.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=e.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=e.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=e.scope.resolve("inBoundsCenter"),this.constantMaxVel=e.scope.resolve("maxVel"),this.constantFaceTangent=e.scope.resolve("faceTangent"),this.constantFaceBinorm=e.scope.resolve("faceBinorm")}_setInputBounds(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)}randomize(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()}update(t,e,s,i,n){const a=this._emitter;t.setBlending(!1),t.setColorWrite(!0,!0,!0,!0),t.setCullMode(0),t.setDepthTest(!1),t.setDepthWrite(!1),this.randomize(),this.constantGraphSampleSize.setValue(1/a.precision),this.constantGraphNumSamples.setValue(a.precision),this.constantNumParticles.setValue(a.numParticles),this.constantNumParticlesPot.setValue(a.numParticlesPot),this.constantInternalTex0.setValue(a.internalTex0),this.constantInternalTex1.setValue(a.internalTex1),this.constantInternalTex2.setValue(a.internalTex2),this.constantInternalTex3.setValue(a.internalTex3);const r=a.meshInstance.node,o=null===r?Vec3.ONE:r.localScale;if(a.pack8){this.worldBoundsMulUniform[0]=a.worldBoundsMul.x,this.worldBoundsMulUniform[1]=a.worldBoundsMul.y,this.worldBoundsMulUniform[2]=a.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=a.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=a.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=a.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();let t=a.maxVel*Math.max(Math.max(o.x,o.y),o.z);t=Math.max(t,1),this.constantMaxVel.setValue(t)}const l=null===r||a.localSpace?Vec3.ZERO:r.getPosition(),h=null===r?Mat4.IDENTITY:r.getWorldTransform();0===a.emitterShape?(ya.setFromMat4(e),this.constantSpawnBounds.setValue(ya.data),this.constantSpawnPosInnerRatio.setValue(s)):(this.constantSpawnBoundsSphere.setValue(a.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===a.emitterRadius?0:a.emitterRadiusInner/a.emitterRadius)),this.constantInitialVelocity.setValue(a.initialVelocity),va.setFromMat4(h),h.invertTo3x3(ba),this.emitterPosUniform[0]=l.x,this.emitterPosUniform[1]=l.y,this.emitterPosUniform[2]=l.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(i),this.constantRate.setValue(a.rate),this.constantRateDiv.setValue(a.rate2-a.rate),this.constantStartAngle.setValue(a.startAngle*O.DEG_TO_RAD),this.constantStartAngle2.setValue(a.startAngle2*O.DEG_TO_RAD),this.constantSeed.setValue(a.seed),this.constantLifetime.setValue(a.lifetime),this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(va.data),this.constantEmitterMatrixInv.setValue(ba.data),this.constantLocalVelocityDivMult.setValue(a.localVelocityUMax),this.constantVelocityDivMult.setValue(a.velocityUMax),this.constantRotSpeedDivMult.setValue(a.rotSpeedUMax[0]);let c=a.swapTex?a.particleTexOUT:a.particleTexIN;c=a.beenReset?a.particleTexStart:c;const d=a.swapTex?a.particleTexIN:a.particleTexOUT;this.constantParticleTexIN.setValue(c),Kt(t,a.swapTex?a.rtParticleTexIN:a.rtParticleTexOUT,n?a.shaderParticleUpdateOnStop:a.loop?a.shaderParticleUpdateRespawn:a.shaderParticleUpdateNoRespawn),a.material.setParameter("particleTexOUT",c),a.material.setParameter("particleTexIN",d),a.beenReset=!1,a.swapTex=!a.swapTex,t.setDepthTest(!0),t.setDepthWrite(!0),a.prevWorldBoundsSize.copy(a.worldBoundsSize),a.prevWorldBoundsCenter.copy(a.worldBounds.center),a.pack8&&this._setInputBounds()}}const xa=[[-1,-1],[1,-1],[1,1],[-1,1]];function Sa(t,e,s,i,n=14,a,r){let o=0;r&&7===n&&(o=1);const l=new Texture(t,{width:e,height:s,format:n,cubemap:!1,mipmaps:!1,minFilter:o,magFilter:o,addressU:1,addressV:1});l.name="PSTexture";const h=l.lock();if(7===n){const t=new Uint8Array(i.length);for(let e=0;e<i.length;e++)t[e]=i[e]*a*255;i=t}return h.set(i),l.unlock(),l}function wa(t){return Math.max(Math.min(t,1),0)}const Ca=new Curve([0,0,1,0]),Ta=new Curve([0,1,1,1]),Ma=new CurveSet([0,0,1,0],[0,0,1,0],[0,0,1,0]),Aa=new CurveSet([0,1,1,1],[0,1,1,1],[0,1,1,1]);let Pa=2;const Ea=new Float32Array(3),La=new Mat4,Ra=new Vec3,Ia=new Vec3,Da=new Vec3;let ka,Fa;function Oa(t,e){void 0!==Fa[t]&&null!==Fa[t]?ka[t]=Fa[t]:ka[t]=e}function Va(t,e,s){return(255*t<<16|255*e<<8|255*s)/(1<<24)}function Ba(t,e){const s=t.length/3,i=new Array(4*s);for(let n=0;n<s;n++)i[4*n]=t[3*n],i[4*n+1]=t[3*n+1],i[4*n+2]=t[3*n+2],i[4*n+3]=Va(e[3*n],e[3*n+1],e[3*n+2]);return i}function za(t,e){const s=e.length,i=t.length/s;for(let n=0;n<i;n++)for(let i=0;i<s;i++){const a=Math.abs(t[n*s+i]);e[i]=Math.max(e[i],a)}}function Ua(t,e,s){const i=function(t,e){const s=new Float32Array(t.length);for(let i=0;i<t.length;i++)s[i]=t[i]-e[i];return s}(e,t);return za(i,s),function(t,e){const s=e.length,i=t.length/s;for(let n=0;n<i;n++)for(let i=0;i<s;i++)t[n*s+i]/=0===e[i]?1:e[i],t[n*s+i]*=.5,t[n*s+i]+=.5}(i,s),i}class ParticleEmitter{constructor(t,e){this.graphicsDevice=t;const s=t;this.precision=32,this._addTimeTime=0,ParticleEmitter.staticInit(s),ka=this,Fa=e,Oa("numParticles",1),this.numParticles>t.maxTextureSize&&(this.numParticles=t.maxTextureSize),Oa("rate",1),Oa("rate2",this.rate),Oa("lifetime",50),Oa("emitterExtents",new Vec3(0,0,0)),Oa("emitterExtentsInner",new Vec3(0,0,0)),Oa("emitterRadius",0),Oa("emitterRadiusInner",0),Oa("emitterShape",0),Oa("initialVelocity",1),Oa("wrap",!1),Oa("localSpace",!1),Oa("screenSpace",!1),Oa("wrapBounds",null),Oa("colorMap",ParticleEmitter.DEFAULT_PARAM_TEXTURE),Oa("normalMap",null),Oa("loop",!0),Oa("preWarm",!1),Oa("sort",0),Oa("mode",0),Oa("scene",null),Oa("lighting",!1),Oa("halfLambert",!1),Oa("intensity",1),Oa("stretch",0),Oa("alignToMotion",!1),Oa("depthSoftening",0),Oa("mesh",null),Oa("particleNormal",new Vec3(0,1,0)),Oa("orientation",0),Oa("depthWrite",!1),Oa("noFog",!1),Oa("blendType",2),Oa("node",null),Oa("startAngle",0),Oa("startAngle2",this.startAngle),Oa("animTilesX",1),Oa("animTilesY",1),Oa("animStartFrame",0),Oa("animNumFrames",1),Oa("animNumAnimations",1),Oa("animIndex",0),Oa("randomizeAnimIndex",!1),Oa("animSpeed",1),Oa("animLoop",!0),this._gpuUpdater=new ParticleGPUUpdater(this,s),this._cpuUpdater=new ParticleCPUUpdater(this),this.constantLightCube=s.scope.resolve("lightCube[0]"),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),Oa("colorGraph",Aa),Oa("colorGraph2",this.colorGraph),Oa("scaleGraph",Ta),Oa("scaleGraph2",this.scaleGraph),Oa("alphaGraph",Ta),Oa("alphaGraph2",this.alphaGraph),Oa("localVelocityGraph",Ma),Oa("localVelocityGraph2",this.localVelocityGraph),Oa("velocityGraph",Ma),Oa("velocityGraph2",this.velocityGraph),Oa("rotationSpeedGraph",Ca),Oa("rotationSpeedGraph2",this.rotationSpeedGraph),Oa("radialSpeedGraph",Ca),Oa("radialSpeedGraph2",this.radialSpeedGraph),this.lightCube=new Float32Array(18),this.lightCubeDir=new Array(6),this.lightCubeDir[0]=new Vec3(-1,0,0),this.lightCubeDir[1]=new Vec3(1,0,0),this.lightCubeDir[2]=new Vec3(0,-1,0),this.lightCubeDir[3]=new Vec3(0,1,0),this.lightCubeDir[4]=new Vec3(0,0,-1),this.lightCubeDir[5]=new Vec3(0,0,1),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!1,this.pack8=!0,this.localBounds=new BoundingBox,this.worldBoundsNoTrail=new BoundingBox,this.worldBoundsTrail=[new BoundingBox,new BoundingBox],this.worldBounds=new BoundingBox,this.worldBoundsSize=new Vec3,this.prevWorldBoundsSize=new Vec3,this.prevWorldBoundsCenter=new Vec3,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new Vec3,this.worldBoundsAdd=new Vec3,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=!1,this._layer=null,this.rebuild()}static staticInit(t){if(!ParticleEmitter.DEFAULT_PARAM_TEXTURE){const e=16,s=.5*e+.5,i=new Float32Array(e*e*4);for(let t=0;t<e;t++)for(let n=0;n<e;n++){const a=n+1-s,r=t+1-s,o=wa(1-wa(Math.sqrt(a*a+r*r)/e)-.5),l=t*e+n;i[4*l]=1,i[4*l+1]=1,i[4*l+2]=1,i[4*l+3]=o}ParticleEmitter.DEFAULT_PARAM_TEXTURE=Sa(t,e,e,i,7,1,!0),ParticleEmitter.DEFAULT_PARAM_TEXTURE.minFilter=1,ParticleEmitter.DEFAULT_PARAM_TEXTURE.magFilter=1}}static staticDestroy(){ParticleEmitter.DEFAULT_PARAM_TEXTURE&&(ParticleEmitter.DEFAULT_PARAM_TEXTURE.destroy(),ParticleEmitter.DEFAULT_PARAM_TEXTURE=null)}onChangeCamera(){this.regenShader(),this.resetMaterial()}calculateBoundsMad(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5}calculateWorldBounds(){if(!this.node)return;if(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu){let t=!1;t=0===this.emitterShape?!this.emitterExtents.equals(this.prevEmitterExtents):!(this.emitterRadius===this.prevEmitterRadius),t&&this.calculateLocalBounds()}const t=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,t),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);const e=this.simTimeTotal;e>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=e+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,t),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,t)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}resetWorldBounds(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?Mat4.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0)}calculateLocalBounds(){let t=Number.MAX_VALUE,e=Number.MAX_VALUE,s=Number.MAX_VALUE,i=-Number.MAX_VALUE,n=-Number.MAX_VALUE,a=-Number.MAX_VALUE,r=0,o=0;const l=this.lifetime/this.precision,h=[this.qVelocity,this.qVelocity2],c=[this.qLocalVelocity,this.qLocalVelocity2],d=[0,0],u=[0,0],p=[0,0],m=[0,0],_=[0,0];let f,g,y;for(let b=0;b<this.precision+1;b++){const v=Math.min(b,this.precision-1);for(let r=0;r<2;r++)f=c[r][3*v+0]*l+d[r],g=c[r][3*v+1]*l+u[r],y=c[r][3*v+2]*l+p[r],t=Math.min(f,t),e=Math.min(g,e),s=Math.min(y,s),i=Math.max(f,i),n=Math.max(g,n),a=Math.max(y,a),d[r]=f,u[r]=g,p[r]=y;for(let t=0;t<2;t++)_[t]+=l*Math.sqrt(h[t][3*v+0]*h[t][3*v+0]+h[t][3*v+1]*h[t][3*v+1]+h[t][3*v+2]*h[t][3*v+2]);m[0]+=this.qRadialSpeed[v]*l,m[1]+=this.qRadialSpeed2[v]*l,r=Math.max(r,Math.max(Math.abs(m[0]),Math.abs(m[1]))),o=Math.max(o,this.qScale[v])}0===this.emitterShape?(f=.5*this.emitterExtents.x,g=.5*this.emitterExtents.y,y=.5*this.emitterExtents.z):(f=this.emitterRadius,g=this.emitterRadius,y=this.emitterRadius);const v=Math.max(_[0],_[1]);Ia.x=t-o-f-r-v,Ia.y=e-o-g-r-v,Ia.z=s-o-y-r-v,Da.x=i+o+f+r+v,Da.y=n+o+g+r+v,Da.z=a+o+y+r+v,this.localBounds.setMinMax(Ia,Da)}rebuild(){const t=this.graphicsDevice;if(null===this.colorMap&&(this.colorMap=ParticleEmitter.DEFAULT_PARAM_TEXTURE),this.spawnBounds=0===this.emitterShape?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>0||t.maxVertexTextures<=1||t.fragmentUniformsCount<64||t.forceCpuParticles||!t.extTextureFloat,this._destroyResources(),this.pack8=(this.pack8||!t.textureFloatRenderable)&&!this.useCpu,Pa=this.useCpu||this.pack8?4:2,this.useMesh=!1,this.mesh){this.numParticles*this.mesh.vertexBuffer.numVertices>65535||(this.useMesh=!0)}this.numParticlesPot=O.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?Mat4.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=new Array(this.numParticles);for(let h=0;h<this.numParticles;h++)this.vbToSort[h]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*Pa*4);const e=null===this.node||this.localSpace?Vec3.ZERO:this.node.getPosition();0===this.emitterShape&&(null===this.node||this.localSpace?La.setTRS(Vec3.ZERO,Quat.IDENTITY,this.spawnBounds):La.setTRS(Vec3.ZERO,this.node.getRotation(),Ra.copy(this.spawnBounds).mul(this.node.localScale)),Ea[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Ea[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Ea[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(let h=0;h<this.numParticles;h++)this._cpuUpdater.calcSpawnPosition(this.particleTex,La,Ea,e,h),this.useCpu&&(this.particleTex[4*h+3+2*this.numParticlesPot*4]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*Pa*4);for(let h=0;h<this.particleTexStart.length;h++)this.particleTexStart[h]=this.particleTex[h];this.useCpu||(this.pack8?(this.particleTexIN=Sa(t,this.numParticlesPot,Pa,this.particleTex,7,1,!1),this.particleTexOUT=Sa(t,this.numParticlesPot,Pa,this.particleTex,7,1,!1),this.particleTexStart=Sa(t,this.numParticlesPot,Pa,this.particleTexStart,7,1,!1)):(this.particleTexIN=Sa(t,this.numParticlesPot,Pa,this.particleTex),this.particleTexOUT=Sa(t,this.numParticlesPot,Pa,this.particleTex),this.particleTexStart=Sa(t,this.numParticlesPot,Pa,this.particleTexStart)),this.rtParticleTexIN=new RenderTarget({colorBuffer:this.particleTexIN,depth:!1}),this.rtParticleTexOUT=new RenderTarget({colorBuffer:this.particleTexOUT,depth:!1}),this.swapTex=!1);const s=(this.localSpace?"#define LOCAL_SPACE\n":"")+Zt.particleUpdaterInitPS+(this.pack8?Zt.particleInputRgba8PS+Zt.particleOutputRgba8PS:Zt.particleInputFloatPS+Zt.particleOutputFloatPS)+(0===this.emitterShape?Zt.particleUpdaterAABBPS:Zt.particleUpdaterSpherePS)+Zt.particleUpdaterStartPS,i=s+Zt.particleUpdaterRespawnPS+Zt.particleUpdaterEndPS,n=s+Zt.particleUpdaterNoRespawnPS+Zt.particleUpdaterEndPS,a=s+Zt.particleUpdaterOnStopPS+Zt.particleUpdaterEndPS,r=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=he(t,Zt.fullscreenQuadVS,i,"fsQuad0"+r),this.shaderParticleUpdateNoRespawn=he(t,Zt.fullscreenQuadVS,n,"fsQuad1"+r),this.shaderParticleUpdateOnStop=he(t,Zt.fullscreenQuadVS,a,"fsQuad2"+r),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);const o=new Mesh(t);o.vertexBuffer=this.vertexBuffer,o.indexBuffer[0]=this.indexBuffer,o.primitive[0].type=4,o.primitive[0].base=0,o.primitive[0].count=this.numParticles*this.numParticleIndices,o.primitive[0].indexed=!0,this.material=new Material$1,this.material.name=this.node.name,this.material.cull=0,this.material.alphaWrite=!1,this.material.blend=!0,this.material.blendType=this.blendType,this.material.depthWrite=this.depthWrite,this.material.emitter=this,this.regenShader(),this.resetMaterial();const l=!this.meshInstance||this.meshInstance.visible;this.meshInstance=new MeshInstance(o,this.material,this.node),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.meshInstance._noDepthDrawGl1=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=l,this._initializeTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)}_isAnimated(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==ParticleEmitter.DEFAULT_PARAM_TEXTURE||this.normalMap)}rebuildGraphs(){const t=this.precision,e=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(t),this.qVelocity=this.velocityGraph.quantize(t),this.qColor=this.colorGraph.quantizeClamped(t,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(t),this.qScale=this.scaleGraph.quantize(t),this.qAlpha=this.alphaGraph.quantize(t),this.qRadialSpeed=this.radialSpeedGraph.quantize(t),this.qLocalVelocity2=this.localVelocityGraph2.quantize(t),this.qVelocity2=this.velocityGraph2.quantize(t),this.qColor2=this.colorGraph2.quantizeClamped(t,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(t),this.qScale2=this.scaleGraph2.quantize(t),this.qAlpha2=this.alphaGraph2.quantize(t),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(t);for(let s=0;s<t;s++)this.qRotSpeed[s]*=O.DEG_TO_RAD,this.qRotSpeed2[s]*=O.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=Ua(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=Ua(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=Ua(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=Ua(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=Ua(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=Ua(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=Ua(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){const t=[0,0,0];za(this.qVelocity,t);const e=[0,0,0];za(this.qVelocity2,e);const s=[0,0,0];za(this.qLocalVelocity,s);const i=[0,0,0];za(this.qLocalVelocity2,i);const n=[0];za(this.qRadialSpeed,n);const a=[0];za(this.qRadialSpeed2,a);let r=Math.max(t[0],e[0]);r=Math.max(r,t[1]),r=Math.max(r,e[1]),r=Math.max(r,t[2]),r=Math.max(r,e[2]);let o=Math.max(s[0],i[0]);o=Math.max(o,s[1]),o=Math.max(o,i[1]),o=Math.max(o,s[2]),o=Math.max(o,i[2]);const l=Math.max(n[0],a[0]);this.maxVel=r+o+l}this.useCpu||(this.internalTex0=Sa(e,t,1,Ba(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=Sa(e,t,1,Ba(this.qVelocity,this.qVelocityDiv)),this.internalTex2=Sa(e,t,1,function(t,e,s,i,n){const a=new Array(4*t.length);for(let r=0;r<t.length;r++)a[4*r]=t[r],a[4*r+1]=e[r],a[4*r+2]=0,a[4*r+3]=Va(s[r],i[r],n[r]);return a}(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=Sa(e,t,1,function(t,e){const s=new Array(4*t.length);for(let i=0;i<t.length;i++)s[4*i]=t[i],s[4*i+1]=e[i],s[4*i+2]=0,s[4*i+3]=0;return s}(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=Sa(e,t,1,function(t,e){const s=new Array(4*e.length);for(let i=0;i<e.length;i++)s[4*i]=t[3*i],s[4*i+1]=t[3*i+1],s[4*i+2]=t[3*i+2],s[4*i+3]=e[i];return s}(this.qColor,this.qAlpha),7,1,!0)}_initializeTextures(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))}regenShader(){const t=this.graphicsDevice.getProgramLibrary(),e=null!==this.normalMap;this.normalOption=0,this.lighting&&(this.normalOption=e?2:1),this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!==this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());const e=this.emitter.inTools,s=t.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:!e&&this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:0!==this.emitter.orientation});this.shader=s},this.material.updateShader()}resetMaterial(){const t=this.material;t.setParameter("stretch",this.stretch),this._isAnimated()&&(t.setParameter("animTexTilesParams",this.animTilesParams),t.setParameter("animTexParams",this.animParams),t.setParameter("animTexIndexParams",this.animIndexParams)),t.setParameter("colorMult",this.intensity),this.useCpu||(t.setParameter("internalTex0",this.internalTex0),t.setParameter("internalTex1",this.internalTex1),t.setParameter("internalTex2",this.internalTex2),t.setParameter("internalTex3",this.internalTex3)),t.setParameter("colorParam",this.colorParam),t.setParameter("numParticles",this.numParticles),t.setParameter("numParticlesPot",this.numParticlesPot),t.setParameter("lifetime",this.lifetime),t.setParameter("rate",this.rate),t.setParameter("rateDiv",this.rate2-this.rate),t.setParameter("seed",this.seed),t.setParameter("scaleDivMult",this.scaleUMax[0]),t.setParameter("alphaDivMult",this.alphaUMax[0]),t.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),t.setParameter("graphNumSamples",this.precision),t.setParameter("graphSampleSize",1/this.precision),t.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),t.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),t.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),t.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,t.setParameter("wrapBounds",this.wrapBoundsUniform)),this.colorMap&&t.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&t.setParameter("normalMap",this.normalMap),this.depthSoftening>0&&t.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(t.cull=0),this._compParticleFaceParams()}_compParticleFaceParams(){let t,e;if(0===this.orientation)t=new Float32Array([1,0,0]),e=new Float32Array([0,0,1]);else{let s;if(1===this.orientation)s=this.particleNormal.normalize();else{s=(null===this.node?Mat4.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize()}const i=new Vec3(1,0,0);1===Math.abs(i.dot(s))&&i.set(0,0,1);const n=(new Vec3).cross(s,i).normalize();i.cross(n,s).normalize(),t=new Float32Array([i.x,i.y,i.z]),e=new Float32Array([n.x,n.y,n.z])}this.material.setParameter("faceTangent",t),this.material.setParameter("faceBinorm",e)}_allocate(t){const e=t*this.numParticleVerts,s=t*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==e){if(this.useCpu){const t=[{semantic:St,components:4,type:6},{semantic:wt,components:4,type:6},{semantic:Ct,components:4,type:6},{semantic:Tt,components:1,type:6},{semantic:Mt,components:this.useMesh?4:2,type:6}],i=new VertexFormat(this.graphicsDevice,t);this.vertexBuffer=new VertexBuffer(this.graphicsDevice,i,e,1),this.indexBuffer=new IndexBuffer(this.graphicsDevice,1,s)}else{const t=[{semantic:St,components:4,type:6}];this.useMesh&&t.push({semantic:wt,components:2,type:6});const i=new VertexFormat(this.graphicsDevice,t);this.vertexBuffer=new VertexBuffer(this.graphicsDevice,i,e,1),this.indexBuffer=new IndexBuffer(this.graphicsDevice,1,s)}const i=new Float32Array(this.vertexBuffer.lock());let n,a,r;if(this.useMesh){n=new Float32Array(this.mesh.vertexBuffer.lock()),a=n.length/this.mesh.vertexBuffer.numVertices;for(let t=0;t<this.mesh.vertexBuffer.format.elements.length;t++)if(this.mesh.vertexBuffer.format.elements[t].name===mt){r=this.mesh.vertexBuffer.format.elements[t].offset/4;break}}for(let t=0;t<e;t++){const e=Math.floor(t/this.numParticleVerts);if(this.useMesh){const s=t%this.numParticleVerts;i[6*t]=n[s*a],i[6*t+1]=n[s*a+1],i[6*t+2]=n[s*a+2],i[6*t+3]=e,i[6*t+4]=n[s*a+r+0],i[6*t+5]=1-n[s*a+r+1]}else{const s=t%4;i[4*t]=xa[s][0],i[4*t+1]=xa[s][1],i[4*t+2]=0,i[4*t+3]=e}}this.useCpu&&(this.vbCPU=new Float32Array(i),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();let o=0;const l=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(n=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(let e=0;e<t;e++)if(this.useMesh)for(let t=0;t<this.numParticleIndices;t++)l[e*this.numParticleIndices+t]=n[t]+e*this.numParticleVerts;else{const t=4*e;l[o++]=t,l[o++]=t+1,l[o++]=t+2,l[o++]=t,l[o++]=t+2,l[o++]=t+3}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}}reset(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(let e=0;e<this.particleTexStart.length;e++)this.particleTex[e]=this.particleTexStart[e];else this._initializeTextures();this.resetWorldBounds(),this.resetTime();const t=this.loop;this.loop=!0,this.addTime(0,!1),this.loop=t,this.preWarm&&this.prewarm(this.lifetime)}prewarm(t){const e=t/this.lifetime,s=Math.min(Math.floor(e*this.precision),this.precision),i=t/s;for(let n=0;n<s;n++)this.addTime(i,!1)}resetTime(){this.endTime=function(t){const e=Math.max(t.rate,t.rate2)*t.numParticles+t.lifetime;return Date.now()+1e3*e}(this)}finishFrame(){this.useCpu&&this.vertexBuffer.unlock()}addTime(t,e){const s=this.graphicsDevice;if(this.simTimeTotal+=t,this.calculateWorldBounds(),this._isAnimated()){const t=this.animTilesParams;t[0]=1/this.animTilesX,t[1]=1/this.animTilesY;const e=this.animParams;e[0]=this.animStartFrame,e[1]=this.animNumFrames*this.animSpeed,e[2]=this.animNumFrames-1,e[3]=this.animNumAnimations-1;const s=this.animIndexParams;s[0]=this.animIndex,s[1]=this.randomizeAnimIndex}let i;this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),0===this.emitterShape&&(Ea[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Ea[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Ea[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?La.setTRS(Vec3.ZERO,Quat.IDENTITY,this.emitterExtents):La.setTRS(Vec3.ZERO,this.meshInstance.node.getRotation(),Ra.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));const n=null===this.meshInstance.node?Vec3.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=n.x,this.emitterScaleUniform[1]=n.y,this.emitterScaleUniform[2]=n.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(i=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=i.x,this.emitterPosUniform[1]=i.y,this.emitterPosUniform[2]=i.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),this.useCpu){const s=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(s,this.vbToSort,this.particleTex,La,Ea,i,t,e)}else this._gpuUpdater.update(s,La,Ea,t,e);this.loop||Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)}_destroyResources(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null),this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null),this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null),this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null),this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null),this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null),this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null),this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null),this.colorParam&&(this.colorParam.destroy(),this.colorParam=null),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this.material&&(this.material.destroy(),this.material=null)}destroy(){this.camera=null,this._destroyResources()}}ParticleEmitter.DEFAULT_PARAM_TEXTURE=null;class Morph extends RefCountedObject{constructor(t,e){super(),this.device=e||ei().graphicsDevice,this._targets=t,this.device.supportsMorphTargetTexturesCore&&(this.device.extTextureHalfFloat&&this.device.textureHalfFloatRenderable?this._renderTextureFormat=Morph.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&this.device.textureFloatRenderable&&(this._renderTextureFormat=Morph.FORMAT_FLOAT),this.device.extTextureHalfFloat&&this.device.textureHalfFloatUpdatable?this._textureFormat=Morph.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&(this._textureFormat=Morph.FORMAT_FLOAT),void 0!==this._renderTextureFormat&&void 0!==this._textureFormat&&(this._useTextureMorph=!0)),this._init(),this._updateMorphFlags(),this._calculateAabb()}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}get maxActiveTargets(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}get useTextureMorph(){return this._useTextureMorph}_init(){if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(let t=0;t<this._targets.length;t++)this._targets[t]._initVertexBuffers(this.device);for(let t=0;t<this._targets.length;t++)this._targets[t]._postInit()}_initTextureBased(){const t=[],e=[];for(let _=0;_<this._targets.length;_++){const s=this._targets[_];s.options.deltaPositions&&(t.push(s.options.deltaPositions),e.push({target:s,name:"texturePositions"})),s.options.deltaNormals&&(t.push(s.options.deltaNormals),e.push({target:s,name:"textureNormals"}))}const s=[],i=[];let n=1;const a=t[0].length;for(let _=0;_<a;_+=3){let e=!1;for(let s=0;s<t.length;s++){const i=t[s];if(0!==i[_]||0!==i[_+1]||0!==i[_+2]){e=!0;break}}e?(s.push(n+.2),i.push(_/3),n++):s.push(.2)}const r=Math.min(this.device.maxTextureSize,4096);let o=Math.ceil(Math.sqrt(n));o=Math.min(o,r);const l=Math.ceil(n/o);if(l>r)return!1;this.morphTextureWidth=o,this.morphTextureHeight=l;let h=!1,c=3;const d=FloatPacking.float2Half;this._textureFormat===Morph.FORMAT_HALF_FLOAT&&(h=!0,c=4);const u=this.morphTextureWidth*this.morphTextureHeight*c,p=h?new Uint16Array(u):new Float32Array(u);for(let _=0;_<t.length;_++){const s=t[_];for(let t=0;t<i.length;t++){const e=i[t];h?(p[t*c+c]=d(s[3*e]),p[t*c+c+1]=d(s[3*e+1]),p[t*c+c+2]=d(s[3*e+2])):(p[t*c+c]=s[3*e],p[t*c+c+1]=s[3*e+1],p[t*c+c+2]=s[3*e+2])}const n=e[_].target,a=this._textureFormat===Morph.FORMAT_FLOAT?13:at;n._setTexture(e[_].name,this._createTexture("MorphTarget",a,p))}const m=[{semantic:kt,components:1,type:6}];return this.vertexBufferIds=new VertexBuffer(this.device,new VertexFormat(this.device,m),s.length,0,new Float32Array(s)),!0}destroy(){this.vertexBufferIds&&(this.vertexBufferIds.destroy(),this.vertexBufferIds=null);for(let t=0;t<this._targets.length;t++)this._targets[t].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let t=0;t<this._targets.length;t++){const e=this._targets[t];e.morphPositions&&(this._morphPositions=!0),e.morphNormals&&(this._morphNormals=!0)}}_calculateAabb(){const t=new Vec3,e=new Vec3;for(let s=0;s<this._targets.length;s++){const i=this._targets[s].aabb;t.min(i.getMin()),e.max(i.getMax())}this.aabb=new BoundingBox,this.aabb.setMinMax(t,e)}_createTexture(t,e,s){const i=new Texture(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:e,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return i.name=t,s&&(i.lock().set(s),i.unlock()),i}}Morph.FORMAT_FLOAT=0,Morph.FORMAT_HALF_FLOAT=1;class MorphInstance{constructor(t){this.morph=t,t.incRefCount(),this.device=t.device,this.meshInstance=null,this._weights=[];for(let e=0;e<t._targets.length;e++)this.setWeight(e,t._targets[e].defaultWeight);if(this._activeTargets=[],t.useTextureMorph){this.shaderCache={},this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);const e=(e,s)=>{const i=t._renderTextureFormat===Morph.FORMAT_FLOAT?rt:at;return this[s]=t._createTexture(e,i),new RenderTarget({colorBuffer:this[s],depth:!1})};t.morphPositions&&(this.rtPositions=e("MorphRTPos","texturePositions")),t.morphNormals&&(this.rtNormals=e("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([t.morphTextureWidth,t.morphTextureHeight,1/t.morphTextureWidth,1/t.morphTextureHeight]);for(let t=0;t<this.maxSubmitCount;t++)this["morphBlendTex"+t]=this.device.scope.resolve("morphBlendTex"+t);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,16,4),this._activeVertexBuffers=new Array(this.maxSubmitCount)}destroy(){this.meshInstance=null,this.shader=null;const t=this.morph;t&&(this.morph=null,t.decRefCount(),t.refCount<1&&t.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}clone(){return new MorphInstance(this.morph)}getWeight(t){return this._weights[t]}setWeight(t,e){this._weights[t]=e,this._dirty=!0}_getFragmentShader(t){let e="";t>0&&(e+="varying vec2 uv0;\nuniform highp float morphFactor["+t+"];\n");for(let s=0;s<t;s++)e+="uniform highp sampler2D morphBlendTex"+s+";\n";e+="void main (void) {\n\t\thighp vec4 color = vec4(0, 0, 0, 1);\n";for(let s=0;s<t;s++)e+="\t\tcolor.xyz += morphFactor["+s+"] * texture2D(morphBlendTex"+s+", uv0).xyz;\n";return e+="\t\tgl_FragColor = color;\n}\n",e}_getShader(t){let e=this.shaderCache[t];if(!e){const s=this._getFragmentShader(t);e=he(this.device,"\n\t\tattribute vec2 vertex_position;\n\t\tvarying vec2 uv0;\n\t\tvoid main(void) {\n\t\t\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\t\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t}\n\t\t",s,"textureMorph"+t),this.shaderCache[t]=e}return e}_updateTextureRenderTarget(t,e){const s=this.device,i=(e,i)=>{this.morphFactor.setValue(this._shaderMorphWeights),s.setBlending(i),i&&(s.setBlendFunction(1,1),s.setBlendEquation(0));const n=this._getShader(e);Kt(s,t,n,void 0,void 0,i)};let n=0,a=!1;const r=this._activeTargets.length;for(let o=0;o<r;o++){const t=this._activeTargets[o],s=t.target[e];s&&(this["morphBlendTex"+n].setValue(s),this._shaderMorphWeights[n]=t.weight,n++,n>=this.maxSubmitCount&&(i(n,a),n=0,a=!0))}(n>0||0===r&&!this.zeroTextures)&&i(n,a)}_updateTextureMorph(){this.device,(this._activeTargets.length>0||!this.zeroTextures)&&(this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this._updateTextureRenderTarget(this.rtNormals,"textureNormals"),this.zeroTextures=0===this._activeTargets.length)}_updateVertexMorph(){const t=this.maxSubmitCount;for(let i=0;i<t;i++)this._shaderMorphWeights[i]=0,this._activeVertexBuffers[i]=null;let e=0,s=this.morph.morphPositions?4:0;for(let i=0;i<this._activeTargets.length;i++){const t=this._activeTargets[i].target;t._vertexBufferPositions&&(this._activeVertexBuffers[e]=t._vertexBufferPositions,this._shaderMorphWeights[e]=this._activeTargets[i].weight,e++),t._vertexBufferNormals&&(this._activeVertexBuffers[s]=t._vertexBufferNormals,this._shaderMorphWeights[s]=this._activeTargets[i].weight,s++)}}update(){this._dirty=!1;const t=this.morph._targets;let e=0;for(let i=0;i<t.length;i++){const s=Math.abs(this.getWeight(i));if(s>1e-5){this._activeTargets.length<=e&&(this._activeTargets[e]={});const n=this._activeTargets[e++];n.absWeight=s,n.weight=this.getWeight(i),n.target=t[i]}}this._activeTargets.length=e;const s=this.morph.maxActiveTargets;this._activeTargets.length>s&&(this._activeTargets.sort((function(t,e){return t.absWeight<e.absWeight?1:e.absWeight<t.absWeight?-1:0})),this._activeTargets.length=s),this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()}}class Model{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(t){this.graph=t}getCameras(){return this.cameras}setCameras(t){this.cameras=t}getLights(){return this.lights}setLights(t){this.lights=t}getMaterials(){const t=[];for(let e=0;e<this.meshInstances.length;e++){const s=this.meshInstances[e];-1===t.indexOf(s.material)&&t.push(s.material)}return t}clone(){const t=[],e=[],s=function s(i){const n=i.clone();t.push(i),e.push(n);for(let t=0;t<i._children.length;t++)n.addChild(s(i._children[t]));return n}(this.graph),i=[],n=[],a=[];for(let o=0;o<this.skinInstances.length;o++){const t=this.skinInstances[o].skin,e=new SkinInstance(t),i=[];for(let n=0;n<t.boneNames.length;n++){const e=t.boneNames[n],a=s.findByName(e);i.push(a)}e.bones=i,n.push(e)}for(let o=0;o<this.morphInstances.length;o++){const t=this.morphInstances[o].morph,e=new MorphInstance(t);a.push(e)}for(let o=0;o<this.meshInstances.length;o++){const s=this.meshInstances[o],r=t.indexOf(s.node),l=new MeshInstance(s.mesh,s.material,e[r]);if(s.skinInstance){const t=this.skinInstances.indexOf(s.skinInstance);l.skinInstance=n[t]}if(s.morphInstance){const t=this.morphInstances.indexOf(s.morphInstance);l.morphInstance=a[t]}i.push(l)}const r=new Model;return r.graph=s,r.meshInstances=i,r.skinInstances=n,r.morphInstances=a,r.getGraph().syncHierarchy(),r}destroy(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].destroy();this.meshInstances.length=0}generateWireframe(){MeshInstance._prepareRenderStyleForArray(this.meshInstances,1)}}const Na=new GraphNode;Na.worldTransform=Mat4.IDENTITY,Na._dirtyWorld=Na._dirtyNormal=!1;class ImmediateBatch{constructor(t,e,s){this.material=e,this.layer=s,this.positions=[],this.colors=[],this.mesh=new Mesh(t),this.meshInstance=null}addLines(t,e){const s=this.positions,i=t.length;for(let a=0;a<i;a++){const e=t[a];s.push(e.x,e.y,e.z)}const n=this.colors;if(e.length)for(let a=0;a<i;a++){const t=e[a];n.push(t.r,t.g,t.b,t.a)}else for(let a=0;a<i;a++)n.push(e.r,e.g,e.b,e.a)}addLinesArrays(t,e){this.positions.push(...t);const s=this.colors;if(e.length)s.push(...e);else{const i=t.length/3;for(let t=0;t<i;t++)s.push(e.r,e.g,e.b,e.a)}}onPreRender(t,e){this.positions.length>0&&this.material.transparent===e&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,!1),this.meshInstance||(this.meshInstance=new MeshInstance(this.mesh,this.material,Na)),this.positions.length=0,this.colors.length=0,t.list.push(this.meshInstance),t.length++)}}class ImmediateBatches{constructor(t){this.device=t,this.map=new Map}getBatch(t,e){let s=this.map.get(t);return s||(s=new ImmediateBatch(this.device,t,e),this.map.set(t,s)),s}onPreRender(t,e){this.map.forEach((s=>{s.onPreRender(t,e)}))}}const Ha=[];class Immediate{constructor(t){this.device=t,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}createMaterial(t){const e=new BasicMaterial;return e.vertexColors=!0,e.blend=!0,e.blendType=2,e.depthTest=t,e.update(),e}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(t,e){let s=this.batchesMap.get(t);s||(s=new ImmediateBatches(this.device),this.batchesMap.set(t,s)),this.allBatches.add(s);const i=e?this.materialDepth:this.materialNoDepth;return s.getBatch(i,t)}static getTextureVS(){return"\n\t\t\t\t\t\tattribute vec2 aPosition;\n\t\t\t\t\t\tuniform mat4 matrix_model;\n\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\tvoid main(void) {\n\t\t\t\t\t\t\t\tgl_Position = matrix_model * vec4(aPosition, 0, 1);\n\t\t\t\t\t\t\t\tuv0 = aPosition.xy + 0.5;\n\t\t\t\t\t\t}\n\t\t\t\t"}getTextureShader(){if(!this.textureShader){const t={attributes:{aPosition:ot},vshader:Immediate.getTextureVS(),fshader:"\n\t\t\t\t\t\t\t\t\t\tprecision lowp float;\n\t\t\t\t\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\t\t\t\t\tuniform sampler2D colorMap;\n\t\t\t\t\t\t\t\t\t\tvoid main (void) {\n\t\t\t\t\t\t\t\t\t\t\t\tgl_FragColor = vec4(texture2D(colorMap, uv0).xyz, 1);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t"};this.textureShader=new Shader(this.device,t)}return this.textureShader}getDepthTextureShader(){if(!this.depthTextureShader){const t=this.device.webgl2?"#define GL2":"",e={attributes:{aPosition:ot},vshader:Immediate.getTextureVS(),fshader:`\n\t\t\t\t\t\t\t\t\t\tprecision ${this.device.precision} float;\n\t\t\t\t\t\t\t\t\t\t${t}\n\t\t\t\t\t\t\t\t\t\t${Zt.screenDepthPS}\n\t\t\t\t\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\t\t\t\t\tvoid main() {\n\t\t\t\t\t\t\t\t\t\t\t\tfloat depth = getLinearScreenDepth(uv0) * camera_params.x;\n\t\t\t\t\t\t\t\t\t\t\t\tgl_FragColor = vec4(vec3(depth), 1.0);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t`};this.depthTextureShader=new Shader(this.device,e)}return this.depthTextureShader}getQuadMesh(){return this.quadMesh||(this.quadMesh=new Mesh(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(5)),this.quadMesh}drawMesh(t,e,s,i,n){if(!i){const n=this.getGraphNode(e);i=new MeshInstance(s,t,n)}let a=this.layerMeshInstances.get(n);a||(a=[],this.layerMeshInstances.set(n,a)),a.push(i)}drawWireAlignedBox(t,e,s,i,n){Ha.push(t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,t.z,t.x,e.y,e.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,t.y,t.z,e.x,t.y,e.z);this.getBatch(n,i).addLinesArrays(Ha,s),Ha.length=0}drawWireSphere(t,e,s,i,n,a){const r=2*Math.PI/i;let o=0;for(let l=0;l<i;l++){const s=Math.sin(o),i=Math.cos(o);o+=r;const n=Math.sin(o),a=Math.cos(o);Ha.push(t.x+e*s,t.y,t.z+e*i),Ha.push(t.x+e*n,t.y,t.z+e*a),Ha.push(t.x+e*s,t.y+e*i,t.z),Ha.push(t.x+e*n,t.y+e*a,t.z),Ha.push(t.x,t.y+e*s,t.z+e*i),Ha.push(t.x,t.y+e*n,t.z+e*a)}this.getBatch(a,n).addLinesArrays(Ha,s),Ha.length=0}getGraphNode(t){const e=new GraphNode;return e.worldTransform=t,e._dirtyWorld=e._dirtyNormal=!1,e}onPreRenderLayer(t,e,s){if(this.batchesMap.forEach(((i,n)=>{n===t&&i.onPreRender(e,s)})),!this.updatedLayers.has(t)){this.updatedLayers.add(t);const s=this.layerMeshInstances.get(t);if(s){for(let t=0;t<s.length;t++)e.list[e.length+t]=s[t];e.length+=s.length,s.length=0}}}onPostRender(){this.allBatches.clear(),this.updatedLayers.clear()}}class Scene$1 extends EventHandler{constructor(t){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new Color(0,0,0),this.exposure=1,this.fogColor=new Color(0,0,0),this.fogDensity=0,this.fogEnd=1e3,this.fogStart=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this.lightmapFilterEnabled=!1,this.root=null,this.device=t||ei().graphicsDevice,this._gravity=new Vec3(0,-9.8,0),this._layers=null,this._fog=K,this._gammaCorrection=1,this._toneMapping=0,this._skyboxCubeMap=null,this._prefilteredCubemaps=[null,null,null,null,null,null],this._envAtlas=null,this._internalEnvAtlas=null,this.skyboxModel=null,this._skyboxIntensity=1,this._skyboxMip=0,this._skyboxRotation=new Quat,this._skyboxRotationMat3=null,this._skyboxRotationMat4=null,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!1,this._lightingParams=new LightingParams(this.device.supportsAreaLights,this.device.maxTextureSize,(()=>{this._layers._dirtyLights=!0})),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this._statsUpdated=!1,this._models=[],this.immediate=new Immediate(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(3)}set ambientBakeNumSamples(t){this._ambientBakeNumSamples=O.clamp(Math.floor(t),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(t){this._ambientBakeSpherePart=O.clamp(t,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(t){!this._clusteredLightingEnabled||t?this._clusteredLightingEnabled=t:console.error("Turning off enabled clustered lighting is not currently supported")}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set drawCalls(t){}get drawCalls(){let t=this.layers._meshInstances;return t.length||(this.layers._update(this.device,this.clusteredLightingEnabled),t=this.layers._meshInstances),t}set envAtlas(t){t!==this._envAtlas&&(this._envAtlas=t,this.updateShaders=!0)}get envAtlas(){return this._envAtlas}set fog(t){t!==this._fog&&(this._fog=t,this.updateShaders=!0)}get fog(){return this._fog}set gammaCorrection(t){t!==this._gammaCorrection&&(this._gammaCorrection=t,this.updateShaders=!0)}get gammaCorrection(){return this._gammaCorrection}set layers(t){const e=this._layers;this._layers=t,this.fire("set:layers",e,t)}get layers(){return this._layers}get lighting(){return this._lightingParams}set lightmapFilterRange(t){this._lightmapFilterRange=Math.max(t,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(t){this._lightmapFilterSmoothness=Math.max(t,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(t){const e=this._prefilteredCubemaps;t=t||[];let s=!1,i=!0;for(let n=0;n<6;++n){const a=t[n]||null;e[n]!==a&&(e[n]=a,s=!0),i=i&&!!e[n]}s&&(this._resetSkyboxModel(),i?(this._internalEnvAtlas=EnvLighting.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas||(this.envAtlas=this._internalEnvAtlas)):this._internalEnvAtlas&&(this._envAtlas===this._internalEnvAtlas&&(this.envAtlas=null),this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null))}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(t){t!==this._skyboxCubeMap&&(this._skyboxCubeMap=t,this._resetSkyboxModel())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(t){t!==this._skyboxIntensity&&(this._skyboxIntensity=t,this._resetSkyboxModel())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxMip(t){t!==this._skyboxMip&&(this._skyboxMip=t,this._resetSkyboxModel())}get skyboxMip(){return this._skyboxMip}set skyboxRotation(t){this._skyboxRotation.equals(t)||(this._skyboxRotation.copy(t),this._resetSkyboxModel())}get skyboxRotation(){return this._skyboxRotation}set toneMapping(t){t!==this._toneMapping&&(this._toneMapping=t,this.updateShaders=!0)}get toneMapping(){return this._toneMapping}destroy(){this._resetSkyboxModel(),this.root=null,this.off()}drawLine(t,e,s=Color.WHITE,i=!0,n=this.defaultDrawLayer){this.immediate.getBatch(n,i).addLines([t,e],[s,s])}drawLines(t,e,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLines(t,e)}drawLineArrays(t,e,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLinesArrays(t,e)}applySettings(t){this._gravity.set(t.physics.gravity[0],t.physics.gravity[1],t.physics.gravity[2]),this.ambientLight.set(t.render.global_ambient[0],t.render.global_ambient[1],t.render.global_ambient[2]),this._fog=t.render.fog,this.fogColor.set(t.render.fog_color[0],t.render.fog_color[1],t.render.fog_color[2]),this.fogStart=t.render.fog_start,this.fogEnd=t.render.fog_end,this.fogDensity=t.render.fog_density,this._gammaCorrection=t.render.gamma_correction,this._toneMapping=t.render.tonemapping,this.lightmapSizeMultiplier=t.render.lightmapSizeMultiplier,this.lightmapMaxResolution=t.render.lightmapMaxResolution,this.lightmapMode=t.render.lightmapMode,this.exposure=t.render.exposure,this._skyboxIntensity=void 0===t.render.skyboxIntensity?1:t.render.skyboxIntensity,this._skyboxMip=void 0===t.render.skyboxMip?0:t.render.skyboxMip,t.render.skyboxRotation&&this._skyboxRotation.setFromEulerAngles(t.render.skyboxRotation[0],t.render.skyboxRotation[1],t.render.skyboxRotation[2]),this._resetSkyboxModel()}_getSkyboxTex(){const t=this._prefilteredCubemaps;if(this._skyboxMip){return t[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||t[0]||this._skyboxCubeMap}return this._skyboxCubeMap||t[0]||this._envAtlas}_updateSkybox(t){if(this.skyboxModel)return;const e=this._getSkyboxTex();if(!e)return;const s=new Material$1,i=this;s.updateShader=function(s,n,a,r,o){const l=t.getProgramLibrary();e.cubemap?this.shader=l.getProgram("skybox",{type:"cubemap",rgbm:e.type===Ot,hdr:e.type===Ot||e.format===rt,useIntensity:1!==i.skyboxIntensity,mip:e.fixCubemapSeams?i.skyboxMip:0,fixSeams:e.fixCubemapSeams,gamma:1===o?i.gammaCorrection?3:0:i.gammaCorrection,toneMapping:1===o?0:i.toneMapping}):this.shader=l.getProgram("skybox",{type:"envAtlas",encoding:e.encoding,useIntensity:1!==i.skyboxIntensity,gamma:1===o?i.gammaCorrection?3:0:i.gammaCorrection,toneMapping:1===o?0:i.toneMapping})},s.updateShader(),e.cubemap?s.setParameter("texture_cubeMap",e):(s.setParameter("texture_envAtlas",e),s.setParameter("mipLevel",this._skyboxMip)),this.skyboxRotation.equals(Quat.IDENTITY)?s.setParameter("cubeMapRotationMatrix",Mat3.IDENTITY.data):(this._skyboxRotationMat4||(this._skyboxRotationMat4=new Mat4),this._skyboxRotationMat3||(this._skyboxRotationMat3=new Mat3),this._skyboxRotationMat4.setTRS(Vec3.ZERO,this._skyboxRotation,Vec3.ONE),this._skyboxRotationMat4.invertTo3x3(this._skyboxRotationMat3),s.setParameter("cubeMapRotationMatrix",this._skyboxRotationMat3.data)),s.cull=2,s.depthWrite=!1;const n=this.layers.getLayerById(2);if(n){const i=new GraphNode("Skybox"),a=di(t),r=new MeshInstance(a,s,i);r.cull=!1,r._noDepthDrawGl1=!0,r.pick=!1;const o=new Model;o.graph=i,o.meshInstances=[r],this.skyboxModel=o,n.addMeshInstances(o.meshInstances),this.skyLayer=n,this.fire("set:skybox",e)}}_resetSkyboxModel(){this.skyboxModel&&(this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),this.skyboxModel.destroy()),this.skyboxModel=null,this.updateShaders=!0}setSkybox(t){t?(this.skybox=t[0]||null,this.prefilteredCubemaps=t.slice(1)):(this.skybox=null,this.prefilteredCubemaps=[null,null,null,null,null,null])}addModel(t){if(this.containsModel(t))return;const e=this.layers.getLayerById(0);e&&(e.addMeshInstances(t.meshInstances),this._models.push(t))}addShadowCaster(t){const e=this.layers.getLayerById(0);e&&e.addShadowCasters(t.meshInstances)}removeModel(t){const e=this._models.indexOf(t);if(-1!==e){const s=this.layers.getLayerById(0);if(!s)return;s.removeMeshInstances(t.meshInstances),this._models.splice(e,1)}}removeShadowCasters(t){const e=this.layers.getLayerById(0);e&&e.removeShadowCasters(t.meshInstances)}containsModel(t){return this._models.indexOf(t)>=0}getModels(t){return this._models}}function Wa(){return!("undefined"==typeof AudioContext&&"undefined"==typeof webkitAudioContext)}class Channel{constructor(t,e,s={}){if(this.volume=void 0===s.volume?1:s.volume,this.loop=void 0!==s.loop&&s.loop,this.pitch=void 0===s.pitch?1:s.pitch,this.sound=e,this.paused=!1,this.suspended=!1,this.manager=t,this.source=null,Wa()){this.startTime=0,this.startOffset=0;const e=t.context;this.gain=e.createGain()}else e.audio&&(this.source=e.audio.cloneNode(!1),this.source.pause())}getVolume(){return this.volume}getLoop(){return this.loop}setLoop(t){this.loop=t,this.source&&(this.source.loop=t)}getPitch(){return this.pitch}onManagerVolumeChange(){this.setVolume(this.getVolume())}onManagerSuspend(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())}onManagerResume(){this.suspended&&(this.suspended=!1,this.unpause())}play(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())}pause(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)}unpause(){!this.source&&this.paused?(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1)):console.warn("Call pause() before unpausing.")}stop(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)}setVolume(t){t=O.clamp(t,0,1),this.volume=t,this.gain&&(this.gain.gain.value=t*this.manager.volume)}setPitch(t){this.pitch=t,this.source&&(this.source.playbackRate.value=t)}isPlaying(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE}getDuration(){return this.source?this.source.buffer.duration:0}_createSource(){const t=this.manager.context;this.sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}Wa()||Object.assign(Channel.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(t){t=O.clamp(t,0,1),this.volume=t,this.source&&(this.source.volume=t*this.manager.volume)},setPitch:function(t){this.pitch=t,this.source&&(this.source.playbackRate=t)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}});const Ga="linear",ja="inverse",Xa="exponential";class Channel3d extends Channel{constructor(t,e,s){super(t,e,s),this.position=new Vec3,this.velocity=new Vec3,Wa()?this.panner=t.context.createPanner():(this.maxDistance=1e4,this.minDistance=1,this.rollOffFactor=1,this.distanceModel=ja)}getPosition(){return this.position}getVelocity(){return this.velocity}setPosition(t){this.position.copy(t),this.panner.setPosition(t.x,t.y,t.z)}setVelocity(t){this.velocity.copy(t),this.panner.setVelocity(t.x,t.y,t.z)}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(t){this.panner.maxDistance=t}getMinDistance(){return this.panner.refDistance}setMinDistance(t){this.panner.refDistance=t}getRollOffFactor(){return this.panner.rolloffFactor}setRollOffFactor(t){this.panner.rolloffFactor=t}getDistanceModel(){return this.pannel.distanceModel}setDistanceModel(t){this.panner.distanceModel=t}_createSource(){const t=this.manager.context;this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this))}}if(!Wa()){let t=new Vec3;const e=function(e,s,i,n,a,r){t=t.sub2(e,s);const o=t.length();if(o<i)return 1;if(o>n)return 0;let l=0;return r===Ga?l=1-a*(o-i)/(n-i):r===ja?l=i/(i+a*(o-i)):r===Xa&&(l=Math.pow(o/i,-a)),O.clamp(l,0,1)};Object.assign(Channel3d.prototype,{setPosition:function(t){if(this.position.copy(t),this.source){const t=this.manager.listener.getPosition(),s=e(t,this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.getVolume();this.source.volume=i*s}},setVelocity:function(t){this.velocity.copy(t)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(t){this.maxDistance=t},getMinDistance:function(){return this.minDistance},setMinDistance:function(t){this.minDistance=t},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(t){this.rollOffFactor=t},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(t){this.distanceModel=t}})}class Listener{constructor(t){this._manager=t,this.position=new Vec3,this.velocity=new Vec3,this.orientation=new Mat4}getPosition(){return this.position}setPosition(t){this.position.copy(t);const e=this.listener;e&&e.setPosition(t.x,t.y,t.z)}getVelocity(){return this.velocity}setVelocity(t){this.velocity.copy(t);const e=this.listener;e&&e.setPosition(t.x,t.y,t.z)}setOrientation(t){this.orientation.copy(t);const e=this.listener;e&&e.setOrientation(-t.data[8],-t.data[9],-t.data[10],t.data[4],t.data[5],t.data[6])}getOrientation(){return this.orientation}get listener(){const t=this._manager.context;return t?t.listener:null}}class SoundManager extends EventHandler{constructor(t){super(),this._context=null,this._forceWebAudioApi=t.forceWebAudioApi,this._resumeContext=null,this._unlock=null,Wa()||this._forceWebAudioApi?(this._resumeContext=()=>{window.removeEventListener("mousedown",this._resumeContext),window.removeEventListener("touchend",this._resumeContext),this.context&&this.context.resume()},window.addEventListener("mousedown",this._resumeContext),window.addEventListener("touchend",this._resumeContext),S.ios&&(this._unlock=()=>{window.removeEventListener("touchend",this._unlock);const t=this.context;if(t){const e=t.createBuffer(1,1,44100),s=t.createBufferSource();s.buffer=e,s.connect(t.destination),s.start(0),s.disconnect()}},window.addEventListener("touchend",this._unlock))):console.warn("No support for 3D audio found"),this.listener=new Listener(this),this._volume=1,this.suspended=!1}set volume(t){t=O.clamp(t,0,1),this._volume=t,this.fire("volumechange",t)}get volume(){return this._volume}get context(){return this._context||(Wa()||this._forceWebAudioApi)&&("undefined"!=typeof AudioContext?this._context=new AudioContext:"undefined"!=typeof webkitAudioContext&&(this._context=new webkitAudioContext)),this._context}suspend(){this.suspended=!0,this.fire("suspend")}resume(){const t=()=>{this.suspended=!1,this.fire("resume")};!Wa()&&!this._forceWebAudioApi||"interrupted"!==this.context.state&&"suspended"!==this.context.state?t():this.context.resume().then(t)}destroy(){this._resumeContext&&(window.removeEventListener("mousedown",this._resumeContext),window.removeEventListener("touchend",this._resumeContext)),this._unlock&&window.removeEventListener("touchend",this._unlock),this.fire("destroy"),this._context&&this._context.close&&(this._context.close(),this._context=null)}playSound(t,e={}){let s=null;return Channel&&(s=new Channel(this,t,e),s.play()),s}playSound3d(t,e,s={}){let i=null;return Channel3d&&(i=new Channel3d(this,t,s),i.setPosition(e),s.volume&&i.setVolume(s.volume),s.loop&&i.setLoop(s.loop),s.maxDistance&&i.setMaxDistance(s.maxDistance),s.minDistance&&i.setMinDistance(s.minDistance),s.rollOffFactor&&i.setRollOffFactor(s.rollOffFactor),s.distanceModel&&i.setDistanceModel(s.distanceModel),i.play()),i}}class Key{constructor(t,e,s,i){this.time=t,this.position=e,this.rotation=s,this.scale=i}}class Node{constructor(){this._name="",this._keys=[]}}class Animation{constructor(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}getNode(t){return this._nodeDict[t]}addNode(t){this._nodes.push(t),this._nodeDict[t._name]=t}get nodes(){return this._nodes}}class MorphTarget{constructor(t){2===arguments.length&&(t=arguments[1]),this.options=t,this._name=t.name,this._defaultWeight=t.defaultWeight||0,this.aabb=t.aabb,this.aabb||(this.aabb=new BoundingBox,t.deltaPositions&&this.aabb.compute(t.deltaPositions)),this.deltaPositions=t.deltaPositions}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get morphPositions(){return!!this._vertexBufferPositions||!!this.texturePositions}get morphNormals(){return!!this._vertexBufferNormals||!!this.textureNormals}_postInit(){this.options=null}_initVertexBuffers(t){const e=this.options;this._vertexBufferPositions=this._createVertexBuffer(t,e.deltaPositions,e.deltaPositionsType),this._vertexBufferNormals=this._createVertexBuffer(t,e.deltaNormals,e.deltaNormalsType),this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())}_createVertexBuffer(t,e,s=6){if(e){return new VertexBuffer(t,new VertexFormat(t,[{semantic:St,components:3,type:s}]),e.length/3,0,e)}return null}_setTexture(t,e){this[t]=e}destroy(){this._vertexBufferPositions&&(this._vertexBufferPositions.destroy(),this._vertexBufferPositions=null),this._vertexBufferNormals&&(this._vertexBufferNormals.destroy(),this._vertexBufferNormals=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}}class Skin{constructor(t,e,s){this.device=t,this.inverseBindPose=e,this.boneNames=s}}class Render extends EventHandler{constructor(){super(),this._meshes=null}set meshes(t){this.decRefMeshes(),this._meshes=t,this.incRefMeshes(),this.fire("set:meshes",t)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){if(this._meshes){const t=this._meshes.length;for(let e=0;e<t;e++){const t=this._meshes[e];t&&(t.decRefCount(),t.refCount<1&&(t.destroy(),this._meshes[e]=null))}}}incRefMeshes(){if(this._meshes){const t=this._meshes.length;for(let e=0;e<t;e++)this._meshes[e]&&this._meshes[e].incRefCount()}}}class AnimCurve{constructor(t,e,s,i){this._paths=t,this._input=e,this._output=s,this._interpolation=i}get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}}class AnimData{constructor(t,e){this._components=t,this._data=e}get components(){return this._components}get data(){return this._data}}class AnimEvents{constructor(t){this._events=[...t],this._events.sort(((t,e)=>t.time-e.time))}get events(){return this._events}}class AnimTrack{constructor(t,e,s,i,n,a=new AnimEvents([])){this._name=t,this._duration=e,this._inputs=s,this._outputs=i,this._curves=n,this._animEvents=a}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(t){this._animEvents=t}get events(){return this._animEvents.events}eval(t,e){e._time=t;const s=this._inputs,i=this._outputs,n=this._curves,a=e._cache,r=e._results;for(let o=0;o<s.length;++o)a[o].update(t,s[o]._data);for(let o=0;o<n.length;++o){const t=n[o],e=i[t._output],s=r[o];a[t._input].eval(s,t._interpolation,e)}}}const qa="en-US",$a={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},Ya={};function Ka(t,e){for(let s=0,i=t.length;s<i;s++)Ya[t[s]]=e}function Za(t){const e=t.indexOf("-");return-1!==e?t.substring(0,e):t}function Qa(t,e){if(e[t])return t;let s=$a[t];if(s&&e[s])return s;const i=Za(t);return s=$a[i],e[s]?s:e[i]?i:qa}Ka(["ja","ko","th","vi","zh","id"],(function(t){return 0})),Ka(["fa","hi"],(function(t){return t>=0&&t<=1?0:1})),Ka(["fr","pt"],(function(t){return t>=0&&t<2?0:1})),Ka(["da"],(function(t){return 1===t||!Number.isInteger(t)&&t>=0&&t<=1?0:1})),Ka(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],(function(t){return 1===t?0:1})),Ka(["ru","uk"],(function(t){if(Number.isInteger(t)){const e=t%10,s=t%100;if(1===e&&11!==s)return 0;if(e>=2&&e<=4&&(s<12||s>14))return 1;if(0===e||e>=5&&e<=9||s>=11&&s<=14)return 2}return 3})),Ka(["pl"],(function(t){if(Number.isInteger(t)){if(1===t)return 0;const e=t%10,s=t%100;if(e>=2&&e<=4&&(s<12||s>14))return 1;if(e>=0&&e<=1||e>=5&&e<=9||s>=12&&s<=14)return 2}return 3})),Ka(["ar"],(function(t){if(0===t)return 0;if(1===t)return 1;if(2===t)return 2;if(Number.isInteger(t)){const e=t%100;if(e>=3&&e<=10)return 3;if(e>=11&&e<=99)return 4}return 5}));const Ja=Ya[Za(qa)];function tr(t){return Ya[t]||Ja}const er=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-\\+\\.]*:)?//|data:|blob:)","i");class AssetFile{constructor(t,e,s,i,n,a){this.url=t||"",this.filename=e||"",this.hash=void 0===s?null:s,this.size=void 0===i?null:i,this.opt=void 0===n?null:n,this.contents=a||null}equals(t){return this.url===t.url&&this.filename===t.filename&&this.hash===t.hash&&this.size===t.size&&this.opt===t.opt&&this.contents===t.contents}}let sr=-1;const ir={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},nr=["pvr","dxt","etc2","etc1","basis"];class Asset extends EventHandler{constructor(t,e,s,i,n){super(),this._id=sr--,this.name=t||"",this.type=e,this.tags=new Tags(this),this._preload=!1,this._file=null,this._data=i||{},this.options=n||{},this._resources=[],this._i18n={},this.loaded=!1,this.loading=!1,this.registry=null,s&&(this.file=s)}set id(t){this._id=t}get id(){return this._id}set file(t){if(t&&t.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){var e,s;const i=(null==(e=this.registry)||null==(s=e._loader)?void 0:s._app)||ei(),n=null==i?void 0:i.graphicsDevice;if(n)for(let e=0,s=nr.length;e<s;e++){const s=nr[e];if(t.variants[s]&&n[ir[s]]){t=t.variants[s];break}if(i.enableBundles){const t=i.bundles.listBundlesForAsset(this);if(t&&t.find((t=>{var e;return null==t||null==(e=t.file)?void 0:e.variants[s]})))break}}}const i=this._file,n=t?new AssetFile(t.url,t.filename,t.hash,t.size,t.opt,t.contents):null;(!!n!=!!i||n&&!n.equals(i))&&(this._file=n,this.fire("change",this,"file",n,i),this.reload())}get file(){return this._file}set data(t){const e=this._data;this._data=t,t!==e&&(this.fire("change",this,"data",t,e),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(t){const e=this._resources[0];this._resources[0]=t,this.fire("change",this,"resource",t,e)}get resource(){return this._resources[0]}set resources(t){const e=this._resources;this._resources=t,this.fire("change",this,"resources",t,e)}get resources(){return this._resources}set preload(t){t=!!t,this._preload!==t&&(this._preload=t,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(t){t=!!t,this.hasOwnProperty("_loadFaces")&&t===this._loadFaces||(this._loadFaces=t,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){const t=this.file;if(!t||!t.url)return null;let e=t.url;if(this.registry&&this.registry.prefix&&!er.test(e)&&(e=this.registry.prefix+e),"script"!==this.type&&t.hash){const s=-1!==e.indexOf("?")?"&":"?";e+=s+"t="+t.hash}return e}getAbsoluteUrl(t){if(t.startsWith("blob:")||t.startsWith("data:"))return t;const e=c.getDirectory(this.file.url);return c.join(e,t)}getLocalizedAssetId(t){return t=Qa(t,this._i18n),this._i18n[t]||null}addLocalizedAssetId(t,e){this._i18n[t]=e,this.fire("add:localized",t,e)}removeLocalizedAssetId(t){const e=this._i18n[t];e&&(delete this._i18n[t],this.fire("remove:localized",t,e))}ready(t,e){e=e||this,this.resource?t.call(e,this):this.once("load",(function(s){t.call(e,s)}))}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&0===this._resources.length)return;this.fire("unload",this),this.registry.fire("unload:"+this.id,this);const t=this._resources;this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let e=0;e<t.length;++e){const s=t[e];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(t,e,s,i=0){var n;null!=s&&null!=(n=s.file)&&n.contents?setTimeout((()=>{e(null,s.file.contents)})):V.get(t,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},e)}}class SkinInstanceCachedObject extends RefCountedObject{constructor(t,e){super(),this.skin=t,this.skinInstance=e}}class SkinInstanceCache{static createCachedSkinInstance(t,e,s){let i=SkinInstanceCache.getCachedSkinInstance(t,e);return i||(i=new SkinInstance(t),i.resolve(e,s),SkinInstanceCache.addCachedSkinInstance(t,e,i)),i}static getCachedSkinInstance(t,e){let s=null;const i=SkinInstanceCache._skinInstanceCache.get(e);if(i){const e=i.find((e=>e.skin===t));e&&(e.incRefCount(),s=e.skinInstance)}return s}static addCachedSkinInstance(t,e,s){let i=SkinInstanceCache._skinInstanceCache.get(e);i||(i=[],SkinInstanceCache._skinInstanceCache.set(e,i));let n=i.find((e=>e.skin===t));n||(n=new SkinInstanceCachedObject(t,s),i.push(n)),n.incRefCount()}static removeCachedSkinInstance(t){if(t){const e=t.rootBone;if(e){const s=SkinInstanceCache._skinInstanceCache.get(e);if(s){const i=s.findIndex((e=>e.skinInstance===t));if(i>=0){const n=s[i];n.decRefCount(),0===n.refCount&&(s.splice(i,1),s.length||SkinInstanceCache._skinInstanceCache.delete(e),t&&(t.destroy(),n.skinInstance=null))}}}}}}SkinInstanceCache._skinInstanceCache=new Map;class GlbContainerResource{constructor(t,e,s,i){const n=function(t,i,n){const a=GlbContainerResource.createAsset(e.name,t,i,n);return s.add(a),a},a=[];for(let l=0;l<t.renders.length;++l)a.push(n("render",t.renders[l],l));const r=[];for(let l=0;l<t.materials.length;++l)r.push(n("material",t.materials[l],l));const o=[];for(let l=0;l<t.animations.length;++l)o.push(n("animation",t.animations[l],l));this.data=t,this._model=null,this._assetName=e.name,this._assets=s,this._defaultMaterial=i,this.renders=a,this.materials=r,this.textures=t.textures,this.animations=o}get model(){if(!this._model){const t=GlbContainerResource.createModel(this.data,this._defaultMaterial),e=GlbContainerResource.createAsset(this._assetName,"model",t,0);this._assets.add(e),this._model=e}return this._model}static createAsset(t,e,s,i){const n=new Asset(t+"/"+e+"/"+i,e,{url:""});return n.resource=s,n.loaded=!0,n}instantiateModelEntity(t){const e=new Entity;return e.addComponent("model",Object.assign({type:"asset",asset:this.model},t)),e}instantiateRenderEntity(t){const e=this._defaultMaterial,s=[],i=function(t,i,n,a,r,o){const l=void 0===n.materialIndex?e:a[n.materialIndex],h=new MeshInstance(n,l);return n.morph&&(h.morphInstance=new MorphInstance(n.morph)),o.hasOwnProperty("skin")&&s.push({meshInstance:h,rootBone:t,entity:i}),h},n=function e(s,n,a){const r=new Entity;n._cloneInternal(r),s||(s=r);let o=null;for(let t=0;t<a.nodes.length;t++){if(a.nodes[t]===n){const e=a.gltf.nodes[t];if(e.hasOwnProperty("mesh")){const t=a.renders[e.mesh].meshes;for(var l=0;l<t.length;l++){const n=t[l];if(n){const t=i(s,r,n,a.materials,a.skins,e);o||(o=[]),o.push(t)}}}if(a.lights){const t=a.lights.get(e);t&&r.addChild(t.clone())}if(a.cameras){const t=a.cameras.get(e);t&&t.camera.system.cloneComponent(t,r)}}}o&&r.addComponent("render",Object.assign({type:"asset",meshInstances:o,rootBone:s},t));const h=n.children;for(let t=0;t<h.length;t++){const i=e(s,h[t],a);r.addChild(i)}return r},a=[];for(const r of this.data.scenes)a.push(n(null,r,this.data));return s.forEach((t=>{t.meshInstance.skinInstance=SkinInstanceCache.createCachedSkinInstance(t.meshInstance.mesh.skin,t.rootBone,t.entity)})),GlbContainerResource.createSceneHierarchy(a,"Entity")}static createSceneHierarchy(t,e){let s=null;if(1===t.length)s=t[0];else{s=new e("SceneGroup");for(const e of t)s.addChild(e)}return s}static createModel(t,e){const s=function(t,s,i,n,a,r,o){const l=void 0===s.materialIndex?e:a[s.materialIndex],h=new MeshInstance(s,l,r);if(s.morph){const e=new MorphInstance(s.morph);h.morphInstance=e,t.morphInstances.push(e)}if(o.hasOwnProperty("skin")){const e=o.skin,a=i[e];s.skin=a;const r=n[e];h.skinInstance=r,t.skinInstances.push(r)}t.meshInstances.push(h)},i=new Model,n=[];for(const r of t.skins){const t=new SkinInstance(r);t.bones=r.bones,n.push(t)}i.graph=GlbContainerResource.createSceneHierarchy(t.scenes,"GraphNode");for(let r=0;r<t.nodes.length;r++){const e=t.nodes[r];if(e.root===i.graph){const o=t.gltf.nodes[r];if(o.hasOwnProperty("mesh")){const r=t.renders[o.mesh].meshes;for(var a=0;a<r.length;a++){const l=r[a];l&&s(i,l,t.skins,n,t.materials,e,o)}}}}return i}destroy(){const t=this._assets,e=function(e){t.remove(e),e.unload()},s=function(t){t.forEach((function(t){e(t)}))};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(e(this._model),this._model=null),this.data=null,this.assets=null}}class GlbResources{constructor(t){this.gltf=t,this.nodes=null,this.scenes=null,this.animations=null,this.textures=null,this.materials=null,this.renders=null,this.skins=null,this.lights=null,this.cameras=null}destroy(){this.renders&&this.renders.forEach((t=>{t.meshes=null}))}}const ar=function(t){return/^data:.*,.*$/i.test(t)},rr=function(t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":default:return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}},or=function(t){switch(t){case 5120:default:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6}},lr=function(t){switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},hr={POSITION:ot,NORMAL:lt,TANGENT:ht,COLOR_0:ut,JOINTS_0:dt,WEIGHTS_0:ct,TEXCOORD_0:mt,TEXCOORD_1:_t,TEXCOORD_2:ft,TEXCOORD_3:gt,TEXCOORD_4:yt,TEXCOORD_5:vt,TEXCOORD_6:bt,TEXCOORD_7:xt},cr=function(t,e,s){const i=(t=>{switch(t){case 0:return t=>Math.max(t/127,-1);case 1:return t=>t/255;case 2:return t=>Math.max(t/32767,-1);case 3:return t=>t/65535;default:return t=>t}})(s),n=e.length;for(let a=0;a<n;++a)t[a]=i(e[a]);return t},dr=function t(e,s,i=!1){const n=rr(e.type),a=function(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}}(e.componentType);if(!a)return null;const r=s[e.bufferView];let o;if(e.sparse){const i=e.sparse,r={count:i.count,type:"SCALAR"},l=t(Object.assign(r,i.indices),s,!0),h={count:i.count,type:e.scalar,componentType:e.componentType},c=t(Object.assign(h,i.values),s,!0);if(e.hasOwnProperty("bufferView")){o=t({bufferView:e.bufferView,byteOffset:e.byteOffset,componentType:e.componentType,count:e.count,type:e.type},s,!0).slice()}else o=new a(e.count*n);for(let t=0;t<i.count;++t){const e=l[t];for(let s=0;s<n;++s)o[e*n+s]=c[t*n+s]}}else if(i&&r.hasOwnProperty("byteStride")){const t=n*a.BYTES_PER_ELEMENT,s=new ArrayBuffer(e.count*t),i=new Uint8Array(s);let l=0;for(let n=0;n<e.count;++n){let s=(e.byteOffset||0)+n*r.byteStride;for(let e=0;e<t;++e)i[l++]=r[s++]}o=new a(s)}else o=new a(r.buffer,r.byteOffset+(e.byteOffset||0),e.count*n);return o},ur=function(t,e){const s=dr(t,e,!0);if(s instanceof Float32Array||!t.normalized)return s;const i=new Float32Array(s.length);return cr(i,s,or(t.componentType)),i},pr=function(t){let e=t.min,s=t.max;if(!e||!s)return null;if(t.normalized){const i=or(t.componentType);e=cr([],e,i),s=cr([],s,i)}return new BoundingBox(new Vec3(.5*(s[0]+e[0]),.5*(s[1]+e[1]),.5*(s[2]+e[2])),new Vec3(.5*(s[0]-e[0]),.5*(s[1]-e[1]),.5*(s[2]-e[2])))},mr=function(t,e){const s=t.POSITION;if(!s||3!==s.components)return;let i;if(s.size!==s.stride){const t=s.stride/Wt[s.type],e=new Ht[s.type](s.buffer,s.offset,s.count*t);i=new Ht[s.type](3*s.count);for(let n=0;n<s.count;++n)i[3*n+0]=e[n*t+0],i[3*n+1]=e[n*t+1],i[3*n+2]=e[n*t+2]}else i=new Ht[s.type](s.buffer,s.offset,3*s.count);const n=s.count;e||(e=function(t){const e=new Uint16Array(t);for(let s=0;s<t;s++)e[s]=s;return e}(n));const a=oi(i,e),r=new Float32Array(a.length);r.set(a),t.NORMAL={buffer:r.buffer,size:12,offset:0,stride:12,count:n,components:3,type:6}},_r=function(t){const e=new Asset(t.name+"_clone",t.type,t.file,t.data,t.options);return e.loaded=!0,e.resource=function(t){const e=new Texture(t.device,t);return e._levels=function(t){const e=[];for(let s=0;s<t._levels.length;++s){let i=[];if(t.cubemap)for(let e=0;e<6;++e)i.push(t._levels[s][e]);else i=t._levels[s];e.push(i)}return e}(t),e}(t.resource),t.registry.add(e),e},fr=function(t,e,s){const i=e.POSITION;if(!i)return null;const n=i.count,a=[];for(const v in e)e.hasOwnProperty(v)&&a.push({semantic:v,components:e[v].components,type:e[v].type,normalize:!!e[v].normalize});const r=[ot,lt,ht,ut,dt,ct,mt,_t];let o,l,h,c,d,u;a.sort((function(t,e){const s=r.indexOf(t.semantic),i=r.indexOf(e.semantic);return s<i?-1:i<s?1:0}));const p=new VertexFormat(t,a);let m=!0;for(o=0;o<p.elements.length;++o)if(d=p.elements[o],c=e[d.name],u=c.offset-i.offset,c.buffer!==i.buffer||c.stride!==d.stride||c.size!==d.size||u!==d.offset){m=!1;break}const _=new VertexBuffer(t,p,n,0),f=_.lock(),g=new Uint32Array(f);let y;if(m)y=new Uint32Array(i.buffer,i.offset,n*_.format.size/4),g.set(y);else{let t,s;for(o=0;o<_.format.elements.length;++o){d=_.format.elements[o],t=d.stride/4,c=e[d.name],s=c.stride/4,y=new Uint32Array(c.buffer,c.offset,(c.count-1)*s+(c.size+3)/4);let i=0,a=d.offset/4;const r=Math.floor((c.size+3)/4);for(l=0;l<n;++l){for(h=0;h<r;++h)g[a+h]=y[i+h];i+=s,a+=t}}}return s&&function(t){let e,s;const i=[],n=[],a=[];for(e=0;e<t.format.elements.length;++e){const s=t.format.elements[e];if(s.name===mt||s.name===_t)switch(s.dataType){case 6:i.push({offset:s.offset/4+1,stride:s.stride/4});break;case 3:n.push({offset:s.offset/2+1,stride:s.stride/2});break;case 1:a.push({offset:s.offset+1,stride:s.stride})}}const r=function(i,n,a){const r=new n(t.storage);for(e=0;e<i.length;++e){let n=i[e].offset;const o=i[e].stride;for(s=0;s<t.numVertices;++s)r[n]=a-r[n],n+=o}};i.length>0&&r(i,Float32Array,1),n.length>0&&r(n,Uint16Array,65535),a.length>0&&r(a,Uint8Array,255)}(_),_.unlock(),_},gr=new Mat4,yr=new Vec3,vr=function(t,e,s,i,n,a,r){const o=[];return e.primitives.forEach((function(l){let h,c,d,u=null,p=!0;if(l.hasOwnProperty("extensions")){const e=l.extensions;if(e.hasOwnProperty("KHR_draco_mesh_compression")){const s=window.DracoDecoderModule;if(s){const r=e.KHR_draco_mesh_compression;if(r.hasOwnProperty("attributes")){const e=i[r.bufferView],o=new s.DecoderBuffer;o.Init(e,e.length);const l=new s.Decoder,m=l.GetEncodedGeometryType(o);let _,f;switch(m){case s.POINT_CLOUD:h=0,_=new s.PointCloud,f=l.DecodeBufferToPointCloud(o,_);break;case s.TRIANGULAR_MESH:h=4,_=new s.Mesh,f=l.DecodeBufferToMesh(o,_);case s.INVALID_GEOMETRY_TYPE:}if(!f||!f.ok()||0==_.ptr)return void n("Failed to decode draco compressed asset: "+(f?f.error_msg():"Mesh asset - invalid draco compressed geometry type: "+m));const g=_.num_faces();if(m===s.TRIANGULAR_MESH){const t=_.num_points()>65535;d=3*g;const e=d*(t?4:2),i=s._malloc(e);t?(l.GetTrianglesUInt32Array(_,e,i),u=new Uint32Array(s.HEAPU32.buffer,i,d).slice()):(l.GetTrianglesUInt16Array(_,e,i),u=new Uint16Array(s.HEAPU16.buffer,i,d).slice()),s._free(i)}c=function(t,e,s,i,n,a,r){const o=e.num_points(),l=function(t){const s=i.GetAttributeByUniqueId(e,t),a=o*s.num_components();let r,l,h,c;switch(s.data_type()){case n.DT_UINT8:c=1,h=1,r=n._malloc(a*h),i.GetAttributeDataArrayForAllPoints(e,s,n.DT_UINT8,a*h,r),l=new Uint8Array(n.HEAPU8.buffer,r,a).slice();break;case n.DT_UINT16:c=3,h=2,r=n._malloc(a*h),i.GetAttributeDataArrayForAllPoints(e,s,n.DT_UINT16,a*h,r),l=new Uint16Array(n.HEAPU16.buffer,r,a).slice();break;case n.DT_FLOAT32:default:c=6,h=4,r=n._malloc(a*h),i.GetAttributeDataArrayForAllPoints(e,s,n.DT_FLOAT32,a*h,r),l=new Float32Array(n.HEAPF32.buffer,r,a).slice()}return n._free(r),{values:l,numComponents:s.num_components(),componentSizeInBytes:h,storageType:c,normalized:s.normalized()}},h={},c=s.attributes;for(const d in c)if(c.hasOwnProperty(d)&&hr.hasOwnProperty(d)){const t=hr[d],e=l(c[d]),s=e.numComponents*e.componentSizeInBytes;h[t]={values:e.values,buffer:e.values.buffer,size:s,offset:0,stride:s,count:o,components:e.numComponents,type:e.storageType,normalize:e.normalized}}return h.hasOwnProperty(lt)||mr(h,a),fr(t,h,r)}(t,_,r,l,s,u,a),s.destroy(_),s.destroy(l),s.destroy(o),p=!1}}}}c||(u=l.hasOwnProperty("indices")?dr(s[l.indices],i,!0):null,c=function(t,e,s,i,n,a,r){const o={},l=[];for(const d in e)e.hasOwnProperty(d)&&hr.hasOwnProperty(d)&&(o[d]=e[d],l.push(d+":"+e[d]));l.sort();const h=l.join();let c=r[h];if(!c){const l={};for(const t in o){const s=i[e[t]],a=dr(s,n),r=n[s.bufferView],o=hr[t],h=rr(s.type)*lr(s.componentType),c=r.hasOwnProperty("byteStride")?r.byteStride:h;l[o]={buffer:a.buffer,size:h,offset:a.byteOffset,stride:c,count:s.count,components:rr(s.type),type:or(s.componentType),normalize:s.normalized}}l.hasOwnProperty(lt)||mr(l,s),c=fr(t,l,a),r[h]=c}return c}(t,l.attributes,u,s,i,a,r),h=function(t){if(!t.hasOwnProperty("mode"))return 4;switch(t.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:default:return 4;case 5:return 5;case 6:return 6}}(l));let m=null;if(c){if(m=new Mesh(t),m.vertexBuffer=c,m.primitive[0].type=h,m.primitive[0].base=0,m.primitive[0].indexed=null!==u,null!==u){let e;e=u instanceof Uint8Array?0:u instanceof Uint16Array?1:2,2!==e||t.extUintElement||(e=1,u=new Uint16Array(u));const s=new IndexBuffer(t,e,u.length,0,u);m.indexBuffer[0]=s,m.primitive[0].count=u.length}else m.primitive[0].count=c.numVertices;m.materialIndex=l.material;let n=s[l.attributes.POSITION];if(m.aabb=pr(n),p&&l.hasOwnProperty("targets")){const a=[];l.targets.forEach((function(t,r){const o={};t.hasOwnProperty("POSITION")&&(n=s[t.POSITION],o.deltaPositions=ur(n,i),o.deltaPositionsType=6,o.aabb=pr(n)),t.hasOwnProperty("NORMAL")&&(n=s[t.NORMAL],o.deltaNormals=ur(n,i),o.deltaNormalsType=6),e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")?o.name=e.extras.targetNames[r]:o.name=r.toString(10),e.hasOwnProperty("weights")&&(o.defaultWeight=e.weights[r]),a.push(new MorphTarget(o))})),m.morph=new Morph(a,t)}}o.push(m)})),o},br=function(t,e,s){const i=["#ifdef MAPFLOAT","uniform float material_shininess;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_glossMap;","#endif","","void getGlossiness() {","\t\tdGlossiness = 1.0;","","#ifdef MAPFLOAT","\t\tdGlossiness *= material_shininess;","#endif","","#ifdef MAPTEXTURE","\t\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;","#endif","","#ifdef MAPVERTEX","\t\tdGlossiness *= saturate(vVertexColor.$VC);","#endif","","\t\tdGlossiness = 1.0 - dGlossiness;","","\t\tdGlossiness += 0.0000001;","}"].join("\n"),n=["#ifdef MAPCOLOR","uniform vec3 material_specular;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_specularMap;","#endif","","void getSpecularity() {","\t\tdSpecularity = vec3(1.0);","","\t\t#ifdef MAPCOLOR","\t\t\t\tdSpecularity *= material_specular;","\t\t#endif","","\t\t#ifdef MAPTEXTURE","\t\t\t\tvec3 srgb = texture2D(texture_specularMap, $UV).$CH;","\t\t\t\tdSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));","\t\t#endif","","\t\t#ifdef MAPVERTEX","\t\t\t\tdSpecularity *= saturate(vVertexColor.$VC);","\t\t#endif","}"].join("\n"),a=["#ifdef MAPFLOAT","uniform float material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_clearCoatGlossMap;","#endif","","void getClearCoatGlossiness() {","\t\tccGlossiness = 1.0;","","#ifdef MAPFLOAT","\t\tccGlossiness *= material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","\t\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;","#endif","","#ifdef MAPVERTEX","\t\tccGlossiness *= saturate(vVertexColor.$VC);","#endif","","\t\tccGlossiness = 1.0 - ccGlossiness;","","\t\tccGlossiness += 0.0000001;","}"].join("\n"),r=[0,0],o=[1,1],l=function(t,e,s){var i;let n;const a=t.texCoord;if(a)for(n=0;n<s.length;++n)e[s[n]+"MapUv"]=a;const l=null==(i=t.extensions)?void 0:i.KHR_texture_transform;if(l){const t=l.offset||r,i=l.scale||o,a=l.rotation?-l.rotation*O.RAD_TO_DEG:0,h=new Vec2(i[0],i[1]),c=new Vec2(t[0],1-i[1]-t[1]);for(n=0;n<s.length;++n)e[`${s[n]}MapTiling`]=h,e[`${s[n]}MapOffset`]=c,e[`${s[n]}MapRotation`]=a}},h=new StandardMaterial;let c,d;if(h.occludeSpecular=!0,h.diffuseTint=!0,h.diffuseVertexColor=!0,h.specularTint=!0,h.specularVertexColor=!0,t.hasOwnProperty("name")&&(h.name=t.name),t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness")){const s=t.extensions.KHR_materials_pbrSpecularGlossiness;if(s.hasOwnProperty("diffuseFactor")?(c=s.diffuseFactor,h.diffuse.set(Math.pow(c[0],1/2.2),Math.pow(c[1],1/2.2),Math.pow(c[2],1/2.2)),h.opacity=c[3]):(h.diffuse.set(1,1,1),h.opacity=1),s.hasOwnProperty("diffuseTexture")){const t=s.diffuseTexture;d=e[t.index],h.diffuseMap=d,h.diffuseMapChannel="rgb",h.opacityMap=d,h.opacityMapChannel="a",l(t,h,["diffuse","opacity"])}if(h.useMetalness=!1,s.hasOwnProperty("specularFactor")?(c=s.specularFactor,h.specular.set(Math.pow(c[0],1/2.2),Math.pow(c[1],1/2.2),Math.pow(c[2],1/2.2))):h.specular.set(1,1,1),s.hasOwnProperty("glossinessFactor")?h.shininess=100*s.glossinessFactor:h.shininess=100,s.hasOwnProperty("specularGlossinessTexture")){const t=s.specularGlossinessTexture;h.specularMap=h.glossMap=e[t.index],h.specularMapChannel="rgb",h.glossMapChannel="a",l(t,h,["gloss","metalness"])}h.chunks.specularPS=n}else if(t.hasOwnProperty("pbrMetallicRoughness")){const s=t.pbrMetallicRoughness;if(s.hasOwnProperty("baseColorFactor")?(c=s.baseColorFactor,h.diffuse.set(Math.pow(c[0],1/2.2),Math.pow(c[1],1/2.2),Math.pow(c[2],1/2.2)),h.opacity=c[3]):(h.diffuse.set(1,1,1),h.opacity=1),s.hasOwnProperty("baseColorTexture")){const t=s.baseColorTexture;d=e[t.index],h.diffuseMap=d,h.diffuseMapChannel="rgb",h.opacityMap=d,h.opacityMapChannel="a",l(t,h,["diffuse","opacity"])}if(h.useMetalness=!0,s.hasOwnProperty("metallicFactor")?h.metalness=s.metallicFactor:h.metalness=1,s.hasOwnProperty("roughnessFactor")?h.shininess=100*s.roughnessFactor:h.shininess=100,s.hasOwnProperty("metallicRoughnessTexture")){const t=s.metallicRoughnessTexture;h.metalnessMap=h.glossMap=e[t.index],h.metalnessMapChannel="b",h.glossMapChannel="g",l(t,h,["gloss","metalness"])}h.chunks.glossPS=i}if(t.hasOwnProperty("normalTexture")){const s=t.normalTexture;h.normalMap=e[s.index],l(s,h,["normal"]),s.hasOwnProperty("scale")&&(h.bumpiness=s.scale)}if(t.hasOwnProperty("occlusionTexture")){const s=t.occlusionTexture;h.aoMap=e[s.index],h.aoMapChannel="r",l(s,h,["ao"])}if(t.hasOwnProperty("emissiveFactor")?(c=t.emissiveFactor,h.emissive.set(Math.pow(c[0],1/2.2),Math.pow(c[1],1/2.2),Math.pow(c[2],1/2.2)),h.emissiveTint=!0):(h.emissive.set(0,0,0),h.emissiveTint=!1),t.hasOwnProperty("emissiveTexture")){const s=t.emissiveTexture;h.emissiveMap=e[s.index],l(s,h,["emissive"])}if(t.hasOwnProperty("alphaMode"))switch(t.alphaMode){case"MASK":h.blendType=3,t.hasOwnProperty("alphaCutoff")?h.alphaTest=t.alphaCutoff:h.alphaTest=.5;break;case"BLEND":h.blendType=2;break;default:h.blendType=3}else h.blendType=3;if(t.hasOwnProperty("doubleSided")?(h.twoSidedLighting=t.doubleSided,h.cull=t.doubleSided?0:1):(h.twoSidedLighting=!1,h.cull=1),t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_clearcoat")){const s=t.extensions.KHR_materials_clearcoat;if(s.hasOwnProperty("clearcoatFactor")?h.clearCoat=.25*s.clearcoatFactor:h.clearCoat=0,s.hasOwnProperty("clearcoatTexture")){const t=s.clearcoatTexture;h.clearCoatMap=e[t.index],h.clearCoatMapChannel="r",l(t,h,["clearCoat"])}if(s.hasOwnProperty("clearcoatRoughnessFactor")?h.clearCoatGlossiness=s.clearcoatRoughnessFactor:h.clearCoatGlossiness=0,s.hasOwnProperty("clearcoatRoughnessTexture")){const t=s.clearcoatRoughnessTexture;h.clearCoatGlossMap=e[t.index],h.clearCoatGlossMapChannel="g",l(t,h,["clearCoatGloss"])}if(s.hasOwnProperty("clearcoatNormalTexture")){const t=s.clearcoatNormalTexture;h.clearCoatNormalMap=e[t.index],l(t,h,["clearCoatNormal"]),t.hasOwnProperty("scale")&&(h.clearCoatBumpiness=t.scale)}h.chunks.clearCoatGlossPS=a}return t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_unlit")&&(h.useLighting=!1,h.emissive.copy(h.diffuse),h.emissiveTint=h.diffuseTint,h.emissiveMap=h.diffuseMap,h.emissiveMapUv=h.diffuseMapUv,h.emissiveMapTiling.copy(h.diffuseMapTiling),h.emissiveMapOffset.copy(h.diffuseMapOffset),h.emissiveMapChannel=h.diffuseMapChannel,h.emissiveVertexColor=h.diffuseVertexColor,h.emissiveVertexColorChannel=h.diffuseVertexColorChannel,h.diffuse.set(0,0,0),h.diffuseTint=!1,h.diffuseMap=null,h.diffuseVertexColor=!1),h.update(),h},xr=function(t,e){const s=new GraphNode;if(t.hasOwnProperty("name")&&t.name.length>0?s.name=t.name:s.name="node_"+e,t.hasOwnProperty("matrix")&&(gr.data.set(t.matrix),gr.getTranslation(yr),s.setLocalPosition(yr),gr.getEulerAngles(yr),s.setLocalEulerAngles(yr),gr.getScale(yr),s.setLocalScale(yr)),t.hasOwnProperty("rotation")){const e=t.rotation;s.setLocalRotation(e[0],e[1],e[2],e[3])}if(t.hasOwnProperty("translation")){const e=t.translation;s.setLocalPosition(e[0],e[1],e[2])}if(t.hasOwnProperty("scale")){const e=t.scale;s.setLocalScale(e[0],e[1],e[2])}return s},Sr=function(t,e){const s="orthographic"===t.type?1:0,i=1===s?t.orthographic:t.perspective,n={enabled:!1,projection:s,nearClip:i.znear,aspectRatioMode:0};i.zfar&&(n.farClip=i.zfar),1===s?(n.orthoHeight=.5*i.ymag,i.ymag&&(n.aspectRatioMode=1,n.aspectRatio=i.xmag/i.ymag)):(n.fov=i.yfov*O.RAD_TO_DEG,i.aspectRatio&&(n.aspectRatioMode=1,n.aspectRatio=i.aspectRatio));const a=new Entity(t.name);return a.addComponent("camera",n),a},wr=function(t,e){const s={enabled:!1,type:"point"===t.type?"omni":t.type,color:t.hasOwnProperty("color")?new Color(t.color):Color.WHITE,range:t.hasOwnProperty("range")?t.range:9999,falloffMode:1,intensity:t.hasOwnProperty("intensity")?O.clamp(t.intensity,0,2):1};t.hasOwnProperty("spot")&&(s.innerConeAngle=t.spot.hasOwnProperty("innerConeAngle")?t.spot.innerConeAngle*O.RAD_TO_DEG:0,s.outerConeAngle=t.spot.hasOwnProperty("outerConeAngle")?t.spot.outerConeAngle*O.RAD_TO_DEG:Math.PI/4);const i=new Entity(e.name);return i.rotateLocal(90,0,0),i.addComponent("light",s),i},Cr=function(t,e,s,i){if(!e.hasOwnProperty("skins")||0===e.skins.length)return[];const n=new Map;return e.skins.map((function(a){return function(t,e,s,i,n,a){let r,o,l;const h=e.joints,c=h.length,d=[];if(e.hasOwnProperty("inverseBindMatrices")){const t=e.inverseBindMatrices,n=dr(s[t],i,!0),a=[];for(r=0;r<c;r++){for(o=0;o<16;o++)a[o]=n[16*r+o];l=new Mat4,l.set(a),d.push(l)}}else for(r=0;r<c;r++)l=new Mat4,d.push(l);const u=[];for(r=0;r<c;r++)u[r]=n[h[r]].name;const p=u.join("#");let m=a.get(p);return m||(m=new Skin(t,d,u),a.set(p,m)),m}(t,a,e.accessors,i,s,n)}))},Tr=function(t,e,s,i){if(!t.hasOwnProperty("animations")||0===t.animations.length)return[];const n=i&&i.animation&&i.animation.preprocess,a=i&&i.animation&&i.animation.postprocess;return t.animations.map((function(i,r){n&&n(i);const o=function(t,e,s,i,n){const a=function(t){return new AnimData(rr(t.type),ur(t,i))},r={STEP:0,LINEAR:1,CUBICSPLINE:2},o={},l=[],h={},c=[],d=[];let u;for(u=0;u<t.samplers.length;++u){const e=t.samplers[u];o.hasOwnProperty(e.input)||(o[e.input]=l.length,l.push(a(s[e.input]))),h.hasOwnProperty(e.output)||(h[e.output]=c.length,c.push(a(s[e.output])));const i=e.hasOwnProperty("interpolation")&&r.hasOwnProperty(e.interpolation)?r[e.interpolation]:1;d.push(new AnimCurve([],o[e.input],h[e.output],i))}const p=[],m={translation:"localPosition",rotation:"localRotation",scale:"localScale",weights:"weights"},_=t=>{const e=[];for(;t;)e.unshift(t.name),t=t.parent;return e};for(u=0;u<t.channels.length;++u){const e=t.channels[u],s=e.target,i=d[e.sampler],a=_(n[s.node]);i._paths.push({entityPath:a,component:"graph",propertyPath:[m[s.path]]}),s.path.startsWith("rotation")&&2!==i.interpolation?p.push(i.output):s.path.startsWith("weights")&&(c[i.output]._components=c[i.output].data.length/l[i.input].data.length)}p.sort();let f,g=null;for(u=0;u<p.length;++u){const t=p[u];if(0===u||t!==g){if(f=c[t],4===f.components){const t=f.data,e=t.length-4;for(let s=0;s<e;s+=4)t[s+0]*t[s+4]+t[s+1]*t[s+5]+t[s+2]*t[s+6]+t[s+3]*t[s+7]<0&&(t[s+4]*=-1,t[s+5]*=-1,t[s+6]*=-1,t[s+7]*=-1)}g=t}}let y=0;for(u=0;u<l.length;u++)f=l[u]._data,y=Math.max(y,0===f.length?0:f[f.length-1]);return new AnimTrack(t.hasOwnProperty("name")?t.name:"animation_"+e,y,l,c,d)}(i,r,t.accessors,s,e);return a&&a(i,o),o}))},Mr=function(t,e,s,i,n,a){const r=n&&n.global&&n.global.preprocess,o=n&&n.global&&n.global.postprocess;r&&r(e);const l=e.asset&&"PlayCanvas"===e.asset.generator,h=function(t,e){if(!t.hasOwnProperty("nodes")||0===t.nodes.length)return[];const s=e&&e.node&&e.node.preprocess,i=e&&e.node&&e.node.process||xr,n=e&&e.node&&e.node.postprocess,a=t.nodes.map((function(t,e){s&&s(t);const a=i(t,e);return n&&n(t,a),a}));for(let r=0;r<t.nodes.length;++r){const e=t.nodes[r];if(e.hasOwnProperty("children")){const t=a[r],s={};for(let i=0;i<e.children.length;++i){const n=a[e.children[i]];n.parent||(s.hasOwnProperty(n.name)?n.name+=s[n.name]++:s[n.name]=1,t.addChild(n))}}}return a}(e,n),c=function(t,e){var s;const i=[],n=t.scenes.length;if(1===n&&1===(null==(s=t.scenes[0].nodes)?void 0:s.length)){const s=t.scenes[0].nodes[0];i.push(e[s])}else for(let a=0;a<n;a++){const s=t.scenes[a];if(s.nodes){const t=new GraphNode(s.name);for(let i=0;i<s.nodes.length;i++){const n=e[s.nodes[i]];t.addChild(n)}i.push(t)}}return i}(e,h),d=function(t,e,s){let i=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_lights_punctual")&&t.extensions.KHR_lights_punctual.hasOwnProperty("lights")){const n=t.extensions.KHR_lights_punctual.lights;if(n.length){const a=s&&s.light&&s.light.preprocess,r=s&&s.light&&s.light.process||wr,o=s&&s.light&&s.light.postprocess;t.nodes.forEach((function(t,s){if(t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_lights_punctual")&&t.extensions.KHR_lights_punctual.hasOwnProperty("light")){const l=t.extensions.KHR_lights_punctual.light,h=n[l];if(h){a&&a(h);const n=r(h,e[s]);o&&o(h,n),n&&(i||(i=new Map),i.set(t,n))}}}))}}return i}(e,h,n),u=function(t,e,s){let i=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("cameras")&&t.cameras.length>0){const n=s&&s.camera&&s.camera.preprocess,a=s&&s.camera&&s.camera.process||Sr,r=s&&s.camera&&s.camera.postprocess;t.nodes.forEach((function(s,o){if(s.hasOwnProperty("camera")){const l=t.cameras[s.camera];if(l){n&&n(l);const t=a(l,e[o]);r&&r(l,t),t&&(i||(i=new Map),i.set(s,t))}}}))}return i}(e,h,n),p=Tr(e,h,s,n),m=function(t,e,s,i){if(!t.hasOwnProperty("materials")||0===t.materials.length)return[];const n=s&&s.material&&s.material.preprocess,a=s&&s.material&&s.material.process||br,r=s&&s.material&&s.material.postprocess;return t.materials.map((function(t){n&&n(t);const s=a(t,e,i);return r&&r(t,s),s}))}(e,i.map((function(t){return t.resource})),n,l),_=function(t,e,s,i,n){if(!e.hasOwnProperty("meshes")||0===e.meshes.length||!e.hasOwnProperty("accessors")||0===e.accessors.length||!e.hasOwnProperty("bufferViews")||0===e.bufferViews.length)return[];const a={};return e.meshes.map((function(r){return vr(t,r,e.accessors,s,i,n,a)}))}(t,e,s,a,l),f=Cr(t,e,h,s),g=[];for(let v=0;v<_.length;v++)g[v]=new Render,g[v].meshes=_[v];!function(t,e,s){t.nodes.forEach((t=>{t.hasOwnProperty("mesh")&&t.hasOwnProperty("skin")&&e[t.mesh].meshes.forEach((e=>{e.skin=s[t.skin]}))}))}(e,g,f);const y=new GlbResources(e);y.nodes=h,y.scenes=c,y.animations=p,y.textures=i,y.materials=m,y.renders=g,y.skins=f,y.lights=d,y.cameras=u,o&&o(e,y),a(null,y)};let Ar=0;const Pr=function(t,e,s,i,n,a,r){const o=a&&a.image&&a.image.preprocess,l=a&&a.image&&a.image.processAsync||function(t,e){e(null,null)},h=a&&a.image&&a.image.postprocess,d=function(e){h&&h(t,e),r(null,e)},u={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},p=function(e,s,i,a){const o=(t.name||"gltf-texture")+"-"+Ar++,l={url:e||o};if(s&&(l.contents=s.slice(0).buffer),i){const t=u[i];t&&(l.filename=l.url+"."+t)}const h=new Asset(o,"texture",l,null,a);h.on("load",d),h.on("error",r),n.add(h),n.load(h)};o&&o(t),l(t,(function(n,a){var o;n?r(n):a?d(a):t.hasOwnProperty("uri")?ar(t.uri)?p(t.uri,null,(o=t.uri).substring(o.indexOf(":")+1,o.indexOf(";")),null):p(c.join(i,t.uri),null,null,{crossOrigin:"anonymous"}):t.hasOwnProperty("bufferView")&&t.hasOwnProperty("mimeType")?p(null,s[t.bufferView],t.mimeType,null):r("Invalid image found in gltf (neither uri or bufferView found). index="+e)}))},Er=function(t,e){const s=JSON.parse(function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);let e="";for(let s=0;s<t.length;s++)e+=String.fromCharCode(t[s]);return decodeURIComponent(escape(e))}(t));s.asset&&s.asset.version&&parseFloat(s.asset.version)<2?e(`Invalid gltf version. Expected version 2.0 or above but found version '${s.asset.version}'.`):e(null,s)},Lr=function(t,e,s){t&&t.toLowerCase().endsWith(".glb")?function(t,e){const s=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),i=s.getUint32(0,!0),n=s.getUint32(4,!0),a=s.getUint32(8,!0);if(1179937895!==i)return void e("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+i.toString(16));if(2!==n)return void e("Invalid version number found in glb header. Expected 2, found "+n);if(a<=0||a>s.byteLength)return void e("Invalid length found in glb header. Found "+a);const r=[];let o=12;for(;o<a;){const t=s.getUint32(o,!0);if(o+t+8>s.byteLength)throw new Error("Invalid chunk length found in glb. Found "+t);const e=s.getUint32(o+4,!0),i=new Uint8Array(s.buffer,s.byteOffset+o+8,t);r.push({length:t,type:e,data:i}),o+=t+8}1===r.length||2===r.length?1313821514===r[0].type?r.length>1&&5130562!==r[1].type?e("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+r[1].type.toString(16)):e(null,{gltfChunk:r[0].data,binaryChunk:2===r.length?r[1].data:null}):e("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+r[0].type.toString(16)):e("Invalid number of chunks found in glb file.")}(e,s):s(null,{gltfChunk:e,binaryChunk:null})},Rr=function(t,e,s,i){const n=[],a=s&&s.bufferView&&s.bufferView.preprocess,r=s&&s.bufferView&&s.bufferView.processAsync||function(t,e,s){s(null,null)},o=s&&s.bufferView&&s.bufferView.postprocess;let l=t.bufferViews?t.bufferViews.length:0;if(!l)return void i(null,null);const h=function(e,s){const a=t.bufferViews[e];a.hasOwnProperty("byteStride")&&(s.byteStride=a.byteStride),n[e]=s,o&&o(a,s),0==--l&&i(null,n)};for(let c=0;c<t.bufferViews.length;++c){const s=t.bufferViews[c];a&&a(s),r(s,e,function(t,s,n,a){if(n)i(n);else if(a)h(t,a);else{const i=e[s.buffer],n=new Uint8Array(i.buffer,i.byteOffset+(s.byteOffset||0),s.byteLength);h(t,n)}}.bind(null,c,s))}};class GlbParser{static parseAsync(t,e,s,i,n,a,r){Lr(t,s,(function(t,s){t?r(t):Er(s.gltfChunk,(function(t,o){t?r(t):function(t,e,s,i,n){const a=[];if(!t.buffers||0===t.buffers.length)return void n(null,a);const r=i&&i.buffer&&i.buffer.preprocess,o=i&&i.buffer&&i.buffer.processAsync||function(t,e){e(null,null)},l=i&&i.buffer&&i.buffer.postprocess;let h=t.buffers.length;const d=function(e,s){a[e]=s,l&&l(t.buffers[e],s),0==--h&&n(null,a)};for(let u=0;u<t.buffers.length;++u){const i=t.buffers[u];r&&r(i),o(i,function(t,i,a,r){if(a)n(a);else if(r)d(t,new Uint8Array(r));else if(i.hasOwnProperty("uri"))if(ar(i.uri)){const e=atob(i.uri.split(",")[1]),s=new Uint8Array(e.length);for(let t=0;t<e.length;t++)s[t]=e.charCodeAt(t);d(t,s)}else V.get(c.join(s,i.uri),{cache:!0,responseType:"arraybuffer",retry:!1},function(t,e,s){e?n(e):d(t,new Uint8Array(s))}.bind(null,t));else d(t,e)}.bind(null,u,i))}}(o,s.binaryChunk,e,a,(function(t,s){t?r(t):Rr(o,s,a,(function(t,s){t?r(t):function(t,e,s,i,n,a){if(!t.hasOwnProperty("images")||0===t.images.length||!t.hasOwnProperty("textures")||0===t.textures.length)return void a(null,[]);const r=n&&n.texture&&n.texture.preprocess,o=n&&n.texture&&n.texture.processAsync||function(t,e,s){s(null,null)},l=n&&n.texture&&n.texture.postprocess,h=[],c=[];let d=t.textures.length;const u=function(e,s){if(c[s]||(c[s]=[]),c[s].push(e),0==--d){const e=[];c.forEach((function(s,i){s.forEach((function(s,n){const a=0===n?h[i]:_r(h[i]);!function(t,e){const s=function(t,e){switch(t){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return e}},i=function(t,e){switch(t){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return e}};t&&(e=e||{},t.minFilter=s(e.minFilter,5),t.magFilter=s(e.magFilter,1),t.addressU=i(e.wrapS,0),t.addressV=i(e.wrapT,0))}(a.resource,(t.samplers||[])[t.textures[s].sampler]),e[s]=a,l&&l(t.textures[s],a)}))})),a(null,e)}};for(let p=0;p<t.textures.length;++p){const l=t.textures[p];r&&r(l),o(l,t.images,function(r,o,l,c){var d,p;if(l)a(l);else if(null==c&&void 0===(c=null==o||null==(d=o.extensions)||null==(p=d.KHR_texture_basisu)?void 0:p.source)&&(c=o.source),h[c])u(r,c);else{const o=t.images[c];Pr(o,r,e,s,i,n,(function(t,e){t?a(t):(h[c]=e,u(r,c))}))}}.bind(null,p,l))}}(o,s,e,n,a,(function(t,e){t?r(t):Mr(i,o,s,e,a,r)}))}))}))}))}))}static parse(t,e,s,i){let n=null;return i=i||{},Lr(t,e,(function(t,e){t?console.error(t):Er(e.gltfChunk,(function(t,a){t?console.error(t):Rr(a,[e.binaryChunk],i,(function(t,e){t?console.error(t):Mr(s,a,e,[],i,(function(t,e){t?console.error(t):n=e}))}))}))})),n}constructor(t,e,s){this._device=t,this._assets=e,this._defaultMaterial=DefaultMaterial.get(t),this._maxRetries=s}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}load(t,e,s){Asset.fetchArrayBuffer(t.load,((i,n)=>{i?e(i):GlbParser.parseAsync(this._getUrlWithoutParams(t.original),c.extractPath(t.load),n,this._device,s.registry,s.options,((t,i)=>{t?e(t):e(null,new GlbContainerResource(i,s,this._assets,this._defaultMaterial))}))}),s,this._maxRetries)}open(t,e,s){return e}patch(t,e){}}class AnimationHandler{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.load.startsWith("blob:")||t.load.startsWith("data:"))&&(".glb"===c.getExtension(t.original).toLowerCase()?s.responseType=Http.ResponseType.ARRAY_BUFFER:s.responseType=Http.ResponseType.JSON),V.get(t.load,s,(function(s,i){s?e(`Error loading animation resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){if(".glb"===c.getExtension(t).toLowerCase()){const t=GlbParser.parse("filename.glb",e,null);if(t){const e=t.animations;return t.destroy(),e}return null}return this["_parseAnimationV"+e.animation.version](e)}patch(t,e){}_parseAnimationV3(t){const e=t.animation,s=new Animation;s.name=e.name,s.duration=e.duration;for(let i=0;i<e.nodes.length;i++){const t=new Node,n=e.nodes[i];t._name=n.name;for(let e=0;e<n.keys.length;e++){const s=n.keys[e],i=s.time,a=s.pos,r=s.rot,o=s.scale,l=new Vec3(a[0],a[1],a[2]),h=(new Quat).setFromEulerAngles(r[0],r[1],r[2]),c=new Vec3(o[0],o[1],o[2]),d=new Key(i,l,h,c);t._keys.push(d)}s.addNode(t)}return s}_parseAnimationV4(t){const e=t.animation,s=new Animation;s.name=e.name,s.duration=e.duration;for(let i=0;i<e.nodes.length;i++){const t=new Node,n=e.nodes[i];t._name=n.name;const a=n.defaults.p,r=n.defaults.r,o=n.defaults.s;for(let e=0;e<n.keys.length;e++){const s=n.keys[e],i=s.t,l=a||s.p,h=r||s.r,c=o||s.s,d=new Vec3(l[0],l[1],l[2]),u=(new Quat).setFromEulerAngles(h[0],h[1],h[2]),p=new Vec3(c[0],c[1],c[2]),m=new Key(i,d,u,p);t._keys.push(m)}s.addNode(t)}return s}}class AnimClipHandler{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=Http.ResponseType.JSON),V.get(t.load,s,(function(s,i){s?e(`Error loading animation clip resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){const s=e.name,i=e.duration,n=e.inputs.map((function(t){return new AnimData(1,t)})),a=e.outputs.map((function(t){return new AnimData(t.components,t.data)})),r=e.curves.map((function(t){return new AnimCurve([t.path],t.inputIndex,t.outputIndex,t.interpolation)}));return new AnimTrack(s,i,n,a,r)}patch(t,e){}}class AnimStateGraph{constructor(t){if(this._layers=[],this._parameters={},Array.isArray(t.layers))this._layers=t.layers;else for(const e in t.layers){const s=t.layers[e],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let e=0;e<s.states.length;e++)i.states.push(t.states[s.states[e]]);for(let e=0;e<s.transitions.length;e++){const n=t.transitions[s.transitions[e]];if(n.conditions&&!Array.isArray(n.conditions)){const t=Object.keys(n.conditions),e=[];for(let s=0;s<t.length;s++){const i=n.conditions[t[s]];i.parameterName&&e.push(i)}n.conditions=e}Number.isInteger(n.from)&&(n.from=t.states[n.from].name),Number.isInteger(n.to)&&(n.to=t.states[n.to].name),i.transitions.push(n)}this._layers.push(i)}for(const e in t.parameters){const s=t.parameters[e];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}class AnimStateGraphHandler{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=Http.ResponseType.JSON),V.get(t.load,s,(function(s,i){s?e(`Error loading animation state graph resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return new AnimStateGraph(e)}patch(t,e){}}class Sound{constructor(t){t instanceof Audio?this.audio=t:this.buffer=t}get duration(){let t=0;return this.buffer?t=this.buffer.duration:this.audio&&(t=this.audio.duration),t||0}}const Ir=function(){if("undefined"==typeof window)return!1;const t=window.navigator.userAgent,e=t.indexOf("MSIE ");if(e>0)return parseInt(t.substring(e+5,t.indexOf(".",e)),10);if(t.indexOf("Trident/")>0){const e=t.indexOf("rv:");return parseInt(t.substring(e+3,t.indexOf(".",e)),10)}return!1}(),Dr={".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",".mp4":"audio/mp4",".aac":"audio/aac"};class AudioHandler{constructor(t){this.manager=t,this.maxRetries=0}_isSupported(t){const e=c.getExtension(t);return!!Dr[e]}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s=function(t){e(null,new Sound(t))},i=function(s){let i="Error loading audio url: "+t.original;s&&(i+=": "+(s.message||s)),console.warn(i),e(i)};if(this._createSound){if(!this._isSupported(t.original))return void i(`Audio format for ${t.original} not supported`);this._createSound(t.load,s,i)}else i(null)}open(t,e){return e}patch(t,e){}_createSound(t,e,s){if(Wa()){const i=this.manager;if(!i.context)return void s("Audio manager has no audio context");const n={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.startsWith("blob:")||t.startsWith("data:"))&&(n.responseType=Http.ResponseType.ARRAY_BUFFER),V.get(t,n,(function(t,n){t?s(t):i.context.decodeAudioData(n,e,s)}))}else{let i=null;try{i=new Audio}catch($u){return void s("No support for Audio element")}Ir&&document.body.appendChild(i);const n=function t(){i.removeEventListener("canplaythrough",t),Ir&&document.body.removeChild(i),e(i)};i.onerror=function(){i.onerror=null,Ir&&document.body.removeChild(i),s()},i.addEventListener("canplaythrough",n),i.src=t}}}class BinaryHandler{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),V.get(t.load,{responseType:Http.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?e(`Error loading binary resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return e}patch(t,e){}}class Bundle{constructor(t){this._blobUrls={};for(let e=0,s=t.length;e<s;e++)t[e].url&&(this._blobUrls[t[e].name]=t[e].url)}hasBlobUrl(t){return!!this._blobUrls[t]}getBlobUrl(t){return this._blobUrls[t]}destroy(){for(const t in this._blobUrls)URL.revokeObjectURL(this._blobUrls[t]);this._blobUrls=null}}let kr;function Fr(t){let e,s;if("undefined"!=typeof TextDecoder)try{e=new TextDecoder("utf-8"),s=new TextDecoder("windows-1252")}catch($u){console.warn("TextDecoder not supported - pc.Untar module will not work")}else console.warn("TextDecoder not supported - pc.Untar module will not work");function i(t){this._fields=t}function n(t){this._arrayBuffer=t||new ArrayBuffer(0),this._bufferView=new DataView(this._arrayBuffer),this._globalPaxHeader=null,this._paxHeader=null,this._bytesRead=0}i.parse=function(t,s,n){const a=new Uint8Array(t,s,n);let r=0;const o=[];for(;r<n;){let i;for(i=r;i<n&&32!==a[i];i++);if(i>=n)throw new Error("Invalid PAX header data format.");const l=parseInt(e.decode(new Uint8Array(t,s+r,i-r)),10),h=e.decode(new Uint8Array(t,s+i+1,l-(i-r)-2)).split("=");if(2!==h.length)throw new Error("Invalid PAX header data format.");0===h[1].length&&(h[1]=null),o.push({name:h[0],value:h[1]}),r+=l}return new i(o)},i.prototype.applyHeader=function(t){for(let e=0;e<this._fields.length;e++){let s=this._fields[e].name;const i=this._fields[e].value;"path"===s&&(s="name"),null===i?delete t[s]:t[s]=i}},t||(kr=n),n.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)},n.prototype._readNextFile=function(){const e=new DataView(this._arrayBuffer,this._bytesRead,512),n=s.decode(e);this._bytesRead+=512;let a=n.substr(0,100).replace(/\0/g,"");const r=n.substr(257,6),o=parseInt(n.substr(124,12),8),l=n.substr(156,1),h=this._bytesRead;let c=null,d=!1;switch(l){case"0":case"":if(d=!0,!t){const t=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+o)]);c=URL.createObjectURL(t)}break;case"g":this._globalPaxHeader=i.parse(this._arrayBuffer,this._bytesRead,o);break;case"x":this._paxHeader=i.parse(this._arrayBuffer,this._bytesRead,o)}this._bytesRead+=o;const u=o%512;if(0!==u&&(this._bytesRead+=512-u),!d)return null;if(-1!==r.indexOf("ustar")){const t=n.substr(345,155).replace(/\0/g,"");t.length>0&&(a=t.trim()+a.trim())}const p={name:a,start:h,size:o,url:c};return this._globalPaxHeader&&this._globalPaxHeader.applyHeader(p),this._paxHeader&&(this._paxHeader.applyHeader(p),this._paxHeader=null),p},n.prototype.untar=function(t){if(!e)return console.error("Cannot untar because TextDecoder interface is not available for this platform."),[];const s=[];for(;this._hasNext();){const e=this._readNextFile();e&&(t&&e.name&&(e.name=t+e.name),s.push(e))}return s},t&&(self.onmessage=function(t){const e=t.data.id;try{const s=new n(t.data.arrayBuffer).untar(t.data.prefix);postMessage({id:e,files:s,arrayBuffer:t.data.arrayBuffer},[t.data.arrayBuffer])}catch(s){postMessage({id:e,error:s.toString()})}})}let Or=null;class UntarWorker{constructor(t){this._requestId=0,this._pendingRequests={},this._filenamePrefix=t,this._worker=new Worker(function(){if(!Or){const t="("+Fr.toString()+")(true)\n\n",e=new Blob([t],{type:"application/javascript"});Or=URL.createObjectURL(e)}return Or}()),this._worker.addEventListener("message",this._onMessage.bind(this))}_onMessage(t){const e=t.data.id;if(!this._pendingRequests[e])return;const s=this._pendingRequests[e];if(delete this._pendingRequests[e],t.data.error)s(t.data.error);else{const e=t.data.arrayBuffer;for(let s=0,i=t.data.files.length;s<i;s++){const i=t.data.files[s],n=new Blob([e.slice(i.start,i.start+i.size)]);i.url=URL.createObjectURL(n)}s(null,t.data.files)}}untar(t,e){const s=this._requestId++;this._pendingRequests[s]=e,this._worker.postMessage({id:s,prefix:this._filenamePrefix,arrayBuffer:t},[t])}hasPendingRequests(){return Object.keys(this._pendingRequests).length>0}destroy(){this._worker&&(this._worker.terminate(),this._worker=null,this._pendingRequests=null)}}Fr();class BundleHandler{constructor(t){this._assets=t,this._worker=null,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s=this;V.get(t.load,{responseType:Http.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(i,n){if(i)e("Error loading bundle resource "+t.original+": "+i);else try{s._untar(n,e)}catch(a){e("Error loading bundle resource "+t.original+": "+a)}}))}_untar(t,e){const s=this;if(S.workers)s._worker||(s._worker=new UntarWorker(s._assets.prefix)),s._worker.untar(t,(function(t,i){e(t,i),s._worker.hasPendingRequests()||(s._worker.destroy(),s._worker=null)}));else{const i=new kr(t).untar(s._assets.prefix);e(null,i)}}open(t,e){return new Bundle(e)}patch(t,e){}}class ContainerHandler{constructor(t,e){this.glbParser=new GlbParser(t,e,0),this.parsers={}}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=t?c.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".",""):null;return this.parsers[e]||this.glbParser}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){return this._getParser(t).open(t,e,s)}patch(t,e){}}class CssHandler{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),V.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?e(`Error loading css resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return e}patch(t,e){}}class CubemapHandler{constructor(t,e,s){this._device=t,this._registry=e,this._loader=s}load(t,e,s){this.loadAssets(s,e)}open(t,e,s){return s?s.resource:null}patch(t,e){this.loadAssets(t,(function(s,i){s&&(e.fire("error",t),e.fire("error:"+t.id,s,t),t.fire("error",t))}))}getAssetIds(t){const e=[];if(e[0]=t.file,(t.loadFaces||!t.file)&&t.data&&t.data.textures)for(let s=0;s<6;++s)e[s+1]=t.data.textures[s];else e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=null;return e}compareAssetIds(t,e){return t&&e?parseInt(t,10)===t||"string"==typeof t?t===e:t.url===e.url:null!==t==(null!==e)}update(t,e,s){const i=t.data||{},n=t._handlerState.assets,a=t._resources;let r,o,l;const h=[null,null,null,null,null,null,null],c=function(){return i.hasOwnProperty("type")?i.type:i.hasOwnProperty("rgbm")?i.rgbm?Ot:Ft:null};if(t.loaded&&s[0]===n[0])h[1]=a[1]||null,h[2]=a[2]||null,h[3]=a[3]||null,h[4]=a[4]||null,h[5]=a[5]||null,h[6]=a[6]||null;else if(s[0])for(r=s[0].resource,l=0;l<6;++l)h[l+1]=new Texture(this._device,{name:t.name+"_prelitCubemap"+(r.width>>l),cubemap:!0,type:c()||r.type,width:r.width>>l,height:r.height>>l,format:r.format,levels:[r._levels[l]],fixCubemapSeams:!0,addressU:1,addressV:1,mipmaps:0===l});const d=s.slice(1);if(t.loaded&&this.cmpArrays(d,n.slice(1)))h[0]=a[0]||null;else if(-1===d.indexOf(null)){const e=d.map((function(t){return t.resource})),n=[];for(o=0;o<e[0]._levels.length;++o)n.push(e.map((function(t){return t._levels[o]})));const a=new Texture(this._device,{name:t.name+"_faces",cubemap:!0,type:c()||e[0].type,width:e[0].width,height:e[0].height,format:e[0].format,levels:n,minFilter:i.hasOwnProperty("minFilter")?i.minFilter:e[0].minFilter,magFilter:i.hasOwnProperty("magFilter")?i.magFilter:e[0].magFilter,anisotropy:i.hasOwnProperty("anisotropy")?i.anisotropy:1,addressU:1,addressV:1,fixCubemapSeams:!!s[0]});h[0]=a}if(!this.cmpArrays(h,a))for(t.resources=h,t._handlerState.assetIds=e,t._handlerState.assets=s,l=0;l<a.length;++l)null!==a[l]&&-1===h.indexOf(a[l])&&a[l].destroy();for(l=0;l<n.length;++l)null!==n[l]&&-1===s.indexOf(n[l])&&n[l].unload()}cmpArrays(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0}resolveId(t){const e=parseInt(t,10);return e===t||e.toString()===t?e:t}loadAssets(t,e){t.hasOwnProperty("_handlerState")||(t._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const s=this,i=s.getAssetIds(t),n=[null,null,null,null,null,null,null],a=t._handlerState.assetIds,r=t._handlerState.assets,o=s._registry;let l=7;const h=function(a,r){n[a]=r,l--,0===l&&(s.update(t,i,n),e(null,t.resources))},c=function(t,s,i){e(s)},d=function(t,e){e.loaded?h(t,e):(o.once("load:"+e.id,h.bind(s,t)),o.once("error:"+e.id,c.bind(s,t)),e.loading||o.load(e))};let u;for(let p=0;p<7;++p){const e=this.resolveId(i[p]);if(e)if(s.compareAssetIds(e,a[p]))h(p,r[p]);else if(parseInt(e,10)===e)u=o.get(e),u?d(p,u):setTimeout(function(t,e){const s=o.get(e);s?d(t,s):c(0,"failed to find dependent cubemap asset="+e)}.bind(null,p,e));else{const i="string"==typeof e?{url:e,filename:e}:e;u=new Asset(t.name+"_part_"+p,"texture",i),o.add(u),o.once("load:"+u.id,h.bind(s,p)),o.once("error:"+u.id,c.bind(s,p)),o.load(u)}else h(p,null)}}}class FolderHandler{load(t,e){e(null,null)}open(t,e){return e}}const Vr="msdf";class Font{constructor(t,e){this.type=e&&e.type||Vr,this.em=1,this.textures=t,this.intensity=0,this._data=null,this.data=e}set data(t){if(this._data=t,t&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(const e in this._data.chars)this._data.chars[e].map=0}get data(){return this._data}}function Br(t){return t.version<3&&(t.version<2&&(t.info.maps=t.info.maps||[{width:t.info.width,height:t.info.height}]),t.chars=Object.keys(t.chars||{}).reduce((function(e,s){const i=t.chars[s],n=void 0!==i.letter?i.letter:D.fromCodePoint(s);return t.version<2&&(i.map=i.map||0),e[n]=i,e}),{}),t.version=3),t}class FontHandler{constructor(t){this._loader=t,this.maxRetries=0}load(t,e,s){"string"==typeof t&&(t={load:t,original:t});const i=this;".json"===c.getExtension(t.original)?V.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,n){if(s)e(`Error loading font resource: ${t.original} [${s}]`);else{const s=Br(n);i._loadTextures(t.load.replace(".json",".png"),s,(function(t,i){if(t)return e(t);e(null,{data:s,textures:i})}))}})):(s&&s.data&&(s.data=Br(s.data)),this._loadTextures(t.load,s&&s.data,e))}_loadTextures(t,e,s){const i=e.info.maps.length;let n=0,a=null;const r=new Array(i),o=this._loader,l=function(e){const l=function(t,o){if(!a){if(t)return a=t,s(t);o.upload(),r[e]=o,n++,n===i&&s(null,r)}};0===e?o.load(t,"texture",l):o.load(t.replace(".png",e+".png"),"texture",l)};for(let h=0;h<i;h++)l(h)}open(t,e,s){let i;return i=e.textures?new Font(e.textures,e.data):new Font(e,null),i}patch(t,e){const s=t.resource;!s.data&&t.data?s.data=t.data:!t.data&&s.data&&(t.data=s.data),t.data&&(t.data=Br(t.data))}}const zr=function(t,e,s){const i=s.singleVecs;let n,a;const r=e.___1;r||(n=s.tripleVecs,a=e.___2);let o=r?r[0]:n[a];t.setLocalPosition(i[o],i[o+1],i[o+2]),o=r?r[1]:n[a+1],t.setLocalEulerAngles(i[o],i[o+1],i[o+2]),o=r?r[2]:n[a+2],t.setLocalScale(i[o],i[o+1],i[o+2])},Ur=function(t,e){const s=t.charCodeAt(0)-e.fieldFirstCode;return e.fieldArray[s]},Nr=function(t,e){let s=0;for(let i=0;i<t.length;i++)s=s*e.fieldCodeBase+t.charCodeAt(i)-e.fieldFirstCode;return e.fieldArray[s]};class Decompress{constructor(t,e){this._node=t,this._data=e}run(){const t=Object.prototype.toString.call(this._node);return"[object Object]"===t?this._handleMap():"[object Array]"===t?this._handleArray():this._result=this._node,this._result}_handleMap(){this._result={};Object.keys(this._node).forEach(this._handleKey,this)}_handleKey(t){let e=t;const s=t.length;1===s?e=Ur(t,this._data):2===s&&(e=Nr(t,this._data)),this._result[e]=new Decompress(this._node[t],this._data).run()}_handleArray(){this._result=[],this._node.forEach(this._handleArElt,this)}_handleArElt(t){const e=new Decompress(t,this._data).run();this._result.push(e)}}class SceneParser{constructor(t,e){this._app=t,this._isTemplate=e}parse(t){const e={};let s=null;const i=t.compressedFormat;i&&!t.entDecompressed&&(t.entDecompressed=!0,t.entities=new Decompress(t.entities,i).run());for(const n in t.entities){const a=t.entities[n],r=this._createEntity(a,i);e[n]=r,null===a.parent&&(s=r)}for(const n in t.entities){const s=e[n],i=t.entities[n].children,a=i.length;for(let t=0;t<a;t++){const n=e[i[t]];n&&s.addChild(n)}}return this._openComponentData(s,t.entities),s}_createEntity(t,e){const s=new Entity;if(s.name=t.name,s.setGuid(t.resource_id),this._setPosRotScale(s,t,e),s._enabled=void 0===t.enabled||t.enabled,this._isTemplate?s._template=!0:s._enabledInHierarchy=s._enabled,s.template=t.template,t.tags)for(let i=0;i<t.tags.length;i++)s.tags.add(t.tags[i]);return t.labels&&t.labels.forEach((function(t){s.addLabel(t)})),s}_setPosRotScale(t,e,s){if(s)zr(t,e,s);else{const s=e.position,i=e.rotation,n=e.scale;t.setLocalPosition(s[0],s[1],s[2]),t.setLocalEulerAngles(i[0],i[1],i[2]),t.setLocalScale(n[0],n[1],n[2])}}_openComponentData(t,e){const s=this._app.systems.list;let i=s.length;const n=e[t.getGuid()];for(let r=0;r<i;r++){const e=s[r],i=n.components[e.id];i&&e.addComponent(t,i)}i=n.children.length;const a=t._children;for(let r=0;r<i;r++)a[r]=this._openComponentData(a[r],e);return t}}const Hr=function(t,e,s){"string"==typeof t&&(t={load:t,original:t}),V.get(t.load,{retry:e>0,maxRetries:e},(function(e,i){if(e){let i="Error while loading scene JSON "+t.original;e.message?(i+=": "+e.message,e.stack&&(i+="\n"+e.stack)):i+=": "+e,s(i)}else s(e,i)}))};class HierarchyHandler{constructor(t){this._app=t,this.maxRetries=0}load(t,e){Hr(t,this.maxRetries,e)}open(t,e){this._app.systems.script.preloading=!0;const s=new SceneParser(this._app,!1).parse(e);return this._app.systems.script.preloading=!1,s}}class HtmlHandler{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),V.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?e(`Error loading html resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return e}patch(t,e){}}class JsonHandler{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=Http.ResponseType.JSON),V.get(t.load,s,(function(s,i){s?e(`Error loading JSON resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return e}patch(t,e){}}class AssetReference{constructor(t,e,s,i,n){this.propertyName=t,this.parent=e,this._scope=n,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}set id(t){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=t,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(t){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=t,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.on("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))}_unbind(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.off("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))}_onLoad(t){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,t)}_onAdd(t){this.asset=t,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,t)}_onRemove(t){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,t),this.asset=null}_onUnload(t){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,t)}}function Wr(){return Wr=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=s[i])}return t},Wr.apply(this,arguments)}class StandardMaterialValidator{constructor(){this.removeInvalid=!0,this.valid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),shadingModel:this._createEnumValidator([0,1])}}setInvalid(t,e){this.valid=!1,this.removeInvalid&&delete e[t]}validate(t){const e=xs,s="path"===t.mappingFormat;for(const i in t){const n=e[i];if(n)if(n.startsWith("enum")){const e=n.split(":")[1];this.enumValidators[e]&&(this.enumValidators[e](t[i])||this.setInvalid(i,t))}else if("number"===n)"number"!=typeof t[i]&&this.setInvalid(i,t);else if("boolean"===n)"boolean"!=typeof t[i]&&this.setInvalid(i,t);else if("string"===n)"string"!=typeof t[i]&&this.setInvalid(i,t);else if("vec2"===n)t[i]instanceof Array&&2===t[i].length||this.setInvalid(i,t);else if("rgb"===n)t[i]instanceof Array&&3===t[i].length||this.setInvalid(i,t);else if("texture"===n)s?"string"!=typeof t[i]&&null!==t[i]&&(t[i]instanceof Texture||this.setInvalid(i,t)):"number"!=typeof t[i]&&null!==t[i]&&(t[i]instanceof Texture||this.setInvalid(i,t));else if("boundingbox"===n)t[i].center&&t[i].center instanceof Array&&3===t[i].center.length||this.setInvalid(i,t),t[i].halfExtents&&t[i].halfExtents instanceof Array&&3===t[i].halfExtents.length||this.setInvalid(i,t);else if("cubemap"===n)"number"!=typeof t[i]&&null!==t[i]&&void 0!==t[i]&&(t[i]instanceof Texture&&t[i].cubemap||this.setInvalid(i,t));else if("chunks"===n){const e=Object.keys(t[i]);for(let s=0;s<e.length;s++)"string"!=typeof t[i][e[s]]&&this.setInvalid(e[s],t[i])}else console.error("Unknown material type: "+n);else this.valid=!1}return t.validated=!0,this.valid}_createEnumValidator(t){return function(e){return t.indexOf(e)>=0}}}class JsonStandardMaterialParser{constructor(){this._validator=null}parse(t){const e=this.migrate(t),s=this._validate(e),i=new StandardMaterial;return this.initialize(i,s),i}initialize(t,e){e.validated||(e=this._validate(e)),e.chunks&&(t.chunks=Wr({},e.chunks));for(const s in e){const i=xs[s],n=e[s];if("vec2"===i)t[s]=new Vec2(n[0],n[1]);else if("rgb"===i)t[s]=new Color(n[0],n[1],n[2]);else if("texture"===i)n instanceof Texture?t[s]=n:t[s]instanceof Texture&&"number"==typeof n&&n>0||(t[s]=null);else if("cubemap"===i)n instanceof Texture?t[s]=n:t[s]instanceof Texture&&"number"==typeof n&&n>0||(t[s]=null),"cubeMap"!==s||n||(t.prefilteredCubemaps=null);else if("boundingbox"===i){const e=new Vec3(n.center[0],n.center[1],n.center[2]),i=new Vec3(n.halfExtents[0],n.halfExtents[1],n.halfExtents[2]);t[s]=new BoundingBox(e,i)}else t[s]=e[s]}t.update()}migrate(t){let e;void 0===t.shadingModel&&("blinn"===t.shader?t.shadingModel=1:t.shadingModel=0),t.shader&&delete t.shader,t.mapping_format&&(t.mappingFormat=t.mapping_format,delete t.mapping_format);const s=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(e=0;e<s.length;e++){const i=s[e][0],n=s[e][1];void 0!==t[i]&&void 0===t[n]&&(t[n]=t[i],delete t[i])}const i=["fresnelFactor","shadowSampleType"];for(e=0;e<i.length;e++){const s=i[e];t.hasOwnProperty(s)&&delete t[s]}return t}_validate(t){return t.validated||(this._validator||(this._validator=new StandardMaterialValidator),this._validator.validate(t)),t}}const Gr={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"};class MaterialHandler{constructor(t){this._assets=t.assets,this._device=t.graphicsDevice,this._placeholderTextures=null,this._parser=new JsonStandardMaterialParser,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),V.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?e&&e(`Error loading material: ${t.original} [${s}]`):e&&(i._engine=!0,e(null,i))}))}open(t,e){const s=this._parser.parse(e);return e._engine&&(s._data=e,delete e._engine),s}_createPlaceholders(){this._placeholderTextures={};const t={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]};for(const e in t){if(!t.hasOwnProperty(e))continue;this._placeholderTextures[e]=new Texture(this._device,{width:2,height:2,format:7}),this._placeholderTextures[e].name="placeholder";const s=this._placeholderTextures[e].lock();for(let i=0;i<4;i++)for(let n=0;n<4;n++)s[4*i+n]=t[e][n];this._placeholderTextures[e].unlock()}}patch(t,e){t.resource._data&&(t._data=t.resource._data,delete t.resource._data),t.data.name=t.name,t.resource.name=t.name,this._bindAndAssignAssets(t,e),t.off("unload",this._onAssetUnload,this),t.on("unload",this._onAssetUnload,this)}_onAssetUnload(t){delete t.data.parameters,delete t.data.chunks,delete t.data.name}_assignTexture(t,e,s){e.resource[t]=s}_getPlaceholderTexture(t){this._placeholderTextures||this._createPlaceholders();const e=Gr[t];return this._placeholderTextures[e]}_assignPlaceholderTexture(t,e){e.resource[t]=this._getPlaceholderTexture(t,e)}_onTextureLoad(t,e,s){this._assignTexture(t,e,s.resource),e.resource.update()}_onTextureAdd(t,e,s){this._assets.load(s)}_onTextureRemoveOrUnload(t,e,s){const i=e.resource;i&&e.resource[t]===s.resource&&(this._assignPlaceholderTexture(t,e),i.update())}_assignCubemap(t,e,s){e.resource[t]=s[0],"cubeMap"===t&&(e.resource.prefilteredCubemaps=s.slice(1))}_onCubemapLoad(t,e,s){this._assignCubemap(t,e,s.resources),this._parser.initialize(e.resource,e.data)}_onCubemapAdd(t,e,s){0===e.data.shadingModel&&(e.loadFaces=!0),this._assets.load(s)}_onCubemapRemoveOrUnload(t,e,s){const i=e.resource;e.data.prefilteredCubeMap128===s.resources[1]&&(this._assignCubemap(t,e,[null,null,null,null,null,null,null]),i.update())}_bindAndAssignAssets(t,e){const s=this._parser.migrate(t.data),i=t.resource,n="path"===s.mappingFormat,a=Ss;let r,o,l;for(r=0;r<a.length;r++){o=a[r],l=i._assetReferences[o];const h=s[o],c=i[o],d=c===this._getPlaceholderTexture(o,t),u=s.validated;!h||c&&u&&!d?l&&(n?l.url=null:l.id=null):(l||(l=new AssetReference(o,t,e,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),i._assetReferences[o]=l),n?l.url=t.getAbsoluteUrl(h):l.id=h,l.asset&&(l.asset.resource?this._assignTexture(o,t,l.asset.resource):this._assignPlaceholderTexture(o,t),e.load(l.asset)))}const h=ws;for(r=0;r<h.length;r++)o=h[r],l=i._assetReferences[o],s[o]&&!t.data.prefilteredCubeMap128&&(l||(l=new AssetReference(o,t,e,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),i._assetReferences[o]=l),n?l.url=s[o]:l.id=s[o],l.asset&&(l.asset.loaded&&this._assignCubemap(o,t,l.asset.resources),e.load(l.asset)));this._parser.initialize(i,s)}}class GlbModelParser{constructor(t,e){this._device=t,this._defaultMaterial=e}parse(t){const e=GlbParser.parse("filename.glb",t,this._device);if(e){const t=GlbContainerResource.createModel(e,this._defaultMaterial);return e.destroy(),t}return null}}class PartitionedVertex{constructor(){this.index=0,this.boneIndices=[0,0,0,0]}}class SkinPartition{constructor(){this.partition=0,this.vertexStart=0,this.vertexCount=0,this.indexStart=0,this.indexCount=0,this.boneIndices=[],this.vertices=[],this.indices=[],this.indexMap={},this.originalMesh=null}addVertex(t,e,s){let i=-1;if(void 0!==this.indexMap[e])i=this.indexMap[e],this.indices.push(i);else{for(let i=0;i<4;i++){if(0===s.blendWeight.data[4*e+i])continue;const n=s.blendIndices.data[4*t.index+i];t.boneIndices[i]=this.getBoneRemap(n)}i=this.vertices.length,this.indices.push(i),this.vertices.push(t),this.indexMap[e]=i}}addPrimitive(t,e,s,i){const n=[];let a=0;const r=t.length;for(let o=0;o<r;o++){const e=t[o].index;for(let t=0;t<4;t++)if(s.blendWeight.data[4*e+t]>0){const i=s.blendIndices.data[4*e+t];let r=!0;for(let t=0;t<a;t++)if(n[t]===i){r=!1;break}if(r){n[a]=i;a+=-1===this.getBoneRemap(i)?1:0}}}if(this.boneIndices.length+a>i)return!1;for(let o=0;o<a;o++)this.boneIndices.push(n[o]);for(let o=0;o<r;o++)this.addVertex(t[o],e[o],s);return!0}getBoneRemap(t){for(let e=0;e<this.boneIndices.length;e++)if(this.boneIndices[e]===t)return e;return-1}}const jr={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,trianglefan:6},Xr={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6};class JsonModelParser{constructor(t,e){this._device=t,this._defaultMaterial=e}parse(t){const e=t.model;if(!e)return null;if(e.version<=1)return null;const s=this._parseNodes(t),i=this._parseSkins(t,s),n=this._parseVertexBuffers(t),a=this._parseIndexBuffers(t,n),r=this._parseMorphs(t,s,n),o=this._parseMeshes(t,i.skins,r.morphs,n,a.buffer,a.data),l=this._parseMeshInstances(t,s,o,i.skins,i.instances,r.morphs,r.instances),h=new Model;return h.graph=s[0],h.meshInstances=l,h.skinInstances=i.instances,h.morphInstances=r.instances,h.getGraph().syncHierarchy(),h}_parseNodes(t){const e=t.model,s=[];let i;for(i=0;i<e.nodes.length;i++){const t=e.nodes[i],n=new GraphNode(t.name);n.setLocalPosition(t.position[0],t.position[1],t.position[2]),n.setLocalEulerAngles(t.rotation[0],t.rotation[1],t.rotation[2]),n.setLocalScale(t.scale[0],t.scale[1],t.scale[2]),n.scaleCompensation=!!t.scaleCompensation,s.push(n)}for(i=1;i<e.parents.length;i++)s[e.parents[i]].addChild(s[i]);return s}_parseSkins(t,e){const s=t.model,i=[],n=[];let a,r;if(!this._device.supportsBoneTextures&&s.skins.length>0){!function(t,e,s){let i,n,a,r;!function(t){const e=t.vertices,s=t.skins,i=t.meshes,n=t.meshInstances;for(let a=0;a<i.length;a++)i[a].vertices=e[i[a].vertices],void 0!==i[a].skin&&(i[a].skin=s[i[a].skin]);for(let a=0;a<n.length;a++)n[a].mesh=i[n[a].mesh]}(t);const o=t.vertices,l=t.skins;let h;const c=t.meshes,d=t.meshInstances,u=function(t){const e=new PartitionedVertex;return e.index=t,e};for(i=l.length-1;i>=0;i--)if(l[i].boneNames.length>s){const t=l.splice(i,1)[0],p=[];for(n=0;n<c.length;n++)c[n].skin===t&&p.push(c[n]);for(n=0;n<p.length;n++)r=c.indexOf(p[n]),-1!==r&&c.splice(r,1);if(0===p.length)throw new Error("partitionSkin: There should be at least one mesh that references a skin");const m=p[0].vertices;for(n=1;n<p.length;n++)if(p[n].vertices!==m)throw new Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");let _;const f=[],g=[],y=[];let v=0;for(n=0;n<p.length;n++){h=p[n];const t=h.indices;for(let e=h.base;e<h.base+h.count;){r=t[e++],g[0]=u(r),y[0]=r,r=t[e++],g[1]=u(r),y[1]=r,r=t[e++],g[2]=u(r),y[2]=r;let i=!1;for(let t=v;t<f.length;t++)if(_=f[t],_.addPrimitive(g,y,m,s)){i=!0;break}i||(_=new SkinPartition,_.originalMesh=h,_.addPrimitive(g,y,m,s),f.push(_))}v=f.length}const b=[],x=[];for(n=0;n<f.length;n++)if(_=f[n],_.vertices.length&&_.indices.length){const t=b.length,e=_.vertices.length,s=x.length,i=_.indices.length;let a,r;for(_.partition=n,_.vertexStart=t,_.vertexCount=e,_.indexStart=s,_.indexCount=i,a=0,r=t;a<e;)b[r++]=_.vertices[a++];for(a=0,r=s;a<i;)x[r++]=_.indices[a++]+t}const S=[];for(n=0;n<f.length;n++){_=f[n];const e=[],s=[];for(a=0;a<_.boneIndices.length;a++)e.push(t.inverseBindMatrices[_.boneIndices[a]]),s.push(t.boneNames[_.boneIndices[a]]);const i={inverseBindMatrices:e,boneNames:s};S.push(i),l.push(i)}let w,C,T,M;const A={};for(C in m)A[C]={components:m[C].components,data:[],type:m[C].type};for(C in m)if("blendIndices"===C){const t=A[C].data;for(n=0;n<b.length;n++){const e=b[n].boneIndices;t.push(e[0],e[1],e[2],e[3])}}else for(w=m[C],T=w.data,M=w.components,n=0;n<b.length;n++)for(r=b[n].index,a=0;a<M;a++)A[C].data.push(T[r*M+a]);for(o[o.indexOf(m)]=A,n=0;n<f.length;n++)for(_=f[n],h={aabb:{min:[0,0,0],max:[0,0,0]},vertices:A,skin:S[n],indices:x.splice(0,_.indexCount),type:"triangles",base:0,count:_.indexCount},c.push(h),a=d.length-1;a>=0;a--)d[a].mesh===_.originalMesh&&(d.push({mesh:h,node:d[a].node}),e&&e.push({material:e[a].material,path:e[a].path}));for(n=0;n<f.length;n++)for(_=f[n],a=d.length-1;a>=0;a--)d[a].mesh===_.originalMesh&&(d.splice(a,1),e&&e.splice(a,1))}!function(t){const e=t.vertices,s=t.skins,i=t.meshes,n=t.meshInstances;for(let a=0;a<i.length;a++)i[a].vertices=e.indexOf(i[a].vertices),void 0!==i[a].skin&&(i[a].skin=s.indexOf(i[a].skin));for(let a=0;a<n.length;a++)n[a].mesh=i.indexOf(n[a].mesh)}(t)}(s,null,this._device.getBoneLimit())}for(a=0;a<s.skins.length;a++){const t=s.skins[a],o=[];for(r=0;r<t.inverseBindMatrices.length;r++){const e=t.inverseBindMatrices[r];o[r]=(new Mat4).set(e)}const l=new Skin(this._device,o,t.boneNames);i.push(l);const h=new SkinInstance(l),c=[];for(r=0;r<l.boneNames.length;r++){const t=l.boneNames[r],s=e[0].findByName(t);c.push(s)}h.bones=c,n.push(h)}return{skins:i,instances:n}}_getMorphVertexCount(t,e,s){for(let i=0;i<t.meshes.length;i++){const n=t.meshes[i];if(n.morph===e){return s[n.vertices].numVertices}}}_parseMorphs(t,e,s){const i=t.model,n=[],a=[];let r,o,l,h,c,d;if(i.morphs){const t=function(t,e,s){const i=new Float32Array(3*s);for(let n=0;n<e.length;n++){const s=3*e[n];i[s]=t[3*n],i[s+1]=t[3*n+1],i[s+2]=t[3*n+2]}return i};for(r=0;r<i.morphs.length;r++){for(h=i.morphs[r].targets,d=[],l=this._getMorphVertexCount(i,r,s),o=0;o<h.length;o++){const e=h[o].aabb,s=e.min,i=e.max,n=new BoundingBox(new Vec3(.5*(i[0]+s[0]),.5*(i[1]+s[1]),.5*(i[2]+s[2])),new Vec3(.5*(i[0]-s[0]),.5*(i[1]-s[1]),.5*(i[2]-s[2]))),a=h[o].indices;let r=h[o].deltaPositions,u=h[o].deltaNormals;a&&(r=t(r,a,l),u=t(u,a,l)),c=new MorphTarget({deltaPositions:r,deltaNormals:u,name:h[o].name,aabb:n}),d.push(c)}const e=new Morph(d,this._device);n.push(e);const u=new MorphInstance(e);a.push(u)}}return{morphs:n,instances:a}}_parseVertexBuffers(t){const e=t.model,s=[],i={position:ot,normal:lt,tangent:ht,blendWeight:ct,blendIndices:dt,color:ut,texCoord0:mt,texCoord1:_t,texCoord2:ft,texCoord3:gt,texCoord4:yt,texCoord5:vt,texCoord6:bt,texCoord7:xt};for(let n=0;n<e.vertices.length;n++){const t=e.vertices[n],a=[];for(const e in t){const s=t[e];a.push({semantic:i[e],components:s.components,type:Xr[s.type],normalize:i[e]===ut})}const r=new VertexFormat(this._device,a),o=t.position.data.length/t.position.components,l=new VertexBuffer(this._device,r,o),h=new VertexIterator(l);for(let e=0;e<o;e++){for(const s in t){const n=t[s];switch(n.components){case 1:h.element[i[s]].set(n.data[e]);break;case 2:h.element[i[s]].set(n.data[2*e],1-n.data[2*e+1]);break;case 3:h.element[i[s]].set(n.data[3*e],n.data[3*e+1],n.data[3*e+2]);break;case 4:h.element[i[s]].set(n.data[4*e],n.data[4*e+1],n.data[4*e+2],n.data[4*e+3])}}h.next()}h.end(),s.push(l)}return s}_parseIndexBuffers(t,e){const s=t.model;let i,n=null,a=null,r=0;for(i=0;i<s.meshes.length;i++){const t=s.meshes[i];void 0!==t.indices&&(r+=t.indices.length)}let o=0;for(i=0;i<e.length;i++)o=Math.max(o,e[i].numVertices);return r>0&&(o>65535&&this._device.extUintElement?(n=new IndexBuffer(this._device,2,r),a=new Uint32Array(n.lock())):(n=new IndexBuffer(this._device,1,r),a=new Uint16Array(n.lock()))),{buffer:n,data:a}}_parseMeshes(t,e,s,i,n,a){const r=t.model,o=[];let l=0;for(let h=0;h<r.meshes.length;h++){const t=r.meshes[h],c=t.aabb,d=c.min,u=c.max,p=new BoundingBox(new Vec3(.5*(u[0]+d[0]),.5*(u[1]+d[1]),.5*(u[2]+d[2])),new Vec3(.5*(u[0]-d[0]),.5*(u[1]-d[1]),.5*(u[2]-d[2]))),m=void 0!==t.indices,_=new Mesh(this._device);_.vertexBuffer=i[t.vertices],_.indexBuffer[0]=m?n:null,_.primitive[0].type=jr[t.type],_.primitive[0].base=m?t.base+l:t.base,_.primitive[0].count=t.count,_.primitive[0].indexed=m,_.skin=void 0!==t.skin?e[t.skin]:null,_.morph=void 0!==t.morph?s[t.morph]:null,_.aabb=p,m&&(a.set(t.indices,l),l+=t.indices.length),o.push(_)}return null!==n&&n.unlock(),o}_parseMeshInstances(t,e,s,i,n,a,r){const o=t.model,l=[];let h;for(h=0;h<o.meshInstances.length;h++){const t=o.meshInstances[h],c=e[t.node],d=s[t.mesh],u=new MeshInstance(d,this._defaultMaterial,c);if(d.skin){const t=i.indexOf(d.skin);u.skinInstance=n[t]}if(d.morph){const t=a.indexOf(d.morph);u.morphInstance=r[t]}l.push(u)}return l}}class ModelHandler{constructor(t){this._device=t,this._parsers=[],this._defaultMaterial=DefaultMaterial.get(t),this.maxRetries=0,this.addParser(new JsonModelParser(this._device,this._defaultMaterial),(function(t,e){return".json"===c.getExtension(t)})),this.addParser(new GlbModelParser(this._device,this._defaultMaterial),(function(t,e){return".glb"===c.getExtension(t)}))}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.load.startsWith("blob:")||t.load.startsWith("data:"))&&(".glb"===c.getExtension(t.original).toLowerCase()?s.responseType=Http.ResponseType.ARRAY_BUFFER:s.responseType=Http.ResponseType.JSON),V.get(t.load,s,(function(s,i){e&&(s?e(`Error loading model: ${t.original} [${s}]`):e(null,i))}))}open(t,e){for(let s=0;s<this._parsers.length;s++){const i=this._parsers[s];if(i.decider(t,e))return i.parser.parse(e)}return null}patch(t,e){if(!t.resource)return;const s=t.data,i=this;t.resource.meshInstances.forEach((function(n,a){if(s.mapping){const r=function t(s){s.resource?n.material=s.resource:(s.once("load",t),e.load(s)),s.once("remove",(function(t){n.material===t.resource&&(n.material=i._defaultMaterial)}))};if(!s.mapping[a])return void(n.material=i._defaultMaterial);const o=s.mapping[a].material,l=s.mapping[a].path;let h;if(void 0!==o)o?(h=e.get(o),h?r(h):e.once("add:"+o,r)):n.material=i._defaultMaterial;else if(l){const i=t.getAbsoluteUrl(s.mapping[a].path);h=e.getByUrl(i),h?r(h):e.once("add:url:"+i,r)}}}))}addParser(t,e){this._parsers.push({parser:t,decider:e})}}function qr(t){const e=this;if(!e.resource)return;const s=t.resource,i=s.renders&&s.renders[e.data.renderIndex];i&&(e.resource.meshes=i.resource.meshes)}function $r(t){const e=this;e.registry.off("load:"+t.id,qr,e),e.registry.on("load:"+t.id,qr,e),e.registry.off("remove:"+t.id,Yr,e),e.registry.once("remove:"+t.id,Yr,e),t.resource?qr.call(e,t):e.registry.load(t)}function Yr(t){const e=this;e.registry.off("load:"+t.id,qr,e),e.resource&&e.resource.destroy()}class RenderHandler{constructor(t){this._registry=t}load(t,e,s){}open(t,e){return new Render}patch(t,e){if(!t.data.containerAsset)return;const s=e.get(t.data.containerAsset);s?$r.call(t,s):e.once("add:"+t.data.containerAsset,$r,t)}}class ResourceLoader{constructor(t){this._handlers={},this._requests={},this._cache={},this._app=t}addHandler(t,e){this._handlers[t]=e,e._loader=this}removeHandler(t){delete this._handlers[t]}getHandler(t){return this._handlers[t]}load(t,e,s,i){const n=this._handlers[e];if(!n){return void s("No handler for asset type: "+e)}if(!t)return void this._loadNull(n,s,i);const a=t+e;if(void 0!==this._cache[a])s(null,this._cache[a]);else if(this._requests[a])this._requests[a].push(s);else{this._requests[a]=[s];const e=this,r=function(t,s){t?e._onFailure(a,t):n.load(s,(function(t,r,o){if(e._requests[a])if(t)e._onFailure(a,t);else try{e._onSuccess(a,n.open(s.original,r,i),o)}catch($u){e._onFailure(a,$u)}}),i)},o=t.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(o)){if(!this._app.bundles.canLoadUrl(o))return void r(`Bundle for ${t} not loaded yet`);this._app.bundles.loadUrl(o,(function(t,e){r(t,{load:e,original:o})}))}else r(null,{load:t,original:i&&i.file.filename||t})}}_loadNull(t,e,s){t.load(null,(function(i,n,a){if(i)e(i);else try{e(null,t.open(null,n,s),a)}catch($u){e($u)}}),s)}_onSuccess(t,e,s){this._cache[t]=e;for(let i=0;i<this._requests[t].length;i++)this._requests[t][i](null,e,s);delete this._requests[t]}_onFailure(t,e){if(console.error(e),this._requests[t]){for(let s=0;s<this._requests[t].length;s++)this._requests[t][s](e);delete this._requests[t]}}open(t,e){const s=this._handlers[t];return s?s.open(null,e):(console.warn("No resource handler found for: "+t),e)}patch(t,e){const s=this._handlers[t.type];s?s.patch&&s.patch(t,e):console.warn("No resource handler found for: "+t.type)}clearCache(t,e){delete this._cache[t+e]}getFromCache(t,e){if(this._cache[t+e])return this._cache[t+e]}enableRetry(t=5){t=Math.max(0,t)||0;for(const e in this._handlers)this._handlers[e].maxRetries=t}disableRetry(){for(const t in this._handlers)this._handlers[t].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}class SceneHandler{constructor(t){this._app=t,this.maxRetries=0}load(t,e){Hr(t,this.maxRetries,e)}open(t,e){this._app.systems.script.preloading=!0;const s=new SceneParser(this._app,!1).parse(e),i=this._app.scene;return i.root=s,this._app.applySceneSettings(e.settings),this._app.systems.script.preloading=!1,i}patch(t,e){}}let Kr=!1,Zr=!1;const Qr={app:null,create:function(t,e){if(!Kr)return;const s=e(Qr.app);s._pcScriptName=t,ScriptHandler._push(s),this.fire("created",t,e)},attribute:function(t,e,s,i){},createLoadingScreen:function(t){if(Zr)return;Zr=!0;t(ei())}};Object.defineProperty(Qr,"legacy",{get:function(){return Kr},set:function(t){Kr=t}}),l.attach(Qr);class ScriptHandler{constructor(t){this._app=t,this._scripts={},this._cache={}}static _push(t){Qr.legacy&&ScriptHandler._types.length>0?console.assert("Script Ordering Error. Contact support@playcanvas.com"):ScriptHandler._types.push(t)}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s=this;Qr.app=this._app,this._loadScript(t.load,((t,i,n)=>{if(t)e(t);else if(Qr.legacy){let t=null;ScriptHandler._types.length&&(t=ScriptHandler._types.pop()),t?this._scripts[i]=t:t=null,e(null,t,n)}else{const t={};for(let e=0;e<ScriptHandler._types.length;e++)t[ScriptHandler._types[e].name]=ScriptHandler._types[e];ScriptHandler._types.length=0,e(null,t,n),delete s._loader._cache[i+"script"]}}))}open(t,e){return e}patch(t,e){}_loadScript(t,e){const s=document.head,i=document.createElement("script");this._cache[t]=i,i.async=!1,i.addEventListener("error",(function(t){e(`Script: ${t.target.src} failed to load`)}),!1);let n=!1;i.onload=i.onreadystatechange=function(){n||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(n=!0,e(null,t,i))},i.src=t,s.appendChild(i)}}ScriptHandler._types=[];class ShaderHandler{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),V.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?e(`Error loading shader resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return e}patch(t,e){}}const Jr=[0,0,1,0,0,1,0,0,1,0,0,1],to=[0,1,3,2,3,1];class Sprite extends EventHandler{constructor(t,e){super(),this._device=t,this._pixelsPerUnit=e&&void 0!==e.pixelsPerUnit?e.pixelsPerUnit:1,this._renderMode=e&&void 0!==e.renderMode?e.renderMode:0,this._atlas=e&&void 0!==e.atlas?e.atlas:null,this._frameKeys=e&&void 0!==e.frameKeys?e.frameKeys:null,this._meshes=[],this._updatingProperties=!1,this._meshesDirty=!1,this._atlas&&this._frameKeys&&this._createMeshes()}set frameKeys(t){this._frameKeys=t,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",t)}get frameKeys(){return this._frameKeys}set atlas(t){t!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=t,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",t))}get atlas(){return this._atlas}set pixelsPerUnit(t){this._pixelsPerUnit!==t&&(this._pixelsPerUnit=t,this.fire("set:pixelsPerUnit",t),this._atlas&&this._frameKeys&&0===this.renderMode&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}get pixelsPerUnit(){return this._pixelsPerUnit}set renderMode(t){if(this._renderMode===t)return;const e=this._renderMode;this._renderMode=t,this.fire("set:renderMode",t),0!==e&&0!==t||this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}get renderMode(){return this._renderMode}get meshes(){return this._meshes}_createMeshes(){const t=this._meshes.length;for(let i=0;i<t;i++){const t=this._meshes[i];t&&t.destroy()}const e=this._frameKeys.length;this._meshes=new Array(e);const s=1===this.renderMode||2===this._renderMode?this._create9SliceMesh:this._createSimpleMesh;for(let i=0;i<e;i++){const t=this._atlas.frames[this._frameKeys[i]];this._meshes[i]=t?s.call(this,t):null}this.fire("set:meshes")}_createSimpleMesh(t){const e=t.rect,s=this._atlas.texture.width,i=this._atlas.texture.height,n=e.z/this._pixelsPerUnit,a=e.w/this._pixelsPerUnit,r=t.pivot.x,o=t.pivot.y,l=[-r*n,-o*a,0,(1-r)*n,-o*a,0,(1-r)*n,(1-o)*a,0,-r*n,(1-o)*a,0],h=e.x/s,c=1-e.y/i,d=(e.x+e.z)/s,u=1-(e.y+e.w)/i,p=[h,c,d,c,d,u,h,u];return hi(this._device,l,{uvs:p,normals:Jr,indices:to})}_create9SliceMesh(){const t=Vec2.ONE,e=[],s=[],i=[],n=[];let a=0;for(let o=0;o<=3;o++){const r=0===o||3===o?0:1;for(let l=0;l<=3;l++){const h=-t.x+2*t.x*(o<=1?0:3)/3,c=0,d=-(-t.y+2*t.y*(l<=1?0:3)/3),u=0===l||3===l?0:1;e.push(-h,c,d),s.push(0,1,0),i.push(r,u),o<3&&l<3&&(n.push(a+3+1,a+1,a),n.push(a+3+1,a+3+2,a+1)),a++}}const r={normals:s,uvs:i,indices:n};return hi(this._device,e,r)}_onSetFrames(t){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()}_onFrameChanged(t,e){const s=this._frameKeys.indexOf(t);s<0||(e?0===this.renderMode&&(this._meshes[s]=this._createSimpleMesh(e)):this._meshes[s]=null,this.fire("set:meshes"))}_onFrameRemoved(t){const e=this._frameKeys.indexOf(t);e<0||(this._meshes[e]=null,this.fire("set:meshes"))}startUpdate(){this._updatingProperties=!0,this._meshesDirty=!1}endUpdate(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1}destroy(){for(const t of this._meshes)t&&t.destroy();this._meshes.length=0}}function eo(t){const e=this;e.resource&&(e.resource.atlas=t.resource)}function so(t){this.registry.load(t)}class SpriteHandler{constructor(t,e){this._assets=t,this._device=e,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),".json"===c.getExtension(t.original)&&V.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(t,s){t?e(t):e(null,s)}))}open(t,e){const s=new Sprite(this._device);return t&&(s.__data=e),s}patch(t,e){const s=t.resource;if(s.__data&&(t.data.pixelsPerUnit=s.__data.pixelsPerUnit,t.data.renderMode=s.__data.renderMode,t.data.frameKeys=s.__data.frameKeys,s.__data.textureAtlasAsset)){const i=e.getByUrl(s.__data.textureAtlasAsset);i?t.data.textureAtlasAsset=i.id:console.warn("Could not find textureatlas with url: "+s.__data.textureAtlasAsset)}s.startUpdate(),s.renderMode=t.data.renderMode,s.pixelsPerUnit=t.data.pixelsPerUnit,s.frameKeys=t.data.frameKeys,this._updateAtlas(t),s.endUpdate(),t.off("change",this._onAssetChange,this),t.on("change",this._onAssetChange,this)}_updateAtlas(t){const e=t.resource;if(!t.data.textureAtlasAsset)return void(e.atlas=null);this._assets.off("load:"+t.data.textureAtlasAsset,eo,t),this._assets.on("load:"+t.data.textureAtlasAsset,eo,t);const s=this._assets.get(t.data.textureAtlasAsset);s&&s.resource?e.atlas=s.resource:s?this._assets.load(s):(this._assets.off("add:"+t.data.textureAtlasAsset,so,t),this._assets.on("add:"+t.data.textureAtlasAsset,so,t))}_onAssetChange(t,e,s,i){"data"===e&&s&&s.textureAtlasAsset&&i&&s.textureAtlasAsset!==i.textureAtlasAsset&&(this._assets.off("load:"+i.textureAtlasAsset,eo,t),this._assets.off("add:"+i.textureAtlasAsset,so,t))}}class Template{constructor(t,e){this._app=t,this._data=e,this._templateRoot=null}instantiate(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()}_parseTemplate(){const t=new SceneParser(this._app,!0);this._templateRoot=t.parse(this._data)}}class TemplateHandler{constructor(t){this._app=t,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};V.get(t.load,s,(function(s,i){s?e("Error requesting template: "+t.original):e(s,i)}))}open(t,e){return new Template(this._app,e)}}class TextHandler{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),V.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?e(`Error loading text resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return e}patch(t,e){}}class TextureAtlas extends EventHandler{constructor(){super(),this._texture=null,this._frames=null}set texture(t){this._texture=t,this.fire("set:texture",t)}get texture(){return this._texture}set frames(t){this._frames=t,this.fire("set:frames",t)}get frames(){return this._frames}setFrame(t,e){let s=this._frames[t];s?(s.rect.copy(e.rect),s.pivot.copy(e.pivot),s.border.copy(e.border)):(s={rect:e.rect.clone(),pivot:e.pivot.clone(),border:e.border.clone()},this._frames[t]=s),this.fire("set:frame",t.toString(),s)}removeFrame(t){const e=this._frames[t];e&&(delete this._frames[t],this.fire("remove:frame",t.toString(),e))}destroy(){this._texture&&this._texture.destroy()}}const io={repeat:0,clamp:1,mirror:2},no={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},ao=/^data\.frames\.(\d+)$/;class TextureAtlasHandler{constructor(t){this._loader=t,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s=this,i=this._loader.getHandler("texture");if(".json"!==c.getExtension(t.original))return i.load(t,e);V.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(i,n){if(i)e(i);else{const i=t.original.replace(".json",".png");s._loader.load(i,"texture",(function(t,s){t?e(t):e(null,{data:n,texture:s})}))}}))}open(t,e){const s=new TextureAtlas;if(e.texture&&e.data)s.texture=e.texture,s.__data=e.data;else{const i=this._loader.getHandler("texture").open(t,e);if(!i)return null;s.texture=i}return s}patch(t,e){t.resource.__data&&(void 0!==t.resource.__data.minfilter&&(t.data.minfilter=t.resource.__data.minfilter),void 0!==t.resource.__data.magfilter&&(t.data.magfilter=t.resource.__data.magfilter),void 0!==t.resource.__data.addressu&&(t.data.addressu=t.resource.__data.addressu),void 0!==t.resource.__data.addressv&&(t.data.addressv=t.resource.__data.addressv),void 0!==t.resource.__data.mipmaps&&(t.data.mipmaps=t.resource.__data.mipmaps),void 0!==t.resource.__data.anisotropy&&(t.data.anisotropy=t.resource.__data.anisotropy),void 0!==t.resource.__data.rgbm&&(t.data.rgbm=!!t.resource.__data.rgbm),t.data.frames=t.resource.__data.frames,delete t.resource.__data);const s=t.resource.texture;if(s&&(s.name=t.name,t.data.hasOwnProperty("minfilter")&&s.minFilter!==no[t.data.minfilter]&&(s.minFilter=no[t.data.minfilter]),t.data.hasOwnProperty("magfilter")&&s.magFilter!==no[t.data.magfilter]&&(s.magFilter=no[t.data.magfilter]),t.data.hasOwnProperty("addressu")&&s.addressU!==io[t.data.addressu]&&(s.addressU=io[t.data.addressu]),t.data.hasOwnProperty("addressv")&&s.addressV!==io[t.data.addressv]&&(s.addressV=io[t.data.addressv]),t.data.hasOwnProperty("mipmaps")&&s.mipmaps!==t.data.mipmaps&&(s.mipmaps=t.data.mipmaps),t.data.hasOwnProperty("anisotropy")&&s.anisotropy!==t.data.anisotropy&&(s.anisotropy=t.data.anisotropy),t.data.hasOwnProperty("rgbm"))){const e=t.data.rgbm?Ot:Ft;s.type!==e&&(s.type=e)}t.resource.texture=s;const i={};for(const n in t.data.frames){const e=t.data.frames[n];i[n]={rect:new Vec4(e.rect),pivot:new Vec2(e.pivot),border:new Vec4(e.border)}}t.resource.frames=i,t.off("change",this._onAssetChange,this),t.on("change",this._onAssetChange,this)}_onAssetChange(t,e,s){let i;if("data"===e||"data.frames"===e){const e={};for(const t in s.frames)i=s.frames[t],e[t]={rect:new Vec4(i.rect),pivot:new Vec2(i.pivot),border:new Vec4(i.border)};t.resource.frames=e}else{const n=e.match(ao);if(n){const e=n[1];s?(t.resource.frames[e]?(i=t.resource.frames[e],i.rect.set(s.rect[0],s.rect[1],s.rect[2],s.rect[3]),i.pivot.set(s.pivot[0],s.pivot[1]),i.border.set(s.border[0],s.border[1],s.border[2],s.border[3])):t.resource.frames[e]={rect:new Vec4(s.rect),pivot:new Vec2(s.pivot),border:new Vec4(s.border)},t.resource.fire("set:frame",e,t.resource.frames[e])):t.resource.frames[e]&&(delete t.resource.frames[e],t.resource.fire("remove:frame",e))}}}}function ro(){const t=0,e=1,s=2,i=3,n=8,a=9,r=10,o=11,l=12,h=13,c=14,d=16,u={astc:r,dxt:s,etc1:t,etc2:t,pvr:n,atc:o,none:c},p={astc:r,dxt:i,etc1:d,etc2:e,pvr:a,atc:l,none:d},m=21,_=22,f=23,g=8,y=10,v=26,b=27,x=28,S=29,w=30,C=7,T=3,M=5,A=(u,p)=>{switch(u){case t:return p.formats.etc1?m:_;case e:return f;case s:return g;case i:return y;case n:return v;case a:return b;case r:return x;case o:return S;case l:return w;case h:return C;case c:return T;case d:return M}},P=t=>{const e=function(t,e){const s=t*(2/255)-1,i=e*(2/255)-1,n=Math.sqrt(1-Math.min(1,s*s+i*i));return Math.max(0,Math.min(255,Math.floor(.5*(n+1)*255)))};for(let s=0;s<t.length;s+=4){const i=t[s+3],n=t[s+1];t[s+0]=i,t[s+2]=e(i,n),t[s+3]=255}return t},E=t=>{const e=new Uint16Array(t.length/4);for(let s=0;s<t.length;s+=4){const i=t[s+0],n=t[s+1],a=t[s+2];e[s/4]=(248&i)<<8|(252&n)<<3|a>>3}return e},L=()=>"undefined"!=typeof performance?performance.now():0;let R,I,D;const k=(t,e,s)=>{if(s){if(t.formats.astc)return"astc"}else if(e){if(t.formats.etc2)return"etc2"}else if(t.formats.etc1||t.formats.etc2)return"etc1";return(e=>{for(let s=0;s<e.length;++s){const i=e[s];if(t.formats[i])return i}return"none"})(e?D:I)},F=(h,c,d,u)=>{switch(d){case t:case e:return!0;case s:case i:return 0==(3&h)&&0==(3&c);case n:case a:return((t,e)=>0==(t&t-1)&&0==(e&e-1))(h,c)&&(h===c||u);case r:case o:case l:return!0}},O=(t,e,s)=>s.isKTX2?((t,e,s)=>{if(!R.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");const i=L(),n=new R.KTX2File(new Uint8Array(e)),a=n.getWidth(),r=n.getHeight(),o=n.getLevels(),l=!!n.getHasAlpha(),m=n.isUASTC&&n.isUASTC();if(!a||!r||!o)throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${t} width=${a} height=${r} levels=${o}`);const _=k(s.deviceDetails,l,m),f=!!s.isGGGR&&"pvr"===_;let g,y;if(f?g=h:(g=l?p[_]:u[_],F(a,r,g,s.deviceDetails.webgl2)||(g=l?h:c)),!n.startTranscoding())throw n.close(),n.delete(),new Error("Failed to start transcoding url="+t);const v=[];for(let h=0;h<o;++h){const e=n.getImageTranscodedSizeInBytes(h,0,0,g),s=new Uint8Array(e);if(!n.transcodeImage(s,h,0,0,g,0,-1,-1))throw n.close(),n.delete(),new Error("Failed to transcode image url="+t);const i=g===c||g===d;v.push(i?new Uint16Array(s.buffer):s)}if(n.close(),n.delete(),f)for(g=c,y=0;y<v.length;++y)v[y]=E(P(v[y]));return{format:A(g,s.deviceDetails),width:a,height:r,levels:v,cubemap:!1,transcodeTime:L()-i,url:t,unswizzledGGGR:f}})(t,e,s):((t,e,s)=>{const i=L(),n=new R.BasisFile(new Uint8Array(e)),a=n.getImageWidth(0,0),r=n.getImageHeight(0,0),o=n.getNumImages(),l=n.getNumLevels(0),m=!!n.getHasAlpha(),_=n.isUASTC&&n.isUASTC();if(!(a&&r&&o&&l))throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${t} width=${a} height=${r} images=${o} levels=${l}`);const f=k(s.deviceDetails,m,_),g=!!s.isGGGR&&"pvr"===f;let y,v;if(g?y=h:(y=m?p[f]:u[f],F(a,r,y,s.deviceDetails.webgl2)||(y=m?h:c)),!n.startTranscoding())throw n.close(),n.delete(),new Error("Failed to start transcoding url="+t);const b=[];for(let h=0;h<l;++h){const e=n.getImageTranscodedSizeInBytes(0,h,y),s=new Uint8Array(e);if(!n.transcodeImage(s,0,h,y,0,0))throw n.close(),n.delete(),new Error("Failed to transcode image url="+t);const i=y===c||y===d;b.push(i?new Uint16Array(s.buffer):s)}if(n.close(),n.delete(),g)for(y=c,v=0;v<b.length;++v)b[v]=E(P(b[v]));return{format:A(y,s.deviceDetails),width:a,height:r,levels:b,cubemap:!1,transcodeTime:L()-i,url:t,unswizzledGGGR:g}})(t,e,s),V=(t,e,s)=>{try{const i=O(t,e,s);i.levels=i.levels.map((t=>t.buffer)),self.postMessage({url:t,data:i},i.levels)}catch(i){self.postMessage({url:t,err:i},null)}},B=[];self.onmessage=t=>{const e=t.data;switch(e.type){case"init":s=e.config,i=()=>{for(let t=0;t<B.length;++t)V(B[t].url,B[t].data,B[t].options);B.length=0},self.importScripts(s.basisUrl),self.BASIS(s.module?{instantiateWasm:(t,e)=>(WebAssembly.instantiate(s.module,t).then((t=>{e(t)})).catch((t=>{console.error("instantiate failed + "+t)})),{})}:null).then((t=>{t.initializeBasis(),R=t,I=s.rgbPriority,D=s.rgbaPriority,i(null)}));break;case"transcode":R?V(e.url,e.data,e.options):B.push(e)}var s,i}}const oo=t=>({astc:!!t.extCompressedTextureASTC,atc:!!t.extCompressedTextureATC,dxt:!!t.extCompressedTextureS3TC,etc1:!!t.extCompressedTextureETC1,etc2:!!t.extCompressedTextureETC,pvr:!!t.extCompressedTexturePVRTC});class BasisClient{constructor(t,e,s){this.queue=t,this.worker=new Worker(e.workerUrl),this.worker.addEventListener("message",(t=>{const e=t.data;this.queue.handleResponse(e.url,e.err,e.data),this.eager||this.queue.enqueueClient(this)})),this.worker.postMessage({type:"init",config:e}),this.eager=s}run(t){const e=[];t.data instanceof ArrayBuffer&&e.push(t.data),this.worker.postMessage({type:"transcode",url:t.url,format:t.format,data:t.data,options:t.options},e),this.eager&&this.queue.enqueueClient(this)}}const lo=["etc1","etc2","astc","dxt","pvr","atc"],ho=["astc","dxt","etc2","pvr","atc"],co=new class BasisQueue{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(t,e,s,i){if(this.callbacks.hasOwnProperty(t))this.callbacks[t].push(s);else{this.callbacks[t]=[s];const n={url:t,data:e,options:i};this.clients.length>0?this.clients.shift().run(n):this.queue.push(n)}}enqueueClient(t){this.queue.length>0?t.run(this.queue.shift()):this.clients.push(t)}handleResponse(t,e,s){const i=this.callbacks[t];if(e)for(let n=0;n<i.length;++n)i[n](e);else{3===s.format||5===s.format?s.levels=s.levels.map((function(t){return new Uint16Array(t)})):s.levels=s.levels.map((function(t){return new Uint8Array(t)}));for(let t=0;t<i.length;++t)i[t](null,s)}delete this.callbacks[t]}};let uo=null,po=!1;function mo(t){if(!po){if(t){if(t.lazyInit)return void(uo=t)}else t=uo||{};if(!t.glueUrl||!t.wasmUrl||!t.fallbackUrl){const e=((window.config?window.config.wasmModules:window.PRELOAD_MODULES)||[]).find((function(t){return"BASIS"===t.moduleName}));if(e){const s=window.ASSET_PREFIX||"";t.glueUrl||(t.glueUrl=s+e.glueUrl),t.wasmUrl||(t.wasmUrl=s+e.wasmUrl),t.fallbackUrl||(t.fallbackUrl=s+e.fallbackUrl)}}if(t.glueUrl||t.wasmUrl||t.fallbackUrl){po=!0;const e=Math.max(1,Math.min(16,t.numWorkers||1)),s=1===t.numWorkers||!t.hasOwnProperty("eagerWorkers")||t.eagerWorkers;t.rgbPriority=t.rgbPriority||lo,t.rgbaPriority=t.rgbaPriority||ho,((t,e)=>{const s=()=>{const t="("+ro.toString()+")()\n\n";return new Blob([t],{type:"application/javascript"})},i=(i,n)=>{e(null,{workerUrl:URL.createObjectURL(s()),basisUrl:URL.createObjectURL(i),module:n,rgbPriority:t.rgbPriority,rgbaPriority:t.rgbaPriority})};if(t.glueUrl&&t.wasmUrl&&(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch($u){}return!1})()){let s=null,n=null;V.get(t.glueUrl,{responseType:"blob"},((t,a)=>{t?e(t):n?i(a,n):s=a}));const a=fetch(t.wasmUrl),r=()=>{a.then((t=>t.arrayBuffer())).then((t=>WebAssembly.compile(t))).then((t=>{s?i(s,t):n=t})).catch((t=>{e(t,null)}))};WebAssembly.compileStreaming?WebAssembly.compileStreaming(a).then((t=>{s?i(s,t):n=t})).catch((t=>{r()})):r()}else V.get(t.fallbackUrl,{responseType:"blob"},((t,s)=>{t?e(t,null):i(s,null)}))})(t,((t,i)=>{if(t)console.error(`failed to initialize basis worker: ${t}`);else for(let n=0;n<e;++n)co.enqueueClient(new BasisClient(co,i,s))}))}}}let _o=null;function fo(t,e,s,i,n){return mo(),_o||(_o={webgl2:t.webgl2,formats:oo(t)}),co.enqueueJob(e,s,i,{deviceDetails:_o,isGGGR:!(null==n||!n.isGGGR),isKTX2:!(null==n||!n.isKTX2)}),po}class BasisParser{constructor(t,e){this.device=e,this.maxRetries=0}load(t,e,s){const i=this.device;Asset.fetchArrayBuffer(t.load,((n,a)=>{var r,o,l,h;n?e(n):(r=a,fo(i,t.load,r,e,{isGGGR:0!=(8&(null==s||null==(o=s.file)||null==(l=o.variants)||null==(h=l.basis)?void 0:h.opt))})||e(`Basis module not found. Asset '${s.name}' basis texture variant will not be loaded.`))}),s,this.maxRetries)}open(t,e,s){const i=new Texture(s,{name:t,addressU:e.cubemap?1:0,addressV:e.cubemap?1:0,width:e.width,height:e.height,format:e.format,cubemap:e.cubemap,levels:e.levels});return i.upload(),i}}class ImgParser{constructor(t){this.crossOrigin=t.prefix?"anonymous":null,this.maxRetries=0,this.useImageBitmap=!1}load(t,e,s){var i;const n=!(null==s||null==(i=s.file)||!i.contents);n&&(t={load:URL.createObjectURL(new Blob([s.file.contents])),original:t.original});const a=(s,i)=>{n&&URL.revokeObjectURL(t.load),e(s,i)};let r;s&&s.options&&s.options.hasOwnProperty("crossOrigin")?r=s.options.crossOrigin:er.test(t.load)&&(r=this.crossOrigin),this.useImageBitmap?this._loadImageBitmap(t.load,t.original,r,a):this._loadImage(t.load,t.original,r,a)}open(t,e,s){const i=c.getExtension(t).toLowerCase(),n=".jpg"===i||".jpeg"===i?6:7,a=new Texture(s,{name:t,width:e.width,height:e.height,format:n});return a.setSource(e),a}_loadImage(t,e,s,i){const n=new Image;s&&(n.crossOrigin=s);let a=0;const r=this.maxRetries;let o;n.onload=function(){i(null,n)},n.onerror=function(){if(!o)if(r>0&&++a<=r){const s=100*Math.pow(2,a);console.log(`Error loading Texture from: '${e}' - Retrying in ${s}ms...`);const i=t.indexOf("?")>=0?"&":"?";o=setTimeout((function(){n.src=t+i+"retry="+Date.now(),o=null}),s)}else i(`Error loading Texture from: '${e}'`)},n.src=t}_loadImageBitmap(t,e,s,i){const n={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};V.get(t,n,(function(t,e){t?i(t):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(t){i(null,t)})).catch((function(t){i(t)}))}))}}const go=[1481919403,3140563232,169478669],yo={33776:8,33778:9,33779:nt,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25,32849:6,32856:7,35905:19,35907:20,35898:18,34843:11,34842:at};class KtxParser{constructor(t){this.maxRetries=0}load(t,e,s){Asset.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s){const i=this.parse(e);if(!i)return null;const n=new Texture(s,{name:t,addressU:i.cubemap?1:0,addressV:i.cubemap?1:0,width:i.width,height:i.height,format:i.format,cubemap:i.cubemap,levels:i.levels});return n.upload(),n}parse(t){const e=new Uint32Array(t);if(go[0]!==e[0]||go[1]!==e[1]||go[2]!==e[2])return null;const s={endianness:e[3],glType:e[4],glTypeSize:e[5],glFormat:e[6],glInternalFormat:e[7],glBaseInternalFormat:e[8],pixelWidth:e[9],pixelHeight:e[10],pixelDepth:e[11],numberOfArrayElements:e[12],numberOfFaces:e[13],numberOfMipmapLevels:e[14],bytesOfKeyValueData:e[15]};if(s.pixelDepth>1)return null;if(0!==s.numberOfArrayElements)return null;const i=yo[s.glInternalFormat];if(void 0===i)return null;let n=16+s.bytesOfKeyValueData/4;const a=s.numberOfFaces>1,r=[];for(let c=0;c<(s.numberOfMipmapLevels||1);c++){const s=e[n++];a&&r.push([]);const d=a?r[c]:r;for(let e=0;e<(a?6:1);++e)d.push((o=t,l=4*n,h=s,18===i?new Uint32Array(o,l,h/4):new Uint8Array(o,l,h))),n+=s+3>>2}var o,l,h;return{format:i,width:s.pixelWidth,height:s.pixelHeight,levels:r,cubemap:a}}}const vo=166;class Ktx2Parser{constructor(t,e){this.maxRetries=0,this.device=e}load(t,e,s){Asset.fetchArrayBuffer(t.load,((i,n)=>{i?e(i,n):this.parse(n,t,e,s)}),s,this.maxRetries)}open(t,e,s){const i=new Texture(s,{name:t,addressU:e.cubemap?1:0,addressV:e.cubemap?1:0,width:e.width,height:e.height,format:e.format,cubemap:e.cubemap,levels:e.levels});return i.upload(),i}parse(t,e,s,i){const n=new ReadStream(t),a=[n.readU32be(),n.readU32be(),n.readU32be()];if(2873840728!==a[0]||540160187!==a[1]||218765834!==a[2])return null;const r={vkFormat:n.readU32(),typeSize:n.readU32(),pixelWidth:n.readU32(),pixelHeight:n.readU32(),pixelDepth:n.readU32(),layerCount:n.readU32(),faceCount:n.readU32(),levelCount:n.readU32(),supercompressionScheme:n.readU32()},o={dfdByteOffset:n.readU32(),dfdByteLength:n.readU32(),kvdByteOffset:n.readU32(),kvdByteLength:n.readU32(),sgdByteOffset:n.readU64(),sgdByteLength:n.readU64()},l=[];for(let p=0;p<Math.max(1,r.levelCount);++p)l.push({byteOffset:n.readU64(),byteLength:n.readU64(),uncompressedByteLength:n.readU64()});if(n.readU32()!==o.kvdByteOffset-o.dfdByteOffset)return null;n.skip(8);const h=n.readU8();if(n.skip(o.dfdByteLength-9),n.skip(o.kvdByteLength),1===r.supercompressionScheme||h===vo){var c,d,u;fo(this.device,e.load,t,s,{isGGGR:0!=(8&(null==i||null==(c=i.file)||null==(d=c.variants)||null==(u=d.basis)?void 0:u.opt)),isKTX2:!0})||s('Basis module not found. Asset "'+i.name+'" basis texture variant will not be loaded.')}else s("unsupported KTX2 pixel format")}}class DdsParser{constructor(t){this.maxRetries=0}load(t,e,s){Asset.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s){const i=new Uint32Array(e,0,32),n=i[4],a=i[3],r=Math.max(i[7],1),o=4===i[20],l=i[21],h=i[22],c=65024===i[28],d=827611204,u=825438800,p=825439312;let m,_=!1,f=!1,g=!1,y=!1,v=null,b=1;if(o?l===d?(v=8,_=!0):894720068===l?(v=nt,_=!0):113===l?(v=at,b=2):116===l?(v=rt,b=4):826496069===l?(v=21,_=!0,f=!0):l===u||825504336===l?(v=l===u?24:25,_=!0,g=!0):l!==p&&825504848!==l||(v=l===p?26:27,_=!0,y=!0):32===h&&(v=7),!v)return m=new Texture(s,{width:4,height:4,format:6}),m.name="dds-legacy-empty",m;m=new Texture(s,{name:t,addressU:c?1:0,addressV:c?1:0,width:n,height:a,format:v,cubemap:c,mipmaps:r>1});let x=128;const S=c?6:1;let w;const C=l===d?8:16;let T,M,A;for(let P=0;P<S;P++){let t=n,s=a;for(let i=0;i<r;i++){_?f?w=Math.floor((t+3)/4)*Math.floor((s+3)/4)*8:g?w=Math.max(t,16)*Math.max(s,8)/4:y?w=Math.max(t,8)*Math.max(s,8)/2:(T=Math.floor((t+4-1)/4),M=Math.floor((s+4-1)/4),A=T*M,w=A*C):w=t*s*4;const n=v===rt?new Float32Array(e,x,w):v===at?new Uint16Array(e,x,w):new Uint8Array(e,x,w);c?(m._levels[i]||(m._levels[i]=[]),m._levels[i][P]=n):m._levels[i]=n,x+=w*b,t=Math.max(.5*t,1),s=Math.max(.5*s,1)}}return m.upload(),m}}class HdrParser{constructor(t){this.maxRetries=0}load(t,e,s){Asset.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s){const i=this.parse(e);if(!i)return null;const n=new Texture(s,{name:t,addressU:0,addressV:1,minFilter:2,magFilter:0,width:i.width,height:i.height,levels:i.levels,format:7,type:Vt,mipmaps:!1});return n.upload(),n}parse(t){const e=new ReadStream(t);if(!e.readLine().startsWith("#?RADIANCE"))return null;const s={};for(;;){const t=e.readLine();if(0===t.length)break;{const e=t.split("=");2===e.length&&(s[e[0]]=e[1])}}if(!s.hasOwnProperty("FORMAT"))return null;const i=e.readLine().split(" ");if(4!==i.length)return null;const n=parseInt(i[1],10),a=parseInt(i[3],10),r=this._readPixels(e,a,n,"-Y"===i[0]);return r?{width:a,height:n,levels:[r]}:null}_readPixels(t,e,s,i){if(e<8||e>32767)return this._readPixelsFlat(t,e,s);const n=[0,0,0,0];if(t.readArray(n),2!==n[0]||2!==n[1]||0!=(128&n[2]))return t.skip(-4),this._readPixelsFlat(t,e,s);const a=new ArrayBuffer(e*s*4),r=new Uint8Array(a);let o,l,h,c,d,u,p=i?0:4*e*(s-1);for(l=0;l<s;++l){if(l&&t.readArray(n),(n[2]<<8)+n[3]!==e)return null;for(c=0;c<4;++c)for(o=0;o<e;)if(d=t.readU8(),d>128){if(d-=128,o+d>e)return null;for(u=t.readU8(),h=0;h<d;++h)r[p+c+4*o++]=u}else{if(0===d||o+d>e)return null;for(h=0;h<d;++h)r[p+c+4*o++]=t.readU8()}p+=4*e*(i?1:-1)}return r}_readPixelsFlat(t,e,s){return t.remainingBytes===e*s*4?new Uint8Array(t.arraybuffer,t.offset):null}}const bo={repeat:0,clamp:1,mirror:2},xo={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},So={default:Ft,rgbm:Ot,rgbe:Vt,swizzleGGGR:Bt};class TextureHandler{constructor(t,e,s){this._device=t,this._assets=e,this._loader=s,this.imgParser=new ImgParser(e),this.parsers={dds:new DdsParser(e),ktx:new KtxParser(e),ktx2:new Ktx2Parser(e,t),basis:new BasisParser(e,t),hdr:new HdrParser(e)}}set crossOrigin(t){this.imgParser.crossOrigin=t}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(t){this.imgParser.maxRetries=t;for(const e in this.parsers)this.parsers.hasOwnProperty(e)&&(this.parsers[e].maxRetries=t)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=c.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".","");return this.parsers[e]||this.imgParser}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){if(!t)return;let i=this._getParser(t).open(t,e,this._device);return null===i?i=new Texture(this._device,{width:4,height:4,format:6}):(!function(t){const e=Math.log2(Math.max(t._width,t._height))+1;if(7!==t._format&&t._format!==rt||t._volume||t._compressed||1===t._levels.length||t._levels.length===e||(s=t._cubemap?t._levels[0][0]:t._levels[0])instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement)return;var s;const i=function(t,e,s){const i=Math.max(1,t>>1),n=Math.max(1,e>>1),a=new s.constructor(i*n*4),r=Math.floor(t/i),o=Math.floor(e/n),l=r*o;for(let h=0;h<n;++h)for(let e=0;e<i;++e)for(let n=0;n<4;++n){let c=0;for(let i=0;i<o;++i)for(let a=0;a<r;++a)c+=s[4*(e*r+a+(h*o+i)*t)+n];a[4*(e+h*i)+n]=c/l}return a};for(let n=t._levels.length;n<e;++n){const e=Math.max(1,t._width>>n-1),s=Math.max(1,t._height>>n-1);if(t._cubemap){const a=[];for(let r=0;r<6;++r)a.push(i(e,s,t._levels[n-1][r]));t._levels.push(a)}else t._levels.push(i(e,s,t._levels[n-1]))}t._levelsUpdated=t._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}(i),e.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),i}patch(t,e){const s=t.resource;if(!s)return;t.name&&t.name.length>0&&(s.name=t.name);const i=t.data;i.hasOwnProperty("minfilter")&&(s.minFilter=xo[i.minfilter]),i.hasOwnProperty("magfilter")&&(s.magFilter=xo[i.magfilter]),s.cubemap||(i.hasOwnProperty("addressu")&&(s.addressU=bo[i.addressu]),i.hasOwnProperty("addressv")&&(s.addressV=bo[i.addressv])),i.hasOwnProperty("mipmaps")&&(s.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(s.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(s.flipY=!!i.flipY),i.hasOwnProperty("type")?s.type=So[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?s.type=Ot:t.file&&0!=(8&t.file.opt)&&(s.type=Bt)}}class TagsCache{constructor(t=null){this._index={},this._key=t}addItem(t){const e=t.tags._list;for(const s of e)this.add(s,t)}removeItem(t){const e=t.tags._list;for(const s of e)this.remove(s,t)}add(t,e){this._index[t]&&-1!==this._index[t].list.indexOf(e)||(this._index[t]||(this._index[t]={list:[]},this._key&&(this._index[t].keys={})),this._index[t].list.push(e),this._key&&(this._index[t].keys[e[this._key]]=e))}remove(t,e){if(!this._index[t])return;if(this._key&&!this._index[t].keys[e[this._key]])return;const s=this._index[t].list.indexOf(e);-1!==s&&(this._index[t].list.splice(s,1),this._key&&delete this._index[t].keys[e[this._key]],0===this._index[t].list.length&&delete this._index[t])}find(t){const e={},s=[];let i,n,a,r,o;const l=(t,e)=>this._index[t].list.length-this._index[e].list.length;for(let h=0;h<t.length;h++){if(n=t[h],n instanceof Array){if(0===n.length)continue;if(1!==n.length){o=!1;for(let t=0;t<n.length;t++)if(!this._index[n[t]]){o=!0;break}if(o)continue;a=n.slice(0).sort(l),r=a.slice(1),1===r.length&&(r=r[0]);for(let t=0;t<this._index[a[0]].list.length;t++)i=this._index[a[0]].list[t],(this._key?!e[i[this._key]]:-1===s.indexOf(i))&&i.tags.has(r)&&(this._key&&(e[i[this._key]]=!0),s.push(i));continue}n=n[0]}if(n&&"string"==typeof n&&this._index[n])for(let t=0;t<this._index[n].list.length;t++)i=this._index[n].list[t],this._key?e[i[this._key]]||(e[i[this._key]]=!0,s.push(i)):-1===s.indexOf(i)&&s.push(i)}return s}}class AssetRegistry extends EventHandler{constructor(t){super(),this._loader=t,this._assets=[],this._cache={},this._names={},this._tags=new TagsCache("_id"),this._urls={},this.prefix=null}list(t){return t=t||{},this._assets.filter((e=>{let s=!0;return void 0!==t.preload&&(s=e.preload===t.preload),s}))}add(t){const e=this._assets.push(t)-1;let s;this._cache[t.id]=e,this._names[t.name]||(this._names[t.name]=[]),this._names[t.name].push(e),t.file&&(s=t.file.url,this._urls[s]=e),t.registry=this,this._tags.addItem(t),t.tags.on("add",this._onTagAdd,this),t.tags.on("remove",this._onTagRemove,this),this.fire("add",t),this.fire("add:"+t.id,t),s&&this.fire("add:url:"+s,t),t.preload&&this.load(t)}remove(t){const e=this._cache[t.id],s=t.file?t.file.url:null;if(void 0!==e){this._assets.splice(e,1),delete this._cache[t.id],this._names={},this._urls=[];for(let t=0,e=this._assets.length;t<e;t++){const e=this._assets[t];this._cache[e.id]=t,this._names[e.name]||(this._names[e.name]=[]),this._names[e.name].push(t),e.file&&(this._urls[e.file.url]=t)}return this._tags.removeItem(t),t.tags.off("add",this._onTagAdd,this),t.tags.off("remove",this._onTagRemove,this),t.fire("remove",t),this.fire("remove",t),this.fire("remove:"+t.id,t),s&&this.fire("remove:url:"+s,t),!0}return!1}get(t){const e=this._cache[t];return this._assets[e]}getByUrl(t){const e=this._urls[t];return this._assets[e]}load(t){if(t.loading||t.loaded)return;const e=t.file,s=s=>{s instanceof Array?t.resources=s:t.resource=s,this._loader.patch(t,this),this.fire("load",t),this.fire("load:"+t.id,t),e&&e.url&&this.fire("load:url:"+e.url,t),t.fire("load",t)},i=(e,i,n)=>{if(t.loaded=!0,t.loading=!1,e)this.fire("error",e,t),this.fire("error:"+t.id,e,t),t.fire("error",e,t);else{if(!Qr.legacy&&"script"===t.type){const e=this._loader.getHandler("script");e._cache[t.id]&&e._cache[t.id].parentNode===document.head&&document.head.removeChild(e._cache[t.id]),e._cache[t.id]=n}s(i)}};if(e||"cubemap"===t.type)this.fire("load:start",t),this.fire("load:"+t.id+":start",t),t.loading=!0,this._loader.load(t.getFileUrl(),t.type,i,t);else{const e=this._loader.open(t.type,t.data);t.loaded=!0,s(e)}}loadFromUrl(t,e,s){this.loadFromUrlAndFilename(t,null,e,s)}loadFromUrlAndFilename(t,e,s,i){const n=c.getBasename(e||t),a={filename:e||n,url:t};let r=this.getByUrl(t);if(r){if(r.loaded)return void i(r.loadFromUrlError||null,r)}else r=new Asset(n,s,a),this.add(r);const o=t=>{t.once("load",(t=>{"material"===s?this._loadTextures(t,((e,s)=>{i(e,t)})):i(null,t)})),t.once("error",(e=>{e&&(this.loadFromUrlError=e),i(e,t)})),this.load(t)};r.resource?i(null,r):"model"===s?this._loadModel(r,o):o(r)}_loadModel(t,e){const s=t.getFileUrl(),i=c.getExtension(s);if(".json"===i||".glb"===i){const n=c.getDirectory(s),a=c.getBasename(s),r=c.join(n,a.replace(i,".mapping.json"));this._loader.load(r,"json",((s,i)=>{s?(t.data={mapping:[]},e(t)):this._loadMaterials(t,i,((s,n)=>{t.data=i,e(t)}))}))}else e(t)}_loadMaterials(t,e,s){const i=[];let n=0;const a=(t,e)=>{this._loadTextures(e,((t,a)=>{i.push(e),i.length===n&&s(null,i)}))};for(let r=0;r<e.mapping.length;r++){const s=e.mapping[r].path;if(s){n++;const e=t.getAbsoluteUrl(s);this.loadFromUrl(e,"material",a)}}0===n&&s(null,i)}_loadTextures(t,e){const s=[];let i=0;const n=t.data;if("path"!==n.mappingFormat)return void e(null,s);const a=(t,n)=>{t&&console.error(t),s.push(n),s.length===i&&e(null,s)},r=Ss;for(let o=0;o<r.length;o++){const e=n[r[o]];if(e&&"string"==typeof e){i++;const s=t.getAbsoluteUrl(e);this.loadFromUrl(s,"texture",a)}}0===i&&e(null,s)}findAll(t,e){const s=this._names[t];if(s){const t=s.map((t=>this._assets[t]));return e?t.filter((t=>t.type===e)):t}return[]}_onTagAdd(t,e){this._tags.add(t,e)}_onTagRemove(t,e){this._tags.remove(t,e)}findByTag(){return this._tags.find(arguments)}filter(t){return this._assets.filter((e=>t(e)))}find(t,e){const s=this.findAll(t,e);return s.length>0?s[0]:null}}class BundleRegistry{constructor(t){this._assets=t,this._bundleAssets={},this._assetsInBundles={},this._urlsInBundles={},this._fileRequests={},this._assets.on("add",this._onAssetAdded,this),this._assets.on("remove",this._onAssetRemoved,this)}_onAssetAdded(t){if("bundle"===t.type){this._bundleAssets[t.id]=t,this._registerBundleEventListeners(t.id);for(let e=0,s=t.data.assets.length;e<s;e++)this._indexAssetInBundle(t.data.assets[e],t)}else this._assetsInBundles[t.id]&&this._indexAssetFileUrls(t)}_registerBundleEventListeners(t){this._assets.on("load:"+t,this._onBundleLoaded,this),this._assets.on("error:"+t,this._onBundleError,this)}_unregisterBundleEventListeners(t){this._assets.off("load:"+t,this._onBundleLoaded,this),this._assets.off("error:"+t,this._onBundleError,this)}_indexAssetInBundle(t,e){if(this._assetsInBundles[t]){const s=this._assetsInBundles[t];-1===s.indexOf(e)&&s.push(e)}else this._assetsInBundles[t]=[e];const s=this._assets.get(t);s&&this._indexAssetFileUrls(s)}_indexAssetFileUrls(t){const e=this._getAssetFileUrls(t);if(e)for(let s=0,i=e.length;s<i;s++){const i=e[s];this._urlsInBundles[i]=this._assetsInBundles[t.id]}}_getAssetFileUrls(t){let e=t.getFileUrl();if(!e)return null;e=this._normalizeUrl(e);const s=[e];if("font"===t.type){const i=t.data.info.maps.length;for(let t=1;t<i;t++)s.push(e.replace(".png",t+".png"))}return s}_normalizeUrl(t){return t&&t.split("?")[0]}_onAssetRemoved(t){if("bundle"===t.type){delete this._bundleAssets[t.id],this._unregisterBundleEventListeners(t.id);for(const e in this._assetsInBundles){const s=this._assetsInBundles[e],i=s.indexOf(t);if(-1!==i&&(s.splice(i,1),!s.length)){delete this._assetsInBundles[e];for(const t in this._urlsInBundles)this._urlsInBundles[t]===s&&delete this._urlsInBundles[t]}}this._onBundleError(`Bundle ${t.id} was removed`,t)}else if(this._assetsInBundles[t.id]){delete this._assetsInBundles[t.id];const e=this._getAssetFileUrls(t);for(let t=0,s=e.length;t<s;t++)delete this._urlsInBundles[e[t]]}}_onBundleLoaded(t){t.resource?requestAnimationFrame((()=>{if(this._fileRequests)for(const e in this._fileRequests){const s=this._urlsInBundles[e];if(!s||-1===s.indexOf(t))continue;const i=decodeURIComponent(e);let n=null;t.resource.hasBlobUrl(i)||(n=`Bundle ${t.id} does not contain URL ${e}`);const a=this._fileRequests[e];for(let e=0,r=a.length;e<r;e++)n?a[e](n):a[e](null,t.resource.getBlobUrl(i));delete this._fileRequests[e]}})):this._onBundleError(`Bundle ${t.id} failed to load`,t)}_onBundleError(t,e){for(const s in this._fileRequests){if(!this._findLoadedOrLoadingBundleForUrl(s)){const e=this._fileRequests[s];for(let s=0,i=e.length;s<i;s++)e[s](t);delete this._fileRequests[s]}}}_findLoadedOrLoadingBundleForUrl(t){const e=this._urlsInBundles[t];if(!e)return null;const s=e.length;for(let i=0;i<s;i++)if(e[i].loaded&&e[i].resource)return e[i];for(let i=0;i<s;i++)if(e[i].loading)return e[i];return null}listBundlesForAsset(t){return this._assetsInBundles[t.id]||null}list(){const t=[];for(const e in this._bundleAssets)t.push(this._bundleAssets[e]);return t}hasUrl(t){return!!this._urlsInBundles[t]}canLoadUrl(t){return!!this._findLoadedOrLoadingBundleForUrl(t)}loadUrl(t,e){const s=this._findLoadedOrLoadingBundleForUrl(t);if(s)if(s.loaded){const i=decodeURIComponent(t);if(!s.resource.hasBlobUrl(i))return void e(`Bundle ${s.id} does not contain URL ${t}`);e(null,s.resource.getBlobUrl(i))}else this._fileRequests.hasOwnProperty(t)?this._fileRequests[t].push(e):this._fileRequests[t]=[e];else e(`URL ${t} not found in any bundles`)}destroy(){this._assets.off("add",this._onAssetAdded,this),this._assets.off("remove",this._onAssetRemoved,this);for(const t in this._bundleAssets)this._unregisterBundleEventListeners(t);this._assets=null,this._bundleAssets=null,this._assetsInBundles=null,this._urlsInBundles=null,this._fileRequests=null}}const wo=["x","y","z","w"],Co=[void 0,void 0,Vec2,Vec3,Vec4];function To(t,e,s,i){switch(e.type){case"boolean":return!!s;case"number":if("number"==typeof s)return s;if("string"==typeof s){const t=parseInt(s,10);return isNaN(t)?null:t}return"boolean"==typeof s?0+s:null;case"json":{const i={};if(Array.isArray(e.schema)){s&&"object"==typeof s||(s={});for(let n=0;n<e.schema.length;n++){const a=e.schema[n];if(a.name)if(a.array){i[a.name]=[];const e=Array.isArray(s[a.name])?s[a.name]:[];for(let s=0;s<e.length;s++)i[a.name].push(To(t,a,e[s]))}else{const e=s.hasOwnProperty(a.name)?s[a.name]:a.default;i[a.name]=To(t,a,e)}}}return i}case"asset":return s instanceof Asset?s:"number"==typeof s?t.assets.get(s)||null:"string"==typeof s&&t.assets.get(parseInt(s,10))||null;case"entity":return s instanceof GraphNode?s:"string"==typeof s?t.getEntityFromIndex(s):null;case"rgb":case"rgba":if(s instanceof Color)return i instanceof Color?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length>=3&&s.length<=4){for(let t=0;t<s.length;t++)if("number"!=typeof s[t])return null;return i||(i=new Color),i.r=s[0],i.g=s[1],i.b=s[2],i.a=3===s.length?1:s[3],i}return"string"==typeof s&&/#([0-9abcdef]{2}){3,4}/i.test(s)?(i||(i=new Color),i.fromString(s),i):null;case"vec2":case"vec3":case"vec4":{const t=parseInt(e.type.slice(3),10),n=Co[t];if(s instanceof n)return i instanceof n?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length===t){for(let t=0;t<s.length;t++)if("number"!=typeof s[t])return null;i||(i=new n);for(let e=0;e<t;e++)i[wo[e]]=s[e];return i}return null}case"curve":if(s){let t;if(s instanceof Curve||s instanceof CurveSet)t=s.clone();else{t=new(s.keys[0]instanceof Array?CurveSet:Curve)(s.keys),t.type=s.type}return t}}return s}class ScriptAttributes{constructor(t){this.scriptType=t,this.index={}}add(t,e){this.index[t]||ScriptAttributes.reservedNames.has(t)||(this.index[t]=e,Object.defineProperty(this.scriptType.prototype,t,{get:function(){return this.__attributes[t]},set:function(s){const i="attr",n="attr:"+t,a=this.__attributes[t];let r=a;if(a&&"json"!==e.type&&a.clone&&(this._callbacks.attr||this._callbacks[n])&&(r=a.clone()),e.array){if(this.__attributes[t]=[],s)for(let o=0,l=s.length;o<l;o++)this.__attributes[t].push(To(this.app,e,s[o],a?a[o]:null))}else this.__attributes[t]=To(this.app,e,s,a);this.fire(i,t,this.__attributes[t],r),this.fire(n,this.__attributes[t],r)}}))}remove(t){return!!this.index[t]&&(delete this.index[t],delete this.scriptType.prototype[t],!0)}has(t){return!!this.index[t]}get(t){return this.index[t]||null}}ScriptAttributes.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","has","get","on","off","fire","once","hasEvent"]);class Component extends EventHandler{constructor(t,e){super(),this.system=t,this.entity=e,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",(function(t,e,s){this.fire("set_"+t,t,e,s)})),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(t,e){e.forEach((function(e){const s="object"==typeof e?e.name:e;Object.defineProperty(t,s,{get:function(){return this.data[s]},set:function(t){const e=this.data,i=e[s];e[s]=t,this.fire("set",s,i,t)},configurable:!0})})),t._accessorsBuilt=!0}buildAccessors(t){Component._buildAccessors(this,t)}onSetEnabled(t,e,s){e!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){const t=this.system.store[this.entity.getGuid()];return t?t.data:null}}class ScriptComponent extends Component{constructor(t,e){super(t,e),this._scripts=[],this._updateList=new SortedLoopArray({sortBy:"__executionOrder"}),this._postUpdateList=new SortedLoopArray({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set enabled(t){const e=this._enabled;this._enabled=t,this.fire("set","enabled",e,t)}get enabled(){return this._enabled}set scripts(t){this._scriptsData=t;for(const e in t){if(!t.hasOwnProperty(e))continue;const s=this._scriptsIndex[e];if(s){if("boolean"==typeof t[e].enabled&&(s.enabled=!!t[e].enabled),"object"==typeof t[e].attributes)for(const i in t[e].attributes)if(!ScriptAttributes.reservedNames.has(i)){if(!s.__attributes.hasOwnProperty(i)){const t=this.system.app.scripts.get(e);t&&t.attributes.add(i,{})}s[i]=t[e].attributes[i]}}else console.log(this.order)}}get scripts(){return this._scripts}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const t=this._beginLooping();for(let e=0,s=this.scripts.length;e<s;e++){const t=this.scripts[e];t._initialized&&!t._postInitialized&&t.enabled&&(t._postInitialized=!0,t.postInitialize&&this._scriptMethod(t,ScriptComponent.scriptMethods.postInitialize))}this._endLooping(t)}_beginLooping(){const t=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,t}_endLooping(t){this._isLoopingThroughScripts=t,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(t,e,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const t=this.enabled&&this.entity.enabled;if(t===this._oldState)return;this._oldState=t,this.fire(t?"enable":"disable"),this.fire("state",t),t?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const e=this._beginLooping();for(let s=0,i=this.scripts.length;s<i;s++){const t=this.scripts[s];t.enabled=t._enabled}this._endLooping(e)}_onBeforeRemove(){this.fire("remove");const t=this._beginLooping();for(let e=0;e<this.scripts.length;e++){const t=this.scripts[e];t&&this.destroy(t.__scriptType.__name)}this._endLooping(t)}_removeDestroyedScripts(){const t=this._destroyedScripts.length;if(t){for(let e=0;e<t;e++){const t=this._destroyedScripts[e];this._removeScriptInstance(t)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let t=0,e=this.scripts.length;t<e;t++)this.scripts[t].__initializeAttributes()}_scriptMethod(t,e,s){t[e](s)}_onInitialize(){const t=this._scripts,e=this._beginLooping();for(let s=0,i=t.length;s<i;s++){const e=t[s];!e._initialized&&e.enabled&&(e._initialized=!0,e.initialize&&this._scriptMethod(e,ScriptComponent.scriptMethods.initialize))}this._endLooping(e)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(t){const e=this._updateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,ScriptComponent.scriptMethods.update,t)}this._endLooping(s)}_onPostUpdate(t){const e=this._postUpdateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,ScriptComponent.scriptMethods.postUpdate,t)}this._endLooping(s)}_insertScriptInstance(t,e,s){-1===e?(this._scripts.push(t),t.__executionOrder=s,t.update&&this._updateList.append(t),t.postUpdate&&this._postUpdateList.append(t)):(this._scripts.splice(e,0,t),t.__executionOrder=e,this._resetExecutionOrder(e+1,s+1),t.update&&this._updateList.insert(t),t.postUpdate&&this._postUpdateList.insert(t))}_removeScriptInstance(t){const e=this._scripts.indexOf(t);return-1===e||(this._scripts.splice(e,1),t.update&&this._updateList.remove(t),t.postUpdate&&this._postUpdateList.remove(t)),e}_resetExecutionOrder(t,e){for(let s=t;s<e;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(t,e,s,i,n,a){if(t.array){const t=s.length;if(!t)return;const r=s.slice();for(let e=0;e<t;e++){const t=r[e]instanceof Entity?r[e].getGuid():r[e];a[t]&&(r[e]=i?a[t].getGuid():a[t])}n[e]=r}else{if(s instanceof Entity)s=s.getGuid();else if("string"!=typeof s)return;a[s]&&(n[e]=a[s])}}has(t){if("string"==typeof t)return!!this._scriptsIndex[t];if(!t)return!1;const e=t,s=e.__name,i=this._scriptsIndex[s];return(i&&i.instance)instanceof e}get(t){if("string"==typeof t){const e=this._scriptsIndex[t];return e?e.instance:null}if(!t)return null;const e=t,s=e.__name,i=this._scriptsIndex[s],n=i&&i.instance;return n instanceof e?n:null}create(t,e={}){const s=this;let i=t,n=t;if("string"==typeof i?i=this.system.app.scripts.get(i):i&&(n=i.__name),i){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){const t=new i({app:this.system.app,entity:this.entity,enabled:!e.hasOwnProperty("enabled")||e.enabled,attributes:e.attributes}),a=this._scripts.length;let r=-1;return"number"==typeof e.ind&&-1!==e.ind&&a>e.ind&&(r=e.ind),this._insertScriptInstance(t,r,a),this._scriptsIndex[n]={instance:t,onSwap:function(){s.swap(n)}},this[n]=t,e.preloading||t.__initializeAttributes(),this.fire("create",n,t),this.fire("create:"+n,t),this.system.app.scripts.on("swap:"+n,this._scriptsIndex[n].onSwap),e.preloading||(t.enabled&&!t._initialized&&(t._initialized=!0,t.initialize&&this._scriptMethod(t,ScriptComponent.scriptMethods.initialize)),t.enabled&&!t._postInitialized&&(t._postInitialized=!0,t.postInitialize&&this._scriptMethod(t,ScriptComponent.scriptMethods.postInitialize))),t}console.warn(`script '${n}' is already added to entity '${this.entity.name}'`)}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length},console.warn(`script '${n}' is not found, awaiting it to be added to registry`);return null}destroy(t){let e=t,s=t;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(e=s.__name);const i=this._scriptsIndex[e];if(delete this._scriptsIndex[e],!i)return!1;const n=i.instance;if(n&&!n._destroyed)if(n.enabled=!1,n._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(n);else{const t=this._removeScriptInstance(n);t>=0&&this._resetExecutionOrder(t,this._scripts.length)}return this.system.app.scripts.off("swap:"+e,i.onSwap),delete this[e],this.fire("destroy",e,n||null),this.fire("destroy:"+e,n||null),n&&n.fire("destroy"),!0}swap(t){let e=t,s=t;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(e=s.__name);const i=this._scriptsIndex[e];if(!i||!i.instance)return!1;const n=i.instance,a=this._scripts.indexOf(n),r=new s({app:this.system.app,entity:this.entity,enabled:n.enabled,attributes:n.__attributes});return!!r.swap&&(r.__initializeAttributes(),this._scripts[a]=r,this._scriptsIndex[e].instance=r,this[e]=r,r.__executionOrder=a,n.update&&this._updateList.remove(n),n.postUpdate&&this._postUpdateList.remove(n),r.update&&this._updateList.insert(r),r.postUpdate&&this._postUpdateList.insert(r),this._scriptMethod(r,ScriptComponent.scriptMethods.swap,n),this.fire("swap",e,r),this.fire("swap:"+e,r),!0)}resolveDuplicatedEntityReferenceProperties(t,e){const s=this.entity.script;for(const i in t._scriptsIndex){const n=this.system.app.scripts.get(i);if(!n)continue;const a=t._scriptsIndex[i];if(!a||!a.instance)continue;const r=s[i].__attributesRaw,o=s[i].__attributes;if(!r&&!o)continue;const l=!!r,h=a.instance.__attributes;for(const t in h){if(!h[t])continue;const s=n.attributes.get(t);if(s)if("entity"===s.type)this._resolveEntityScriptAttribute(s,t,h[t],l,r||o,e);else if("json"===s.type&&Array.isArray(s.schema)){const i=h[t],n=r?r[t]:o[t];for(let t=0;t<s.schema.length;t++){const a=s.schema[t];if("entity"===a.type)if(s.array)for(let t=0;t<i.length;t++)this._resolveEntityScriptAttribute(a,a.name,i[t][a.name],l,n[t],e);else this._resolveEntityScriptAttribute(a,a.name,i[a.name],l,n,e)}}}}}move(t,e){const s=this._scripts.length;if(e>=s||e<0)return!1;let i=t,n=t;"string"!=typeof n?n=t.__name:i=null;const a=this._scriptsIndex[n];if(!a||!a.instance)return!1;const r=a.instance;if(i&&!(r instanceof i))return!1;const o=this._scripts.indexOf(r);return-1!==o&&o!==e&&(this._scripts.splice(e,0,this._scripts.splice(o,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,r,e,o),this.fire("move:"+n,r,e,o),!0)}}ScriptComponent.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"};const Mo=new RegExp("^\\s*function(?:\\s|\\s*\\/\\*.*\\*\\/\\s*)+([^\\(\\s\\/]*)\\s*");class ScriptType extends EventHandler{constructor(t){super(),this.initialize=void 0,this.postInitialize=void 0,this.update=void 0,this.postUpdate=void 0,this.swap=void 0,this.initScriptType(t)}set enabled(t){this._enabled=!!t,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,ScriptComponent.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,ScriptComponent.scriptMethods.postInitialize)))}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScriptType(t){const e=this.constructor;this.app=t.app,this.entity=t.entity,this._enabled="boolean"!=typeof t.enabled||t.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__attributes={},this.__attributesRaw=t.attributes||{},this.__scriptType=e,this.__executionOrder=-1}static __getScriptName(t){if("function"!=typeof t)return;if("name"in Function.prototype)return t.name;if(t===Function||t===Function.prototype.constructor)return"Function";const e=(""+t).match(Mo);return e?e[1]:void 0}static get scriptName(){return this.__name}static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new ScriptAttributes(this)),this.__attributes}__initializeAttributes(t){if(t||this.__attributesRaw){for(const t in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(this.__scriptType.attributes.index[t].hasOwnProperty("default")?this[t]=this.__scriptType.attributes.index[t].default:this[t]=null);this.__attributesRaw=null}}static extend(t){for(const e in t)t.hasOwnProperty(e)&&(this.prototype[e]=t[e])}}ScriptType.__name=null;class ScriptRegistry extends EventHandler{constructor(t){super(),this.app=t,this._scripts={},this._list=[]}destroy(){this.app=null,this.off()}add(t){const e=t.__name;return this._scripts.hasOwnProperty(e)?(setTimeout((()=>{if(t.prototype.swap){const s=this._scripts[e],i=this._list.indexOf(s);this._list[i]=t,this._scripts[e]=t,this.fire("swap",e,t),this.fire("swap:"+e,t)}else console.warn(`script registry already has '${e}' script, define 'swap' method for new script type to enable code hot swapping`)})),!1):(this._scripts[e]=t,this._list.push(t),this.fire("add",e,t),this.fire("add:"+e,t),setTimeout((()=>{if(!this._scripts.hasOwnProperty(e))return;if(!this.app||!this.app.systems||!this.app.systems.script)return;const t=this.app.systems.script._components;let s;const i=[],n=[];for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const n=t.items[t.loopIndex];if(n._scriptsIndex[e]&&n._scriptsIndex[e].awaiting){n._scriptsData&&n._scriptsData[e]&&(s=n._scriptsData[e].attributes);const t=n.create(e,{preloading:!0,ind:n._scriptsIndex[e].ind,attributes:s});t&&i.push(t)}}for(let e=0;e<i.length;e++)i[e].__initializeAttributes();for(let e=0;e<i.length;e++)i[e].enabled&&(i[e]._initialized=!0,n.push(i[e]),i[e].initialize&&i[e].initialize());for(let e=0;e<n.length;e++)n[e].enabled&&!n[e]._postInitialized&&(n[e]._postInitialized=!0,n[e].postInitialize&&n[e].postInitialize())})),!0)}remove(t){let e=t,s=t;if("string"!=typeof s?s=e.__name:e=this.get(s),this.get(s)!==e)return!1;delete this._scripts[s];const i=this._list.indexOf(e);return this._list.splice(i,1),this.fire("remove",s,e),this.fire("remove:"+s,e),!0}get(t){return this._scripts[t]||null}has(t){if("string"==typeof t)return this._scripts.hasOwnProperty(t);if(!t)return!1;const e=t.__name;return this._scripts[e]===t}list(){return this._list}}class I18nParser{_validate(t){if(!t.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!t.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(1!==t.header.version)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!t.data)throw new Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(t.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(let e=0,s=t.data.length;e<s;e++){const s=t.data[e];if(!s.info)throw new Error(`pc.I18n#addData: missing "data[${e}].info" field`);if(!s.info.locale)throw new Error(`pc.I18n#addData: missing "data[${e}].info.locale" field`);if("string"!=typeof s.info.locale)throw new Error(`pc.I18n#addData: "data[${e}].info.locale" must be a string`);if(!s.messages)throw new Error(`pc.I18n#addData: missing "data[${e}].messages" field`)}}parse(t){return t.data}}class I18n extends EventHandler{constructor(t){super(),this.locale=qa,this._translations={},this._availableLangs={},this._app=t,this._assets=[],this._parser=new I18nParser}set assets(t){const e={};for(let i=0,n=t.length;i<n;i++){e[t[i]instanceof Asset?t[i].id:t[i]]=!0}let s=this._assets.length;for(;s--;){const t=this._assets[s];if(!e[t]){this._app.assets.off("add:"+t,this._onAssetAdd,this);const e=this._app.assets.get(t);e&&this._onAssetRemove(e),this._assets.splice(s,1)}}for(const i in e){const t=parseInt(i,10);if(-1!==this._assets.indexOf(t))continue;this._assets.push(t);const e=this._app.assets.get(t);e?this._onAssetAdd(e):this._app.assets.once("add:"+t,this._onAssetAdd,this)}}get assets(){return this._assets}set locale(t){if(this._locale===t)return;let e=Za(t);if("in"===e&&(e="id",t=function(t,e){const s=t.indexOf("-");return-1!==s?e+t.substring(s):e}(t,e),this._locale===t))return;const s=this._locale;this._locale=t,this._lang=e,this._pluralFn=tr(this._lang),this.fire("set:locale",t,s)}get locale(){return this._locale}static findAvailableLocale(t,e){return Qa(t,e)}findAvailableLocale(t){if(this._translations[t])return t;const e=Za(t);return this._findFallbackLocale(t,e)}getText(t,e){let s,i=t;e||(e=this._locale,s=this._lang);let n=this._translations[e];return n||(s||(s=Za(e)),e=this._findFallbackLocale(e,s),n=this._translations[e]),n&&n.hasOwnProperty(t)&&(i=n[t],Array.isArray(i)&&(i=i[0]),null==i&&(i=t)),i}getPluralText(t,e,s){let i,n,a=t;s?(i=Za(s),n=tr(i)):(s=this._locale,i=this._lang,n=this._pluralFn);let r=this._translations[s];if(r||(i=Za(s=this._findFallbackLocale(s,i)),n=tr(i),r=this._translations[s]),r&&r[t]&&n){const s=n(e);a=r[t][s],null==a&&(a=t)}return a}addData(t){let e;try{e=this._parser.parse(t)}catch(s){return void console.error(s)}for(let i=0,n=e.length;i<n;i++){const t=e[i],s=t.info.locale,n=t.messages;if(!this._translations[s]){this._translations[s]={};const t=Za(s);this._availableLangs[t]||(this._availableLangs[t]=s)}Object.assign(this._translations[s],n),this.fire("data:add",s,n)}}removeData(t){let e;try{e=this._parser.parse(t)}catch(s){return void console.error(s)}for(let i=0,n=e.length;i<n;i++){const t=e[i],s=t.info.locale,n=this._translations[s];if(!n)continue;const a=t.messages;for(const e in a)delete n[e];0===Object.keys(n).length&&(delete this._translations[s],delete this._availableLangs[Za(s)]),this.fire("data:remove",s,a)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(t,e){let s=$a[t];return s&&this._translations[s]?s:(s=$a[e],s&&this._translations[s]?s:(s=this._availableLangs[e],s&&this._translations[s]?s:qa))}_onAssetAdd(t){t.on("load",this._onAssetLoad,this),t.on("change",this._onAssetChange,this),t.on("remove",this._onAssetRemove,this),t.on("unload",this._onAssetUnload,this),t.resource&&this._onAssetLoad(t)}_onAssetLoad(t){this.addData(t.resource)}_onAssetChange(t){t.resource&&this.addData(t.resource)}_onAssetRemove(t){t.off("load",this._onAssetLoad,this),t.off("change",this._onAssetChange,this),t.off("remove",this._onAssetRemove,this),t.off("unload",this._onAssetUnload,this),t.resource&&this.removeData(t.resource),this._app.assets.once("add:"+t.id,this._onAssetAdd,this)}_onAssetUnload(t){t.resource&&this.removeData(t.resource)}}const Ao="KEEP_ASPECT",Po="AUTO";class VrDisplay extends EventHandler{constructor(t,e){super(),this._app=t,this._device=t.graphicsDevice,this.id=e.displayId,this._frameData=null,window.VRFrameData&&(this._frameData=new window.VRFrameData),this.display=e,this._camera=null,this.sitToStandInv=new Mat4,this.leftView=new Mat4,this.leftProj=new Mat4,this.leftViewInv=new Mat4,this.leftPos=new Vec3,this.rightView=new Mat4,this.rightProj=new Mat4,this.rightViewInv=new Mat4,this.rightPos=new Vec3,this.combinedPos=new Vec3,this.combinedView=new Mat4,this.combinedProj=new Mat4,this.combinedViewInv=new Mat4,this.combinedFov=0,this.combinedAspect=0,this.presenting=!1,this._presentChange=t=>{let e;if(e=t.display?t.display:t.detail&&t.detail.display?t.detail.display:t.detail&&t.detail.vrdisplay?t.detail.vrdisplay:this.display,e===this.display){if(this.presenting=this.display&&this.display.isPresenting,this.presenting){const t=this.display.getEyeParameters("left"),e=this.display.getEyeParameters("right"),s=2*Math.max(t.renderWidth,e.renderWidth),i=Math.max(t.renderHeight,e.renderHeight);this._app.graphicsDevice.setResolution(s,i),this._app._allowResize=!1}else this._app.setCanvasResolution(Po),this._app._allowResize=!0;this.fire("beforepresentchange",this),this.fire("presentchange",this)}},window.addEventListener("vrdisplaypresentchange",this._presentChange,!1)}destroy(){window.removeEventListener("vrdisplaypresentchange",this._presentChange),this._camera&&(this._camera.vrDisplay=null),this._camera=null}poll(){if(this.display){this.display.getFrameData(this._frameData),this.leftProj.data=this._frameData.leftProjectionMatrix,this.rightProj.data=this._frameData.rightProjectionMatrix;const t=this.display.stageParameters;t?(this.sitToStandInv.set(t.sittingToStandingTransform).invert(),this.combinedView.set(this._frameData.leftViewMatrix),this.leftView.mul2(this.combinedView,this.sitToStandInv),this.combinedView.set(this._frameData.rightViewMatrix),this.rightView.mul2(this.combinedView,this.sitToStandInv)):(this.leftView.set(this._frameData.leftViewMatrix),this.rightView.set(this._frameData.rightViewMatrix));let e=this.leftProj.data[3]+this.leftProj.data[0],s=this.leftProj.data[11]+this.leftProj.data[8],i=1/Math.sqrt(e*e+s*s);e*=i,s*=i;let n=-Math.atan2(s,e);e=this.rightProj.data[3]+this.rightProj.data[0],s=this.rightProj.data[11]+this.rightProj.data[8],i=1/Math.sqrt(e*e+s*s),e*=i,s*=i,n=Math.max(n,-Math.atan2(s,e)),n*=2,this.combinedFov=n;const a=this.rightProj.data[5]/this.rightProj.data[0];this.combinedAspect=a;const r=this.combinedView;r.copy(this.leftView),r.invert(),this.leftViewInv.copy(r);const o=this.combinedPos;o.x=this.leftPos.x=r.data[12],o.y=this.leftPos.y=r.data[13],o.z=this.leftPos.z=r.data[14],r.copy(this.rightView),r.invert(),this.rightViewInv.copy(r);const l=o.x-r.data[12],h=o.y-r.data[13],c=o.z-r.data[14],d=Math.sqrt(l*l+h*h+c*c);this.rightPos.x=r.data[12],this.rightPos.y=r.data[13],this.rightPos.z=r.data[14],o.x+=r.data[12],o.y+=r.data[13],o.z+=r.data[14],o.x*=.5,o.y*=.5,o.z*=.5;const u=.5*Math.PI,p=.5*n,m=Math.PI-(u+p),_=.5*d*Math.sin(m),f=r.data[8],g=r.data[9],y=r.data[10];r.data[12]=o.x+f*_,r.data[13]=o.y+g*_,r.data[14]=o.z+y*_,this.combinedViewInv.copy(r),r.invert(),this.combinedProj.setPerspective(n*O.RAD_TO_DEG,a,this.display.depthNear+_,this.display.depthFar+_,!0)}}requestPresent(t){this.display?this.presenting?t&&t(new Error("VrDisplay already presenting")):this.display.requestPresent([{source:this._device.canvas}]).then((function(){t&&t()}),(function(e){t&&t(e)})):t&&t(new Error("No VrDisplay to requestPresent"))}exitPresent(t){this.display||t&&t(new Error("No VrDisplay to exitPresent")),this.presenting?this.display.exitPresent().then((function(){t&&t()}),(function(){t&&t(new Error("exitPresent failed"))})):t&&t(new Error("VrDisplay not presenting"))}requestAnimationFrame(t){this.display&&this.display.requestAnimationFrame(t)}submitFrame(){this.display&&this.display.submitFrame()}reset(){this.display&&this.display.resetPose()}setClipPlanes(t,e){this.display&&(this.display.depthNear=t,this.display.depthFar=e)}getFrameData(){if(this.display)return this._frameData}get capabilities(){return this.display?this.display.capabilities:{}}}class VrManager extends EventHandler{constructor(t){super(),this.isSupported=VrManager.isSupported,this._index={},this.displays=[],this.display=null,this._app=t,this._onDisplayConnect=this._onDisplayConnect.bind(this),this._onDisplayDisconnect=this._onDisplayDisconnect.bind(this),this._attach(),this._getDisplays(((t,e)=>{if(t)this.fire("error",t);else{for(let t=0;t<e.length;t++)this._addDisplay(e[t]);this.fire("ready",this.displays)}}))}_attach(){window.addEventListener("vrdisplayconnect",this._onDisplayConnect),window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)}_detach(){window.removeEventListener("vrdisplayconnect",this._onDisplayConnect),window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)}destroy(){this._detach()}poll(){const t=this.displays.length;if(t)for(let e=0;e<t;e++)this.displays[e]._camera&&this.displays[e].poll()}_getDisplays(t){navigator.getVRDisplays?navigator.getVRDisplays().then((function(e){t&&t(null,e)})):t&&t(new Error("WebVR not supported"))}_addDisplay(t){if(this._index[t.displayId])return;const e=new VrDisplay(this._app,t);this._index[e.id]=e,this.displays.push(e),this.display||(this.display=e),this.fire("displayconnect",e)}_onDisplayConnect(t){t.detail&&t.detail.display?this._addDisplay(t.detail.display):this._addDisplay(t.display)}_onDisplayDisconnect(t){let e;e=t.detail&&t.detail.display?t.detail.display.displayId:t.display.displayId;const s=this._index[e];if(!s)return;s.destroy(),delete this._index[s.id];const i=this.displays.indexOf(s);this.displays.splice(i,1),this.display===s&&(this.displays.length?this.display=this.displays[0]:this.display=null),this.fire("displaydisconnect",s)}}VrManager.isSupported="undefined"!=typeof navigator&&!!navigator.getVRDisplays;const Eo="immersive-vr",Lo="immersive-ar",Ro="cpu-optimized",Io=[],Do=[];class XrHitTestSource extends EventHandler{constructor(t,e,s){super(),this.manager=t,this._xrHitTestSource=e,this._transient=s}remove(){if(!this._xrHitTestSource)return;const t=this.manager.hitTest.sources,e=t.indexOf(this);-1!==e&&t.splice(e,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(t){if(this._transient){const e=t.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let t=0;t<e.length;t++){const s=e[t];let i;s.inputSource&&(i=this.manager.input._getByInputSource(s.inputSource)),this.updateHitResults(s.results,i)}}else this.updateHitResults(t.getHitTestResults(this._xrHitTestSource))}updateHitResults(t,e){for(let s=0;s<t.length;s++){const i=t[s].getPose(this.manager._referenceSpace);let n=Io.pop();n||(n=new Vec3),n.copy(i.transform.position);let a=Do.pop();a||(a=new Quat),a.copy(i.transform.orientation),this.fire("result",n,a,e),this.manager.hitTest.fire("result",this,n,a,e),Io.push(n),Do.push(a)}}}class XrHitTest extends EventHandler{constructor(t){super(),this.manager=t,this._supported=S.browser&&!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource),this._session=null,this.sources=[],this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){this.manager.type===Lo&&(this._session=this.manager.session)}_onSessionEnd(){if(this._session){this._session=null;for(let t=0;t<this.sources.length;t++)this.sources[t].onStop();this.sources=[]}}isAvailable(t,e){let s;return this._supported||(s=new Error("XR HitTest is not supported")),this._session||(s=new Error("XR Session is not started (1)")),this.manager.type!==Lo&&(s=new Error("XR HitTest is available only for AR")),!s||(t&&t(s),e&&e.fire("error",s),!1)}start(t){if(t=t||{},!this.isAvailable(t.callback,this))return;let e;t.profile||t.spaceType||(t.spaceType="viewer");const s=t.offsetRay;s&&(e=new XRRay(new DOMPoint(s.origin.x,s.origin.y,s.origin.z),new DOMPoint(s.direction.x,s.direction.y,s.direction.z)));const i=t.callback;t.spaceType?this._session.requestReferenceSpace(t.spaceType).then((s=>{if(!this._session){const t=new Error("XR Session is not started (2)");return i&&i(t),void this.fire("error",t)}this._session.requestHitTestSource({space:s,entityTypes:t.entityTypes||void 0,offsetRay:e}).then((t=>{this._onHitTestSource(t,!1,i)})).catch((t=>{i&&i(t),this.fire("error",t)}))})).catch((t=>{i&&i(t),this.fire("error",t)})):this._session.requestHitTestSourceForTransientInput({profile:t.profile,entityTypes:t.entityTypes||void 0,offsetRay:e}).then((t=>{this._onHitTestSource(t,!0,i)})).catch((t=>{i&&i(t),this.fire("error",t)}))}_onHitTestSource(t,e,s){if(!this._session){t.cancel();const e=new Error("XR Session is not started (3)");return s&&s(e),void this.fire("error",e)}const i=new XrHitTestSource(this.manager,t,e);this.sources.push(i),s&&s(null,i),this.fire("add",i)}update(t){for(let e=0;e<this.sources.length;e++)this.sources[e].update(t)}get supported(){return this._supported}}class XrFinger{constructor(t,e){this._index=t,this._hand=e,this._hand._fingers.push(this),this._joints=[],this._tip=null}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}const ko=S.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],Fo={};for(let Yu=0;Yu<ko.length;Yu++)Fo[ko[Yu]]=!0;class XrJoint{constructor(t,e,s,i=null){this._index=t,this._id=e,this._hand=s,this._finger=i,this._wrist="wrist"===e,this._tip=this._finger&&!!Fo[e],this._radius=null,this._localTransform=new Mat4,this._worldTransform=new Mat4,this._localPosition=new Vec3,this._localRotation=new Quat,this._position=new Vec3,this._rotation=new Quat,this._dirtyLocal=!0}update(t){this._dirtyLocal=!0,this._radius=t.radius,this._localPosition.copy(t.transform.position),this._localRotation.copy(t.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,Vec3.ONE));const t=this._hand._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}let Oo=[];const Vo=new Vec3,Bo=new Vec3,zo=new Vec3;S.browser&&window.XRHand&&(Oo=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class XrHand extends EventHandler{constructor(t){super();const e=t._xrInputSource.hand;if(this._manager=t._manager,this._inputSource=t,this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null,e.get("wrist")){const t=new XrJoint(0,"wrist",this,null);this._wrist=t,this._joints.push(t),this._jointsById.wrist=t}for(let s=0;s<Oo.length;s++){const t=new XrFinger(s,this);for(let i=0;i<Oo[s].length;i++){const n=Oo[s][i];if(!e.get(n))continue;const a=new XrJoint(i,n,this,t);this._joints.push(a),this._jointsById[n]=a,a.tip&&(this._tips.push(a),t._tip=a),t._joints.push(a)}}}update(t){const e=this._inputSource._xrInputSource;for(let l=0;l<this._joints.length;l++){const s=this._joints[l],i=e.hand.get(s._id);if(i){let e;if("hidden"!==t.session.visibilityState&&(e=t.getJointPose(i,this._manager._referenceSpace)),e)s.update(e),s.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(s.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}const s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],n=this._jointsById["index-finger-phalanx-proximal"],a=this._jointsById["index-finger-tip"],r=this._jointsById["ring-finger-phalanx-proximal"],o=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&n&&a&&r&&o){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(i._localPosition,a._localPosition,.5);let t=s,e=o;if("left"===this._inputSource.handedness){const s=t;t=e,e=s}Vo.sub2(t._localPosition,this._wrist._localPosition),Bo.sub2(e._localPosition,this._wrist._localPosition),zo.cross(Vo,Bo).normalize(),Vo.lerp(n._localPosition,r._localPosition,.5),Vo.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(zo,Vo,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(t){const e=this._fingers[t];return Vo.sub2(e.joints[0]._localPosition,e.joints[1]._localPosition).normalize(),Bo.sub2(e.joints[2]._localPosition,e.joints[3]._localPosition).normalize(),Vo.dot(Bo)<-.8}getJointById(t){return this._jointsById[t]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}}const Uo=new Quat;let No=0;class XrInputSource extends EventHandler{constructor(t,e){super(),this._id=++No,this._manager=t,this._xrInputSource=e,this._ray=new Ray,this._rayLocal=new Ray,this._grip=!1,this._hand=null,e.hand&&(this._hand=new XrHand(this)),this._localTransform=null,this._worldTransform=null,this._position=new Vec3,this._rotation=new Quat,this._localPosition=null,this._localRotation=null,this._dirtyLocal=!0,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[]}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(t){this._elementInput!==t&&(this._elementInput=t,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(t){if(this._hand)this._hand.update(t);else{if(this._xrInputSource.gripSpace){const e=t.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace);e&&(this._grip||(this._grip=!0,this._localTransform=new Mat4,this._worldTransform=new Mat4,this._localPosition=new Vec3,this._localRotation=new Quat),this._dirtyLocal=!0,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation))}const e=t.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);e&&(this._dirtyRay=!0,this._rayLocal.origin.copy(e.transform.position),this._rayLocal.direction.set(0,0,-1),Uo.copy(e.transform.orientation),Uo.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,Vec3.ONE));const t=this._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){const t=this._dirtyRay;this._dirtyRay=!1;if(this._manager.camera.parent){const t=this._manager.camera.parent.getWorldTransform();t.getTranslation(this._position),this._rotation.setFromMat4(t),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else t&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(t={}){t.profile=this._xrInputSource.profiles[0];const e=t.callback;t.callback=(t,s)=>{s&&this.onHitTestSourceAdd(s),e&&e(t,s)},this._manager.hitTest.start(t)}onHitTestSourceAdd(t){this._hitTestSources.push(t),this.fire("hittest:add",t),t.on("result",(function(e,s,i){i===this&&this.fire("hittest:result",t,e,s)}),this),t.once("remove",(function(){this.onHitTestSourceRemove(t),this.fire("hittest:remove",t)}),this)}onHitTestSourceRemove(t){const e=this._hitTestSources.indexOf(t);-1!==e&&this._hitTestSources.splice(e,1)}}class XrInput extends EventHandler{constructor(t){super(),this.manager=t,this._session=null,this._inputSources=[],this._onInputSourcesChangeEvt=t=>{this._onInputSourcesChange(t)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){this._session=this.manager.session,this._session.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),this._session.addEventListener("select",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e.fire("select",t),this.fire("select",e,t)})),this._session.addEventListener("selectstart",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._selecting=!0,e.fire("selectstart",t),this.fire("selectstart",e,t)})),this._session.addEventListener("selectend",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._selecting=!1,e.fire("selectend",t),this.fire("selectend",e,t)})),this._session.addEventListener("squeeze",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e.fire("squeeze",t),this.fire("squeeze",e,t)})),this._session.addEventListener("squeezestart",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._squeezing=!0,e.fire("squeezestart",t),this.fire("squeezestart",e,t)})),this._session.addEventListener("squeezeend",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._squeezing=!1,e.fire("squeezeend",t),this.fire("squeezeend",e,t)}));const t=this._session.inputSources;for(let e=0;e<t.length;e++)this._addInputSource(t[e])}_onSessionEnd(){let t=this._inputSources.length;for(;t--;){const e=this._inputSources[t];this._inputSources.splice(t,1),e.fire("remove"),this.fire("remove",e)}this._session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt),this._session=null}_onInputSourcesChange(t){for(let e=0;e<t.removed.length;e++)this._removeInputSource(t.removed[e]);for(let e=0;e<t.added.length;e++)this._addInputSource(t.added[e])}_getByInputSource(t){for(let e=0;e<this._inputSources.length;e++)if(this._inputSources[e].inputSource===t)return this._inputSources[e];return null}_addInputSource(t){if(this._getByInputSource(t))return;const e=new XrInputSource(this.manager,t);this._inputSources.push(e),this.fire("add",e)}_removeInputSource(t){for(let e=0;e<this._inputSources.length;e++){if(this._inputSources[e].inputSource!==t)continue;const s=this._inputSources[e];this._inputSources.splice(e,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();return s.fire("remove"),void this.fire("remove",s)}}update(t){for(let e=0;e<this._inputSources.length;e++)this._inputSources[e].update(t)}get inputSources(){return this._inputSources}}const Ho=new Vec3,Wo=new Vec3,Go=new Mat4,jo=new Mat4;class XrLightEstimation extends EventHandler{constructor(t){super(),this._manager=t,this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new Quat,this._color=new Color,this._sphericalHarmonics=new Float32Array(27),this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){!!this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let t;this._manager.session||(t=new Error("XR session is not running")),t||this._manager.type===Lo||(t=new Error("XR session type is not AR")),t||this._supported||(t=new Error("light-estimation is not supported")),(!t&&this._lightProbe||this._lightProbeRequested)&&(t=new Error("light estimation is already requested")),t?this.fire("error",t):(this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then((t=>{const e=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?e&&(this._lightProbe=t):this.fire("error",new Error("XR session is not active"))})).catch((t=>{this._lightProbeRequested=!1,this.fire("error",t)})))}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(t){if(!this._lightProbe)return;const e=t.getLightEstimate(this._lightProbe);if(!e)return;this._available||(this._available=!0,this.fire("available"));const s=e.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),Ho.copy(s).mulScalar(1/this._intensity),this._color.set(Ho.x,Ho.y,Ho.z),Ho.set(0,0,0),Wo.copy(e.primaryLightDirection),Go.setLookAt(Wo,Ho,Vec3.UP),jo.setFromAxisAngle(Vec3.RIGHT,90),Go.mul(jo),this._rotation.setFromMat4(Go),this._sphericalHarmonics.set(e.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}}class XrTrackedImage extends EventHandler{constructor(t,e){super(),this._image=t,this._bitmap=null,this._width=e,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new Vec3,this._rotation=new Quat}get image(){return this._image}set width(t){this._width=t}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then((t=>(this._bitmap=t,{image:this._bitmap,widthInMeters:this._width})))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}}class XrImageTracking extends EventHandler{constructor(t){super(),this._manager=t,this._supported=S.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(t,e){if(!this._supported||this._manager.active)return null;const s=new XrTrackedImage(t,e);return this._images.push(s),s}remove(t){if(this._manager.active)return;const e=this._images.indexOf(t);-1!==e&&(t.destroy(),this._images.splice(e,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then((t=>{this._available=!0;for(let e=0;e<t.length;e++)this._images[e]._trackable="trackable"===t[e]})).catch((t=>{this._available=!1,this.fire("error",t)}))}_onSessionEnd(){this._available=!1;for(let t=0;t<this._images.length;t++)this._images[t]._pose=null,this._images[t]._measuredWidth=0,this._images[t]._tracking&&(this._images[t]._tracking=!1,this._images[t].fire("untracked"))}prepareImages(t){this._images.length?Promise.all(this._images.map((function(t){return t.prepare()}))).then((function(e){t(null,e)})).catch((function(e){t(e,null)})):t(null,null)}update(t){if(!this._available)return;const e=t.getImageTrackingResults(),s={};for(let i=0;i<e.length;i++){s[e[i].index]=e[i];const n=this._images[e[i].index];n._emulated="emulated"===e[i].trackingState,n._measuredWidth=e[i].measuredWidthInMeters,n._dirtyTransform=!0,n._pose=t.getPose(e[i].imageSpace,this._manager._referenceSpace)}for(let i=0;i<this._images.length;i++)this._images[i]._tracking&&!s[i]?(this._images[i]._tracking=!1,this._images[i].fire("untracked")):!this._images[i]._tracking&&s[i]&&(this._images[i]._tracking=!0,this._images[i].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}}class XrDomOverlay{constructor(t){this._manager=t,this._supported=S.browser&&!!window.XRDOMOverlayState,this._root=null}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}get state(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}set root(t){this._supported&&!this._manager.active&&(this._root=t)}get root(){return this._root}}class XrDepthSensing extends EventHandler{constructor(t){super(),this._manager=t,this._available=!1,this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._matrixDirty=!1,this._matrix=new Mat4,this._emptyBuffer=new Uint8Array(32),this._depthBuffer=null,this._texture=new Texture(this._manager.app.graphicsDevice,{format:2,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1}),this.supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){const t=this._manager.session;try{this._usage=t.depthUsage,this._dataFormat=t.depthDataFormat}catch(e){this._usage=null,this._dataFormat=null,this._available=!1,this.fire("error",e)}}_onSessionEnd(){this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._available&&(this._available=!1,this.fire("unavailable")),this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload()}_updateTexture(){const t=this._depthInfoCpu||this._depthInfoGpu;if(t){let e=!1;if(t.width===this._texture.width&&t.height===this._texture.height||(this._texture._width=t.width,this._texture._height=t.height,this._matrixDirty=!0,e=!0),this._depthInfoCpu){const t=this._depthInfoCpu.data;this._depthBuffer=new Uint8Array(t),this._texture._levels[0]=this._depthBuffer,this._texture.upload()}else this._depthInfoGpu&&(this._texture._levels[0]=this._depthInfoGpu.texture,this._texture.upload());e&&this.fire("resize",t.width,t.height)}else this._depthBuffer&&(this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload())}update(t,e){if(!this._usage)return;let s=null,i=null;if(this._usage===Ro&&e?s=t.getDepthInformation(e):"gpu-optimized"===this._usage&&e&&(i=t.getDepthInformation(e)),(this._depthInfoCpu&&!s||!this._depthInfoCpu&&s||this.depthInfoGpu&&!i||!this._depthInfoGpu&&i)&&(this._matrixDirty=!0),this._depthInfoCpu=s,this._depthInfoGpu=i,this._updateTexture(),this._matrixDirty){this._matrixDirty=!1;const t=this._depthInfoCpu||this._depthInfoGpu;t?this._matrix.data.set(t.normDepthBufferFromNormView.matrix):this._matrix.setIdentity()}!this._depthInfoCpu&&!this._depthInfoGpu||this._available?this._depthInfoCpu||this._depthInfoGpu||!this._available||(this._available=!1,this.fire("unavailable")):(this._available=!0,this.fire("available"))}getDepth(t,e){return this._depthInfoCpu?this._depthInfoCpu.getDepthInMeters(t,e):null}get supported(){return S.browser&&!!window.XRDepthInformation}get available(){return this._available}get usage(){return this._usage}get dataFormat(){return this._dataFormat}get width(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.width||0}get height(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.height||0}get texture(){return this._texture}get uvMatrix(){return this._matrix}get rawValueToMeters(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.rawValueToMeters||0}}let Xo=0;class XrPlane extends EventHandler{constructor(t,e){super(),this._id=++Xo,this._planeDetection=t,this._manager=this._planeDetection._manager,this._xrPlane=e,this._lastChangedTime=this._xrPlane.lastChangedTime,this._orientation=this._xrPlane.orientation,this._position=new Vec3,this._rotation=new Quat}destroy(){this.fire("remove")}update(t){const e=t.getPose(this._xrPlane.planeSpace,this._manager._referenceSpace);e&&(this._position.copy(e.transform.position),this._rotation.copy(e.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this.id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}}class XrPlaneDetection extends EventHandler{constructor(t){super(),this._manager=t,this._supported=S.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=null,this._supported&&this._manager.on("end",this._onSessionEnd,this)}_onSessionEnd(){if(this._planes)for(let t=0;t<this._planes.length;t++)this._planes[t].destroy();this._planesIndex.clear(),this._planes=null,this._available&&(this._available=!1,this.fire("unavailable"))}update(t){let e;if(this._available)e=t.detectedPlanes;else try{e=t.detectedPlanes,this._planes=[],this._available=!0,this.fire("available")}catch(s){return}for(const[i,n]of this._planesIndex)e.has(i)||(this._planesIndex.delete(i),this._planes.splice(this._planes.indexOf(n),1),n.destroy(),this.fire("remove",n));for(const i of e){let e=this._planesIndex.get(i);e?e.update(t):(e=new XrPlane(this,i),this._planesIndex.set(i,e),this._planes.push(e),e.update(t),this.fire("add",e))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}}class XrManager extends EventHandler{constructor(t){super(),this.app=t,this._supported=S.browser&&!!navigator.xr,this._available={},this._available.inline=!1,this._available[Eo]=!1,this._available[Lo]=!1,this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this._referenceSpace=null,this.depthSensing=new XrDepthSensing(this),this.domOverlay=new XrDomOverlay(this),this.hitTest=new XrHitTest(this),this.imageTracking=new XrImageTracking(this),this.planeDetection=new XrPlaneDetection(this),this.input=new XrInput(this),this.lightEstimation=new XrLightEstimation(this),this._camera=null,this.views=[],this.viewsPool=[],this._localPosition=new Vec3,this._localRotation=new Quat,this._depthNear=.1,this._depthFar=1e3,this._width=0,this._height=0,this._supported&&(navigator.xr.addEventListener("devicechange",(()=>{this._deviceAvailabilityCheck()})),this._deviceAvailabilityCheck())}start(t,e,s,i){let n=i;if("object"==typeof i&&(n=i.callback),!this._available[e])return void(n&&n(new Error("XR is not available")));if(this._session)return void(n&&n(new Error("XR session is already started")));this._camera=t,this._camera.camera.xr=this,this._type=e,this._spaceType=s,this._setClipPlanes(t.nearClip,t.farClip);const a={requiredFeatures:[s],optionalFeatures:[]};if(e===Lo){if(a.optionalFeatures.push("light-estimation"),a.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&a.optionalFeatures.push("image-tracking"),i.planeDetection&&a.optionalFeatures.push("plane-detection")),this.domOverlay.supported&&this.domOverlay.root&&(a.optionalFeatures.push("dom-overlay"),a.domOverlay={root:this.domOverlay.root}),i&&i.depthSensing&&this.depthSensing.supported){a.optionalFeatures.push("depth-sensing");const t=[Ro],e=["luminance-alpha"];if(i.depthSensing.usagePreference){const e=t.indexOf(i.depthSensing.usagePreference);-1!==e&&t.splice(e,1),t.unshift(i.depthSensing.usagePreference)}if(i.depthSensing.dataFormatPreference){const t=e.indexOf(i.depthSensing.dataFormatPreference);-1!==t&&e.splice(t,1),e.unshift(i.depthSensing.dataFormatPreference)}a.depthSensing={usagePreference:t,dataFormatPreference:e}}}else e===Eo&&a.optionalFeatures.push("hand-tracking");i&&i.optionalFeatures&&(a.optionalFeatures=a.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages(((t,i)=>{if(t)return n&&n(t),void this.fire("error",t);null!==i&&(a.trackedImages=i),this._onStartOptionsReady(e,s,a,n)})):this._onStartOptionsReady(e,s,a,n)}_onStartOptionsReady(t,e,s,i){navigator.xr.requestSession(t,s).then((t=>{this._onSessionStart(t,e,i)})).catch((t=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,i&&i(t),this.fire("error",t)}))}end(t){this._session?(t&&this.once("end",t),this._session.end()):t&&t(new Error("XR Session is not initialized"))}isAvailable(t){return this._available[t]}_deviceAvailabilityCheck(){for(const t in this._available)this._sessionSupportCheck(t)}_sessionSupportCheck(t){navigator.xr.isSessionSupported(t).then((e=>{this._available[t]!==e&&(this._available[t]=e,this.fire("available",t,e),this.fire("available:"+t,e))})).catch((t=>{this.fire("error",t)}))}_onSessionStart(t,e,s){let i=!1;this._session=t;const n=()=>{this.fire("visibility:change",t.visibilityState)},a=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},r=()=>{this._session=null,this._referenceSpace=null,this.views=[],this._width=0,this._height=0,this._type=null,this._spaceType=null,this._camera&&(this._camera.off("set_nearClip",a),this._camera.off("set_farClip",a),this._camera.camera.xr=null,this._camera=null),t.removeEventListener("end",r),t.removeEventListener("visibilitychange",n),i||this.fire("end"),this.app.tick()};t.addEventListener("end",r),t.addEventListener("visibilitychange",n),this._camera.on("set_nearClip",a),this._camera.on("set_farClip",a),this._baseLayer=new XRWebGLLayer(t,this.app.graphicsDevice.gl),t.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}),t.requestReferenceSpace(e).then((t=>{this._referenceSpace=t,this.app.tick(),s&&s(null),this.fire("start")})).catch((e=>{i=!0,t.end(),s&&s(e),this.fire("error",e)}))}_setClipPlanes(t,e){this._depthNear===t&&this._depthFar===e||(this._depthNear=t,this._depthFar=e,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}update(t){if(!this._session)return;const e=t.session.renderState.baseLayer.framebufferWidth,s=t.session.renderState.baseLayer.framebufferHeight;this._width===e&&this._height===s||(this._width=e,this._height=s,this.app.graphicsDevice.setResolution(e,s));const i=t.getViewerPose(this._referenceSpace),n=i?i.views.length:0;if(n>this.views.length)for(let a=0;a<=n-this.views.length;a++){let t=this.viewsPool.pop();t||(t={viewport:new Vec4,projMat:new Mat4,viewMat:new Mat4,viewOffMat:new Mat4,viewInvMat:new Mat4,viewInvOffMat:new Mat4,projViewOffMat:new Mat4,viewMat3:new Mat3,position:new Float32Array(3),rotation:new Quat}),this.views.push(t)}else if(n<=this.views.length)for(let a=0;a<this.views.length-n;a++)this.viewsPool.push(this.views.pop());if(i){const e=i.transform.position,s=i.transform.orientation;this._localPosition.set(e.x,e.y,e.z),this._localRotation.set(s.x,s.y,s.z,s.w);const n=t.session.renderState.baseLayer;for(let t=0;t<i.views.length;t++){const e=i.views[t],s=this.views[t],a=n.getViewport(e);s.viewport.x=a.x,s.viewport.y=a.y,s.viewport.z=a.width,s.viewport.w=a.height,s.projMat.set(e.projectionMatrix),s.viewMat.set(e.transform.inverse.matrix),s.viewInvMat.set(e.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(t),this._type===Lo&&(this.hitTest.supported&&this.hitTest.update(t),this.lightEstimation.supported&&this.lightEstimation.update(t),this.depthSensing.supported&&this.depthSensing.update(t,i&&i.views[0]),this.imageTracking.supported&&this.imageTracking.update(t),this.planeDetection.supported&&this.planeDetection.update(t)),this.fire("update",t)}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}}class ComponentSystem extends EventHandler{constructor(t){super(),this.app=t,this.store={},this.schema=[]}addComponent(t,e={}){const s=new this.ComponentType(this,t),i=new this.DataType;return this.store[t.getGuid()]={entity:t,data:i},t[this.id]=s,t.c[this.id]=s,this.initializeComponentData(s,e,[]),this.fire("add",t,s),s}removeComponent(t){const e=this.store[t.getGuid()],s=t.c[this.id];this.fire("beforeremove",t,s),delete this.store[t.getGuid()],t[this.id]=void 0,delete t.c[this.id],this.fire("remove",t,e.data)}cloneComponent(t,e){const s=this.store[t.getGuid()];return this.addComponent(e,s.data)}initializeComponentData(t,e={},s){for(let i=0,n=s.length;i<n;i++){const n=s[i];let a,r;"object"==typeof n?(a=n.name,r=n.type):(a=n,r=void 0);let o=e[a];void 0!==o?(void 0!==r&&(o=qo(o,r)),t[a]=o):t[a]=t.data[a]}t.enabled&&t.entity.enabled&&t.onEnable()}getPropertiesOfType(t){const e=[];return(this.schema||[]).forEach((function(s){s&&"object"==typeof s&&s.type===t&&e.push(s)})),e}destroy(){this.off()}}function qo(t,e){if(!t)return t;switch(e){case"rgb":return t instanceof Color?t.clone():new Color(t[0],t[1],t[2]);case"rgba":return t instanceof Color?t.clone():new Color(t[0],t[1],t[2],t[3]);case"vec2":return t instanceof Vec2?t.clone():new Vec2(t[0],t[1]);case"vec3":return t instanceof Vec3?t.clone():new Vec3(t[0],t[1],t[2]);case"vec4":return t instanceof Vec4?t.clone():new Vec4(t[0],t[1],t[2],t[3]);case"boolean":case"number":case"string":case"entity":return t;default:throw new Error("Could not convert unhandled type: "+e)}}class AnimCache{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(t,e){if(t<this._left||t>=this._right){const s=e.length;if(s)if(t<e[0])this._left=-1/0,this._right=e[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(t>=e[s-1])this._left=e[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{const s=this._findKey(t,e);this._left=e[s],this._right=e[s+1],this._len=this._right-this._left;const i=1/this._len;this._recip=isFinite(i)?i:0,this._p0=s,this._p1=s+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=0===this._recip?0:(t-this._left)*this._recip,this._hermite.valid=!1}_findKey(t,e){let s=0;for(;t>=e[s+1];)s++;return s}eval(t,e,s){const i=s._data,n=s._components,a=this._p0*n;if(0===e)for(let r=0;r<n;++r)t[r]=i[a+r];else{const s=this._t,r=this._p1*n;switch(e){case 1:for(let e=0;e<n;++e)t[e]=O.lerp(i[a+e],i[r+e],s);break;case 2:{const e=this._hermite;if(!e.valid){const t=s*s,i=s+s,n=1-s,a=n*n;e.valid=!0,e.p0=(1+i)*a,e.m0=s*a,e.p1=t*(3-i),e.m1=t*(s-1)}const a=(3*this._p0+1)*n,r=(3*this._p0+2)*n,o=(3*this._p1+1)*n,l=(3*this._p1+0)*n;for(let s=0;s<n;++s)t[s]=e.p0*i[a+s]+e.m0*i[r+s]*this._len+e.p1*i[o+s]+e.m1*i[l+s]*this._len;break}}}}}class AnimSnapshot{constructor(t){this._name=t.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(let i=0;i<t._inputs.length;++i)this._cache[i]=new AnimCache;const e=t._curves,s=t._outputs;for(let i=0;i<e.length;++i){const t=s[e[i]._output],n=[];for(let e=0;e<t._components;++e)n[e]=0;this._results[i]=n}}}class AnimClip{constructor(t,e,s,i,n,a){for(this._name=t.name,this._track=t,this._snapshot=new AnimSnapshot(t),this._playing=i,this._time=e,this._speed=s,this._loop=n,this._blendWeight=1,this._blendOrder=0,this._eventHandler=a,this._eventCursor=0;this._track.events[this._eventCursor]&&this._track.events[this._eventCursor].time<this.time;)this._eventCursor++}set name(t){this._name=t}get name(){return this._name}get track(){return this._track}get snapshot(){return this._snapshot}set time(t){this._time=t}get time(){return this._time}set speed(t){this._speed=t}get speed(){return this._speed}set loop(t){this._loop=t}get loop(){return this._loop}set blendWeight(t){this._blendWeight=t}get blendWeight(){return this._blendWeight}set blendOrder(t){this._blendOrder=t}get blendOrder(){return this._blendOrder}set eventCursor(t){this._eventCursor=t}get eventCursor(){return this._eventCursor}activeEventsForFrame(t,e){let s;for(0===t&&(this.eventCursor=0),e>this.track.duration&&(s=e-this.track.duration,e=this.track.duration);this.track.events[this.eventCursor]&&this.track.events[this.eventCursor].time>=t&&(e===this.track.duration?this.track.events[this.eventCursor].time<=e:this.track.events[this.eventCursor].time<e);){const t=this.track.events[this.eventCursor];this._eventHandler.fire(t.name,Wr({track:this.track},t)),this.eventCursor++}Number.isFinite(s)&&this.activeEventsForFrame(0,s)}_update(t){if(this._playing){let e=this._time;const s=this._track.duration,i=this._speed,n=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(e,e+i*t),e+=i*t,i>=0?e>s&&(n?e=e%s||0:(e=this._track.duration,this.pause())):e<0&&(n?e=s+(e%s||0):(e=0,this.pause())),this._time=e}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}}const $o="NONE",Yo="INTEGER",Ko="FLOAT",Zo="BOOLEAN",Qo="TRIGGER",Jo="START",tl="END",el="ANY",sl=[Jo,tl,el],il="OVERWRITE";class AnimTargetValue{constructor(t,e){this._component=t,this.mask=new Int8Array(t.layers.length),this.weights=new Float32Array(t.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=e,this.dirty=!0,this.value=[0,0,0,1]}getWeight(t){return this.dirty&&this.updateWeights(),0!==this.totalWeight&&this.mask[t]?this.weights[t]/this.totalWeight:0}setMask(t,e){this.mask[t]=e,this._component.layers[t].blendType===il&&(this.mask=this.mask.fill(0,0,t)),this.dirty=!0}updateWeights(){this.totalWeight=0;for(let t=0;t<this.weights.length;t++)this.weights[t]=this._component.layers[t].weight,this.totalWeight+=this.mask[t]*this.weights[t];this.dirty=!1}updateValue(t,e){0===this.counter&&(this.value[0]=0,this.value[1]=0,this.value[2]=0,this.value[3]=1),this.mask[t]&&(0===this.counter?AnimEvaluator._set(this.value,e,this.valueType):AnimEvaluator._blend(this.value,e,this.getWeight(t),this.valueType))}}AnimTargetValue.TYPE_QUAT="quaternion",AnimTargetValue.TYPE_VEC3="vector3";class AnimEvaluator{constructor(t){this._binder=t,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}get clips(){return this._clips}static _dot(t,e){const s=t.length;let i=0;for(let n=0;n<s;++n)i+=t[n]*e[n];return i}static _normalize(t){let e=AnimEvaluator._dot(t,t);if(e>0){e=1/Math.sqrt(e);const s=t.length;for(let i=0;i<s;++i)t[i]*=e}}static _set(t,e,s){const i=t.length;if("quaternion"===s){let s=AnimEvaluator._dot(e,e);s>0&&(s=1/Math.sqrt(s));for(let n=0;n<i;++n)t[n]=e[n]*s}else for(let n=0;n<i;++n)t[n]=e[n]}static _blendVec(t,e,s){const i=1-s,n=t.length;for(let a=0;a<n;++a)t[a]=t[a]*i+e[a]*s}static _blendQuat(t,e,s){const i=t.length,n=1-s;AnimEvaluator._dot(t,e)<0&&(s=-s);for(let a=0;a<i;++a)t[a]=t[a]*n+e[a]*s;AnimEvaluator._normalize(t)}static _blend(t,e,s,i){"quaternion"===i?AnimEvaluator._blendQuat(t,e,s):AnimEvaluator._blendVec(t,e,s)}static _stableSort(t,e){const s=t.length;for(let i=0;i<s-1;++i)for(let n=i+1;n<s;++n)if(e(t[n],t[i])){const e=t[i];t[i]=t[n],t[n]=e}}addClip(t){const e=this._targets,s=this._binder,i=t.track.curves,n=t.snapshot,a=[],r=[];for(let o=0;o<i.length;++o){const t=i[o].paths;for(let i=0;i<t.length;++i){const l=t[i],h=s.resolve(l);let c=e[h&&h.targetPath||null];if(!c&&h){c={target:h,value:[],curves:0,blendCounter:0};for(let t=0;t<c.target.components;++t)c.value.push(0);if(e[h.targetPath]=c,s.animComponent){if(!s.animComponent.targets[h.targetPath]){let t;t="localRotation"===h.targetPath.substring(h.targetPath.length-13)?AnimTargetValue.TYPE_QUAT:AnimTargetValue.TYPE_VEC3,s.animComponent.targets[h.targetPath]=new AnimTargetValue(s.animComponent,t)}s.animComponent.targets[h.targetPath].layerCounter++,s.animComponent.targets[h.targetPath].setMask(s.layerIndex,1)}}c&&(c.curves++,a.push(n._results[o]),r.push(c))}}this._clips.push(t),this._inputs.push(a),this._outputs.push(r)}removeClip(t){const e=this._targets,s=this._binder,i=this._clips,n=i[t].track.curves;for(let a=0;a<n.length;++a){const t=n[a].paths;for(let i=0;i<t.length;++i){const n=t[i],a=this._binder.resolve(n);a&&(a.curves--,0===a.curves&&(s.unresolve(n),delete e[a.targetPath],s.animComponent&&s.animComponent.targets[a.targetPath].layerCounter--))}}i.splice(t,1),this._inputs.splice(t,1),this._outputs.splice(t,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}findClip(t){const e=this._clips;for(let s=0;s<e.length;++s){const i=e[s];if(i.name===t)return i}return null}rebind(){this._binder.rebind(),this._targets={};const t=[...this.clips];this.removeClips(),t.forEach((t=>{this.addClip(t)}))}assignMask(t){return this._binder.assignMask(t)}update(t){const e=this._clips,s=e.map((function(t,e){return e}));AnimEvaluator._stableSort(s,(function(t,s){return e[t].blendOrder<e[s].blendOrder}));for(let a=0;a<s.length;++a){const i=s[a],n=e[i],r=this._inputs[i],o=this._outputs[i],l=n.blendWeight;let h,c,d;if(l>0&&n._update(t),l>=1)for(let t=0;t<r.length;++t)h=r[t],c=o[t],d=c.value,AnimEvaluator._set(d,h,c.target.type),c.blendCounter++;else if(l>0)for(let t=0;t<r.length;++t)h=r[t],c=o[t],d=c.value,0===c.blendCounter?AnimEvaluator._set(d,h,c.target.type):AnimEvaluator._blend(d,h,l,c.target.type),c.blendCounter++}const i=this._targets,n=this._binder;for(const a in i)if(i.hasOwnProperty(a)){const t=i[a];if(n.animComponent&&t.target.isTransform){const e=n.animComponent.targets[a];e.counter===e.layerCounter&&(e.counter=0),e.updateValue(n.layerIndex,t.value),t.target.func(e.value),e.counter++}else t.target.func(t.value);t.blendCounter=0}n.update(t)}}class AnimBinder{static joinPath(t,e){e=e||".";return t.map((function(t){return t.replace(/\\/g,"\\\\").replace(new RegExp("\\"+e,"g"),"\\"+e)})).join(e)}static splitPath(t,e){e=e||".";const s=[];let i="",n=0;for(;n<t.length;){let a=t[n++];"\\"===a&&n<t.length?(a=t[n++],i+="\\"===a||a===e?a:"\\"+a):a===e?(s.push(i),i=""):i+=a}return i.length>0&&s.push(i),s}static encode(t,e,s){return`${Array.isArray(t)?t.join("/"):t}/${e}/${Array.isArray(s)?s.join("/"):s}`}resolve(t){return null}unresolve(t){}update(t){}}class AnimTarget{constructor(t,e,s,i){this._func=t,this._type=e,this._components=s,this._targetPath=i,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10)}get func(){return this._func}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}}class DefaultAnimBinder{constructor(t){if(this._isPathInMask=(t,e)=>{const s=this._mask[t];return!!s&&!!(s.children||e&&!1!==s.value)},this.graph=t,!t)return;this._mask=null;const e={};!function t(s){e[s.name]=s;for(let e=0;e<s.children.length;++e)t(s.children[e])}(t),this.nodes=e,this.targetCache={};const s=function(t){let e,s=t;for(;s&&!(s instanceof Entity);)s=s.parent;return s&&(s.render?e=s.render.meshInstances:s.model&&(e=s.model.meshInstances)),e};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(t){const e=t.localPosition;return DefaultAnimBinder.createAnimTarget((function(t){e.set(...t)}),"vector",3,t,"localPosition")},localRotation:function(t){const e=t.localRotation;return DefaultAnimBinder.createAnimTarget((function(t){e.set(...t)}),"quaternion",4,t,"localRotation")},localScale:function(t){const e=t.localScale;return DefaultAnimBinder.createAnimTarget((function(t){e.set(...t)}),"vector",3,t,"localScale")},weights:function(t){const e=s(t);if(e){const s=[];for(let i=0;i<e.length;++i)e[i].node.name===t.name&&e[i].morphInstance&&s.push(e[i].morphInstance);if(s.length>0){const e=function(t){for(let e=0;e<t.length;++e)for(let i=0;i<s.length;i++)s[i].setWeight(e,t[e])};return DefaultAnimBinder.createAnimTarget(e,"vector",s[0].morph._targets.length,t,"weights")}}return null},materialTexture:(t,e)=>{const i=s(t);if(i){let s;for(let e=0;e<i.length;++e)if(i[e].node.name===t.name){s=i[e];break}if(s){const i=t=>{const i=this.animComponent.system.app.assets.get(t[0]);i&&i.resource&&"texture"===i.type&&(s.material[e]=i.resource,s.material.update())};return DefaultAnimBinder.createAnimTarget(i,"vector",1,t,"materialTexture","material")}}return null}}}_isPathActive(t){if(!this._mask)return!0;const e=[t.entityPath[0],this.graph.name];for(let s=0;s<e.length;++s){let i=e[s];if(this._isPathInMask(i,1===t.entityPath.length))return!0;for(let e=1;e<t.entityPath.length;e++)if(i+="/"+t.entityPath[e],this._isPathInMask(i,e===t.entityPath.length-1))return!0}return!1}findNode(t){if(!this._isPathActive(t))return null;let e;return this.graph&&(e=this.graph.findByPath(t.entityPath)),e||(e=this.nodes[t.entityPath[t.entityPath.length-1]||""]),e}static createAnimTarget(t,e,s,i,n,a){const r=AnimBinder.encode(i.path,a||"entity",n);return new AnimTarget(t,e,s,r)}resolve(t){const e=AnimBinder.encode(t.entityPath,t.component,t.propertyPath);let s=this.targetCache[e];if(s)return s;const i=this.findNode(t);if(!i)return null;const n=this.handlers[t.propertyPath];return n?(s=n(i),s?(this.targetCache[e]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s):null):null}unresolve(t){if("graph"!==t.component)return;const e=this.nodes[t.entityPath[t.entityPath.length-1]||""];if(this.nodeCounts[e.path]--,0===this.nodeCounts[e.path]){const t=this.activeNodes,s=t.indexOf(e.node),i=t.length;s<i-1&&(t[s]=t[i-1]),t.pop()}}update(t){const e=this.activeNodes;for(let s=0;s<e.length;++s)e[s]._dirtifyLocal()}assignMask(t){return t!==this._mask&&(this._mask=t,!0)}}class InterpolatedKey{constructor(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new Quat,this._pos=new Vec3,this._scale=new Vec3,this._targetNode=null}getTarget(){return this._targetNode}setTarget(t){this._targetNode=t}}class Skeleton{constructor(t){this.looping=!0,this._animation=null,this._time=0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;const e=t=>{const s=new InterpolatedKey;s._name=t.name,this._interpolatedKeys.push(s),this._interpolatedKeyDict[t.name]=s,this._currKeyIndices[t.name]=0;for(let i=0;i<t._children.length;i++)e(t._children[i])};e(t)}set animation(t){this._animation=t,this.currentTime=0}get animation(){return this._animation}set currentTime(t){this._time=t;const e=this._interpolatedKeys.length;for(let s=0;s<e;s++){const t=this._interpolatedKeys[s]._name;this._currKeyIndices[t]=0}this.addTime(0),this.updateGraph()}get currentTime(){return this._time}get numNodes(){return this._interpolatedKeys.length}addTime(t){if(null!==this._animation){const e=this._animation._nodes,s=this._animation.duration;if(this._time===s&&!this.looping)return;if(this._time+=t,this._time>s){this._time=this.looping?0:s;for(let t=0;t<e.length;t++){const s=e[t]._name;this._currKeyIndices[s]=0}}else if(this._time<0){this._time=this.looping?s:0;for(let t=0;t<e.length;t++){const s=e[t],i=s._name;this._currKeyIndices[i]=s._keys.length-2}}const i=t>=0?1:-1;for(let t=0;t<e.length;t++){const s=e[t],n=s._name,a=s._keys,r=this._interpolatedKeyDict[n];if(void 0===r)continue;let o=!1;if(1!==a.length)for(let t=this._currKeyIndices[n];t<a.length-1&&t>=0;t+=i){const e=a[t],s=a[t+1];if(e.time<=this._time&&s.time>=this._time){const i=(this._time-e.time)/(s.time-e.time);r._pos.lerp(e.position,s.position,i),r._quat.slerp(e.rotation,s.rotation,i),r._scale.lerp(e.scale,s.scale,i),r._written=!0,this._currKeyIndices[n]=t,o=!0;break}}(1===a.length||!o&&0===this._time&&this.looping)&&(r._pos.copy(a[0].position),r._quat.copy(a[0].rotation),r._scale.copy(a[0].scale),r._written=!0)}}}blend(t,e,s){const i=this._interpolatedKeys.length;for(let n=0;n<i;n++){const i=t._interpolatedKeys[n],a=e._interpolatedKeys[n],r=this._interpolatedKeys[n];i._written&&a._written?(r._quat.slerp(i._quat,e._interpolatedKeys[n]._quat,s),r._pos.lerp(i._pos,e._interpolatedKeys[n]._pos,s),r._scale.lerp(i._scale,a._scale,s),r._written=!0):i._written?(r._quat.copy(i._quat),r._pos.copy(i._pos),r._scale.copy(i._scale),r._written=!0):a._written&&(r._quat.copy(a._quat),r._pos.copy(a._pos),r._scale.copy(a._scale),r._written=!0)}}setGraph(t){if(this.graph=t,t)for(let e=0;e<this._interpolatedKeys.length;e++){const s=this._interpolatedKeys[e],i=t.findByName(s._name);this._interpolatedKeys[e].setTarget(i)}else for(let e=0;e<this._interpolatedKeys.length;e++)this._interpolatedKeys[e].setTarget(null)}updateGraph(){if(this.graph)for(let t=0;t<this._interpolatedKeys.length;t++){const e=this._interpolatedKeys[t];if(e._written){const t=e.getTarget();t.localPosition.copy(e._pos),t.localRotation.copy(e._quat),t.localScale.copy(e._scale),t._dirtyLocal||t._dirtifyLocal(),e._written=!1}}}}class AnimationComponent extends Component{constructor(t,e){super(t,e),this.animationsIndex={},this.on("set_animations",this.onSetAnimations,this),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this)}set currentTime(t){const e=this.data;if(e.skeleton){const s=e.skeleton;s.currentTime=t,s.addTime(0),s.updateGraph()}if(e.animEvaluator){const s=e.animEvaluator;for(let e=0;e<s.clips.length;++e)s.clips[e].time=t}}get currentTime(){const t=this.data;if(t.skeleton)return this.data.skeleton._time;if(t.animEvaluator){const e=t.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0}get duration(){return this.data.animations[this.data.currAnim].duration}play(t,e=0){if(!this.enabled||!this.entity.enabled)return;const s=this.data;if(s.animations[t]){if(s.prevAnim=s.currAnim,s.currAnim=t,s.model){s.skeleton||s.animEvaluator||this._createAnimationController();const t=s.animations[s.prevAnim],i=s.animations[s.currAnim];if(s.blending=e>0&&s.prevAnim,s.blending&&(s.blend=0,s.blendSpeed=1/e),s.skeleton&&(s.blending?(s.fromSkel.animation=t,s.fromSkel.addTime(s.skeleton._time),s.toSkel.animation=i):s.skeleton.animation=i),s.animEvaluator){const t=s.animEvaluator;if(s.blending)for(;t.clips.length>1;)t.removeClip(0);else s.animEvaluator.removeClips();const e=new AnimClip(s.animations[s.currAnim],0,1,!0,s.loop);e.name=s.currAnim,e.blendWeight=s.blending?0:1,e.reset(),s.animEvaluator.addClip(e)}}s.playing=!0}}getAnimation(t){return this.data.animations[t]}setModel(t){const e=this.data;t!==e.model&&(this._resetAnimationController(),e.model=t,e.animations&&e.currAnim&&e.animations[e.currAnim]&&this.play(e.currAnim))}_resetAnimationController(){const t=this.data;t.skeleton=null,t.fromSkel=null,t.toSkel=null,t.animEvaluator=null}_createAnimationController(){const t=this.data,e=t.model,s=t.animations;let i=!1,n=!1;for(const r in s)if(s.hasOwnProperty(r)){s[r].constructor===AnimTrack?n=!0:i=!0}const a=e.getGraph();i?(t.fromSkel=new Skeleton(a),t.toSkel=new Skeleton(a),t.skeleton=new Skeleton(a),t.skeleton.looping=t.loop,t.skeleton.setGraph(a)):n&&(t.animEvaluator=new AnimEvaluator(new DefaultAnimBinder(this.entity)))}loadAnimationAssets(t){if(!t||!t.length)return;const e=this.system.app.assets,s=t=>{if(t.resources.length>1)for(let e=0;e<t.resources.length;e++)this.animations[t.resources[e].name]=t.resources[e],this.animationsIndex[t.id]=t.resources[e].name;else this.animations[t.name]=t.resource,this.animationsIndex[t.id]=t.name;this.animations=this.animations},i=t=>{t.off("change",this.onAssetChanged,this),t.on("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this),t.on("remove",this.onAssetRemoved,this),t.resource?s(t):(t.once("load",s,this),this.enabled&&this.entity.enabled&&e.load(t))};for(let n=0,a=t.length;n<a;n++){const s=e.get(t[n]);s?i(s):e.on("add:"+t[n],i)}}onAssetChanged(t,e,s,i){if("resource"===e||"resources"===e)if("resources"===e&&s&&0===s.length&&(s=null),s){let e=!1;if(s.length>1){if(i&&i.length>1)for(let t=0;t<i.length;t++)delete this.animations[i[t].name];else delete this.animations[t.name];e=!1;for(let t=0;t<s.length;t++)this.animations[s[t].name]=s[t],e||this.data.currAnim!==s[t].name||this.data.playing&&this.data.enabled&&this.entity.enabled&&(e=!0,this.play(s[t].name));e||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(i&&i.length>1)for(let t=0;t<i.length;t++)delete this.animations[i[t].name];this.animations[t.name]=s[0]||s,e=!1,this.data.currAnim===t.name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(e=!0,this.play(t.name)),e||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[t.id]=t.name}else{if(i.length>1)for(let t=0;t<i.length;t++)delete this.animations[i[t].name],this.data.currAnim===i[t].name&&this._stopCurrentAnimation();else delete this.animations[t.name],this.data.currAnim===t.name&&this._stopCurrentAnimation();delete this.animationsIndex[t.id]}}onAssetRemoved(t){if(t.off("remove",this.onAssetRemoved,this),this.animations){if(t.resources.length>1)for(let e=0;e<t.resources.length;e++)delete this.animations[t.resources[e].name],this.data.currAnim===t.resources[e].name&&this._stopCurrentAnimation();else delete this.animations[t.name],this.data.currAnim===t.name&&this._stopCurrentAnimation();delete this.animationsIndex[t.id]}}_stopCurrentAnimation(){const t=this.data;if(t.currAnim=null,t.playing=!1,t.skeleton&&(t.skeleton.currentTime=0,t.skeleton.animation=null),t.animEvaluator){for(let e=0;e<t.animEvaluator.clips.length;++e)t.animEvaluator.clips[e].stop();t.animEvaluator.update(0),t.animEvaluator.removeClips()}}onSetAnimations(t,e,s){const i=this.data,n=this.entity.model;if(n){const t=n.model;t&&t!==i.model&&this.setModel(t)}if(!i.currAnim&&i.activate&&i.enabled&&this.entity.enabled){const t=Object.keys(i.animations);t.length>0&&this.play(t[0])}}onSetAssets(t,e,s){if(e&&e.length)for(let n=0;n<e.length;n++)if(e[n]){const t=this.system.app.assets.get(e[n]);if(t){t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this);const e=this.animationsIndex[t.id];this.data.currAnim===e&&this._stopCurrentAnimation(),delete this.animations[e],delete this.animationsIndex[t.id]}}const i=s.map((t=>t instanceof Asset?t.id:t));this.loadAnimationAssets(i)}onSetLoop(t,e,s){const i=this.data;if(i.skeleton&&(i.skeleton.looping=i.loop),i.animEvaluator)for(let n=0;n<i.animEvaluator.clips.length;++n)i.animEvaluator.clips[n].loop=i.loop}onSetCurrentTime(t,e,s){const i=this.data;if(i.skeleton){const t=i.skeleton;t.currentTime=s,t.addTime(0),t.updateGraph()}if(i.animEvaluator){const t=i.animEvaluator;for(let e=0;e<t.clips.length;++e)t.clips[e].time=s}}onEnable(){super.onEnable();const t=this.data,e=t.assets,s=this.system.app.assets;if(e)for(let i=0,n=e.length;i<n;i++){let t=e[i];t instanceof Asset||(t=s.get(t)),t&&!t.resource&&s.load(t)}if(t.activate&&!t.currAnim){const e=Object.keys(t.animations);e.length>0&&this.play(e[0])}}onBeforeRemove(){for(let e=0;e<this.assets.length;e++){let t=this.assets[e];"number"==typeof t&&(t=this.system.app.assets.get(t)),t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this))}const t=this.data;delete t.animation,delete t.skeleton,delete t.fromSkel,delete t.toSkel,delete t.animEvaluator}}class AnimationComponentData{constructor(){this.assets=[],this.speed=1,this.loop=!0,this.activate=!0,this.enabled=!0,this.animations={},this.model=null,this.prevAnim=null,this.currAnim=null,this.blending=!1,this.blend=0,this.blendSpeed=0,this.playing=!1,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}}const nl=["enabled","assets","speed","loop","activate","animations","skeleton","model","prevAnim","currAnim","fromSkel","toSkel","blending","blendTimeRemaining","playing"];class AnimationComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="animation",this.ComponentType=AnimationComponent,this.DataType=AnimationComponentData,this.schema=nl,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){s=["activate","enabled","loop","speed","assets"],super.initializeComponentData(t,e,s)}cloneComponent(t,e){this.addComponent(e,{}),e.animation.assets=t.animation.assets.slice(),e.animation.data.speed=t.animation.speed,e.animation.data.loop=t.animation.loop,e.animation.data.activate=t.animation.activate,e.animation.data.enabled=t.animation.enabled;const s={},i=t.animation.animations;for(const r in i)i.hasOwnProperty(r)&&(s[r]=i[r]);e.animation.animations=s;const n={},a=t.animation.animationsIndex;for(const r in a)a.hasOwnProperty(r)&&(n[r]=a[r]);e.animation.animationsIndex=n}onBeforeRemove(t,e){e.onBeforeRemove()}onUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s],n=i.data;if(n.enabled&&i.entity.enabled){if(n.blending&&(n.blend+=t*n.blendSpeed,n.blend>=1&&(n.blend=1)),n.playing){const e=n.skeleton;if(null!==e&&null!==n.model){if(n.blending)e.blend(n.fromSkel,n.toSkel,n.blend);else{const s=t*n.speed;e.addTime(s),(n.speed>0&&e._time===e._animation.duration&&!n.loop||n.speed<0&&0===e._time&&!n.loop)&&(n.playing=!1)}n.blending&&1===n.blend&&(e.animation=n.toSkel._animation),e.updateGraph()}}const e=n.animEvaluator;if(e){for(let t=0;t<e.clips.length;++t){const s=e.clips[t];s.speed=n.speed,n.playing?s.resume():s.pause()}n.blending&&e.clips.length>1&&(e.clips[1].blendWeight=n.blend),e.update(t)}n.blending&&1===n.blend&&(n.blending=!1)}}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Component._buildAccessors(AnimationComponent.prototype,nl);class AnimNode{constructor(t,e,s,i,n=1){this._state=t,this._parent=e,this._name=s,Array.isArray(i)?(this._point=new Vec2(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=n,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?this._parent.path+"."+this._name:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(t){this._weight=t}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){const t=this._state.totalWeight;return 0===t?0:this.weight/t}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(t){this._weightedSpeed=t}get weightedSpeed(){return this._weightedSpeed}set animTrack(t){this._animTrack=t}get animTrack(){return this._animTrack}}class AnimBlendTree extends AnimNode{constructor(t,e,s,i,n,a,r,o,l){super(t,e,s,i),this._parameters=n,this._parameterValues=new Array(n.length),this._children=[],this._findParameter=l,this._syncAnimations=!1!==r,this._pointCache={};for(let h=0;h<a.length;h++){const e=a[h];e.children?this._children.push(o(e.type,this,null,s,1,e.parameter?[e.parameter]:e.parameters,e.children,o,l)):this._children.push(new AnimNode(t,this,e.name,e.point,e.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(t){for(let e=0;e<this._children.length;e++)if(this._children[e].name===t)return this._children[e];return null}updateParameterValues(){let t=!0;for(let e=0;e<this._parameterValues.length;e++){const s=this._findParameter(this._parameters[e]).value;this._parameterValues[e]!==s&&(this._parameterValues[e]=s,t=!1)}return t}getNodeWeightedDuration(t){return this._children[t].animTrack.duration/this._children[t].speedMultiplier*this._children[t].weight}getNodeCount(){let t=0;for(let e=0;e<this._children.length;e++){this._children[e].constructor===AnimBlendTree?t+=this._children[e].getNodeCount():t++}return t}}class AnimBlendTree1D extends AnimBlendTree{constructor(t,e,s,i,n,a,r,o,l){a.sort(((t,e)=>t.point-e.point)),super(t,e,s,i,n,a,r,o,l)}calculateWeights(){if(this.updateParameterValues())return;let t=0;this._children[0].weight=0;for(let e=0;e<this._children.length;e++){const s=this._children[e];if(e!==this._children.length-1){const t=this._children[e+1];if(s.point===t.point)s.weight=.5,t.weight=.5;else if(O.between(this._parameterValues[0],s.point,t.point,!0)){const e=Math.abs(s.point-t.point),i=(e-Math.abs(s.point-this._parameterValues[0]))/e;s.weight=i,t.weight=1-i}else t.weight=0}this._syncAnimations&&(t+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let e=0;e<this._children.length;e++){const s=this._children[e];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/t}}}class AnimBlendTreeCartesian2D extends AnimBlendTree{pointDistanceCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=this._children[e].point.clone().sub(this._children[t].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;AnimBlendTreeCartesian2D._p.set(...this._parameterValues),t=0,e=0;for(let s=0;s<this._children.length;s++){const i=this._children[s],n=i.point;AnimBlendTreeCartesian2D._pip.set(AnimBlendTreeCartesian2D._p.x,AnimBlendTreeCartesian2D._p.y).sub(n);let a=Number.MAX_VALUE;for(let t=0;t<this._children.length;t++){if(s===t)continue;const e=this.pointDistanceCache(s,t),i=O.clamp(1-AnimBlendTreeCartesian2D._pip.dot(e)/e.lengthSq(),0,1);i<a&&(a=i)}i.weight=a,t+=a,this._syncAnimations&&(e+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=i._weight/t,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/e)}}}AnimBlendTreeCartesian2D._p=new Vec2,AnimBlendTreeCartesian2D._pip=new Vec2;class AnimBlendTreeDirectional2D extends AnimBlendTree{pointCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=new Vec2((this._children[e].pointLength-this._children[t].pointLength)/((this._children[e].pointLength+this._children[t].pointLength)/2),2*Vec2.angleRad(this._children[t].point,this._children[e].point))),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;AnimBlendTreeDirectional2D._p.set(...this._parameterValues);const s=AnimBlendTreeDirectional2D._p.length();t=0,e=0;for(let i=0;i<this._children.length;i++){const n=this._children[i],a=n.point,r=n.pointLength;let o=Number.MAX_VALUE;for(let t=0;t<this._children.length;t++){if(i===t)continue;const e=this.pointCache(i,t),n=this._children[t].pointLength;AnimBlendTreeDirectional2D._pip.set((s-r)/((n+r)/2),2*Vec2.angleRad(a,AnimBlendTreeDirectional2D._p));const l=O.clamp(1-Math.abs(AnimBlendTreeDirectional2D._pip.dot(e)/e.lengthSq()),0,1);l<o&&(o=l)}n.weight=o,t+=o,this._syncAnimations&&(e+=n.animTrack.duration/n.absoluteSpeed*n.weight)}for(let i=0;i<this._children.length;i++){const s=this._children[i];if(s.weight=s._weight/t,this._syncAnimations){const i=s.animTrack.duration/e*t;s.weightedSpeed=s.absoluteSpeed*i}}}}AnimBlendTreeDirectional2D._p=new Vec2,AnimBlendTreeDirectional2D._pip=new Vec2;class AnimBlendTreeDirect extends AnimBlendTree{calculateWeights(){if(this.updateParameterValues())return;let t=0,e=0;for(let s=0;s<this._children.length;s++)if(t+=Math.max(this._parameterValues[s],0),this._syncAnimations){const t=this._children[s];e+=t.animTrack.duration/t.absoluteSpeed*t.weight}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=Math.max(this._parameterValues[s],0)/t,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/e)}}}class AnimState{constructor(t,e,s,i,n){this._controller=t,this._name=e,this._animations={},this._animationList=[],this._speed=s||1,this._loop=void 0===i||i;const a=this._controller.findParameter.bind(this._controller);this._blendTree=n?this._createTree(n.type,this,null,e,1,n.parameter?[n.parameter]:n.parameters,n.children,n.syncAnimations,this._createTree,a):new AnimNode(this,null,e,1,s)}_createTree(t,e,s,i,n,a,r,o,l,h){switch(t){case"1D":return new AnimBlendTree1D(e,s,i,n,a,r,o,l,h);case"2D_CARTESIAN":return new AnimBlendTreeCartesian2D(e,s,i,n,a,r,o,l,h);case"2D_DIRECTIONAL":return new AnimBlendTreeDirectional2D(e,s,i,n,a,r,o,l,h);case"DIRECT":return new AnimBlendTreeDirect(e,s,i,n,a,r,o,l,h)}}_getNodeFromPath(t){let e=this._blendTree;for(let s=1;s<t.length;s++)e=e.getChild(t[s]);return e}addAnimation(t,e){const s=t.join("."),i=this._animationList.findIndex((function(t){return t.path===s}));if(i>=0)this._animationList[i].animTrack=e;else{const s=this._getNodeFromPath(t);s.animTrack=e,this._animationList.push(s)}}get name(){return this._name}set animations(t){this._animationList=t}get animations(){return this._animationList}set speed(t){this._speed=t}get speed(){return this._speed}set loop(t){this._loop=t}get loop(){return this._loop}get nodeCount(){return this._blendTree&&this._blendTree.constructor!==AnimNode?this._blendTree.getNodeCount():1}get playable(){return-1!==sl.indexOf(this.name)||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){const t=this.name+"."+this.animations[0].animTrack.name,e=this._controller.animEvaluator.findClip(t);if(e)return e.loop}return!1}get totalWeight(){let t=0;for(let e=0;e<this.animations.length;e++)t+=this.animations[e].weight;return t}get timelineDuration(){let t=0;for(let e=0;e<this.animations.length;e++){const s=this.animations[e];s.animTrack.duration>t&&(t=s.animTrack.duration)}return t}}class AnimTransition{constructor({from:t,to:e,time:s=0,priority:i=0,conditions:n=[],exitTime:a=null,transitionOffset:r=null,interruptionSource:o="NONE"}){this._from=t,this._to=e,this._time=s,this._priority=i,this._conditions=n,this._exitTime=a,this._transitionOffset=r,this._interruptionSource=o}get from(){return this._from}set to(t){this._to=t}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}class AnimController{constructor(t,e,s,i,n,a,r){this._animEvaluator=t,this._states={},this._stateNames=[],this._eventHandler=a,this._consumedTriggers=r;for(let o=0;o<e.length;o++)this._states[e[o].name]=new AnimState(this,e[o].name,e[o].speed,e[o].loop,e[o].blendTree),this._stateNames.push(e[o].name);this._transitions=s.map((t=>new AnimTransition(Wr({},t)))),this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._parameters=i,this._previousStateName=null,this._activeStateName=Jo,this._playing=!1,this._activate=n,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=$o,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0}get animEvaluator(){return this._animEvaluator}set activeState(t){this._activeStateName=t}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(t){this._previousStateName=t}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let t=!0;for(let e=0;e<this._stateNames.length;e++)this._states[this._stateNames[e]].playable||(t=!1);return t}set playing(t){this._playing=t}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this.activeStateName===Jo||this.activeStateName===tl)return 0;let t=0;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this._animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(t=Math.max(t,s.track.duration))}return t}set activeStateCurrentTime(t){this._timeInStateBefore=t,this._timeInState=t;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this.animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(s.time=t)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(t){return this._animEvaluator.assignMask(t)}_findState(t){return this._states[t]}_getActiveStateProgressForTime(t){if(this.activeStateName===Jo||this.activeStateName===tl||this.activeStateName===el)return 1;const e=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return e?t/e.track.duration:null}_findTransitionsFromState(t){let e=this._findTransitionsFromStateCache[t];return e||(e=this._transitions.filter((function(e){return e.from===t})),e.sort((function(t,e){return t.priority<e.priority})),this._findTransitionsFromStateCache[t]=e),e}_findTransitionsBetweenStates(t,e){let s=this._findTransitionsBetweenStatesCache[t+"->"+e];return s||(s=this._transitions.filter((function(s){return s.from===t&&s.to===e})),s.sort((function(t,e){return t.priority<e.priority})),this._findTransitionsBetweenStatesCache[t+"->"+e]=s),s}_transitionHasConditionsMet(t){const e=t.conditions;for(let s=0;s<e.length;s++){const t=e[s],i=this.findParameter(t.parameterName);switch(t.predicate){case"GREATER_THAN":if(!(i.value>t.value))return!1;break;case"LESS_THAN":if(!(i.value<t.value))return!1;break;case"GREATER_THAN_EQUAL_TO":if(!(i.value>=t.value))return!1;break;case"LESS_THAN_EQUAL_TO":if(!(i.value<=t.value))return!1;break;case"EQUAL_TO":if(i.value!==t.value)return!1;break;case"NOT_EQUAL_TO":if(i.value===t.value)return!1}}return!0}_findTransition(t,e){let s=[];if(t&&e)s=s.concat(this._findTransitionsBetweenStates(t,e));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(el));break;case"NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(el));break;case"PREV_STATE_NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(el));break;case"NEXT_STATE_PREV_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(el))}else s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(el));if(s=s.filter((t=>{if(t.to===this.activeStateName)return!1;if(t.hasExitTime){let e=this._getActiveStateProgressForTime(this._timeInStateBefore),s=this._getActiveStateProgressForTime(this._timeInState);if(t.exitTime<1&&this.activeState.loop&&(e-=Math.floor(e),s-=Math.floor(s)),!(t.exitTime>e&&t.exitTime<=s))return null}return this._transitionHasConditionsMet(t)})),s.length>0){const t=s[0];if(t.to===tl){const e=this._findTransitionsFromState(Jo)[0];t.to=e.to}return t}return null}updateStateFromTransition(t){let e,s,i;this.previousState=t.from?this.activeStateName:null,this.activeState=t.to;for(let l=0;l<t.conditions.length;l++){const e=t.conditions[l];this.findParameter(e.parameterName).type===Qo&&this._consumedTriggers.add(e.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});const t=Math.min(0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,1);for(let n=0;n<this._transitionPreviousStates.length;n++){this._isTransitioning?n!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[n].weight*=1-t:this._transitionPreviousStates[n].weight=t:this._transitionPreviousStates[n].weight=1,e=this._findState(this._transitionPreviousStates[n].name);for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(s.name+".previous."+n),i||(i=this._animEvaluator.findClip(s.name),i.name=s.name+".previous."+n),n!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=t.time,this._currTransitionTime=0,this._transitionInterruptionSource=t.interruptionSource;const n=this.activeState,a=t.transitionOffset&&t.transitionOffset>0&&t.transitionOffset<1;let r=0,o=0;if(a){const e=n.timelineDuration*t.transitionOffset;r=e,o=e}this._timeInState=r,this._timeInStateBefore=o;for(let l=0;l<n.animations.length;l++){if(i=this._animEvaluator.findClip(n.animations[l].name),i)i.reset();else{const t=Number.isFinite(n.animations[l].speed)?n.animations[l].speed:n.speed;i=new AnimClip(n.animations[l].animTrack,this._timeInState,t,!0,n.loop,this._eventHandler),i.name=n.animations[l].name,this._animEvaluator.addClip(i)}if(t.time>0?i.blendWeight=0:i.blendWeight=n.animations[l].normalizedWeight,i.play(),a)i.time=n.timelineDuration*t.transitionOffset;else{const t=n.speed>=0?0:this.activeStateDuration;i.time=t}}}_transitionToState(t){if(!this._findState(t))return;let e=this._findTransition(this._activeStateName,t);e||(this._animEvaluator.removeClips(),e=new AnimTransition({from:null,to:t})),this.updateStateFromTransition(e)}assignAnimation(t,e,s,i){const n=t.split(".");let a=this._findState(n[0]);a||(a=new AnimState(this,n[0],1),this._states[n[0]]=a,this._stateNames.push(n[0])),a.addAnimation(n,e),void 0!==s&&(a.speed=s),void 0!==i&&(a.loop=i),!this._playing&&this._activate&&this.playable&&this.play()}removeNodeAnimations(t){if(-1!==sl.indexOf(t))return;const e=this._findState(t);return e?(e.animations=[],!0):void 0}play(t){t&&this._transitionToState(t),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=Jo,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(t){if(!this._playing)return;let e,s,i;this._timeInStateBefore=this._timeInState,this._timeInState+=t;const n=this._findTransition(this._activeStateName);if(n&&this.updateStateFromTransition(n),this._isTransitioning)if(this._currTransitionTime+=t,this._currTransitionTime<=this._totalTransitionTime){const t=0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1;for(let n=0;n<this._transitionPreviousStates.length;n++){e=this._findState(this._transitionPreviousStates[n].name);const a=this._transitionPreviousStates[n].weight;for(let r=0;r<e.animations.length;r++)s=e.animations[r],i=this._animEvaluator.findClip(s.name+".previous."+n),i&&(i.blendWeight=(1-t)*s.normalizedWeight*a)}e=this.activeState;for(let i=0;i<e.animations.length;i++)s=e.animations[i],this._animEvaluator.findClip(s.name).blendWeight=t*s.normalizedWeight}else{this._isTransitioning=!1;const t=this.activeStateAnimations.length,n=this._animEvaluator.clips.length;for(let e=0;e<n-t;e++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],e=this.activeState;for(let a=0;a<e.animations.length;a++)s=e.animations[a],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==AnimNode){e=this.activeState;for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(t)}findParameter(t){return this._parameters[t]}}const al=new Vec2,rl=new Vec3,ol=new Vec4,ll=new Color,hl=new Quat;class AnimComponentBinder extends DefaultAnimBinder{constructor(t,e,s,i,n){super(e),this.animComponent=t,this._mask=i,this.layerName=s,this.layerIndex=n}static _packFloat(t){return t[0]}static _packBoolean(t){return!!t[0]}static _packVec2(t){return al.x=t[0],al.y=t[1],al}static _packVec3(t){return rl.x=t[0],rl.y=t[1],rl.z=t[2],rl}static _packVec4(t){return ol.x=t[0],ol.y=t[1],ol.z=t[2],ol.w=t[3],ol}static _packColor(t){return ll.r=t[0],ll.g=t[1],ll.b=t[2],ll.a=t[3],ll}static _packQuat(t){return hl.x=t[0],hl.y=t[1],hl.z=t[2],hl.w=t[3],hl}resolve(t){const e=AnimBinder.encode(t.entityPath,t.component,t.propertyPath);let s,i,n,a=this.targetCache[e];if(a)return a;switch(t.component){case"entity":s=this._getEntityFromHierarchy(t.entityPath),n=AnimBinder.encode(s.path,"entity",t.propertyPath),i=s;break;case"graph":if(i=this.findNode(t),!i)return null;n=AnimBinder.encode(i.path,"graph",t.propertyPath);break;default:if(s=this._getEntityFromHierarchy(t.entityPath),i=s.findComponent(t.component),!i)return null;n=AnimBinder.encode(s.path,t.component,t.propertyPath)}return a=this._createAnimTargetForProperty(i,t.propertyPath,n),this.targetCache[e]=a,a}update(t){const e=this.activeNodes;if(e)for(let s=0;s<e.length;s++)e[s]._dirtifyLocal()}_getEntityFromHierarchy(t){if(!this.animComponent.entity.name===t[0])return null;const e=this.animComponent.entity;return 1===t.length?e:e._parent.findByPath(t)}_resolvePath(t,e,s){const i=e.length-(s?0:1);for(let n=0;n<i;n++)t=t[e[n]];return t}_setter(t,e,s){const i=this._resolvePath(t,e),n=e[e.length-1],a="set"+n.substring(0,1).toUpperCase()+n.substring(1);if(i[a]){const t=i[a].bind(i);return function(e){t(s(e))}}const r=i[n];if("object"==typeof r&&r.hasOwnProperty("copy"))return function(t){r.copy(s(t))};if(-1!==[Vec2,Vec3,Vec4,Color,Quat].indexOf(i.constructor)&&e.length>1){const a=e.length>2?this._resolvePath(t,e.slice(0,-1)):t,r=e[e.length-2];return function(t){i[n]=s(t),a[r]=i}}return function(t){i[n]=s(t)}}_createAnimTargetForProperty(t,e,s){if(this.handlers&&"weights"===e[0])return this.handlers.weights(t);if(this.handlers&&"material"===e[0]&&2===e.length){const s=e[1];if(s.endsWith("Map"))return this.handlers.materialTexture(t,s)}const i=this._resolvePath(t,e,!0);if(void 0===i)return null;let n,a,r;if("number"==typeof i)n=this._setter(t,e,AnimComponentBinder._packFloat),a="vector",r=1;else if("boolean"==typeof i)n=this._setter(t,e,AnimComponentBinder._packBoolean),a="vector",r=1;else if("object"==typeof i)switch(i.constructor){case Vec2:n=this._setter(t,e,AnimComponentBinder._packVec2),a="vector",r=2;break;case Vec3:n=this._setter(t,e,AnimComponentBinder._packVec3),a="vector",r=3;break;case Vec4:n=this._setter(t,e,AnimComponentBinder._packVec4),a="vector",r=4;break;case Color:n=this._setter(t,e,AnimComponentBinder._packColor),a="vector",r=4;break;case Quat:n=this._setter(t,e,AnimComponentBinder._packQuat),a="quaternion",r=4;break;default:return null}return-1!==e.indexOf("material")?new AnimTarget((function(e){n(e),t.material.update()}),a,r,s):new AnimTarget(n,a,r,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;const t={};!function e(s){t[s.name]=s;for(let t=0;t<s.children.length;++t)e(s.children[t])}(this.graph),this.nodes=t}}class AnimComponentLayer{constructor(t,e,s,i=1,n="OVERWRITE"){this._name=t,this._controller=e,this._component=s,this._weight=i,this._blendType=n,this._mask=null}get name(){return this._name}set playing(t){this._controller.playing=t}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(t){const e=this._controller,s=e.playing;e.playing=!0,e.activeStateCurrentTime=t,s||e.update(0),e.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(t){this._weight=t,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(t){t!==this._blendType&&(this._blendType=t,this._component.rebind())}get blendType(){return this._blendType}set mask(t){this._controller.assignMask(t)&&this._component.rebind(),this._mask=t}get mask(){return this._mask}play(t){this._controller.play(t)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(t){this._controller.update(t)}assignMask(t){this._controller.assignMask(t)&&this._component.rebind(),this._mask=t}assignAnimation(t,e,s,i){e.constructor===AnimTrack&&(this._controller.assignAnimation(t,e,s,i),0===this._controller._transitions.length&&this._controller._transitions.push(new AnimTransition({from:"START",to:t})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(t){this._controller.removeNodeAnimations(t)&&(this._component.playing=!1)}getAnimationAsset(t){return this._component.animationAssets[`${this.name}:${t}`]}transition(t,e=0,s=null){this._controller.updateStateFromTransition(new AnimTransition({from:this._controller.activeStateName,to:t,time:e,transitionOffset:s}))}}class AnimComponent extends Component{constructor(t,e){super(t,e),this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set}set stateGraphAsset(t){if(null===t)return void this.removeStateGraph();if(this._stateGraphAsset){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}let e,s;t instanceof Asset?(e=t.id,s=this.system.app.assets.get(e),s||(this.system.app.assets.add(t),s=this.system.app.assets.get(e))):(e=t,s=this.system.app.assets.get(e)),s&&this._stateGraphAsset!==e&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",(t=>{this._stateGraph=t.resource,this.loadStateGraph(this._stateGraph)})),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=e)}get stateGraphAsset(){return this._stateGraphAsset}set animationAssets(t){this._animationAssets=t,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(t){this._speed=t}get speed(){return this._speed}set activate(t){this._activate=t}get activate(){return this._activate}set playing(t){this._playing=t}get playing(){return this._playing}set rootBone(t){if("string"==typeof t){const e=this.entity.root.findByGuid(t);this._rootBone=e}else this._rootBone=t instanceof Entity?t:null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(t){this._stateGraph=t}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(t){this._layerIndices=t}get layerIndices(){return this._layerIndices}set parameters(t){this._parameters=t}get parameters(){return this._parameters}set targets(t){this._targets=t}get targets(){return this._targets}get playable(){for(let t=0;t<this._layers.length;t++)if(!this._layers[t].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(t){const e=this.animationAssets,s=this.layers.map((t=>t.mask));this.removeStateGraph(),this._stateGraph=new AnimStateGraph(t._data),this.loadStateGraph(this._stateGraph),this.animationAssets=e,this.loadAnimationAssets(),this.layers.forEach(((t,e)=>{t.mask=s[e]})),this.rebind()}dirtifyTargets(){const t=Object.values(this._targets);for(let e=0;e<t.length;e++)t[e].dirty=!0}_addLayer({name:t,states:e,transitions:s,weight:i,mask:n,blendType:a}){let r;r=this.rootBone?this.rootBone:this.entity;const o=this._layers.length,l=new AnimComponentBinder(this,r,t,n,o),h=new AnimEvaluator(l),c=new AnimController(h,e,s,this._parameters,this._activate,this,this._consumedTriggers);return this._layers.push(new AnimComponentLayer(t,c,this,i,a)),this._layerIndices[t]=o,this._layers[o]}addLayer(t,e,s,i){const n=this.findAnimationLayer(t);if(n)return n;return this._addLayer({name:t,states:[{name:"START",speed:1}],transitions:[],weight:e,mask:s,blendType:i})}loadStateGraph(t){this._stateGraph=t,this._parameters={};const e=Object.keys(t.parameters);for(let s=0;s<e.length;s++){const i=e[s];this._parameters[i]={type:t.parameters[i].type,value:t.parameters[i].value}}this._layers=[];for(let s=0;s<t.layers.length;s++){const e=t.layers[s];this._addLayer.bind(this)(Wr({},e))}this.setupAnimationAssets()}setupAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t],s=e.name;for(let t=0;t<e.states.length;t++){const i=e.states[t];if(-1===sl.indexOf(i)){const t=s+":"+i;this._animationAssets[t]||(this._animationAssets[t]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t];for(let t=0;t<e.states.length;t++){const s=e.states[t];if(-1!==sl.indexOf(s))continue;const i=this._animationAssets[e.name+":"+s];if(!i||!i.asset){this.removeNodeAnimations(s,e.name);continue}const n=i.asset,a=this.system.app.assets.get(n);a&&(a.resource?this.onAnimationAssetLoaded(e.name,s,a):(a.once("load",function(t,e){return function(s){this.onAnimationAssetLoaded(t,e,s)}.bind(this)}.bind(this)(e.name,s)),this.system.app.assets.load(a)))}}}onAnimationAssetLoaded(t,e,s){const i=s.resource;s.data.events&&(i.events=new AnimEvents(Object.values(s.data.events))),this.findAnimationLayer(t).assignAnimation(e,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1}resetStateGraph(){if(this.stateGraphAsset){const t=this.system.app.assets.get(this.stateGraphAsset).resource;this.loadStateGraph(t)}else this.removeStateGraph()}reset(){this._parameters=Object.assign({},this._stateGraph.parameters);for(let t=0;t<this._layers.length;t++){const e=this._layers[t].playing;this._layers[t].reset(),this._layers[t].playing=e}}rebind(){this._targets={};for(let t=0;t<this._layers.length;t++)this._layers[t].rebind()}findAnimationLayer(t){const e=this._layerIndices[t];return this._layers[e]||null}addAnimationState(t,e,s=1,i=!0,n="Base"){this._stateGraph||this.loadStateGraph(new AnimStateGraph({layers:[{name:n,states:[{name:"START",speed:1},{name:t,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}}));const a=this.findAnimationLayer(n);var r;a?a.assignAnimation(t,e,s,i):null==(r=this.addLayer(n))||r.assignAnimation(t,e,s,i)}assignAnimation(t,e,s,i=1,n=!0){if(!this._stateGraph&&-1===t.indexOf("."))return this.loadStateGraph(new AnimStateGraph({layers:[{name:"Base",states:[{name:"START",speed:1},{name:t,speed:i,loop:n,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}})),void this.baseLayer.assignAnimation(t,e);const a=s?this.findAnimationLayer(s):this.baseLayer;a&&a.assignAnimation(t,e,i,n)}removeNodeAnimations(t,e){const s=e?this.findAnimationLayer(e):this.baseLayer;s&&s.removeNodeAnimations(t)}getParameterValue(t,e){const s=this._parameters[t];if(s&&s.type===e)return s.value}setParameterValue(t,e,s){const i=this._parameters[t];i&&i.type===e&&(i.value=s)}getFloat(t){return this.getParameterValue(t,Ko)}setFloat(t,e){this.setParameterValue(t,Ko,e)}getInteger(t){return this.getParameterValue(t,Yo)}setInteger(t,e){"number"==typeof e&&e%1==0&&this.setParameterValue(t,Yo,e)}getBoolean(t){return this.getParameterValue(t,Zo)}setBoolean(t,e){this.setParameterValue(t,Zo,!!e)}getTrigger(t){return this.getParameterValue(t,Qo)}setTrigger(t,e=!1){this.setParameterValue(t,Qo,!0),e&&this._consumedTriggers.add(t)}resetTrigger(t){this.setParameterValue(t,Qo,!1)}onBeforeRemove(){if(Number.isFinite(this._stateGraphAsset)){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}}update(t){for(let e=0;e<this.layers.length;e++)this.layers[e].update(t*this.speed);this._consumedTriggers.forEach((t=>{this.parameters[t].value=!1})),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&e[t.rootBone.getGuid()]?this.rootBone=e[t.rootBone.getGuid()]:this.rebind()}}class AnimComponentData{constructor(){this.enabled=!0}}const cl=["enabled"];class AnimComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="anim",this.ComponentType=AnimComponent,this.DataType=AnimComponentData,this.schema=cl,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,cl);const i=["animationAssets","stateGraph","layers","masks"];Object.keys(e).forEach((s=>{i.includes(s)||(t[s]=e[s])})),e.stateGraph&&(t.stateGraph=e.stateGraph,t.loadStateGraph(t.stateGraph)),e.layers?e.layers.forEach(((e,s)=>{e._controller.states.forEach((i=>{e._controller._states[i]._animationList.forEach((e=>{t.layers[s].assignAnimation(e.name,e.animTrack)}))}))})):e.animationAssets&&(t.animationAssets=Object.assign(t.animationAssets,e.animationAssets)),e.masks&&Object.keys(e.masks).forEach((s=>{if(t.layers[s]){const i=e.masks[s].mask,n={};Object.keys(i).forEach((t=>{n[decodeURI(t)]=i[t]})),t.layers[s].mask=n}}))}onAnimationUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(t)}}cloneComponent(t,e){const s={stateGraphAsset:t.anim.stateGraphAsset,animationAssets:t.anim.animationAssets,speed:t.anim.speed,activate:t.anim.activate,playing:t.anim.playing,rootBone:t.anim.rootBone,stateGraph:t.anim.stateGraph,layers:t.anim.layers,layerIndices:t.anim.layerIndices,parameters:t.anim.parameters};this.addComponent(e,s)}onBeforeRemove(t,e){e.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}}Component._buildAccessors(AnimComponent.prototype,cl);class AudioListenerComponent extends Component{constructor(t,e){super(t,e)}setCurrentListener(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;const t=this.system.current.getPosition();this.system.manager.listener.setPosition(t)}}onEnable(){this.setCurrentListener()}onDisable(){this.system.current===this.entity&&(this.system.current=null)}}class AudioListenerComponentData{constructor(){this.enabled=!0}}const dl=["enabled"];class AudioListenerComponentSystem extends ComponentSystem{constructor(t,e){super(t),this.id="audiolistener",this.ComponentType=AudioListenerComponent,this.DataType=AudioListenerComponentData,this.schema=dl,this.manager=e,this.current=null,this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){s=["enabled"],super.initializeComponentData(t,e,s)}onUpdate(t){if(this.current){const t=this.current.getPosition();this.manager.listener.setPosition(t);const e=this.current.getWorldTransform();this.manager.listener.setOrientation(e)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Component._buildAccessors(AudioListenerComponent.prototype,dl);class AudioSourceComponent extends Component{constructor(t,e){super(t,e),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_minDistance",this.onSetMinDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_3d",this.onSet3d,this)}play(t){if(!this.enabled||!this.entity.enabled)return;let e;this.channel&&this.stop();const s=this.data;if(s.sources[t])if(s["3d"]){const i=this.entity.getPosition();e=this.system.manager.playSound3d(s.sources[t],i,s),s.currentSource=t,s.channel=e}else e=this.system.manager.playSound(s.sources[t],s),s.currentSource=t,s.channel=e}pause(){this.channel&&this.channel.pause()}unpause(){this.channel&&this.channel.paused&&this.channel.unpause()}stop(){this.channel&&(this.channel.stop(),this.channel=null)}onSetAssets(t,e,s){const i=[],n=s.length;if(e&&e.length)for(let a=0;a<e.length;a++)if(e[a]){const t=this.system.app.assets.get(e[a]);t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this),this.currentSource===t.name&&this.stop())}if(n)for(let a=0;a<n;a++)e.indexOf(s[a])<0&&(s[a]instanceof Asset?i.push(s[a].id):i.push(s[a]));!this.system._inTools&&i.length&&this.loadAudioSourceAssets(i)}onAssetChanged(t,e,s,i){if("resource"===e){this.data.sources&&(this.data.sources[t.name]=s,this.data.currentSource===t.name&&this.channel&&(this.channel.paused?(this.play(t.name),this.pause()):this.play(t.name)))}}onAssetRemoved(t){t.off("remove",this.onAssetRemoved,this),this.data.sources[t.name]&&(delete this.data.sources[t.name],this.data.currentSource===t.name&&(this.stop(),this.data.currentSource=null))}onSetLoop(t,e,s){e!==s&&this.channel&&this.channel.setLoop(s)}onSetVolume(t,e,s){e!==s&&this.channel&&this.channel.setVolume(s)}onSetPitch(t,e,s){e!==s&&this.channel&&this.channel.setPitch(s)}onSetMaxDistance(t,e,s){e!==s&&this.channel instanceof Channel3d&&this.channel.setMaxDistance(s)}onSetMinDistance(t,e,s){e!==s&&this.channel instanceof Channel3d&&this.channel.setMinDistance(s)}onSetRollOffFactor(t,e,s){e!==s&&this.channel instanceof Channel3d&&this.channel.setRollOffFactor(s)}onSetDistanceModel(t,e,s){e!==s&&this.channel instanceof Channel3d&&this.channel.setDistanceModel(s)}onSet3d(t,e,s){if(e!==s&&this.system.initialized&&this.currentSource){let t=!1,e=!1;this.channel&&(t=this.channel.paused,e=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=t,this.channel.suspended=e)}}onEnable(){const t=this.data.assets;if(t){const e=this.system.app.assets;for(let s=0,i=t.length;s<i;s++){let i=t[s];i instanceof Asset||(i=e.get(i)),i&&!i.resource&&e.load(i)}}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())}onDisable(){this.pause()}loadAudioSourceAssets(t){const e=t.map((t=>this.system.app.assets.get(t))),s={};let i=null,n=e.length;const a=t=>{n--},r=()=>{this.data.sources=s,this.data.currentSource=i,this.enabled&&this.activate&&i&&this.onEnable()};e.forEach(((e,o)=>{e?(i=i||e.name,e.off("change",this.onAssetChanged,this),e.on("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this),e.off("error",a,this),e.on("error",a,this),e.ready((t=>{s[t.name]=t.resource,n--,0===n&&r()})),!e.resource&&this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)):(n--,0===n&&r(),this.system.app.assets.on("add:"+t[o],(t=>{t.ready((t=>{this.data.sources[t.name]=t.resource})),t.resource||this.system.app.assets.load(t)})))}))}}class AudioSourceComponentData{constructor(){this.enabled=!0,this.assets=[],this.activate=!0,this.volume=1,this.pitch=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=ja,this.paused=!0,this.sources={},this.currentSource=null,this.channel=null}}const ul=["enabled","assets","volume","pitch","loop","activate","3d","minDistance","maxDistance","rollOffFactor","distanceModel","sources","currentSource","channel"];class AudioSourceComponentSystem extends ComponentSystem{constructor(t,e){super(t),this.id="audiosource",this.ComponentType=AudioSourceComponent,this.DataType=AudioSourceComponentData,this.schema=ul,this.manager=e,this.initialized=!1,this.app.systems.on("initialize",this.onInitialize,this),this.app.systems.on("update",this.onUpdate,this),this.on("remove",this.onRemove,this)}initializeComponentData(t,e,s){s=["activate","volume","pitch","loop","3d","minDistance","maxDistance","rollOffFactor","distanceModel","enabled","assets"],super.initializeComponentData(t,e,s),t.paused=!(t.enabled&&t.activate)}onInitialize(t){t.audiosource&&t.enabled&&t.audiosource.enabled&&t.audiosource.activate&&t.audiosource.play(t.audiosource.currentSource);const e=t._children;for(let s=0,i=e.length;s<i;s++)e[s]instanceof Entity&&this.onInitialize(e[s]);this.initialized=!0}onUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const t=e[s],i=t.entity,n=t.data;if(n.enabled&&i.enabled&&n.channel instanceof Channel3d){const t=i.getPosition();n.channel.setPosition(t)}}}onRemove(t,e){e.channel&&(e.channel.stop(),e.channel=null)}setVolume(t){this.manager.setVolume(t)}destroy(){super.destroy(),this.app.systems.off("initialize",this.onInitialize,this),this.app.systems.off("update",this.onUpdate,this)}}Component._buildAccessors(AudioSourceComponent.prototype,ul);class EntityReference extends EventHandler{constructor(t,e,s){if(super(),!(t&&t instanceof Component))throw new Error("The parentComponent argument is required and must be a Component");if(!e||"string"!=typeof e)throw new Error("The propertyName argument is required and must be a string");if(s&&"object"!=typeof s)throw new Error("If provided, the eventConfig argument must be an object");this._parentComponent=t,this._entityPropertyName=e,this._entity=null,this._app=t.system.app,this._configureEventListeners(s||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}_configureEventListeners(t,e){const s=this._parseEventListenerConfig(t,"external",this._parentComponent),i=this._parseEventListenerConfig(e,"internal",this);this._eventListenerConfigs=s.concat(i),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}}_parseEventListenerConfig(t,e,s){return Object.keys(t).map((function(i,n){const a=i.split("#"),r=a[0],o=a[1],l=t[i];if(2!==a.length||"string"!=typeof r||0===r.length||"string"!=typeof o||0===o.length)throw new Error("Invalid event listener description: `"+i+"`");if("function"!=typeof l)throw new Error("Invalid or missing callback for event listener `"+i+"`");return{id:e+"_"+n+"_"+i,sourceName:r,eventName:o,callback:l,scope:s}}),this)}_toggleLifecycleListeners(t){this._parentComponent[t]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[t]("beforeremove",this._onParentComponentRemove,this),this._app.systems[t]("postPostInitialize",this._updateEntityReference,this),this._app[t]("tools:sceneloaded",this._onSceneLoaded,this);const e=[];for(let s=0;s<this._eventListenerConfigs.length;++s){const t=this._eventListenerConfigs[s],i=this._app.systems[t.sourceName];i&&(-1===e.indexOf(i)&&e.push(i),i&&"gain"===t.eventName&&(this._gainListeners[t.sourceName]=t),i&&"lose"===t.eventName&&(this._loseListeners[t.sourceName]=t))}for(let s=0;s<e.length;++s)e[s][t]("add",this._onComponentAdd,this),e[s][t]("beforeremove",this._onComponentRemove,this)}_onSetEntity(t,e,s){if(s instanceof Entity)this._updateEntityReference();else{if(null!=s&&"string"!=typeof s)return void console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof s+"'");e!==s&&this._updateEntityReference()}}onParentComponentEnable(){this._entity||this._updateEntityReference()}_onSceneLoaded(){this._updateEntityReference()}_updateEntityReference(){let t,e=this._parentComponent.data[this._entityPropertyName];if(e instanceof Entity)t=e,e=t.getGuid(),this._parentComponent.data[this._entityPropertyName]=e;else{const s=this._parentComponent.system.app.root;t=this._parentComponent.entity.isDescendantOf(s)&&e?s.findByGuid(e):null}this._entity!==t&&(this._entity&&this._onBeforeEntityChange(),this._entity=t,this._entity&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))}_onBeforeEntityChange(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)}_onAfterEntityChange(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)}_onComponentAdd(t,e){const s=e.system.id;t===this._entity&&(this._callGainOrLoseListener(s,this._gainListeners),this._toggleComponentListeners("on",s))}_onComponentRemove(t,e){const s=e.system.id;t===this._entity&&(this._callGainOrLoseListener(s,this._loseListeners),this._toggleComponentListeners("off",s,!0))}_callAllGainOrLoseListeners(t){for(const e in this._entity.c)this._callGainOrLoseListener(e,t)}_callGainOrLoseListener(t,e){if(this._entity.c.hasOwnProperty(t)&&e[t]){const s=e[t];s.callback.call(s.scope)}}_toggleEntityListeners(t,e){if(this._entity)for(let s=0;s<this._eventListenerConfigs.length;++s)this._safeToggleListener(t,this._eventListenerConfigs[s],e)}_toggleComponentListeners(t,e,s){for(let i=0;i<this._eventListenerConfigs.length;++i){const n=this._eventListenerConfigs[i];n.sourceName===e&&this._safeToggleListener(t,n,s)}}_safeToggleListener(t,e,s){const i="on"===t;if(i&&this._listenerStatusFlags[e.id])return;const n=this._getEventSource(e.sourceName,s);n&&(n[t](e.eventName,e.callback,e.scope),this._listenerStatusFlags[e.id]=i)}_getEventSource(t,e){if("entity"===t)return this._entity;const s=this._entity[t];return s||(e||console.warn("Entity has no component with name "+t),null)}_onEntityDestroy(t){this._entity===t&&(this._toggleEntityListeners("off",!0),this._entity=null)}_onParentComponentRemove(t,e){e===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))}hasComponent(t){return!(!this._entity||!this._entity.c)&&!!this._entity.c[t]}get entity(){return this._entity}}const pl="group",ml="image",_l="text",fl="DEFAULT",gl="HOVER",yl="PRESSED",vl="INACTIVE",bl={};bl[fl]="_defaultTint",bl[gl]="hoverTint",bl[yl]="pressedTint",bl[vl]="inactiveTint";const xl={};xl[fl]="_defaultSpriteAsset",xl[gl]="hoverSpriteAsset",xl[yl]="pressedSpriteAsset",xl[vl]="inactiveSpriteAsset";const Sl={};Sl[fl]="_defaultSpriteFrame",Sl[gl]="hoverSpriteFrame",Sl[yl]="pressedSpriteFrame",Sl[vl]="inactiveSpriteFrame";class ButtonComponent extends Component{constructor(t,e){super(t,e),this._visualState=fl,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new Color(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageReference=new EntityReference(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame}),this._toggleLifecycleListeners("on",t)}_toggleLifecycleListeners(t,e){this[t]("set_active",this._onSetActive,this),this[t]("set_transitionMode",this._onSetTransitionMode,this),this[t]("set_hoverTint",this._onSetTransitionValue,this),this[t]("set_pressedTint",this._onSetTransitionValue,this),this[t]("set_inactiveTint",this._onSetTransitionValue,this),this[t]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[t]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[t]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[t]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[t]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[t]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),e.app.systems.element[t]("add",this._onElementComponentAdd,this),e.app.systems.element[t]("beforeremove",this._onElementComponentRemove,this)}_onSetActive(t,e,s){e!==s&&this._updateVisualState()}_onSetTransitionMode(t,e,s){e!==s&&(this._cancelTween(),this._resetToDefaultVisualState(e),this._forceReapplyVisualState())}_onSetTransitionValue(t,e,s){e!==s&&this._forceReapplyVisualState()}_onElementComponentRemove(t){this.entity===t&&this._toggleHitElementListeners("off")}_onElementComponentAdd(t){this.entity===t&&this._toggleHitElementListeners("on")}_onImageElementLose(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)}_onImageElementGain(){this._storeDefaultVisualState(),this._forceReapplyVisualState()}_toggleHitElementListeners(t){if(this.entity.element){const e="on"===t;if(e&&this._hasHitElementListeners)return;this.entity.element[t]("mouseenter",this._onMouseEnter,this),this.entity.element[t]("mouseleave",this._onMouseLeave,this),this.entity.element[t]("mousedown",this._onMouseDown,this),this.entity.element[t]("mouseup",this._onMouseUp,this),this.entity.element[t]("touchstart",this._onTouchStart,this),this.entity.element[t]("touchend",this._onTouchEnd,this),this.entity.element[t]("touchleave",this._onTouchLeave,this),this.entity.element[t]("touchcancel",this._onTouchCancel,this),this.entity.element[t]("selectstart",this._onSelectStart,this),this.entity.element[t]("selectend",this._onSelectEnd,this),this.entity.element[t]("selectenter",this._onSelectEnter,this),this.entity.element[t]("selectleave",this._onSelectLeave,this),this.entity.element[t]("click",this._onClick,this),this._hasHitElementListeners=e}}_storeDefaultVisualState(){if(this._imageReference.hasComponent("element")){const t=this._imageReference.entity.element;t.type!==pl&&(this._storeDefaultColor(t.color),this._storeDefaultOpacity(t.opacity),this._storeDefaultSpriteAsset(t.spriteAsset),this._storeDefaultSpriteFrame(t.spriteFrame))}}_storeDefaultColor(t){this._defaultTint.r=t.r,this._defaultTint.g=t.g,this._defaultTint.b=t.b}_storeDefaultOpacity(t){this._defaultTint.a=t}_storeDefaultSpriteAsset(t){this._defaultSpriteAsset=t}_storeDefaultSpriteFrame(t){this._defaultSpriteFrame=t}_onSetColor(t){this._isApplyingTint||(this._storeDefaultColor(t),this._forceReapplyVisualState())}_onSetOpacity(t){this._isApplyingTint||(this._storeDefaultOpacity(t),this._forceReapplyVisualState())}_onSetSpriteAsset(t){this._isApplyingSprite||(this._storeDefaultSpriteAsset(t),this._forceReapplyVisualState())}_onSetSpriteFrame(t){this._isApplyingSprite||(this._storeDefaultSpriteFrame(t),this._forceReapplyVisualState())}_onMouseEnter(t){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",t)}_onMouseLeave(t){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",t)}_onMouseDown(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",t)}_onMouseUp(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",t)}_onTouchStart(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",t)}_onTouchEnd(t){t.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",t)}_onTouchLeave(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",t)}_onTouchCancel(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",t)}_onSelectStart(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",t)}_onSelectEnd(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",t)}_onSelectEnter(t){this._hoveringCounter++,1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",t)}_onSelectLeave(t){this._hoveringCounter--,0===this._hoveringCounter&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",t)}_onClick(t){this._fireIfActive("click",t)}_fireIfActive(t,e){this.data.active&&this.fire(t,e)}_updateVisualState(t){const e=this._visualState,s=this._determineVisualState();if((e!==s||t)&&this.enabled)switch(this._visualState=s,e===gl&&this._fireIfActive("hoverend"),e===yl&&this._fireIfActive("pressedend"),s===gl&&this._fireIfActive("hoverstart"),s===yl&&this._fireIfActive("pressedstart"),this.transitionMode){case 0:{const t=this[bl[this._visualState]];this._applyTint(t);break}case 1:{const t=xl[this._visualState],e=Sl[this._visualState],s=this[t],i=this[e];this._applySprite(s,i);break}}}_forceReapplyVisualState(){this._updateVisualState(!0)}_resetToDefaultVisualState(t){if(this._imageReference.hasComponent("element"))switch(t){case 0:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}}_determineVisualState(){return this.active?this._isPressed?yl:this._isHovering?gl:fl:vl}_applySprite(t,e){e=e||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset!==t&&(this._imageReference.entity.element.spriteAsset=t),this._imageReference.entity.element.spriteFrame!==e&&(this._imageReference.entity.element.spriteFrame=e),this._isApplyingSprite=!1)}_applyTint(t){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(t):this._applyTintWithTween(t)}_applyTintImmediately(t){if(!t||!this._imageReference.hasComponent("element"))return;const e=wl(t);this._isApplyingTint=!0,e.equals(this._imageReference.entity.element.color)||(this._imageReference.entity.element.color=e),this._imageReference.entity.element.opacity!=t.a&&(this._imageReference.entity.element.opacity=t.a),this._isApplyingTint=!1}_applyTintWithTween(t){if(!t||!this._imageReference.hasComponent("element"))return;const e=wl(t),s=this._imageReference.entity.element.color,i=this._imageReference.entity.element.opacity;e.equals(s)&&t.a==i||(this._tweenInfo={startTime:k(),from:new Color(s.r,s.g,s.b,i),to:t.clone(),lerpColor:new Color})}_updateTintTween(){const t=k()-this._tweenInfo.startTime;let e=0===this.fadeDuration?1:t/this.fadeDuration;if(e=O.clamp(e,0,1),Math.abs(e-1)>1e-5){const t=this._tweenInfo.lerpColor;t.lerp(this._tweenInfo.from,this._tweenInfo.to,e),this._applyTintImmediately(new Color(t.r,t.g,t.b,t.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()}_cancelTween(){delete this._tweenInfo}onUpdate(){this._tweenInfo&&this._updateTintTween()}onEnable(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()}onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)}onRemove(){this._toggleLifecycleListeners("off",this.system),this.onDisable()}}function wl(t){return new Color(t.r,t.g,t.b)}class ButtonComponentData{constructor(){this.enabled=!0,this.active=!0,this.imageEntity=null,this.hitPadding=new Vec4,this.transitionMode=0,this.hoverTint=new Color(.75,.75,.75),this.pressedTint=new Color(.5,.5,.5),this.inactiveTint=new Color(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0}}const Cl=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"];class ButtonComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="button",this.ComponentType=ButtonComponent,this.DataType=ButtonComponentData,this.schema=Cl,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,Cl)}onUpdate(t){const e=this.store;for(const s in e){const t=e[s].entity,i=t.button;i.enabled&&t.enabled&&i.onUpdate()}}_onRemoveComponent(t,e){e.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}let Tl;Component._buildAccessors(ButtonComponent.prototype,Cl);class PostEffect{constructor(t,e){this.effect=t,this.inputTarget=e,this.outputTarget=null,this.name=t.constructor.name}}class PostEffectQueue{constructor(t,e){this.app=t,this.camera=e,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,this.renderTargetScale=1,this.resizeTimeout=null,this.resizeLast=0,this._resizeTimeoutCallback=()=>{this.resizeRenderTargets()},e.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(t,e){const s=this.camera.rect,i=Math.floor(s.z*this.app.graphicsDevice.width*this.renderTargetScale),n=Math.floor(s.w*this.app.graphicsDevice.height*this.renderTargetScale),a=new Texture(this.app.graphicsDevice,{format:t,width:i,height:n,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return a.name=e,a}_createOffscreenTarget(t,e){const s=this.app.graphicsDevice,i=e?s.getHdrFormat():7,n=this.camera.entity.name+"-posteffect-"+this.effects.length,a=this._allocateColorBuffer(i,n),r=this.app.graphicsDevice.supportsStencil,o=t?s.samples:1;return new RenderTarget({colorBuffer:a,depth:t,stencil:r,samples:o})}_resizeOffscreenTarget(t){const e=t.colorBuffer.format,s=t.colorBuffer.name;t.destroyFrameBuffers(),t.destroyTextureBuffers(),t._colorBuffer=this._allocateColorBuffer(e,s)}_destroyOffscreenTarget(t){t.destroyTextureBuffers(),t.destroy()}setRenderTargetScale(t){this.renderTargetScale=t,this.resizeRenderTargets()}addEffect(t){const e=this.effects,s=0===e.length,i=this._createOffscreenTarget(s,t.hdr),n=new PostEffect(t,i);e.push(n),this._sourceTarget=n.inputTarget,e.length>1&&(e[e.length-2].outputTarget=n.inputTarget),this._newPostEffect=t,t.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(t){let e=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===t){e=s;break}e>=0&&(e>0?this.effects[e-1].outputTarget=e+1<this.effects.length?this.effects[e+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[e].inputTarget),this.effects.splice(e,1)),this.enabled&&t.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()}_requestDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++){const e=this.effects[t].effect;this._newPostEffect!==e&&(e.needsDepthBuffer&&this._requestDepthMap())}}_releaseDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++){this.effects[t].effect.needsDepthBuffer&&this._releaseDepthMap()}}_requestDepthMap(){Tl||(Tl=this.app.scene.layers.getLayerById(1)),Tl&&Tl.incrementCounter()}_releaseDepthMap(){Tl&&Tl.decrementCounter()}destroy(){for(let t=0,e=this.effects.length;t<e;t++)this.effects[t].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let t=null;const e=this.effects.length;if(e)for(let s=0;s<e;s++){const i=this.effects[s];let n=i.outputTarget;s===e-1&&(t=this.camera.rect,this.destinationRenderTarget&&(n=this.destinationRenderTarget)),i.effect.render(i.inputTarget,n,t)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=null,this.camera.onPostprocessing=null)}_onCanvasResized(t,e){const s=this.camera.rect,i=this.app.graphicsDevice;this.camera.camera.aspectRatio=i.width*s.z/(i.height*s.w),this.resizeTimeout||(k()-this.resizeLast>100?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))}resizeRenderTargets(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.resizeLast=k();const t=this.camera.rect,e=Math.floor(t.z*this.app.graphicsDevice.width*this.renderTargetScale),s=Math.floor(t.w*this.app.graphicsDevice.height*this.renderTargetScale),i=this.effects;for(let n=0,a=i.length;n<a;n++){const t=i[n];t.inputTarget.width===e&&t.inputTarget.height===s||this._resizeOffscreenTarget(t.inputTarget)}}onCameraRectChanged(t,e,s){this.enabled&&this.resizeRenderTargets()}}const Ml=[{name:"aspectRatio",readonly:!1},{name:"aspectRatioMode",readonly:!1},{name:"calculateProjection",readonly:!1},{name:"calculateTransform",readonly:!1},{name:"clearColor",readonly:!1},{name:"cullFaces",readonly:!1},{name:"farClip",readonly:!1},{name:"flipFaces",readonly:!1},{name:"fov",readonly:!1},{name:"frustumCulling",readonly:!1},{name:"horizontalFov",readonly:!1},{name:"nearClip",readonly:!1},{name:"orthoHeight",readonly:!1},{name:"projection",readonly:!1},{name:"scissorRect",readonly:!1},{name:"vrDisplay",readonly:!1}];class CameraComponent extends Component{constructor(t,e){super(t,e),this.onPostprocessing=null,this.onPreRender=null,this.onPostRender=null,this._camera=new Camera,this._camera.node=e,this._priority=0,this._disablePostEffectsLayer=4,this._postEffects=new PostEffectQueue(t.app,this)}get camera(){return this._camera}set clearColorBuffer(t){this._camera.clearColorBuffer=t,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(t){this._camera.clearDepthBuffer=t,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(t){this._camera.clearStencilBuffer=t,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set disablePostEffectsLayer(t){this._disablePostEffectsLayer=t,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}get frustum(){return this._camera.frustum}set layers(t){const e=this._camera.layers;for(let s=0;s<e.length;s++){const t=this.system.app.scene.layers.getLayerById(e[s]);t&&t.removeCamera(this)}if(this._camera.layers=t,this.enabled&&this.entity.enabled)for(let s=0;s<t.length;s++){const e=this.system.app.scene.layers.getLayerById(t[s]);e&&e.addCamera(this)}}get layers(){return this._camera.layers}get postEffectsEnabled(){return this._postEffects.enabled}get postEffects(){return this._postEffects}set priority(t){this._priority=t,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}get projectionMatrix(){return this._camera.projectionMatrix}set rect(t){this._camera.rect=t,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderTarget(t){this._camera.renderTarget=t,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}get viewMatrix(){return this._camera.viewMatrix}dirtyLayerCompositionCameras(){this.system.app.scene.layers._dirtyCameras=!0}screenToWorld(t,e,s,i){const n=this.system.app.graphicsDevice,a=n.clientRect.width,r=n.clientRect.height;return this._camera.screenToWorld(t,e,s,a,r,i)}worldToScreen(t,e){const s=this.system.app.graphicsDevice,i=s.clientRect.width,n=s.clientRect.height;return this._camera.worldToScreen(t,i,n,e)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.addCamera(this)}}removeCameraFromLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeCamera(this)}}onLayersChanged(t,e){this.addCameraToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addCamera(this)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeCamera(this)}onEnable(){const t=this.system,e=t.app.scene,s=e.layers;t.addCamera(this),e.on("set:layers",this.onLayersChanged,this),s&&(s.on("add",this.onLayerAdded,this),s.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){const t=this.system,e=t.app.scene,s=e.layers;this.postEffects.disable(),this.removeCameraFromLayers(),e.off("set:layers",this.onLayersChanged,this),s&&(s.off("add",this.onLayerAdded,this),s.off("remove",this.onLayerRemoved,this)),t.removeCamera(this)}onRemove(){this.onDisable(),this.off()}calculateAspectRatio(t){const e=t||this.system.app.graphicsDevice,s=this.rect;return e.width*s.z/(e.height*s.w)}frameBegin(t){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(t))}frameEnd(){}enterVr(t,e){if(t instanceof Function&&!e&&(e=t,t=null),this.system.app.vr)if(t||(t=this.system.app.vr.display),t){const s=this;t.capabilities.canPresent?t.requestPresent((function(i){i||(s.vrDisplay=t,s.vrDisplay.once("beforepresentchange",(function(t){t.presenting||(s.vrDisplay=null)}))),e(i)})):(s.vrDisplay=t,e())}else e("No pc.VrDisplay to present");else e("VrManager not created. Enable VR in project settings.")}exitVr(t){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){const e=this.vrDisplay;this.vrDisplay=null,e.exitPresent(t)}else this.vrDisplay=null,t();else t("Not presenting VR")}startXr(t,e,s){this.system.app.xr.start(this,t,e,s)}endXr(t){this._camera.xr?this._camera.xr.end(t):t&&t(new Error("Camera is not in XR"))}copy(t){Ml.forEach((e=>{if(!e.readonly){const s=e.name;this[s]=t[s]}})),this.clearColorBuffer=t.clearColorBuffer,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencilBuffer=t.clearStencilBuffer,this.disablePostEffectsLayer=t.disablePostEffectsLayer,this.layers=t.layers,this.priority=t.priority,this.renderTarget=t.renderTarget,this.rect=t.rect}}Ml.forEach((function(t){const e=t.name,s={get:function(){return this._camera[e]}};t.readonly||(s.set=function(t){this._camera[e]=t}),Object.defineProperty(CameraComponent.prototype,e,s)}));class CameraComponentData{constructor(){this.enabled=!0}}const Al=["enabled"];class CameraComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="camera",this.ComponentType=CameraComponent,this.DataType=CameraComponentData,this.schema=Al,this.cameras=[],this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect"];for(let i=0;i<s.length;i++){const n=s[i];if(e.hasOwnProperty(n)){const s=e[n];switch(n){case"rect":case"scissorRect":Array.isArray(s)?t[n]=new Vec4(s[0],s[1],s[2],s[3]):t[n]=s;break;case"clearColor":Array.isArray(s)?t[n]=new Color(s[0],s[1],s[2],s[3]):t[n]=s;break;default:t[n]=s}}}super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.camera;this.addComponent(e,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect})}onBeforeRemove(t,e){this.removeCamera(e)}onUpdate(t){if(this.app.vr){const t=this.store;for(const e in t){const s=t[e];if(s.data.enabled&&s.entity.enabled){const t=s.entity.camera,e=t.vrDisplay;e&&(e.setClipPlanes(t.nearClip,t.farClip),s.entity&&(s.entity.localTransform.copy(e.combinedViewInv),s.entity._dirtyLocal=!1,s.entity._dirtifyWorld()))}}}}onAppPrerender(){for(let t=0,e=this.cameras.length;t<e;t++)this.cameras[t].onAppPrerender()}addCamera(t){this.cameras.push(t),this.sortCamerasByPriority()}removeCamera(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),this.sortCamerasByPriority())}sortCamerasByPriority(){this.cameras.sort((function(t,e){return t.priority-e.priority}))}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Component._buildAccessors(CameraComponent.prototype,Al);class CollisionComponent extends Component{constructor(t,e){super(t,e),this._compoundParent=null,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_model",this.onSetModel,this),this.on("set_render",this.onSetRender,this)}onSetType(t,e,s){e!==s&&this.system.changeType(this,e,s)}onSetHalfExtents(t,e,s){const i=this.data.type;this.data.initialized&&"box"===i&&this.system.recreatePhysicalShapes(this)}onSetRadius(t,e,s){const i=this.data.type;!this.data.initialized||"sphere"!==i&&"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetHeight(t,e,s){const i=this.data.type;!this.data.initialized||"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetAxis(t,e,s){const i=this.data.type;!this.data.initialized||"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&t.off("remove",this.onAssetRemoved,this)}if(s){s instanceof Asset&&(this.data.asset=s.id);const t=i.get(this.data.asset);t&&(t.off("remove",this.onAssetRemoved,this),t.on("remove",this.onAssetRemoved,this))}this.data.initialized&&"mesh"===this.data.type&&(s||(this.data.model=null),this.system.recreatePhysicalShapes(this))}onSetRenderAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&t.off("remove",this.onRenderAssetRemoved,this)}if(s){s instanceof Asset&&(this.data.renderAsset=s.id);const t=i.get(this.data.renderAsset);t&&(t.off("remove",this.onRenderAssetRemoved,this),t.on("remove",this.onRenderAssetRemoved,this))}this.data.initialized&&"mesh"===this.data.type&&(s||(this.data.render=null),this.system.recreatePhysicalShapes(this))}onSetModel(t,e,s){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)}onSetRender(t,e,s){this.onSetModel(t,e,s)}onAssetRemoved(t){t.off("remove",this.onAssetRemoved,this),this.data.asset===t.id&&(this.asset=null)}onRenderAssetRemoved(t){t.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===t.id&&(this.renderAsset=null)}_getCompoundChildShapeIndex(t){const e=this.data.shape,s=e.getNumChildShapes();for(let i=0;i<s;i++){if(e.getChildShape(i).ptr===t.ptr)return i}return null}_onInsert(t){if("undefined"!=typeof Ammo)if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody){let t=this.entity.parent;for(;t;){if(t.collision&&"compound"===t.collision.type){0===t.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(t.collision):this.system.recreatePhysicalShapes(this);break}t=t.parent}}}_updateCompound(){const t=this.entity;if(t._dirtyWorld){let e=t._dirtyLocal,s=t;for(;s&&!e&&(!s.collision||s.collision!==this._compoundParent);)s._dirtyLocal&&(e=!0),s=s.parent;if(e){t.forEach(this.system.implementations.compound._updateEachDescendantTransform,t);const e=this._compoundParent.entity.rigidbody;e&&e.activate()}}}onEnable(){if("mesh"===this.data.type&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){const t=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(t&&(!t.resource||!this.data.shape))return void this.system.recreatePhysicalShapes(this)}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(0===this._compoundParent.shape.getNumChildShapes())this.system.recreatePhysicalShapes(this._compoundParent);else{const t=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(t,this.data.shape),Ammo.destroy(t),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()}else this.entity.trigger&&this.entity.trigger.enable()}onDisable(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()}onBeforeRemove(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off()}}class CollisionComponentData{constructor(){this.enabled=!0,this.type="box",this.halfExtents=new Vec3(.5,.5,.5),this.radius=.5,this.axis=1,this.height=2,this.asset=null,this.renderAsset=null,this.shape=null,this.model=null,this.render=null,this.initialized=!1}}const Pl="static",El="dynamic",Ll="kinematic",Rl=65533;let Il,Dl,kl;class Trigger{constructor(t,e,s){this.entity=e.entity,this.component=e,this.app=t,"undefined"==typeof Ammo||Il||(Il=new Ammo.btVector3,Dl=new Ammo.btQuaternion,kl=new Ammo.btTransform),this.initialize(s)}initialize(t){const e=this.entity,s=t.shape;if(s&&"undefined"!=typeof Ammo){e.trigger&&e.trigger.destroy();const t=1,i=e.getPosition(),n=e.getRotation();Il.setValue(i.x,i.y,i.z),Dl.setValue(n.x,n.y,n.z,n.w),kl.setOrigin(Il),kl.setRotation(Dl);const a=this.app.systems.rigidbody.createBody(t,s,kl);a.setRestitution(0),a.setFriction(0),a.setDamping(0,0),Il.setValue(0,0,0),a.setLinearFactor(Il),a.setAngularFactor(Il),a.setCollisionFlags(4|a.getCollisionFlags()),a.entity=e,this.body=a,this.component.enabled&&e.enabled&&this.enable()}}destroy(){const t=this.body;t&&(this.disable(),this.app.systems.rigidbody.destroyBody(t))}_getEntityTransform(t){const e=this.entity.getPosition(),s=this.entity.getRotation();Il.setValue(e.x,e.y,e.z),Dl.setValue(s.x,s.y,s.z,s.w),t.setOrigin(Il),t.setRotation(Dl)}updateTransform(){this._getEntityTransform(kl);const t=this.body;t.setWorldTransform(kl),t.activate()}enable(){const t=this.body;if(!t)return;const e=this.app.systems;e.rigidbody.addBody(t,16,65517),e.rigidbody._triggers.push(this),t.forceActivationState(1),this.updateTransform()}disable(){const t=this.body;if(!t)return;const e=this.app.systems,s=e.rigidbody._triggers.indexOf(this);s>-1&&e.rigidbody._triggers.splice(s,1),e.rigidbody.removeBody(t),t.forceActivationState(5)}}const Fl=new Mat4,Ol=new Vec3,Vl=new Quat,Bl=new GraphNode,zl=["enabled","type","halfExtents","radius","axis","height","asset","renderAsset","shape","model","render"];class CollisionSystemImpl{constructor(t){this.system=t}beforeInitialize(t,e){e.shape=null,e.model=new Model,e.model.graph=new GraphNode}afterInitialize(t,e){this.recreatePhysicalShapes(t),t.data.initialized=!0}reset(t,e){this.beforeInitialize(t,e),this.afterInitialize(t,e)}recreatePhysicalShapes(t){const e=t.entity,s=t.data;if("undefined"!=typeof Ammo){e.trigger&&(e.trigger.destroy(),delete e.trigger),s.shape&&(t._compoundParent&&(this.system._removeCompoundChild(t._compoundParent,s.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),Ammo.destroy(s.shape),s.shape=null),s.shape=this.createPhysicalShape(t.entity,s);const i=!t._compoundParent;if("compound"!==s.type||t._compoundParent&&t!==t._compoundParent){if("compound"!==s.type&&(t._compoundParent&&t===t._compoundParent&&e.forEach(this.system.implementations.compound._updateEachDescendant,t),!t.rigidbody)){t._compoundParent=null;let s=e.parent;for(;s;){if(s.collision&&"compound"===s.collision.type){t._compoundParent=s.collision;break}s=s.parent}}}else t._compoundParent=t,e.forEach(this._addEachDescendant,t);t._compoundParent&&t!==t._compoundParent&&(i&&0===t._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(t._compoundParent):(this.system.updateCompoundChildTransform(e),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate())),e.rigidbody?(e.rigidbody.disableSimulation(),e.rigidbody.createBody(),e.enabled&&e.rigidbody.enabled&&e.rigidbody.enableSimulation()):t._compoundParent||(e.trigger?e.trigger.initialize(s):e.trigger=new Trigger(this.system.app,t,s))}}createPhysicalShape(t,e){}updateTransform(t,e,s,i){t.entity.trigger&&t.entity.trigger.updateTransform()}beforeRemove(t,e){e.data.shape&&(e._compoundParent&&!e._compoundParent.entity._destroying&&(this.system._removeCompoundChild(e._compoundParent,e.data.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),e._compoundParent=null,Ammo.destroy(e.data.shape),e.data.shape=null)}remove(t,e){const s=this.system.app;t.rigidbody&&t.rigidbody.body&&t.rigidbody.disableSimulation(),t.trigger&&(t.trigger.destroy(),delete t.trigger),s.scene.containsModel(e.model)&&(s.root.removeChild(e.model.graph),s.scene.removeModel(e.model))}clone(t,e){const s=this.system.store[t.getGuid()],i={enabled:s.data.enabled,type:s.data.type,halfExtents:[s.data.halfExtents.x,s.data.halfExtents.y,s.data.halfExtents.z],radius:s.data.radius,axis:s.data.axis,height:s.data.height,asset:s.data.asset,renderAsset:s.data.renderAsset,model:s.data.model,render:s.data.render};return this.system.addComponent(e,i)}}class CollisionBoxSystemImpl extends CollisionSystemImpl{createPhysicalShape(t,e){if("undefined"!=typeof Ammo){const t=e.halfExtents,s=new Ammo.btVector3(t?t.x:.5,t?t.y:.5,t?t.z:.5),i=new Ammo.btBoxShape(s);return Ammo.destroy(s),i}}}class CollisionSphereSystemImpl extends CollisionSystemImpl{createPhysicalShape(t,e){if("undefined"!=typeof Ammo)return new Ammo.btSphereShape(e.radius)}}class CollisionCapsuleSystemImpl extends CollisionSystemImpl{createPhysicalShape(t,e){const s=void 0!==e.axis?e.axis:1,i=e.radius||.5,n=Math.max((e.height||2)-2*i,0);let a=null;if("undefined"!=typeof Ammo)switch(s){case 0:a=new Ammo.btCapsuleShapeX(i,n);break;case 1:a=new Ammo.btCapsuleShape(i,n);break;case 2:a=new Ammo.btCapsuleShapeZ(i,n)}return a}}class CollisionCylinderSystemImpl extends CollisionSystemImpl{createPhysicalShape(t,e){const s=void 0!==e.axis?e.axis:1,i=void 0!==e.radius?e.radius:.5,n=void 0!==e.height?e.height:1;let a=null,r=null;if("undefined"!=typeof Ammo)switch(s){case 0:a=new Ammo.btVector3(.5*n,i,i),r=new Ammo.btCylinderShapeX(a);break;case 1:a=new Ammo.btVector3(i,.5*n,i),r=new Ammo.btCylinderShape(a);break;case 2:a=new Ammo.btVector3(i,i,.5*n),r=new Ammo.btCylinderShapeZ(a)}return a&&Ammo.destroy(a),r}}class CollisionConeSystemImpl extends CollisionSystemImpl{createPhysicalShape(t,e){const s=void 0!==e.axis?e.axis:1,i=void 0!==e.radius?e.radius:.5,n=void 0!==e.height?e.height:1;let a=null;if("undefined"!=typeof Ammo)switch(s){case 0:a=new Ammo.btConeShapeX(i,n);break;case 1:a=new Ammo.btConeShape(i,n);break;case 2:a=new Ammo.btConeShapeZ(i,n)}return a}}class CollisionMeshSystemImpl extends CollisionSystemImpl{beforeInitialize(t,e){}createAmmoMesh(t,e,s){let i;if(this.system._triMeshCache[t.id])i=this.system._triMeshCache[t.id];else{const e=t.vertexBuffer,s=e.getFormat();let n,a;for(let t=0;t<s.elements.length;t++){const i=s.elements[t];if(i.name===ot){a=new Float32Array(e.lock(),i.offset),n=i.stride/4;break}}const r=[];t.getIndices(r);const o=t.primitive[0].count/3,l=new Ammo.btVector3,h=new Ammo.btVector3,c=new Ammo.btVector3;let d,u,p;const m=t.primitive[0].base;i=new Ammo.btTriangleMesh,this.system._triMeshCache[t.id]=i;for(let t=0;t<o;t++)d=r[m+3*t]*n,u=r[m+3*t+1]*n,p=r[m+3*t+2]*n,l.setValue(a[d],a[d+1],a[d+2]),h.setValue(a[u],a[u+1],a[u+2]),c.setValue(a[p],a[p+1],a[p+2]),i.addTriangle(l,h,c,!0);Ammo.destroy(l),Ammo.destroy(h),Ammo.destroy(c)}const n=new Ammo.btBvhTriangleMeshShape(i,!0),a=this.system._getNodeScaling(e);n.setLocalScaling(a),Ammo.destroy(a);const r=this.system._getNodeTransform(e);s.addChildShape(r,n),Ammo.destroy(r)}createPhysicalShape(t,e){if("undefined"!=typeof Ammo&&(e.model||e.render)){const s=new Ammo.btCompoundShape;if(e.model){const t=e.model.meshInstances;for(let e=0;e<t.length;e++)this.createAmmoMesh(t[e].mesh,t[e].node,s)}else if(e.render){const t=e.render.meshes;for(let e=0;e<t.length;e++)this.createAmmoMesh(t[e],Bl,s)}const i=t.getWorldTransform().getScale(),n=new Ammo.btVector3(i.x,i.y,i.z);return s.setLocalScaling(n),Ammo.destroy(n),s}}recreatePhysicalShapes(t){const e=t.data;(e.renderAsset||e.asset)&&t.enabled&&t.entity.enabled?this.loadAsset(t,e.renderAsset||e.asset,e.renderAsset?"render":"model"):this.doRecreatePhysicalShape(t)}loadAsset(t,e,s){const i=t.data,n=this.system.app.assets,a=n.get(e);a?(a.ready((e=>{i[s]=e.resource,this.doRecreatePhysicalShape(t)})),n.load(a)):n.once("add:"+e,(e=>{e.ready((e=>{i[s]=e.resource,this.doRecreatePhysicalShape(t)})),n.load(e)}))}doRecreatePhysicalShape(t){const e=t.entity,s=t.data;s.model||s.render?(this.destroyShape(s),s.shape=this.createPhysicalShape(e,s),e.rigidbody?(e.rigidbody.disableSimulation(),e.rigidbody.createBody(),e.enabled&&e.rigidbody.enabled&&e.rigidbody.enableSimulation()):e.trigger?e.trigger.initialize(s):e.trigger=new Trigger(this.system.app,t,s)):(this.beforeRemove(e,t),this.remove(e,s))}updateTransform(t,e,s,i){if(t.shape){const e=t.entity.getWorldTransform().getScale(),s=t.shape.getLocalScaling();e.x===s.x()&&e.y===s.y()&&e.z===s.z()||this.doRecreatePhysicalShape(t)}super.updateTransform(t,e,s,i)}destroyShape(t){if(!t.shape)return;const e=t.shape.getNumChildShapes();for(let s=0;s<e;s++){const e=t.shape.getChildShape(s);Ammo.destroy(e)}Ammo.destroy(t.shape),t.shape=null}remove(t,e){this.destroyShape(e),super.remove(t,e)}}class CollisionCompoundSystemImpl extends CollisionSystemImpl{createPhysicalShape(t,e){if("undefined"!=typeof Ammo)return new Ammo.btCompoundShape}_addEachDescendant(t){t.collision&&!t.rigidbody&&(t.collision._compoundParent=this,t!==this.entity&&t.collision.system.recreatePhysicalShapes(t.collision))}_updateEachDescendant(t){t.collision&&t.collision._compoundParent===this&&(t.collision._compoundParent=null,t===this.entity||t.rigidbody||t.collision.system.recreatePhysicalShapes(t.collision))}_updateEachDescendantTransform(t){t.collision&&t.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(t)}}class CollisionComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="collision",this.ComponentType=CollisionComponent,this.DataType=CollisionComponentData,this.schema=zl,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}initializeComponentData(t,e,s){const i={};for(let r=0,o=(s=["type","halfExtents","radius","axis","height","shape","model","asset","render","renderAsset","enabled"]).length;r<o;r++){const t=s[r];i[t]=e[t]}let n;e.hasOwnProperty("asset")?(n=s.indexOf("model"),-1!==n&&s.splice(n,1),n=s.indexOf("render"),-1!==n&&s.splice(n,1)):e.hasOwnProperty("model")&&(n=s.indexOf("asset"),-1!==n&&s.splice(n,1)),i.type||(i.type=t.data.type),t.data.type=i.type,i.halfExtents&&Array.isArray(i.halfExtents)&&(i.halfExtents=new Vec3(i.halfExtents[0],i.halfExtents[1],i.halfExtents[2]));const a=this._createImplementation(i.type);a.beforeInitialize(t,i),super.initializeComponentData(t,i,s),a.afterInitialize(t,i)}_createImplementation(t){if(void 0===this.implementations[t]){let e;switch(t){case"box":e=new CollisionBoxSystemImpl(this);break;case"sphere":e=new CollisionSphereSystemImpl(this);break;case"capsule":e=new CollisionCapsuleSystemImpl(this);break;case"cylinder":e=new CollisionCylinderSystemImpl(this);break;case"cone":e=new CollisionConeSystemImpl(this);break;case"mesh":e=new CollisionMeshSystemImpl(this);break;case"compound":e=new CollisionCompoundSystemImpl(this)}this.implementations[t]=e}return this.implementations[t]}_getImplementation(t){return this.implementations[t.collision.data.type]}cloneComponent(t,e){return this._getImplementation(t).clone(t,e)}onBeforeRemove(t,e){this.implementations[e.data.type].beforeRemove(t,e),e.onBeforeRemove()}onRemove(t,e){this.implementations[e.type].remove(t,e)}updateCompoundChildTransform(t){if(this._removeCompoundChild(t.collision._compoundParent,t.collision.data.shape),t.enabled&&t.collision.enabled){const e=this._getNodeTransform(t,t.collision._compoundParent.entity);t.collision._compoundParent.shape.addChildShape(e,t.collision.data.shape),Ammo.destroy(e)}}_removeCompoundChild(t,e){if(t.shape.removeChildShape)t.shape.removeChildShape(e);else{const s=t._getCompoundChildShapeIndex(e);null!==s&&t.shape.removeChildShapeByIndex(s)}}onTransformChanged(t,e,s,i){this.implementations[t.data.type].updateTransform(t,e,s,i)}changeType(t,e,s){this.implementations[e].beforeRemove(t.entity,t),this.implementations[e].remove(t.entity,t.data),this._createImplementation(s).reset(t,t.data)}recreatePhysicalShapes(t){this.implementations[t.data.type].recreatePhysicalShapes(t)}_calculateNodeRelativeTransform(t,e){if(t===e){const e=t.getWorldTransform().getScale();Fl.setScale(e.x,e.y,e.z)}else this._calculateNodeRelativeTransform(t.parent,e),Fl.mul(t.getLocalTransform())}_getNodeScaling(t){const e=t.getWorldTransform().getScale();return new Ammo.btVector3(e.x,e.y,e.z)}_getNodeTransform(t,e){let s,i;e?(this._calculateNodeRelativeTransform(t,e),s=Ol,i=Vl,Fl.getTranslation(s),i.setFromMat4(Fl)):(s=t.getPosition(),i=t.getRotation());const n=new Ammo.btTransform;n.setIdentity();const a=n.getOrigin();a.setValue(s.x,s.y,s.z);const r=new Ammo.btQuaternion;return r.setValue(i.x,i.y,i.z,i.w),n.setRotation(r),Ammo.destroy(r),Ammo.destroy(a),n}destroy(){for(const t in this._triMeshCache)Ammo.destroy(this._triMeshCache[t]);this._triMeshCache=null,super.destroy()}}Component._buildAccessors(CollisionComponent.prototype,zl);class ComponentSystemRegistry extends EventHandler{constructor(){super(),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.audiosource=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.joint=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.zone=void 0,this.list=[]}add(t){const e=t.id;if(this[e])throw new Error(`ComponentSystem name '${e}' already registered or not allowed`);this[e]=t,this.list.push(t)}remove(t){const e=t.id;if(!this[e])throw new Error(`No ComponentSystem named '${e}' registered`);delete this[e];const s=this.list.indexOf(this[e]);-1!==s&&this.list.splice(s,1)}destroy(){this.off();for(let t=0;t<this.list.length;t++)this.list[t].destroy()}}class StencilParameters{constructor(t){this.func=void 0===t.func?7:t.func,this.ref=t.ref||0,this.readMask=void 0===t.readMask?255:t.readMask,this.writeMask=void 0===t.writeMask?255:t.writeMask,this.fail=t.fail||0,this.zfail=t.zfail||0,this.zpass=t.zpass||0}clone(){return new StencilParameters({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})}}class ImageRenderable{constructor(t,e,s){this._entity=t,this._element=t.element,this.model=new Model,this.node=new GraphNode,this.model.graph=this.node,this.mesh=e,this.meshInstance=new MeshInstance(this.mesh,s,this.node),this.meshInstance.name="ImageElement: "+t.name,this.meshInstance.castShadow=!1,this.meshInstance.receiveShadow=!1,this._meshDirty=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}destroy(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,this.meshInstance=null,this._entity=null,this._element=null}setMesh(t){this.meshInstance&&(this.mesh=t,this.meshInstance.mesh=t,this.meshInstance.visible=!!t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=t),this.forceUpdateAabb())}setMask(t){if(this.meshInstance){if(t){this.unmaskMeshInstance=new MeshInstance(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance);for(const t in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(t,this.meshInstance.parameters[t].data)}else{const t=this.model.meshInstances.indexOf(this.unmaskMeshInstance);t>=0&&this.model.meshInstances.splice(t,1),this.unmaskMeshInstance=null}this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}}setMaterial(t){this.meshInstance&&(this.meshInstance.material=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=t))}setParameter(t,e){this.meshInstance&&(this.meshInstance.setParameter(t,e),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(t,e))}deleteParameter(t){this.meshInstance&&(this.meshInstance.deleteParameter(t),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(t))}setUnmaskDrawOrder(){if(!this.meshInstance)return;const t=function t(e){let s;const i=e.children,n=i.length;if(n){for(let t=0;t<n;t++)i[t].element&&(s=i[t]);if(!s)return null;const e=t(s);return e||s}return null};if(this.unmaskMeshInstance){const e=t(this._entity);e&&e.element?this.unmaskMeshInstance.drawOrder=e.element.drawOrder+e.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}}setDrawOrder(t){this.meshInstance&&(this.meshInstance.drawOrder=t)}setCull(t){if(!this.meshInstance)return;const e=this._element;let s=null;t&&e._isScreenCulled()&&(s=function(t){return e.isVisibleForCamera(t)}),this.meshInstance.cull=t,this.meshInstance.isVisibleFunc=s,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=t,this.unmaskMeshInstance.isVisibleFunc=s)}setScreenSpace(t){this.meshInstance&&(this.meshInstance.screenSpace=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=t))}setLayer(t){this.meshInstance&&(this.meshInstance.layer=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=t))}forceUpdateAabb(t){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))}setAabbFunc(t){this.meshInstance&&(this.meshInstance._updateAabbFunc=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=t))}}class ImageElement{constructor(t){this._element=t,this._entity=t.entity,this._system=t.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._rect=new Vec4(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new Vec2,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new Vec4,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new Vec4,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new ImageRenderable(this._entity,this._defaultMesh,this._material),this._color=new Color(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}destroy(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)}_onResolutionChange(t){}_onParentResizeOrPivotChange(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)}_onScreenSpaceChange(t){this._updateMaterial(t)}_onScreenChange(t,e){t?this._updateMaterial(t.screen.screenSpace):this._updateMaterial(!1)}_onDrawOrderChange(t){this._renderable.setDrawOrder(t),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",(function(){this._renderable.setUnmaskDrawOrder()}),this)}_hasUserMaterial(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)}_use9Slicing(){return this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)}_updateMaterial(t){const e=!!this._mask,s=!(!this.sprite||1!==this.sprite.renderMode),i=!(!this.sprite||2!==this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(t,e,s,i)),this._renderable&&(this._renderable.setCull(!0),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(t),this._renderable.setLayer(t?0:15))}_createMesh(){const t=this._element,e=t.calculatedWidth,s=t.calculatedHeight,i=this._rect,n=new ArrayBuffer(128),a=new Float32Array(n);a[5]=1,a[6]=i.x,a[7]=1-i.y,a[8]=e,a[13]=1,a[14]=i.x+i.z,a[15]=1-i.y,a[16]=e,a[17]=s,a[21]=1,a[22]=i.x+i.z,a[23]=1-(i.y+i.w),a[25]=s,a[29]=1,a[30]=i.x,a[31]=1-(i.y+i.w);const r=[{semantic:ot,components:3,type:6},{semantic:lt,components:3,type:6},{semantic:mt,components:2,type:6}],o=this._system.app.graphicsDevice,l=new VertexFormat(o,r),h=new VertexBuffer(o,l,4,0,n),c=new Mesh(o);return c.vertexBuffer=h,c.primitive[0].type=6,c.primitive[0].base=0,c.primitive[0].count=4,c.primitive[0].indexed=!1,c.aabb.setMinMax(Vec3.ZERO,new Vec3(e,s,0)),this._updateMesh(c),c}_updateMesh(t){const e=this._element,s=e.calculatedWidth,i=e.calculatedHeight,n=e._isScreenSpace();if(this._updateMaterial(n),this._renderable&&this._renderable.forceUpdateAabb(),!this.sprite||1!==this.sprite.renderMode&&2!==this.sprite.renderMode){const n=t.vertexBuffer,a=new Float32Array(n.lock()),r=e.pivot.x,o=e.pivot.y;a[0]=0-r*s,a[1]=0-o*i,a[8]=s-r*s,a[9]=0-o*i,a[16]=s-r*s,a[17]=i-o*i,a[24]=0-r*s,a[25]=i-o*i;let l=1,h=1,c=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){const t=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];t&&(c=t.rect,l=this._sprite.atlas.texture.width,h=this._sprite.atlas.texture.height)}a[6]=c.x/l,a[7]=1-c.y/h,a[14]=(c.x+c.z)/l,a[15]=1-c.y/h,a[22]=(c.x+c.z)/l,a[23]=1-(c.y+c.w)/h,a[30]=c.x/l,a[31]=1-(c.y+c.w)/h,n.unlock();const d=new Vec3(0-r*s,0-o*i,0),u=new Vec3(s-r*s,i-o*i,0);t.aabb.setMinMax(d,u),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else{const t=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],n=2/t.rect.z,a=2/t.rect.w;this._innerOffset.set(t.border.x*n,t.border.y*a,t.border.z*n,t.border.w*a);const r=this.sprite.atlas.texture;this._atlasRect.set(t.rect.x/r.width,t.rect.y/r.height,t.rect.z/r.width,t.rect.w/r.height);const o=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,l=t.rect.z/o,h=t.rect.w/o;this._outerScale.set(Math.max(s,this._innerOffset.x*l),Math.max(i,this._innerOffset.y*h));let c=l,d=h;this._outerScale.x/=l,this._outerScale.y/=h,c*=O.clamp(s/(this._innerOffset.x*l),1e-4,1),d*=O.clamp(i/(this._innerOffset.y*h),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(c,d,1),this._renderable.node.setLocalPosition((.5-e.pivot.x)*s,(.5-e.pivot.y)*i,0))}this._meshDirty=!1}_updateSprite(){let t=!1,e=null;this._sprite&&this._sprite.atlas&&(e=this._sprite.meshes[this.spriteFrame],t=1===this._sprite.renderMode||2===this._sprite.renderMode),this.mesh=t?e:this._defaultMesh,this.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))}_updateAabb(t){return t.center.set(0,0,0),t.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),t.setFromTransformedAabb(t,this._renderable.node.getWorldTransform()),t}_toggleMask(){this._element._dirtifyMask();const t=this._element._isScreenSpace();this._updateMaterial(t),this._renderable.setMask(!!this._mask)}_onMaterialLoad(t){this.material=t.resource}_onMaterialAdded(t){this._system.app.assets.off("add:"+t.id,this._onMaterialAdded,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)}_bindMaterialAsset(t){this._entity.enabled&&(t.on("load",this._onMaterialLoad,this),t.on("change",this._onMaterialChange,this),t.on("remove",this._onMaterialRemove,this),t.resource?this._onMaterialLoad(t):this._system.app.assets.load(t))}_unbindMaterialAsset(t){t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this)}_onMaterialChange(){}_onMaterialRemove(){}_onTextureAdded(t){this._system.app.assets.off("add:"+t.id,this._onTextureAdded,this),this._textureAsset===t.id&&this._bindTextureAsset(t)}_bindTextureAsset(t){this._entity.enabled&&(t.on("load",this._onTextureLoad,this),t.on("change",this._onTextureChange,this),t.on("remove",this._onTextureRemove,this),t.resource?this._onTextureLoad(t):this._system.app.assets.load(t))}_unbindTextureAsset(t){t.off("load",this._onTextureLoad,this),t.off("change",this._onTextureChange,this),t.off("remove",this._onTextureRemove,this)}_onTextureLoad(t){this.texture=t.resource}_onTextureChange(t){}_onTextureRemove(t){}_onSpriteAssetAdded(t){this._system.app.assets.off("add:"+t.id,this._onSpriteAssetAdded,this),this._spriteAsset===t.id&&this._bindSpriteAsset(t)}_bindSpriteAsset(t){this._entity.enabled&&(t.on("load",this._onSpriteAssetLoad,this),t.on("change",this._onSpriteAssetChange,this),t.on("remove",this._onSpriteAssetRemove,this),t.resource?this._onSpriteAssetLoad(t):this._system.app.assets.load(t))}_unbindSpriteAsset(t){t.off("load",this._onSpriteAssetLoad,this),t.off("change",this._onSpriteAssetChange,this),t.off("remove",this._onSpriteAssetRemove,this),t.data.textureAtlasAsset&&this._system.app.assets.off("load:"+t.data.textureAtlasAsset,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(t){if(t&&t.resource)if(t.resource.atlas)this.sprite=t.resource;else{const e=t.data.textureAtlasAsset;if(e){const t=this._system.app.assets;t.off("load:"+e,this._onTextureAtlasLoad,this),t.once("load:"+e,this._onTextureAtlasLoad,this)}}else this.sprite=null}_onSpriteAssetChange(t){this._onSpriteAssetLoad(t)}_onSpriteAssetRemove(t){}_bindSprite(t){t.on("set:meshes",this._onSpriteMeshesChange,this),t.on("set:pixelsPerUnit",this._onSpritePpuChange,this),t.on("set:atlas",this._onAtlasTextureChange,this),t.atlas&&t.atlas.on("set:texture",this._onAtlasTextureChange,this)}_unbindSprite(t){t.off("set:meshes",this._onSpriteMeshesChange,this),t.off("set:pixelsPerUnit",this._onSpritePpuChange,this),t.off("set:atlas",this._onAtlasTextureChange,this),t.atlas&&t.atlas.off("set:texture",this._onAtlasTextureChange,this)}_onSpriteMeshesChange(){this._sprite&&(this._spriteFrame=O.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}_onSpritePpuChange(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite()}_onAtlasTextureChange(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}_onTextureAtlasLoad(t){const e=this._spriteAsset;e instanceof Asset?this._onSpriteAssetLoad(e):this._onSpriteAssetLoad(this._system.app.assets.get(e))}onEnable(){if(this._materialAsset){const t=this._system.app.assets.get(this._materialAsset);t&&t.resource!==this._material&&this._bindMaterialAsset(t)}if(this._textureAsset){const t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==this._texture&&this._bindTextureAsset(t)}if(this._spriteAsset){const t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==this._sprite&&this._bindSpriteAsset(t)}this._element.addModelToLayers(this._renderable.model)}onDisable(){this._element.removeModelFromLayers(this._renderable.model)}_setStencil(t){this._renderable.meshInstance.stencilFront=t,this._renderable.meshInstance.stencilBack=t;let e=0;if(this._element.maskedBy&&(e=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){const t=new StencilParameters({ref:e+1,func:2,zpass:5});this._renderable.unmaskMeshInstance.stencilFront=t,this._renderable.unmaskMeshInstance.stencilBack=t}}set color(t){const e=t.r,s=t.g,i=t.b;this._color.r===e&&this._color.g===s&&this._color.b===i||(this._color.r=e,this._color.g=s,this._color.b=i,this._colorUniform[0]=e,this._colorUniform[1]=s,this._colorUniform[2]=i,this._renderable.setParameter("material_emissive",this._colorUniform)),this._element&&this._element.fire("set:color",this._color)}get color(){return this._color}set opacity(t){t!==this._color.a&&(this._color.a=t,this._renderable.setParameter("material_opacity",t)),this._element&&this._element.fire("set:opacity",t)}get opacity(){return this._color.a}set rect(t){let e,s,i,n;t instanceof Vec4?(e=t.x,s=t.y,i=t.z,n=t.w):(e=t[0],s=t[1],i=t[2],n=t[3]),e===this._rect.x&&s===this._rect.y&&i===this._rect.z&&n===this._rect.w||(this._rect.set(e,s,i,n),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}get rect(){return this._rect}set material(t){if(this._material!==t){if(!t){const e=this._element._isScreenSpace();t=this.mask?e?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:e?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}this._material=t,t&&(this._renderable.setMaterial(t),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}}get material(){return this._material}set materialAsset(t){const e=this._system.app.assets;let s=t;if(t instanceof Asset&&(s=t.id),this._materialAsset!==s){if(this._materialAsset){e.off("add:"+this._materialAsset,this._onMaterialAdded,this);const t=e.get(this._materialAsset);t&&(t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this))}if(this._materialAsset=s,this._materialAsset){const t=e.get(this._materialAsset);t?this._bindMaterialAsset(t):(this.material=null,e.on("add:"+this._materialAsset,this._onMaterialAdded,this))}else this.material=null}}get materialAsset(){return this._materialAsset}set texture(t){if(this._texture!==t){if(this._textureAsset){const e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==t&&(this.textureAsset=null)}this._texture=t,t?(this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}}get texture(){return this._texture}set textureAsset(t){const e=this._system.app.assets;let s=t;if(t instanceof Asset&&(s=t.id),this._textureAsset!==s){if(this._textureAsset){e.off("add:"+this._textureAsset,this._onTextureAdded,this);const t=e.get(this._textureAsset);t&&(t.off("load",this._onTextureLoad,this),t.off("change",this._onTextureChange,this),t.off("remove",this._onTextureRemove,this))}if(this._textureAsset=s,this._textureAsset){const t=e.get(this._textureAsset);t?this._bindTextureAsset(t):(this.texture=null,e.on("add:"+this._textureAsset,this._onTextureAdded,this))}else this.texture=null}}get textureAsset(){return this._textureAsset}set spriteAsset(t){const e=this._system.app.assets;let s=t;if(t instanceof Asset&&(s=t.id),this._spriteAsset!==s){if(this._spriteAsset){e.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);const t=e.get(this._spriteAsset);t&&this._unbindSpriteAsset(t)}if(this._spriteAsset=s,this._spriteAsset){const t=e.get(this._spriteAsset);t?this._bindSpriteAsset(t):(this.sprite=null,e.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}this._element&&this._element.fire("set:spriteAsset",s)}get spriteAsset(){return this._spriteAsset}set sprite(t){if(this._sprite!==t){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){const e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==t&&(this.spriteAsset=null)}this._sprite=t,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=O.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}get sprite(){return this._sprite}set spriteFrame(t){const e=this._spriteFrame;this._sprite?this._spriteFrame=O.clamp(t,0,this._sprite.frameKeys.length-1):this._spriteFrame=t,this._spriteFrame!==e&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",t)}get spriteFrame(){return this._spriteFrame}set mesh(t){this._renderable.setMesh(t),this._defaultMesh===t?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}get mesh(){return this._renderable.mesh}set mask(t){this._mask!==t&&(this._mask=t,this._toggleMask())}get mask(){return this._mask}set pixelsPerUnit(t){this._pixelsPerUnit!==t&&(this._pixelsPerUnit=t,!this._sprite||1!==this._sprite.renderMode&&2!==this._sprite.renderMode||this._updateSprite())}get pixelsPerUnit(){return this._pixelsPerUnit}get aabb(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}class LocalizedAsset extends EventHandler{constructor(t){super(),this._app=t,t.i18n.on("set:locale",this._onSetLocale,this),this._autoLoad=!1,this._disableLocalization=!1,this._defaultAsset=null,this._localizedAsset=null}set defaultAsset(t){const e=t instanceof Asset?t.id:t;this._defaultAsset!==e&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=e,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}get defaultAsset(){return this._defaultAsset}set localizedAsset(t){const e=t instanceof Asset?t.id:t;if(this._localizedAsset!==e&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=e,this._localizedAsset)){this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)}}get localizedAsset(){return this._localizedAsset}set autoLoad(t){this._autoLoad!==t&&(this._autoLoad=t,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()))}get autoLoad(){return this._autoLoad}set disableLocalization(t){this._disableLocalization!==t&&(this._disableLocalization=t,this._onSetLocale(this._app.i18n.locale))}get disableLocalization(){return this._disableLocalization}_bindDefaultAsset(){const t=this._app.assets.get(this._defaultAsset);t?this._onDefaultAssetAdd(t):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)}_unbindDefaultAsset(){if(!this._defaultAsset)return;this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);const t=this._app.assets.get(this._defaultAsset);t&&(t.off("add:localized",this._onLocaleAdd,this),t.off("remove:localized",this._onLocaleRemove,this),t.off("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetAdd(t){this._defaultAsset===t.id&&(t.on("add:localized",this._onLocaleAdd,this),t.on("remove:localized",this._onLocaleRemove,this),t.once("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetRemove(t){this._defaultAsset===t.id&&(t.off("add:localized",this._onLocaleAdd,this),t.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))}_bindLocalizedAsset(){if(!this._autoLoad)return;const t=this._app.assets.get(this._localizedAsset);t&&(t.on("load",this._onLocalizedAssetLoad,this),t.on("change",this._onLocalizedAssetChange,this),t.on("remove",this._onLocalizedAssetRemove,this),t.resource?this._onLocalizedAssetLoad(t):this._app.assets.load(t))}_unbindLocalizedAsset(){const t=this._app.assets.get(this._localizedAsset);t&&(t.off("load",this._onLocalizedAssetLoad,this),t.off("change",this._onLocalizedAssetChange,this),t.off("remove",this._onLocalizedAssetRemove,this))}_onLocalizedAssetAdd(t){this._localizedAsset===t.id&&this._bindLocalizedAsset()}_onLocalizedAssetLoad(t){this.fire("load",t)}_onLocalizedAssetChange(t,e,s,i){this.fire("change",t,e,s,i)}_onLocalizedAssetRemove(t){this._localizedAsset===t.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",t)}_onLocaleAdd(t,e){this._app.i18n.locale===t&&this._onSetLocale(t)}_onLocaleRemove(t,e){this._app.i18n.locale===t&&this._onSetLocale(t)}_onSetLocale(t){if(!this._defaultAsset)return void(this.localizedAsset=null);const e=this._app.assets.get(this._defaultAsset);if(!e||this._disableLocalization)return void(this.localizedAsset=this._defaultAsset);const s=e.getLocalizedAssetId(t);this.localizedAsset=s||this._defaultAsset}destroy(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()}}const Ul=/[A-Z|a-z|0-9|_|-|/]/;class Scanner{constructor(t){this._symbols=t,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}read(){let t=this._read();for(;8===t;)t=this._read();return 0!==t&&1!==t&&(this._last=this._index),t}buf(){return this._buf}last(){return this._last}error(){return this._error}debugPrint(){const t=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"];let e=this.read(),s="";for(;s+=(s.length>0?"\n":"")+t[e]+" '"+this.buf().join("")+"'",0!==e&&1!==e;)e=this.read();return s}_read(){return this._buf=[],this._eof()?0:"text"===this._mode?this._text():this._tag()}_text(){for(;;)switch(this._cur){case null:return this._buf.length>0?2:0;case"[":return this._mode="tag",this._buf.length>0?2:this._tag();case"\\":if(this._next(),"["===this._cur)this._store();else this._output("\\");break;default:this._store()}}_tag(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",1;case"[":return this._store(),3;case"]":return this._store(),this._mode="text",4;case"=":return this._store(),5;case" ":case"\t":case"\n":case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",1)}}_whitespace(){for(this._store();-1!==" \t\n\r\v\f".indexOf(this._cur);)this._store();return 8}_string(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",1;case'"':return this._next(),6;default:this._store()}}_identifier(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return 7}_isIdentifierSymbol(t){return 1===t.length&&null!==t.match(Ul)}_eof(){return null===this._cur}_next(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur}_store(){return this._buf.push(this._cur),this._next()}_output(t){this._buf.push(t)}}class Parser{constructor(t){this._scanner=new Scanner(t),this._error=null}parse(t,e){for(;;){switch(this._scanner.read()){case 0:return!0;case 1:default:return!1;case 2:Array.prototype.push.apply(t,this._scanner.buf());break;case 3:if(!this._parseTag(t,e))return!1}}}error(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"}_parseTag(t,e){let s=this._scanner.read();if(7!==s)return this._error="expected identifier",!1;const i=this._scanner.buf().join("");if("/"===i[0]){for(let n=e.length-1;n>=0;--n)if(i==="/"+e[n].name&&null===e[n].end)return e[n].end=t.length,s=this._scanner.read(),4===s||(this._error="expected close bracket",!1);return this._error="failed to find matching tag",!1}const n={name:i,value:null,attributes:{},start:t.length,end:null};if(s=this._scanner.read(),5===s){if(s=this._scanner.read(),6!==s)return this._error="expected string",!1;n.value=this._scanner.buf().join(""),s=this._scanner.read()}for(;;){switch(s){case 4:return e.push(n),!0;case 7:{const t=this._scanner.buf().join("");if(s=this._scanner.read(),5!==s)return this._error="expected equals",!1;if(s=this._scanner.read(),6!==s)return this._error="expected string",!1;const e=this._scanner.buf().join("");n.attributes[t]=e;break}default:return this._error="expected close bracket or identifier",!1}s=this._scanner.read()}}}function Nl(t,e){for(const s in e){if(!e.hasOwnProperty(s))continue;const i=e[s];i instanceof Object?(t.hasOwnProperty(s)||(t[s]={}),Nl(t[s],e[s])):t[s]=i}}function Hl(t){if(0===t.length)return null;const e={};for(let s=0;s<t.length;++s){const i=t[s],n={};n[i.name]={value:i.value,attributes:i.attributes},Nl(e,n)}return e}function Wl(t){const e=new Parser(t),s=[],i=[];if(!e.parse(s,i))return console.warn(e.error()),{symbols:t,tags:null};const n=i.find((function(t){return null===t.end}));if(n)return console.warn(`Markup error: found unclosed tag='${n.name}'`),{symbols:t,tags:null};const a=function(t,e){if(0===t.length)return null;const s={};for(let c=0;c<t.length;++c){const e=t[c];s.hasOwnProperty(e.start)?null===s[e.start].open?s[e.start].open=[e]:s[e.start].open.push(e):s[e.start]={open:[e],close:null},s.hasOwnProperty(e.end)?null===s[e.end].close?s[e.end].close=[e]:s[e.end].close.push(e):s[e.end]={open:null,close:[e]}}let i=[];function n(t){i=i.filter((function(e){return void 0===t.find((function(t){return t===e}))}))}function a(t){for(let e=0;e<t.length;++e)i.push(t[e])}const r=Object.keys(s).sort((function(t,e){return t-e})),o=[];for(let c=0;c<r.length;++c){const t=s[r[c]];null!==t.close&&n(t.close),null!==t.open&&a(t.open),o.push({start:r[c],tags:Hl(i)})}const l=[];let h=null;for(let c=0;c<o.length;++c){const t=o[c];for(;l.length<t.start;)l.push(h?h.tags:null);h=t}for(;l.length<e;)l.push(null);return l}(i,s.length);return{symbols:s,tags:a}}class MeshInfo{constructor(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.meshInstance=null}}const Gl=/^[\r\n]$/,jl=/^[ \t]$/,Xl=/^[ \t\-]|[\u200b]$/,ql=/^[a-z0-9]$/i,$l=/^[\u1100-\u11ff]|[\u3000-\u9fff]|[\ua960-\ua97f]|[\uac00-\ud7ff]$/,Yl=/^[〕〉》」』】〙〗〟ヽヾーァィゥェォッャュョヮヵヶぁぃぅぇぉっゃゅょゎゕゖㇰㇱㇲㇳㇴㇵㇶㇷㇸㇹㇺㇻㇼㇽㇾㇿ々〻]$/,Kl=["​","؜","‎","‏","‪","‫","‬","‭","‮","⁦","⁧","⁨","⁩"],Zl={width:0,height:0,xadvance:0,xoffset:0,yoffset:0};class TextElement{constructor(t){this._element=t,this._system=t.system,this._entity=t.entity,this._text="",this._symbols=[],this._colorPalette=[],this._symbolColors=null,this._i18nKey=null,this._fontAsset=new LocalizedAsset(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new Color(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=!1,this._autoFitHeight=!1,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new Vec2(.5,.5),this._autoWidth=!0,this._autoHeight=!0,this.width=0,this.height=0,this._node=new GraphNode,this._model=new Model,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new BoundingBox,this._noResize=!1,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=!1,this._unicodeConverter=!1,this._rtl=!1,this._outlineColor=new Color(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new Color(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new Vec2(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),t.on("resize",this._onParentResize,this),t.on("set:screen",this._onScreenChange,this),t.on("screen:set:screenspace",this._onScreenSpaceChange,this),t.on("set:draworder",this._onDrawOrderChange,this),t.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0}destroy(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)}_onParentResize(t,e){this._noResize||this._font&&this._updateText()}_onScreenChange(t){t?this._updateMaterial(t.screen.screenSpace):this._updateMaterial(!1)}_onScreenSpaceChange(t){this._updateMaterial(t)}_onDrawOrderChange(t){if(this._drawOrder=t,this._model)for(let e=0,s=this._model.meshInstances.length;e<s;e++)this._model.meshInstances[e].drawOrder=t}_onPivotChange(t){this._font&&this._updateText()}_onLocaleSet(t){if(this._i18nKey){if(this.fontAsset){const t=this._system.app.assets.get(this.fontAsset);t&&t.resource&&t.resource===this._font||(this.font=null)}this._resetLocalizedText()}}_onLocalizationData(t,e){this._i18nKey&&e[this._i18nKey]&&this._resetLocalizedText()}_resetLocalizedText(){this._setText(this._system.app.i18n.getText(this._i18nKey))}_setText(t){if(this.unicodeConverter){const e=this._system.getUnicodeConverter();e?t=e(t):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==t&&(this._font&&this._updateText(t),this._text=t)}_updateText(t){let e;if(void 0===t&&(t=this._text),this._symbols=D.getSymbols(t.normalize?t.normalize("NFC"):t),0===this._symbols.length&&(this._symbols=[" "]),this._enableMarkup){const t=class Markup{static evaluate(t){return Wl(t)}}.evaluate(this._symbols);this._symbols=t.symbols,e=t.tags}if(this._rtlReorder){const t=this._system.app.systems.element.getRtlReorder();if(t){const s=t(this._symbols);this._rtl=s.rtl,this._symbols=s.mapping.map((function(t){return this._symbols[t]}),this),e&&(e=s.mapping.map((function(t){return e[t]})))}else console.warn("Element created with rtlReorder option but no rtlReorder function registered")}else this._rtl=!1;if(e){const t={};this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._symbolColors=[],t[this._color.toString(!1).toLowerCase()]=0;for(let s=0,i=this._symbols.length;s<i;++s){const i=e[s];let n=0;if(i&&i.color&&i.color.value){const e=i.color.value;if(7===e.length&&"#"===e[0]){const s=e.substring(1).toLowerCase();t.hasOwnProperty(s)?n=t[s]:/^([0-9a-f]{2}){3}$/.test(s)&&(n=this._colorPalette.length/3,t[s]=n,this._colorPalette.push(parseInt(s.substring(0,2),16)),this._colorPalette.push(parseInt(s.substring(2,4),16)),this._colorPalette.push(parseInt(s.substring(4,6),16)))}}this._symbolColors.push(n)}}else this._colorPalette=[],this._symbolColors=null;const s=this._calculateCharsPerTexture();let i=!1;const n=this._element,a=n._isScreenSpace(),r=n._isScreenCulled(),o=function(t){return n.isVisibleForCamera(t)};for(let l=0,h=this._meshInfo.length;l<h;l++){const t=s[l]||0,e=this._meshInfo[l];if(e.count!==t){if(i||(n.removeModelFromLayers(this._model),i=!0),e.count=t,e.positions.length=e.normals.length=3*t*4,e.indices.length=3*t*2,e.uvs.length=2*t*4,e.colors.length=4*t*4,e.meshInstance&&this._removeMeshInstance(e.meshInstance),0===t){e.meshInstance=null;continue}for(let i=0;i<t;i++)e.indices[3*i*2+0]=4*i,e.indices[3*i*2+1]=4*i+1,e.indices[3*i*2+2]=4*i+3,e.indices[3*i*2+3]=4*i+2,e.indices[3*i*2+4]=4*i+3,e.indices[3*i*2+5]=4*i+1,e.normals[4*i*3+0]=0,e.normals[4*i*3+1]=0,e.normals[4*i*3+2]=-1,e.normals[4*i*3+3]=0,e.normals[4*i*3+4]=0,e.normals[4*i*3+5]=-1,e.normals[4*i*3+6]=0,e.normals[4*i*3+7]=0,e.normals[4*i*3+8]=-1,e.normals[4*i*3+9]=0,e.normals[4*i*3+10]=0,e.normals[4*i*3+11]=-1;const s=hi(this._system.app.graphicsDevice,e.positions,{uvs:e.uvs,normals:e.normals,colors:e.colors,indices:e.indices}),h=new MeshInstance(s,this._material,this._node);h.name="Text Element: "+this._entity.name,h.castShadow=!1,h.receiveShadow=!1,h.cull=!a,h.screenSpace=a,h.drawOrder=this._drawOrder,r&&(h.cull=!0,h.isVisibleFunc=o),this._setTextureParams(h,this._font.textures[l]),this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b),h.setParameter("material_emissive",this._colorUniform),h.setParameter("material_opacity",this._color.a),h.setParameter("font_sdfIntensity",this._font.intensity),h.setParameter("font_pxrange",this._getPxRange(this._font)),h.setParameter("font_textureWidth",this._font.data.info.maps[l].width),this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,h.setParameter("outline_color",this._outlineColorUniform),h.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,h.setParameter("shadow_color",this._shadowColorUniform);const c=-this._font.data.info.maps[l].width/this._font.data.info.maps[l].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=c*this._shadowOffsetScale*this._shadowOffset.y,h.setParameter("shadow_offset",this._shadowOffsetUniform),e.meshInstance=h,this._model.meshInstances.push(h)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),i&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()}_removeMeshInstance(t){t.destroy();const e=this._model.meshInstances.indexOf(t);-1!==e&&this._model.meshInstances.splice(e,1)}_setMaterial(t){if(this._material=t,this._model)for(let e=0,s=this._model.meshInstances.length;e<s;e++){this._model.meshInstances[e].material=t}}_updateMaterial(t){const e=this._element,s=e._isScreenCulled(),i=function(t){return e.isVisibleForCamera(t)},n=this._font&&this._font.type===Vr;if(this._material=this._system.getTextElementMaterial(t,n),this._model)for(let a=0,r=this._model.meshInstances.length;a<r;a++){const e=this._model.meshInstances[a];e.cull=!t,e.material=this._material,e.screenSpace=t,s?(e.cull=!0,e.isVisibleFunc=i):e.isVisibleFunc=null}}_isWordBoundary(t){return Xl.test(t)}_isValidNextChar(t){return null!==t&&!Yl.test(t)}_isNextCJKBoundary(t,e){return $l.test(t)&&(Xl.test(e)||ql.test(e))}_isNextCJKWholeWord(t){return $l.test(t)}_updateMeshes(){const t=this._font.data,e=this,s=Math.min(this._minFontSize,this._maxFontSize),i=this._maxFontSize,n=this._shouldAutoFit();n&&(this._fontSize=this._maxFontSize);const a=this._symbols.length;let r=0,o=0,l=0,h=0,c=1,d=0,u=0,p=0,m=0,_=0,f=0;const g=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4;let y=this._element.calculatedWidth;(this.autoWidth&&!g||!this._wrapLines)&&(y=Number.POSITIVE_INFINITY);let v,b,x,S,w=0,C=0;function T(t,s,i){e._lineWidths.push(Math.abs(i));const n=p>s?s+1:p,a=p>s?p+1:s,l=t.slice(n,a);if(f){let t=l.length;for(;t--&&f>0;)Gl.test(l[t])&&(l.splice(t,1),f--)}e._lineContents.push(l.join("")),r=0,o-=e._scaledLineHeight,c++,m=0,_=0,f=0,d=0,p=s}let M=!0;for(;M;){M=!1,this._scaledLineHeight=n?this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],r=0,o=0,l=0,h=0,c=1,d=0,u=0,p=0,m=0,_=0,f=0;const e=this._fontSize/32;w=this._fontMinY*e,C=this._fontMaxY*e;for(let t=0;t<this._meshInfo.length;t++)this._meshInfo[t].quad=0,this._meshInfo[t].lines={};let g=255,A=255,P=255;for(let n=0;n<a;n++){v=this._symbols[n],S=n+1>=a?null:this._symbols[n+1];if(Gl.test(v)){f++,(!this._wrapLines||this._maxLines<0||c<this._maxLines)&&(T(this._symbols,n,h),u=n+1,p=n+1);continue}let E,L,R=0,I=0,k=0,F=1;if(b=t.chars[v],!b)if(-1!==Kl.indexOf(v))b=Zl;else if(t.chars[" "])b=t.chars[" "];else for(const e in t.chars){b=t.chars[e];break}if(b){let t=0;if(_>0){const e=this._font.data.kerning;if(e){const s=e[D.getCodePoint(this._symbols[n-1])||0];s&&(t=s[D.getCodePoint(this._symbols[n])||0]||0)}}E=b.scale||1,L=(b.width+b.height)/2,F=e*L/E,k=(b.xadvance+t)*e,R=(b.xoffset-t)*e,I=b.yoffset*e}else console.error(`Couldn't substitute missing character: '${v}'`);const V=jl.test(v),B=this._meshInfo[b&&b.map||0],z=r+this._spacing*k;if(z>y&&_>0&&!V&&(this._maxLines<0||c<this._maxLines)){if(0!==m){const e=Math.max(n-u,0);if(this._meshInfo.length<=1)B.lines[c-1]-=e,B.quad-=e;else{const e=n;for(let s=u;s<e;s++){const e=this._symbols[s],i=t.chars[e],n=this._meshInfo[i&&i.map||0];n.lines[c-1]-=1,n.quad-=1}}n-=e+1,T(this._symbols,u,d);continue}u=n,T(this._symbols,n,h)}x=B.quad,B.lines[c-1]=x;let U=r-R,N=U+F;const H=o-I,W=H+F;if(this._rtl){const t=F-R-this._spacing*k-R;U-=t,N-=t}let G;if(B.positions[4*x*3+0]=U,B.positions[4*x*3+1]=H,B.positions[4*x*3+2]=l,B.positions[4*x*3+3]=N,B.positions[4*x*3+4]=H,B.positions[4*x*3+5]=l,B.positions[4*x*3+6]=N,B.positions[4*x*3+7]=W,B.positions[4*x*3+8]=l,B.positions[4*x*3+9]=U,B.positions[4*x*3+10]=W,B.positions[4*x*3+11]=l,this.width=Math.max(this.width,z),this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(G=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),G=O.clamp(G,s,i),G!==this._element.fontSize)){this._fontSize=G,M=!0;break}if(this.height=Math.max(this.height,C-(o+w)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(G=O.clamp(this._fontSize-1,s,i),G!==this._element.fontSize)){this._fontSize=G,M=!0;break}r+=this._spacing*k,V||(h=r),(this._isWordBoundary(v)||this._isValidNextChar(S)&&(this._isNextCJKBoundary(v,S)||this._isNextCJKWholeWord(S)))&&(m++,d=h,u=n+1),_++;const j=this._getUv(v);if(B.uvs[4*x*2+0]=j[0],B.uvs[4*x*2+1]=1-j[1],B.uvs[4*x*2+2]=j[2],B.uvs[4*x*2+3]=1-j[1],B.uvs[4*x*2+4]=j[2],B.uvs[4*x*2+5]=1-j[3],B.uvs[4*x*2+6]=j[0],B.uvs[4*x*2+7]=1-j[3],this._symbolColors){const t=3*this._symbolColors[n];g=this._colorPalette[t],A=this._colorPalette[t+1],P=this._colorPalette[t+2]}B.colors[4*x*4+0]=g,B.colors[4*x*4+1]=A,B.colors[4*x*4+2]=P,B.colors[4*x*4+3]=255,B.colors[4*x*4+4]=g,B.colors[4*x*4+5]=A,B.colors[4*x*4+6]=P,B.colors[4*x*4+7]=255,B.colors[4*x*4+8]=g,B.colors[4*x*4+9]=A,B.colors[4*x*4+10]=P,B.colors[4*x*4+11]=255,B.colors[4*x*4+12]=g,B.colors[4*x*4+13]=A,B.colors[4*x*4+14]=P,B.colors[4*x*4+15]=255,B.quad++}M||p<a&&T(this._symbols,a,r)}this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1;const A=this._element.pivot.x,P=this._element.pivot.y,E=this._alignment.x,L=this._alignment.y;for(let R=0;R<this._meshInfo.length;R++){if(0===this._meshInfo[R].count)continue;let t=0;for(const n in this._meshInfo[R].lines){const e=this._meshInfo[R].lines[n],s=this._lineWidths[parseInt(n,10)],i=-A*this._element.calculatedWidth+E*(this._element.calculatedWidth-s)*(this._rtl?-1:1),a=(1-P)*this._element.calculatedHeight-C-(1-L)*(this._element.calculatedHeight-this.height);for(let n=t;n<=e;n++)this._meshInfo[R].positions[4*n*3]+=i,this._meshInfo[R].positions[4*n*3+3]+=i,this._meshInfo[R].positions[4*n*3+6]+=i,this._meshInfo[R].positions[4*n*3+9]+=i,this._meshInfo[R].positions[4*n*3+1]+=a,this._meshInfo[R].positions[4*n*3+4]+=a,this._meshInfo[R].positions[4*n*3+7]+=a,this._meshInfo[R].positions[4*n*3+10]+=a;if(this._rtl)for(let n=t;n<=e;n++){const t=4*n*3;for(let n=0;n<4;++n)this._meshInfo[R].positions[t+3*n]=this._element.calculatedWidth-this._meshInfo[R].positions[t+3*n]+2*i;const e=this._meshInfo[R].positions[t+3],s=this._meshInfo[R].positions[t+6];this._meshInfo[R].positions[t+3]=this._meshInfo[R].positions[t+0],this._meshInfo[R].positions[t+6]=this._meshInfo[R].positions[t+9],this._meshInfo[R].positions[t+0]=e,this._meshInfo[R].positions[t+9]=s}t=e+1}const e=4*this._meshInfo[R].count,s=4*this._meshInfo[R].quad,i=new VertexIterator(this._meshInfo[R].meshInstance.mesh.vertexBuffer);for(let n=0;n<e;n++)n>=s?(i.element.POSITION.set(0,0,0),i.element.TEXCOORD0.set(0,0),i.element.COLOR.set(0,0,0,0)):(i.element.POSITION.set(this._meshInfo[R].positions[3*n+0],this._meshInfo[R].positions[3*n+1],this._meshInfo[R].positions[3*n+2]),i.element.TEXCOORD0.set(this._meshInfo[R].uvs[2*n+0],this._meshInfo[R].uvs[2*n+1]),i.element.COLOR.set(this._meshInfo[R].colors[4*n+0],this._meshInfo[R].colors[4*n+1],this._meshInfo[R].colors[4*n+2],this._meshInfo[R].colors[4*n+3])),i.next();i.end(),this._meshInfo[R].meshInstance.mesh.aabb.compute(this._meshInfo[R].positions),this._meshInfo[R].meshInstance._aabbVer=-1}this._aabbDirty=!0}_onFontRender(){this.font=this._font}_onFontLoad(t){this.font!==t.resource&&(this.font=t.resource)}_onFontChange(t,e,s,i){if("data"===e){this._font.data=s;const t=this._font.data.info.maps.length;for(let e=0;e<t;e++){if(!this._meshInfo[e])continue;const t=this._meshInfo[e].meshInstance;t&&(t.setParameter("font_sdfIntensity",this._font.intensity),t.setParameter("font_pxrange",this._getPxRange(this._font)),t.setParameter("font_textureWidth",this._font.data.info.maps[e].width))}}}_onFontRemove(t){}_setTextureParams(t,e){this._font&&(this._font.type===Vr?(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap"),t.setParameter("texture_msdfMap",e)):"bitmap"===this._font.type&&(t.deleteParameter("texture_msdfMap"),t.setParameter("texture_emissiveMap",e),t.setParameter("texture_opacityMap",e)))}_getPxRange(t){const e=Object.keys(this._font.data.chars);for(let s=0;s<e.length;s++){const t=this._font.data.chars[e[s]];if(t.range)return(t.scale||1)*t.range}return 2}_getUv(t){const e=this._font.data;if(!e.chars[t]){const t=" ";return e.chars[t]?this._getUv(t):[0,0,0,0]}const s=e.chars[t].map,i=e.info.maps[s].width,n=e.info.maps[s].height,a=e.chars[t].x,r=e.chars[t].y,o=a,l=r,h=a+e.chars[t].width,c=r-e.chars[t].height,d=1-e.chars[t].height/n;return[o/i,d-l/n,h/i,d-c/n]}onEnable(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)}onDisable(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)}_setStencil(t){if(this._model){const e=this._model.meshInstances;for(let s=0;s<e.length;s++)e[s].stencilFront=t,e[s].stencilBack=t}}_shouldAutoFitWidth(){return this._autoFitWidth&&!this._autoWidth}_shouldAutoFitHeight(){return this._autoFitHeight&&!this._autoHeight}_shouldAutoFit(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight}_calculateCharsPerTexture(t){const e={};void 0===t&&(t=this._symbols.length);for(let s=0,i=t;s<i;s++){const t=this._symbols[s];let i=this._font.data.chars[t];i||(i=this._font.data.chars[" "],i||(i=this._font.data.chars[Object.keys(this._font.data.chars)[0]]));const n=i.map;e[n]?e[n]++:e[n]=1}return e}_updateRenderRange(){const t=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),e=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd);for(let s=0,i=this._meshInfo.length;s<i;s++){const i=t[s]||0,n=e[s]||0,a=this._meshInfo[s].meshInstance;if(a){const t=a.mesh;t&&(t.primitive[0].base=3*i*2,t.primitive[0].count=3*(n-i)*2)}}}set text(t){this._i18nKey=null;const e=null!=t&&t.toString()||"";this._setText(e)}get text(){return this._text}set key(t){const e=null!==t?t.toString():null;this._i18nKey!==e&&(this._i18nKey=e,e?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}get key(){return this._i18nKey}set color(t){const e=t.r,s=t.g,i=t.b;if(this._color.r!==e||this._color.g!==s||this._color.b!==i)if(this._color.r=e,this._color.g=s,this._color.b=i,this._symbolColors)this._font&&this._updateText();else{this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b;for(let t=0,e=this._model.meshInstances.length;t<e;t++){this._model.meshInstances[t].setParameter("material_emissive",this._colorUniform)}}this._element&&this._element.fire("set:color",this._color)}get color(){return this._color}set opacity(t){if(this._color.a!==t&&(this._color.a=t,this._model))for(let e=0,s=this._model.meshInstances.length;e<s;e++){this._model.meshInstances[e].setParameter("material_opacity",t)}this._element&&this._element.fire("set:opacity",t)}get opacity(){return this._color.a}set lineHeight(t){const e=this._lineHeight;this._lineHeight=t,this._scaledLineHeight=t,e!==t&&this._font&&this._updateText()}get lineHeight(){return this._lineHeight}set wrapLines(t){const e=this._wrapLines;this._wrapLines=t,e!==t&&this._font&&this._updateText()}get wrapLines(){return this._wrapLines}get lines(){return this._lineContents}set spacing(t){const e=this._spacing;this._spacing=t,e!==t&&this._font&&this._updateText()}get spacing(){return this._spacing}set fontSize(t){const e=this._fontSize;this._fontSize=t,this._originalFontSize=t,e!==t&&this._font&&this._updateText()}get fontSize(){return this._fontSize}set fontAsset(t){this._fontAsset.defaultAsset=t}get fontAsset(){return this._fontAsset.localizedAsset}set font(t){let e;if(this._font&&(e=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=t,this._fontMinY=0,this._fontMaxY=0,!t)return;const s=this._font.data;for(const n in s.chars){const t=s.chars[n];t.bounds&&(this._fontMinY=Math.min(this._fontMinY,t.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,t.bounds[3]))}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset){this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null)}if(t.type!==e){const t=this._element._isScreenSpace();this._updateMaterial(t)}for(let n=0,a=this._font.textures.length;n<a;n++)if(this._meshInfo[n]){const t=this._meshInfo[n].meshInstance;t&&(t.setParameter("font_sdfIntensity",this._font.intensity),t.setParameter("font_pxrange",this._getPxRange(this._font)),t.setParameter("font_textureWidth",this._font.data.info.maps[n].width),this._setTextureParams(t,this._font.textures[n]))}else this._meshInfo[n]=new MeshInfo;let i=!1;for(let n=this._font.textures.length;n<this._meshInfo.length;n++)this._meshInfo[n].meshInstance&&(i||(this._element.removeModelFromLayers(this._model),i=!0),this._removeMeshInstance(this._meshInfo[n].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}get font(){return this._font}set alignment(t){t instanceof Vec2?this._alignment.set(t.x,t.y):this._alignment.set(t[0],t[1]),this._font&&this._updateText()}get alignment(){return this._alignment}set autoWidth(t){const e=this._autoWidth;if(this._autoWidth=t,t&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4&&(this._element.width=this.width),e!==t){const t=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;t!==this._fontSize&&(this._fontSize=t,this._font&&this._updateText())}}get autoWidth(){return this._autoWidth}set autoHeight(t){const e=this._autoHeight;if(this._autoHeight=t,t&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4&&(this._element.height=this.height),e!==t){const t=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;t!==this._fontSize&&(this._fontSize=t,this._font&&this._updateText())}}get autoHeight(){return this._autoHeight}set rtlReorder(t){this._rtlReorder!==t&&(this._rtlReorder=t,this._font&&this._updateText())}get rtlReorder(){return this._rtlReorder}set unicodeConverter(t){this._unicodeConverter!==t&&(this._unicodeConverter=t,this._setText(this._text))}get unicodeConverter(){return this._unicodeConverter}get aabb(){if(this._aabbDirty){let t=!1;for(let e=0;e<this._meshInfo.length;e++)this._meshInfo[e].meshInstance&&(t?this._aabb.add(this._meshInfo[e].meshInstance.aabb):(this._aabb.copy(this._meshInfo[e].meshInstance.aabb),t=!0));this._aabbDirty=!1}return this._aabb}set outlineColor(t){const e=t instanceof Color?t.r:t[0],s=t instanceof Color?t.g:t[1],i=t instanceof Color?t.b:t[2],n=t instanceof Color?t.a:t[3];if((this._outlineColor.r!==e||this._outlineColor.g!==s||this._outlineColor.b!==i||this._outlineColor.a!==n)&&(this._outlineColor.r=e,this._outlineColor.g=s,this._outlineColor.b=i,this._outlineColor.a=n,this._model)){this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a;for(let t=0,e=this._model.meshInstances.length;t<e;t++){this._model.meshInstances[t].setParameter("outline_color",this._outlineColorUniform)}}}get outlineColor(){return this._outlineColor}set outlineThickness(t){const e=this._outlineThickness;if(this._outlineThickness=t,e!==t&&this._font&&this._model)for(let s=0,i=this._model.meshInstances.length;s<i;s++){this._model.meshInstances[s].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}get outlineThickness(){return this._outlineThickness}set shadowColor(t){const e=t instanceof Color?t.r:t[0],s=t instanceof Color?t.g:t[1],i=t instanceof Color?t.b:t[2],n=t instanceof Color?t.a:t[3];if((this._shadowColor.r!==e||this._shadowColor.g!==s||this._shadowColor.b!==i||this._shadowColor.a!==n)&&(this._shadowColor.r=e,this._shadowColor.g=s,this._shadowColor.b=i,this._shadowColor.a=n,this._model)){this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a;for(let t=0,e=this._model.meshInstances.length;t<e;t++){this._model.meshInstances[t].setParameter("shadow_color",this._shadowColorUniform)}}}get shadowColor(){return this._shadowColor}set shadowOffset(t){const e=t instanceof Vec2?t.x:t[0],s=t instanceof Vec2?t.y:t[1];if((this._shadowOffset.x!==e||this._shadowOffset.y!==s)&&(this._shadowOffset.set(e,s),this._font&&this._model))for(let i=0,n=this._model.meshInstances.length;i<n;i++){const t=-this._font.data.info.maps[i].width/this._font.data.info.maps[i].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=t*this._shadowOffsetScale*this._shadowOffset.y;this._model.meshInstances[i].setParameter("shadow_offset",this._shadowOffsetUniform)}}get shadowOffset(){return this._shadowOffset}set minFontSize(t){this._minFontSize!==t&&(this._minFontSize=t,this.font&&this._shouldAutoFit()&&this._updateText())}get minFontSize(){return this._minFontSize}set maxFontSize(t){this._maxFontSize!==t&&(this._maxFontSize=t,this.font&&this._shouldAutoFit()&&this._updateText())}get maxFontSize(){return this._maxFontSize}set autoFitWidth(t){this._autoFitWidth!==t&&(this._autoFitWidth=t,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitWidth(){return this._autoFitWidth}set autoFitHeight(t){this._autoFitHeight!==t&&(this._autoFitHeight=t,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitHeight(){return this._autoFitHeight}set maxLines(t){this._maxLines!==t&&(null===t&&-1===this._maxLines||(this._maxLines=null===t?-1:t,this.font&&this._wrapLines&&this._updateText()))}get maxLines(){return this._maxLines}set enableMarkup(t){t=!!t,this._enableMarkup!==t&&(this._enableMarkup=t,this.font&&this._updateText())}get enableMarkup(){return this._enableMarkup}get symbols(){return this._symbols}get symbolColors(){return null===this._symbolColors?null:this._symbolColors.map((function(t){return this._colorPalette.slice(3*t,3*t+3)}),this)}get rtl(){return this._rtl}set rangeStart(t){(t=Math.max(0,Math.min(t,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=t,this._updateRenderRange())}get rangeStart(){return this._rangeStart}set rangeEnd(t){(t=Math.max(this._rangeStart,Math.min(t,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=t,this._updateRenderRange())}get rangeEnd(){return this._rangeEnd}}const Ql=new Vec3,Jl=new Mat4,th=new Vec3,eh=new Vec3,sh=new Mat4,ih=new Mat4,nh=new Mat4,ah=new Mat4;class ElementComponent extends Component{constructor(t,e){super(t,e),this._beingInitialized=!1,this._anchor=new Vec4,this._localAnchor=new Vec4,this._pivot=new Vec2,this._width=this._calculatedWidth=32,this._height=this._calculatedHeight=32,this._margin=new Vec4(0,0,-32,-32),this._modelTransform=new Mat4,this._screenToWorld=new Mat4,this._anchorTransform=new Mat4,this._anchorDirty=!0,this._parentWorldTransform=new Mat4,this._screenTransform=new Mat4,this._screenCorners=[new Vec3,new Vec3,new Vec3,new Vec3],this._canvasCorners=[new Vec2,new Vec2,new Vec2,new Vec2],this._worldCorners=[new Vec3,new Vec3,new Vec3,new Vec3],this._cornersDirty=!0,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type=pl,this._image=null,this._text=null,this._group=null,this._drawOrder=0,this._useInput=!1,this._layers=[4],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null}get _absLeft(){return this._localAnchor.x+this._margin.x}get _absRight(){return this._localAnchor.z-this._margin.z}get _absTop(){return this._localAnchor.w-this._margin.w}get _absBottom(){return this._localAnchor.y+this._margin.y}get _hasSplitAnchorsX(){return Math.abs(this._anchor.x-this._anchor.z)>.001}get _hasSplitAnchorsY(){return Math.abs(this._anchor.y-this._anchor.w)>.001}get aabb(){return this._image?this._image.aabb:this._text?this._text.aabb:null}set anchor(t){t instanceof Vec4?this._anchor.set(t.x,t.y,t.z,t.w):this._anchor.set(t[0],t[1],t[2],t[3]),this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}get anchor(){return this._anchor}set batchGroupId(t){this._batchGroupId!==t&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher.remove(BatchGroup.ELEMENT,this.batchGroupId,this.entity),this.entity.enabled&&t>=0&&this.system.app.batcher.insert(BatchGroup.ELEMENT,t,this.entity),t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=t)}get batchGroupId(){return this._batchGroupId}set bottom(t){this._margin.y=t;const e=this.entity.getLocalPosition(),s=this._absTop,i=this._localAnchor.y+t;this._setHeight(s-i),e.y=t+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(e)}get bottom(){return this._margin.y}set calculatedWidth(t){this._setCalculatedWidth(t,!0)}get calculatedWidth(){return this._calculatedWidth}set calculatedHeight(t){this._setCalculatedHeight(t,!0)}get calculatedHeight(){return this._calculatedHeight}get canvasCorners(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;const t=this.system.app.graphicsDevice,e=this.screenCorners,s=t.canvas.clientWidth/t.width,i=t.canvas.clientHeight/t.height;for(let n=0;n<4;n++)this._canvasCorners[n].set(e[n].x*s,(t.height-e[n].y)*i);return this._canvasCornersDirty=!1,this._canvasCorners}set drawOrder(t){let e=0;this.screen&&(e=this.screen.screen.priority),t>16777215&&(t=16777215),this._drawOrder=(e<<24)+t,this.fire("set:draworder",this._drawOrder)}get drawOrder(){return this._drawOrder}set height(t){this._height=t,this._hasSplitAnchorsY||this._setCalculatedHeight(t,!0),this.fire("set:height",this._height)}get height(){return this._height}set layers(t){if(this._addedModels.length)for(let e=0;e<this._layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this._layers[e]);if(t)for(let e=0;e<this._addedModels.length;e++)t.removeMeshInstances(this._addedModels[e].meshInstances)}if(this._layers=t,this.enabled&&this.entity.enabled&&this._addedModels.length)for(let e=0;e<this._layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this._layers[e]);if(t)for(let e=0;e<this._addedModels.length;e++)t.addMeshInstances(this._addedModels[e].meshInstances)}}get layers(){return this._layers}set left(t){this._margin.x=t;const e=this.entity.getLocalPosition(),s=this._absRight,i=this._localAnchor.x+t;this._setWidth(s-i),e.x=t+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(e)}get left(){return this._margin.x}set margin(t){this._margin.copy(t),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}get margin(){return this._margin}get maskedBy(){return this._maskedBy}set pivot(t){const e=this._pivot.x,s=this._pivot.y;t instanceof Vec2?this._pivot.set(t.x,t.y):this._pivot.set(t[0],t[1]);const i=this._margin.x+this._margin.z,n=this._pivot.x-e;this._margin.x+=i*n,this._margin.z-=i*n;const a=this._margin.y+this._margin.w,r=this._pivot.y-s;this._margin.y+=a*r,this._margin.w-=a*r,this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",this._pivot)}get pivot(){return this._pivot}set right(t){this._margin.z=t;const e=this.entity.getLocalPosition(),s=this._absLeft,i=this._localAnchor.z-t;this._setWidth(i-s),e.x=this._localAnchor.z-this._localAnchor.x-t-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(e)}get right(){return this._margin.z}get screenCorners(){if(!this._cornersDirty||!this.screen)return this._screenCorners;const t=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);const e=this.screen.screen.screenSpace;for(let s=0;s<4;s++)this._screenTransform.transformPoint(this._screenCorners[s],this._screenCorners[s]),e&&this._screenCorners[s].mulScalar(this.screen.screen.scale),t&&this._screenCorners[s].add(t);return this._cornersDirty=!1,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this._screenCorners}get textWidth(){return this._text?this._text.width:0}get textHeight(){return this._text?this._text.height:0}set top(t){this._margin.w=t;const e=this.entity.getLocalPosition(),s=this._absBottom,i=this._localAnchor.w-t;this._setHeight(i-s),e.y=this._localAnchor.w-this._localAnchor.y-t-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(e)}get top(){return this._margin.w}set type(t){t!==this._type&&(this._type=t,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),t===ml?this._image=new ImageElement(this):t===_l&&(this._text=new TextElement(this)))}get type(){return this._type}set useInput(t){this._useInput!==t&&(this._useInput=t,this.system.app.elementInput?t?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):!0===this._useInput&&console.warn("Elements will not get any input events because this.system.app.elementInput is not created"),this.fire("set:useInput",t))}get useInput(){return this._useInput}set width(t){this._width=t,this._hasSplitAnchorsX||this._setCalculatedWidth(t,!0),this.fire("set:width",this._width)}get width(){return this._width}get worldCorners(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){const t=this.screenCorners;if(!this.screen.screen.screenSpace){sh.copy(this.screen.screen._screenMatrix),sh.data[13]=-sh.data[13],sh.mul2(this.screen.getWorldTransform(),sh);for(let e=0;e<4;e++)sh.transformPoint(t[e],this._worldCorners[e])}}else{const t=this.entity.getLocalPosition();sh.setTranslate(-t.x,-t.y,-t.z),ih.setTRS(Vec3.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),nh.setTranslate(t.x,t.y,t.z);const e=this.entity.parent?this.entity.parent:this.entity;ah.copy(e.getWorldTransform()),ah.mul(nh).mul(ih).mul(sh),th.set(t.x-this.pivot.x*this.calculatedWidth,t.y-this.pivot.y*this.calculatedHeight,t.z),ah.transformPoint(th,this._worldCorners[0]),th.set(t.x+(1-this.pivot.x)*this.calculatedWidth,t.y-this.pivot.y*this.calculatedHeight,t.z),ah.transformPoint(th,this._worldCorners[1]),th.set(t.x+(1-this.pivot.x)*this.calculatedWidth,t.y+(1-this.pivot.y)*this.calculatedHeight,t.z),ah.transformPoint(th,this._worldCorners[2]),th.set(t.x-this.pivot.x*this.calculatedWidth,t.y+(1-this.pivot.y)*this.calculatedHeight,t.z),ah.transformPoint(th,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}_patch(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition}_unpatch(){this.entity._sync=Entity.prototype._sync,this.entity.setPosition=Entity.prototype.setPosition,this.entity.setLocalPosition=Entity.prototype.setLocalPosition}_setPosition(t,e,s){if(!this.element.screen)return Entity.prototype.setPosition.call(this,t,e,s);t instanceof Vec3?Ql.copy(t):Ql.set(t,e,s),this.getWorldTransform(),Jl.copy(this.element._screenToWorld).invert(),Jl.transformPoint(Ql,this.localPosition),this._dirtyLocal||this._dirtifyLocal()}_setLocalPosition(t,e,s){t instanceof Vec3?this.localPosition.copy(t):this.localPosition.set(t,e,s);const i=this.element,n=this.localPosition,a=i._pivot;i._margin.x=n.x-i._calculatedWidth*a.x,i._margin.z=i._localAnchor.z-i._localAnchor.x-i._calculatedWidth-i._margin.x,i._margin.y=n.y-i._calculatedHeight*a.y,i._margin.w=i._localAnchor.w-i._localAnchor.y-i._calculatedHeight-i._margin.y,this._dirtyLocal||this._dirtifyLocal()}_sync(){const t=this.element,e=t.screen;if(e){if(t._anchorDirty){let s=0,i=0,n=0,a=1;if(this._parent&&this._parent.element)s=this._parent.element.calculatedWidth,i=this._parent.element.calculatedHeight,n=this._parent.element.pivot.x,a=this._parent.element.pivot.y;else{const t=e.screen.resolution;s=t.x/e.screen.scale,i=t.y/e.screen.scale}t._anchorTransform.setTranslate(s*(t.anchor.x-n),-i*(a-t.anchor.y),0),t._anchorDirty=!1,t._calculateLocalAnchors()}t._sizeDirty&&t._calculateSize(!1,!1)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);const e=this.localPosition,s=t._pivot;t._margin.x=e.x-t._calculatedWidth*s.x,t._margin.z=t._localAnchor.z-t._localAnchor.x-t._calculatedWidth-t._margin.x,t._margin.y=e.y-t._calculatedHeight*s.y,t._margin.w=t._localAnchor.w-t._localAnchor.y-t._calculatedHeight-t._margin.y,this._dirtyLocal=!1}if(!e)return this._dirtyWorld&&(t._cornersDirty=!0,t._canvasCornersDirty=!0,t._worldCornersDirty=!0),Entity.prototype._sync.call(this);if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this._parent.element?t._screenToWorld.mul2(this._parent.element._modelTransform,t._anchorTransform):t._screenToWorld.copy(t._anchorTransform),t._modelTransform.mul2(t._screenToWorld,this.localTransform),e){t._screenToWorld.mul2(e.screen._screenMatrix,t._screenToWorld),e.screen.screenSpace||t._screenToWorld.mul2(e.worldTransform,t._screenToWorld),this.worldTransform.mul2(t._screenToWorld,this.localTransform);const s=t._parentWorldTransform;s.setIdentity();const i=this._parent;i&&i.element&&i!==e&&(sh.setTRS(Vec3.ZERO,i.getLocalRotation(),i.getLocalScale()),s.mul2(i.element._parentWorldTransform,sh));const n=th;n.set(0,0,this.localPosition.z);const a=eh;a.set(t._absLeft+t._pivot.x*t.calculatedWidth,t._absBottom+t._pivot.y*t.calculatedHeight,0),sh.setTranslate(-a.x,-a.y,-a.z),ih.setTRS(n,this.getLocalRotation(),this.getLocalScale()),nh.setTranslate(a.x,a.y,a.z),t._screenTransform.mul2(t._parentWorldTransform,nh).mul(ih).mul(sh),t._cornersDirty=!0,t._canvasCornersDirty=!0,t._worldCornersDirty=!0}else this.worldTransform.copy(t._modelTransform);this._dirtyWorld=!1}}_onInsert(t){const e=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(e.screen),this._dirtifyMask()}_dirtifyMask(){let t=this.entity;for(;t;){const e=t.parent;if((null===e||e.screen)&&t.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));const e=this.system._prerender.indexOf(this.entity);e>=0&&this.system._prerender.splice(e,1);this.system._prerender.indexOf(t)<0&&this.system._prerender.push(t)}t=e}}_onPrerender(){for(let t=0;t<this.system._prerender.length;t++){const e=this.system._prerender[t];if(e.element){const t=1;e.element.syncMask(t)}}this.system._prerender.length=0}_bindScreen(t){t._bindElement(this)}_unbindScreen(t){t._unbindElement(this)}_updateScreen(t){this.screen&&this.screen!==t&&this._unbindScreen(this.screen.screen);const e=this.screen;this.screen=t,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,e),this._anchorDirty=!0;const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateScreen(t);this.screen&&this.screen.screen.syncDrawOrder()}syncMask(t){const e=this._parseUpToScreen();this._updateMask(e.mask,t)}_setMaskedBy(t){const e=this._image||this._text;if(t){const s=t.element._image._maskRef,i=new StencilParameters({ref:s,func:2});e&&e._setStencil&&e._setStencil(i),this._maskedBy=t}else e&&e._setStencil&&e._setStencil(null),this._maskedBy=null}_updateMask(t,e){if(t){if(this._setMaskedBy(t),this.mask){const s=t.element._image._maskRef,i=new StencilParameters({ref:s,func:2,zpass:3});this._image._setStencil(i),this._image._maskRef=e,e++,t=this.entity}const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateMask(t,e);this.mask&&e--}else{if(this._setMaskedBy(null),this.mask){const s=new StencilParameters({ref:e,func:7,zpass:2});this._image._setStencil(s),this._image._maskRef=e,e++,t=this.entity}const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateMask(t,e);this.mask&&e--}}_parseUpToScreen(){const t={screen:null,mask:null};let e=this.entity._parent;for(;e&&!e.screen;)e.element&&e.element.mask&&(t.mask||(t.mask=e)),e=e.parent;return e&&e.screen&&(t.screen=e),t}_onScreenResize(t){this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",t)}_onScreenSpaceChange(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)}_onScreenRemove(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))}_calculateLocalAnchors(){let t=1e3,e=1e3;const s=this.entity._parent;if(s&&s.element)t=s.element.calculatedWidth,e=s.element.calculatedHeight;else if(this.screen){const s=this.screen.screen.resolution,i=this.screen.screen.scale;t=s.x/i,e=s.y/i}this._localAnchor.set(this._anchor.x*t,this._anchor.y*e,this._anchor.z*t,this._anchor.w*e)}getOffsetPosition(t,e){const s=this.entity.getLocalPosition().clone();return s.x+=t,s.y+=e,this._screenToWorld.transformPoint(s,s),s}onLayersChanged(t,e){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||(this._image?t.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&t.addMeshInstances(this._text._model.meshInstances))}onLayerRemoved(t){this.layers.indexOf(t.id)<0||(this._image?t.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&t.removeMeshInstances(this._text._model.meshInstances))}onEnable(){this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&this.system.app.batcher.insert(BatchGroup.ELEMENT,this.batchGroupId,this.entity),this.fire("enableelement")}onDisable(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0&&this.system.app.batcher.remove(BatchGroup.ELEMENT,this.batchGroupId,this.entity),this.fire("disableelement")}onRemove(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()}_calculateSize(t,e){if(!this.entity._parent&&!this.screen)return;this._calculateLocalAnchors();const s=this._absRight-this._absLeft,i=this._absTop-this._absBottom;t?this._setWidth(s):this._setCalculatedWidth(s,!1),e?this._setHeight(i):this._setCalculatedHeight(i,!1);const n=this.entity.getLocalPosition();n.x=this._margin.x+this._calculatedWidth*this._pivot.x,n.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(n),this._sizeDirty=!1}_setWidth(t){this._width=t,this._setCalculatedWidth(t,!1),this.fire("set:width",this._width)}_setHeight(t){this._height=t,this._setCalculatedHeight(t,!1),this.fire("set:height",this._height)}_setCalculatedWidth(t,e){if(!(Math.abs(t-this._calculatedWidth)<=1e-4)){if(this._calculatedWidth=t,this.entity._dirtifyLocal(),e){const t=this.entity.getLocalPosition(),e=this._pivot;this._margin.x=t.x-this._calculatedWidth*e.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_setCalculatedHeight(t,e){if(!(Math.abs(t-this._calculatedHeight)<=1e-4)){if(this._calculatedHeight=t,this.entity._dirtifyLocal(),e){const t=this.entity.getLocalPosition(),e=this._pivot;this._margin.y=t.y-this._calculatedHeight*e.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_flagChildrenAsDirty(){const t=this.entity._children;for(let e=0,s=t.length;e<s;e++)t[e].element&&(t[e].element._anchorDirty=!0,t[e].element._sizeDirty=!0)}addModelToLayers(t){this._addedModels.push(t);for(let e=0;e<this.layers.length;e++){const s=this.system.app.scene.layers.getLayerById(this.layers[e]);s&&s.addMeshInstances(t.meshInstances)}}removeModelFromLayers(t){const e=this._addedModels.indexOf(t);e>=0&&this._addedModels.splice(e,1);for(let s=0;s<this.layers.length;s++){const e=this.system.app.scene.layers.getLayerById(this.layers[s]);e&&e.removeMeshInstances(t.meshInstances)}}getMaskOffset(){const t=this.system.app.frame;this._offsetReadAt!==t&&(this._maskOffset=.5,this._offsetReadAt=t);const e=this._maskOffset;return this._maskOffset-=.001,e}isVisibleForCamera(t){let e,s,i,n;if(this.maskedBy){const t=this.maskedBy.element.screenCorners;e=Math.min(Math.min(t[0].x,t[1].x),Math.min(t[2].x,t[3].x)),s=Math.max(Math.max(t[0].x,t[1].x),Math.max(t[2].x,t[3].x)),n=Math.min(Math.min(t[0].y,t[1].y),Math.min(t[2].y,t[3].y)),i=Math.max(Math.max(t[0].y,t[1].y),Math.max(t[2].y,t[3].y))}else{const a=this.system.app.graphicsDevice.width,r=this.system.app.graphicsDevice.height,o=t._rect.z*a,l=t._rect.w*r;e=t._rect.x*a,s=e+o,i=(1-t._rect.y)*r,n=i-l}const a=this.screenCorners,r=Math.min(Math.min(a[0].x,a[1].x),Math.min(a[2].x,a[3].x)),o=Math.max(Math.max(a[0].x,a[1].x),Math.max(a[2].x,a[3].x)),l=Math.min(Math.min(a[0].y,a[1].y),Math.min(a[2].y,a[3].y)),h=Math.max(Math.max(a[0].y,a[1].y),Math.max(a[2].y,a[3].y));return!(o<e||r>s||l>i||h<n)}_isScreenSpace(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.screenSpace}_isScreenCulled(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.cull}}function rh(t){Object.defineProperty(ElementComponent.prototype,t,{get:function(){return this._text?this._text[t]:this._image?this._image[t]:null},set:function(e){this._text?this._text[t]=e:this._image&&(this._image[t]=e)}})}rh("fontSize"),rh("minFontSize"),rh("maxFontSize"),rh("maxLines"),rh("autoFitWidth"),rh("autoFitHeight"),rh("color"),rh("font"),rh("fontAsset"),rh("spacing"),rh("lineHeight"),rh("wrapLines"),rh("lines"),rh("alignment"),rh("autoWidth"),rh("autoHeight"),rh("rtlReorder"),rh("unicodeConverter"),rh("text"),rh("key"),rh("texture"),rh("textureAsset"),rh("material"),rh("materialAsset"),rh("sprite"),rh("spriteAsset"),rh("spriteFrame"),rh("pixelsPerUnit"),rh("opacity"),rh("rect"),rh("mask"),rh("outlineColor"),rh("outlineThickness"),rh("shadowColor"),rh("shadowOffset"),rh("enableMarkup"),rh("rangeStart"),rh("rangeEnd");class ElementComponentData{constructor(){this.enabled=!0}}const oh=["enabled"];class ElementComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="element",this.ComponentType=ElementComponent,this.DataType=ElementComponentData,this.schema=oh,this._unicodeConverter=null,this._rtlReorder=null,this._defaultTexture=new Texture(t.graphicsDevice,{width:1,height:1,format:7}),this._defaultTexture.name="element-system";const e=this._defaultTexture.lock(),s=new Uint8Array(4);s[0]=255,s[1]=255,s[2]=255,s[3]=255,e.set(s),this._defaultTexture.unlock(),this.defaultImageMaterial=null,this.defaultImage9SlicedMaterial=null,this.defaultImage9TiledMaterial=null,this.defaultImageMaskMaterial=null,this.defaultImage9SlicedMaskMaterial=null,this.defaultImage9TiledMaskMaterial=null,this.defaultScreenSpaceImageMaterial=null,this.defaultScreenSpaceImage9SlicedMaterial=null,this.defaultScreenSpaceImage9TiledMaterial=null,this.defaultScreenSpaceImageMask9SlicedMaterial=null,this.defaultScreenSpaceImageMask9TiledMaterial=null,this.defaultScreenSpaceImageMaskMaterial=null,this.defaultTextMaterial=null,this.defaultBitmapTextMaterial=null,this.defaultScreenSpaceTextMaterial=null,this.defaultScreenSpaceBitmapTextMaterial=null,this.defaultImageMaterials=[],this.on("beforeremove",this.onRemoveComponent,this)}destroy(){super.destroy(),this._defaultTexture.destroy()}initializeComponentData(t,e,s){t._beingInitialized=!0,void 0!==e.anchor&&(e.anchor instanceof Vec4?t.anchor.copy(e.anchor):t.anchor.set(e.anchor[0],e.anchor[1],e.anchor[2],e.anchor[3])),void 0!==e.pivot&&(e.pivot instanceof Vec2?t.pivot.copy(e.pivot):t.pivot.set(e.pivot[0],e.pivot[1]));const i=Math.abs(t.anchor.x-t.anchor.z)>.001,n=Math.abs(t.anchor.y-t.anchor.w)>.001;let a,r=!1;void 0!==e.margin&&(e.margin instanceof Vec4?t.margin.copy(e.margin):t._margin.set(e.margin[0],e.margin[1],e.margin[2],e.margin[3]),r=!0),void 0!==e.left&&(t._margin.x=e.left,r=!0),void 0!==e.bottom&&(t._margin.y=e.bottom,r=!0),void 0!==e.right&&(t._margin.z=e.right,r=!0),void 0!==e.top&&(t._margin.w=e.top,r=!0),r&&(t.margin=t._margin);let o=!1;void 0===e.width||i?i&&(o=!0):t.width=e.width,void 0===e.height||n?n&&(o=!0):t.height=e.height,o&&(t.anchor=t.anchor),void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.useInput&&(t.useInput=e.useInput),t.batchGroupId=void 0===e.batchGroupId||null===e.batchGroupId?-1:e.batchGroupId,e.layers&&Array.isArray(e.layers)&&(t.layers=e.layers.slice(0)),void 0!==e.type&&(t.type=e.type),t.type===ml?(void 0!==e.rect&&(t.rect=e.rect),void 0!==e.color&&(a=e.color,a instanceof Color||(a=new Color(e.color[0],e.color[1],e.color[2])),t.color=a),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.textureAsset&&(t.textureAsset=e.textureAsset),e.texture&&(t.texture=e.texture),void 0!==e.spriteAsset&&(t.spriteAsset=e.spriteAsset),e.sprite&&(t.sprite=e.sprite),void 0!==e.spriteFrame&&(t.spriteFrame=e.spriteFrame),void 0!==e.pixelsPerUnit&&null!==e.pixelsPerUnit&&(t.pixelsPerUnit=e.pixelsPerUnit),void 0!==e.materialAsset&&(t.materialAsset=e.materialAsset),e.material&&(t.material=e.material),void 0!==e.mask&&(t.mask=e.mask)):t.type===_l&&(void 0!==e.autoWidth&&(t.autoWidth=e.autoWidth),void 0!==e.autoHeight&&(t.autoHeight=e.autoHeight),void 0!==e.rtlReorder&&(t.rtlReorder=e.rtlReorder),void 0!==e.unicodeConverter&&(t.unicodeConverter=e.unicodeConverter),null!==e.text&&void 0!==e.text?t.text=e.text:null!==e.key&&void 0!==e.key&&(t.key=e.key),void 0!==e.color&&(a=e.color,a instanceof Color||(a=new Color(a[0],a[1],a[2])),t.color=a),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.spacing&&(t.spacing=e.spacing),void 0!==e.fontSize&&(t.fontSize=e.fontSize,e.lineHeight||(t.lineHeight=e.fontSize)),void 0!==e.lineHeight&&(t.lineHeight=e.lineHeight),void 0!==e.maxLines&&(t.maxLines=e.maxLines),void 0!==e.wrapLines&&(t.wrapLines=e.wrapLines),void 0!==e.minFontSize&&(t.minFontSize=e.minFontSize),void 0!==e.maxFontSize&&(t.maxFontSize=e.maxFontSize),e.autoFitWidth&&(t.autoFitWidth=e.autoFitWidth),e.autoFitHeight&&(t.autoFitHeight=e.autoFitHeight),void 0!==e.fontAsset&&(t.fontAsset=e.fontAsset),void 0!==e.font&&(t.font=e.font),void 0!==e.alignment&&(t.alignment=e.alignment),void 0!==e.outlineColor&&(t.outlineColor=e.outlineColor),void 0!==e.outlineThickness&&(t.outlineThickness=e.outlineThickness),void 0!==e.shadowColor&&(t.shadowColor=e.shadowColor),void 0!==e.shadowOffset&&(t.shadowOffset=e.shadowOffset),void 0!==e.enableMarkup&&(t.enableMarkup=e.enableMarkup));const l=t._parseUpToScreen();l.screen&&t._updateScreen(l.screen),super.initializeComponentData(t,e,s),t._beingInitialized=!1,t.type===ml&&t._image._meshDirty&&t._image._updateMesh(t._image.mesh)}onRemoveComponent(t,e){e.onRemove()}cloneComponent(t,e){const s=t.element,i={enabled:s.enabled,width:s.width,height:s.height,anchor:s.anchor.clone(),pivot:s.pivot.clone(),margin:s.margin.clone(),alignment:s.alignment&&s.alignment.clone()||s.alignment,autoWidth:s.autoWidth,autoHeight:s.autoHeight,type:s.type,rect:s.rect&&s.rect.clone()||s.rect,rtlReorder:s.rtlReorder,unicodeConverter:s.unicodeConverter,materialAsset:s.materialAsset,material:s.material,color:s.color&&s.color.clone()||s.color,opacity:s.opacity,textureAsset:s.textureAsset,texture:s.texture,spriteAsset:s.spriteAsset,sprite:s.sprite,spriteFrame:s.spriteFrame,pixelsPerUnit:s.pixelsPerUnit,spacing:s.spacing,lineHeight:s.lineHeight,wrapLines:s.wrapLines,layers:s.layers,fontSize:s.fontSize,minFontSize:s.minFontSize,maxFontSize:s.maxFontSize,autoFitWidth:s.autoFitWidth,autoFitHeight:s.autoFitHeight,maxLines:s.maxLines,fontAsset:s.fontAsset,font:s.font,useInput:s.useInput,batchGroupId:s.batchGroupId,mask:s.mask,outlineColor:s.outlineColor&&s.outlineColor.clone()||s.outlineColor,outlineThickness:s.outlineThickness,shadowColor:s.shadowColor&&s.shadowColor.clone()||s.shadowColor,shadowOffset:s.shadowOffset&&s.shadowOffset.clone()||s.shadowOffset,enableMarkup:s.enableMarkup};return void 0!==s.key&&null!==s.key?i.key=s.key:i.text=s.text,this.addComponent(e,i)}getTextElementMaterial(t,e){return t?e?(this.defaultScreenSpaceTextMaterial||(this.defaultScreenSpaceTextMaterial=new StandardMaterial,this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial",this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture,this.defaultScreenSpaceTextMaterial.useLighting=!1,this.defaultScreenSpaceTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceTextMaterial.useFog=!1,this.defaultScreenSpaceTextMaterial.useSkybox=!1,this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1),this.defaultScreenSpaceTextMaterial.opacity=.5,this.defaultScreenSpaceTextMaterial.blendType=4,this.defaultScreenSpaceTextMaterial.depthWrite=!1,this.defaultScreenSpaceTextMaterial.depthTest=!1,this.defaultScreenSpaceTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceTextMaterial.update()),this.defaultScreenSpaceTextMaterial):(this.defaultScreenSpaceBitmapTextMaterial||(this.defaultScreenSpaceBitmapTextMaterial=new StandardMaterial,this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial",this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=!0,this.defaultScreenSpaceBitmapTextMaterial.opacity=.5,this.defaultScreenSpaceBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a",this.defaultScreenSpaceBitmapTextMaterial.useLighting=!1,this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceBitmapTextMaterial.useFog=!1,this.defaultScreenSpaceBitmapTextMaterial.useSkybox=!1,this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceBitmapTextMaterial.blendType=4,this.defaultScreenSpaceBitmapTextMaterial.depthWrite=!1,this.defaultScreenSpaceBitmapTextMaterial.depthTest=!1,this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceBitmapTextMaterial.update()),this.defaultScreenSpaceBitmapTextMaterial):e?(this.defaultTextMaterial||(this.defaultTextMaterial=new StandardMaterial,this.defaultTextMaterial.name="defaultTextMaterial",this.defaultTextMaterial.msdfMap=this._defaultTexture,this.defaultTextMaterial.useLighting=!1,this.defaultTextMaterial.useGammaTonemap=!1,this.defaultTextMaterial.useFog=!1,this.defaultTextMaterial.useSkybox=!1,this.defaultTextMaterial.diffuse.set(0,0,0),this.defaultTextMaterial.emissive.set(1,1,1),this.defaultTextMaterial.opacity=.5,this.defaultTextMaterial.blendType=4,this.defaultTextMaterial.depthWrite=!1,this.defaultTextMaterial.emissiveVertexColor=!0,this.defaultTextMaterial.update()),this.defaultTextMaterial):(this.defaultBitmapTextMaterial||(this.defaultBitmapTextMaterial=new StandardMaterial,this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial",this.defaultBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultBitmapTextMaterial.emissiveTint=!0,this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacity=.5,this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacityMapChannel="a",this.defaultBitmapTextMaterial.useLighting=!1,this.defaultBitmapTextMaterial.useGammaTonemap=!1,this.defaultBitmapTextMaterial.useFog=!1,this.defaultBitmapTextMaterial.useSkybox=!1,this.defaultBitmapTextMaterial.diffuse.set(0,0,0),this.defaultBitmapTextMaterial.blendType=4,this.defaultBitmapTextMaterial.depthWrite=!1,this.defaultBitmapTextMaterial.emissiveVertexColor=!0,this.defaultBitmapTextMaterial.update()),this.defaultBitmapTextMaterial)}_createBaseImageMaterial(){const t=new StandardMaterial;return t.diffuse.set(0,0,0),t.emissive.set(.5,.5,.5),t.emissiveMap=this._defaultTexture,t.emissiveTint=!0,t.opacityMap=this._defaultTexture,t.opacityMapChannel="a",t.opacityTint=!0,t.opacity=0,t.useLighting=!1,t.useGammaTonemap=!1,t.useFog=!1,t.useSkybox=!1,t.blendType=4,t.depthWrite=!1,t}getImageElementMaterial(t,e,s,i){return t?e?s?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):i?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):s?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):i?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):e?s?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):i?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):s?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):i?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)}registerUnicodeConverter(t){this._unicodeConverter=t}registerRtlReorder(t){this._rtlReorder=t}getUnicodeConverter(){return this._unicodeConverter}getRtlReorder(){return this._rtlReorder}}Component._buildAccessors(ElementComponent.prototype,oh);const lh="free",hh="limited",ch="locked",dh=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"];class JointComponent extends Component{constructor(t,e){super(t,e),this._constraint=null,this._entityA=null,this._entityB=null,this._breakForce=34e37,this._enableCollision=!0,this._linearMotionX=ch,this._linearLimitsX=new Vec2(0,0),this._linearSpringX=!1,this._linearStiffnessX=0,this._linearDampingX=1,this._linearEquilibriumX=0,this._linearMotionY=ch,this._linearLimitsY=new Vec2(0,0),this._linearSpringY=!1,this._linearStiffnessY=0,this._linearDampingY=1,this._linearEquilibriumY=0,this._linearMotionZ=ch,this._linearLimitsZ=new Vec2(0,0),this._linearSpringZ=!1,this._linearStiffnessZ=0,this._linearDampingZ=1,this._linearEquilibriumZ=0,this._angularMotionX=ch,this._angularLimitsX=new Vec2(0,0),this._angularSpringX=!1,this._angularStiffnessX=0,this._angularDampingX=1,this._angularEquilibriumX=0,this._angularMotionY=ch,this._angularLimitsY=new Vec2(0,0),this._angularSpringY=!1,this._angularStiffnessY=0,this._angularDampingY=1,this._angularEquilibriumY=0,this._angularMotionZ=ch,this._angularLimitsZ=new Vec2(0,0),this._angularSpringZ=!1,this._angularEquilibriumZ=0,this._angularDampingZ=1,this._angularStiffnessZ=0,this.on("set_enabled",this._onSetEnabled,this)}set entityA(t){this._destroyConstraint(),this._entityA=t,this._createConstraint()}get entityA(){return this._entityA}set entityB(t){this._destroyConstraint(),this._entityB=t,this._createConstraint()}get entityB(){return this._entityB}set breakForce(t){this._constraint&&this._breakForce!==t&&(this._constraint.setBreakingImpulseThreshold(t),this._breakForce=t)}get breakForce(){return this._breakForce}set enableCollision(t){this._destroyConstraint(),this._enableCollision=t,this._createConstraint()}get enableCollision(){return this._enableCollision}set angularLimitsX(t){this._angularLimitsX.equals(t)||(this._angularLimitsX.copy(t),this._updateAngularLimits())}get angularLimitsX(){return this._angularLimitsX}set angularMotionX(t){this._angularMotionX!==t&&(this._angularMotionX=t,this._updateAngularLimits())}get angularMotionX(){return this._angularMotionX}set angularLimitsY(t){this._angularLimitsY.equals(t)||(this._angularLimitsY.copy(t),this._updateAngularLimits())}get angularLimitsY(){return this._angularLimitsY}set angularMotionY(t){this._angularMotionY!==t&&(this._angularMotionY=t,this._updateAngularLimits())}get angularMotionY(){return this._angularMotionY}set angularLimitsZ(t){this._angularLimitsZ.equals(t)||(this._angularLimitsZ.copy(t),this._updateAngularLimits())}get angularLimitsZ(){return this._angularLimitsZ}set angularMotionZ(t){this._angularMotionZ!==t&&(this._angularMotionZ=t,this._updateAngularLimits())}get angularMotionZ(){return this._angularMotionZ}set linearLimitsX(t){this._linearLimitsX.equals(t)||(this._linearLimitsX.copy(t),this._updateLinearLimits())}get linearLimitsX(){return this._linearLimitsX}set linearMotionX(t){this._linearMotionX!==t&&(this._linearMotionX=t,this._updateLinearLimits())}get linearMotionX(){return this._linearMotionX}set linearLimitsY(t){this._linearLimitsY.equals(t)||(this._linearLimitsY.copy(t),this._updateLinearLimits())}get linearLimitsY(){return this._linearLimitsY}set linearMotionY(t){this._linearMotionY!==t&&(this._linearMotionY=t,this._updateLinearLimits())}get linearMotionY(){return this._linearMotionY}set linearLimitsZ(t){this._linearLimitsZ.equals(t)||(this._linearLimitsZ.copy(t),this._updateLinearLimits())}get linearLimitsZ(){return this._linearLimitsZ}set linearMotionZ(t){this._linearMotionZ!==t&&(this._linearMotionZ=t,this._updateLinearLimits())}get linearMotionZ(){return this._linearMotionZ}_convertTransform(t,e){const s=t.getTranslation(),i=new Quat;i.setFromMat4(t);const n=new Ammo.btVector3(s.x,s.y,s.z),a=new Ammo.btQuaternion(i.x,i.y,i.z,i.w);e.setOrigin(n),e.setRotation(a),Ammo.destroy(n),Ammo.destroy(a)}_updateAngularLimits(){const t=this._constraint;if(t){let e,s,i,n,a,r;this._angularMotionX===hh?(e=this._angularLimitsX.x*O.DEG_TO_RAD,n=this._angularLimitsX.y*O.DEG_TO_RAD):this._angularMotionX===lh?(e=1,n=0):e=n=0,this._angularMotionY===hh?(s=this._angularLimitsY.x*O.DEG_TO_RAD,a=this._angularLimitsY.y*O.DEG_TO_RAD):this._angularMotionY===lh?(s=1,a=0):s=a=0,this._angularMotionZ===hh?(i=this._angularLimitsZ.x*O.DEG_TO_RAD,r=this._angularLimitsZ.y*O.DEG_TO_RAD):this._angularMotionZ===lh?(i=1,r=0):i=r=0;const o=new Ammo.btVector3(e,s,i);t.setAngularLowerLimit(o),o.setValue(n,a,r),t.setAngularUpperLimit(o),Ammo.destroy(o)}}_updateLinearLimits(){const t=this._constraint;if(t){let e,s,i,n,a,r;this._linearMotionX===hh?(e=this._linearLimitsX.x,n=this._linearLimitsX.y):this._linearMotionX===lh?(e=1,n=0):e=n=0,this._linearMotionY===hh?(s=this._linearLimitsY.x,a=this._linearLimitsY.y):this._linearMotionY===lh?(s=1,a=0):s=a=0,this._linearMotionZ===hh?(i=this._linearLimitsZ.x,r=this._linearLimitsZ.y):this._linearMotionZ===lh?(i=1,r=0):i=r=0;const o=new Ammo.btVector3(e,s,i);t.setLinearLowerLimit(o),o.setValue(n,a,r),t.setLinearUpperLimit(o),Ammo.destroy(o)}}_createConstraint(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();const t=new Mat4,e=this._entityA.rigidbody.body;e.activate();const s=this.entity.getWorldTransform(),i=this._entityA.getWorldTransform().clone().invert();t.mul2(i,s);const n=new Ammo.btTransform;if(this._convertTransform(t,n),this._entityB&&this._entityB.rigidbody){const i=this._entityB.rigidbody.body;i.activate();const a=this._entityB.getWorldTransform().clone().invert();t.mul2(a,s);const r=new Ammo.btTransform;this._convertTransform(t,r),this._constraint=new Ammo.btGeneric6DofSpringConstraint(e,i,n,r,!this._enableCollision),Ammo.destroy(r)}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(e,n,!this._enableCollision);Ammo.destroy(n);const a=["X","Y","Z","X","Y","Z"];for(let r=0;r<6;r++){const t=r<3?"_linear":"_angular";this._constraint.enableSpring(r,this[t+"Spring"+a[r]]),this._constraint.setDamping(r,this[t+"Damping"+a[r]]),this._constraint.setEquilibriumPoint(r,this[t+"Equilibrium"+a[r]]),this._constraint.setStiffness(r,this[t+"Stiffness"+a[r]])}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits();this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision)}}_destroyConstraint(){if(this._constraint){this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null}}initFromData(t){for(const e of dh)t.hasOwnProperty(e)&&(t[e]instanceof Vec2?this["_"+e].copy(t[e]):this["_"+e]=t[e]);this._createConstraint()}onEnable(){this._createConstraint()}onDisable(){this._destroyConstraint()}_onSetEnabled(t,e,s){}_onBeforeRemove(){this.fire("remove")}}const uh={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach((t=>{["Damping","Equilibrium","Spring","Stiffness"].forEach((e=>{["X","Y","Z"].forEach((s=>{const i=t+e+s,n="_"+i;let a="linear"===t?0:3;"Y"===s&&(a+=1),"Z"===s&&(a+=2),Object.defineProperty(JointComponent.prototype,i,{get:function(){return this[n]},set:function(t){this[n]!==t&&(this[n]=t,this._constraint[uh[e]](a,t))}})}))}))}));class JointComponentData{constructor(){this.enabled=!0}}const ph=["enabled"];class JointComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="joint",this.app=t,this.ComponentType=JointComponent,this.DataType=JointComponentData,this.schema=ph}initializeComponentData(t,e,s){t.initFromData(e)}}Component._buildAccessors(JointComponent.prototype,ph);class LayoutChildComponent extends Component{constructor(t,e){super(t,e),this._minWidth=0,this._minHeight=0,this._maxWidth=null,this._maxHeight=null,this._fitWidthProportion=0,this._fitHeightProportion=0,this._excludeFromLayout=!1}set minWidth(t){t!==this._minWidth&&(this._minWidth=t,this.fire("resize"))}get minWidth(){return this._minWidth}set minHeight(t){t!==this._minHeight&&(this._minHeight=t,this.fire("resize"))}get minHeight(){return this._minHeight}set maxWidth(t){t!==this._maxWidth&&(this._maxWidth=t,this.fire("resize"))}get maxWidth(){return this._maxWidth}set maxHeight(t){t!==this._maxHeight&&(this._maxHeight=t,this.fire("resize"))}get maxHeight(){return this._maxHeight}set fitWidthProportion(t){t!==this._fitWidthProportion&&(this._fitWidthProportion=t,this.fire("resize"))}get fitWidthProportion(){return this._fitWidthProportion}set fitHeightProportion(t){t!==this._fitHeightProportion&&(this._fitHeightProportion=t,this.fire("resize"))}get fitHeightProportion(){return this._fitHeightProportion}set excludeFromLayout(t){t!==this._excludeFromLayout&&(this._excludeFromLayout=t,this.fire("resize"))}get excludeFromLayout(){return this._excludeFromLayout}}class LayoutChildComponentData{constructor(){this.enabled=!0}}const mh=["enabled"];class LayoutChildComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="layoutchild",this.ComponentType=LayoutChildComponent,this.DataType=LayoutChildComponentData,this.schema=mh}initializeComponentData(t,e,s){void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.minWidth&&(t.minWidth=e.minWidth),void 0!==e.minHeight&&(t.minHeight=e.minHeight),void 0!==e.maxWidth&&(t.maxWidth=e.maxWidth),void 0!==e.maxHeight&&(t.maxHeight=e.maxHeight),void 0!==e.fitWidthProportion&&(t.fitWidthProportion=e.fitWidthProportion),void 0!==e.fitHeightProportion&&(t.fitHeightProportion=e.fitHeightProportion),void 0!==e.excludeFromLayout&&(t.excludeFromLayout=e.excludeFromLayout),super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=t.layoutchild;return this.addComponent(e,{enabled:s.enabled,minWidth:s.minWidth,minHeight:s.minHeight,maxWidth:s.maxWidth,maxHeight:s.maxHeight,fitWidthProportion:s.fitWidthProportion,fitHeightProportion:s.fitHeightProportion,excludeFromLayout:s.excludeFromLayout})}}Component._buildAccessors(LayoutChildComponent.prototype,mh);const _h={0:{axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},1:{axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"}},fh={0:1,1:0},gh={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},yh="NONE",vh="APPLY_STRETCHING",bh="APPLY_SHRINKING",xh=new Vec2;function Sh(t){let e;const s=_h[t],i=_h[fh[t]];function n(t,e){return-e[s.size]*t.pivot[s.axis]}function a(t,e){return-e[i.size]*t.pivot[i.axis]}function r(t,e){return e[s.size]*(1-t.pivot[s.axis])}function o(t){const e=t.entity.layoutchild;return!e||!e.enabled||!e.excludeFromLayout}function l(t,e,s){switch(t){case 0:return yh;case 1:return e<s?vh:yh;case 2:return e>=s?bh:yh;case 3:return e<s?vh:bh;default:throw new Error(`Unrecognized fitting mode: ${t}`)}}function h(t,s){return f(t,s.size)+(t.length-1)*e.spacing[s.axis]}function c(t,e,s){const i=y(t,s.maxSize),n=g(t,s.fittingProportion),a=x(n,i);let r=xh[s.axis]-e;for(let o=0;o<t.length;++o){const e=i[o],l=u(e,r,n,a),h=t[e][s.size]+l,c=t[e][s.maxSize],d=Math.min(h,c);t[e][s.size]=d;r-=l-Math.max(h-d,0)}}function d(t,e,s){const i=y(t,s.minSize,!0),n=function(t){if(1===t.length)return[1];const e=[],s=t.length;for(let i=0;i<s;++i)e.push((1-t[i])/(s-1));return e}(g(t,s.fittingProportion)),a=x(n,i);let r=e-xh[s.axis];for(let o=0;o<t.length;++o){const e=i[o],l=u(e,r,n,a),h=t[e][s.size]-l,c=t[e][s.minSize],d=Math.max(h,c);t[e][s.size]=d;r-=l-Math.max(d-h,0)}}function u(t,e,s,i){const n=s[t],a=i[t];return Math.abs(n)<1e-5&&Math.abs(a)<1e-5?e:e*n/a}function p(t){const e=[];for(let s=0;s<t.length;++s){const i=t[s],n=Math.max(m(i,"minWidth"),0),a=Math.max(m(i,"minHeight"),0),r=Math.max(m(i,"maxWidth"),n),o=Math.max(m(i,"maxHeight"),a),l=_(m(i,"width"),n,r),h=_(m(i,"height"),a,o),c=m(i,"fitWidthProportion"),d=m(i,"fitHeightProportion");e.push({minWidth:n,minHeight:a,maxWidth:r,maxHeight:o,width:l,height:h,fitWidthProportion:c,fitHeightProportion:d})}return e}function m(t,e){const s=t.entity.layoutchild;return s&&s.enabled&&void 0!==s[e]&&null!==s[e]?s[e]:void 0!==t[e]?t[e]:gh[e]}function _(t,e,s){return Math.min(Math.max(t,e),s)}function f(t,e){return t.reduce((function(t,s){return t+s[e]}),0)}function g(t,e){const s=f(t,e),i=[],n=t.length;if(0===s)for(let a=0;a<n;++a)i.push(1/n);else for(let a=0;a<n;++a)i.push(t[a][e]/s);return i}function y(t,e,s){return t.forEach(v),t.slice().sort((function(t,i){return s?i[e]-t[e]:t[e]-i[e]})).map(b)}function v(t,e){t.index=e}function b(t){return t.index}function x(t,e){const s=[];s[e[t.length-1]]=t[e[t.length-1]];for(let i=t.length-2;i>=0;--i)s[e[i]]=s[e[i+1]]+t[e[i]];return s}return function(t,u){t=t.filter(o),e=u,xh.x=e.containerSize.x-e.padding.x-e.padding.z,xh.y=e.containerSize.y-e.padding.y-e.padding.w,function(t){for(let e=0;e<t.length;++e){const s=t[e],i=s.anchor;0===i.x&&0===i.y&&0===i.z&&0===i.w||(s.anchor=Vec4.ZERO)}}(t);const m=function(t){const s=0===e.orientation&&e.reverseX||1===e.orientation&&e.reverseY,i=0===e.orientation&&e.reverseY||1===e.orientation&&e.reverseX;if(s)for(let e=0;e<t.length;++e)s&&t[e].reverse();i&&t.reverse();return t}(function(t){if(!e.wrap)return[t];const i=[[]],n=p(t);let a=0;const r=2===e[s.fitting];for(let o=0;o<t.length;++o){i[i.length-1].length>0&&(a+=e.spacing[s.axis]);const l=n[o][s.size];a+=l,!r&&a>xh[s.axis]&&0!==i[i.length-1].length&&(a=l,i.push([])),i[i.length-1].push(t[o]),r&&a>xh[s.axis]&&o!==t.length-1&&(a=0,i.push([]))}return i}(t)),_=function(t,s){const n=[],a=[];for(let e=0;e<t.length;++e){const r=t[e];r.largestElement=null,r.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(let t=0;t<r.length;++t){const n=s[e][t];n[i.size]>r.largestSize[i.size]&&(r.largestElement=r[t],r.largestSize=n)}n.push(r.largestElement),a.push(r.largestSize)}const r=h(a,i),o=l(e[i.fitting],r,xh[i.axis]);o===vh?c(a,r,i):o===bh&&d(a,r,i);for(let h=0;h<t.length;++h){const n=t[h];for(let a=0;a<n.length;++a){const r=s[h][a],o=r[i.size],c=1===t.length?xh[i.axis]:n.largestSize[i.size],d=l(e[i.fitting],o,c);d===vh?r[i.size]=Math.min(c,r[i.maxSize]):d===bh&&(r[i.size]=Math.max(c,r[i.minSize]))}}return s}(m,function(t){const i=[];for(let n=0;n<t.length;++n){const a=p(t[n]),r=h(a,s),o=l(e[s.fitting],r,xh[s.axis]);o===vh?c(a,r,s):o===bh&&d(a,r,s),i.push(a)}return i}(m)),f=function(t,o){const l={};l[s.axis]=0,l[i.axis]=0,t[s.size]=Number.NEGATIVE_INFINITY;const h=[];for(let c=0;c<t.length;++c){const d=t[c];if(0===d.length){h.push([]);continue}const u=[],p=o[c];for(let t=0;t<d.length;++t){const o=d[t],h=p[t];l[i.axis]-=a(o,h),l[s.axis]-=n(o,h),u[t]={},u[t][s.axis]=l[s.axis],u[t][i.axis]=l[i.axis],l[i.axis]+=a(o,h),l[s.axis]+=r(o,h)+e.spacing[s.axis]}d[s.size]=l[s.axis]-e.spacing[s.axis],d[i.size]=d.largestSize[i.size],t[s.size]=Math.max(t[s.size],d[s.size]),l[s.axis]=0,l[i.axis]+=d[i.size]+e.spacing[i.axis],h.push(u)}return t[i.size]=l[i.axis]-e.spacing[i.axis],h}(m,_);return function(t,n,a){const r=e.alignment[s.axis],o=e.alignment[i.axis],l=e.padding[s.axis],h=e.padding[i.axis];for(let c=0;c<t.length;++c){const d=t[c],u=n[c],p=a[c],m=(xh[s.axis]-d[s.size])*r+l,_=(xh[i.axis]-t[i.size])*o+h;for(let t=0;t<d.length;++t){const n=(d[i.size]-u[t][i.size])*e.alignment[i.axis];p[t][s.axis]+=m,p[t][i.axis]+=_+n}}}(m,_,f),function(t,n,a){for(let r=0;r<t.length;++r){const o=t[r],l=n[r],h=a[r];for(let t=0;t<o.length;++t){const n=o[t];n[s.calculatedSize]=l[t][s.size],n[i.calculatedSize]=l[t][i.size],0===e.orientation?n.entity.setLocalPosition(h[t][s.axis],h[t][i.axis],n.entity.getLocalPosition().z):n.entity.setLocalPosition(h[t][i.axis],h[t][s.axis],n.entity.getLocalPosition().z)}}}(m,_,f),function(t){const s=t.width,i=t.height,n=(xh.x-s)*e.alignment.x+e.padding.x,a=(xh.y-i)*e.alignment.y+e.padding.y;return{bounds:new Vec4(n,a,s,i)}}(m)}}const wh={};wh[0]=Sh(0),wh[1]=Sh(1);class LayoutCalculator{calculateLayout(t,e){const s=wh[e.orientation];if(s)return s(t,e);throw new Error("Unrecognized orientation value: "+e.orientation)}}function Ch(t){return t.element}function Th(t){return t.enabled&&t.element&&t.element.enabled}class LayoutGroupComponent extends Component{constructor(t,e){super(t,e),this._orientation=0,this._reverseX=!1,this._reverseY=!0,this._alignment=new Vec2(0,1),this._padding=new Vec4,this._spacing=new Vec2,this._widthFitting=0,this._heightFitting=0,this._wrap=!1,this._layoutCalculator=new LayoutCalculator,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach((t=>{this._listenForReflowEvents(t,"on")})),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),t.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),t.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),t.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),t.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}set orientation(t){t!==this._orientation&&(this._orientation=t,this._scheduleReflow())}get orientation(){return this._orientation}set reverseX(t){t!==this._reverseX&&(this._reverseX=t,this._scheduleReflow())}get reverseX(){return this._reverseX}set reverseY(t){t!==this._reverseY&&(this._reverseY=t,this._scheduleReflow())}get reverseY(){return this._reverseY}set alignment(t){t.equals(this._alignment)||(this._alignment.copy(t),this._scheduleReflow())}get alignment(){return this._alignment}set padding(t){t.equals(this._padding)||(this._padding.copy(t),this._scheduleReflow())}get padding(){return this._padding}set spacing(t){t.equals(this._spacing)||(this._spacing.copy(t),this._scheduleReflow())}get spacing(){return this._spacing}set widthFitting(t){t!==this._widthFitting&&(this._widthFitting=t,this._scheduleReflow())}get widthFitting(){return this._widthFitting}set heightFitting(t){t!==this._heightFitting&&(this._heightFitting=t,this._scheduleReflow())}get heightFitting(){return this._heightFitting}set wrap(t){t!==this._wrap&&(this._wrap=t,this._scheduleReflow())}get wrap(){return this._wrap}_isSelfOrChild(t){return t===this.entity||-1!==this.entity.children.indexOf(t)}_listenForReflowEvents(t,e){t.element&&(t.element[e]("enableelement",this._scheduleReflow,this),t.element[e]("disableelement",this._scheduleReflow,this),t.element[e]("resize",this._scheduleReflow,this),t.element[e]("set:pivot",this._scheduleReflow,this)),t.layoutchild&&(t.layoutchild[e]("set_enabled",this._scheduleReflow,this),t.layoutchild[e]("resize",this._scheduleReflow,this))}_onElementOrLayoutComponentAdd(t){this._isSelfOrChild(t)&&(this._listenForReflowEvents(t,"on"),this._scheduleReflow())}_onElementOrLayoutComponentRemove(t){this._isSelfOrChild(t)&&(this._listenForReflowEvents(t,"off"),this._scheduleReflow())}_onChildInsert(t){this._listenForReflowEvents(t,"on"),this._scheduleReflow()}_onChildRemove(t){this._listenForReflowEvents(t,"off"),this._scheduleReflow()}_scheduleReflow(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)}reflow(){const t=Ch(this.entity),e=this.entity.children.filter(Th).map(Ch);if(!t||0===e.length)return;const s=Math.max(t.calculatedWidth,0),i=Math.max(t.calculatedHeight,0),n={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new Vec2(s,i)};this._isPerformingReflow=!0;const a=this._layoutCalculator.calculateLayout(e,n);this._isPerformingReflow=!1,this.fire("reflow",a)}onEnable(){this._scheduleReflow()}onRemove(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach((t=>{this._listenForReflowEvents(t,"off")})),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}}class LayoutGroupComponentData{constructor(){this.enabled=!0}}const Mh=["enabled"];class LayoutGroupComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="layoutgroup",this.ComponentType=LayoutGroupComponent,this.DataType=LayoutGroupComponentData,this.schema=Mh,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(t,e,s){void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.orientation&&(t.orientation=e.orientation),void 0!==e.reverseX&&(t.reverseX=e.reverseX),void 0!==e.reverseY&&(t.reverseY=e.reverseY),void 0!==e.alignment&&(t.alignment=Array.isArray(e.alignment)?new Vec2(e.alignment):e.alignment),void 0!==e.padding&&(t.padding=Array.isArray(e.padding)?new Vec4(e.padding):e.padding),void 0!==e.spacing&&(t.spacing=Array.isArray(e.spacing)?new Vec2(e.spacing):e.spacing),void 0!==e.widthFitting&&(t.widthFitting=e.widthFitting),void 0!==e.heightFitting&&(t.heightFitting=e.heightFitting),void 0!==e.wrap&&(t.wrap=e.wrap),super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=t.layoutgroup;return this.addComponent(e,{enabled:s.enabled,orientation:s.orientation,reverseX:s.reverseX,reverseY:s.reverseY,alignment:s.alignment,padding:s.padding,spacing:s.spacing,widthFitting:s.widthFitting,heightFitting:s.heightFitting,wrap:s.wrap})}scheduleReflow(t){-1===this._reflowQueue.indexOf(t)&&this._reflowQueue.push(t)}_onPostUpdate(){this._processReflowQueue()}_processReflowQueue(){if(0===this._reflowQueue.length)return;let t=0;for(;this._reflowQueue.length>0;){const e=this._reflowQueue.slice();this._reflowQueue.length=0,e.sort((function(t,e){return t.entity.graphDepth-e.entity.graphDepth}));for(let t=0;t<e.length;++t)e[t].reflow();if(++t>=100){console.warn("Max reflow iterations limit reached, bailing.");break}}}_onRemoveComponent(t,e){e.onRemove()}destroy(){super.destroy(),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}Component._buildAccessors(LayoutGroupComponent.prototype,Mh);const Ah=[],Ph=[];class LightComponent extends Component{constructor(t,e){super(t,e),this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}addLightToLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.addLight(this)}}removeLightFromLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.removeLight(this)}}onLayersChanged(t,e){this.enabled&&this.entity.enabled&&this.addLightToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)>=0&&this.enabled&&this.entity.enabled&&t.addLight(this)}onLayerRemoved(t){this.layers.indexOf(t.id)>=0&&t.removeLight(this)}refreshProperties(){for(let t=0;t<Ah.length;t++){const e=Ah[t];this[e]=this[e]}this.enabled&&this.entity.enabled&&this.onEnable()}updateShadow(){this.light.updateShadow()}onCookieAssetSet(){let t=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,t=!0),this._cookieAsset.resource&&!t||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(t){this._cookieAssetId===t.id&&(this._cookieAsset=t,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}}function Eh(t,e,s,i){const n=LightComponent.prototype;Ah.push(t),Ph.push(e),Object.defineProperty(n,t,{get:function(){return this.data[t]},set:function(e){const n=this.data,a=n[t];(i||a!==e)&&(n[t]=e,s&&s.call(this,e,a))},configurable:!0})}Eh("enabled",!0,(function(t,e){this.onSetEnabled(null,e,t)})),Eh("light",null),Eh("type","directional",(function(t,e){this.system.changeType(this,e,t),this.refreshProperties()})),Eh("color",new Color(1,1,1),(function(t,e){this.light.setColor(t)}),!0),Eh("intensity",1,(function(t,e){this.light.intensity=t})),Eh("shape",0,(function(t,e){this.light.shape=t})),Eh("castShadows",!1,(function(t,e){this.light.castShadows=t})),Eh("shadowDistance",40,(function(t,e){this.light.shadowDistance=t})),Eh("shadowResolution",1024,(function(t,e){this.light.shadowResolution=t})),Eh("shadowBias",.05,(function(t,e){this.light.shadowBias=-.01*O.clamp(t,0,1)})),Eh("numCascades",1,(function(t,e){this.light.numCascades=O.clamp(Math.floor(t),1,4)})),Eh("bakeNumSamples",1,(function(t,e){this.light.bakeNumSamples=O.clamp(Math.floor(t),1,255)})),Eh("bakeArea",0,(function(t,e){this.light.bakeArea=O.clamp(t,0,180)})),Eh("cascadeDistribution",.5,(function(t,e){this.light.cascadeDistribution=O.clamp(t,0,1)})),Eh("normalOffsetBias",0,(function(t,e){this.light.normalOffsetBias=O.clamp(t,0,1)})),Eh("range",10,(function(t,e){this.light.attenuationEnd=t})),Eh("innerConeAngle",40,(function(t,e){this.light.innerConeAngle=t})),Eh("outerConeAngle",45,(function(t,e){this.light.outerConeAngle=t})),Eh("falloffMode",0,(function(t,e){this.light.falloffMode=t})),Eh("shadowType",0,(function(t,e){this.light.shadowType=t})),Eh("vsmBlurSize",11,(function(t,e){this.light.vsmBlurSize=t})),Eh("vsmBlurMode",1,(function(t,e){this.light.vsmBlurMode=t})),Eh("vsmBias",.0025,(function(t,e){this.light.vsmBias=O.clamp(t,0,1)})),Eh("cookieAsset",null,(function(t,e){if(!this._cookieAssetId||!(t instanceof Asset&&t.id===this._cookieAssetId||t===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,t instanceof Asset)this.data.cookieAsset=t.id,this._cookieAssetId=t.id,this.onCookieAssetAdd(t);else if("number"==typeof t){this._cookieAssetId=t;const e=this.system.app.assets.get(t);e?this.onCookieAssetAdd(e):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}})),Eh("cookie",null,(function(t,e){this.light.cookie=t})),Eh("cookieIntensity",1,(function(t,e){this.light.cookieIntensity=O.clamp(t,0,1)})),Eh("cookieFalloff",!0,(function(t,e){this.light.cookieFalloff=t})),Eh("cookieChannel","rgb",(function(t,e){this.light.cookieChannel=t})),Eh("cookieAngle",0,(function(t,e){if(0!==t||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new Vec4);let e=1,s=1;this.cookieScale&&(e=this.cookieScale.x,s=this.cookieScale.y);const i=Math.cos(t*O.DEG_TO_RAD),n=Math.sin(t*O.DEG_TO_RAD);this._cookieMatrix.set(i/e,-n/e,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})),Eh("cookieScale",null,(function(t,e){if(null!==t||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new Vec4);const e=t.x,s=t.y,i=Math.cos(this.cookieAngle*O.DEG_TO_RAD),n=Math.sin(this.cookieAngle*O.DEG_TO_RAD);this._cookieMatrix.set(i/e,-n/e,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),!0),Eh("cookieOffset",null,(function(t,e){this.light.cookieOffset=t}),!0),Eh("shadowUpdateMode",2,(function(t,e){this.light.shadowUpdateMode=t}),!0),Eh("mask",1,(function(t,e){this.light.mask=t})),Eh("affectDynamic",!0,(function(t,e){t?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty()})),Eh("affectLightmapped",!1,(function(t,e){t?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))})),Eh("bake",!1,(function(t,e){t?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2)),this.light.layersDirty()})),Eh("bakeDir",!0,(function(t,e){this.light.bakeDir=t})),Eh("isStatic",!1,(function(t,e){this.light.isStatic=t})),Eh("layers",[0],(function(t,e){for(let s=0;s<e.length;s++){const t=this.system.app.scene.layers.getLayerById(e[s]);t&&t.removeLight(this)}for(let s=0;s<t.length;s++){const e=this.system.app.scene.layers.getLayerById(t[s]);e&&this.enabled&&this.entity.enabled&&e.addLight(this)}}));class LightComponentData{constructor(){const t=Ah,e=Ph;for(let s=0;s<t.length;s++){const i=e[s];i&&i.clone?this[t[s]]=i.clone():this[t[s]]=i}}}const Lh={directional:0,omni:1,point:1,spot:2};class LightComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="light",this.ComponentType=LightComponent,this.DataType=LightComponentData,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(t,e){const s=Ah,i={};for(let a=0,r=s.length;a<r;a++){const t=s[a];i[t]=e[t]}i.type||(i.type=t.data.type),t.data.type=i.type,i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0)),i.color&&Array.isArray(i.color)&&(i.color=new Color(i.color[0],i.color[1],i.color[2])),i.cookieOffset&&i.cookieOffset instanceof Array&&(i.cookieOffset=new Vec2(i.cookieOffset[0],i.cookieOffset[1])),i.cookieScale&&i.cookieScale instanceof Array&&(i.cookieScale=new Vec2(i.cookieScale[0],i.cookieScale[1])),i.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),i.enabled=i.enable),i.shape||(i.shape=0);const n=new Light(this.app.graphicsDevice);n.type=Lh[i.type],n._node=t.entity,n._scene=this.app.scene,t.data.light=n,super.initializeComponentData(t,i,s)}_onRemoveComponent(t,e){e.onRemove()}cloneComponent(t,e){const s=t.light,i=[];let n;const a=Ah;for(let r=0;r<a.length;r++)n=a[r],"light"!==n&&(s[n]&&s[n].clone?i[n]=s[n].clone():i[n]=s[n]);this.addComponent(e,i)}changeType(t,e,s){e!==s&&(t.light.type=Lh[s])}}class ModelComponent extends Component{constructor(t,e){super(t,e),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=!0,this._receiveShadows=!0,this._materialAsset=null,this._material=t.defaultMaterial,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._layers=[0],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._assetOld=0,this._materialEvents=null,this._dirtyModelAsset=!1,this._dirtyMaterialAsset=!1,this._clonedModel=!1,e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}set meshInstances(t){this._model&&(this._model.meshInstances=t)}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(t){if(this._customAabb=t,this._model){const t=this._model.meshInstances;if(t)for(let e=0;e<t.length;e++)t[e].setCustomAabb(this._customAabb)}}get customAabb(){return this._customAabb}set type(t){if(this._type!==t)if(this._area=null,this._type=t,"asset"===t)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{const e=ui(this.system.app.graphicsDevice,t);this._area=e.area;const s=e.mesh,i=new GraphNode,n=new Model;n.graph=i,n.meshInstances=[new MeshInstance(s,this._material,i)],this.model=n,this._asset=null}}get type(){return this._type}set asset(t){const e=this.system.app.assets;let s=t;if(t instanceof Asset&&(s=t.id),this._asset!==s){if(this._asset){e.off("add:"+this._asset,this._onModelAssetAdded,this);const t=e.get(this._asset);t&&this._unbindModelAsset(t)}if(this._asset=s,this._asset){const t=e.get(this._asset);t?this._bindModelAsset(t):(this.model=null,e.on("add:"+this._asset,this._onModelAssetAdded,this))}else this.model=null}}get asset(){return this._asset}set model(t){if(this._model!==t&&(!t||!t._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=t,this._model)){this._model._immutable=!0;const t=this._model.meshInstances;for(let e=0;e<t.length;e++)t[e].castShadow=this._castShadows,t[e].receiveShadow=this._receiveShadows,t[e].isStatic=this._isStatic,t[e].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&(this.entity.anim.playing?this.entity.anim.rebind():this.entity.anim.resetStateGraph()),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}get model(){return this._model}set lightmapped(t){if(t!==this._lightmapped&&(this._lightmapped=t,this._model)){const e=this._model.meshInstances;for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get lightmapped(){return this._lightmapped}set castShadows(t){if(this._castShadows===t)return;const e=this._model;if(e){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!t)for(let t=0;t<s.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.removeShadowCasters(e.meshInstances)}const n=e.meshInstances;for(let e=0;e<n.length;e++)n[e].castShadow=t;if(!this._castShadows&&t)for(let t=0;t<s.length;t++){const n=i.layers.getLayerById(s[t]);n&&n.addShadowCasters(e.meshInstances)}}this._castShadows=t}get castShadows(){return this._castShadows}set receiveShadows(t){if(this._receiveShadows!==t&&(this._receiveShadows=t,this._model)){const e=this._model.meshInstances;for(let s=0,i=e.length;s<i;s++)e[s].receiveShadow=t}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(t){this._castShadowsLightmap=t}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set isStatic(t){if(this._isStatic!==t&&(this._isStatic=t,this._model)){const e=this._model.meshInstances;for(let s=0;s<e.length;s++){e[s].isStatic=t}}}get isStatic(){return this._isStatic}set layers(t){const e=this.system.app.scene.layers;if(this.meshInstances)for(let s=0;s<this._layers.length;s++){const t=e.getLayerById(this._layers[s]);t&&t.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(let s=0;s<t.length;s++)this._layers[s]=t[s];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(let s=0;s<this._layers.length;s++){const t=e.getLayerById(this._layers[s]);t&&t.addMeshInstances(this.meshInstances)}}get layers(){return this._layers}set batchGroupId(t){if(this._batchGroupId===t)return;const e=this.system.app.batcher;this.entity.enabled&&this._batchGroupId>=0&&e.remove(BatchGroup.MODEL,this.batchGroupId,this.entity),this.entity.enabled&&t>=0&&e.insert(BatchGroup.MODEL,t,this.entity),t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=t}get batchGroupId(){return this._batchGroupId}set materialAsset(t){let e=t;t instanceof Asset&&(e=t.id);const s=this.system.app.assets;if(e!==this._materialAsset){if(this._materialAsset){s.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);const t=s.get(this._materialAsset);t&&this._unbindMaterialAsset(t)}if(this._materialAsset=e,this._materialAsset){const t=s.get(this._materialAsset);t?this._bindMaterialAsset(t):(this._setMaterial(this.system.defaultMaterial),s.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}get materialAsset(){return this._materialAsset}set material(t){this._material!==t&&(this.materialAsset=null,this._setMaterial(t))}get material(){return this._material}set mapping(t){if("asset"!==this._type)return;if(this._unsetMaterialEvents(),t||(t={}),this._mapping=t,!this._model)return;const e=this._model.meshInstances,s=this.asset?this.system.app.assets.get(this.asset):null,i=s?s.data.mapping:null;let n=null;for(let a=0,r=e.length;a<r;a++)if(void 0!==t[a])t[a]?(n=this.system.app.assets.get(t[a]),this._loadAndSetMeshInstanceMaterial(n,e[a],a)):e[a].material=this.system.defaultMaterial;else if(i)if(i[a]&&(i[a].material||i[a].path)){if(void 0!==i[a].material)n=this.system.app.assets.get(i[a].material);else if(void 0!==i[a].path){const t=this._getMaterialAssetUrl(i[a].path);t&&(n=this.system.app.assets.getByUrl(t))}this._loadAndSetMeshInstanceMaterial(n,e[a],a)}else e[a].material=this.system.defaultMaterial}get mapping(){return this._mapping}addModelToLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this.meshInstances)}}removeModelFromLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this.meshInstances)}}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addModelToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this.meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this.meshInstances)}_setMaterialEvent(t,e,s,i){const n=e+":"+s;this.system.app.assets.on(n,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[t]||(this._materialEvents[t]={}),this._materialEvents[t][n]={id:s,handler:i}}_unsetMaterialEvents(){const t=this.system.app.assets,e=this._materialEvents;if(e){for(let s=0,i=e.length;s<i;s++){if(!e[s])continue;const i=e[s];for(const e in i)t.off(e,i[e].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(t){let e=null;if(isNaN(parseInt(t,10))){if(this.asset){const s=this._getMaterialAssetUrl(t);s&&(e=this.system.app.assets.getByUrl(s))}}else e=this.system.app.assets.get(t);return e}_getMaterialAssetUrl(t){if(!this.asset)return null;const e=this.system.app.assets.get(this.asset);return e?e.getAbsoluteUrl(t):null}_loadAndSetMeshInstanceMaterial(t,e,s){const i=this.system.app.assets;t&&(t.resource?(e.material=t.resource,this._setMaterialEvent(s,"remove",t.id,(function(){e.material=this.system.defaultMaterial}))):(this._setMaterialEvent(s,"load",t.id,(function(i){e.material=i.resource,this._setMaterialEvent(s,"remove",t.id,(function(){e.material=this.system.defaultMaterial}))})),this.enabled&&this.entity.enabled&&i.load(t)))}onEnable(){const t=this.system.app,e=t.scene;e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this));const s="asset"===this._type;let i;if(this._model?this.addModelToLayers():s&&this._asset&&(i=t.assets.get(this._asset),i&&i.resource!==this._model&&this._bindModelAsset(i)),this._materialAsset&&(i=t.assets.get(this._materialAsset),i&&i.resource!==this._material&&this._bindMaterialAsset(i)),s&&this._mapping)for(const n in this._mapping)this._mapping[n]&&(i=this._getAssetByIdOrPath(this._mapping[n]),i&&!i.resource&&t.assets.load(i));this._batchGroupId>=0&&t.batcher.insert(BatchGroup.MODEL,this.batchGroupId,this.entity)}onDisable(){const t=this.system.app,e=t.scene;e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&t.batcher.remove(BatchGroup.MODEL,this.batchGroupId,this.entity),this._model&&this.removeModelFromLayers()}hide(){if(this._model){const t=this._model.meshInstances;for(let e=0,s=t.length;e<s;e++)t[e].visible=!1}}show(){if(this._model){const t=this._model.meshInstances;for(let e=0,s=t.length;e<s;e++)t[e].visible=!0}}_bindMaterialAsset(t){if(t.on("load",this._onMaterialAssetLoad,this),t.on("unload",this._onMaterialAssetUnload,this),t.on("remove",this._onMaterialAssetRemove,this),t.on("change",this._onMaterialAssetChange,this),t.resource)this._onMaterialAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindMaterialAsset(t){t.off("load",this._onMaterialAssetLoad,this),t.off("unload",this._onMaterialAssetUnload,this),t.off("remove",this._onMaterialAssetRemove,this),t.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(t){this.system.app.assets.off("add:"+t.id,this._onMaterialAssetAdd,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)}_onMaterialAssetLoad(t){this._setMaterial(t.resource)}_onMaterialAssetUnload(t){this._setMaterial(this.system.defaultMaterial)}_onMaterialAssetRemove(t){this._onMaterialAssetUnload(t)}_onMaterialAssetChange(t){}_bindModelAsset(t){if(this._unbindModelAsset(t),t.on("load",this._onModelAssetLoad,this),t.on("unload",this._onModelAssetUnload,this),t.on("change",this._onModelAssetChange,this),t.on("remove",this._onModelAssetRemove,this),t.resource)this._onModelAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindModelAsset(t){t.off("load",this._onModelAssetLoad,this),t.off("unload",this._onModelAssetUnload,this),t.off("change",this._onModelAssetChange,this),t.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(t){this.system.app.assets.off("add:"+t.id,this._onModelAssetAdded,this),t.id===this._asset&&this._bindModelAsset(t)}_onModelAssetLoad(t){this.model=t.resource.clone(),this._clonedModel=!0}_onModelAssetUnload(t){this.model=null}_onModelAssetChange(t,e,s,i){"data"===e&&(this.mapping=this._mapping)}_onModelAssetRemove(t){this.model=null}_setMaterial(t){if(this._material===t)return;this._material=t;const e=this._model;if(e&&"asset"!==this._type){const s=e.meshInstances;for(let e=0,i=s.length;e<i;e++)s[e].material=t}}}class ModelComponentData{constructor(){this.enabled=!0}}const Rh=["enabled"];class ModelComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="model",this.ComponentType=ModelComponent,this.DataType=ModelComponentData,this.schema=Rh,this.defaultMaterial=DefaultMaterial.get(t.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(t,e,s){s=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],null!==e.batchGroupId&&void 0!==e.batchGroupId||(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(let i=0;i<s.length;i++)e.hasOwnProperty(s[i])&&(t[s[i]]=e[s[i]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new BoundingBox(new Vec3(e.aabbCenter),new Vec3(e.aabbHalfExtents))),super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s={type:t.model.type,asset:t.model.asset,castShadows:t.model.castShadows,receiveShadows:t.model.receiveShadows,castShadowsLightmap:t.model.castShadowsLightmap,lightmapped:t.model.lightmapped,lightmapSizeMultiplier:t.model.lightmapSizeMultiplier,isStatic:t.model.isStatic,enabled:t.model.enabled,layers:t.model.layers,batchGroupId:t.model.batchGroupId,mapping:r({},t.model.mapping)};let i=t.model.materialAsset;i instanceof Asset||null==i||(i=this.app.assets.get(i));const n=t.model.material;n&&n!==this.defaultMaterial&&i&&n!==i.resource||(s.materialAsset=i);const a=this.addComponent(e,s);if(t.model.model&&"asset"===t.model.type&&!t.model.asset&&(a.model=t.model.model.clone(),a._clonedModel=!0),s.materialAsset||(a.material=n),t.model.model){const e=t.model.model.meshInstances,s=a.model.meshInstances;for(let t=0;t<e.length;t++)s[t].mask=e[t].mask,s[t].material=e[t].material,s[t].layer=e[t].layer,s[t].receiveShadow=e[t].receiveShadow}t.model.customAabb&&(a.customAabb=t.model.customAabb.clone())}onRemove(t,e){e.onRemove()}}Component._buildAccessors(ModelComponent.prototype,Rh);class RenderComponent extends Component{constructor(t,e){super(t,e),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._batchGroupId=-1,this._meshInstances=[],this._layers=[0],this._renderStyle=0,this._customAabb=null,this._area=null,this._rootBone=new EntityReference(this,"rootBone"),this._rootBone.on("set:entity",this._onSetRootBone,this),this._assetReference=new AssetReference("asset",this,t.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=t.defaultMaterial,this._materialReferences=[],e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}set renderStyle(t){this._renderStyle!==t&&(this._renderStyle=t,MeshInstance._prepareRenderStyleForArray(this._meshInstances,t))}get renderStyle(){return this._renderStyle}set customAabb(t){this._customAabb=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(t){if(this._type!==t&&(this._area=null,this._type=t,this.destroyMeshInstances(),"asset"!==t)){let e=this._material;e&&e!==this.system.defaultMaterial||(e=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);const s=ui(this.system.app.graphicsDevice,t);this._area=s.area,this.meshInstances=[new MeshInstance(s.mesh,e||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(t){if(this.destroyMeshInstances(),this._meshInstances=t,this._meshInstances){const t=this._meshInstances;for(let e=0;e<t.length;e++)t[e].node||(t[e].node=this.entity),t[e].castShadow=this._castShadows,t[e].receiveShadow=this._receiveShadows,t[e].isStatic=this._isStatic,t[e].renderStyle=this._renderStyle,t[e].setLightmapped(this._lightmapped),t[e].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(t){if(t!==this._lightmapped){this._lightmapped=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get lightmapped(){return this._lightmapped}set castShadows(t){if(this._castShadows!==t){const e=this._meshInstances;if(e){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!t)for(let t=0;t<s.length;t++){const s=i.layers.getLayerById(this.layers[t]);s&&s.removeShadowCasters(e)}for(let n=0;n<e.length;n++)e[n].castShadow=t;if(!this._castShadows&&t)for(let t=0;t<s.length;t++){const n=i.layers.getLayerById(s[t]);n&&n.addShadowCasters(e)}}this._castShadows=t}}get castShadows(){return this._castShadows}set receiveShadows(t){if(this._receiveShadows!==t){this._receiveShadows=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].receiveShadow=t}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(t){this._castShadowsLightmap=t}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set isStatic(t){if(this._isStatic!==t){this._isStatic=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].isStatic=t}}get isStatic(){return this._isStatic}set layers(t){const e=this.system.app.scene.layers;let s;if(this._meshInstances)for(let i=0;i<this._layers.length;i++)s=e.getLayerById(this._layers[i]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let i=0;i<t.length;i++)this._layers[i]=t[i];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(let i=0;i<this._layers.length;i++)s=e.getLayerById(this._layers[i]),s&&s.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(t){if(this._batchGroupId!==t){const e=this.system.app.batcher;this.entity.enabled&&this._batchGroupId>=0&&e.remove(BatchGroup.RENDER,this.batchGroupId,this.entity),this.entity.enabled&&t>=0&&e.insert(BatchGroup.RENDER,t,this.entity),t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=t}}get batchGroupId(){return this._batchGroupId}set material(t){if(this._material!==t&&(this._material=t,this._meshInstances&&"asset"!==this._type))for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].material=t}get material(){return this._material}set materialAssets(t=[]){if(this._materialReferences.length>t.length){for(let e=t.length;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this._materialReferences.length=t.length}for(let e=0;e<t.length;e++)if(this._materialReferences[e]||this._materialReferences.push(new AssetReference(e,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),t[e]){const s=t[e]instanceof Asset?t[e].id:t[e];this._materialReferences[e].id!==s&&(this._materialReferences[e].id=s),this._materialReferences[e].asset&&this._onMaterialAdded(e,this,this._materialReferences[e].asset)}else this._materialReferences[e].id=null,this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map((function(t){return t.id}))}set asset(t){const e=t instanceof Asset?t.id:t;this._assetReference.id!==e&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=e,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}_onSetRootBone(t){t&&this._onRootBoneChanged()}_onRootBoneChanged(){this._clearSkinInstances(),this.enabled&&this.entity.enabled&&this._cloneSkinInstances()}destroyMeshInstances(){const t=this._meshInstances;if(t){this.removeFromLayers(),this._clearSkinInstances();for(let e=0;e<t.length;e++)t[e].destroy();this._meshInstances.length=0}}addToLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this._meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this._meshInstances)}onEnable(){const t=this.system.app,e=t.scene;this._rootBone.onParentComponentEnable(),this._cloneSkinInstances(),e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this));const s="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():s&&this.asset&&this._onRenderAssetAdded();for(let i=0;i<this._materialReferences.length;i++)this._materialReferences[i].asset&&this.system.app.assets.load(this._materialReferences[i].asset);this._batchGroupId>=0&&t.batcher.insert(BatchGroup.RENDER,this.batchGroupId,this.entity)}onDisable(){const t=this.system.app,e=t.scene;e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&t.batcher.remove(BatchGroup.RENDER,this.batchGroupId,this.entity),this.removeFromLayers()}hide(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!1}show(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){const t=this._assetReference.asset.resource;t.off("set:meshes",this._onSetMeshes,this),t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes)}}_onSetMeshes(t){this._cloneMeshes(t)}_clearSkinInstances(){for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t];SkinInstanceCache.removeCachedSkinInstance(e.skinInstance),e.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone.entity instanceof GraphNode)for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t],s=e.mesh;s.skin&&!s.skinInstance&&(e.skinInstance=SkinInstanceCache.createCachedSkinInstance(s.skin,this._rootBone.entity,this.entity))}}_cloneMeshes(t){if(t&&t.length){const e=[];for(let s=0;s<t.length;s++){const i=t[s],n=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,a=new MeshInstance(i,n||this.system.defaultMaterial,this.entity);e.push(a),i.morph&&(a.morphInstance=new MorphInstance(i.morph))}this.meshInstances=e,this._cloneSkinInstances()}}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances()}_onRenderAssetRemove(){this._assetReference.asset&&this._assetReference.asset.resource&&this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this),this._onRenderAssetUnload()}_onMaterialAdded(t,e,s){s.resource?this._onMaterialLoad(t,e,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(t,e){0===t&&(this.material=e)}_onMaterialLoad(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=s.resource),this._updateMainMaterial(t,s.resource)}_onMaterialRemove(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}_onMaterialUnload(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&e[t.rootBone]&&(this.rootBone=e[t.rootBone]),this._clearSkinInstances()}}class RenderComponentData{constructor(){this.enabled=!0,this.rootBone=null}}const Ih=[{name:"rootBone",type:"entity"},"enabled"],Dh=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId"];class RenderComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="render",this.ComponentType=RenderComponent,this.DataType=RenderComponentData,this.schema=Ih,this.defaultMaterial=DefaultMaterial.get(t.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(t,e,s){null!==e.batchGroupId&&void 0!==e.batchGroupId||(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(let i=0;i<Dh.length;i++)e.hasOwnProperty(Dh[i])&&(t[Dh[i]]=e[Dh[i]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new BoundingBox(new Vec3(e.aabbCenter),new Vec3(e.aabbHalfExtents))),super.initializeComponentData(t,e,Ih)}cloneComponent(t,e){const s={};for(let r=0;r<Dh.length;r++)s[Dh[r]]=t.render[Dh[r]];delete s.meshInstances;const i=this.addComponent(e,s),n=t.render.meshInstances,a=n.map((t=>t.mesh));i._onSetMeshes(a);for(let r=0;r<n.length;r++)i.meshInstances[r].material=n[r].material;t.render.customAabb&&(i.customAabb=t.render.customAabb.clone())}onRemove(t,e){e.onRemove()}}Component._buildAccessors(RenderComponent.prototype,Ih);const kh=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],Fh=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],Oh=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],Vh=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"];let Bh;class ParticleSystemComponent extends Component{constructor(t,e){super(t,e),this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),kh.forEach((t=>{this.on(`set_${t}`,this.onSetSimpleProperty,this)})),Fh.forEach((t=>{this.on(`set_${t}`,this.onSetComplexProperty,this)})),Oh.forEach((t=>{this.on(`set_${t}`,this.onSetGraphProperty,this)})),this._requestedDepth=!1,this._drawOrder=0}set drawOrder(t){this._drawOrder=t,this.emitter&&(this.emitter.drawOrder=t)}get drawOrder(){return this._drawOrder}addMeshInstanceToLayers(){if(this.emitter)for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&(e.addMeshInstances([this.emitter.meshInstance]),this.emitter._layer=e)}}removeMeshInstanceFromLayers(){if(this.emitter)for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.removeMeshInstances([this.emitter.meshInstance])}}onSetLayers(t,e,s){if(this.emitter){for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeMeshInstances([this.emitter.meshInstance])}if(this.enabled&&this.entity.enabled)for(let t=0;t<s.length;t++){const e=this.system.app.scene.layers.getLayerById(s[t]);e&&e.addMeshInstances([this.emitter.meshInstance])}}}onLayersChanged(t,e){this.addMeshInstanceToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){if(!this.emitter)return;this.layers.indexOf(t.id)<0||t.addMeshInstances([this.emitter.meshInstance])}onLayerRemoved(t){if(!this.emitter)return;this.layers.indexOf(t.id)<0||t.removeMeshInstances([this.emitter.meshInstance])}_bindColorMapAsset(t){if(t.on("load",this._onColorMapAssetLoad,this),t.on("unload",this._onColorMapAssetUnload,this),t.on("remove",this._onColorMapAssetRemove,this),t.on("change",this._onColorMapAssetChange,this),t.resource)this._onColorMapAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindColorMapAsset(t){t.off("load",this._onColorMapAssetLoad,this),t.off("unload",this._onColorMapAssetUnload,this),t.off("remove",this._onColorMapAssetRemove,this),t.off("change",this._onColorMapAssetChange,this)}_onColorMapAssetLoad(t){this.colorMap=t.resource}_onColorMapAssetUnload(t){this.colorMap=null}_onColorMapAssetRemove(t){this._onColorMapAssetUnload(t)}_onColorMapAssetChange(t){}onSetColorMapAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&this._unbindColorMapAsset(t)}if(s){s instanceof Asset&&(this.data.colorMapAsset=s.id,s=s.id);const t=i.get(s);t?this._bindColorMapAsset(t):i.once("add:"+s,(t=>{this._bindColorMapAsset(t)}))}else this.colorMap=null}_bindNormalMapAsset(t){if(t.on("load",this._onNormalMapAssetLoad,this),t.on("unload",this._onNormalMapAssetUnload,this),t.on("remove",this._onNormalMapAssetRemove,this),t.on("change",this._onNormalMapAssetChange,this),t.resource)this._onNormalMapAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindNormalMapAsset(t){t.off("load",this._onNormalMapAssetLoad,this),t.off("unload",this._onNormalMapAssetUnload,this),t.off("remove",this._onNormalMapAssetRemove,this),t.off("change",this._onNormalMapAssetChange,this)}_onNormalMapAssetLoad(t){this.normalMap=t.resource}_onNormalMapAssetUnload(t){this.normalMap=null}_onNormalMapAssetRemove(t){this._onNormalMapAssetUnload(t)}_onNormalMapAssetChange(t){}onSetNormalMapAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&this._unbindNormalMapAsset(t)}if(s){s instanceof Asset&&(this.data.normalMapAsset=s.id,s=s.id);const t=i.get(s);t?this._bindNormalMapAsset(t):i.once("add:"+s,(t=>{this._bindNormalMapAsset(t)}))}else this.normalMap=null}_bindMeshAsset(t){if(t.on("load",this._onMeshAssetLoad,this),t.on("unload",this._onMeshAssetUnload,this),t.on("remove",this._onMeshAssetRemove,this),t.on("change",this._onMeshAssetChange,this),t.resource)this._onMeshAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindMeshAsset(t){t.off("load",this._onMeshAssetLoad,this),t.off("unload",this._onMeshAssetUnload,this),t.off("remove",this._onMeshAssetRemove,this),t.off("change",this._onMeshAssetChange,this)}_onMeshAssetLoad(t){this._onMeshChanged(t.resource)}_onMeshAssetUnload(t){this.mesh=null}_onMeshAssetRemove(t){this._onMeshAssetUnload(t)}_onMeshAssetChange(t){}onSetMeshAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&this._unbindMeshAsset(t)}if(s){s instanceof Asset&&(this.data.meshAsset=s.id,s=s.id);const t=i.get(s);t&&this._bindMeshAsset(t)}else this._onMeshChanged(null)}onSetMesh(t,e,s){!s||s instanceof Asset||"number"==typeof s?this.meshAsset=s:this._onMeshChanged(s)}_onMeshChanged(t){!t||t instanceof Mesh||(t=t.meshInstances[0]?t.meshInstances[0].mesh:null),this.data.mesh=t,this.emitter&&(this.emitter.mesh=t,this.emitter.resetMaterial(),this.rebuild())}onSetRenderAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&this._unbindRenderAsset(t)}if(s){s instanceof Asset&&(this.data.renderAsset=s.id,s=s.id);const t=i.get(s);t&&this._bindRenderAsset(t)}else this._onRenderChanged(null)}_bindRenderAsset(t){if(t.on("load",this._onRenderAssetLoad,this),t.on("unload",this._onRenderAssetUnload,this),t.on("remove",this._onRenderAssetRemove,this),t.resource)this._onRenderAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindRenderAsset(t){t.off("load",this._onRenderAssetLoad,this),t.off("unload",this._onRenderAssetUnload,this),t.off("remove",this._onRenderAssetRemove,this),t.resource&&t.resource.off("set:meshes",this._onRenderSetMeshes,this)}_onRenderAssetLoad(t){this._onRenderChanged(t.resource)}_onRenderAssetUnload(t){this._onRenderChanged(null)}_onRenderAssetRemove(t){this._onRenderAssetUnload(t)}_onRenderChanged(t){t?(t.off("set:meshes",this._onRenderSetMeshes,this),t.on("set:meshes",this._onRenderSetMeshes,this),t.meshes&&this._onRenderSetMeshes(t.meshes)):this._onMeshChanged(null)}_onRenderSetMeshes(t){this._onMeshChanged(t&&t[0])}onSetLoop(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.resetTime())}onSetBlendType(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.material.blendType=s,this.emitter.resetMaterial(),this.rebuild())}_requestDepth(){this._requestedDepth||(Bh||(Bh=this.system.app.scene.layers.getLayerById(1)),Bh&&(Bh.incrementCounter(),this._requestedDepth=!0))}_releaseDepth(){this._requestedDepth&&Bh&&(Bh.decrementCounter(),this._requestedDepth=!1)}onSetDepthSoftening(t,e,s){e!==s&&(s?(this.enabled&&this.entity.enabled&&this._requestDepth(),this.emitter&&(this.emitter[t]=s)):(this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[t]=s)),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))}onSetSimpleProperty(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.resetMaterial())}onSetComplexProperty(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.resetMaterial(),this.rebuild(),this.reset())}onSetGraphProperty(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())}onEnable(){const t=this.data;for(let e=0,s=Vh.length;e<s;e++){let s=t[Vh[e]];if(s){if(!(s instanceof Asset)){if(!(parseInt(s,10)>=0))continue;s=this.system.app.assets.get(s)}s&&!s.resource&&this.system.app.assets.load(s)}}if(!this.emitter){let e=t.mesh;e instanceof Mesh||(e=null),this.emitter=new ParticleEmitter(this.system.app.graphicsDevice,{numParticles:t.numParticles,emitterExtents:t.emitterExtents,emitterExtentsInner:t.emitterExtentsInner,emitterRadius:t.emitterRadius,emitterRadiusInner:t.emitterRadiusInner,emitterShape:t.emitterShape,initialVelocity:t.initialVelocity,wrap:t.wrap,localSpace:t.localSpace,screenSpace:t.screenSpace,wrapBounds:t.wrapBounds,lifetime:t.lifetime,rate:t.rate,rate2:t.rate2,orientation:t.orientation,particleNormal:t.particleNormal,animTilesX:t.animTilesX,animTilesY:t.animTilesY,animStartFrame:t.animStartFrame,animNumFrames:t.animNumFrames,animNumAnimations:t.animNumAnimations,animIndex:t.animIndex,randomizeAnimIndex:t.randomizeAnimIndex,animSpeed:t.animSpeed,animLoop:t.animLoop,startAngle:t.startAngle,startAngle2:t.startAngle2,scaleGraph:t.scaleGraph,scaleGraph2:t.scaleGraph2,colorGraph:t.colorGraph,colorGraph2:t.colorGraph2,alphaGraph:t.alphaGraph,alphaGraph2:t.alphaGraph2,localVelocityGraph:t.localVelocityGraph,localVelocityGraph2:t.localVelocityGraph2,velocityGraph:t.velocityGraph,velocityGraph2:t.velocityGraph2,rotationSpeedGraph:t.rotationSpeedGraph,rotationSpeedGraph2:t.rotationSpeedGraph2,radialSpeedGraph:t.radialSpeedGraph,radialSpeedGraph2:t.radialSpeedGraph2,colorMap:t.colorMap,normalMap:t.normalMap,loop:t.loop,preWarm:t.preWarm,sort:t.sort,stretch:t.stretch,alignToMotion:t.alignToMotion,lighting:t.lighting,halfLambert:t.halfLambert,intensity:t.intensity,depthSoftening:t.depthSoftening,scene:this.system.app.scene,mesh:e,depthWrite:t.depthWrite,noFog:t.noFog,node:this.entity,blendType:t.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,t.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)}this.emitter.colorMap&&this.addMeshInstanceToLayers(),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&t.depthSoftening&&this._requestDepth()}onDisable(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.emitter&&(this.removeMeshInstanceFromLayers(),this.data.depthSoftening&&this._releaseDepth(),this.emitter.camera=null)}onBeforeRemove(){this.enabled&&(this.enabled=!1),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(let t=0;t<Vh.length;t++){const e=Vh[t];this.data[e]&&(this[e]=null)}this.off()}reset(){this.emitter&&this.emitter.reset()}stop(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))}pause(){this.data.paused=!0}unpause(){this.data.paused=!1}play(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())}isPlaying(){return!this.data.paused&&(!(!this.emitter||!this.emitter.loop)||Date.now()<=this.emitter.endTime)}rebuild(){const t=this.enabled;this.enabled=!1,this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity),this.enabled=t}}class ParticleSystemComponentData{constructor(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new Vec3,this.emitterExtentsInner=new Vec3,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=0,this.initialVelocity=0,this.wrapBounds=new Vec3,this.localSpace=!1,this.screenSpace=!1,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=!0,this.preWarm=!1,this.sort=0,this.mode=0,this.scene=null,this.lighting=!1,this.halfLambert=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.meshAsset=null,this.mesh=null,this.depthWrite=!1,this.noFog=!1,this.orientation=0,this.particleNormal=new Vec3(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=2,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[0]}}const zh=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"];class ParticleSystemComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="particlesystem",this.ComponentType=ParticleSystemComponent,this.DataType=ParticleSystemComponentData,this.schema=zh,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){const i={};s=[];const n=this.propertyTypes;(e.mesh instanceof Asset||"number"==typeof e.mesh)&&(e.meshAsset=e.mesh,delete e.mesh);for(const a in e){if(e.hasOwnProperty(a)&&(s.push(a),i[a]=e[a]),"vec3"===n[a])Array.isArray(i[a])&&(i[a]=new Vec3(i[a][0],i[a][1],i[a][2]));else if("curve"===n[a]){if(!(i[a]instanceof Curve)){const t=i[a].type;i[a]=new Curve(i[a].keys),i[a].type=t}}else if("curveset"===n[a]&&!(i[a]instanceof CurveSet)){const t=i[a].type;i[a]=new CurveSet(i[a].keys),i[a].type=t}i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0))}super.initializeComponentData(t,i,s)}cloneComponent(t,e){const s=t.particlesystem.data,i=this.schema,n={};for(let a=0,r=i.length;a<r;a++){const t=i[a];let e=s[t];e instanceof Vec3||e instanceof Curve||e instanceof CurveSet?(e=e.clone(),n[t]=e):"layers"===t?n.layers=s.layers.slice(0):null!=e&&(n[t]=e)}return this.addComponent(e,n)}onUpdate(t){const e=this.store;let s;const i=this.app.stats.particles;for(const n in e)if(e.hasOwnProperty(n)){const a=e[n],r=a.entity,o=a.data;if(o.enabled&&r.enabled){const e=r.particlesystem.emitter;if(!e.meshInstance.visible)continue;if(e.lighting){const t=o.layers;let s;for(let i=0;i<t.length;i++){const n=this.app.scene.layers.getLayerById(t[i]);if(!n)continue;n._lightCube||(n._lightCube=new Float32Array(18)),s=n._lightCube;for(let t=0;t<6;t++)s[3*t]=this.app.scene.ambientLight.r,s[3*t+1]=this.app.scene.ambientLight.g,s[3*t+2]=this.app.scene.ambientLight.b;const a=n._splitLights[0];for(let t=0;t<a.length;t++)for(let i=0;i<6;i++){const n=Math.max(e.lightCubeDir[i].dot(a[t]._direction),0)*a[t]._intensity;s[3*i]+=a[t]._color.r*n,s[3*i+1]+=a[t]._color.g*n,s[3*i+2]+=a[t]._color.b*n}}e.constantLightCube.setValue(s)}if(!o.paused){if(e.simTime+=t,e.simTime>e.fixedTimeStep&&(s=Math.floor(e.simTime/e.fixedTimeStep),e.simTime-=s*e.fixedTimeStep),s){s=Math.min(s,e.maxSubSteps);for(let t=0;t<s;t++)e.addTime(e.fixedTimeStep,!1);i._updatesPerFrame+=s,i._frameTime+=e._addTimeTime,e._addTimeTime=0}e.finishFrame()}}}}onBeforeRemove(t,e){e.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Component._buildAccessors(ParticleSystemComponent.prototype,zh);class ObjectPool{constructor(t,e){this._constructor=t,this._pool=[],this._count=0,this._resize(e)}_resize(t){if(t>this._pool.length)for(let e=this._pool.length;e<t;e++)this._pool[e]=new this._constructor}allocate(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]}freeAll(){this._count=0}}let Uh,Nh,Hh,Wh,Gh,jh,Xh;class RigidBodyComponent extends Component{constructor(t,e){super(t,e),this._angularDamping=0,this._angularFactor=new Vec3(1,1,1),this._angularVelocity=new Vec3,this._body=null,this._friction=.5,this._group=2,this._linearDamping=0,this._linearFactor=new Vec3(1,1,1),this._linearVelocity=new Vec3,this._mask=Rl,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=!1,this._type=Pl}static onLibraryLoaded(){"undefined"==typeof Ammo||Uh||(Uh=new Ammo.btTransform,Nh=new Ammo.btVector3,Hh=new Ammo.btVector3,Wh=new Ammo.btQuaternion,Gh=new Ammo.btVector3(0,0,0))}set angularDamping(t){this._angularDamping!==t&&(this._angularDamping=t,this._body&&this._body.setDamping(this._linearDamping,t))}get angularDamping(){return this._angularDamping}set angularFactor(t){this._angularFactor.equals(t)||(this._angularFactor.copy(t),this._body&&this._type===El&&(Nh.setValue(t.x,t.y,t.z),this._body.setAngularFactor(Nh)))}get angularFactor(){return this._angularFactor}set angularVelocity(t){this._body&&this._type===El&&(this._body.activate(),Nh.setValue(t.x,t.y,t.z),this._body.setAngularVelocity(Nh),this._angularVelocity.copy(t))}get angularVelocity(){if(this._body&&this._type===El){const t=this._body.getAngularVelocity();this._angularVelocity.set(t.x(),t.y(),t.z())}return this._angularVelocity}set body(t){this._body!==t&&(this._body=t,t&&this._simulationEnabled&&t.activate())}get body(){return this._body}set friction(t){this._friction!==t&&(this._friction=t,this._body&&this._body.setFriction(t))}get friction(){return this._friction}set group(t){this._group!==t&&(this._group=t,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get group(){return this._group}set linearDamping(t){this._linearDamping!==t&&(this._linearDamping=t,this._body&&this._body.setDamping(t,this._angularDamping))}get linearDamping(){return this._linearDamping}set linearFactor(t){this._linearFactor.equals(t)||(this._linearFactor.copy(t),this._body&&this._type===El&&(Nh.setValue(t.x,t.y,t.z),this._body.setLinearFactor(Nh)))}get linearFactor(){return this._linearFactor}set linearVelocity(t){this._body&&this._type===El&&(this._body.activate(),Nh.setValue(t.x,t.y,t.z),this._body.setLinearVelocity(Nh),this._linearVelocity.copy(t))}get linearVelocity(){if(this._body&&this._type===El){const t=this._body.getLinearVelocity();this._linearVelocity.set(t.x(),t.y(),t.z())}return this._linearVelocity}set mask(t){this._mask!==t&&(this._mask=t,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get mask(){return this._mask}set mass(t){if(this._mass!==t&&(this._mass=t,this._body&&this._type===El)){const e=this.enabled&&this.entity.enabled;e&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(t,Nh),this._body.setMassProps(t,Nh),this._body.updateInertiaTensor(),e&&this.enableSimulation()}}get mass(){return this._mass}set restitution(t){this._restitution!==t&&(this._restitution=t,this._body&&this._body.setRestitution(t))}get restitution(){return this._restitution}set rollingFriction(t){this._rollingFriction!==t&&(this._rollingFriction=t,this._body&&this._body.setRollingFriction(t))}get rollingFriction(){return this._rollingFriction}set type(t){if(this._type!==t){switch(this._type=t,this.disableSimulation(),t){case El:this._group=1,this._mask=65535;break;case Ll:this._group=4,this._mask=65535;break;default:this._group=2,this._mask=Rl}this.createBody()}}get type(){return this._type}createBody(){const t=this.entity;let e;if(t.collision&&(e=t.collision.shape,t.trigger&&(t.trigger.destroy(),delete t.trigger)),e){this._body&&this.system.onRemove(t,this);const s=this._type===El?this._mass:0;this._getEntityTransform(Uh);const i=this.system.createBody(s,e,Uh);if(i.setRestitution(this._restitution),i.setFriction(this._friction),i.setRollingFriction(this._rollingFriction),i.setDamping(this._linearDamping,this._angularDamping),this._type===El){const t=this._linearFactor;Nh.setValue(t.x,t.y,t.z),i.setLinearFactor(Nh);const e=this._angularFactor;Nh.setValue(e.x,e.y,e.z),i.setAngularFactor(Nh)}else this._type===Ll&&(i.setCollisionFlags(2|i.getCollisionFlags()),i.setActivationState(4));i.entity=t,this.body=i,this.enabled&&t.enabled&&this.enableSimulation()}}isActive(){return!!this._body&&this._body.isActive()}activate(){this._body&&this._body.activate()}enableSimulation(){const t=this.entity;if(t.collision&&t.collision.enabled&&!this._simulationEnabled){const e=this._body;if(e){switch(this.system.addBody(e,this._group,this._mask),this._type){case El:this.system._dynamic.push(this),e.forceActivationState(1),this.syncEntityToBody();break;case Ll:this.system._kinematic.push(this),e.forceActivationState(4);break;case Pl:e.forceActivationState(1),this.syncEntityToBody()}"compound"===t.collision.type&&this.system._compounds.push(t.collision),e.activate(),this._simulationEnabled=!0}}}disableSimulation(){const t=this._body;if(t&&this._simulationEnabled){const e=this.system;let s=e._compounds.indexOf(this.entity.collision);s>-1&&e._compounds.splice(s,1),s=e._dynamic.indexOf(this),s>-1&&e._dynamic.splice(s,1),s=e._kinematic.indexOf(this),s>-1&&e._kinematic.splice(s,1),e.removeBody(t),t.forceActivationState(5),this._simulationEnabled=!1}}applyForce(){let t,e,s,i,n,a;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 2:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z,i=arguments[1].x,n=arguments[1].y,a=arguments[1].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;case 6:t=arguments[0],e=arguments[1],s=arguments[2],i=arguments[3],n=arguments[4],a=arguments[5]}const r=this._body;r&&(r.activate(),Nh.setValue(t,e,s),void 0!==i?(Hh.setValue(i,n,a),r.applyForce(Nh,Hh)):r.applyForce(Nh,Gh))}applyTorque(){let t,e,s;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;default:return}const i=this._body;i&&(i.activate(),Nh.setValue(t,e,s),i.applyTorque(Nh))}applyImpulse(){let t,e,s,i,n,a;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 2:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z,i=arguments[1].x,n=arguments[1].y,a=arguments[1].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;case 6:t=arguments[0],e=arguments[1],s=arguments[2],i=arguments[3],n=arguments[4],a=arguments[5];break;default:return}const r=this._body;r&&(r.activate(),Nh.setValue(t,e,s),void 0!==i?(Hh.setValue(i,n,a),r.applyImpulse(Nh,Hh)):r.applyImpulse(Nh,Gh))}applyTorqueImpulse(){let t,e,s;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;default:return}const i=this._body;i&&(i.activate(),Nh.setValue(t,e,s),i.applyTorqueImpulse(Nh))}isStatic(){return this._type===Pl}isStaticOrKinematic(){return this._type===Pl||this._type===Ll}isKinematic(){return this._type===Ll}_getEntityTransform(t){const e=this.entity,s=e.getPosition(),i=e.getRotation();Nh.setValue(s.x,s.y,s.z),Wh.setValue(i.x,i.y,i.z,i.w),t.setOrigin(Nh),t.setRotation(Wh)}syncEntityToBody(){const t=this._body;if(t){if(this._getEntityTransform(Uh),t.setWorldTransform(Uh),this._type===Ll){const e=t.getMotionState();e&&e.setWorldTransform(Uh)}t.activate()}}_updateDynamic(){const t=this._body;if(t.isActive()){const e=t.getMotionState();if(e){e.getWorldTransform(Uh);const t=Uh.getOrigin(),s=Uh.getRotation();this.entity.setPosition(t.x(),t.y(),t.z()),this.entity.setRotation(s.x(),s.y(),s.z(),s.w())}}}_updateKinematic(){const t=this._body.getMotionState();t&&(this._getEntityTransform(Uh),t.setWorldTransform(Uh))}teleport(){arguments.length<3?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof Quat?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2])),this.syncEntityToBody()}onEnable(){this._body||this.createBody(),this.enableSimulation()}onDisable(){this.disableSimulation()}}class RigidBodyComponentData{constructor(){this.enabled=!0}}class RaycastResult{constructor(t,e,s){this.entity=t,this.point=e,this.normal=s}}class SingleContactResult{constructor(t,e,s){0===arguments.length?(this.a=null,this.b=null,this.impulse=0,this.localPointA=new Vec3,this.localPointB=new Vec3,this.pointA=new Vec3,this.pointB=new Vec3,this.normal=new Vec3):(this.a=t,this.b=e,this.impulse=s.impulse,this.localPointA=s.localPoint,this.localPointB=s.localPointOther,this.pointA=s.point,this.pointB=s.pointOther,this.normal=s.normal)}}class ContactPoint{constructor(t=new Vec3,e=new Vec3,s=new Vec3,i=new Vec3,n=new Vec3,a=0){this.localPoint=t,this.localPointOther=e,this.point=s,this.pointOther=i,this.normal=n,this.impulse=a}}class ContactResult{constructor(t,e){this.other=t,this.contacts=e}}const qh=["enabled"];class RigidBodyComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="rigidbody",this._stats=t.stats.frame,this.ComponentType=RigidBodyComponent,this.DataType=RigidBodyComponentData,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=qh,this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new Vec3(0,-9.81,0),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}onLibraryLoaded(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){const t=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(t)}jh=new Ammo.btVector3,Xh=new Ammo.btVector3,RigidBodyComponent.onLibraryLoaded(),this.contactPointPool=new ObjectPool(ContactPoint,1),this.contactResultPool=new ObjectPool(ContactResult,1),this.singleContactResultPool=new ObjectPool(SingleContactResult,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)}initializeComponentData(t,e,s){const i=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];for(const n of i)if(e.hasOwnProperty(n)){const s=e[n];Array.isArray(s)?t[n]=new Vec3(s[0],s[1],s[2]):t[n]=s}super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.rigidbody,i={enabled:s.enabled,mass:s.mass,linearDamping:s.linearDamping,angularDamping:s.angularDamping,linearFactor:[s.linearFactor.x,s.linearFactor.y,s.linearFactor.z],angularFactor:[s.angularFactor.x,s.angularFactor.y,s.angularFactor.z],friction:s.friction,rollingFriction:s.rollingFriction,restitution:s.restitution,type:s.type,group:s.group,mask:s.mask};this.addComponent(e,i)}onBeforeRemove(t,e){e.enabled&&(e.enabled=!1)}onRemove(t,e){const s=e.body;s&&(this.removeBody(s),this.destroyBody(s),e.body=null)}addBody(t,e,s){void 0!==e&&void 0!==s?this.dynamicsWorld.addRigidBody(t,e,s):this.dynamicsWorld.addRigidBody(t)}removeBody(t){this.dynamicsWorld.removeRigidBody(t)}createBody(t,e,s){const i=new Ammo.btVector3(0,0,0);0!==t&&e.calculateLocalInertia(t,i);const n=new Ammo.btDefaultMotionState(s),a=new Ammo.btRigidBodyConstructionInfo(t,n,e,i),r=new Ammo.btRigidBody(a);return Ammo.destroy(a),Ammo.destroy(i),r}destroyBody(t){const e=t.getMotionState();e&&Ammo.destroy(e),Ammo.destroy(t)}raycastFirst(t,e){let s=null;jh.setValue(t.x,t.y,t.z),Xh.setValue(e.x,e.y,e.z);const i=new Ammo.ClosestRayResultCallback(jh,Xh);if(this.dynamicsWorld.rayTest(jh,Xh,i),i.hasHit()){const t=i.get_m_collisionObject(),e=Ammo.castObject(t,Ammo.btRigidBody);if(e){const t=i.get_m_hitPointWorld(),n=i.get_m_hitNormalWorld();if(s=new RaycastResult(e.entity,new Vec3(t.x(),t.y(),t.z()),new Vec3(n.x(),n.y(),n.z())),arguments.length>2){(0,arguments[2])(s)}}}return Ammo.destroy(i),s}raycastAll(t,e){const s=[];jh.setValue(t.x,t.y,t.z),Xh.setValue(e.x,e.y,e.z);const i=new Ammo.AllHitsRayResultCallback(jh,Xh);if(this.dynamicsWorld.rayTest(jh,Xh,i),i.hasHit()){const t=i.get_m_collisionObjects(),e=i.get_m_hitPointWorld(),n=i.get_m_hitNormalWorld(),a=t.size();for(let i=0;i<a;i++){const a=Ammo.castObject(t.at(i),Ammo.btRigidBody);if(a){const t=e.at(i),r=n.at(i),o=new RaycastResult(a.entity,new Vec3(t.x(),t.y(),t.z()),new Vec3(r.x(),r.y(),r.z()));s.push(o)}}}return Ammo.destroy(i),s}_storeCollision(t,e){let s=!1;const i=t.getGuid();return this.collisions[i]=this.collisions[i]||{others:[],entity:t},this.collisions[i].others.indexOf(e)<0&&(this.collisions[i].others.push(e),s=!0),this.frameCollisions[i]=this.frameCollisions[i]||{others:[],entity:t},this.frameCollisions[i].others.push(e),s}_createContactPointFromAmmo(t){const e=t.get_m_localPointA(),s=t.get_m_localPointB(),i=t.getPositionWorldOnA(),n=t.getPositionWorldOnB(),a=t.get_m_normalWorldOnB(),r=this.contactPointPool.allocate();return r.localPoint.set(e.x(),e.y(),e.z()),r.localPointOther.set(s.x(),s.y(),s.z()),r.point.set(i.x(),i.y(),i.z()),r.pointOther.set(n.x(),n.y(),n.z()),r.normal.set(a.x(),a.y(),a.z()),r.impulse=t.getAppliedImpulse(),r}_createReverseContactPointFromAmmo(t){const e=t.get_m_localPointA(),s=t.get_m_localPointB(),i=t.getPositionWorldOnA(),n=t.getPositionWorldOnB(),a=t.get_m_normalWorldOnB(),r=this.contactPointPool.allocate();return r.localPointOther.set(e.x(),e.y(),e.z()),r.localPoint.set(s.x(),s.y(),s.z()),r.pointOther.set(i.x(),i.y(),i.z()),r.point.set(n.x(),n.y(),n.z()),r.normal.set(a.x(),a.y(),a.z()),r.impulse=t.getAppliedImpulse(),r}_createSingleContactResult(t,e,s){const i=this.singleContactResultPool.allocate();return i.a=t,i.b=e,i.localPointA=s.localPoint,i.localPointB=s.localPointOther,i.pointA=s.point,i.pointB=s.pointOther,i.normal=s.normal,i.impulse=s.impulse,i}_createContactResult(t,e){const s=this.contactResultPool.allocate();return s.other=t,s.contacts=e,s}_cleanOldCollisions(){for(const t in this.collisions)if(this.collisions.hasOwnProperty(t)){const e=this.frameCollisions[t],s=this.collisions[t],i=s.entity,n=i.collision,a=i.rigidbody,r=s.others;let o=r.length;for(;o--;){const t=r[o];(!e||e.others.indexOf(t)<0)&&(r.splice(o,1),i.trigger?(n&&n.fire("triggerleave",t),t.rigidbody&&t.rigidbody.fire("triggerleave",i)):t.trigger||(a&&a.fire("collisionend",t),n&&n.fire("collisionend",t)))}0===r.length&&delete this.collisions[t]}}_hasContactEvent(t){const e=t.collision;if(e&&(e.hasEvent("collisionstart")||e.hasEvent("collisionend")||e.hasEvent("contact")))return!0;const s=t.rigidbody;return s&&(s.hasEvent("collisionstart")||s.hasEvent("collisionend")||s.hasEvent("contact"))}_checkForCollisions(t,e){const s=Ammo.wrapPointer(t,Ammo.btDynamicsWorld).getDispatcher(),i=s.getNumManifolds();this.frameCollisions={};for(let n=0;n<i;n++){const t=s.getManifoldByIndexInternal(n),e=t.getBody0(),i=t.getBody1(),a=Ammo.castObject(e,Ammo.btRigidBody),r=Ammo.castObject(i,Ammo.btRigidBody),o=a.entity,l=r.entity;if(!o||!l)continue;const h=a.getCollisionFlags(),c=r.getCollisionFlags(),d=t.getNumContacts(),u=[],p=[];let m;if(d>0)if(4&h||4&c){const t=o.collision&&(o.collision.hasEvent("triggerenter")||o.collision.hasEvent("triggerleave")),e=l.collision&&(l.collision.hasEvent("triggerenter")||l.collision.hasEvent("triggerleave")),s=o.rigidbody&&(o.rigidbody.hasEvent("triggerenter")||o.rigidbody.hasEvent("triggerleave")),i=l.rigidbody&&(l.rigidbody.hasEvent("triggerenter")||l.rigidbody.hasEvent("triggerleave"));t&&(m=this._storeCollision(o,l),!m||4&c||o.collision.fire("triggerenter",l)),e&&(m=this._storeCollision(l,o),!m||4&h||l.collision.fire("triggerenter",o)),s&&(m||(m=this._storeCollision(l,o)),m&&o.rigidbody.fire("triggerenter",l)),i&&(m||(m=this._storeCollision(o,l)),m&&l.rigidbody.fire("triggerenter",o))}else{const e=this._hasContactEvent(o),s=this._hasContactEvent(l),i=this.hasEvent("contact");if(i||e||s){for(let n=0;n<d;n++){const a=t.getContactPoint(n),r=this._createContactPointFromAmmo(a);if(e||s){u.push(r);const t=this._createReverseContactPointFromAmmo(a);p.push(t)}if(i){const t=this._createSingleContactResult(o,l,r);this.fire("contact",t)}}if(e){const t=this._createContactResult(l,u);m=this._storeCollision(o,l),o.collision&&(o.collision.fire("contact",t),m&&o.collision.fire("collisionstart",t)),o.rigidbody&&(o.rigidbody.fire("contact",t),m&&o.rigidbody.fire("collisionstart",t))}if(s){const t=this._createContactResult(o,p);m=this._storeCollision(l,o),l.collision&&(l.collision.fire("contact",t),m&&l.collision.fire("collisionstart",t)),l.rigidbody&&(l.rigidbody.fire("contact",t),m&&l.rigidbody.fire("collisionstart",t))}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}onUpdate(t){let e,s;const i=this.dynamicsWorld.getGravity();i.x()===this.gravity.x&&i.y()===this.gravity.y&&i.z()===this.gravity.z||(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));const n=this._triggers;for(e=0,s=n.length;e<s;e++)n[e].updateTransform();const a=this._compounds;for(e=0,s=a.length;e<s;e++)a[e]._updateCompound();const r=this._kinematic;for(e=0,s=r.length;e<s;e++)r[e]._updateKinematic();this.dynamicsWorld.stepSimulation(t,this.maxSubSteps,this.fixedTimeStep);const o=this._dynamic;for(e=0,s=o.length;e<s;e++)o[e]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),t)}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null)}}Component._buildAccessors(RigidBodyComponent.prototype,qh);const $h="none",Yh=new Mat4;class ScreenComponent extends Component{constructor(t,e){super(t,e),this._resolution=new Vec2(640,320),this._referenceResolution=new Vec2(640,320),this._scaleMode=$h,this.scale=1,this._scaleBlend=.5,this._priority=0,this._screenSpace=!1,this.cull=this._screenSpace,this._screenMatrix=new Mat4,this._elements=new Set,t.app.graphicsDevice.on("resizecanvas",this._onResize,this)}syncDrawOrder(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)}_recurseDrawOrderSync(t,e){if(!(t instanceof Entity))return e;if(t.element){const s=t.element.drawOrder;t.element.drawOrder=e++,t.element._batchGroupId>=0&&s!==t.element.drawOrder&&this.system.app.batcher.markGroupDirty(t.element._batchGroupId)}t.particlesystem&&(t.particlesystem.drawOrder=e++);const s=t.children;for(let i=0;i<s.length;i++)e=this._recurseDrawOrderSync(s[i],e);return e}_processDrawOrderSync(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")}_calcProjectionMatrix(){const t=this._resolution.x/this.scale,e=this._resolution.y/this.scale,s=t,i=-e;this._screenMatrix.setOrtho(0,s,i,0,1,-1),this._screenSpace||(Yh.setScale(.5*t,.5*e,1),this._screenMatrix.mul2(Yh,this._screenMatrix))}_updateScale(){this.scale=this._calcScale(this._resolution,this.referenceResolution)}_calcScale(t,e){const s=Math.log2(t.x/e.x),i=Math.log2(t.y/e.y);return Math.pow(2,s*(1-this._scaleBlend)+i*this._scaleBlend)}_onResize(t,e){this._screenSpace&&(this._resolution.set(t,e),this.resolution=this._resolution)}_bindElement(t){this._elements.add(t)}_unbindElement(t){this._elements.delete(t)}onRemove(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach((t=>t._onScreenRemove())),this._elements.clear(),this.off()}set resolution(t){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(t.x,t.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach((t=>t._onScreenResize(this._resolution)))}get resolution(){return this._resolution}set referenceResolution(t){this._referenceResolution.set(t.x,t.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach((t=>t._onScreenResize(this._resolution)))}get referenceResolution(){return this._scaleMode===$h?this._resolution:this._referenceResolution}set screenSpace(t){this._screenSpace=t,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach((t=>t._onScreenSpaceChange()))}get screenSpace(){return this._screenSpace}set scaleMode(t){t!==$h&&"blend"!==t&&(t=$h),this._screenSpace||t===$h||(t=$h),this._scaleMode=t,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)}get scaleMode(){return this._scaleMode}set scaleBlend(t){this._scaleBlend=t,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach((t=>t._onScreenResize(this._resolution)))}get scaleBlend(){return this._scaleBlend}set priority(t){t>255&&(t=255),this._priority=t}get priority(){return this._priority}}class ScreenComponentData{constructor(){this.enabled=!0}}const Kh=["enabled"];class ScreenComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="screen",this.ComponentType=ScreenComponent,this.DataType=ScreenComponentData,this.schema=Kh,this.windowResolution=new Vec2,this._drawOrderSyncQueue=new IndexedList,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),this.app.systems.on("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)}initializeComponentData(t,e,s){void 0!==e.priority&&(t.priority=e.priority),void 0!==e.screenSpace&&(t.screenSpace=e.screenSpace),t.cull=t.screenSpace,void 0!==e.scaleMode&&(t.scaleMode=e.scaleMode),void 0!==e.scaleBlend&&(t.scaleBlend=e.scaleBlend),void 0!==e.resolution&&(e.resolution instanceof Vec2?t._resolution.copy(e.resolution):t._resolution.set(e.resolution[0],e.resolution[1]),t.resolution=t._resolution),void 0!==e.referenceResolution&&(e.referenceResolution instanceof Vec2?t._referenceResolution.copy(e.referenceResolution):t._referenceResolution.set(e.referenceResolution[0],e.referenceResolution[1]),t.referenceResolution=t._referenceResolution),t.syncDrawOrder(),super.initializeComponentData(t,e,s)}destroy(){super.destroy(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.app.systems.off("update",this._onUpdate,this)}_onUpdate(t){const e=this.store;for(const s in e)e[s].entity.screen.update&&e[s].entity.screen.update(t)}_onResize(t,e){this.windowResolution.x=t,this.windowResolution.y=e}cloneComponent(t,e){const s=t.screen;return this.addComponent(e,{enabled:s.enabled,screenSpace:s.screenSpace,scaleMode:s.scaleMode,resolution:s.resolution.clone(),referenceResolution:s.referenceResolution.clone()})}onRemoveComponent(t,e){e.onRemove()}processDrawOrderSyncQueue(){const t=this._drawOrderSyncQueue.list();for(let e=0;e<t.length;e++){const s=t[e];s.callback.call(s.scope)}this._drawOrderSyncQueue.clear()}queueDrawOrderSync(t,e,s){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(t)||this._drawOrderSyncQueue.push(t,{callback:e,scope:s})}}Component._buildAccessors(ScreenComponent.prototype,Kh);class ScriptComponentData{constructor(){this.enabled=!0}}let Zh=0;class ScriptComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="script",this.ComponentType=ScriptComponent,this.DataType=ScriptComponentData,this._components=new SortedLoopArray({sortBy:"_executionOrder"}),this._enabledComponents=new SortedLoopArray({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(t,e){if(t._executionOrder=Zh++,this._components.append(t),Zh>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),t.enabled=!e.hasOwnProperty("enabled")||!!e.enabled,t.enabled&&t.entity.enabled&&this._enabledComponents.append(t),e.hasOwnProperty("order")&&e.hasOwnProperty("scripts")){t._scriptsData=e.scripts;for(let s=0;s<e.order.length;s++)t.create(e.order[s],{enabled:e.scripts[e.order[s]].enabled,attributes:e.scripts[e.order[s]].attributes,preloading:this.preloading})}}cloneComponent(t,e){const s=[],i={};for(let a=0;a<t.script._scripts.length;a++){const e=t.script._scripts[a],n=e.__scriptType.__name;s.push(n);const r={};for(const t in e.__attributes)r[t]=e.__attributes[t];i[n]={enabled:e._enabled,attributes:r}}for(const a in t.script._scriptsIndex)a.awaiting&&s.splice(a.ind,0,a);const n={enabled:t.script.enabled,order:s,scripts:i};return this.addComponent(e,n)}_resetExecutionOrder(){Zh=0;for(let t=0,e=this._components.length;t<e;t++)this._components.items[t]._executionOrder=Zh++}_callComponentMethod(t,e,s){for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++)t.items[t.loopIndex][e](s)}_onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")}_onUpdate(t){this._callComponentMethod(this._enabledComponents,"_onUpdate",t)}_onPostUpdate(t){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",t)}_addComponentToEnabled(t){this._enabledComponents.insert(t)}_removeComponentFromEnabled(t){this._enabledComponents.remove(t)}_onBeforeRemove(t,e){this._components.items.indexOf(e)>=0&&e._onBeforeRemove(),this._removeComponentFromEnabled(e),this._components.remove(e)}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}class ScriptLegacyComponent extends Component{constructor(t,e){super(t,e),this.on("set_scripts",this.onSetScripts,this)}send(t,e){const s=Array.prototype.slice.call(arguments,2),i=this.entity.script.instances;let n;if(i&&i[t]&&(n=i[t].instance[e],n))return n.apply(i[t].instance,s)}onEnable(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))}onDisable(){this.system._disableScriptComponent(this)}onSetScripts(t,e,s){if(!this.system._inTools||this.runInTools){if(this._updateScriptAttributes(e,s))return;this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1;const t=s.map((function(t){return t.url}));if(this._loadFromCache(t))return;this._loadScripts(t)}}_updateScriptAttributes(t,e){let s=!0;if(t.length!==e.length)s=!1;else for(let i=0,n=e.length;i<n;i++)if(t[i].url!==e[i].url){s=!1;break}if(s)for(const i in this.instances)this.instances.hasOwnProperty(i)&&this.system._updateAccessors(this.entity,this.instances[i]);return s}_loadFromCache(t){const e=[],s=this.system.app._scriptPrefix||"",i=/^http(s)?:\/\//i;for(let n=0,a=t.length;n<a;n++){let a=t[n];i.test(a)||(a=c.join(s,a));const r=this.system.app.loader.getFromCache(a,"script");if(!r)return!1;e.push(r)}for(let n=0,a=e.length;n<a;n++){const s=e[n];if(!0!==s&&(s&&this.entity.script&&!this.entity.script.instances[s._pcScriptName])){const e=new s(this.entity);this.system._preRegisterInstance(this.entity,t[n],s._pcScriptName,e)}}return this.data&&(this.data.areScriptsLoaded=!0),this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)),!0}_loadScripts(t){let e=t.length;const s=this.system.app._scriptPrefix||"";t.forEach((t=>{let i=null,n=null;t.toLowerCase().startsWith("http://")||t.toLowerCase().startsWith("https://")?(n=t,i=t):(n=t,i=c.join(s,t)),this.system.app.loader.load(i,"script",((t,s)=>{if(e--,t)console.error(t);else if(s&&this.entity.script&&!this.entity.script.instances[s._pcScriptName]){const t=new s(this.entity);this.system._preRegisterInstance(this.entity,n,s._pcScriptName,t)}0===e&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}))}))}}class ScriptLegacyComponentData{constructor(){this.scripts=[],this.enabled=!0,this.instances={},this._instances={},this.runInTools=!1,this.attributes={},this.initialized=!1,this.postInitialized=!1,this.areScriptsLoaded=!1}}const Qh=["enabled","scripts","instances","runInTools"],Jh="initialize",tc="postInitialize",ec="update",sc="postUpdate",ic="fixedUpdate",nc="toolsUpdate";class ScriptLegacyComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="script",this.ComponentType=ScriptLegacyComponent,this.DataType=ScriptLegacyComponentData,this.schema=Qh,this.preloading=!1,this.instancesWithUpdate=[],this.instancesWithFixedUpdate=[],this.instancesWithPostUpdate=[],this.instancesWithToolsUpdate=[],this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on(Jh,this.onInitialize,this),this.app.systems.on(tc,this.onPostInitialize,this),this.app.systems.on(ec,this.onUpdate,this),this.app.systems.on(ic,this.onFixedUpdate,this),this.app.systems.on(sc,this.onPostUpdate,this),this.app.systems.on(nc,this.onToolsUpdate,this)}initializeComponentData(t,e,s){s=["runInTools","enabled","scripts"],e.scripts&&e.scripts.length&&e.scripts.forEach((function(t){if(t.attributes&&Array.isArray(t.attributes)){const e={};for(let s=0;s<t.attributes.length;s++)e[t.attributes[s].name]=t.attributes[s];t.attributes=e}})),super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=this.store[t.getGuid()],i={runInTools:s.data.runInTools,scripts:[],enabled:s.data.enabled},n=s.data.scripts;for(let a=0,o=n.length;a<o;a++){const t=n[a].attributes;t&&delete n[a].attributes,i.scripts.push(r({},n[a])),t&&(i.scripts[a].attributes=this._cloneAttributes(t),n[a].attributes=t)}return this.addComponent(e,i)}onBeforeRemove(t,e){e.enabled&&this._disableScriptComponent(e),this._destroyScriptComponent(e)}onInitialize(t){if(this._registerInstances(t),t.enabled){t.script&&t.script.enabled&&this._initializeScriptComponent(t.script);const e=t._children;for(let t=0,s=e.length;t<s;t++)e[t]instanceof Entity&&this.onInitialize(e[t])}}onPostInitialize(t){if(t.enabled){t.script&&t.script.enabled&&this._postInitializeScriptComponent(t.script);const e=t._children;for(let t=0,s=e.length;t<s;t++)e[t]instanceof Entity&&this.onPostInitialize(e[t])}}_callInstancesMethod(t,e){const s=t.data.instances;for(const i in s)if(s.hasOwnProperty(i)){const t=s[i].instance;t[e]&&t[e]()}}_initializeScriptComponent(t){this._callInstancesMethod(t,Jh),t.data.initialized=!0,t.enabled&&t.entity.enabled&&this._enableScriptComponent(t)}_enableScriptComponent(t){this._callInstancesMethod(t,"onEnable")}_disableScriptComponent(t){this._callInstancesMethod(t,"onDisable")}_destroyScriptComponent(t){const e=t.data.instances;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s].instance;if(i.destroy&&i.destroy(),i.update){const t=this.instancesWithUpdate.indexOf(i);t>=0&&this.instancesWithUpdate.splice(t,1)}if(i.fixedUpdate){const t=this.instancesWithFixedUpdate.indexOf(i);t>=0&&this.instancesWithFixedUpdate.splice(t,1)}if(i.postUpdate){const t=this.instancesWithPostUpdate.indexOf(i);t>=0&&this.instancesWithPostUpdate.splice(t,1)}if(i.toolsUpdate){const t=this.instancesWithToolsUpdate.indexOf(i);t>=0&&this.instancesWithToolsUpdate.splice(t,1)}t.instances[s].instance===t[s]&&delete t[s],delete t.instances[s]}}_postInitializeScriptComponent(t){this._callInstancesMethod(t,tc),t.data.postInitialized=!0}_updateInstances(t,e,s){for(let i=0,n=e.length;i<n;i++){const n=e[i];n&&n.entity&&n.entity.enabled&&n.entity.script.enabled&&n[t](s)}}onUpdate(t){this._updateInstances(ec,this.instancesWithUpdate,t)}onFixedUpdate(t){this._updateInstances(ic,this.instancesWithFixedUpdate,t)}onPostUpdate(t){this._updateInstances(sc,this.instancesWithPostUpdate,t)}onToolsUpdate(t){this._updateInstances(nc,this.instancesWithToolsUpdate,t)}broadcast(t,e){const s=Array.prototype.slice.call(arguments,2),i=this.store;for(const n in i)if(i.hasOwnProperty(n)){const a=i[n].data;if(a.instances[t]){const i=a.instances[t].instance[e];i&&i.apply(a.instances[t].instance,s)}}}_preRegisterInstance(t,e,s,i){if(t.script){if(t.script.data._instances=t.script.data._instances||{},t.script.data._instances[s])throw Error(`Script name collision '${s}'. Scripts from '${e}' and '${t.script.data._instances[s].url}' {${t.getGuid()}}`);t.script.data._instances[s]={url:e,name:s,instance:i}}}_registerInstances(t){if(t.script&&t.script.data._instances){t.script.instances=t.script.data._instances;for(const e in t.script.instances){const s=t.script.instances[e],i=s.instance;if(l.attach(i),i.update&&this.instancesWithUpdate.push(i),i.fixedUpdate&&this.instancesWithFixedUpdate.push(i),i.postUpdate&&this.instancesWithPostUpdate.push(i),i.toolsUpdate&&this.instancesWithToolsUpdate.push(i),t.script.scripts&&this._createAccessors(t,s),t.script[e])throw Error(`Script with name '${e}' is already attached to Script Component`);t.script[e]=i}delete t.script.data._instances}const e=t._children;for(let s=0,i=e.length;s<i;s++)e[s]instanceof Entity&&this._registerInstances(e[s])}_cloneAttributes(t){const e={};for(const s in t)if(t.hasOwnProperty(s))if("entity"!==t[s].type)e[s]=r({},t[s]);else{const i=t[s].value;delete t[s].value,e[s]=r({},t[s]),e[s].value=i,t[s].value=i}return e}_createAccessors(t,e){const s=t.script.scripts.length,i=e.url;for(let n=0;n<s;n++){const s=t.script.scripts[n];if(s.url===i){const i=s.attributes;if(s.name&&i){for(const t in i)i.hasOwnProperty(t)&&this._createAccessor(i[t],e);t.script.data.attributes[s.name]=this._cloneAttributes(i)}break}}}_createAccessor(t,e){const s=this;t={name:t.name,value:t.value,type:t.type},this._convertAttributeValue(t),Object.defineProperty(e.instance,t.name,{get:function(){return t.value},set:function(i){const n=t.value;t.value=i,s._convertAttributeValue(t),e.instance.fire("set",t.name,n,t.value)},configurable:!0})}_updateAccessors(t,e){const s=t.script.scripts.length,i=e.url;for(let n=0;n<s;n++){const s=t.script,a=s.scripts[n];if(a.url===i){const t=a.name,i=a.attributes;if(t){if(i)for(const t in i)i.hasOwnProperty(t)&&this._createAccessor(i[t],e);const n=s.data.attributes[t];if(n)for(const t in n){const s=n[t];t in i?i[t].value!==s.value&&e.instance.onAttributeChanged&&e.instance.onAttributeChanged(s.name,s.value,i[t].value):delete e.instance[s.name]}i?s.data.attributes[t]=this._cloneAttributes(i):delete s.data.attributes[t]}break}}}_convertAttributeValue(t){if("rgb"===t.type||"rgba"===t.type)Array.isArray(t.value)&&(t.value=3===t.value.length?new Color(t.value[0],t.value[1],t.value[2]):new Color(t.value[0],t.value[1],t.value[2],t.value[3]));else if("vec2"===t.type)Array.isArray(t.value)&&(t.value=new Vec2(t.value[0],t.value[1]));else if("vec3"===t.type||"vector"===t.type)Array.isArray(t.value)&&(t.value=new Vec3(t.value[0],t.value[1],t.value[2]));else if("vec4"===t.type)Array.isArray(t.value)&&(t.value=new Vec4(t.value[0],t.value[1],t.value[2],t.value[3]));else if("entity"===t.type)null!==t.value&&"string"==typeof t.value&&(t.value=this.app.root.findByGuid(t.value));else if("curve"===t.type||"colorcurve"===t.type){const e=t.value.keys[0]instanceof Array?CurveSet:Curve;t.value=new e(t.value.keys),t.value.type=t.value.type}}destroy(){super.destroy(),this.app.systems.off(Jh,this.onInitialize,this),this.app.systems.off(tc,this.onPostInitialize,this),this.app.systems.off(ec,this.onUpdate,this),this.app.systems.off(ic,this.onFixedUpdate,this),this.app.systems.off(sc,this.onPostUpdate,this),this.app.systems.off(nc,this.onToolsUpdate,this)}}Component._buildAccessors(ScriptLegacyComponent.prototype,Qh);const ac=new Vec2,rc=new Vec3,oc=new Vec3,lc=new Vec3,hc=new Vec3,cc=new Vec3,dc=new Quat,uc={x:"y",y:"x"};class ElementDragHelper extends EventHandler{constructor(t,e){if(super(),!(t&&t instanceof ElementComponent))throw new Error("Element was null or not an ElementComponent");if(e&&"x"!==e&&"y"!==e)throw new Error("Unrecognized axis: "+e);this._element=t,this._app=t.system.app,this._axis=e||null,this._enabled=!0,this._dragScale=new Vec3,this._dragStartMousePosition=new Vec3,this._dragStartHandlePosition=new Vec3,this._deltaMousePosition=new Vec3,this._deltaHandlePosition=new Vec3,this._isDragging=!1,this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(t){this._element[t]("mousedown",this._onMouseDownOrTouchStart,this),this._element[t]("touchstart",this._onMouseDownOrTouchStart,this)}_toggleDragListeners(t){const e="on"===t,s=e?"addEventListener":"removeEventListener";this._hasDragListeners&&e||(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse&&(this._app.mouse[t]("mousemove",this._onMove,this),window[s]("mouseup",this._handleMouseUpOrTouchEnd,!1)),S.touch&&(this._app.touch[t]("touchmove",this._onMove,this),window[s]("touchend",this._handleMouseUpOrTouchEnd,!1),window[s]("touchcancel",this._handleMouseUpOrTouchEnd,!1)),this._hasDragListeners=e)}_onMouseDownOrTouchStart(t){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=t.camera,this._calculateDragScale();const e=this._screenToLocal(t);e&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(e),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))}}_onMouseUpOrTouchEnd(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))}_screenToLocal(t){this._determineInputPosition(t),this._chooseRayOriginAndDirection(),hc.copy(this._element.entity.getPosition()),cc.copy(this._element.entity.forward).mulScalar(-1);const e=cc.dot(lc);if(Math.abs(e)>0){const t=hc.sub(oc).dot(cc)/e,s=oc.add(lc.mulScalar(t));return dc.copy(this._element.entity.getRotation()).invert().transformVector(s,s),s.mul(this._dragScale),s}return null}_determineInputPosition(t){const e=this._app.graphicsDevice.maxPixelRatio;void 0!==t.x&&void 0!==t.y?(ac.x=t.x*e,ac.y=t.y*e):t.changedTouches?(ac.x=t.changedTouches[0].x*e,ac.y=t.changedTouches[0].y*e):console.warn("Could not determine position from input event")}_chooseRayOriginAndDirection(){this._element.screen&&this._element.screen.screen.screenSpace?(oc.set(ac.x,-ac.y,0),lc.set(0,0,-1)):(rc.copy(this._dragCamera.screenToWorld(ac.x,ac.y,1)),oc.copy(this._dragCamera.entity.getPosition()),lc.copy(rc).sub(oc).normalize())}_calculateDragScale(){let t=this._element.entity.parent;const e=this._element.screen&&this._element.screen.screen,s=e&&e.screenSpace,i=s?e.scale:1,n=this._dragScale;for(n.set(i,i,i);t&&(n.mul(t.getLocalScale()),t=t.parent,!s||!t.screen););n.x=1/n.x,n.y=1/n.y,n.z=1/n.z}_onMove(t){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled){const e=this._screenToLocal(t);if(this._dragStartMousePosition&&e){if(this._deltaMousePosition.copy(e).sub(this._dragStartMousePosition),this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition),this._axis){const t=this._element.entity.getLocalPosition(),e=uc[this._axis];this._deltaHandlePosition[e]=t[e]}this._element.entity.setLocalPosition(this._deltaHandlePosition),this.fire("drag:move",this._deltaHandlePosition)}}}destroy(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")}set enabled(t){this._enabled=t}get enabled(){return this._enabled}get isDragging(){return this._isDragging}}const pc="mousedown",mc="mousemove",_c="mouseup",fc="mousewheel",gc="touchstart",yc="touchend",vc="touchmove",bc="touchcancel",xc=new Vec2;class ScrollViewComponent extends Component{constructor(t,e){super(t,e),this._viewportReference=new EntityReference(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize}),this._contentReference=new EntityReference(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize}),this._scrollbarUpdateFlags={},this._scrollbarReferences={},this._scrollbarReferences[0]=new EntityReference(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain}),this._scrollbarReferences[1]=new EntityReference(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain}),this._prevContentSizes={},this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._scroll=new Vec2,this._velocity=new Vec3,this._dragStartPosition=new Vec3,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on",t),this._toggleElementListeners("on")}_toggleLifecycleListeners(t,e){this[t]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[t]("set_vertical",this._onSetVerticalScrollingEnabled,this),e.app.systems.element[t]("add",this._onElementComponentAdd,this),e.app.systems.element[t]("beforeremove",this._onElementComponentRemove,this)}_toggleElementListeners(t){if(this.entity.element){if("on"===t&&this._hasElementListeners)return;this.entity.element[t]("resize",this._onSetContentOrViewportSize,this),this.entity.element[t](fc,this._onMouseWheel,this),this._hasElementListeners="on"===t}}_onElementComponentAdd(t){this.entity===t&&this._toggleElementListeners("on")}_onElementComponentRemove(t){this.entity===t&&this._toggleElementListeners("off")}_onViewportElementGain(){this._syncAll()}_onContentElementGain(){this._destroyDragHelper(),this._contentDragHelper=new ElementDragHelper(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._syncAll()}_onContentElementLose(){this._destroyDragHelper()}_onContentDragStart(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())}_onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput()}_onContentDragMove(t){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(t),this._setVelocityFromContentPositionDelta(t),!this._disabledContentInput)){const e=t.x-this._dragStartPosition.x,s=t.y-this._dragStartPosition.y;(Math.abs(e)>this.dragThreshold||Math.abs(s)>this.dragThreshold)&&this._disableContentInput()}}_onSetContentOrViewportSize(){this._syncAll()}_onSetHorizontalScrollbarValue(t){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(t,null)}_onSetVerticalScrollbarValue(t){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,t)}_onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(0)}_onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(1)}_onHorizontalScrollbarGain(){this._syncScrollbarEnabledState(0),this._syncScrollbarPosition(0)}_onVerticalScrollbarGain(){this._syncScrollbarEnabledState(1),this._syncScrollbarPosition(1)}_onSetScroll(t,e,s){!1!==s&&this._velocity.set(0,0,0);let i=!1;i|=this._updateAxis(t,"x",0),i|=this._updateAxis(e,"y",1),i&&this.fire("set:scroll",this._scroll)}_updateAxis(t,e,s){const i=null!==t&&Math.abs(t-this._scroll[e])>1e-5;return(i||this._isDragging()||0===t)&&(this._scroll[e]=this._determineNewScrollValue(t,e,s),this._syncContentPosition(s),this._syncScrollbarPosition(s)),i}_determineNewScrollValue(t,e,s){if(!this._getScrollingEnabled(s))return this._scroll[e];switch(this.scrollMode){case 0:return O.clamp(t,0,this._getMaxScrollValue(s));case 1:return this._setVelocityFromOvershoot(t,e,s),t;case 2:return t;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),t}}_syncAll(){this._syncContentPosition(0),this._syncContentPosition(1),this._syncScrollbarPosition(0),this._syncScrollbarPosition(1),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1)}_syncContentPosition(t){const e=this._getAxis(t),s=this._getSign(t),i=this._contentReference.entity;if(i){const n=this._prevContentSizes[t],a=this._getContentSize(t);if(null!==n&&Math.abs(n-a)>1e-4){const s=this._getMaxOffset(t,n),i=this._getMaxOffset(t,a);this._scroll[e]=0===i?1:O.clamp(this._scroll[e]*s/i,0,1)}const r=this._scroll[e]*this._getMaxOffset(t),o=i.getLocalPosition();o[e]=r*s,i.setLocalPosition(o),this._prevContentSizes[t]=a}}_syncScrollbarPosition(t){const e=this._getAxis(t),s=this._scrollbarReferences[t].entity;s&&s.scrollbar&&(this._scrollbarUpdateFlags[t]=!0,s.scrollbar.value=this._scroll[e],s.scrollbar.handleSize=this._getScrollbarHandleSize(e,t),this._scrollbarUpdateFlags[t]=!1)}_syncScrollbarEnabledState(t){const e=this._scrollbarReferences[t].entity;if(e){const s=this._getScrollingEnabled(t),i=this._getScrollbarVisibility(t);switch(i){case 0:return void(e.enabled=s);case 1:return void(e.enabled=s&&this._contentIsLargerThanViewport(t));default:console.warn("Unhandled scrollbar visibility:"+i),e.enabled=s}}}_contentIsLargerThanViewport(t){return this._getContentSize(t)>this._getViewportSize(t)}_contentPositionToScrollValue(t){const e=this._getMaxOffset(0),s=this._getMaxOffset(1);return xc.x=0===e?0:t.x/e,xc.y=0===s?0:t.y/-s,xc}_getMaxOffset(t,e){e=void 0===e?this._getContentSize(t):e;const s=this._getViewportSize(t);return e<s?-this._getViewportSize(t):s-e}_getMaxScrollValue(t){return this._contentIsLargerThanViewport(t)?1:0}_getScrollbarHandleSize(t,e){const s=this._getViewportSize(e),i=this._getContentSize(e);if(Math.abs(i)<.001)return 1;const n=Math.min(s/i,1),a=this._toOvershoot(this._scroll[t],e);return 0===a?n:n/(1+Math.abs(a))}_getViewportSize(t){return this._getSize(t,this._viewportReference)}_getContentSize(t){return this._getSize(t,this._contentReference)}_getSize(t,e){return e.entity&&e.entity.element?e.entity.element[this._getCalculatedDimension(t)]:0}_getScrollingEnabled(t){return 0===t?this.horizontal:1===t?this.vertical:void console.warn("Unrecognized orientation: "+t)}_getScrollbarVisibility(t){return 0===t?this.horizontalScrollbarVisibility:1===t?this.verticalScrollbarVisibility:void console.warn("Unrecognized orientation: "+t)}_getSign(t){return 0===t?1:-1}_getAxis(t){return 0===t?"x":"y"}_getCalculatedDimension(t){return 0===t?"calculatedWidth":"calculatedHeight"}_destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy()}onUpdate(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1))}_updateVelocity(){if(!this._isDragging()){if(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){const t=this._contentReference.entity.getLocalPosition();t.x+=this._velocity.x,t.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(t),this._setScrollFromContentPosition(t)}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction}}_hasOvershoot(t,e){return Math.abs(this._toOvershoot(this.scroll[t],e))>.001}_toOvershoot(t,e){const s=this._getMaxScrollValue(e);return t<0?t:t>s?t-s:0}_setVelocityFromOvershoot(t,e,s){const i=this._toOvershoot(t,s)*this._getMaxOffset(s)*this._getSign(s);Math.abs(i)>0&&(this._velocity[e]=-i/(50*this.bounceAmount+1))}_setVelocityFromContentPositionDelta(t){this._prevContentDragPosition?(this._velocity.sub2(t,this._prevContentDragPosition),this._prevContentDragPosition.copy(t)):(this._velocity.set(0,0,0),this._prevContentDragPosition=t.clone())}_setScrollFromContentPosition(t){let e=this._contentPositionToScrollValue(t);this._isDragging()&&(e=this._applyScrollValueTension(e)),this._onSetScroll(e.x,e.y,!1)}_applyScrollValueTension(t){let e=this._getMaxScrollValue(0),s=this._toOvershoot(t.x,0);return s>0?t.x=e+1*Math.log10(1+s):s<0&&(t.x=-1*Math.log10(1-s)),e=this._getMaxScrollValue(1),s=this._toOvershoot(t.y,1),s>0?t.y=e+1*Math.log10(1+s):s<0&&(t.y=-1*Math.log10(1-s)),t}_isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging}_setScrollbarComponentsEnabled(t){this._scrollbarReferences[0].hasComponent("scrollbar")&&(this._scrollbarReferences[0].entity.scrollbar.enabled=t),this._scrollbarReferences[1].hasComponent("scrollbar")&&(this._scrollbarReferences[1].entity.scrollbar.enabled=t)}_setContentDraggingEnabled(t){this._contentDragHelper&&(this._contentDragHelper.enabled=t)}_onMouseWheel(t){if(this.useMouseWheel){const e=t.event,s=e.deltaX/this._contentReference.entity.element.calculatedWidth*this.mouseWheelSensitivity.x,i=e.deltaY/this._contentReference.entity.element.calculatedHeight*this.mouseWheelSensitivity.y,n=O.clamp(this._scroll.x+s,0,this._getMaxScrollValue(0)),a=O.clamp(this._scroll.y+i,0,this._getMaxScrollValue(1));this.scroll=new Vec2(n,a)}}_enableContentInput(){for(;this._disabledContentInputEntities.length;){const t=this._disabledContentInputEntities.pop();t.element&&(t.element.useInput=!0)}this._disabledContentInput=!1}_disableContentInput(){const t=e=>{e.element&&e.element.useInput&&(this._disabledContentInputEntities.push(e),e.element.useInput=!1);const s=e.children;for(let i=0,n=s.length;i<n;i++)t(s[i])},e=this._contentReference.entity;if(e){const s=e.children;for(let e=0,i=s.length;e<i;e++)t(s[e])}this._disabledContentInput=!0}onEnable(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[0].onParentComponentEnable(),this._scrollbarReferences[1].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()}onDisable(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)}onRemove(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()}set scroll(t){this._onSetScroll(t.x,t.y)}get scroll(){return this._scroll}}class ScrollViewComponentData{constructor(){this.enabled=!0}}const Sc=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}];class ScrollViewComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="scrollview",this.ComponentType=ScrollViewComponent,this.DataType=ScrollViewComponentData,this.schema=Sc,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){void 0===e.dragThreshold&&(e.dragThreshold=10),void 0===e.useMouseWheel&&(e.useMouseWheel=!0),void 0===e.mouseWheelSensitivity&&(e.mouseWheelSensitivity=new Vec2(1,1)),super.initializeComponentData(t,e,Sc)}onUpdate(t){const e=this.store;for(const s in e){const t=e[s].entity,i=t.scrollview;i.enabled&&t.enabled&&i.onUpdate()}}_onRemoveComponent(t,e){e.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Component._buildAccessors(ScrollViewComponent.prototype,Sc);class ScrollbarComponent extends Component{constructor(t,e){super(t,e),this._app=t.app,this._handleReference=new EntityReference(this,"handleEntity",{"element#gain":this._onHandleElementGain,"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment}),this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(t){this[t]("set_value",this._onSetValue,this),this[t]("set_handleSize",this._onSetHandleSize,this),this[t]("set_orientation",this._onSetOrientation,this)}_onHandleElementGain(){this._destroyDragHelper(),this._handleDragHelper=new ElementDragHelper(this._handleReference.entity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()}_onHandleElementLose(){this._destroyDragHelper()}_onHandleDrag(t){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(t[this._getAxis()]))}_onSetValue(t,e,s){Math.abs(s-e)>1e-5&&(this.data.value=O.clamp(s,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))}_onSetHandleSize(t,e,s){Math.abs(s-e)>1e-5&&(this.data.handleSize=O.clamp(s,0,1),this._updateHandlePositionAndSize())}_onSetHandleAlignment(){this._updateHandlePositionAndSize()}_onSetOrientation(t,e,s){s!==e&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)}_updateHandlePositionAndSize(){const t=this._handleReference.entity,e=t&&t.element;if(t){const e=t.getLocalPosition();e[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(e)}e&&(e[this._getDimension()]=this._getHandleLength())}_handlePositionToScrollValue(t){return t*this._getSign()/this._getUsableTrackLength()}_scrollValueToHandlePosition(t){return t*this._getSign()*this._getUsableTrackLength()}_getUsableTrackLength(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)}_getTrackLength(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0}_getHandleLength(){return this._getTrackLength()*this.handleSize}_getHandlePosition(){return this._scrollValueToHandlePosition(this.value)}_getSign(){return 0===this.orientation?1:-1}_getAxis(){return 0===this.orientation?"x":"y"}_getDimension(){return 0===this.orientation?"width":"height"}_getOppositeDimension(){return 0===this.orientation?"height":"width"}_destroyDragHelper(){this._handleDragHelper&&this._handleDragHelper.destroy()}_setHandleDraggingEnabled(t){this._handleDragHelper&&(this._handleDragHelper.enabled=t)}onEnable(){this._handleReference.onParentComponentEnable(),this._setHandleDraggingEnabled(!0)}onDisable(){this._setHandleDraggingEnabled(!1)}onRemove(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")}}class ScrollbarComponentData{constructor(){this.enabled=!0}}const wc=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}];class ScrollbarComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="scrollbar",this.ComponentType=ScrollbarComponent,this.DataType=ScrollbarComponentData,this.schema=wc,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,wc)}_onRemoveComponent(t,e){e.onRemove()}}Component._buildAccessors(ScrollbarComponent.prototype,wc);function Cc(t,e){return t%e||0}class SoundInstance extends EventHandler{constructor(t,e,s){super(),this._manager=t,this._volume=void 0!==s.volume?O.clamp(Number(s.volume)||0,0,1):1,this._pitch=void 0!==s.pitch?Math.max(.01,Number(s.pitch)||0):1,this._loop=!(void 0===s.loop||!s.loop),this._sound=e,this._state=2,this._suspended=!1,this._suspendEndEvent=!1,this._suspendInstanceEvents=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(s.startTime)||0),this._duration=Math.max(0,Number(s.duration)||0),this._startOffset=null,this.source=null,this._onPlayCallback=s.onPlay,this._onPauseCallback=s.onPause,this._onResumeCallback=s.onResume,this._onStopCallback=s.onStop,this._onEndCallback=s.onEnd,Wa()?(this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._initializeNodes(),this._endedHandler=this._onEnded.bind(this)):(this._isReady=!1,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._createSource())}set duration(t){this._duration=Math.max(0,Number(t)||0);const e=0===this._state;this.stop(),e&&this.play()}get duration(){return this._sound?this._duration?Cc(this._duration,this._sound.duration):this._sound.duration:0}get isPaused(){return 1===this._state}get isPlaying(){return 0===this._state}get isStopped(){return 2===this._state}get isSuspended(){return this._suspended}set loop(t){this._loop=!!t,this.source&&(this.source.loop=this._loop)}get loop(){return this._loop}set startTime(t){this._startTime=Math.max(0,Number(t)||0);const e=0===this._state;this.stop(),e&&this.play()}get startTime(){return this._startTime}_onPlay(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)}_onPause(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)}_onResume(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)}_onStop(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)}_onEnded(){this._suspendEndEvent?this._suspendEndEvent=!1:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())}_onManagerVolumeChange(){this.volume=this._volume}_onManagerSuspend(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())}_onManagerResume(){this._suspended&&(this._suspended=!1,this.resume())}}Wa()?(Object.assign(SoundInstance.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)},play:function(){2!==this._state&&this.stop(),this.source||this._createSource();let t=Cc(this._startOffset,this.duration);return t=Cc(this._startTime+t,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=t,this._state=0,this._playWhenLoaded=!1,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0},pause:function(){return this._playWhenLoaded=!1,!(0!==this._state||!this.source)&&(this._updateCurrentTime(),this._state=1,this._suspendEndEvent=!0,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){if(1!==this._state)return!1;this.source||this._createSource();let t=this.currentTime;return null!==this._startOffset&&(t=Cc(this._startOffset,this.duration),t=Cc(this._startTime+t,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._state=0,this._startedAt=this._manager.context.currentTime,this._currentOffset=t,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume(),!0},stop:function(){return this._playWhenLoaded=!1,!(2===this._state||!this.source)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent=!0,0===this._state&&this.source.stop(0),this.source=null,this._state=2,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(t,e){if(!t)return void console.error("The firstNode must be a valid Audio Node");e||(e=t);const s=this._manager.context.destination;this._firstNode!==t&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(s),this._firstNode=t,this._connectorNode.connect(t)),this._lastNode!==e&&(this._lastNode&&this._lastNode.disconnect(s),this._lastNode=e,this._lastNode.connect(s))},clearExternalNodes:function(){const t=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(t),this._lastNode=null),this._connectorNode.connect(t)},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_createSource:function(){if(!this._sound)return null;const t=this._manager.context;return this._sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=Cc(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,Cc(this._startTime+this._duration,this.source.buffer.duration)))),this.source},_updateCurrentTime:function(){this._currentTime=Cc((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)},_onManagerDestroy:function(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}),Object.defineProperty(SoundInstance.prototype,"volume",{get:function(){return this._volume},set:function(t){t=O.clamp(t,0,1),this._volume=t,this.gain&&(this.gain.gain.value=t*this._manager.volume)}}),Object.defineProperty(SoundInstance.prototype,"pitch",{get:function(){return this._pitch},set:function(t){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(t)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(SoundInstance.prototype,"sound",{get:function(){return this._sound},set:function(t){this._sound=t,2!==this._state?this.stop():this._createSource()}}),Object.defineProperty(SoundInstance.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0},set:function(t){if(!(t<0))if(0===this._state){const e=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this.stop(),this._startOffset=t,this.play(),this._suspendInstanceEvents=e}else this._startOffset=t,this._currentTime=t}})):(Object.assign(SoundInstance.prototype,{play:function(){return 2!==this._state&&this.stop(),!(!this.source&&!this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!(!this.source||0!==this._state)&&(this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!(!this.source||1!==this._state)&&(this._state=0,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!(!this.source||2===this._state)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;let t=Cc(this._startOffset,this.duration);t=Cc(this._startTime+t,this._sound.duration),this._startOffset=null,this.source.currentTime=t},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>Cc(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=Cc(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(SoundInstance.prototype,"volume",{get:function(){return this._volume},set:function(t){t=O.clamp(t,0,1),this._volume=t,this.source&&(this.source.volume=t*this._manager.volume)}}),Object.defineProperty(SoundInstance.prototype,"pitch",{get:function(){return this._pitch},set:function(t){this._pitch=Math.max(Number(t)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(SoundInstance.prototype,"sound",{get:function(){return this._sound},set:function(t){this.stop(),this._sound=t}}),Object.defineProperty(SoundInstance.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(t){t<0||(this._startOffset=t,this.source&&this._isReady&&(this.source.currentTime=Cc(this._startTime+Cc(t,this.duration),this._sound.duration),this._startOffset=null))}}));class SoundInstance3d extends SoundInstance{constructor(t,e,s){super(t,e,s),s=s||{},this._position=new Vec3,s.position&&(this.position=s.position),this._velocity=new Vec3,s.velocity&&(this.velocity=s.velocity),this.maxDistance=void 0!==s.maxDistance?Number(s.maxDistance):1e4,this.refDistance=void 0!==s.refDistance?Number(s.refDistance):1,this.rollOffFactor=void 0!==s.rollOffFactor?Number(s.rollOffFactor):1,this.distanceModel=void 0!==s.distanceModel?s.distanceModel:Ga}}if(Wa())Object.assign(SoundInstance3d.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(SoundInstance3d.prototype,"position",{get:function(){return this._position},set:function(t){this._position.copy(t),this.panner.setPosition(t.x,t.y,t.z)}}),Object.defineProperty(SoundInstance3d.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity.copy(t),this.panner.setVelocity(t.x,t.y,t.z)}}),Object.defineProperty(SoundInstance3d.prototype,"maxDistance",{get:function(){return this.panner.maxDistance},set:function(t){this.panner.maxDistance=t}}),Object.defineProperty(SoundInstance3d.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(t){this.panner.refDistance=t}}),Object.defineProperty(SoundInstance3d.prototype,"rollOffFactor",{get:function(){return this.panner.rolloffFactor},set:function(t){this.panner.rolloffFactor=t}}),Object.defineProperty(SoundInstance3d.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},set:function(t){this.panner.distanceModel=t}});else{let t=new Vec3;const e=function(e,s,i,n,a,r){t=t.sub2(e,s);const o=t.length();if(o<i)return 1;if(o>n)return 0;let l=0;return r===Ga?l=1-a*(o-i)/(n-i):r===ja?l=i/(i+a*(o-i)):r===Xa&&(l=Math.pow(o/i,-a)),O.clamp(l,0,1)};Object.defineProperty(SoundInstance3d.prototype,"position",{get:function(){return this._position},set:function(t){if(this._position.copy(t),this.source){const t=this._manager.listener.getPosition(),s=e(t,this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.volume;this.source.volume=i*s*this._manager.volume}}}),Object.defineProperty(SoundInstance3d.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity.copy(t)}}),Object.defineProperty(SoundInstance3d.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){this._maxDistance=t}}),Object.defineProperty(SoundInstance3d.prototype,"refDistance",{get:function(){return this._refDistance},set:function(t){this._refDistance=t}}),Object.defineProperty(SoundInstance3d.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t}}),Object.defineProperty(SoundInstance3d.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(t){this._distanceModel=t}})}const Tc={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new Vec3,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};class SoundSlot extends EventHandler{constructor(t,e="Untitled",s={}){super(),this.name=void 0,this.instances=[],this._component=t,this._assets=t.system.app.assets,this._manager=t.system.manager,this.name=e,this._volume=void 0!==s.volume?O.clamp(Number(s.volume)||0,0,1):1,this._pitch=void 0!==s.pitch?Math.max(.01,Number(s.pitch)||0):1,this._loop=!(void 0===s.loop||!s.loop),this._duration=s.duration>0?s.duration:null,this._startTime=Math.max(0,Number(s.startTime)||0),this._overlap=!!s.overlap,this._autoPlay=!!s.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=s.asset,this._asset instanceof Asset&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this)}play(){if(this.overlap||this.stop(),!this.isLoaded&&!this._hasAsset())return;const t=this._createInstance();if(this.instances.push(t),this.isLoaded)t.play();else{const e=function(e){const s=t._playWhenLoaded;t.sound=e,s&&t.play()};this.off("load",e),this.once("load",e),this.load()}return t}pause(){let t=!1;const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].pause()&&(t=!0);return t}resume(){let t=!1;const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].resume()&&(t=!0);return t}stop(){let t=!1;const e=this.instances;let s=e.length;for(;s--;)e[s].stop(),t=!0;return e.length=0,t}load(){if(!this._hasAsset())return;const t=this._assets.get(this._asset);return t?(t.off("remove",this._onAssetRemoved,this),t.on("remove",this._onAssetRemoved,this),t.resource?void this.fire("load",t.resource):(t.off("load",this._onAssetLoad,this),t.once("load",this._onAssetLoad,this),void this._assets.load(t))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),void this._assets.once("add:"+this._asset,this._onAssetAdd,this))}setExternalNodes(t,e){if(t){if(e||(e=t),this._firstNode=t,this._lastNode=e,!this._overlap){const s=this.instances;for(let i=0,n=s.length;i<n;i++)s[i].setExternalNodes(t,e)}}else console.error("The firstNode must have a valid AudioNode")}clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].clearExternalNodes()}}getExternalNodes(){return[this._firstNode,this._lastNode]}_hasAsset(){return null!=this._asset}_createInstance(){let t=null;const e=this._component;let s=null;if(this._hasAsset()){const t=this._assets.get(this._asset);t&&(s=t.resource)}const i=Tc;return i.volume=this._volume*e.volume,i.pitch=this._pitch*e.pitch,i.loop=this._loop,i.startTime=this._startTime,i.duration=this._duration,i.onPlay=this._onInstancePlayHandler,i.onPause=this._onInstancePauseHandler,i.onResume=this._onInstanceResumeHandler,i.onStop=this._onInstanceStopHandler,i.onEnd=this._onInstanceEndHandler,e.positional?(i.position.copy(e.entity.getPosition()),i.maxDistance=e.maxDistance,i.refDistance=e.refDistance,i.rollOffFactor=e.rollOffFactor,i.distanceModel=e.distanceModel,t=new SoundInstance3d(this._manager,s,i)):t=new SoundInstance(this._manager,s,i),this._firstNode&&t.setExternalNodes(this._firstNode,this._lastNode),t}_onInstancePlay(t){this.fire("play",t),this._component.fire("play",this,t)}_onInstancePause(t){this.fire("pause",t),this._component.fire("pause",this,t)}_onInstanceResume(t){this.fire("resume",t),this._component.fire("resume",this,t)}_onInstanceStop(t){const e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1),this.fire("stop",t),this._component.fire("stop",this,t)}_onInstanceEnd(t){const e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1),this.fire("end",t),this._component.fire("end",this,t)}_onAssetAdd(t){this.load()}_onAssetLoad(t){this.load()}_onAssetRemoved(t){t.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+t.id,this._onAssetAdd,this),this.stop()}updatePosition(t){const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].position=t}set asset(t){const e=this._asset;if(e){this._assets.off("add:"+e,this._onAssetAdd,this);const t=this._assets.get(e);t&&t.off("remove",this._onAssetRemoved,this)}this._asset=t,this._asset instanceof Asset&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}get asset(){return this._asset}set autoPlay(t){this._autoPlay=!!t}get autoPlay(){return this._autoPlay}set duration(t){if(this._duration=Math.max(0,Number(t)||0)||null,!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].duration=this._duration}}get duration(){let t=0;if(this._hasAsset()){const e=this._assets.get(this._asset);t=null!=e&&e.resource?e.resource.duration:0}return null!=this._duration?this._duration%(t||1):t}get isLoaded(){if(this._hasAsset()){const t=this._assets.get(this._asset);if(t)return!!t.resource}return!1}get isPaused(){const t=this.instances,e=t.length;if(0===e)return!1;for(let s=0;s<e;s++)if(!t[s].isPaused)return!1;return!0}get isPlaying(){const t=this.instances;for(let e=0,s=t.length;e<s;e++)if(t[e].isPlaying)return!0;return!1}get isStopped(){const t=this.instances;for(let e=0,s=t.length;e<s;e++)if(!t[e].isStopped)return!1;return!0}set loop(t){this._loop=!!t;const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].loop=this._loop}get loop(){return this._loop}set overlap(t){this._overlap=!!t}get overlap(){return this._overlap}set pitch(t){if(this._pitch=Math.max(Number(t)||0,.01),!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].pitch=this.pitch*this._component.pitch}}get pitch(){return this._pitch}set startTime(t){if(this._startTime=Math.max(0,Number(t)||0),!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].startTime=this._startTime}}get startTime(){return this._startTime}set volume(t){if(this._volume=O.clamp(Number(t)||0,0,1),!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].volume=this._volume*this._component.volume}}get volume(){return this._volume}}class SoundComponent extends Component{constructor(t,e){super(t,e),this._volume=1,this._pitch=1,this._positional=!0,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel=Ga,this._slots={},this._playingBeforeDisable={}}_updateSoundInstances(t,e,s){const i=this._slots;for(const n in i){const a=i[n];if(!a.overlap){const i=a.instances;for(let n=0,r=i.length;n<r;n++)i[n][t]=s?a[t]*e:e}}}set distanceModel(t){this._distanceModel=t,this._updateSoundInstances("distanceModel",t,!1)}get distanceModel(){return this._distanceModel}set maxDistance(t){this._maxDistance=t,this._updateSoundInstances("maxDistance",t,!1)}get maxDistance(){return this._maxDistance}set refDistance(t){this._refDistance=t,this._updateSoundInstances("refDistance",t,!1)}get refDistance(){return this._refDistance}set rollOffFactor(t){this._rollOffFactor=t,this._updateSoundInstances("rollOffFactor",t,!1)}get rollOffFactor(){return this._rollOffFactor}set pitch(t){this._pitch=t,this._updateSoundInstances("pitch",t,!0)}get pitch(){return this._pitch}set volume(t){this._volume=t,this._updateSoundInstances("volume",t,!0)}get volume(){return this._volume}set positional(t){this._positional=t;const e=this._slots;for(const s in e){const t=e[s];if(!t.overlap){const e=t.instances;for(let s=e.length-1;s>=0;s--){const i=e[s].isPlaying||e[s].isSuspended,n=e[s].currentTime;i&&e[s].stop();const a=t._createInstance();i&&(a.play(),a.currentTime=n),e.push(a)}}}}get positional(){return this._positional}set slots(t){const e=this._slots;if(e)for(const i in e)e[i].stop();const s={};for(const i in t)t[i]instanceof SoundSlot?s[t[i].name]=t[i]:t[i].name&&(s[t[i].name]=new SoundSlot(this,t[i].name,t[i]));this._slots=s,this.enabled&&this.entity.enabled&&this.onEnable()}get slots(){return this._slots}onEnable(){if(this.system._inTools)return;const t=this._slots,e=this._playingBeforeDisable;for(const s in t){const i=t[s];i.autoPlay&&i.isStopped?i.play():e[s]?i.resume():i.isLoaded||i.load()}}onDisable(){const t=this._slots,e={};for(const s in t)t[s].overlap||t[s].isPlaying&&(t[s].pause(),e[s]=!0);this._playingBeforeDisable=e}onRemove(){this.off()}addSlot(t,e){const s=this._slots;if(s[t])return null;const i=new SoundSlot(this,t,e);return s[t]=i,i.autoPlay&&this.enabled&&this.entity.enabled&&i.play(),i}removeSlot(t){const e=this._slots;e[t]&&(e[t].stop(),delete e[t])}slot(t){return this._slots[t]}play(t){if(!this.enabled||!this.entity.enabled)return null;const e=this._slots[t];return e?e.play():null}pause(t){const e=this._slots;if(t){const s=e[t];if(!s)return;s.pause()}else for(const s in e)e[s].pause()}resume(t){const e=this._slots;if(t){const s=e[t];if(!s)return;s.isPaused&&s.resume()}else for(const s in e)e[s].resume()}stop(t){const e=this._slots;if(t){const s=e[t];if(!s)return;s.stop()}else for(const s in e)e[s].stop()}}class SoundComponentData{constructor(){this.enabled=!0}}const Mc=["enabled"];class SoundComponentSystem extends ComponentSystem{constructor(t,e){super(t),this.id="sound",this.ComponentType=SoundComponent,this.DataType=SoundComponentData,this.schema=Mc,this.manager=e,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set volume(t){this.manager.volume=t}get volume(){return this.manager.volume}get context(){return Wa()?this.manager.context:null}initializeComponentData(t,e,s){s=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(let i=0;i<s.length;i++)e.hasOwnProperty(s[i])&&(t[s[i]]=e[s[i]]);super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.sound,i=s.slots,n={};for(const r in i){const t=i[r];n[r]={name:t.name,volume:t.volume,pitch:t.pitch,loop:t.loop,duration:t.duration,startTime:t.startTime,overlap:t.overlap,autoPlay:t.autoPlay,asset:t.asset}}const a={distanceModel:s.distanceModel,enabled:s.enabled,maxDistance:s.maxDistance,pitch:s.pitch,positional:s.positional,refDistance:s.refDistance,rollOffFactor:s.rollOffFactor,slots:n,volume:s.volume};return this.addComponent(e,a)}onUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const t=e[s].entity;if(t.enabled){const e=t.sound;if(e.enabled&&e.positional){const s=t.getPosition(),i=e.slots;for(const t in i)i[t].updatePosition(s)}}}}onBeforeRemove(t,e){const s=e.slots;for(const i in s)s[i].overlap||s[i].stop();e.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Component._buildAccessors(SoundComponent.prototype,Mc);const Ac="simple",Pc="animated";class SpriteAnimationClip extends EventHandler{constructor(t,e){super(),this._component=t,this._frame=0,this._sprite=null,this._spriteAsset=null,this.spriteAsset=e.spriteAsset,this.name=e.name,this.fps=e.fps||0,this.loop=e.loop||!1,this._playing=!1,this._paused=!1,this._time=0}get duration(){if(this._sprite){const t=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(t)}return 0}set frame(t){this._setFrame(t);const e=this.fps||Number.MIN_VALUE;this._setTime(this._frame/e)}get frame(){return this._frame}get isPaused(){return this._paused}get isPlaying(){return this._playing}set sprite(t){if(this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=t,this._sprite&&(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this){let e;t&&t.atlas?(t.atlas.texture&&(e=this._component._meshInstance,e&&(e.setParameter("texture_emissiveMap",t.atlas.texture),e.setParameter("texture_opacityMap",t.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):(e=this._component._meshInstance,e&&(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap")),this._component._hideModel())}}get sprite(){return this._sprite}set spriteAsset(t){const e=this._component.system.app.assets;let s=t;if(t instanceof Asset&&(s=t.id),this._spriteAsset!==s){if(this._spriteAsset){const t=e.get(this._spriteAsset);t&&this._unbindSpriteAsset(t)}if(this._spriteAsset=s,this._spriteAsset){const t=e.get(this._spriteAsset);t?this._bindSpriteAsset(t):(this.sprite=null,e.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}}get spriteAsset(){return this._spriteAsset}set time(t){this._setTime(t),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0}get time(){return this._time}_onSpriteAssetAdded(t){this._component.system.app.assets.off("add:"+t.id,this._onSpriteAssetAdded,this),this._spriteAsset===t.id&&this._bindSpriteAsset(t)}_bindSpriteAsset(t){t.on("load",this._onSpriteAssetLoad,this),t.on("remove",this._onSpriteAssetRemove,this),t.resource?this._onSpriteAssetLoad(t):this._component.system.app.assets.load(t)}_unbindSpriteAsset(t){t.off("load",this._onSpriteAssetLoad,this),t.off("remove",this._onSpriteAssetRemove,this),t.resource&&t.resource.atlas&&this._component.system.app.assets.off("load:"+t.data.textureAtlasAsset,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(t){if(t.resource)if(t.resource.atlas)this.sprite=t.resource;else{const e=t.data.textureAtlasAsset,s=this._component.system.app.assets;s.off("load:"+e,this._onTextureAtlasLoad,this),s.once("load:"+e,this._onTextureAtlasLoad,this)}else this.sprite=null}_onTextureAtlasLoad(t){const e=this._spriteAsset;e instanceof Asset?this._onSpriteAssetLoad(e):this._onSpriteAssetLoad(this._component.system.app.assets.get(e))}_onSpriteAssetRemove(t){this.sprite=null}_onSpriteMeshesChange(){this._component.currentClip===this&&this._component._showFrame(this.frame)}_onSpritePpuChanged(){this._component.currentClip===this&&0!==this.sprite.renderMode&&this._component._showFrame(this.frame)}_update(t){if(0===this.fps)return;if(!this._playing||this._paused||!this._sprite)return;const e=this.fps<0?-1:1,s=this._time+t*this._component.speed*e,i=this.duration,n=s>i||s<0;this._setTime(s);let a=this.frame;a=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/i):0,a!==this._frame&&this._setFrame(a),n&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=!1,this._paused=!1,this.fire("end"),this._component.fire("end",this)))}_setTime(t){this._time=t;const e=this.duration;this._time<0?this.loop?this._time=this._time%e+e:this._time=0:this._time>e&&(this.loop?this._time%=e:this._time=e)}_setFrame(t){this._sprite?this._frame=O.clamp(t,0,this._sprite.frameKeys.length-1):this._frame=t,this._component.currentClip===this&&this._component._showFrame(this._frame)}_destroy(){this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)}play(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))}pause(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))}resume(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))}stop(){this._playing&&(this._playing=!1,this._paused=!1,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this))}}const Ec="texture_emissiveMap",Lc="texture_opacityMap",Rc="material_emissive",Ic="material_opacity";class SpriteComponent extends Component{constructor(t,e){super(t,e),this._type=Ac,this._material=t.defaultMaterial,this._color=new Color(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipX=!1,this._flipY=!1,this._width=1,this._height=1,this._drawOrder=0,this._layers=[0],this._outerScale=new Vec2(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new Vec4,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new Vec4,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new GraphNode,this._model=new Model,this._model.graph=this._node,this._meshInstance=null,e.addChild(this._model.graph),this._model._entity=e,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=!1,this._autoPlayClip=null,this._clips={},this._defaultClip=new SpriteAnimationClip(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null}),this._currentClip=this._defaultClip}set type(t){this._type!==t&&(this._type=t,this._type===Ac?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===Pc&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}get type(){return this._type}set frame(t){this._currentClip.frame=t}get frame(){return this._currentClip.frame}set spriteAsset(t){this._defaultClip.spriteAsset=t}get spriteAsset(){return this._defaultClip._spriteAsset}set sprite(t){this._currentClip.sprite=t}get sprite(){return this._currentClip.sprite}set material(t){this._material=t,this._meshInstance&&(this._meshInstance.material=t)}get material(){return this._material}set color(t){this._color.r=t.r,this._color.g=t.g,this._color.b=t.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(Rc,this._colorUniform))}get color(){return this._color}set opacity(t){this._color.a=t,this._meshInstance&&this._meshInstance.setParameter(Ic,t)}get opacity(){return this._color.a}set clips(t){if(t){for(const e in this._clips){let s=!1;for(const i in t)if(t[i].name===e){s=!0,this._clips[e].fps=t[i].fps,this._clips[e].loop=t[i].loop,t[i].hasOwnProperty("sprite")?this._clips[e].sprite=t[i].sprite:t[i].hasOwnProperty("spriteAsset")&&(this._clips[e].spriteAsset=t[i].spriteAsset);break}s||this.removeClip(e)}for(const e in t)this._clips[t[e].name]||this.addClip(t[e]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(const e in this._clips)this.removeClip(e)}get clips(){return this._clips}get currentClip(){return this._currentClip}set speed(t){this._speed=t}get speed(){return this._speed}set flipX(t){this._flipX!==t&&(this._flipX=t,this._updateTransform())}get flipX(){return this._flipX}set flipY(t){this._flipY!==t&&(this._flipY=t,this._updateTransform())}get flipY(){return this._flipY}set width(t){t!==this._width&&(this._width=t,this._outerScale.x=this._width,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}get width(){return this._width}set height(t){t!==this._height&&(this._height=t,this._outerScale.y=this.height,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}get height(){return this._height}set batchGroupId(t){if(this._batchGroupId===t)return;const e=this._batchGroupId;this._batchGroupId=t,this.entity.enabled&&e>=0&&this.system.app.batcher.remove(BatchGroup.SPRITE,e,this.entity),this.entity.enabled&&t>=0?this.system.app.batcher.insert(BatchGroup.SPRITE,t,this.entity):e>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}get batchGroupId(){return this._batchGroupId}set autoPlayClip(t){this._autoPlayClip=t instanceof SpriteAnimationClip?t.name:t,this._tryAutoPlay()}get autoPlayClip(){return this._autoPlayClip}set drawOrder(t){this._drawOrder=t,this._meshInstance&&(this._meshInstance.drawOrder=t)}get drawOrder(){return this._drawOrder}set layers(t){this._addedModel&&this._hideModel(),this._layers=t,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}get layers(){return this._layers}get aabb(){return this._meshInstance?this._meshInstance.aabb:null}onEnable(){const t=this.system.app,e=t.scene;e.on("set:layers",this._onLayersChanged,this),e.layers&&(e.layers.on("add",this._onLayerAdded,this),e.layers.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0&&t.batcher.insert(BatchGroup.SPRITE,this._batchGroupId,this.entity)}onDisable(){const t=this.system.app,e=t.scene;e.off("set:layers",this._onLayersChanged,this),e.layers&&(e.layers.off("add",this._onLayerAdded,this),e.layers.off("remove",this._onLayerRemoved,this)),this.stop(),this._hideModel(),this._batchGroupId>=0&&t.batcher.remove(BatchGroup.SPRITE,this._batchGroupId,this.entity)}onDestroy(){this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(const t in this._clips)this._clips[t]._destroy();this._clips=null,this._hideModel(),this._model=null,this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null),this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null)}_showModel(){if(this._addedModel)return;if(!this._meshInstance)return;const t=[this._meshInstance];for(let e=0,s=this._layers.length;e<s;e++){const s=this.system.app.scene.layers.getLayerById(this._layers[e]);s&&s.addMeshInstances(t)}this._addedModel=!0}_hideModel(){if(!this._addedModel||!this._meshInstance)return;const t=[this._meshInstance];for(let e=0,s=this._layers.length;e<s;e++){const s=this.system.app.scene.layers.getLayerById(this._layers[e]);s&&s.removeMeshInstances(t)}this._addedModel=!1}_showFrame(t){if(!this.sprite)return;const e=this.sprite.meshes[t];if(!e)return void(this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1));let s;if(s=1===this.sprite.renderMode?this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial,this._meshInstance||(this._meshInstance=new MeshInstance(e,this._material,this._node),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(Rc,this._colorUniform),this._meshInstance.setParameter(Ic,this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==s&&(this._meshInstance.material=s),this._meshInstance.mesh!==e&&(this._meshInstance.mesh=e,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter(Ec,this.sprite.atlas.texture),this._meshInstance.setParameter(Lc,this.sprite.atlas.texture)):(this._meshInstance.deleteParameter(Ec),this._meshInstance.deleteParameter(Lc)),!this.sprite.atlas||1!==this.sprite.renderMode&&2!==this.sprite.renderMode)this._meshInstance._updateAabbFunc=null;else{this._meshInstance._updateAabbFunc=this._updateAabbFunc;const e=this.sprite.atlas.frames[this.sprite.frameKeys[t]];if(e){const t=2/e.rect.z,s=2/e.rect.w;this._innerOffset.set(e.border.x*t,e.border.y*s,e.border.z*t,e.border.w*s);const i=this.sprite.atlas.texture;this._atlasRect.set(e.rect.x/i.width,e.rect.y/i.height,e.rect.z/i.width,e.rect.w/i.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform)}this._updateTransform()}_updateTransform(){let t=this.flipX?-1:1,e=this.flipY?-1:1,s=0,i=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){let n=1,a=1;if(this.sprite.atlas){const t=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];t&&(n=t.rect.z,a=t.rect.w,s=(.5-t.pivot.x)*this._width,i=(.5-t.pivot.y)*this._height)}const r=n/this.sprite.pixelsPerUnit,o=a/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*r),Math.max(this._height,this._innerOffset.y*o)),t*=r,e*=o,this._outerScale.x/=r,this._outerScale.y/=o,t*=O.clamp(this._width/(this._innerOffset.x*r),1e-4,1),e*=O.clamp(this._height/(this._innerOffset.y*o),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform))}this._node.setLocalScale(t,e,1),this._node.setLocalPosition(s,i,0)}_updateAabb(t){return t.center.set(0,0,0),t.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),t.setFromTransformedAabb(t,this._node.getWorldTransform()),t}_tryAutoPlay(){if(!this._autoPlayClip)return;if(this.type!==Pc)return;const t=this._clips[this._autoPlayClip];!t||t.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(t.name)}_onLayersChanged(t,e){t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()}_onLayerAdded(t){this.layers.indexOf(t.id)<0||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&t.addMeshInstances([this._meshInstance])}_onLayerRemoved(t){if(!this._meshInstance)return;this.layers.indexOf(t.id)<0||t.removeMeshInstances([this._meshInstance])}removeModelFromLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.removeMeshInstances([this._meshInstance])}}addClip(t){const e=new SpriteAnimationClip(this,{name:t.name,fps:t.fps,loop:t.loop,spriteAsset:t.spriteAsset});return this._clips[t.name]=e,e.name&&e.name===this._autoPlayClip&&this._tryAutoPlay(),e}removeClip(t){delete this._clips[t]}clip(t){return this._clips[t]}play(t){const e=this._clips[t],s=this._currentClip;return s&&s!==e&&(s._playing=!1),this._currentClip=e,this._currentClip&&(this._currentClip=e,this._currentClip.play()),e}pause(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()}resume(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()}stop(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}}class SpriteComponentData{constructor(){this.enabled=!0}}const Dc=["enabled"];class SpriteComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="sprite",this.ComponentType=SpriteComponent,this.DataType=SpriteComponentData,this.schema=Dc,this._defaultTexture=null,this._defaultMaterial=null,this._default9SlicedMaterialSlicedMode=null,this._default9SlicedMaterialTiledMode=null,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set defaultMaterial(t){this._defaultMaterial=t}get defaultMaterial(){if(!this._defaultMaterial){const t=new Texture(this.app.graphicsDevice,{width:1,height:1,format:7}),e=new Uint8Array(t.lock());e[0]=e[1]=e[2]=e[3]=255,t.name="sprite",t.unlock();const s=new StandardMaterial;s.diffuse.set(0,0,0),s.emissive.set(.5,.5,.5),s.emissiveMap=t,s.emissiveMapTint=!0,s.opacityMap=t,s.opacityMapChannel="a",s.opacityTint=!0,s.opacity=0,s.useLighting=!1,s.useGammaTonemap=!1,s.useFog=!1,s.useSkybox=!1,s.blendType=4,s.depthWrite=!1,s.pixelSnap=!1,s.cull=0,s.update(),this._defaultTexture=t,this._defaultMaterial=s}return this._defaultMaterial}set default9SlicedMaterialSlicedMode(t){this._default9SlicedMaterialSlicedMode=t}get default9SlicedMaterialSlicedMode(){if(!this._default9SlicedMaterialSlicedMode){const t=this.defaultMaterial.clone();t.nineSlicedMode=1,t.update(),this._default9SlicedMaterialSlicedMode=t}return this._default9SlicedMaterialSlicedMode}set default9SlicedMaterialTiledMode(t){this._default9SlicedMaterialTiledMode=t}get default9SlicedMaterialTiledMode(){if(!this._default9SlicedMaterialTiledMode){const t=this.defaultMaterial.clone();t.nineSlicedMode=2,t.update(),this._default9SlicedMaterialTiledMode=t}return this._default9SlicedMaterialTiledMode}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)}initializeComponentData(t,e,s){if(void 0!==e.enabled&&(t.enabled=e.enabled),t.type=e.type,e.layers&&Array.isArray(e.layers)&&(t.layers=e.layers.slice(0)),void 0!==e.drawOrder&&(t.drawOrder=e.drawOrder),void 0!==e.color&&(e.color instanceof Color?t.color.set(e.color.r,e.color.g,e.color.b,void 0!==e.opacity?e.opacity:1):t.color.set(e.color[0],e.color[1],e.color[2],void 0!==e.opacity?e.opacity:1),t.color=t.color),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.flipX&&(t.flipX=e.flipX),void 0!==e.flipY&&(t.flipY=e.flipY),void 0!==e.width&&(t.width=e.width),void 0!==e.height&&(t.height=e.height),void 0!==e.spriteAsset&&(t.spriteAsset=e.spriteAsset),e.sprite&&(t.sprite=e.sprite),void 0!==e.frame&&(t.frame=e.frame),e.clips)for(const i in e.clips)t.addClip(e.clips[i]);void 0!==e.speed&&(t.speed=e.speed),e.autoPlayClip&&(t.autoPlayClip=e.autoPlayClip),t.batchGroupId=void 0===e.batchGroupId||null===e.batchGroupId?-1:e.batchGroupId,super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=t.sprite;return this.addComponent(e,{enabled:s.enabled,type:s.type,spriteAsset:s.spriteAsset,sprite:s.sprite,frame:s.frame,color:s.color.clone(),opacity:s.opacity,flipX:s.flipX,flipY:s.flipY,speed:s.speed,clips:s.clips,autoPlayClip:s.autoPlayClip,batchGroupId:s.batchGroupId,drawOrder:s.drawOrder,layers:s.layers.slice(0)})}onUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s];if(i.data.enabled&&i.entity.enabled){const e=i.entity.sprite;e._currentClip&&e._currentClip._update(t)}}}onBeforeRemove(t,e){e.onDestroy()}}Component._buildAccessors(SpriteComponent.prototype,Dc);class ZoneComponent extends Component{constructor(t,e){super(t,e),this._oldState=!0,this._size=new Vec3,this.on("set_enabled",this._onSetEnabled,this)}set size(t){t instanceof Vec3?this._size.copy(t):t instanceof Array&&t.length>=3&&this.size.set(t[0],t[1],t[2])}get size(){return this._size}onEnable(){this._checkState()}onDisable(){this._checkState()}_onSetEnabled(t,e,s){this._checkState()}_checkState(){const t=this.enabled&&this.entity.enabled;t!==this._oldState&&(this._oldState=t,this.fire("enable"),this.fire("state",this.enabled))}_onBeforeRemove(){this.fire("remove")}}class ZoneComponentData{constructor(){this.enabled=!0}}const kc=["enabled"];class ZoneComponentSystem extends ComponentSystem{constructor(t){super(t),this.id="zone",this.ComponentType=ZoneComponent,this.DataType=ZoneComponentData,this.schema=kc,this.on("beforeremove",this._onBeforeRemove,this)}initializeComponentData(t,e,s){t.enabled=!e.hasOwnProperty("enabled")||!!e.enabled,e.size&&(e.size instanceof Vec3?t.size.copy(e.size):e.size instanceof Array&&e.size.length>=3&&t.size.set(e.size[0],e.size[1],e.size[2]))}cloneComponent(t,e){const s={size:t.zone.size};return this.addComponent(e,s)}_onBeforeRemove(t,e){e._onBeforeRemove()}}Component._buildAccessors(ZoneComponent.prototype,kc);class ApplicationStats{constructor(t){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=t._shaderStats,this.vram=t._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return ei().scene._stats}get lightmapper(){return ei().lightmapper.stats}get batcher(){return ei().batcher._stats}}class SceneRegistryItem{constructor(t,e){this.name=t,this.url=e,this.data=null,this._loading=!1,this._onLoadedCallbacks=[]}get loaded(){return!!this.data}get loading(){return this._loading}}class SceneRegistry{constructor(t){this._app=t,this._list=[],this._index={},this._urlIndex={}}destroy(){this._app=null}list(){return this._list}add(t,e){if(this._index.hasOwnProperty(t))return!1;const s=new SceneRegistryItem(t,e),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(t){return this._index.hasOwnProperty(t)?this._list[this._index[t]]:null}findByUrl(t){return this._urlIndex.hasOwnProperty(t)?this._list[this._urlIndex[t]]:null}remove(t){if(this._index.hasOwnProperty(t)){const e=this._index[t];let s=this._list[e];delete this._urlIndex[s.url],delete this._index[t],this._list.splice(e,1);for(let t=0;t<this._list.length;t++)s=this._list[t],this._index[s.name]=t,this._urlIndex[s.url]=t}}_loadSceneData(t,e,s){let i=t;if(t instanceof SceneRegistryItem?i=t.url:(t=this.findByUrl(i))||(t=new SceneRegistryItem("Untitled",i)),!t.url)return void s("URL or SceneRegistryItem is null when loading a scene");if(t.loaded)return void s(null,t);const n=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&!er.test(i)&&(i=c.join(this._app.assets.prefix,i)),t._onLoadedCallbacks.push(s),t._loading||n.load(i,(function(s,i){t.data=i,t._loading=!1;for(let e=0;e<t._onLoadedCallbacks.length;e++)t._onLoadedCallbacks[e](s,t);e||(t.data=null),t._onLoadedCallbacks.length=0})),t._loading=!0}loadSceneData(t,e){this._loadSceneData(t,!0,e)}unloadSceneData(t){"string"==typeof t&&(t=this.findByUrl(t)),t&&(t.data=null)}loadSceneHierarchy(t,e){const s=this,i=this._app.loader.getHandler("hierarchy");this._loadSceneData(t,!1,(function(t,n){if(t)return void(e&&e(t));const a=n.url,r=n.data;s._app._preloadScripts(r,(function(){s._app.systems.script.preloading=!0;const n=i.open(a,r);s._app.systems.script.preloading=!1,s._app.loader.clearCache(a,"hierarchy"),s._app.root.addChild(n),s._app.systems.fire("initialize",n),s._app.systems.fire("postInitialize",n),s._app.systems.fire("postPostInitialize",n),e&&e(t,n)}))}))}loadSceneSettings(t,e){const s=this;this._loadSceneData(t,!1,(function(t,i){t?e&&e(t):(s._app.applySceneSettings(i.data.settings),e&&e(null))}))}loadScene(t,e){const s=this,i=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!er.test(t)&&(t=c.join(this._app.assets.prefix,t)),i.load(t,(function(n,a){if(n)e&&e(n);else{const n=function(){s._app.systems.script.preloading=!0;const n=i.open(t,a),r=s.findByUrl(t);r&&!r.loaded&&(r.data=a),s._app.systems.script.preloading=!1,s._app.loader.clearCache(t,"scene"),s._app.loader.patch({resource:n,type:"scene"},s._app.assets),s._app.root.addChild(n.root),s._app.systems.rigidbody&&"undefined"!=typeof Ammo&&s._app.systems.rigidbody.gravity.set(n._gravity.x,n._gravity.y,n._gravity.z),e&&e(null,n)};s._app._preloadScripts(a,n)}}))}}class SceneDepth{constructor(t){this.application=t,this.device=t.graphicsDevice,this.clearOptions=null,this.layer=null,this.init()}allocateTexture(t,e,s){const i=new Texture(t,{format:s,width:t.width,height:t.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return i.name=e,t.scope.resolve("uDepthMap").setValue(i),i}allocateRenderTarget(t,e,s,i,n){const a=this.allocateTexture(e,s,i);return t?(t.destroyFrameBuffers(),n?t._depthBuffer=a:t._colorBuffer=a):t=new RenderTarget({colorBuffer:n?null:a,depthBuffer:n?a:null,depth:!n,stencil:e.supportsStencil,autoResolve:!1}),t}releaseRenderTarget(t){t&&(t.destroyTextureBuffers(),t.destroy())}initWebGl2(){const t=this.application,e=this;this.clearOptions={flags:0},this.layer=new Layer({enabled:!1,name:"Depth",id:1,onEnable:function(){e.releaseRenderTarget(this.renderTarget),this.renderTarget=e.allocateRenderTarget(this.renderTarget,t.graphicsDevice,"rt-depth2",17,!0)},onDisable:function(){e.releaseRenderTarget(this.renderTarget),this.renderTarget=null},onPreRenderOpaque:function(s){const i=t.graphicsDevice.gl;this.srcFbo=i.getParameter(i.FRAMEBUFFER_BINDING),this.renderTarget.width===t.graphicsDevice.width&&this.renderTarget.height===t.graphicsDevice.height||this.onEnable(),this.oldClear=this.cameras[s].camera._clearOptions,this.cameras[s].camera._clearOptions=e.clearOptions},onPostRenderOpaque:function(e){if(this.renderTarget){this.cameras[e].camera._clearOptions=this.oldClear,t.graphicsDevice.setRenderTarget(this.renderTarget),t.graphicsDevice.updateBegin();const s=t.graphicsDevice.gl;s.bindFramebuffer(s.READ_FRAMEBUFFER,this.srcFbo),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,this.renderTarget._glFrameBuffer),s.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,s.DEPTH_BUFFER_BIT,s.NEAREST)}}})}initWebGl1(){const t=this.application,e=this;this.clearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:3},this.layer=new Layer({enabled:!1,name:"Depth",id:1,shaderPass:2,onEnable:function(){e.releaseRenderTarget(this.renderTarget),this.renderTarget=e.allocateRenderTarget(this.renderTarget,t.graphicsDevice,"rt-depth1",7,!1)},onDisable:function(){e.releaseRenderTarget(this.renderTarget),this.renderTarget=null},onPostCull:function(e){const s=this.instances.visibleOpaque[e],i=s.list,n=t.scene.layers,a=n.subLayerEnabled,r=n.subLayerList,o=t.scene.layers.getLayerById(0).renderTarget,l=this.cameras[e];let h=0;const c=n.layerList;for(let t=0;t<c.length;t++){const e=c[t];if(e===this)break;if(e.renderTarget!==o||!e.enabled||!a[t])continue;const s=e.cameras.indexOf(l);if(s<0)continue;let n=r[t]?e.instances.visibleTransparent[s]:e.instances.visibleOpaque[s];const d=n.length;n=n.list;for(let t=0;t<d;t++){const e=n[t];e.material&&e.material.depthWrite&&!e._noDepthDrawGl1&&(i[h]=e,h++)}}s.length=h},onPreRenderOpaque:function(s){this.renderTarget.width===t.graphicsDevice.width&&this.renderTarget.height===t.graphicsDevice.height||this.onEnable(),this.oldClear=this.cameras[s].camera._clearOptions,this.cameras[s].camera._clearOptions=e.clearOptions},onDrawCall:function(){t.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(t){this.renderTarget&&(this.cameras[t].camera._clearOptions=this.oldClear)}})}init(){this.device.webgl2?this.initWebGl2():this.initWebGl1()}patch(t){t.onEnable=this.layer.onEnable,t.onDisable=this.layer.onDisable,t.onPreRenderOpaque=this.layer.onPreRenderOpaque,t.onPostRenderOpaque=this.layer.onPostRenderOpaque,t.shaderPass=this.layer.shaderPass,t.onPostCull=this.layer.onPostCull,t.onDrawCall=this.layer.onDrawCall}}class Progress$1{constructor(t){this.length=t,this.count=0}inc(){this.count++}done(){return this.count===this.length}}let Fc=null;class Application extends EventHandler{constructor(t,e={}){super(),Application._applications[t.id]=this,si(this),Fc=this,this._destroyRequested=!1,this._inFrameUpdate=!1,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=Qr.legacy,this._librariesLoaded=!1,this._fillMode=Ao,this._resolutionMode="FIXED",this._allowResize=!0,this.context=this,e.graphicsDeviceOptions||(e.graphicsDeviceOptions={}),S.browser&&navigator.xr&&(e.graphicsDeviceOptions.xrCompatible=!0),e.graphicsDeviceOptions.alpha=e.graphicsDeviceOptions.alpha||!1,this.graphicsDevice=new GraphicsDevice(t,e.graphicsDeviceOptions),this._initDefaultMaterial(),this.stats=new ApplicationStats(this.graphicsDevice),this._soundManager=new SoundManager(e),this.loader=new ResourceLoader(this),LightsBuffer.init(this.graphicsDevice),this._entityIndex={},this.scene=new Scene$1(this.graphicsDevice),this._registerSceneImmediate(this.scene),this.root=new Entity,this.root._enabledInHierarchy=!0,this._enableList=[],this._enableList.size=0,this.assets=new AssetRegistry(this.loader),e.assetPrefix&&(this.assets.prefix=e.assetPrefix),this.bundles=new BundleRegistry(this.assets),this.enableBundles="undefined"!=typeof TextDecoder,this.scriptsOrder=e.scriptsOrder||[],this.scripts=new ScriptRegistry(this),this.i18n=new I18n(this),this.scenes=new SceneRegistry(this);const s=this;this.defaultLayerWorld=new Layer({name:"World",id:0}),this.sceneDepth=new SceneDepth(this),this.defaultLayerDepth=this.sceneDepth.layer,this.defaultLayerSkybox=new Layer({enabled:!0,name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new Layer({enabled:!0,name:"UI",id:4,transparentSortMode:1,passThrough:!1}),this.defaultLayerImmediate=new Layer({enabled:!0,name:"Immediate",id:3,opaqueSortMode:0,passThrough:!0});const i=new LayerComposition("default");i.pushOpaque(this.defaultLayerWorld),i.pushOpaque(this.defaultLayerDepth),i.pushOpaque(this.defaultLayerSkybox),i.pushTransparent(this.defaultLayerWorld),i.pushOpaque(this.defaultLayerImmediate),i.pushTransparent(this.defaultLayerImmediate),i.pushTransparent(this.defaultLayerUi),this.scene.layers=i,this._immediateLayer=this.defaultLayerImmediate,this.scene.on("set:layers",(function(t,e){const i=e.layerList;let n;for(let a=0;a<i.length;a++)switch(n=i[a],n.id){case 1:s.sceneDepth.patch(n);break;case 4:n.passThrough=s.defaultLayerUi.passThrough;break;case 3:n.passThrough=s.defaultLayerImmediate.passThrough}})),AreaLightLuts.createPlaceholder(this.graphicsDevice),this.renderer=new ForwardRenderer(this.graphicsDevice),this.renderer.scene=this.scene,this.lightmapper=new Lightmapper(this.graphicsDevice,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this),this.batcher=new BatchManager(this.graphicsDevice,this.root,this.scene),this.once("prerender",this._firstBatch,this),this.keyboard=e.keyboard||null,this.mouse=e.mouse||null,this.touch=e.touch||null,this.gamepads=e.gamepads||null,this.elementInput=e.elementInput||null,this.elementInput&&(this.elementInput.app=this),this.vr=null,this.xr=new XrManager(this),this.elementInput&&this.elementInput.attachSelectEvents(),this._inTools=!1,this._skyboxAsset=null,this._scriptPrefix=e.scriptPrefix||"",this.enableBundles&&this.loader.addHandler("bundle",new BundleHandler(this.assets)),this.loader.addHandler("animation",new AnimationHandler),this.loader.addHandler("animclip",new AnimClipHandler),this.loader.addHandler("animstategraph",new AnimStateGraphHandler),this.loader.addHandler("model",new ModelHandler(this.graphicsDevice)),this.loader.addHandler("render",new RenderHandler(this.assets)),this.loader.addHandler("material",new MaterialHandler(this)),this.loader.addHandler("texture",new TextureHandler(this.graphicsDevice,this.assets,this.loader)),this.loader.addHandler("text",new TextHandler),this.loader.addHandler("json",new JsonHandler),this.loader.addHandler("audio",new AudioHandler(this._soundManager)),this.loader.addHandler("script",new ScriptHandler(this)),this.loader.addHandler("scene",new SceneHandler(this)),this.loader.addHandler("cubemap",new CubemapHandler(this.graphicsDevice,this.assets,this.loader)),this.loader.addHandler("html",new HtmlHandler),this.loader.addHandler("css",new CssHandler),this.loader.addHandler("shader",new ShaderHandler),this.loader.addHandler("hierarchy",new HierarchyHandler(this)),this.loader.addHandler("folder",new FolderHandler),this.loader.addHandler("font",new FontHandler(this.loader)),this.loader.addHandler("binary",new BinaryHandler),this.loader.addHandler("textureatlas",new TextureAtlasHandler(this.loader)),this.loader.addHandler("sprite",new SpriteHandler(this.assets,this.graphicsDevice)),this.loader.addHandler("template",new TemplateHandler(this)),this.loader.addHandler("container",new ContainerHandler(this.graphicsDevice,this.assets)),this.systems=new ComponentSystemRegistry,this.systems.add(new RigidBodyComponentSystem(this)),this.systems.add(new CollisionComponentSystem(this)),this.systems.add(new JointComponentSystem(this)),this.systems.add(new AnimationComponentSystem(this)),this.systems.add(new AnimComponentSystem(this)),this.systems.add(new ModelComponentSystem(this)),this.systems.add(new RenderComponentSystem(this)),this.systems.add(new CameraComponentSystem(this)),this.systems.add(new LightComponentSystem(this)),Qr.legacy?this.systems.add(new ScriptLegacyComponentSystem(this)):this.systems.add(new ScriptComponentSystem(this)),this.systems.add(new AudioSourceComponentSystem(this,this._soundManager)),this.systems.add(new SoundComponentSystem(this,this._soundManager)),this.systems.add(new AudioListenerComponentSystem(this,this._soundManager)),this.systems.add(new ParticleSystemComponentSystem(this)),this.systems.add(new ScreenComponentSystem(this)),this.systems.add(new ElementComponentSystem(this)),this.systems.add(new ButtonComponentSystem(this)),this.systems.add(new ScrollViewComponentSystem(this)),this.systems.add(new ScrollbarComponentSystem(this)),this.systems.add(new SpriteComponentSystem(this)),this.systems.add(new LayoutGroupComponentSystem(this)),this.systems.add(new LayoutChildComponentSystem(this)),this.systems.add(new ZoneComponentSystem(this)),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=Vc(this)}static getApplication(t){return t?Application._applications[t]:ei()}_initDefaultMaterial(){const t=new StandardMaterial;t.name="Default Material",t.shadingModel=1,DefaultMaterial.add(this.graphicsDevice,t)}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(t,e){V.get(t,((t,s)=>{if(t)return void e(t);const i=s.application_properties,n=s.scenes,a=s.assets;this._parseApplicationProperties(i,(t=>{this._parseScenes(n),this._parseAssets(a),e(t||null)}))}))}preload(t){this.fire("preload:start");const e=this.assets.list({preload:!0}),s=new Progress$1(e.length);let i=!1;const n=()=>{this.graphicsDevice&&!i&&s.done()&&(i=!0,this.fire("preload:end"),t())},a=e.length;if(s.length){const t=t=>{s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()},i=(t,e)=>{s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()};for(let r=0;r<e.length;r++)e[r].loaded?(s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()):(e[r].once("load",t),e[r].once("error",i),this.assets.load(e[r]))}else n()}_preloadScripts(t,e){if(!Qr.legacy)return void e();this.systems.script.preloading=!0;const s=this._getScriptReferences(t),i=s.length,n=new Progress$1(i),a=/^http(s)?:\/\//;if(i){const t=(t,s)=>{t&&console.error(t),n.inc(),n.done()&&(this.systems.script.preloading=!1,e())};for(let e=0;e<i;e++){let i=s[e];!a.test(i.toLowerCase())&&this._scriptPrefix&&(i=c.join(self._scriptPrefix,s[e])),this.loader.load(i,"script",t)}}else this.systems.script.preloading=!1,e()}_handleAreaLightDataProperty(t){const e=this.assets.get(t);e?this.setAreaLightLuts(e):this.assets.once("add:"+t,this.setAreaLightLuts,this)}_parseApplicationProperties(t,e){if("number"==typeof t.maxAssetRetries&&t.maxAssetRetries>0&&this.loader.enableRetry(t.maxAssetRetries),t.useDevicePixelRatio||(t.useDevicePixelRatio=t.use_device_pixel_ratio),t.resolutionMode||(t.resolutionMode=t.resolution_mode),t.fillMode||(t.fillMode=t.fill_mode),this._width=t.width,this._height=t.height,t.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(t.resolutionMode,this._width,this._height),this.setCanvasFillMode(t.fillMode,this._width,this._height),t.layers&&t.layerOrder){const e=new LayerComposition("application"),s={};for(const i in t.layers){const e=t.layers[i];e.id=parseInt(i,10),e.enabled=1!==e.id,s[i]=new Layer(e)}for(let i=0,n=t.layerOrder.length;i<n;i++){const n=t.layerOrder[i],a=s[n.layer];a&&(n.transparent?e.pushTransparent(a):e.pushOpaque(a),e.subLayerEnabled[i]=n.enabled)}this.scene.layers=e}if(t.batchGroups)for(let s=0,i=t.batchGroups.length;s<i;s++){const e=t.batchGroups[s];this.batcher.addGroup(e.name,e.dynamic,e.maxAabbSize,e.id,e.layers)}t.i18nAssets&&(this.i18n.assets=t.i18nAssets),t.areaLightDataAsset&&this._handleAreaLightDataProperty(t.areaLightDataAsset),this._loadLibraries(t.libraries,e)}_loadLibraries(t,e){const s=t.length;let i=s;const n=/^http(s)?:\/\//;if(s){const a=(t,s)=>{i--,t?e(t):0===i&&(this.onLibrariesLoaded(),e(null))};for(let e=0;e<s;++e){let s=t[e];!n.test(s.toLowerCase())&&this._scriptPrefix&&(s=c.join(this._scriptPrefix,s)),this.loader.load(s,"script",a)}}else this.onLibrariesLoaded(),e(null)}_parseScenes(t){if(t)for(let e=0;e<t.length;e++)this.scenes.add(t[e].name,t[e].url)}_parseAssets(t){const e=[],s={},i={};if(Qr.legacy){if(this.enableBundles)for(const s in t)"bundle"===t[s].type&&(i[s]=!0,e.push(t[s]));for(const s in t)i[s]||e.push(t[s])}else{for(let i=0;i<this.scriptsOrder.length;i++){const n=this.scriptsOrder[i];t[n]&&(s[n]=!0,e.push(t[n]))}if(this.enableBundles)for(const s in t)"bundle"===t[s].type&&(i[s]=!0,e.push(t[s]));for(const n in t)s[n]||i[n]||e.push(t[n])}for(let n=0;n<e.length;n++){const t=e[n],s=new Asset(t.name,t.type,t.file,t.data);if(s.id=parseInt(t.id,10),s.preload=!!t.preload&&t.preload,s.loaded="script"===t.type&&t.data&&t.data.loadingType>0,s.tags.add(t.tags),t.i18n)for(const e in t.i18n)s.addLocalizedAssetId(e,t.i18n[e]);this.assets.add(s)}}_getScriptReferences(t){let e=[];t.settings.priority_scripts&&(e=t.settings.priority_scripts);const s=[],i={};for(let a=0;a<e.length;a++)s.push(e[a]),i[e[a]]=!0;const n=t.entities;for(const a in n){if(!n[a].components.script)continue;const t=n[a].components.script.scripts;for(let e=0;e<t.length;e++)i[t[e].url]||(s.push(t[e].url),i[t[e].url]=!0)}return s}start(){this.frame=0,this.fire("start",{timestamp:k(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(t){this.controller&&this.controller.update(t),this.mouse&&this.mouse.update(t),this.keyboard&&this.keyboard.update(t),this.gamepads&&this.gamepads.update(t)}update(t){this.frame++,this.graphicsDevice.updateClientRect(),this.vr&&this.vr.poll(),Qr.legacy&&this.systems.fire("fixedUpdate",1/60),this.systems.fire(this._inTools?"toolsUpdate":"update",t),this.systems.fire("animationUpdate",t),this.systems.fire("postUpdate",t),this.fire("update",t),this.inputUpdate(t)}render(){this.fire("prerender"),this.root.syncHierarchy(),this.batcher.updateAll(),this.renderer.renderComposition(this.scene.layers),this.fire("postrender")}_fillFrameStatsBasic(t,e,s){const i=this.stats.frame;i.dt=e,i.ms=s,t>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=t+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let t=this.stats.frame;t.cameras=this.renderer._camerasRendered,t.materials=this.renderer._materialSwitches,t.shaders=this.graphicsDevice._shaderSwitchesPerFrame,t.shadowMapUpdates=this.renderer._shadowMapUpdates,t.shadowMapTime=this.renderer._shadowMapTime,t.depthMapTime=this.renderer._depthMapTime,t.forwardTime=this.renderer._forwardTime;const e=this.graphicsDevice._primsPerFrame;t.triangles=e[4]/3+Math.max(e[5]-2,0)+Math.max(e[6]-2,0),t.cullTime=this.renderer._cullTime,t.sortTime=this.renderer._sortTime,t.skinTime=this.renderer._skinTime,t.morphTime=this.renderer._morphTime,t.instancingTime=this.renderer._instancingTime,t.lightClusters=this.renderer._lightClusters,t.lightClustersTime=this.renderer._lightClustersTime,t.otherPrimitives=0;for(let s=0;s<e.length;s++)s<4&&(t.otherPrimitives+=e[s]),e[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._instancingTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,t=this.stats.drawCalls,t.forward=this.renderer._forwardDrawCalls,t.culled=this.renderer._numDrawCallsCulled,t.depth=0,t.shadow=this.renderer._shadowDrawCalls,t.skinned=this.renderer._skinDrawCalls,t.immediate=0,t.instanced=0,t.removedByInstancing=0,t.misc=t.total-(t.forward+t.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.renderer._removedByInstancing=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,t=this.stats.particles,t.updatesPerFrame=t._updatesPerFrame,t.frameTime=t._frameTime,t._updatesPerFrame=0,t._frameTime=0}setCanvasFillMode(t,e,s){this._fillMode=t,this.resizeCanvas(e,s)}setCanvasResolution(t,e,s){this._resolutionMode=t,t===Po&&void 0===e&&(e=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(e,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager.suspend():this._soundManager.resume()}resizeCanvas(t,e){if(!this._allowResize)return;if(this.xr&&this.xr.session)return;const s=window.innerWidth,i=window.innerHeight;if(this._fillMode===Ao){const n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;n>s/i?e=(t=s)/n:t=(e=i)*n}else"FILL_WINDOW"===this._fillMode&&(t=s,e=i);return this.graphicsDevice.canvas.style.width=t+"px",this.graphicsDevice.canvas.style.height=e+"px",this.updateCanvasSize(),{width:t,height:e}}updateCanvasSize(){if(this._allowResize&&!this.xr.active&&this._resolutionMode===Po){const t=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(t.clientWidth,t.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(t){let e;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){const e=t.physics.gravity;this.systems.rigidbody.gravity.set(e[0],e[1],e[2])}this.scene.applySettings(t),t.render.hasOwnProperty("skybox")&&(t.render.skybox?(e=this.assets.get(t.render.skybox),e?this.setSkybox(e):this.assets.once("add:"+t.render.skybox,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(t){if(t){const e=this.graphicsDevice;t.ready((t=>{AreaLightLuts.set(e,t.resource)})),this.assets.load(t)}}setSkybox(t){if(t!==this._skyboxAsset){const e=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,s,this),this.assets.off("remove:"+this._skyboxAsset.id,e,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=t,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,s,this),this.assets.once("remove:"+this._skyboxAsset.id,e,this),this._skyboxAsset.on("change",s,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}enableVr(){this.vr||(this.vr=new VrManager(this))}disableVr(){this.vr&&(this.vr.destroy(),this.vr=null)}_firstBake(){this.lightmapper.bake(null,this.scene.lightmapMode)}_firstBatch(){this.batcher.generate()}_processTimestamp(t){return t}drawLine(t,e,s,i,n){this.scene.drawLine(t,e,s,i,n)}drawLines(t,e,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLines(t,e,s,i)}drawLineArrays(t,e,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLineArrays(t,e,s,i)}drawWireSphere(t,e,s=Color.WHITE,i=20,n=!0,a=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(t,e,s,i,n,a)}drawWireAlignedBox(t,e,s=Color.WHITE,i=!0,n=this.scene.defaultDrawLayer){this.scene.immediate.drawWireAlignedBox(t,e,s,i,n)}drawMeshInstance(t,e=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,t,e)}drawMesh(t,e,s,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(e,s,t,null,i)}drawQuad(t,e,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(e,t,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(t,e,s,i,n,a,r=this.scene.defaultDrawLayer){const o=new Mat4;o.setTRS(new Vec3(t,e,0),Quat.IDENTITY,new Vec3(s,i,0)),a||((a=new Material$1).setParameter("colorMap",n),a.shader=this.scene.immediate.getTextureShader(),a.update()),this.drawQuad(o,a,r)}drawDepthTexture(t,e,s,i,n=this.scene.defaultDrawLayer){const a=new Material$1;a.shader=this.scene.immediate.getDepthTextureShader(),a.update(),this.drawTexture(t,e,s,i,null,a,n)}destroy(){if(this._inFrameUpdate)return void(this._destroyRequested=!0);const t=this.graphicsDevice.canvas.id;this.off("librariesloaded"),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();const e=this.assets.list();for(let s=0;s<e.length;s++)e[s].unload(),e[s].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;for(const s in this.loader.getHandler("script")._cache){const t=this.loader.getHandler("script")._cache[s],e=t.parentNode;e&&e.removeChild(t)}this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,this.lightmapper.destroy(),this.lightmapper=null,this.batcher.destroy(),this.batcher=null,this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,$t&&($t.destroy(),$t=null),this.vr&&(this.vr.destroy(),this.vr=null),this.xr.end(),ParticleEmitter.staticDestroy(),this.renderer.destroy(),this.renderer=null,DefaultMaterial.remove(this.graphicsDevice),this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),this._soundManager&&(this._soundManager.destroy(),this._soundManager=null),Qr.app=null,Application._applications[t]=null,ei()===this&&si(null)}getEntityFromIndex(t){return this._entityIndex[t]}_registerSceneImmediate(t){this.on("postrender",t.immediate.onPostRender,t.immediate)}}Application._applications={};const Oc={},Vc=function(t){const e=t;let s;return function(t,i){if(!e.graphicsDevice)return;si(e),s&&(window.cancelAnimationFrame(s),s=null),Fc=e;const n=e._processTimestamp(t)||k(),a=n-(e._time||n);let r=a/1e3;r=O.clamp(r,0,e.maxDeltaTime),r*=e.timeScale,e._time=n,s=e.vr&&e.vr.display?e.vr.display.requestAnimationFrame(e.tick):e.xr.session?e.xr.session.requestAnimationFrame(e.tick):S.browser?window.requestAnimationFrame(e.tick):null,e.graphicsDevice.contextLost||(e._fillFrameStatsBasic(n,r,a),e._inFrameUpdate=!0,e.fire("frameupdate",a),i?(e.xr.update(i),e.graphicsDevice.defaultFramebuffer=i.session.renderState.baseLayer.framebuffer):e.graphicsDevice.defaultFramebuffer=null,e.update(r),e.fire("framerender"),(e.autoRender||e.renderNextFrame)&&(e.updateCanvasSize(),e.render(),e.renderNextFrame=!1),Oc.timestamp=k(),Oc.target=e,e.fire("frameend",Oc),e.fire("frameEnd",Oc),e.vr&&e.vr.display&&e.vr.display.presenting&&e.vr.display.submitFrame(),e._inFrameUpdate=!1,e._destroyRequested&&e.destroy())}};class Entity extends GraphNode{constructor(t,e){if(super(t),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,t instanceof Application&&(e=t),this._batchHandle=null,this.c={},this._app=e,!e&&(this._app=Application.getApplication(),!this._app))throw new Error("Couldn't find current application");this._guid=null,this._destroying=!1,this._template=!1}addComponent(t,e){const s=this._app.systems[t];return s?this.c[t]?null:s.addComponent(this,e):null}removeComponent(t){const e=this._app.systems[t];e&&this.c[t]&&e.removeComponent(this)}findComponent(t){const e=this.findOne((function(e){return e.c&&e.c[t]}));return e&&e.c[t]}findComponents(t){return this.find((function(e){return e.c&&e.c[t]})).map((function(e){return e.c[t]}))}getGuid(){return this._guid||this.setGuid(h()),this._guid}setGuid(t){const e=this._app._entityIndex;this._guid&&delete e[this._guid],this._guid=t,e[this._guid]=this}_notifyHierarchyStateChanged(t,e){let s=!1;t===this&&0===this._app._enableList.length&&(s=!0),t._beingEnabled=!0,t._onHierarchyStateChanged(e),t._onHierarchyStatePostChanged&&this._app._enableList.push(t);const i=t._children;for(let n=0,a=i.length;n<a;n++)i[n]._enabled&&this._notifyHierarchyStateChanged(i[n],e);if(t._beingEnabled=!1,s){for(let t=0;t<this._app._enableList.length;t++)this._app._enableList[t]._onHierarchyStatePostChanged();this._app._enableList.length=0}}_onHierarchyStateChanged(t){super._onHierarchyStateChanged(t);const e=this.c;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s];i.enabled&&(t?i.onEnable():i.onDisable())}}_onHierarchyStatePostChanged(){const t=this.c;for(const e in t)t.hasOwnProperty(e)&&t[e].onPostStateChange()}findByGuid(t){if(this._guid===t)return this;const e=this._app._entityIndex[t];return e&&(e===this||e.isDescendantOf(this))?e:null}destroy(){this._destroying=!0;for(const s in this.c)this.c[s].enabled=!1;for(const s in this.c)this.c[s].system.removeComponent(this);this._parent&&this._parent.removeChild(this);const t=this._children;let e=t.shift();for(;e;)e instanceof Entity&&e.destroy(),e._parent=null,e=t.shift();this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const t={},e=this._cloneRecursively(t);return t[this.getGuid()]=e,Bc(this,this,e,t),e}_cloneRecursively(t){const e=new Entity(this._app);super._cloneInternal(e);for(const s in this.c){this.c[s].system.cloneComponent(this,e)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i instanceof Entity){const s=i._cloneRecursively(t);e.addChild(s),t[i.getGuid()]=s}}return e}}function Bc(t,e,s,i){if(e instanceof Entity){const n=e.c;for(const e in n){const a=n[e],r=a.system.getPropertiesOfType("entity");for(let n=0,o=r.length;n<o;n++){const o=r[n].name,l=a[o];if(!!t.findByGuid(l)){const t=i[l].getGuid();t&&(s.c[e][o]=t)}}}n.script&&!s._app.useLegacyScriptAttributeCloning&&s.script.resolveDuplicatedEntityReferenceProperties(n.script,i),n.render&&s.render.resolveDuplicatedEntityReferenceProperties(n.render,i),n.anim&&s.anim.resolveDuplicatedEntityReferenceProperties(n.anim,i);const a=e.children.filter((function(t){return t instanceof Entity})),r=s.children.filter((function(t){return t instanceof Entity}));for(let e=0,s=a.length;e<s;e++)Bc(t,a[e],r[e],i)}}const zc=new Vec3;class BakeLightAmbient extends BakeLight{constructor(t){const e=new Entity("AmbientLight");e.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:t.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:0,color:Color.WHITE,intensity:1}),super(t,e.light.light)}get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(t,e){Qe(zc,t,e,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(zc.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);const s=this.scene.gammaCorrection?2.2:1,i=2*Math.PI*this.scene.ambientBakeSpherePart,n=Math.pow(i,s);this.light.intensity=Math.pow(n/e,1/s)}}class BakeMeshNode{constructor(t,e=null){this.node=t,this.component=t.render||t.model,e=e||this.component.meshInstances,this.store(),this.meshInstances=e,this.bounds=null,this.renderTargets=[]}store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}}class LightmapFilters{constructor(t){this.device=t,this.shaderDilate=he(t,Zt.fullscreenQuadVS,Zt.dilatePS,"lmDilate"),this.constantTexSource=t.scope.resolve("source"),this.constantPixelOffset=t.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.shaderDenoise=null,this.sigmas=null,this.constantSigmas=null,this.kernel=null}setSourceTexture(t){this.constantTexSource.setValue(t)}prepare(t,e){this.pixelOffset[0]=1/t,this.pixelOffset[1]=1/e,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(t,e){this.shaderDenoise||(this.shaderDenoise=he(this.device,Zt.fullscreenQuadVS,Zt.bilateralDeNoisePS,"lmBilateralDeNoise"),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")),this.sigmas[0]=t,this.sigmas[1]=e,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(t,e)}evaluateDenoiseUniforms(t,e){function s(t,e){return.39894*Math.exp(-.5*t*t/(e*e))/e}this.kernel=this.kernel||new Float32Array(15);const i=this.kernel,n=Math.floor(7);for(let r=0;r<=n;++r){const e=s(r,t);i[n+r]=e,i[n-r]=e}this.constantKernel.setValue(this.kernel);const a=1/s(0,e);this.bZnorm.setValue(a)}}const Uc=new Vec3;class Lightmapper{constructor(t,e,s,i,n){this.device=t,this.root=e,this.scene=s,this.renderer=i,this.assets=n,this.shadowMapCache=i._shadowRenderer.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new Color,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}destroy(){LightmapCache.decRef(this.blackTex),this.blackTex=null,LightmapCache.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null}initBake(t){if(!this._initCalled){this._initCalled=!0,this.lightmapFilters=new LightmapFilters(t),this.constantBakeDir=t.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new Texture(this.device,{width:4,height:4,format:7,type:Ot}),this.blackTex.name="lightmapBlack",LightmapCache.incRef(this.blackTex);const e=new Camera;e.clearColor.set(0,0,0,0),e.clearColorBuffer=!0,e.clearDepthBuffer=!1,e.clearStencilBuffer=!1,e.frustumCulling=!1,e.projection=1,e.aspectRatio=1,e.node=new GraphNode,this.camera=e}if(this.scene.clusteredLightingEnabled){const e=new LightingParams(t.supportsAreaLights,t.maxTextureSize,(()=>{}));this.lightingParams=e;const s=this.scene.lighting;e.shadowsEnabled=s.shadowsEnabled,e.shadowAtlasResolution=s.shadowAtlasResolution,e.cookiesEnabled=s.cookiesEnabled,e.cookieAtlasResolution=s.cookieAtlasResolution,e.areaLightsEnabled=s.areaLightsEnabled,e.cells=new Vec3(3,3,3),e.maxLightsPerCell=4,this.worldClusters=new WorldClusters(t),this.worldClusters.name="ClusterLightmapper"}}finishBake(t){function e(t){LightmapCache.decRef(t.colorBuffer),t.destroy()}this.materials=[],this.renderTargets.forEach((t=>{e(t)})),this.renderTargets.clear(),t.forEach((t=>{t.renderTargets.forEach((t=>{e(t)})),t.renderTargets.length=0})),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)}createMaterialForPass(t,e,s,i){const n=new StandardMaterial;if(n.name=`lmMaterial-pass:${s}-ambient:${i}`,n.chunks.transformVS="#define UV1LAYOUT\n"+Zt.transformVS,0===s){let t=Zt.bakeLmEndPS;i?t=`\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = ((dDiffuseLight - 0.5) * max(${e.ambientBakeOcclusionContrast.toFixed(1)} + 1.0, 0.0)) + 0.5;\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight += vec3(${e.ambientBakeOcclusionBrightness.toFixed(1)});\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = saturate(dDiffuseLight);\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight *= dAmbientLight;\n\t\t\t\t\t\t\t\t`+t:(n.ambient=new Color(0,0,0),n.ambientTint=!0),n.chunks.endPS=t,n.lightMap=this.blackTex}else n.chunks.basePS=Zt.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",n.chunks.endPS=Zt.bakeDirLmEndPS;return n.chunks.outputAlphaPS="\n",n.chunks.outputAlphaOpaquePS="\n",n.chunks.outputAlphaPremulPS="\n",n.cull=0,n.forceUv1=!0,n.update(),n.updateShader(t,e),n}createMaterials(t,e,s){for(let i=0;i<s;i++)this.passMaterials[i]||(this.passMaterials[i]=this.createMaterialForPass(t,e,i,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(t,e,0,!0),this.ambientAOMaterial.onUpdateShader=function(t){return t.lightMapWithoutAmbient=!0,t.separateAmbient=!0,t})}createTexture(t,e,s){const i=new Texture(this.device,{width:t,height:t,format:7,mipmaps:!1,type:e,minFilter:0,magFilter:0,addressU:1,addressV:1});return i.name=s,i}collectModels(t,e,s){var i,n,a;if(!t.enabled)return;let r;if(null!=(i=t.model)&&i.model&&null!=(n=t.model)&&n.enabled&&(s&&s.push(new BakeMeshNode(t)),t.model.lightmapped&&e&&(r=t.model.model.meshInstances)),null!=(a=t.render)&&a.enabled&&(s&&s.push(new BakeMeshNode(t)),t.render.lightmapped&&e&&(r=t.render.meshInstances)),r){let s=!0;for(let t=0;t<r.length;t++)if(!r[t].mesh.vertexBuffer.format.hasUv1){s=!1;break}if(s){const s=[];for(let i=0;i<r.length;i++){const n=r[i].mesh;this._tempSet.has(n)?e.push(new BakeMeshNode(t,[r[i]])):s.push(r[i]),this._tempSet.add(n)}this._tempSet.clear(),s.length>0&&e.push(new BakeMeshNode(t,s))}}for(let o=0;o<t._children.length;o++)this.collectModels(t._children[o],e,s)}prepareShadowCasters(t){const e=[];for(let s=0;s<t.length;s++){const i=t[s].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap){const i=t[s].meshInstances;for(let t=0;t<i.length;t++)i[t].visibleThisFrame=!0,e.push(i[t])}}return e}updateTransforms(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;for(let t=0;t<s.length;t++)s[t].node.getWorldTransform()}}calculateLightmapSize(t){let e;const s=this.scene.lightmapSizeMultiplier||16,i=Uc;let n,a;t.model?(a=t.model.lightmapSizeMultiplier,t.model.asset?(e=this.assets.get(t.model.asset).data,e.area&&(n=e.area)):t.model._area&&(e=t.model,e._area&&(n=e._area))):t.render&&(a=t.render.lightmapSizeMultiplier,"asset"!==t.render.type&&t.render._area&&(e=t.render,e._area&&(n=e._area)));const r={x:1,y:1,z:1,uv:1};n&&(r.x=n.x,r.y=n.y,r.z=n.z,r.uv=n.uv);const o=a||1;r.x*=o,r.y*=o,r.z*=o;const l=t.render||t.model,h=this.computeNodeBounds(l.meshInstances);i.copy(h.halfExtents);let c=r.x*i.y*i.z+r.y*i.x*i.z+r.z*i.x*i.y;c/=r.uv,c=Math.sqrt(c);return Math.min(O.nextPowerOfTwo(c*s),this.scene.lightmapMaxResolution||2048)}setLightmapping(t,e,s,i){for(let n=0;n<t.length;n++){const a=t[n],r=a.meshInstances;for(let t=0;t<r.length;t++){const n=r[t];if(n.setLightmapped(e),e){i&&(n._shaderDefs|=i),n.mask=2;for(let t=0;t<s;t++){const e=a.renderTargets[t].colorBuffer;e.minFilter=1,e.magFilter=1,n.setRealtimeLightmap(MeshInstance.lightmapParamNames[t],e)}}}}}bake(t,e=1){const s=this.device,i=k();this.scene._updateSkybox(s),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;const n=s._shaderStats.linked,a=s._renderTargetCreationTime,r=s._shaderStats.compileTime,o=[],l=[];if(t){for(let e=0;e<t.length;e++)this.collectModels(t[e],o,null);this.collectModels(this.root,null,l)}else this.collectModels(this.root,o,l);if(o.length>0){const t=1===e?2:1;this.setLightmapping(o,!1,t),this.initBake(s),this.bakeInternal(t,o,l);let i=64;1===e&&(i|=128),this.scene.ambientBake&&(i|=st),this.setLightmapping(o,!0,t,i),this.finishBake(o)}const h=k();this.stats.totalRenderTime=h-i,this.stats.shadersLinked=s._shaderStats.linked-n,this.stats.compileTime=s._shaderStats.compileTime-r,this.stats.fboTime=s._renderTargetCreationTime-a,this.stats.lightmapCount=o.length}allocateTextures(t,e){for(let s=0;s<t.length;s++){const i=t[s],n=this.calculateLightmapSize(i.node);for(let t=0;t<e;t++){const e=this.createTexture(n,Ft,"lightmapper_lightmap_"+s);LightmapCache.incRef(e),i.renderTargets[t]=new RenderTarget({colorBuffer:e,depth:!1})}if(!this.renderTargets.has(n)){const t=this.createTexture(n,Ft,"lightmapper_temp_lightmap_"+n);LightmapCache.incRef(t),this.renderTargets.set(n,new RenderTarget({colorBuffer:t,depth:!1}))}}}prepareLightsToBake(t,e,s){if(this.scene.ambientBake){const t=new BakeLightAmbient(this.scene);s.push(t)}const i=t._lights;for(let n=0;n<i.length;n++){const t=i[n],a=new BakeLightSimple(this.scene,t);e.push(a),t.enabled&&0!=(4&t.mask)&&(t.isStatic=!1,t.mask=4294967295,t.shadowUpdateMode=0===t.type?2:1,s.push(a))}s.sort()}restoreLights(t){for(let e=0;e<t.length;e++)t[e].restore()}setupScene(){this.revertStatic=!1,this.scene._needsStaticPrepare&&(this.scene._needsStaticPrepare=!1,this.revertStatic=!0),this.fog=this.scene.fog,this.ambientLight.copy(this.scene.ambientLight),this.scene.fog=K,this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants()}restoreScene(){this.scene.fog=this.fog,this.scene.ambientLight.copy(this.ambientLight),this.revertStatic&&(this.scene._needsStaticPrepare=!0)}computeNodeBounds(t){const e=new BoundingBox;if(t.length>0){e.copy(t[0].aabb);for(let s=1;s<t.length;s++)e.add(t[s].aabb)}return e}computeNodesBounds(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;t[e].bounds=this.computeNodeBounds(s)}}computeBounds(t){const e=new BoundingBox;for(let s=0;s<t.length;s++){e.copy(t[0].aabb);for(let s=1;s<t.length;s++)e.add(t[s].aabb)}return e}backupMaterials(t){for(let e=0;e<t.length;e++)this.materials[e]=t[e].material}restoreMaterials(t){for(let e=0;e<t.length;e++)t[e].material=this.materials[e]}lightCameraPrepare(t,e){const s=e.light;let i;if(2===s.type){i=s.getRenderData(null,0).shadowCamera,i._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=0,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=2*s._outerConeAngle,this.renderer.updateCameraFrustum(i)}return i}lightCameraPrepareAndCull(t,e,s,i){const n=t.light;let a=!0;if(0===n.type){Uc.copy(i.center),Uc.y+=i.halfExtents.y,this.camera.node.setPosition(Uc),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*i.halfExtents.y;const t=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=t}else t.lightBounds.intersects(e.bounds)||(a=!1);if(2===n.type){let t=!1;const i=e.meshInstances;for(let e=0;e<i.length;e++)if(i[e]._isVisible(s)){t=!0;break}t||(a=!1)}return a}setupLightArray(t,e){t[0].length=0,t[1].length=0,t[2].length=0,t[e.type][0]=e,e.visibleThisFrame=!0}renderShadowMap(t,e,s,i){const n=i.light;return!t&&n.castShadows&&(n.shadowMap||this.scene.clusteredLightingEnabled||(n.shadowMap=this.shadowMapCache.get(this.device,n)),0===n.type?this.renderer._shadowRenderer.cullDirectional(n,e,this.camera):this.renderer._shadowRenderer.cullLocal(n,e),this.renderer.renderShadows(s[n.type],this.camera)),!0}postprocessTextures(t,e,s){const i=this.lightmapFilters.shaderDilate,n=this.scene.lightmapFilterEnabled;n&&this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness);for(let a=0;a<e.length;a++){const r=e[a];for(let e=0;e<s;e++){const s=r.renderTargets[e],a=s.colorBuffer,o=this.renderTargets.get(a.width),l=o.colorBuffer;this.lightmapFilters.prepare(a.width,a.height);for(let r=0;r<1;r++){this.lightmapFilters.setSourceTexture(a);Kt(t,o,n&&0===e&&0===r?this.lightmapFilters.shaderDenoise:i),this.lightmapFilters.setSourceTexture(l),Kt(t,s,i)}}}}bakeInternal(t,e,s){const i=this.scene,n=this.device,a=i.clusteredLightingEnabled;this.createMaterials(n,i,t),this.setupScene(),i.layers._update(),this.computeNodesBounds(e),this.allocateTextures(e,t);const r=[],o=[];this.prepareLightsToBake(i.layers,r,o),this.updateTransforms(s);const l=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(l),this.renderer.gpuUpdate(l);const h=this.computeBounds(l);let c,d,u,p;for(c=0;c<e.length;c++){for(u=e[c].meshInstances,d=0;d<u.length;d++)p=u[d],p.setLightmapped(!1),p.mask=4,p.setRealtimeLightmap(MeshInstance.lightmapParamNames[0],p.material.lightMap?p.material.lightMap:this.blackTex),p.setRealtimeLightmap(MeshInstance.lightmapParamNames[1],this.blackTex)}for(d=0;d<o.length;d++)o[d].light.enabled=!1;const m=[[],[],[]];let _,f,g=!1;for(c=0;c<o.length;c++){const s=o[c],r=s instanceof BakeLightAmbient;let y=s.numVirtualLights;t>1&&y>1&&(y=1);for(let o=0;o<y;o++){y>1&&s.prepareVirtualLight(o,y),s.startBake();let c=!1;const v=this.lightCameraPrepare(n,s);for(f=0;f<e.length;f++){const n=e[f];u=n.meshInstances;if(this.lightCameraPrepareAndCull(s,n,v,h)){if(this.setupLightArray(m,s.light),a&&this.renderer.lightTextureAtlas.update(m[2],m[1],this.lightingParams),c=this.renderShadowMap(c,l,m,s),a){const t=m[2].concat(m[1]);this.worldClusters.update(t,this.scene.gammaCorrection,this.lightingParams)}for(this.backupMaterials(u),_=0;_<t&&!(_>0&&o>0)&&!(r&&_>0);_++){const t=n.renderTargets[_],e=n.renderTargets[_].colorBuffer.width,l=this.renderTargets.get(e),h=l.colorBuffer;0===_?g=i.updateShaders:g&&(i.updateShaders=!0);let c=this.passMaterials[_];if(r){o+1===y&&0===_&&(c=this.ambientAOMaterial)}for(d=0;d<u.length;d++)u[d].material=c;for(this.renderer.updateShaders(u),this.renderer.setCamera(this.camera,l,!0),1===_&&this.constantBakeDir.setValue(s.light.bakeDir?1:0),a&&this.worldClusters.activate(this.renderer.lightTextureAtlas),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,u,u.length,m,1),n.renderTargets[_]=l,this.renderTargets.set(e,t),d=0;d<u.length;d++)p=u[d],p.setRealtimeLightmap(MeshInstance.lightmapParamNames[_],h),p._shaderDefs|=64}this.restoreMaterials(u)}}s.endBake(this.shadowMapCache)}}for(this.postprocessTextures(n,e,t),f=0;f<s.length;f++)s[f].restore();this.restoreLights(r),this.restoreScene(),a||this.shadowMapCache.clear()}}const Nc=new Set(["system","entity","create","destroy","swap","move","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","has","get","on","off","fire","once","hasEvent"]);function Hc(t,e){if(Qr.legacy)return null;if(Nc.has(t))throw new Error(`script name: '${t}' is reserved, please change script name`);const s=function(t){EventHandler.prototype.initEventHandler.call(this),ScriptType.prototype.initScriptType.call(this,t)};return(s.prototype=Object.create(ScriptType.prototype)).constructor=s,s.extend=ScriptType.extend,s.attributes=new ScriptAttributes(s),function(t,e,s){if(t.legacy)return;if("function"!=typeof t)throw new Error(`script class: '${t}' must be a constructor function (i.e. class).`);if(!(t.prototype instanceof ScriptType))throw new Error(`script class: '${ScriptType.__getScriptName(t)}' does not extend pc.ScriptType.`);if(e=e||t.__name||ScriptType.__getScriptName(t),Nc.has(e))throw new Error(`script name: '${e}' is reserved, please change script name`);t.__name=e;(s?s.scripts:Application.getApplication().scripts).add(t),ScriptHandler._push(t)}(s,t,e),s}const Wc={};function Gc(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}ScriptAttributes.reservedNames.forEach(((t,e,s)=>{Wc[t]=1})),Hc.reservedAttributes=Wc;class MouseEvent$1{constructor(t,e){let s={x:0,y:0};if(e){if(e instanceof MouseEvent$1)throw Error("Expected MouseEvent");s=t._getTargetCoords(e)}else e={};if(s)this.x=s.x,this.y=s.y;else{if(!Gc())return;this.x=0,this.y=0}this.wheelDelta=0,"wheel"===e.type&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1)),Gc()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=this.x-t._lastX,this.dy=this.y-t._lastY),"mousedown"===e.type||"mouseup"===e.type?this.button=e.button:this.button=-1,this.buttons=t._buttons.slice(0),this.element=e.target,this.ctrlKey=e.ctrlKey||!1,this.altKey=e.altKey||!1,this.shiftKey=e.shiftKey||!1,this.metaKey=e.metaKey||!1,this.event=e}}class Mouse extends EventHandler{constructor(t){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=t=>{t.preventDefault()},this._target=null,this._attached=!1,this.attach(t)}static isPointerLocked(){return Gc()}attach(t){if(this._target=t,this._attached)return;this._attached=!0;const e=!!S.passiveEvents&&{passive:!1};window.addEventListener("mouseup",this._upHandler,e),window.addEventListener("mousedown",this._downHandler,e),window.addEventListener("mousemove",this._moveHandler,e),window.addEventListener("wheel",this._wheelHandler,e)}detach(){if(!this._attached)return;this._attached=!1,this._target=null;const t=!!S.passiveEvents&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(t,e){if(!document.body.requestPointerLock)return void(e&&e());const s=()=>{t(),document.removeEventListener("pointerlockchange",s)},i=()=>{e(),document.removeEventListener("pointerlockerror",i)};t&&document.addEventListener("pointerlockchange",s,!1),e&&document.addEventListener("pointerlockerror",i,!1),document.body.requestPointerLock()}disablePointerLock(t){if(!document.exitPointerLock)return;const e=()=>{t(),document.removeEventListener("pointerlockchange",e)};t&&document.addEventListener("pointerlockchange",e,!1),document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(t){return this._buttons[t]}wasPressed(t){return this._buttons[t]&&!this._lastbuttons[t]}wasReleased(t){return!this._buttons[t]&&this._lastbuttons[t]}_handleUp(t){this._buttons[t.button]=!1;const e=new MouseEvent$1(this,t);e.event&&this.fire(_c,e)}_handleDown(t){this._buttons[t.button]=!0;const e=new MouseEvent$1(this,t);e.event&&this.fire(pc,e)}_handleMove(t){const e=new MouseEvent$1(this,t);e.event&&(this.fire(mc,e),this._lastX=e.x,this._lastY=e.y)}_handleWheel(t){const e=new MouseEvent$1(this,t);e.event&&this.fire(fc,e)}_getTargetCoords(t){const e=this._target.getBoundingClientRect(),s=Math.floor(e.left),i=Math.floor(e.top);return t.clientX<s||t.clientX>=s+this._target.clientWidth||t.clientY<i||t.clientY>=i+this._target.clientHeight?null:{x:t.clientX-s,y:t.clientY-i}}}let jc,Xc;const qc=new Vec3,$c=new Vec3,Yc=new Ray,Kc=new Ray,Zc=new Ray;Yc.end=new Vec3,Kc.end=new Vec3,Zc.end=new Vec3;const Qc=new Vec3,Jc=new Vec3,td=new Vec3,ed=new Vec3,sd=new Vec3,id=new Vec3,nd=new Vec3,ad=new Vec3,rd=new Vec3,od=new Vec3,ld=new Vec3,hd=new Vec3,cd=new Vec3,dd=new Vec3,ud=new Vec3,pd=new Vec3,md=new Vec3,_d=new Vec3,fd=new Vec3,gd=new Vec3,yd=new Vec4;function vd(t,e,s){return ld.cross(t,e).dot(s)}class ElementInputEvent{constructor(t,e,s){this.event=t,this.element=e,this.camera=s,this._stopPropagation=!1}stopPropagation(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}}class ElementMouseEvent extends ElementInputEvent{constructor(t,e,s,i,n,a,r){super(t,e,s),this.x=i,this.y=n,this.ctrlKey=t.ctrlKey||!1,this.altKey=t.altKey||!1,this.shiftKey=t.shiftKey||!1,this.metaKey=t.metaKey||!1,this.button=t.button,Mouse.isPointerLocked()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=i-a,this.dy=n-r),this.wheelDelta=0,"wheel"===t.type&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1))}}class ElementTouchEvent extends ElementInputEvent{constructor(t,e,s,i,n,a){super(t,e,s),this.touches=t.touches,this.changedTouches=t.changedTouches,this.x=i,this.y=n,this.touch=a}}class ElementSelectEvent extends ElementInputEvent{constructor(t,e,s,i){super(t,e,s),this.inputSource=i}}class Touch{constructor(t){const e=function(t){let e=0,s=0,i=t.target;for(;!(i instanceof HTMLElement);)i=i.parentNode;let n=i;do{e+=n.offsetLeft-n.scrollLeft,s+=n.offsetTop-n.scrollTop,n=n.offsetParent}while(n);return{x:t.pageX-e,y:t.pageY-s}}(t);this.id=t.identifier,this.x=e.x,this.y=e.y,this.target=t.target,this.touch=t}}class TouchEvent{constructor(t,e){if(this.element=e.target,this.event=e,this.touches=[],this.changedTouches=[],e){for(let t=0,s=e.touches.length;t<s;t++)this.touches.push(new Touch(e.touches[t]));for(let t=0,s=e.changedTouches.length;t<s;t++)this.changedTouches.push(new Touch(e.changedTouches[t]))}}getTouchById(t,e){for(let s=0,i=e.length;s<i;s++)if(e[s].id===t)return e[s];return null}}class TouchDevice extends EventHandler{constructor(t){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(t)}attach(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null}_handleTouchStart(t){this.fire("touchstart",new TouchEvent(this,t))}_handleTouchEnd(t){this.fire("touchend",new TouchEvent(this,t))}_handleTouchMove(t){t.preventDefault(),this.fire("touchmove",new TouchEvent(this,t))}_handleTouchCancel(t){this.fire("touchcancel",new TouchEvent(this,t))}}D.endsWith=function(t,e){return t.endsWith(e)},D.startsWith=function(t,e){return t.startsWith(e)},Object.defineProperty(Color.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}}),Object.defineProperty(Color.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}}),O.INV_LOG2=Math.LOG2E,O.intToBytes=O.intToBytes32,O.bytesToInt=O.bytesToInt32,Object.defineProperty(Vec2.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}}),Vec2.prototype.scale=Vec2.prototype.mulScalar,Object.defineProperty(Vec3.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}}),Vec3.prototype.scale=Vec3.prototype.mulScalar,Object.defineProperty(Vec4.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}}),Vec4.prototype.scale=Vec4.prototype.mulScalar,BoundingSphere.prototype.intersectRay=BoundingSphere.prototype.intersectsRay,Frustum.prototype.update=function(t,e){const s=new Mat4;s.mul2(t,e),this.setFromMat4(s)},Object.defineProperty(Zt,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+Zt.transformVS}});const bd={"ambientPrefilteredCube.frag":"ambientEnv.frag","ambientPrefilteredCubeLod.frag":"ambientEnv.frag","dpAtlasQuad.frag":null,"genParaboloid.frag":null,"prefilterCubemap.frag":null,"reflectionDpAtlas.frag":"reflectionEnv.frag","reflectionPrefilteredCube.frag":"reflectionEnv.frag","reflectionPrefilteredCubeLod.frag":"reflectionEnv.frag"};function xd(t,e){Object.defineProperty(StandardMaterial.prototype,e,{get:function(){return this[t]},set:function(e){this[t]=e}})}Object.keys(bd).forEach((t=>{Object.defineProperty(Zt,t,{get:function(){return null},set:function(){}})})),Object.defineProperties(Texture.prototype,{rgbm:{get:function(){return this.type===Ot},set:function(t){this.type=t?Ot:Ft}},swizzleGGGR:{get:function(){return this.type===Bt},set:function(t){this.type=t?Bt:Ft}}}),Object.defineProperty(Scene$1.prototype,"defaultMaterial",{get:function(){return DefaultMaterial.get(ei().graphicsDevice)}}),["128","64","32","16","8","4"].forEach(((t,e)=>{Object.defineProperty(Scene$1.prototype,`skyboxPrefiltered${t}`,{get:function(){return this._prefilteredCubemaps[e]},set:function(t){this._prefilteredCubemaps[e]=t,this.updateShaders=!0}})})),Object.defineProperty(Batch.prototype,"model",{get:function(){return null}}),MeshInstance.prototype.syncAabb=function(){},Morph.prototype.getTarget=function(t){return this.targets[t]},GraphNode.prototype._dirtify=function(t){t?this._dirtifyLocal():this._dirtifyWorld()},GraphNode.prototype.addLabel=function(t){this._labels[t]=!0},GraphNode.prototype.getLabels=function(){return Object.keys(this._labels)},GraphNode.prototype.hasLabel=function(t){return!!this._labels[t]},GraphNode.prototype.removeLabel=function(t){delete this._labels[t]},GraphNode.prototype.findByLabel=function(t,e=[]){this.hasLabel(t)&&e.push(this);for(let s=0;s<this._children.length;++s)e=this._children[s].findByLabel(t,e);return e},GraphNode.prototype.getChildren=function(){return this.children},GraphNode.prototype.getName=function(){return this.name},GraphNode.prototype.getPath=function(){return this.path},GraphNode.prototype.getRoot=function(){return this.root},GraphNode.prototype.getParent=function(){return this.parent},GraphNode.prototype.setName=function(t){this.name=t},Material$1.prototype.getName=function(){return this.name},Material$1.prototype.setName=function(t){this.name=t},Material$1.prototype.getShader=function(){return this.shader},Material$1.prototype.setShader=function(t){this.shader=t},xd("diffuseTint","diffuseMapTint"),xd("specularTint","specularMapTint"),xd("emissiveTint","emissiveMapTint"),xd("aoVertexColor","aoMapVertexColor"),xd("diffuseVertexColor","diffuseMapVertexColor"),xd("specularVertexColor","specularMapVertexColor"),xd("emissiveVertexColor","emissiveMapVertexColor"),xd("metalnessVertexColor","metalnessMapVertexColor"),xd("glossVertexColor","glossMapVertexColor"),xd("opacityVertexColor","opacityMapVertexColor"),xd("lightVertexColor","lightMapVertexColor"),Animation.prototype.getDuration=function(){return this.duration},Animation.prototype.getName=function(){return this.name},Animation.prototype.getNodes=function(){return this.nodes},Animation.prototype.setDuration=function(t){this.duration=t},Animation.prototype.setName=function(t){this.name=t},Skeleton.prototype.getAnimation=function(){return this.animation},Skeleton.prototype.getCurrentTime=function(){return this.currentTime},Skeleton.prototype.getLooping=function(){return this.looping},Skeleton.prototype.getNumNodes=function(){return this.numNodes},Skeleton.prototype.setAnimation=function(t){this.animation=t},Skeleton.prototype.setCurrentTime=function(t){this.currentTime=t},Skeleton.prototype.setLooping=function(t){this.looping=t},SoundManager.prototype.getListener=function(){return this.listener},SoundManager.prototype.getVolume=function(){return this.volume},SoundManager.prototype.setVolume=function(t){this.volume=t},AssetRegistry.prototype.getAssetById=function(t){return this.get(t)},Object.defineProperty(XrInputSource.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(XrInputSource.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(XrInputSource.prototype,"rotation",{get:function(){return this._localRotation}}),Object.defineProperty(class ElementInput{constructor(t,e){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!e||!1!==e.useMouse,this._useTouch=!e||!1!==e.useTouch,this._useXr=!e||!1!==e.useXr,this._selectEventsAttached=!1,S.touch&&(this._clickedEntities={}),this.attach(t)}set enabled(t){this._enabled=t}get enabled(){return this._enabled}set app(t){this._app=t}get app(){return this._app||ei()}attach(t){this._attached&&(this._attached=!1,this.detach()),this._target=t,this._attached=!0;const e=!!S.passiveEvents&&{passive:!0};this._useMouse&&(window.addEventListener("mouseup",this._upHandler,e),window.addEventListener("mousedown",this._downHandler,e),window.addEventListener("mousemove",this._moveHandler,e),window.addEventListener("wheel",this._wheelHandler,e)),this._useTouch&&S.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,e),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()}attachSelectEvents(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))}detach(){if(!this._attached)return;this._attached=!1;const t=!!S.passiveEvents&&{passive:!0};this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,t),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}addElement(t){-1===this._elements.indexOf(t)&&this._elements.push(t)}removeElement(t){const e=this._elements.indexOf(t);-1!==e&&this._elements.splice(e,1)}_handleUp(t){this._enabled&&(Mouse.isPointerLocked()||(this._calcMouseCoords(t),null!==jc&&this._onElementMouseEvent("mouseup",t)))}_handleDown(t){this._enabled&&(Mouse.isPointerLocked()||(this._calcMouseCoords(t),null!==jc&&this._onElementMouseEvent("mousedown",t)))}_handleMove(t){this._enabled&&(this._calcMouseCoords(t),null!==jc&&(this._onElementMouseEvent("mousemove",t),this._lastX=jc,this._lastY=Xc))}_handleWheel(t){this._enabled&&(this._calcMouseCoords(t),null!==jc&&this._onElementMouseEvent("mousewheel",t))}_determineTouchedElements(t){const e={},s=this.app.systems.camera.cameras;for(let i=s.length-1;i>=0;i--){const n=s[i];let a=0;const r=t.changedTouches.length;for(let s=0;s<r;s++){if(e[t.changedTouches[s].identifier]){a++;continue}const i=this._calcTouchCoords(t.changedTouches[s]),r=this._getTargetElement(n,i.x,i.y);r&&(a++,e[t.changedTouches[s].identifier]={element:r,camera:n,x:i.x,y:i.y})}if(a===r)break}return e}_handleTouchStart(t){if(!this._enabled)return;const e=this._determineTouchedElements(t);for(let s=0,i=t.changedTouches.length;s<i;s++){const i=t.changedTouches[s],n=e[i.identifier],a=this._touchedElements[i.identifier];!n||a&&n.element===a.element||(this._fireEvent(t.type,new ElementTouchEvent(t,n.element,n.camera,n.x,n.y,i)),this._touchesForWhichTouchLeaveHasFired[i.identifier]=!1)}for(const s in e)this._touchedElements[s]=e[s]}_handleTouchEnd(t){if(!this._enabled)return;const e=this.app.systems.camera.cameras;for(const s in this._clickedEntities)delete this._clickedEntities[s];for(let s=0,i=t.changedTouches.length;s<i;s++){const i=t.changedTouches[s],n=this._touchedElements[i.identifier];if(!n)continue;const a=n.element,r=n.camera,o=n.x,l=n.y;if(delete this._touchedElements[i.identifier],delete this._touchesForWhichTouchLeaveHasFired[i.identifier],this._fireEvent(t.type,new ElementTouchEvent(t,a,r,o,l,i)),0===t.touches.length){const s=this._calcTouchCoords(i);for(let n=e.length-1;n>=0;n--){this._getTargetElement(e[n],s.x,s.y)===a&&(this._clickedEntities[a.entity.getGuid()]||(this._fireEvent("click",new ElementTouchEvent(t,a,r,o,l,i)),this._clickedEntities[a.entity.getGuid()]=!0))}}}}_handleTouchMove(t){if(t.preventDefault(),!this._enabled)return;const e=this._determineTouchedElements(t);for(let s=0,i=t.changedTouches.length;s<i;s++){const i=t.changedTouches[s],n=e[i.identifier],a=this._touchedElements[i.identifier];if(a){const e=this._calcTouchCoords(i);n&&n.element===a.element||this._touchesForWhichTouchLeaveHasFired[i.identifier]||(this._fireEvent("touchleave",new ElementTouchEvent(t,a.element,a.camera,e.x,e.y,i)),this._touchesForWhichTouchLeaveHasFired[i.identifier]=!0),this._fireEvent("touchmove",new ElementTouchEvent(t,a.element,a.camera,e.x,e.y,i))}}}_onElementMouseEvent(t,e){let s;const i=this._hoveredElement;this._hoveredElement=null;const n=this.app.systems.camera.cameras;let a;for(let r=n.length-1;r>=0&&(a=n[r],s=this._getTargetElement(a,jc,Xc),!s);r--);s&&(this._fireEvent(t,new ElementMouseEvent(e,s,a,jc,Xc,this._lastX,this._lastY)),this._hoveredElement=s,"mousedown"===t&&(this._pressedElement=s)),i!==this._hoveredElement&&(i&&this._fireEvent("mouseleave",new ElementMouseEvent(e,i,a,jc,Xc,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new ElementMouseEvent(e,this._hoveredElement,a,jc,Xc,this._lastX,this._lastY))),"mouseup"===t&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||this._fireEvent("click",new ElementMouseEvent(e,this._hoveredElement,a,jc,Xc,this._lastX,this._lastY))):this._pressedElement=null)}_onXrStart(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)}_onXrEnd(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)}_onXrUpdate(){if(!this._enabled)return;const t=this.app.xr.input.inputSources;for(let e=0;e<t.length;e++)this._onElementSelectEvent("selectmove",t[e],null)}_onXrInputRemove(t){const e=this._selectedElements[t.id];e&&(t._elementEntity=null,this._fireEvent("selectleave",new ElementSelectEvent(null,e,null,t))),delete this._selectedElements[t.id],delete this._selectedPressedElements[t.id]}_onSelectStart(t,e){this._enabled&&this._onElementSelectEvent("selectstart",t,e)}_onSelectEnd(t,e){this._enabled&&this._onElementSelectEvent("selectend",t,e)}_onElementSelectEvent(t,e,s){let i;const n=this._selectedElements[e.id];let a;const r=this.app.systems.camera.cameras;let o;if(e.elementInput){Zc.set(e.getOrigin(),e.getDirection());for(let t=r.length-1;t>=0&&(o=r[t],i=this._getTargetElementByRay(Zc,o),!i);t--);}e._elementEntity=i||null,i?(this._selectedElements[e.id]=i,a=i):delete this._selectedElements[e.id],n!==a&&(n&&this._fireEvent("selectleave",new ElementSelectEvent(s,n,o,e)),a&&this._fireEvent("selectenter",new ElementSelectEvent(s,a,o,e))),"selectstart"===t&&(this._selectedPressedElements[e.id]=a,a&&this._fireEvent("selectstart",new ElementSelectEvent(s,a,o,e)));const l=this._selectedPressedElements[e.id];!e.elementInput&&l&&(delete this._selectedPressedElements[e.id],n&&this._fireEvent("selectend",new ElementSelectEvent(s,n,o,e))),"selectend"===t&&e.elementInput&&(delete this._selectedPressedElements[e.id],n&&this._fireEvent("selectend",new ElementSelectEvent(s,n,o,e)),l&&l===n&&this._fireEvent("click",new ElementSelectEvent(s,l,o,e)))}_fireEvent(t,e){let s=e.element;for(;s.fire(t,e),!e._stopPropagation&&s.entity.parent&&(s=s.entity.parent.element,s););}_calcMouseCoords(t){const e=this._target.getBoundingClientRect(),s=Math.floor(e.left),i=Math.floor(e.top);t.clientX<s||t.clientX>=s+this._target.clientWidth||t.clientY<i||t.clientY>=i+this._target.clientHeight?(jc=null,Xc=null):(jc=t.clientX-s,Xc=t.clientY-i)}_calcTouchCoords(t){let e=0,s=0,i=t.target;for(;!(i instanceof HTMLElement);)i=i.parentNode;let n=i;do{e+=n.offsetLeft-n.scrollLeft,s+=n.offsetTop-n.scrollTop,n=n.offsetParent}while(n);return{x:t.pageX-e,y:t.pageY-s}}_sortElements(t,e){const s=this.app.scene.layers.sortTransparentLayers(t.layers,e.layers);return 0!==s?s:t.screen&&!e.screen?-1:!t.screen&&e.screen?1:t.screen||e.screen?t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?-1:e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?1:e.drawOrder-t.drawOrder:0}_getTargetElement(t,e,s){let i,n,a=null,r=1/0;this._elements.sort(this._sortHandler);for(let o=0,l=this._elements.length;o<l;o++){const l=this._elements[o];if(l.screen&&l.screen.screen.screenSpace){if(void 0===i&&(i=this._calculateRayScreen(e,s,t,Yc)?Yc:null),!i)continue;if(this._checkElement(i,l,!0)>=0){a=l;break}}else{if(void 0===n&&(n=this._calculateRay3d(e,s,t,Kc)?Kc:null),!n)continue;const i=this._checkElement(n,l,!1);if(i>=0&&(i<r&&(a=l,r=i),l.screen)){a=l;break}}}return a}_getTargetElementByRay(t,e){let s=null;Yc.origin.copy(t.origin),Yc.direction.copy(t.direction),Yc.end.copy(Yc.direction).mulScalar(2*e.farClip).add(Yc.origin),this._elements.sort(this._sortHandler);for(let i=0,n=this._elements.length;i<n;i++){const t=this._elements[i];if((!t.screen||!t.screen.screen.screenSpace)&&this._checkElement(Yc,t,!1)>=0){s=t;break}}return s}_buildHitCorners(t,e,s,i,n){let a=e;if(t.entity&&t.entity.button){const e=t.entity.button.hitPadding||yd;cd.copy(t.entity.up),dd.copy(cd).mulScalar(-1),pd.copy(t.entity.right),ud.copy(pd).mulScalar(-1),cd.mulScalar(e.w*i),dd.mulScalar(e.y*i),pd.mulScalar(e.z*s),ud.mulScalar(e.x*s),md.copy(a[0]).add(dd).add(ud),_d.copy(a[1]).add(dd).add(pd),fd.copy(a[2]).add(cd).add(pd),gd.copy(a[3]).add(cd).add(ud),a=[md,_d,fd,gd]}if(s<0){const t=a[2].x,e=a[0].x;a[0].x=t,a[1].x=e,a[2].x=e,a[3].x=t}if(i<0){const t=a[2].y,e=a[0].y;a[0].y=t,a[1].y=t,a[2].y=e,a[3].y=e}if(n<0){const t=a[2].x,e=a[2].y,s=a[2].z;a[2].x=a[0].x,a[2].y=a[0].y,a[2].z=a[0].z,a[0].x=t,a[0].y=e,a[0].z=s}return a}_calculateScaleToScreen(t){let e=t.entity;const s=t.screen.screen.scale;for(hd.set(s,s,s);e&&!e.screen;)hd.mul(e.getLocalScale()),e=e.parent;return hd}_calculateScaleToWorld(t){let e=t.entity;for(hd.set(1,1,1);e;)hd.mul(e.getLocalScale()),e=e.parent;return hd}_calculateRayScreen(t,e,s,i){const n=this.app.graphicsDevice.width,a=this.app.graphicsDevice.height,r=s.rect.z*n,o=s.rect.w*a,l=s.rect.x*n,h=l+r,c=(1-s.rect.y)*a,d=c-o;let u=t*n/this._target.clientWidth,p=e*a/this._target.clientHeight;return u>=l&&u<=h&&p<=c&&p>=d&&(u=n*(u-l)/r,p=a*(p-d)/o,p=a-p,i.origin.set(u,p,1),i.direction.set(0,0,-1),i.end.copy(i.direction).mulScalar(2).add(i.origin),!0)}_calculateRay3d(t,e,s,i){const n=this._target.clientWidth,a=this._target.clientHeight,r=s.rect.z*n,o=s.rect.w*a,l=s.rect.x*n,h=l+r,c=(1-s.rect.y)*a,d=c-o;let u=t,p=e;return t>=l&&t<=h&&e<=c&&p>=d&&(u=n*(u-l)/r,p=a*(p-d)/o,s.screenToWorld(u,p,s.nearClip,qc),s.screenToWorld(u,p,s.farClip,$c),i.origin.copy(qc),i.direction.set(0,0,-1),i.end.copy($c),!0)}_checkElement(t,e,s){if(e.maskedBy&&this._checkElement(t,e.maskedBy.element,s)<0)return-1;let i;i=s?this._calculateScaleToScreen(e):this._calculateScaleToWorld(e);const n=this._buildHitCorners(e,s?e.screenCorners:e.worldCorners,i.x,i.y,i.z);return function(t,e,s){Qc.sub2(e,t),Jc.sub2(s[0],t),td.sub2(s[1],t),ed.sub2(s[2],t),id.cross(ed,Qc);let i,n,a=Jc.dot(id);if(a>=0){if(i=-td.dot(id),i<0)return-1;if(n=vd(Qc,td,Jc),n<0)return-1;const t=1/(i+a+n);nd.copy(s[0]).mulScalar(i*t),ad.copy(s[1]).mulScalar(a*t),rd.copy(s[2]).mulScalar(n*t),od.copy(nd).add(ad).add(rd)}else{if(sd.sub2(s[3],t),i=sd.dot(id),i<0)return-1;if(n=vd(Qc,Jc,sd),n<0)return-1;a=-a;const e=1/(i+a+n);nd.copy(s[0]).mulScalar(i*e),ad.copy(s[3]).mulScalar(a*e),rd.copy(s[2]).mulScalar(n*e),od.copy(nd).add(ad).add(rd)}return Qc.sub2(s[0],s[2]).lengthSq()<1e-8||Qc.sub2(s[1],s[3]).lengthSq()<1e-8?-1:od.sub(t).lengthSq()}(t.origin,t.end,n)}}.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),Object.defineProperty(MouseEvent$1.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),Application.prototype.isFullscreen=function(){return!!document.fullscreenElement},Application.prototype.enableFullscreen=function(t,e,s){t=t||this.graphicsDevice.canvas;const i=function t(){e(),document.removeEventListener("fullscreenchange",t)},n=function t(){s(),document.removeEventListener("fullscreenerror",t)};e&&document.addEventListener("fullscreenchange",i,!1),s&&document.addEventListener("fullscreenerror",n,!1),t.requestFullscreen?t.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):s()},Application.prototype.disableFullscreen=function(t){const e=function e(){t(),document.removeEventListener("fullscreenchange",e)};t&&document.addEventListener("fullscreenchange",e,!1),document.exitFullscreen()},Application.prototype.getSceneUrl=function(t){const e=this.scenes.find(t);return e?e.url:null},Application.prototype.loadScene=function(t,e){this.scenes.loadScene(t,e)},Application.prototype.loadSceneHierarchy=function(t,e){this.scenes.loadSceneHierarchy(t,e)},Application.prototype.loadSceneSettings=function(t,e){this.scenes.loadSceneSettings(t,e)},Application.prototype.renderMeshInstance=function(t,e){const s=null!=e&&e.layer?e.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(null,null,null,t,s)},Application.prototype.renderMesh=function(t,e,s,i){const n=null!=i&&i.layer?i.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(e,s,t,null,n)},Application.prototype._addLines=function(t,e,s){const i=s&&s.layer?s.layer:this.scene.layers.getLayerById(3),n=!s||void 0===s.depthTest||s.depthTest;this.scene.immediate.getBatch(i,n).addLines(t,e)},Application.prototype.renderLine=function(t,e,s){let i,n=s;const a=arguments[3],r=arguments[4];a instanceof Color?(n=a,i="number"==typeof r?1===r?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}:r):"number"==typeof a?(n=s,i=1===a?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):a&&(i=a),this._addLines([t,e],[s,n],i)},Application.prototype.renderLines=function(t,e,s){s?"number"==typeof s&&(s=1===s?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):s={layer:this.scene.layers.getLayerById(3),depthTest:!0};!e.length||t.length===e.length?t.length%2==0?this._addLines(t,e,s):console.error("renderLines: array length is not divisible by 2"):console.error("renderLines: position/color arrays have different lengths")},Object.defineProperty(CameraComponent.prototype,"node",{get:function(){return this.entity}}),Object.defineProperty(LightComponent.prototype,"enable",{get:function(){return this.enabled},set:function(t){this.enabled=t}}),ModelComponent.prototype.setVisible=function(t){this.enabled=t},Object.defineProperty(ModelComponent.prototype,"aabb",{get:function(){return null},set:function(t){}}),Object.defineProperty(RenderComponent.prototype,"aabb",{get:function(){return null},set:function(t){}}),Object.defineProperty(RigidBodyComponent.prototype,"bodyType",{get:function(){return this.type},set:function(t){this.type=t}}),RigidBodyComponent.prototype.syncBodyToEntity=function(){this._updateDynamic()},RigidBodyComponentSystem.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};const Sd=[.2472488433122635,1.6666533946990967,0,.16416716575622559,1.6666533946990967,0,.15526895225048065,1.5763176679611206,0,.23243571817874908,1.5668010711669922,0,.3315504193305969,1.6666533946990967,0,.3090425729751587,1.5535097122192383,0,.41751596331596375,1.6666533946990967,0,.3849049210548401,1.5364761352539062,0,.5056233406066895,1.6666533946990967,0,.45983991026878357,1.5157407522201538,0,.5963965654373169,1.6666533946990967,0,.5336672067642212,1.4913538694381714,0,.6904183030128479,1.6666533946990967,0,.6062088012695312,1.463374137878418,0,.7883456349372864,1.6666533946990967,0,.6772900223731995,1.4318692684173584,0,.8909319639205933,1.6666533946990967,0,.7467395067214966,1.3969147205352783,0,.9990513324737549,1.6666533946990967,0,.8143900036811829,1.3585948944091797,0,1.1137312650680542,1.6666533946990967,0,.8800786733627319,1.3170020580291748,0,1.2361955642700195,1.6666533946990967,0,.9436472058296204,1.2722365856170654,0,.07772809267044067,1.6666533946990967,0,.07772809267044067,1.5820367336273193,0,0,1.6666533946990967,0,0,1.5839447975158691,0,-.0817786380648613,1.664645791053772,0,-.07772809267044067,1.5820367336273193,0,-.16336026787757874,1.658627986907959,0,-.15526895225048065,1.5763176679611206,0,-.24454833567142487,1.6486144065856934,0,-.23243571817874908,1.5668010711669922,0,-.3251473009586334,1.6346290111541748,0,-.3090425729751587,1.5535097122192383,0,-.404962956905365,1.6167058944702148,0,-.3849049210548401,1.5364761352539062,0,-.4838029444217682,1.5948878526687622,0,-.45983991026878357,1.5157407522201538,0,-.5614774823188782,1.5692274570465088,0,-.5336672067642212,1.4913538694381714,0,-.6377993226051331,1.5397869348526,0,-.6062088012695312,1.463374137878418,0,-.7125847339630127,1.5066368579864502,0,-.6772900223731995,1.4318692684173584,0,-.7856534123420715,1.469857096672058,0,-.7467395067214966,1.3969147205352783,0,-.8568293452262878,1.4295363426208496,0,-.8143900036811829,1.3585948944091797,0,-.9259411096572876,1.385771632194519,0,-.8800786733627319,1.3170020580291748,0,-.9928222894668579,1.3386685848236084,0,-.9436472058296204,1.2722365856170654,0,-1.0573115348815918,1.2883405685424805,0,-1.0049421787261963,1.2244060039520264,0,-1.1192537546157837,1.2349088191986084,0,-1.0638165473937988,1.1736259460449219,0,-1.178499460220337,1.178502082824707,0,-1.12012779712677,1.1200183629989624,0,-1.2349061965942383,1.1192562580108643,0,-1.1737405061721802,1.0637125968933105,0,-1.2883378267288208,1.0573139190673828,0,-1.224525809288025,1.004844307899475,0,-1.3386658430099487,.9928244948387146,0,-1.2723610401153564,.9435550570487976,0,-1.3857687711715698,.9259433746337891,0,-1.3171309232711792,.8799929022789001,0,-1.4295333623886108,.8568314909934998,0,-1.3587278127670288,.8143108487129211,0,-1.4698541164398193,.7856553196907043,0,-1.397051453590393,.7466667890548706,0,-1.5066337585449219,.712586522102356,0,-1.4320093393325806,.6772240400314331,0,-1.5397837162017822,.6378011107444763,0,-1.4635173082351685,.6061499118804932,0,-1.5692243576049805,.5614790916442871,0,-1.4914997816085815,.5336154103279114,0,-1.5948846340179443,.4838044345378876,0,-1.5158891677856445,.45979538559913635,0,-1.6167025566101074,.40496429800987244,0,-1.5366264581680298,.384867787361145,0,-1.6346256732940674,.3251485228538513,0,-1.553661823272705,.30901291966438293,0,-1.648611068725586,.2445494532585144,0,-1.5669543743133545,.23241358995437622,0,-1.6586246490478516,.16336126625537872,0,-1.5764720439910889,.15525442361831665,0,-1.6646424531936646,.08177950978279114,0,-1.5821917057037354,.07772119343280792,0,-1.6666499376296997,7.450580596923828e-7,0,-1.5840997695922852,7.450580596923828e-7,0,1.3679208755493164,1.6666533946990967,0,1.0049421787261963,1.2244060039520264,0,1.9099923372268677,.4214799404144287,0,1.9868781566619873,.4573325216770172,0,1.744999885559082,.7199999690055847,0,1.8405001163482666,.37282103300094604,0,2.526153802871704,.31283411383628845,0,2.5950000286102295,.7249999642372131,0,2.4661667346954346,.37282103300094604,0,2.396674633026123,.4214799404144287,0,3.5353410243988037,.4214799404144287,0,3.6048333644866943,.37282103300094604,0,3.705000162124634,.7199999690055847,0,2.884999990463257,.7300000190734863,0,3.048658847808838,.4214799404144287,0,3.125544548034668,.4573325216770172,0,2.9791665077209473,.37282103300094604,0,4.187325954437256,.4214799404144287,0,4.03000020980835,.7050000429153442,0,4.117833614349365,.37282103300094604,0,4.264211654663086,.4573325216770172,0,4.757999897003174,.5320000052452087,0,4.674007892608643,.4214799404144287,0,4.743500232696533,.37282103300094604,0,4.5971221923828125,.4573325216770172,0,1.190999984741211,1.1460000276565552,0,1.12012779712677,1.1200183629989624,0,1.1737405061721802,1.0637125968933105,0,1.224525809288025,1.004844307899475,0,2.1533334255218506,.8524738550186157,0,2.1533334255218506,.48668304085731506,0,2.237844944000244,.47928929328918457,0,3.2920002937316895,.8524738550186157,0,3.207489013671875,.47928929328918457,0,3.2920002937316895,.48668304085731506,0,3.376511573791504,.47928929328918457,0,4.057846546173096,.31283411383628845,0,2.2277963161468506,1.6666533946990967,0,2.2380640506744385,1.594059944152832,0,2.350635528564453,1.6666533946990967,0,2.104956865310669,1.6666533946990967,0,2.76401424407959,1.594059944152832,0,3.2422549724578857,1.594059944152832,0,2.964832305908203,1.6666533946990967,0,3.0876717567443848,1.6666533946990967,0,2.8419928550720215,1.6666533946990967,0,2.719153642654419,1.6666533946990967,0,3.2105109691619873,1.6666533946990967,0,3.33335018157959,1.6666533946990967,0,1.7364388704299927,1.6666533946990967,0,1.8633335828781128,1.594059944152832,0,1.8592782020568848,1.6666533946990967,0,1.613599419593811,1.6666533946990967,0,3.4151289463043213,1.664645791053772,0,2.068822145462036,.47928929328918457,0,2.319788694381714,.4573325216770172,0,3.4584550857543945,.4573325216770172,0,3.6648201942443848,.31283411383628845,0,4.346155166625977,.47928929328918457,0,4.430666446685791,.8524738550186157,0,4.430666446685791,.48668304085731506,0,4.5151777267456055,.47928929328918457,0,1.0638165473937988,1.1736259460449219,0,1.3559999465942383,.918999969959259,0,1.2723610401153564,.9435550570487976,0,1.3171309232711792,.8799929022789001,0,1.397051453590393,.7466667890548706,0,1.3587278127670288,.8143108487129211,0,1.9821174144744873,1.6666533946990967,0,3.5820000171661377,1.5760000944137573,0,3.4967105388641357,1.658627986907959,0,1.490760087966919,1.6666533946990967,0,2.812711238861084,.08451224118471146,0,2.7226827144622803,.08451224118471146,0,2.7226827144622803,7.450580596923828e-7,0,2.8053176403045654,7.450580596923828e-7,0,2.6326217651367188,.08451224118471146,0,2.6400158405303955,7.450580596923828e-7,0,2.7226827144622803,.727400004863739,0,2.5126829147338867,1.594059944152832,0,2.4734747409820557,1.6666533946990967,0,2.5963141918182373,1.6666533946990967,0,1.6740447282791138,.08451224118471146,0,1.5983912944793701,.09899487346410751,0,1.603168249130249,-.0011273215059190989,0,1.6666511297225952,7.450580596923828e-7,0,1.5821917057037354,.07772119343280792,0,1.5840997695922852,7.450580596923828e-7,0,1.4635173082351685,.6061499118804932,0,1.4914997816085815,.5336154103279114,0,1.5010000467300415,.6399999856948853,0,1.5158891677856445,.45979538559913635,0,1.4320093393325806,.6772240400314331,0,1.5366499423980713,1.594059944152832,0,1.7805131673812866,.31283411383628845,0,1.5699999332427979,.4000000059604645,0,1.6960015296936035,.16645589470863342,0,1.5906872749328613,.19898943603038788,0,1.5764720439910889,.15525442361831665,0,1.5810649394989014,.29885998368263245,0,1.7318540811538696,.24334189295768738,0,1.5669543743133545,.23241358995437622,0,1.5366264581680298,.384867787361145,0,1.553661823272705,.30901291966438293,0,2.919179677963257,.31283411383628845,0,2.7226827144622803,.31283411383628845,0,3.867666721343994,.7124999761581421,0,3.8959999084472656,1.49399995803833,0,4.131999969482422,1.3619999885559082,0,3.867666721343994,.31283411383628845,0,3.9513778686523438,.08451224118471146,0,3.867666721343994,.08451224118471146,0,3.867666721343994,7.450580596923828e-7,0,3.943984270095825,7.450580596923828e-7,0,3.7712883949279785,.08451224118471146,0,3.7786827087402344,7.450580596923828e-7,0,4.957400798797607,.08341200649738312,0,4.965715408325195,7.450580596923828e-7,0,5,7.450580596923828e-7,0,4.997992992401123,.08177950978279114,0,4.917348861694336,7.450580596923828e-7,0,4.9099555015563965,.08451224118471146,0,4.991974830627441,.16336126625537872,0,4.949268341064453,.16498948633670807,0,4.887998580932617,.16645589470863342,0,4.981961250305176,.2445494532585144,0,4.9413862228393555,.24406039714813232,0,4.852146148681641,.24334189295768738,0,2.7226827144622803,.16645589470863342,0,2.8346681594848633,.16645589470863342,0,2.6106650829315186,.16645589470863342,0,2.7226827144622803,.24334189295768738,0,2.87052059173584,.24334189295768738,0,2.574812889099121,.24334189295768738,0,3.867666721343994,.24334189295768738,0,4.009187698364258,.24334189295768738,0,3.7134792804718018,.24334189295768738,0,3.867666721343994,.16645589470863342,0,3.973334550857544,.16645589470863342,0,3.749331474304199,.16645589470863342,0,4.926000118255615,.3240000009536743,0,4.803487300872803,.31283411383628845,0,3.6584978103637695,1.6346290111541748,0,3.5778985023498535,1.6486144065856934,0,3.7383131980895996,1.6167058944702148,0,3.8171534538269043,1.5948878526687622,0,3.8948278427124023,1.5692274570465088,0,3.971149444580078,1.5397869348526,0,4.045935153961182,1.5066368579864502,0,4.119003772735596,1.469857096672058,0,4.190179824829102,1.4295363426208496,0,4.259291172027588,1.385771632194519,0,4.424000263214111,1.187999963760376,0,4.390661716461182,1.2883405685424805,0,4.326172351837158,1.3386685848236084,0,4.452604293823242,1.2349088191986084,0,4.511849880218506,1.178502082824707,0,4.568256378173828,1.1192562580108643,0,4.664000034332275,.9340000152587891,0,4.621687889099121,1.0573139190673828,0,4.672016143798828,.9928244948387146,0,4.719119071960449,.9259433746337891,0,4.76288366317749,.8568314909934998,0,4.809999942779541,.6679999828338623,0,4.80320405960083,.7856553196907043,0,4.839983940124512,.712586522102356,0,4.873133659362793,.6378011107444763,0,4.9025750160217285,.5614790916442871,0,4.892000198364258,.48000001907348633,0,4.928235054016113,.4838044345378876,0,4.967976093292236,.3251485228538513,0,4.950052738189697,.40496429800987244,0,.2472488433122635,-1.6666518449783325,0,.23243571817874908,-1.566799521446228,0,.15526895225048065,-1.5763161182403564,0,.16416716575622559,-1.6666518449783325,0,.3315504193305969,-1.6666518449783325,0,.3090425729751587,-1.5535082817077637,0,.41751596331596375,-1.6666518449783325,0,.3849049210548401,-1.5364747047424316,0,.5056233406066895,-1.6666518449783325,0,.45983991026878357,-1.5157392024993896,0,.5963965654373169,-1.6666518449783325,0,.5336672067642212,-1.4913523197174072,0,.6904183030128479,-1.6666518449783325,0,.6062088012695312,-1.4633725881576538,0,.7883456349372864,-1.6666518449783325,0,.6772900223731995,-1.4318677186965942,0,.8909319639205933,-1.6666518449783325,0,.7467395067214966,-1.3969132900238037,0,.9990513324737549,-1.6666518449783325,0,.8143900036811829,-1.3585933446884155,0,1.1137312650680542,-1.6666518449783325,0,.8800786733627319,-1.3170006275177002,0,1.2361955642700195,-1.6666518449783325,0,.9436472058296204,-1.2722350358963013,0,.07772809267044067,-1.5820351839065552,0,.07772809267044067,-1.6666518449783325,0,3469446951953614e-31,-1.5839433670043945,0,3469446951953614e-31,-1.6666518449783325,0,-.07772809267044067,-1.5820351839065552,0,-.0817786380648613,-1.6646442413330078,0,-.15526895225048065,-1.5763161182403564,0,-.16336026787757874,-1.6586264371871948,0,-.23243571817874908,-1.566799521446228,0,-.24454833567142487,-1.6486128568649292,0,-.3090425729751587,-1.5535082817077637,0,-.3251473009586334,-1.6346275806427002,0,-.3849049210548401,-1.5364747047424316,0,-.404962956905365,-1.6167044639587402,0,-.45983991026878357,-1.5157392024993896,0,-.4838029444217682,-1.5948864221572876,0,-.5336672067642212,-1.4913523197174072,0,-.5614774823188782,-1.5692260265350342,0,-.6062088012695312,-1.4633725881576538,0,-.6377993226051331,-1.539785385131836,0,-.6772900223731995,-1.4318677186965942,0,-.7125847339630127,-1.506635308265686,0,-.7467395067214966,-1.3969132900238037,0,-.7856534123420715,-1.4698556661605835,0,-.8143900036811829,-1.3585933446884155,0,-.8568293452262878,-1.429534912109375,0,-.8800786733627319,-1.3170006275177002,0,-.9259411096572876,-1.3857702016830444,0,-.9436472058296204,-1.2722350358963013,0,-.9928222894668579,-1.3386671543121338,0,-1.0049421787261963,-1.2244044542312622,0,-1.0573115348815918,-1.2883391380310059,0,-1.0638165473937988,-1.1736243963241577,0,-1.1192537546157837,-1.2349073886871338,0,-1.12012779712677,-1.1200168132781982,0,-1.178499460220337,-1.1785006523132324,0,-1.1737405061721802,-1.0637110471725464,0,-1.2349061965942383,-1.1192548274993896,0,-1.224525809288025,-1.004842758178711,0,-1.2883378267288208,-1.0573124885559082,0,-1.2723610401153564,-.9435535669326782,0,-1.3386658430099487,-.9928230047225952,0,-1.3171309232711792,-.8799914121627808,0,-1.3857687711715698,-.9259418845176697,0,-1.3587278127670288,-.8143093585968018,0,-1.4295333623886108,-.8568300008773804,0,-1.397051453590393,-.7466652989387512,0,-1.4698541164398193,-.785653829574585,0,-1.4320093393325806,-.6772225499153137,0,-1.5066337585449219,-.7125850319862366,0,-1.4635173082351685,-.6061484217643738,0,-1.5397837162017822,-.6377996206283569,0,-1.4914997816085815,-.533613920211792,0,-1.5692243576049805,-.5614776015281677,0,-1.5158891677856445,-.45979389548301697,0,-1.5948846340179443,-.4838029444217682,0,-1.5366264581680298,-.38486629724502563,0,-1.6167025566101074,-.40496280789375305,0,-1.553661823272705,-.30901142954826355,0,-1.6346256732940674,-.32514703273773193,0,-1.5669543743133545,-.23241209983825684,0,-1.648611068725586,-.24454796314239502,0,-1.5764720439910889,-.15525293350219727,0,-1.6586246490478516,-.16335977613925934,0,-1.5821917057037354,-.07771970331668854,0,-1.6646424531936646,-.08177801966667175,0,1.3679208755493164,-1.6666518449783325,0,1.0049421787261963,-1.2244044542312622,0,1.9099923372268677,-.4214784502983093,0,1.744999885559082,-.7199984788894653,0,1.9868781566619873,-.4573310315608978,0,1.8405001163482666,-.37281954288482666,0,2.526153802871704,-.31283262372016907,0,2.4661667346954346,-.37281954288482666,0,2.5950000286102295,-.7249984741210938,0,2.396674633026123,-.4214784502983093,0,3.5353410243988037,-.4214784502983093,0,3.705000162124634,-.7199984788894653,0,3.6048333644866943,-.37281954288482666,0,2.884999990463257,-.7299985289573669,0,3.125544548034668,-.4573310315608978,0,3.048658847808838,-.4214784502983093,0,2.9791665077209473,-.37281954288482666,0,4.187325954437256,-.4214784502983093,0,4.117833614349365,-.37281954288482666,0,4.03000020980835,-.7049984931945801,0,4.264211654663086,-.4573310315608978,0,4.757999897003174,-.5319985151290894,0,4.743500232696533,-.37281954288482666,0,4.674007892608643,-.4214784502983093,0,4.5971221923828125,-.4573310315608978,0,1.190999984741211,-1.145998477935791,0,1.1737405061721802,-1.0637110471725464,0,1.12012779712677,-1.1200168132781982,0,1.224525809288025,-1.004842758178711,0,2.1533334255218506,-.8524723052978516,0,2.237844944000244,-.4792878031730652,0,2.1533334255218506,-.4866815507411957,0,3.2920002937316895,-.8524723052978516,0,3.2920002937316895,-.4866815507411957,0,3.207489013671875,-.4792878031730652,0,3.376511573791504,-.4792878031730652,0,4.057846546173096,-.31283262372016907,0,2.2277963161468506,-1.6666518449783325,0,2.350635528564453,-1.6666518449783325,0,2.2380640506744385,-1.5940583944320679,0,2.104956865310669,-1.6666518449783325,0,2.76401424407959,-1.5940583944320679,0,3.2422549724578857,-1.5940583944320679,0,2.964832305908203,-1.6666518449783325,0,3.0876717567443848,-1.6666518449783325,0,2.8419928550720215,-1.6666518449783325,0,2.719153642654419,-1.6666518449783325,0,3.2105109691619873,-1.6666518449783325,0,3.33335018157959,-1.6666518449783325,0,1.7364388704299927,-1.6666518449783325,0,1.8592782020568848,-1.6666518449783325,0,1.8633335828781128,-1.5940583944320679,0,1.613599419593811,-1.6666518449783325,0,3.4151289463043213,-1.6646442413330078,0,2.068822145462036,-.4792878031730652,0,2.319788694381714,-.4573310315608978,0,3.4584550857543945,-.4573310315608978,0,3.6648201942443848,-.31283262372016907,0,4.346155166625977,-.4792878031730652,0,4.430666446685791,-.8524723052978516,0,4.430666446685791,-.4866815507411957,0,4.5151777267456055,-.4792878031730652,0,1.0638165473937988,-1.1736243963241577,0,1.3559999465942383,-.9189984798431396,0,1.2723610401153564,-.9435535669326782,0,1.3171309232711792,-.8799914121627808,0,1.397051453590393,-.7466652989387512,0,1.3587278127670288,-.8143093585968018,0,1.9821174144744873,-1.6666518449783325,0,3.5820000171661377,-1.5759985446929932,0,3.4967105388641357,-1.6586264371871948,0,1.490760087966919,-1.6666518449783325,0,2.812711238861084,-.08451075106859207,0,2.7226827144622803,-.08451075106859207,0,2.6326217651367188,-.08451075106859207,0,2.5126829147338867,-1.5940583944320679,0,2.7226827144622803,-.7273985147476196,0,2.4734747409820557,-1.6666518449783325,0,2.5963141918182373,-1.6666518449783325,0,1.6740447282791138,-.08451075106859207,0,1.603285551071167,-.10128706693649292,0,1.5821917057037354,-.07771970331668854,0,1.4635173082351685,-.6061484217643738,0,1.5010000467300415,-.6399984955787659,0,1.4914997816085815,-.533613920211792,0,1.5158891677856445,-.45979389548301697,0,1.4320093393325806,-.6772225499153137,0,1.5366499423980713,-1.5940583944320679,0,1.7805131673812866,-.31283262372016907,0,1.5699999332427979,-.3999985158443451,0,1.6960015296936035,-.16645440459251404,0,1.5991445779800415,-.2013990879058838,0,1.5764720439910889,-.15525293350219727,0,1.5888115167617798,-.3012150526046753,0,1.7318540811538696,-.243340402841568,0,1.5669543743133545,-.23241209983825684,0,1.5366264581680298,-.38486629724502563,0,1.553661823272705,-.30901142954826355,0,2.919179677963257,-.31283262372016907,0,2.7226827144622803,-.31283262372016907,0,3.8959999084472656,-1.4939985275268555,0,3.867666721343994,-.7124984860420227,0,4.131999969482422,-1.3619985580444336,0,3.867666721343994,-.31283262372016907,0,3.9513778686523438,-.08451075106859207,0,3.867666721343994,-.08451075106859207,0,3.7712883949279785,-.08451075106859207,0,4.957400798797607,-.08341051638126373,0,4.997992992401123,-.08177801966667175,0,4.9099555015563965,-.08451075106859207,0,4.991974830627441,-.16335977613925934,0,4.949268341064453,-.16498799622058868,0,4.887998580932617,-.16645440459251404,0,4.9413862228393555,-.24405890703201294,0,4.981961250305176,-.24454796314239502,0,4.852146148681641,-.243340402841568,0,2.7226827144622803,-.16645440459251404,0,2.8346681594848633,-.16645440459251404,0,2.6106650829315186,-.16645440459251404,0,2.7226827144622803,-.243340402841568,0,2.87052059173584,-.243340402841568,0,2.574812889099121,-.243340402841568,0,4.009187698364258,-.243340402841568,0,3.867666721343994,-.243340402841568,0,3.7134792804718018,-.243340402841568,0,3.867666721343994,-.16645440459251404,0,3.973334550857544,-.16645440459251404,0,3.749331474304199,-.16645440459251404,0,4.926000118255615,-.32399851083755493,0,4.803487300872803,-.31283262372016907,0,3.5778985023498535,-1.6486128568649292,0,3.6584978103637695,-1.6346275806427002,0,3.7383131980895996,-1.6167044639587402,0,3.8171534538269043,-1.5948864221572876,0,3.8948278427124023,-1.5692260265350342,0,3.971149444580078,-1.539785385131836,0,4.045935153961182,-1.506635308265686,0,4.119003772735596,-1.4698556661605835,0,4.190179824829102,-1.429534912109375,0,4.259291172027588,-1.3857702016830444,0,4.424000263214111,-1.1879985332489014,0,4.326172351837158,-1.3386671543121338,0,4.390661716461182,-1.2883391380310059,0,4.452604293823242,-1.2349073886871338,0,4.511849880218506,-1.1785006523132324,0,4.568256378173828,-1.1192548274993896,0,4.664000034332275,-.9339985251426697,0,4.621687889099121,-1.0573124885559082,0,4.672016143798828,-.9928230047225952,0,4.719119071960449,-.9259418845176697,0,4.76288366317749,-.8568300008773804,0,4.809999942779541,-.6679984927177429,0,4.80320405960083,-.785653829574585,0,4.839983940124512,-.7125850319862366,0,4.873133659362793,-.6377996206283569,0,4.9025750160217285,-.5614776015281677,0,4.928235054016113,-.4838029444217682,0,4.892000198364258,-.47999852895736694,0,4.967976093292236,-.32514703273773193,0,4.950052738189697,-.40496280789375305,0],wd=[0,1,2,0,2,3,4,0,3,4,3,5,6,4,5,6,5,7,8,6,7,8,7,9,10,8,9,10,9,11,12,10,11,12,11,13,14,12,13,14,13,15,16,14,15,16,15,17,18,16,17,18,17,19,20,18,19,20,19,21,22,20,21,22,21,23,1,24,25,1,25,2,24,26,27,24,27,25,26,28,29,26,29,27,28,30,31,28,31,29,30,32,33,30,33,31,32,34,35,32,35,33,34,36,37,34,37,35,36,38,39,36,39,37,38,40,41,38,41,39,40,42,43,40,43,41,42,44,45,42,45,43,44,46,47,44,47,45,46,48,49,46,49,47,48,50,51,48,51,49,50,52,53,50,53,51,52,54,55,52,55,53,54,56,57,54,57,55,56,58,59,56,59,57,58,60,61,58,61,59,60,62,63,60,63,61,62,64,65,62,65,63,64,66,67,64,67,65,66,68,69,66,69,67,68,70,71,68,71,69,70,72,73,70,73,71,72,74,75,72,75,73,74,76,77,74,77,75,76,78,79,76,79,77,78,80,81,78,81,79,80,82,83,80,83,81,82,84,85,82,85,83,84,86,87,84,87,85,86,88,89,86,89,87,88,90,91,88,91,89,92,22,23,92,23,93,94,95,96,97,94,96,98,99,100,101,100,99,102,103,104,105,106,107,105,108,106,109,110,111,112,110,109,113,114,115,116,114,113,117,118,119,117,119,120,121,122,123,124,125,126,124,126,127,111,110,128,129,130,131,132,130,129,133,105,124,133,124,134,135,133,136,137,133,135,138,133,137,139,134,140,141,142,143,144,142,141,134,145,140,146,121,95,122,121,146,99,121,147,147,121,123,99,147,101,99,130,142,99,142,121,124,107,125,124,105,107,104,124,148,148,124,127,104,148,102,104,103,149,150,151,112,112,151,110,152,151,150,113,151,116,116,151,153,153,151,152,118,117,154,154,117,93,120,155,117,120,156,155,156,157,155,158,155,159,157,159,155,142,160,143,104,161,134,104,134,124,133,134,136,134,139,136,134,162,145,142,144,163,142,130,160,130,132,160,164,165,166,164,166,167,165,168,169,165,169,166,130,99,170,130,170,171,171,170,105,171,105,133,130,171,131,171,172,131,171,173,172,171,133,173,133,138,173,174,175,176,174,176,177,175,178,179,175,179,176,180,181,182,181,183,182,184,180,182,158,184,182,158,182,155,96,95,121,163,185,142,96,121,142,96,142,185,185,155,182,185,182,96,96,186,97,96,182,187,96,187,186,188,189,175,188,175,174,189,190,178,189,178,175,191,189,188,191,188,192,187,191,192,187,192,186,193,190,189,193,189,191,182,183,187,183,194,187,187,195,193,187,193,191,187,194,195,108,105,196,196,105,170,196,170,197,197,170,99,197,99,98,161,104,198,161,198,199,199,198,110,199,110,200,149,201,198,149,198,104,201,128,110,201,110,198,202,203,204,202,204,205,203,206,207,203,207,204,208,209,210,208,210,211,212,209,208,212,208,213,214,215,208,214,208,211,216,213,208,216,208,215,214,217,218,214,218,215,218,219,216,218,216,215,220,165,164,220,164,221,220,222,168,220,168,165,223,220,221,223,221,224,196,197,223,196,223,224,197,98,225,197,225,223,223,225,222,223,222,220,128,201,226,128,226,227,201,149,228,201,228,226,229,203,202,229,202,230,227,226,229,227,229,230,226,228,231,226,231,229,229,231,206,229,206,203,232,233,219,232,219,218,161,234,235,161,236,234,161,237,236,161,199,237,199,238,237,199,239,238,199,240,239,199,200,240,200,241,240,200,242,241,200,243,242,134,161,162,161,235,162,244,245,246,244,247,245,244,248,247,200,246,243,200,244,246,248,244,249,110,151,244,110,244,200,250,244,151,244,250,249,250,251,249,250,252,251,250,253,252,253,250,254,255,254,250,254,255,256,257,256,255,257,255,258,258,255,259,151,113,255,151,255,250,233,113,115,259,260,261,262,232,218,262,218,217,261,260,263,232,262,263,232,263,260,259,255,260,233,232,260,233,260,113,260,255,113,117,155,185,117,185,163,117,163,92,117,92,93,264,265,266,264,266,267,268,269,265,268,265,264,270,271,269,270,269,268,272,273,271,272,271,270,274,275,273,274,273,272,276,277,275,276,275,274,278,279,277,278,277,276,280,281,279,280,279,278,282,283,281,282,281,280,284,285,283,284,283,282,286,287,285,286,285,284,267,266,288,267,288,289,289,288,290,289,290,291,291,290,292,291,292,293,293,292,294,293,294,295,295,294,296,295,296,297,297,296,298,297,298,299,299,298,300,299,300,301,301,300,302,301,302,303,303,302,304,303,304,305,305,304,306,305,306,307,307,306,308,307,308,309,309,308,310,309,310,311,311,310,312,311,312,313,313,312,314,313,314,315,315,314,316,315,316,317,317,316,318,317,318,319,319,318,320,319,320,321,321,320,322,321,322,323,323,322,324,323,324,325,325,324,326,325,326,327,327,326,328,327,328,329,329,328,330,329,330,331,331,330,332,331,332,333,333,332,334,333,334,335,335,334,336,335,336,337,337,336,338,337,338,339,339,338,340,339,340,341,341,340,342,341,342,343,343,342,344,343,344,345,345,344,346,345,346,347,347,346,348,347,348,349,349,348,350,349,350,351,351,350,352,351,352,353,353,352,91,353,91,90,354,355,287,354,287,286,356,357,358,359,357,356,360,361,362,363,362,361,364,365,366,367,368,369,367,369,370,371,372,373,374,371,373,375,376,377,378,375,377,379,380,381,379,382,380,383,384,385,386,387,388,386,389,387,372,390,373,391,392,393,394,391,393,395,396,386,395,386,367,397,398,395,399,397,395,400,399,395,401,402,396,403,404,405,406,403,405,396,402,407,408,358,383,385,408,383,362,409,383,409,384,383,362,363,409,362,383,405,362,405,393,386,388,368,386,368,367,365,410,386,410,389,386,365,364,410,365,411,366,412,374,413,374,373,413,414,412,413,375,378,413,378,415,413,415,414,413,381,416,379,416,355,379,382,379,417,382,417,418,418,417,419,420,421,417,419,417,421,405,404,422,365,386,396,365,396,423,395,398,396,396,398,401,396,407,424,405,425,406,405,422,393,393,422,394,426,167,166,426,166,427,427,166,169,427,169,428,393,429,430,393,430,362,429,395,367,429,367,430,393,392,429,429,392,431,429,431,432,429,432,395,395,432,400,433,177,176,433,176,434,434,176,179,434,179,435,436,437,438,438,437,439,440,437,436,420,437,440,420,417,437,357,383,358,425,405,441,357,441,405,357,405,383,441,357,437,441,437,417,357,359,442,357,442,443,357,443,437,444,433,434,444,434,445,445,434,435,445,435,446,447,448,444,447,444,445,443,442,448,443,448,447,449,447,445,449,445,446,437,443,439,439,443,450,443,447,449,443,449,451,443,451,450,370,452,367,452,453,430,452,430,367,453,360,362,453,362,430,423,454,455,423,455,365,454,456,373,454,373,455,411,365,455,411,455,457,457,455,373,457,373,390,458,205,204,458,204,459,459,204,207,459,207,460,461,462,210,461,210,209,212,463,461,212,461,209,464,462,461,464,461,465,466,465,461,466,461,463,464,465,467,464,467,468,467,465,466,467,466,469,470,471,426,470,426,427,470,427,428,470,428,472,473,474,471,473,471,470,452,474,473,452,473,453,453,473,475,453,475,360,473,470,472,473,472,475,390,476,477,390,477,457,457,477,478,457,478,411,479,480,458,479,458,459,476,480,479,476,479,477,477,479,481,477,481,478,479,459,460,479,460,481,482,467,469,482,469,483,423,484,485,423,485,486,423,486,487,423,487,454,454,487,488,454,488,489,454,489,490,454,490,456,456,490,491,456,491,492,456,492,493,396,424,423,423,424,484,494,495,496,494,496,497,494,497,498,456,493,495,456,495,494,498,499,494,373,456,494,373,494,413,500,413,494,494,499,500,500,499,501,500,501,502,500,502,503,503,504,500,505,500,504,504,506,505,507,505,506,507,508,505,508,509,505,413,500,505,413,505,375,483,376,375,509,510,511,512,468,467,512,467,482,510,513,511,482,511,513,482,513,512,509,511,505,483,375,511,483,511,482,511,375,505,379,425,441,379,441,417,379,355,354,379,354,425],Cd=[.2870854139328003,.2500014901161194,.2746231257915497,.2500014901161194,.27328839898109436,.26355189085006714,.28486350178718567,.26497936248779297,.29973074793815613,.2500014901161194,.29635462164878845,.266973078250885,.3126256763935089,.2500014901161194,.3077339231967926,.2695280909538269,.3258417248725891,.2500014901161194,.31897422671318054,.2726384401321411,.33945783972740173,.2500014901161194,.3300483822822571,.2762964963912964,.35356107354164124,.2500014901161194,.3409295976161957,.28049343824386597,.36825016140937805,.2500014901161194,.3515917956829071,.2852191925048828,.3836381435394287,.2500014901161194,.36200928688049316,.2904623746871948,.3998561203479767,.2500014901161194,.37215688824653625,.2962104082107544,.41705819964408875,.2500014901161194,.3820101320743561,.3024492859840393,.43542778491973877,.2500014901161194,.39154547452926636,.3091641664505005,.26165735721588135,.2500014901161194,.26165735721588135,.26269400119781494,.24999810755252838,.2500014901161194,.24999810755252838,.2624077796936035,.23773127794265747,.25030261278152466,.23833885788917542,.26269400119781494,.225493922829628,.25120532512664795,.22670765221118927,.26355189085006714,.21331574022769928,.2527073621749878,.21513254940509796,.26497936248779297,.20122583210468292,.25480514764785767,.2036415934562683,.266973078250885,.1892535388469696,.25749361515045166,.19226211309432983,.2695280909538269,.17742741107940674,.26076632738113403,.18102200329303741,.2726384401321411,.16577625274658203,.26461541652679443,.16994784772396088,.2762964963912964,.1543278992176056,.2690315246582031,.15906654298305511,.28049343824386597,.14311008155345917,.2740040421485901,.1484043300151825,.2852191925048828,.13214975595474243,.27952098846435547,.13798683881759644,.2904623746871948,.12147333472967148,.28556913137435913,.12783925235271454,.2962104082107544,.11110655218362808,.2921338677406311,.11798591911792755,.3024492859840393,.10107440501451492,.29919934272766113,.10845066606998444,.3091641664505005,.09140096604824066,.30674856901168823,.09925633668899536,.3163387179374695,.08210963755846024,.3147633671760559,.09042523056268692,.323955774307251,.07322268933057785,.32322436571121216,.0819784626364708,.3319969177246094,.06476172059774399,.3321112394332886,.07393653690814972,.34044283628463745,.0567469485104084,.34140264987945557,.06631878763437271,.34927308559417725,.04919770359992981,.35107606649398804,.05914345756173134,.3584665060043335,.042132239788770676,.3611082434654236,.0524279959499836,.368000864982605,.035567548125982285,.37147510051727295,.04618839919567108,.3778531551361084,.029519449919462204,.3821514844894409,.04043986648321152,.38799983263015747,.02400251105427742,.3931118845939636,.03519614785909653,.3984162211418152,.019029948860406876,.40432971715927124,.030469926074147224,.40907740592956543,.014613897539675236,.4157780408859253,.026272615417838097,.41995757818222046,.010764789767563343,.4274292588233948,.022614195942878723,.43103063106536865,.007492152974009514,.43925535678863525,.01950356736779213,.44226980209350586,.00480363005772233,.45122772455215454,.016948195174336433,.45364809036254883,.0027057838160544634,.4633175730705261,.014954368583858013,.46513795852661133,.0012038287241011858,.4754958748817444,.013526675291359425,.47671186923980713,.00030109137878753245,.4877331852912903,.012668710201978683,.48834192752838135,-9.06169361769571e-10,.5,.012382542714476585,.5,.45518678426742554,.2500014901161194,.4007396996021271,.3163387179374695,.5364977121353149,.4367779493331909,.5480305552482605,.4314000606536865,.5117486119270325,.39199984073638916,.5260737538337708,.4440768361091614,.6289219856262207,.4530748724937439,.6392490267753601,.3912498354911804,.6199238896369934,.4440768361091614,.6095001101493835,.4367779493331909,.7803006172180176,.4367779493331909,.7907243967056274,.4440768361091614,.8057495355606079,.39199984073638916,.6827490925788879,.3904998302459717,.7072980403900146,.4367779493331909,.7188308835029602,.4314000606536865,.6968740820884705,.4440768361091614,.8780983686447144,.4367779493331909,.8544995188713074,.3942498564720154,.8676745891571045,.4440768361091614,.8896313905715942,.4314000606536865,.9636998772621155,.4201998710632324,.9511009454727173,.4367779493331909,.9615249037742615,.4440768361091614,.9395681023597717,.4314000606536865,.42864859104156494,.32809966802597046,.4180176854133606,.3319969177246094,.4260595142841339,.34044283628463745,.4336773455142975,.34927308559417725,.5729988217353821,.3721287250518799,.5729988217353821,.42699748277664185,.5856756567955017,.42810654640197754,.7437993288040161,.3721287250518799,.7311225533485413,.42810654640197754,.7437993288040161,.42699748277664185,.7564761638641357,.42810654640197754,.8586764931678772,.4530748724937439,.5841682553291321,.2500014901161194,.5857085585594177,.26089054346084595,.6025941371917725,.2500014901161194,.5657424330711365,.2500014901161194,.66460120677948,.26089054346084595,.7363375425338745,.26089054346084595,.694723904132843,.2500014901161194,.7131499648094177,.2500014901161194,.6762980222702026,.2500014901161194,.6578721404075623,.2500014901161194,.7315760254859924,.2500014901161194,.7500019073486328,.2500014901161194,.510464608669281,.2500014901161194,.5294987559318542,.26089054346084595,.5288904905319214,.2500014901161194,.4920385479927063,.2500014901161194,.7622687220573425,.25030261278152466,.5603222250938416,.42810654640197754,.597967267036438,.4314000606536865,.7687675952911377,.4314000606536865,.7997224926948547,.4530748724937439,.901922881603241,.42810654640197754,.9145996570587158,.3721287250518799,.9145996570587158,.42699748277664185,.9272764325141907,.42810654640197754,.4095709025859833,.323955774307251,.45339858531951904,.36214977502822876,.44085267186164856,.3584665060043335,.44756823778152466,.368000864982605,.45955637097358704,.38799983263015747,.45380765199661255,.3778531551361084,.5473163723945618,.2500014901161194,.787299394607544,.2635995149612427,.7745059132575989,.25120532512664795,.4736126661300659,.2500014901161194,.6719058156013489,.48732322454452515,.6584014892578125,.48732322454452515,.6584014892578125,.5,.6707967519760132,.5,.6448923349380493,.48732322454452515,.6460014581680298,.5,.6584014892578125,.39088982343673706,.6269014477729797,.26089054346084595,.6210201978683472,.2500014901161194,.6394460797309875,.2500014901161194,.5011053085327148,.48732322454452515,.4897572994232178,.4851508140563965,.49047383666038513,.5001691579818726,.4999963939189911,.5,.48732733726501465,.48834192752838135,.48761358857154846,.5,.4695262908935547,.40907740592956543,.4737236201763153,.41995757818222046,.47514861822128296,.40399986505508423,.47738203406333923,.43103063106536865,.4647999703884125,.3984162211418152,.4804961681365967,.26089054346084595,.5170756578445435,.4530748724937439,.48549866676330566,.4399999976158142,.5043988823890686,.47503161430358887,.4886016547679901,.4701516032218933,.48646944761276245,.47671186923980713,.48715847730636597,.45517098903656006,.5097768306732178,.4634987711906433,.4850417673587799,.46513795852661133,.48049256205558777,.44226980209350586,.48304784297943115,.45364809036254883,.6878759860992432,.4530748724937439,.6584014892578125,.4530748724937439,.8301494121551514,.3931248188018799,.834399402141571,.2758995294570923,.8697995543479919,.2956995964050293,.8301494121551514,.4530748724937439,.8427061438560486,.48732322454452515,.8301494121551514,.48732322454452515,.8301494121551514,.5,.8415972590446472,.5,.815692663192749,.48732322454452515,.8168017864227295,.5,.9936099052429199,.4874882698059082,.9948572516441345,.5,1,.5,.99969881772995,.4877331852912903,.9876022338867188,.5,.9864931702613831,.48732322454452515,.9987961649894714,.4754958748817444,.9923900961875916,.47525161504745483,.9831995964050293,.47503161430358887,.9972941875457764,.4633175730705261,.9912078380584717,.46339094638824463,.9778218269348145,.4634987711906433,.6584014892578125,.47503161430358887,.6751993894577026,.47503161430358887,.6415987610816956,.47503161430358887,.6584014892578125,.4634987711906433,.6805771589279175,.4634987711906433,.6362208127975464,.4634987711906433,.8301494121551514,.4634987711906433,.8513776659965515,.4634987711906433,.8070213198661804,.4634987711906433,.8301494121551514,.47503161430358887,.8459997177124023,.47503161430358887,.8123990893363953,.47503161430358887,.9888999462127686,.4513999819755554,.9705229997634888,.4530748724937439,.798774003982544,.25480514764785767,.7866840958595276,.2527073621749878,.8107464909553528,.25749361515045166,.8225724101066589,.26076632738113403,.8342235684394836,.26461541652679443,.8456718921661377,.2690315246582031,.8568897247314453,.2740040421485901,.8678500652313232,.27952098846435547,.8785266876220703,.28556913137435913,.8888932466506958,.2921338677406311,.9135997295379639,.32179969549179077,.9085988402366638,.30674856901168823,.8989254236221313,.29919934272766113,.9178903698921204,.3147633671760559,.9267773032188416,.32322436571121216,.9352381229400635,.3321112394332886,.9495997428894043,.35989975929260254,.9432529807090759,.34140264987945557,.9508020877838135,.35107606649398804,.9578675627708435,.3611082434654236,.9644324779510498,.37147510051727295,.9714997410774231,.3997998833656311,.9704805612564087,.3821514844894409,.9759975075721741,.3931118845939636,.9809699654579163,.40432971715927124,.985386073589325,.4157780408859253,.9837998151779175,.42799991369247437,.9892351031303406,.4274292588233948,.9951961636543274,.45122772455215454,.9925078749656677,.43925535678863525,.2870854139328003,.7499985098838806,.28486350178718567,.7350205779075623,.27328839898109436,.7364481091499329,.2746231257915497,.7499985098838806,.29973074793815613,.7499985098838806,.29635462164878845,.7330268621444702,.3126256763935089,.7499985098838806,.3077339231967926,.7304718494415283,.3258417248725891,.7499985098838806,.31897422671318054,.7273615598678589,.33945783972740173,.7499985098838806,.3300483822822571,.7237035036087036,.35356107354164124,.7499985098838806,.3409295976161957,.719506561756134,.36825016140937805,.7499985098838806,.3515917956829071,.7147808074951172,.3836381435394287,.7499985098838806,.36200928688049316,.7095376253128052,.3998561203479767,.7499985098838806,.37215688824653625,.7037895917892456,.41705819964408875,.7499985098838806,.3820101320743561,.6975506544113159,.43542778491973877,.7499985098838806,.39154547452926636,.6908358335494995,.26165735721588135,.7373059988021851,.26165735721588135,.7499985098838806,.24999810755252838,.7375921607017517,.24999810755252838,.7499985098838806,.23833885788917542,.7373059988021851,.23773127794265747,.7496973276138306,.22670765221118927,.7364481091499329,.225493922829628,.748794674873352,.21513254940509796,.7350205779075623,.21331574022769928,.7472926378250122,.2036415934562683,.7330268621444702,.20122583210468292,.7451947927474976,.19226211309432983,.7304718494415283,.1892535388469696,.7425063848495483,.18102200329303741,.7273615598678589,.17742741107940674,.7392336130142212,.16994784772396088,.7237035036087036,.16577625274658203,.7353845834732056,.15906654298305511,.719506561756134,.1543278992176056,.7309684753417969,.1484043300151825,.7147808074951172,.14311008155345917,.7259959578514099,.13798683881759644,.7095376253128052,.13214975595474243,.7204790115356445,.12783925235271454,.7037895917892456,.12147333472967148,.7144308686256409,.11798591911792755,.6975506544113159,.11110655218362808,.7078661322593689,.10845066606998444,.6908358335494995,.10107440501451492,.7008006572723389,.09925633668899536,.6836612224578857,.09140096604824066,.6932514309883118,.09042523056268692,.6760441660881042,.08210963755846024,.6852366924285889,.0819784626364708,.6680030822753906,.07322268933057785,.6767756342887878,.07393653690814972,.6595571637153625,.06476172059774399,.6678887009620667,.06631878763437271,.6507269144058228,.0567469485104084,.6585973501205444,.05914345756173134,.6415334939956665,.04919770359992981,.648923933506012,.0524279959499836,.631999135017395,.042132239788770676,.6388916969299316,.04618839919567108,.6221468448638916,.035567548125982285,.628524899482727,.04043986648321152,.6120001673698425,.029519449919462204,.6178484559059143,.03519614785909653,.60158371925354,.02400251105427742,.6068881154060364,.030469926074147224,.5909225940704346,.019029948860406876,.595670223236084,.026272615417838097,.5800423622131348,.014613897539675236,.5842219591140747,.022614195942878723,.5689693689346313,.010764789767563343,.5725707411766052,.01950356736779213,.5577301979064941,.007492152974009514,.5607446432113647,.016948195174336433,.5463519096374512,.00480363005772233,.5487722754478455,.014954368583858013,.5348620414733887,.0027057838160544634,.5366823673248291,.013526675291359425,.5232880711555481,.0012038287241011858,.5245041251182556,.012668710201978683,.5116580724716187,.00030109137878753245,.5122668743133545,.45518678426742554,.7499985098838806,.4007396996021271,.6836612224578857,.5364977121353149,.5632220506668091,.5117486119270325,.6080001592636108,.5480305552482605,.5685999393463135,.5260737538337708,.5559232234954834,.6289219856262207,.5469251275062561,.6199238896369934,.5559232234954834,.6392490267753601,.6087501049041748,.6095001101493835,.5632220506668091,.7803006172180176,.5632220506668091,.8057495355606079,.6080001592636108,.7907243967056274,.5559232234954834,.6827490925788879,.6095001697540283,.7188308835029602,.5685999393463135,.7072980403900146,.5632220506668091,.6968740820884705,.5559232234954834,.8780983686447144,.5632220506668091,.8676745891571045,.5559232234954834,.8544995188713074,.6057501435279846,.8896313905715942,.5685999393463135,.9636998772621155,.5798000693321228,.9615249037742615,.5559232234954834,.9511009454727173,.5632220506668091,.9395681023597717,.5685999393463135,.42864859104156494,.6719002723693848,.4260595142841339,.6595571637153625,.4180176854133606,.6680030822753906,.4336773455142975,.6507269144058228,.5729988217353821,.6278712749481201,.5856756567955017,.5718934535980225,.5729988217353821,.5730025172233582,.7437993288040161,.6278712749481201,.7437993288040161,.5730025172233582,.7311225533485413,.5718934535980225,.7564761638641357,.5718934535980225,.8586764931678772,.5469251275062561,.5841682553291321,.7499985098838806,.6025941371917725,.7499985098838806,.5857085585594177,.7391095161437988,.5657424330711365,.7499985098838806,.66460120677948,.7391095161437988,.7363375425338745,.7391095161437988,.694723904132843,.7499985098838806,.7131499648094177,.7499985098838806,.6762980222702026,.7499985098838806,.6578721404075623,.7499985098838806,.7315760254859924,.7499985098838806,.7500019073486328,.7499985098838806,.510464608669281,.7499985098838806,.5288904905319214,.7499985098838806,.5294987559318542,.7391095161437988,.4920385479927063,.7499985098838806,.7622687220573425,.7496973276138306,.5603222250938416,.5718934535980225,.597967267036438,.5685999393463135,.7687675952911377,.5685999393463135,.7997224926948547,.5469251275062561,.901922881603241,.5718934535980225,.9145996570587158,.6278712749481201,.9145996570587158,.5730025172233582,.9272764325141907,.5718934535980225,.4095709025859833,.6760441660881042,.45339858531951904,.6378502249717712,.44085267186164856,.6415334939956665,.44756823778152466,.631999135017395,.45955637097358704,.6120001673698425,.45380765199661255,.6221468448638916,.5473163723945618,.7499985098838806,.787299394607544,.7364004850387573,.7745059132575989,.748794674873352,.4736126661300659,.7499985098838806,.6719058156013489,.5126767158508301,.6584014892578125,.5126767158508301,.6448923349380493,.5126767158508301,.6269014477729797,.7391095161437988,.6584014892578125,.6091101765632629,.6210201978683472,.7499985098838806,.6394460797309875,.7499985098838806,.5011053085327148,.5126767158508301,.49049144983291626,.5151932239532471,.48732733726501465,.5116580724716187,.4695262908935547,.5909225940704346,.47514861822128296,.596000075340271,.4737236201763153,.5800423622131348,.47738203406333923,.5689693689346313,.4647999703884125,.60158371925354,.4804961681365967,.7391095161437988,.5170756578445435,.5469251275062561,.48549866676330566,.5600000619888306,.5043988823890686,.5249683260917664,.4898703992366791,.530210018157959,.48646944761276245,.5232880711555481,.48832041025161743,.545182466506958,.5097768306732178,.5365012884140015,.4850417673587799,.5348620414733887,.48049256205558777,.5577301979064941,.48304784297943115,.5463519096374512,.6878759860992432,.5469251275062561,.6584014892578125,.5469251275062561,.834399402141571,.7241004705429077,.8301494121551514,.6068751215934753,.8697995543479919,.7043004035949707,.8301494121551514,.5469251275062561,.8427061438560486,.5126767158508301,.8301494121551514,.5126767158508301,.815692663192749,.5126767158508301,.9936099052429199,.5125117301940918,.99969881772995,.5122668743133545,.9864931702613831,.5126767158508301,.9987961649894714,.5245041251182556,.9923900961875916,.5247483253479004,.9831995964050293,.5249683260917664,.9912078380584717,.5366089940071106,.9972941875457764,.5366823673248291,.9778218269348145,.5365012884140015,.6584014892578125,.5249683260917664,.6751993894577026,.5249683260917664,.6415987610816956,.5249683260917664,.6584014892578125,.5365012884140015,.6805771589279175,.5365012884140015,.6362208127975464,.5365012884140015,.8513776659965515,.5365012884140015,.8301494121551514,.5365012884140015,.8070213198661804,.5365012884140015,.8301494121551514,.5249683260917664,.8459997177124023,.5249683260917664,.8123990893363953,.5249683260917664,.9888999462127686,.5486000180244446,.9705229997634888,.5469251275062561,.7866840958595276,.7472926378250122,.798774003982544,.7451947927474976,.8107464909553528,.7425063848495483,.8225724101066589,.7392336130142212,.8342235684394836,.7353845834732056,.8456718921661377,.7309684753417969,.8568897247314453,.7259959578514099,.8678500652313232,.7204790115356445,.8785266876220703,.7144308686256409,.8888932466506958,.7078661322593689,.9135997295379639,.6782002449035645,.8989254236221313,.7008006572723389,.9085988402366638,.6932514309883118,.9178903698921204,.6852366924285889,.9267773032188416,.6767756342887878,.9352381229400635,.6678887009620667,.9495997428894043,.6401002407073975,.9432529807090759,.6585973501205444,.9508020877838135,.648923933506012,.9578675627708435,.6388916969299316,.9644324779510498,.628524899482727,.9714997410774231,.6002001166343689,.9704805612564087,.6178484559059143,.9759975075721741,.6068881154060364,.9809699654579163,.595670223236084,.985386073589325,.5842219591140747,.9892351031303406,.5725707411766052,.9837998151779175,.5720000863075256,.9951961636543274,.5487722754478455,.9925078749656677,.5607446432113647],Td=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.2433396577835083,.4214792251586914,0,.32022643089294434,.45733174681663513,0,.12999999523162842,.36799997091293335,0,.17384862899780273,.37282031774520874,0,.8595011234283447,.31283333897590637,0,.6299998760223389,.2800000309944153,0,.799515962600708,.37282031774520874,0,.7300219535827637,.4214792251586914,0,.6083533763885498,-.2107395976781845,0,.5736072063446045,-.18641014397144318,0,.45600008964538574,-.012000024318695068,0,.7720000743865967,.15700006484985352,0,.8516945838928223,-.2107395976781845,0,.8132517337799072,-.22866588830947876,0,.8864405155181885,-.18641014397144318,0,.36501169204711914,-.2107395976781845,0,.39999961853027344,-.006000041961669922,0,.39975738525390625,-.18641014397144318,0,.326568603515625,-.22866588830947876,0,.046000003814697266,-.07199999690055847,0,.12167072296142578,-.2107395976781845,0,.08692407608032227,-.18641014397144318,0,.16011333465576172,-.22866588830947876,0,0,0,0,0,0,0,0,0,0,0,0,0,.3516664505004883,.4075261354446411,0,.4866824150085449,.486682265996933,0,.5711932182312012,.47928857803344727,0,.6400001049041748,-.05200004577636719,0,.7722787857055664,-.23964427411556244,0,.7300233840942383,-.24334114789962769,0,.6877684593200684,-.23964427411556244,0,.4297513961791992,-.15641668438911438,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.40217137336730957,.47928857803344727,0,.6531369686126709,.45733174681663513,0,.6467962265014648,-.22866588830947876,0,.5436139106750488,-.15641668438911438,0,.2855968475341797,-.23964427411556244,0,.19000005722045898,-.14399999380111694,0,.24334096908569336,-.24334114789962769,0,.20108556747436523,-.23964427411556244,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.9696683883666992,-.04225574806332588,0,.9723927974700928,.011487752199172974,0,.9723927974700928,0,0,.973365068435669,0,0,.965970516204834,.08451149612665176,0,.9733645915985107,0,0,.7223169803619385,.23760002851486206,0,0,0,0,0,0,0,0,0,0,.00739288330078125,.08451149612665176,0,.0010020732879638672,.00047581642866134644,0,-.0004520416259765625,.0004030172131024301,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.11386048793792725,.31283333897590637,0,0,0,0,.029349684715270996,.16645514965057373,0,.0016508102416992188,.0004993528127670288,0,0,0,0,.0013196468353271484,.0004146695137023926,0,.06520307064056396,.24334114789962769,0,0,0,0,0,0,0,0,0,0,.9164340496063232,-.15641668438911438,0,.9723927974700928,.03316590189933777,0,.4239997863769531,-.012000024318695068,0,0,0,0,0,0,0,.4719996452331543,-.12999999523162842,0,.4829854965209961,-.04225574806332588,0,.4719996452331543,-.03999999910593033,0,.4719996452331543,0,0,.4866821765899658,0,0,.49037981033325195,-.04225574806332588,0,.4866824150085449,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.003696441650390625,-.04225574806332588,0,0,0,0,0,0,0,.014675140380859375,-.08322757482528687,0,0,0,0,0,0,0,.032601356506347656,-.12167057394981384,0,.9723927974700928,.007544100284576416,0,.9586899280548096,-.08322757482528687,0,.9440135955810547,.16645514965057373,0,.9723927974700928,.004658102989196777,0,.9407634735107422,-.12167057394981384,0,.9081616401672363,.24334114789962769,0,.4719996452331543,-.1120000034570694,0,.45408058166503906,-.12167057394981384,0,.5192840099334717,-.12167057394981384,0,.4719996452331543,-.07800000160932541,0,.47200751304626465,-.08322757482528687,0,.5013580322265625,-.08322757482528687,0,0,0,0,.0569310188293457,-.15641668438911438,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.2433396577835083,-.42147916555404663,0,.12999999523162842,-.3680000305175781,0,.32022643089294434,-.4573318064212799,0,.17384862899780273,-.37282025814056396,0,.8595011234283447,-.31283339858055115,0,.799515962600708,-.37282025814056396,0,.6299998760223389,-.2799999713897705,0,.7300219535827637,-.42147916555404663,0,.6083533763885498,.2107395976781845,0,.45600008964538574,.012000024318695068,0,.5736072063446045,.18641014397144318,0,.7720000743865967,-.15700006484985352,0,.8132517337799072,.22866588830947876,0,.8516945838928223,.2107395976781845,0,.8864405155181885,.18641014397144318,0,.36501169204711914,.2107395976781845,0,.39975738525390625,.18641014397144318,0,.39999961853027344,.006000041961669922,0,.326568603515625,.22866588830947876,0,.046000003814697266,.07199999690055847,0,.08692407608032227,.18641014397144318,0,.12167072296142578,.2107395976781845,0,.16011333465576172,.22866588830947876,0,0,0,0,0,0,0,0,0,0,0,0,0,.3516664505004883,-.4075261354446411,0,.5711932182312012,-.4792885184288025,0,.4866824150085449,-.48668232560157776,0,.6400001049041748,.05200004577636719,0,.7300233840942383,.24334114789962769,0,.7722787857055664,.23964427411556244,0,.6877684593200684,.23964427411556244,0,.4297513961791992,.15641668438911438,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.40217137336730957,-.4792885184288025,0,.6531369686126709,-.4573318064212799,0,.6467962265014648,.22866588830947876,0,.5436139106750488,.15641668438911438,0,.2855968475341797,.23964427411556244,0,.19000005722045898,.14399999380111694,0,.24334096908569336,.24334114789962769,0,.20108556747436523,.23964427411556244,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.9696683883666992,.04225574806332588,0,.9723927974700928,-.011487752199172974,0,.965970516204834,-.08451149612665176,0,0,0,0,.7223169803619385,-.23760002851486206,0,0,0,0,0,0,0,.00739288330078125,-.08451149612665176,0,-.001673579216003418,.00034965574741363525,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.11386048793792725,-.31283339858055115,0,0,0,0,.029349684715270996,-.16645514965057373,0,-.002778291702270508,.0003414154052734375,0,0,0,0,-.0028470754623413086,.00036212801933288574,0,.06520307064056396,-.24334114789962769,0,0,0,0,0,0,0,0,0,0,.9164340496063232,.15641668438911438,0,.9723927974700928,-.03316590189933777,0,0,0,0,.4239997863769531,.012000024318695068,0,0,0,0,.4719996452331543,.12999999523162842,0,.4829854965209961,.04225574806332588,0,.4719996452331543,.03999999910593033,0,.49037981033325195,.04225574806332588,0,0,0,0,0,0,0,.003696441650390625,.04225574806332588,0,0,0,0,0,0,0,.014675140380859375,.08322757482528687,0,0,0,0,0,0,0,.032601356506347656,.12167057394981384,0,.9723927974700928,-.007544100284576416,0,.9586899280548096,.08322757482528687,0,.9440135955810547,-.16645514965057373,0,.9723927974700928,-.004658102989196777,0,.9407634735107422,.12167057394981384,0,.9081616401672363,-.24334114789962769,0,.45408058166503906,.12167057394981384,0,.4719996452331543,.1120000034570694,0,.5192840099334717,.12167057394981384,0,.4719996452331543,.07800000160932541,0,.47200751304626465,.08322757482528687,0,.5013580322265625,.08322757482528687,0,0,0,0,.0569310188293457,.15641668438911438,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-.002700507640838623,-.01803898811340332,0,-.0008068978786468506,-.008025407791137695,0,0,0,0,0,0,0,-.006403118371963501,-.032024264335632324,0,0,0,0,-.012553006410598755,-.049947381019592285,0,0,0,0,-.021820425987243652,-.07176542282104492,0,0,0,0,.02750498056411743,-.11568272113800049,0,0,0,0,.07358193397521973,-.1596001386642456,0,0,0,0,.11575323343276978,-.20351731777191162,0,0,0,0,.15326547622680664,-.2474346160888672,0,0,0,0,.18524479866027832,-.2913520336151123,0,0,0,0,.2106635570526123,-.3352692127227783,0,0,0,0,.22829794883728027,-.3791865110397339,0,0,0,0,.004050545394420624,-.002007603645324707,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.23667120933532715,-.42310380935668945,0,0,0,0,2.6377081871032715,-.3597858250141144,0,2.5720760822296143,-.39039045572280884,0,2.760000228881836,-.6209999918937683,0,2.6970279216766357,-.31824934482574463,0,2.111737012863159,-.26704302430152893,0,2.056161642074585,-.6198743581771851,0,2.1629436016082764,-.31824934482574463,0,2.222263813018799,-.3597858250141144,0,1.2502696514129639,-.3597858250141144,0,1.1909492015838623,-.31824934482574463,0,1.1071116924285889,-.6155993938446045,0,1.8082115650177002,-.6241493821144104,0,1.6657137870788574,-.3597858250141144,0,1.6000819206237793,-.39039045572280884,0,1.7250337600708008,-.31824934482574463,0,.6937189102172852,-.3597858250141144,0,.8292365074157715,-.6027743816375732,0,.7530393600463867,-.31824934482574463,0,.628087043762207,-.39039045572280884,0,.20599985122680664,-.4505000114440918,0,.2782745361328125,-.3597858250141144,0,.21895456314086914,-.31824934482574463,0,.3439064025878906,-.39039045572280884,0,.0690000057220459,.029000043869018555,0,0,0,0,0,0,0,0,0,0,2.4126665592193604,-.7304738163948059,0,2.429985761642456,-.41544485092163086,0,2.357844829559326,-.40913331508636475,0,1.4602265357971191,-.7288644909858704,0,1.5301322937011719,-.40913331508636475,0,1.457991600036621,-.41544485092163086,0,1.385850429534912,-.40913331508636475,0,.8042459487915039,-.26704302430152893,0,.3574862480163574,-.7305248379707336,0,.23393583297729492,-.7560599446296692,0,.37474584579467773,-.774442195892334,0,.3402271270751953,-.6866075992584229,0,.48398590087890625,-.9480599164962769,0,.6337449550628662,-1.1200599670410156,0,.4610424041748047,-.9940286874771118,0,.4783012866973877,-1.0379459857940674,0,.4437828063964844,-.9501113295555115,0,.42652344703674316,-.9061939716339111,0,.495560884475708,-1.081863284111023,0,.5128202438354492,-1.125780463218689,0,.28844916820526123,-.5548557043075562,0,.07066631317138672,-.6180599331855774,0,.3057084083557129,-.5987730026245117,0,.27118992805480957,-.5109384059906006,0,.5711400508880615,-1.1676902770996094,0,2.502126932144165,-.40913331508636475,0,2.287895441055298,-.39039045572280884,0,1.3159008026123047,-.39039045572280884,0,1.1397428512573242,-.26704302430152893,0,.558138370513916,-.40913331508636475,0,.4866666793823242,-.7288644909858704,0,.48599720001220703,-.41544485092163086,0,.41385650634765625,-.40913331508636475,0,0,0,0,.1237567663192749,.03842973709106445,0,0,0,0,0,0,0,0,0,0,0,0,0,.3229677677154541,-.6426904201507568,0,1.0239999294281006,-1.3160001039505005,0,.6296570301055908,-1.205589771270752,0,.25393056869506836,-.467021107673645,0,1.867124080657959,-.07214176654815674,0,1.9469926357269287,-.07225733250379562,0,1.9469926357269287,0,0,1.8734357357025146,0,0,2.020853042602539,-.07214176654815674,0,2.0145413875579834,0,0,1.9469926357269287,-.6219263672828674,0,.3273169994354248,-.8340598940849304,0,.39200496673583984,-.8183594942092896,0,.40926432609558105,-.8622767329216003,0,2.8391189575195312,-.07214176654815674,0,.16590666770935059,-.0008331388235092163,0,.16807377338409424,-.00031630927696824074,0,2.8454298973083496,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.14129769802093506,.05462402105331421,0,0,0,0,0,0,0,.22135019302368164,-.6860598921775818,0,2.748234272003174,-.26704302430152893,0,.14499998092651367,-.005000025033950806,0,2.820375919342041,-.14209091663360596,0,.16088545322418213,-.0017549842596054077,0,0,0,0,.15377235412597656,-.0031194090843200684,0,2.78977108001709,-.2077227234840393,0,0,0,0,0,0,0,0,0,0,1.776240587234497,-.26704302430152893,0,1.9469926357269287,-.2674725353717804,0,.9680314064025879,-.6091868281364441,0,.9120001792907715,-1.2960000038146973,0,.7109999656677246,-1.1700000762939453,0,.9680314064025879,-.2674725353717804,0,.8951301574707031,-.07214176654815674,0,.9680314064025879,-.07225733250379562,0,.9680314064025879,0,0,.9014418125152588,0,0,1.0488591194152832,-.07214176654815674,0,1.0425472259521484,0,0,.03545188903808594,-.07139543443918228,0,.02852153778076172,0,0,0,0,0,.0017132759094238281,-.06980903446674347,0,.07055330276489258,0,0,.07686424255371094,-.07214176654815674,0,.006850242614746094,-.13944925367832184,0,.041800498962402344,-.14021176099777222,0,.09560728073120117,-.14209091663360596,0,.013350963592529297,-.1969558447599411,0,.04669809341430664,-.20252151787281036,0,.12621164321899414,-.2077227234840393,0,1.9469926357269287,-.14231915771961212,0,1.848381519317627,-.14209091663360596,0,2.03959584236145,-.14209091663360596,0,1.9469926357269287,-.20805668830871582,0,1.817777156829834,-.2077227234840393,0,2.0702009201049805,-.2077227234840393,0,.9680314064025879,-.20805668830871582,0,.8457822799682617,-.2077227234840393,0,1.0982062816619873,-.2077227234840393,0,.9680314064025879,-.14231915771961212,0,.876387357711792,-.14209091663360596,0,1.0676021575927734,-.14209091663360596,0,.05819988250732422,-.2691999673843384,0,.16774845123291016,-.26704302430152893,0,.7480673789978027,-1.269425392150879,0,.6885676383972168,-1.239493489265442,0,.8083505630493164,-1.2954195737838745,0,.8696088790893555,-1.3175188302993774,0,.9320330619812012,-1.3357757329940796,0,.8670811653137207,-1.310091257095337,0,.8034672737121582,-1.2812505960464478,0,.7413449287414551,-1.2493231296539307,0,.6808643341064453,-1.2143861055374146,0,.6221709251403809,-1.176523208618164,0,.47536325454711914,-1.0132554769515991,0,.510706901550293,-1.0923930406570435,0,.565406322479248,-1.1358263492584229,0,.4582037925720215,-1.0463279485702515,0,.40802526473999023,-.9977423548698425,0,.36029052734375,-.9467530250549316,0,.2749471664428711,-.7988166213035583,0,.31511545181274414,-.8934828639030457,0,.27260875701904297,-.838060200214386,0,.23287248611450195,-.7806186676025391,0,.19600248336791992,-.7212965488433838,0,.15513134002685547,-.5647777318954468,0,.16208791732788086,-.660236656665802,0,.1312098503112793,-.5975862145423889,0,.10344409942626953,-.5334962010383606,0,.07885503768920898,-.4681209623813629,0,.08411550521850586,-.40413886308670044,0,.05750417709350586,-.4016179144382477,0,.02471303939819336,-.26587188243865967,0,.03944253921508789,-.3341474235057831,0,-.002700507640838623,.01803898811340332,0,0,0,0,0,0,0,-.0008068978786468506,.008025407791137695,0,-.006403118371963501,.032024264335632324,0,0,0,0,-.012553006410598755,.049947381019592285,0,0,0,0,-.021820425987243652,.07176554203033447,0,0,0,0,.02750498056411743,.11568272113800049,0,0,0,0,.07358193397521973,.1596001386642456,0,0,0,0,.11575323343276978,.20351731777191162,0,0,0,0,.15326547622680664,.2474346160888672,0,0,0,0,.18524479866027832,.29135191440582275,0,0,0,0,.2106635570526123,.3352692127227783,0,0,0,0,.22829794883728027,.3791865110397339,0,0,0,0,0,0,0,.004050545394420624,.002007603645324707,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.23667120933532715,.42310380935668945,0,0,0,0,2.6377081871032715,.3597858250141144,0,2.760000228881836,.6209999918937683,0,2.5720760822296143,.39039045572280884,0,2.6970279216766357,.31824934482574463,0,2.111737012863159,.26704302430152893,0,2.1629436016082764,.31824934482574463,0,2.056161642074585,.6198743581771851,0,2.222263813018799,.3597858250141144,0,1.2502696514129639,.3597858250141144,0,1.1071116924285889,.6155993938446045,0,1.1909492015838623,.31824934482574463,0,1.8082115650177002,.6241493821144104,0,1.6000819206237793,.39039045572280884,0,1.6657137870788574,.3597858250141144,0,1.7250337600708008,.31824934482574463,0,.6937189102172852,.3597858250141144,0,.7530393600463867,.31824934482574463,0,.8292365074157715,.6027743816375732,0,.628087043762207,.39039045572280884,0,.20599985122680664,.4505000114440918,0,.21895456314086914,.31824934482574463,0,.2782745361328125,.3597858250141144,0,.3439064025878906,.39039045572280884,0,.0690000057220459,-.029000043869018555,0,0,0,0,0,0,0,0,0,0,2.4126665592193604,.7304738163948059,0,2.357844829559326,.40913331508636475,0,2.429985761642456,.41544485092163086,0,1.4602265357971191,.7288644909858704,0,1.457991600036621,.41544485092163086,0,1.5301322937011719,.40913331508636475,0,1.385850429534912,.40913331508636475,0,.8042459487915039,.26704302430152893,0,.3574862480163574,.7305248379707336,0,.37474584579467773,.774442195892334,0,.23393583297729492,.7560599446296692,0,.3402271270751953,.6866075992584229,0,.48398590087890625,.9480599164962769,0,.6337449550628662,1.1200599670410156,0,.4610424041748047,.9940286874771118,0,.4783012866973877,1.0379459857940674,0,.4437828063964844,.9501113295555115,0,.42652344703674316,.9061939716339111,0,.495560884475708,1.081863284111023,0,.5128202438354492,1.125780463218689,0,.28844916820526123,.5548557043075562,0,.3057084083557129,.5987730026245117,0,.07066631317138672,.6180599331855774,0,.27118992805480957,.5109385251998901,0,.5711400508880615,1.1676902770996094,0,2.502126932144165,.40913331508636475,0,2.287895441055298,.39039045572280884,0,1.3159008026123047,.39039045572280884,0,1.1397428512573242,.26704302430152893,0,.558138370513916,.40913331508636475,0,.4866666793823242,.7288644909858704,0,.48599720001220703,.41544485092163086,0,.41385650634765625,.40913331508636475,0,0,0,0,.12431418895721436,-.03773856163024902,0,0,0,0,0,0,0,0,0,0,0,0,0,.3229677677154541,.6426903009414673,0,1.0239999294281006,1.3160001039505005,0,.6296570301055908,1.205589771270752,0,.25393056869506836,.467021107673645,0,1.867124080657959,.07214176654815674,0,1.9469926357269287,.07225733250379562,0,2.020853042602539,.07214176654815674,0,.3273169994354248,.8340598940849304,0,1.9469926357269287,.6219263672828674,0,.39200496673583984,.8183594942092896,0,.40926432609558105,.8622767329216003,0,2.8391189575195312,.07214176654815674,0,.16686654090881348,4729628562927246e-20,0,0,0,0,0,0,0,.14165890216827393,-.05382949113845825,0,0,0,0,0,0,0,0,0,0,.22135019302368164,.6860598921775818,0,2.748234272003174,.26704302430152893,0,.14499998092651367,.005000025033950806,0,2.820375919342041,.14209091663360596,0,.16255652904510498,.0006660819053649902,0,0,0,0,.1547764539718628,.002169191837310791,0,2.78977108001709,.2077227234840393,0,0,0,0,0,0,0,0,0,0,1.776240587234497,.26704302430152893,0,1.9469926357269287,.2674725353717804,0,.9120001792907715,1.2960000038146973,0,.9680314064025879,.6091868281364441,0,.7109999656677246,1.1700000762939453,0,.9680314064025879,.2674725353717804,0,.8951301574707031,.07214176654815674,0,.9680314064025879,.07225733250379562,0,1.0488591194152832,.07214176654815674,0,.03545188903808594,.07139543443918228,0,.0017132759094238281,.06980903446674347,0,.07686424255371094,.07214176654815674,0,.006850242614746094,.13944925367832184,0,.041800498962402344,.14021176099777222,0,.09560728073120117,.14209091663360596,0,.04669809341430664,.20252151787281036,0,.013350963592529297,.1969558447599411,0,.12621164321899414,.2077227234840393,0,1.9469926357269287,.14231915771961212,0,1.848381519317627,.14209091663360596,0,2.03959584236145,.14209091663360596,0,1.9469926357269287,.20805668830871582,0,1.817777156829834,.2077227234840393,0,2.0702009201049805,.2077227234840393,0,.8457822799682617,.2077227234840393,0,.9680314064025879,.20805668830871582,0,1.0982062816619873,.2077227234840393,0,.9680314064025879,.14231915771961212,0,.876387357711792,.14209091663360596,0,1.0676021575927734,.14209091663360596,0,.05819988250732422,.2691999673843384,0,.16774845123291016,.26704302430152893,0,.6885676383972168,1.239493489265442,0,.7480673789978027,1.269425392150879,0,.8083505630493164,1.2954195737838745,0,.8696088790893555,1.3175188302993774,0,.9320330619812012,1.3357757329940796,0,.8670811653137207,1.310091257095337,0,.8034672737121582,1.2812505960464478,0,.7413449287414551,1.2493231296539307,0,.6808643341064453,1.2143861055374146,0,.6221709251403809,1.176523208618164,0,.47536325454711914,1.0132554769515991,0,.565406322479248,1.1358263492584229,0,.510706901550293,1.0923930406570435,0,.4582037925720215,1.0463279485702515,0,.40802526473999023,.9977423548698425,0,.36029052734375,.9467530250549316,0,.2749471664428711,.7988166213035583,0,.31511545181274414,.8934828639030457,0,.27260875701904297,.838060200214386,0,.23287248611450195,.7806186676025391,0,.19600248336791992,.7212965488433838,0,.15513134002685547,.5647777318954468,0,.16208791732788086,.660236656665802,0,.1312098503112793,.5975862145423889,0,.10344409942626953,.5334962010383606,0,.07885503768920898,.4681209623813629,0,.05750417709350586,.4016179144382477,0,.08411550521850586,.40413886308670044,0,.02471303939819336,.26587188243865967,0,.03944253921508789,.3341474235057831,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.12167060375213623,-.2107395976781845,0,-.16011357307434082,-.22866588830947876,0,0,0,0,-.08692443370819092,-.18641014397144318,0,-.4297513961791992,-.15641668438911438,0,-.21499991416931152,.07500004768371582,0,-.39975786209106445,-.18641014397144318,0,-.36501169204711914,-.2107395976781845,0,.24334001541137695,.4214792251586914,0,.3128337860107422,.37282031774520874,0,.12299966812133789,.30800002813339233,0,-.16899991035461426,.25199997425079346,0,-.24334239959716797,.4214792251586914,0,-.16645574569702148,.45733174681663513,0,-.312833309173584,.37282031774520874,0,.36501169204711914,-.2107395976781845,0,.24499988555908203,.0849999189376831,0,.39975738525390625,-.18641014397144318,0,.326568603515625,-.22866588830947876,0,0,0,0,.12167072296142578,-.2107395976781845,0,.08692407608032227,-.18641014397144318,0,.16011333465576172,-.22866588830947876,0,0,0,0,0,0,0,0,0,0,0,0,0,-.17333340644836426,.017526209354400635,0,-.24334120750427246,-.24334114789962769,0,-.2855968475341797,-.23964427411556244,0,0,.3400000333786011,0,-.08451128005981445,.47928857803344727,0,0,.486682265996933,0,.08451128005981445,.47928857803344727,0,.4297513961791992,-.15641668438911438,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.20108556747436523,-.23964427411556244,0,-.3265688419342041,-.22866588830947876,0,.16645479202270508,.45733174681663513,0,.3728194236755371,.31283333897590637,0,.2855968475341797,-.23964427411556244,0,0,0,0,.24334096908569336,-.24334114789962769,0,.20108556747436523,-.23964427411556244,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.47928929328918457,.08451149612665176,0,-.5,-.019860200583934784,0,-.5,0,0,-.4866819381713867,0,0,-.4829854965209961,-.04225574806332588,0,-.4866824150085449,0,0,-.1446828842163086,.22860002517700195,0,0,0,0,0,0,0,0,0,0,-.0036967992782592773,-.04225574806332588,0,.0009113550186157227,.0004747062921524048,0,-.0005533695220947266,.0004042122745886445,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.0569310188293457,-.15641668438911438,0,0,0,0,-.014675259590148926,-.08322757482528687,0,.0015821456909179688,.0004971474409103394,0,0,0,0,.0012818574905395508,.00041282176971435547,0,-.03260147571563721,-.12167057394981384,0,0,0,0,0,0,0,0,0,0,-.372821569442749,.31283333897590637,0,-.5,-.07351583242416382,0,.16233301162719727,.24150002002716064,0,0,0,0,0,0,0,.49500036239624023,-.05474585294723511,0,.4829854965209961,-.04225574806332588,0,.49500036239624023,-.014789514243602753,0,.49500036239624023,0,0,.4866821765899658,0,0,.47928857803344727,.08451149612665176,0,.4866824150085449,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.003696441650390625,-.04225574806332588,0,0,0,0,0,0,0,.014675140380859375,-.08322757482528687,0,0,0,0,0,0,0,.032601356506347656,-.12167057394981384,0,-.5,-.03911694884300232,0,-.4573323726654053,.16645514965057373,0,-.47200703620910645,-.08322757482528687,0,-.5,-.05718517303466797,0,-.4214789867401123,.24334114789962769,0,-.45408082008361816,-.12167057394981384,0,.49500036239624023,-.042584702372550964,0,.45408058166503906,-.12167057394981384,0,.4214799404144287,.24334114789962769,0,.49500036239624023,-.02912965416908264,0,.47200751304626465,-.08322757482528687,0,.45733165740966797,.16645514965057373,0,0,0,0,.0569310188293457,-.15641668438911438,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.12167060375213623,.2107395976781845,0,0,0,0,-.16011357307434082,.22866588830947876,0,-.08692443370819092,.18641014397144318,0,-.4297513961791992,.15641668438911438,0,-.39975786209106445,.18641014397144318,0,-.21499991416931152,-.07500004768371582,0,-.36501169204711914,.2107395976781845,0,.24334001541137695,-.42147916555404663,0,.12299966812133789,-.30799996852874756,0,.3128337860107422,-.37282025814056396,0,-.16899991035461426,-.25200003385543823,0,-.16645574569702148,-.4573318064212799,0,-.24334239959716797,-.42147916555404663,0,-.312833309173584,-.37282025814056396,0,.36501169204711914,.2107395976781845,0,.39975738525390625,.18641014397144318,0,.24499988555908203,-.0849999189376831,0,.326568603515625,.22866588830947876,0,0,0,0,.08692407608032227,.18641014397144318,0,.12167072296142578,.2107395976781845,0,.16011333465576172,.22866588830947876,0,0,0,0,0,0,0,0,0,0,0,0,0,-.17333340644836426,-.017526209354400635,0,-.2855968475341797,.23964427411556244,0,-.24334120750427246,.24334114789962769,0,0,-.3399999141693115,0,0,-.48668232560157776,0,-.08451128005981445,-.4792885184288025,0,.08451128005981445,-.4792885184288025,0,.4297513961791992,.15641668438911438,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.20108556747436523,.23964427411556244,0,-.3265688419342041,.22866588830947876,0,.16645479202270508,-.4573318064212799,0,.3728194236755371,-.31283339858055115,0,.2855968475341797,.23964427411556244,0,0,0,0,.24334096908569336,.24334114789962769,0,.20108556747436523,.23964427411556244,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.47928929328918457,-.08451149612665176,0,-.5,.019860200583934784,0,-.4829854965209961,.04225574806332588,0,0,0,0,-.1446828842163086,-.22860002517700195,0,0,0,0,0,0,0,-.0036967992782592773,.04225574806332588,0,-.0017715692520141602,.0003534853458404541,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.0569310188293457,.15641668438911438,0,0,0,0,-.014675259590148926,.08322757482528687,0,-.002859354019165039,.0003470778465270996,0,0,0,0,-.0028954744338989258,.00036713480949401855,0,-.03260147571563721,.12167057394981384,0,0,0,0,0,0,0,0,0,0,-.372821569442749,-.31283339858055115,0,-.5,.07351583242416382,0,0,0,0,.16233301162719727,-.24150002002716064,0,0,0,0,.49500036239624023,.05474585294723511,0,.4829854965209961,.04225574806332588,0,.49500036239624023,.014789514243602753,0,.47928857803344727,-.08451149612665176,0,0,0,0,0,0,0,.003696441650390625,.04225574806332588,0,0,0,0,0,0,0,.014675140380859375,.08322757482528687,0,0,0,0,0,0,0,.032601356506347656,.12167057394981384,0,-.5,.03911694884300232,0,-.4573323726654053,-.16645514965057373,0,-.47200703620910645,.08322757482528687,0,-.5,.05718517303466797,0,-.4214789867401123,-.24334114789962769,0,-.45408082008361816,.12167057394981384,0,.45408058166503906,.12167057394981384,0,.49500036239624023,.042584702372550964,0,.4214799404144287,-.24334114789962769,0,.49500036239624023,.02912965416908264,0,.47200751304626465,.08322757482528687,0,.45733165740966797,-.16645514965057373,0,0,0,0,.0569310188293457,.15641668438911438,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[.386249840259552,-.5111169815063477,0,.40879666805267334,-.5551019906997681,0,-.10822245478630066,-1.0986930131912231,0,-.16200768947601318,-1.092059850692749,0,.36248308420181274,-.4671320915222168,0,-.21540266275405884,-1.0827958583831787,0,.3370523750782013,-.42314696311950684,0,-.26827874779701233,-1.0709233283996582,0,.30947983264923096,-.379162073135376,0,-.3205084204673767,-1.0564707517623901,0,.2792414426803589,-.33517706394195557,0,-.37196603417396545,-1.0394731760025024,0,.24575459957122803,-.2911919355392456,0,-.422527551651001,-1.019971251487732,0,.20836210250854492,-.24720704555511475,0,-.47207111120224,-.998012363910675,0,.16631078720092773,-.20322203636169434,0,-.5204774141311646,-.9736491441726685,0,.11872625350952148,-.15923690795898438,0,-.5676298141479492,-.9469401240348816,0,.06458115577697754,-.11525201797485352,0,-.6134148836135864,-.917949914932251,0,.002651691436767578,-.0712670087814331,0,-.6577221155166626,-.8867483735084534,0,.4347008466720581,-.5990869998931885,0,-.05417648330330849,-1.1026790142059326,0,.4518941044807434,-.6430720090866089,0,0,-1.1040090322494507,0,.47313788533210754,-.6850494742393494,0,.05417648330330849,-1.1026790142059326,0,.49418461322784424,-.723016619682312,0,.10822245478630066,-1.0986930131912231,0,.5148378610610962,-.7569880485534668,0,.16200768947601318,-1.092059850692749,0,.5349019765853882,-.7869877815246582,0,.21540266275405884,-1.0827958583831787,0,.554182767868042,-.8130496144294739,0,.26827874779701233,-1.0709233283996582,0,.5724878907203674,-.8352165818214417,0,.3205084204673767,-1.0564707517623901,0,.5896275639533997,-.8535411953926086,0,.37196603417396545,-1.0394731760025024,0,.6054145693778992,-.8680855631828308,0,.422527551651001,-1.019971251487732,0,.6196650862693787,-.8789206147193909,0,.47207111120224,-.998012363910675,0,.6321989297866821,-.8861258625984192,0,.5204774141311646,-.9736491441726685,0,.6428400278091431,-.8897900581359863,0,.5676298141479492,-.9469401240348816,0,.6514168977737427,-.890010416507721,0,.6134148836135864,-.917949914932251,0,.6577632427215576,-.8868923187255859,0,.6577221155166626,-.8867483735084534,0,.7004885673522949,-.8535491228103638,0,.7004446983337402,-.8534104824066162,0,.7415264248847961,-.8181495666503906,0,.7414801120758057,-.818016767501831,0,.7807778120040894,-.7807790637016296,0,.7807291150093079,-.7806522846221924,0,.8181482553482056,-.7415276765823364,0,.8180971145629883,-.7414071559906006,0,.8535478115081787,-.7004896402359009,0,.8534945249557495,-.7003759741783142,0,.8868910074234009,-.6577642560005188,0,.8868356347084045,-.6576573252677917,0,.9180976152420044,-.6134541630744934,0,.9180402159690857,-.6133545637130737,0,.9470924735069275,-.5676663517951965,0,.9470332264900208,-.567574143409729,0,.9738056659698486,-.5205107927322388,0,.9737448692321777,-.5204262137413025,0,.9981728792190552,-.4721013307571411,0,.9981105327606201,-.4720246493816376,0,1.0201354026794434,-.422554612159729,0,1.0200716257095337,-.42248597741127014,0,1.0396403074264526,-.3719898760318756,0,1.039575457572937,-.37192943692207336,0,1.0566407442092896,-.32052895426750183,0,1.0565747022628784,-.3204768896102905,0,1.071095585823059,-.26829588413238525,0,1.0710285902023315,-.26825234293937683,0,1.0829699039459229,-.21541647613048553,0,1.0829023122787476,-.21538150310516357,0,1.0922353267669678,-.1620180904865265,0,1.0921671390533447,-.16199177503585815,0,1.0988696813583374,-.1082293912768364,0,1.0988010168075562,-.10821183770895004,0,1.1028565168380737,-.05417997017502785,0,1.1027876138687134,-.05417116731405258,0,1.1041866540908813,2.4079236027318984e-7,0,1.104117512702942,2.4079236027318984e-7,0,-.06853866577148438,-.027281999588012695,0,-.7004446983337402,-.8534104824066162,0,-.9986465573310852,.13621646165847778,0,-.9737987518310547,.14780351519584656,0,-.9955851435661316,-.13240021467208862,0,-1.021105408668518,.12049058079719543,0,-.7995140552520752,.10110360383987427,0,-.8490850925445557,.06124985218048096,0,-.8189002275466919,.12049058079719543,0,-.8413589000701904,.13621646165847778,0,-.4733562469482422,.13621646165847778,0,-.4508974552154541,.12049058079719543,0,-.4267849922180176,.23759979009628296,0,-.6973850727081299,.24089974164962769,0,-.6306471824645996,.13621646165847778,0,-.6057994365692139,.14780351519584656,0,-.6531062126159668,.12049058079719543,0,-.26264524459838867,.13621646165847778,0,-.3195347785949707,.2326498031616211,0,-.28510379791259766,.12049058079719543,0,-.23779773712158203,.14780351519584656,0,-.07929515838623047,.17555975914001465,0,-.10535764694213867,.13621646165847778,0,-.08289575576782227,.12049058079719543,0,-.13020563125610352,.14780351519584656,0,-.7589999437332153,-.7080000042915344,0,-.7807291150093079,-.7806522846221924,0,-.8180971145629883,-.7414071559906006,0,-.8534945249557495,-.7003759741783142,0,-.9388351440429688,.08931612968444824,0,-.920002818107605,.15728923678398132,0,-.8926913738250732,.15489965677261353,0,-.563075065612793,.2813161611557007,0,-.5793156623840332,.15489965677261353,0,-.5520005226135254,.15728923678398132,0,-.5246889591217041,.15489965677261353,0,-.304490327835083,.10110360383987427,0,-.3759993314743042,.3269284963607788,0,-.31806397438049316,.11594021320343018,0,-.3998821973800659,.3707926273345947,0,-.34984421730041504,.278261661529541,0,-.24901437759399414,.2359400987625122,0,-.41225504875183105,.24094009399414062,0,-.4937293529510498,.5147931575775146,0,-.5091409683227539,.5280430316925049,0,-.4775388240814209,.49628782272338867,0,-.4603116512298584,.47257184982299805,0,-.5240316390991211,.536005973815918,0,-.538661003112793,.5386624336242676,0,-.25545215606689453,.10467302799224854,0,-.2383335828781128,-.01905989646911621,0,-.2897942066192627,.1669996976852417,0,-.1931476593017578,.060688018798828125,0,-.512230396270752,.5380135774612427,0,-.9473142623901367,.15489965677261353,0,-.8662068843841553,.14780351519584656,0,-.49820756912231445,.14780351519584656,0,-.43151116371154785,.10110360383987427,0,-.21131277084350586,.15489965677261353,0,-.1873149871826172,.2813161611557007,0,-.18400096893310547,.15728923678398132,0,-.15668964385986328,.15489965677261353,0,-.7414801120758057,-.818016767501831,0,-.843999981880188,-.5509999394416809,0,-.8868356347084045,-.6576573252677917,0,-.9180402159690857,-.6133545637130737,0,-.9737448692321777,-.5204262137413025,0,-.9470332264900208,-.567574143409729,0,-.32118499279022217,.22490918636322021,0,-.2969999313354492,.21399986743927002,0,-.48586320877075195,.5360684394836426,0,-.1308431625366211,.016703128814697266,0,-.706902027130127,.02731318026781082,0,-.7509498596191406,.027888797223567963,0,-.7509498596191406,2.4079236027318984e-7,0,-.7092912197113037,2.4079236027318984e-7,0,-.7651040554046631,.02731318026781082,0,-.762715220451355,2.4079236027318984e-7,0,-.7469497919082642,.14604181051254272,0,-.30268287658691406,.20094013214111328,0,-.42173314094543457,.4097483158111572,0,-.44179344177246094,.44370222091674805,0,-1.0749012231826782,.02731318026781082,0,-1.066666841506958,-.04831935465335846,0,-1.071443796157837,.0006151511333882809,0,-1.077290415763855,2.4079236027318984e-7,0,-1.1027876138687134,-.05417116731405258,0,-1.104117512702942,2.4079236027318984e-7,0,-1.0200716257095337,-.42248597741127014,0,-1.039575457572937,-.37192943692207336,0,-.9692755341529846,-.305999755859375,0,-1.0565747022628784,-.3204768896102905,0,-.9981105327606201,-.4720246493816376,0,-.5716499090194702,-.5840598344802856,0,-1.0404950380325317,.10110360383987427,0,-1.0382754802703857,-.1947351098060608,0,-1.0678062438964844,.053796231746673584,0,-1.0589627027511597,-.09712622314691544,0,-1.0988010168075562,-.10821183770895004,0,-1.0493404865264893,-.14580905437469482,0,-1.0562201738357544,.07864472270011902,0,-1.0921671390533447,-.16199177503585815,0,-1.0710285902023315,-.26825234293937683,0,-1.0829023122787476,-.21538150310516357,0,-.672492265701294,.10110360383987427,0,-.7509498596191406,.10323503613471985,0,-.3731050491333008,.23512470722198486,0,-.305999755859375,.22099995613098145,0,-.2069997787475586,.20300006866455078,0,-.3731050491333008,.10323503613471985,0,-.3394804000854492,.030888795852661133,0,-.3731050491333008,.027888797223567963,0,-.3731050491333008,2.4079236027318984e-7,0,-.34128880500793457,2.4079236027318984e-7,0,-.39710140228271484,.02731318026781082,0,-.3947126865386963,2.4079236027318984e-7,0,-.023999691009521484,.030000001192092896,0,-.022432804107666016,2.4079236027318984e-7,0,0,0,0,-.0006499290466308594,.026429995894432068,0,-.026710033416748047,2.4079236027318984e-7,0,-.029102802276611328,.02731318026781082,0,-.0025930404663085938,.05279609560966492,0,-.026000022888183594,.05800001323223114,0,-.036197662353515625,.053796231746673584,0,-.005830287933349609,.07903498411178589,0,-.03399991989135742,.07400000095367432,0,-.047783851623535156,.07864472270011902,0,-.7509498596191406,.05493021011352539,0,-.6998038291931152,.053796231746673584,0,-.7721991539001465,.053796231746673584,0,-.7509498596191406,.08030259609222412,0,-.6882176399230957,.07864472270011902,0,-.7837854623794556,.07864472270011902,0,-.3731050491333008,.08030259609222412,0,-.32021546363830566,.07864472270011902,0,-.4157860279083252,.07864472270011902,0,-.3731050491333008,.05493021011352539,0,-.3258044719696045,.05679622292518616,0,-.40419960021972656,.053796231746673584,0,-.03703117370605469,.09858125448226929,0,-.06350898742675781,.10110360383987427,0,-.43357348442077637,.5283119678497314,0,-.4596233367919922,.532832145690918,0,-.4077773094177246,.5225193500518799,0,-.382279634475708,.5154455900192261,0,-.3571767807006836,.5071523189544678,0,-.33250856399536133,.49763762950897217,0,-.30834197998046875,.4869241714477539,0,-.2847251892089844,.4750373363494873,0,-.26172399520874023,.46200621128082275,0,-.23938655853271484,.44786226749420166,0,-.19533395767211914,.14892077445983887,0,-.1969308853149414,.416373610496521,0,-.2177720069885254,.43263912200927734,0,-.176910400390625,.3991053104400635,0,-.15776300430297852,.38087546825408936,0,-.13953447341918945,.36172807216644287,0,-.20599985122680664,.20500004291534424,0,-.12226390838623047,.3417092561721802,0,-.10599899291992188,.320867121219635,0,-.0907754898071289,.2992520332336426,0,-.07663202285766602,.276915967464447,0,-.12299966812133789,.2269999384880066,0,-.06360340118408203,.25391286611557007,0,-.05171537399291992,.23029804229736328,0,-.041002750396728516,.20612841844558716,0,-.03148794174194336,.18146222829818726,0,-.04700040817260742,.14300000667572021,0,-.023192882537841797,.15635886788368225,0,-.010349750518798828,.10508346557617188,0,-.01614093780517578,.13087883591651917,0,.386249840259552,.5111174583435059,0,-.16200768947601318,1.0920603275299072,0,-.10822245478630066,1.0986934900283813,0,.40879666805267334,.5551024675369263,0,.36248308420181274,.46713244915008545,0,-.21540266275405884,1.082796335220337,0,.3370523750782013,.42314743995666504,0,-.26827874779701233,1.0709238052368164,0,.30947983264923096,.37916243076324463,0,-.3205084204673767,1.0564712285995483,0,.2792414426803589,.33517754077911377,0,-.37196603417396545,1.0394736528396606,0,.24575459957122803,.2911924123764038,0,-.422527551651001,1.0199717283248901,0,.20836210250854492,.24720752239227295,0,-.47207111120224,.9980128407478333,0,.16631078720092773,.20322251319885254,0,-.5204774141311646,.9736496210098267,0,.11872625350952148,.15923750400543213,0,-.5676298141479492,.9469406008720398,0,.06458115577697754,.11525249481201172,0,-.6134148836135864,.9179503917694092,0,.002651691436767578,.07126760482788086,0,-.6577221155166626,.8867488503456116,0,-.05417648330330849,1.1026794910430908,0,.4347008466720581,.5990874767303467,0,-3469446951953614e-31,1.1040095090866089,0,.4518941044807434,.6430724859237671,0,.05417648330330849,1.1026794910430908,0,.47313788533210754,.6850499510765076,0,.10822245478630066,1.0986934900283813,0,.49418461322784424,.7230170965194702,0,.16200768947601318,1.0920603275299072,0,.5148378610610962,.7569884657859802,0,.21540266275405884,1.082796335220337,0,.5349019765853882,.7869882583618164,0,.26827874779701233,1.0709238052368164,0,.554182767868042,.8130500912666321,0,.3205084204673767,1.0564712285995483,0,.5724878907203674,.8352170586585999,0,.37196603417396545,1.0394736528396606,0,.5896275639533997,.8535416722297668,0,.422527551651001,1.0199717283248901,0,.6054145693778992,.868086040019989,0,.47207111120224,.9980128407478333,0,.6196650862693787,.8789210319519043,0,.5204774141311646,.9736496210098267,0,.6321989297866821,.8861263394355774,0,.5676298141479492,.9469406008720398,0,.6428400278091431,.8897905349731445,0,.6134148836135864,.9179503917694092,0,.6514168977737427,.8900108933448792,0,.6577221155166626,.8867488503456116,0,.6577632427215576,.8868927955627441,0,.7004446983337402,.8534108996391296,0,.7004885673522949,.853549599647522,0,.7414801120758057,.8180172443389893,0,.7415264248847961,.8181500434875488,0,.7807291150093079,.7806527614593506,0,.7807778120040894,.7807795405387878,0,.8180971145629883,.7414076328277588,0,.8181482553482056,.7415281534194946,0,.8534945249557495,.7003764510154724,0,.8535478115081787,.7004901766777039,0,.8868356347084045,.65765780210495,0,.8868910074234009,.657764732837677,0,.9180402159690857,.6133551001548767,0,.9180976152420044,.6134546399116516,0,.9470332264900208,.5675746202468872,0,.9470924735069275,.5676668286323547,0,.9737448692321777,.5204266905784607,0,.9738056659698486,.520511269569397,0,.9981105327606201,.4720250964164734,0,.9981728792190552,.4721018373966217,0,1.0200716257095337,.42248642444610596,0,1.0201354026794434,.4225551187992096,0,1.039575457572937,.37192991375923157,0,1.0396403074264526,.3719903528690338,0,1.0565747022628784,.32047736644744873,0,1.0566407442092896,.32052943110466003,0,1.0710285902023315,.26825281977653503,0,1.071095585823059,.26829639077186584,0,1.0829023122787476,.21538199484348297,0,1.0829699039459229,.21541693806648254,0,1.0921671390533447,.16199226677417755,0,1.0922353267669678,.1620185822248459,0,1.0988010168075562,.10821231454610825,0,1.0988696813583374,.1082298681139946,0,1.1027876138687134,.05417165160179138,0,1.1028565168380737,.05418045446276665,0,-.06853866577148438,.02728259563446045,0,-.7004446983337402,.8534108996391296,0,-.9986465573310852,-.13621598482131958,0,-.9955851435661316,.13240069150924683,0,-.9737987518310547,-.14780303835868835,0,-1.021105408668518,-.12049010396003723,0,-.7995140552520752,-.10110315680503845,0,-.8189002275466919,-.12049010396003723,0,-.8490850925445557,-.061249375343322754,0,-.8413589000701904,-.13621598482131958,0,-.4733562469482422,-.13621598482131958,0,-.4267849922180176,-.23759931325912476,0,-.4508974552154541,-.12049010396003723,0,-.6973850727081299,-.24089926481246948,0,-.6057994365692139,-.14780303835868835,0,-.6306471824645996,-.13621598482131958,0,-.6531062126159668,-.12049010396003723,0,-.26264524459838867,-.13621598482131958,0,-.28510379791259766,-.12049010396003723,0,-.3195347785949707,-.2326493263244629,0,-.23779773712158203,-.14780303835868835,0,-.07929515838623047,-.17555928230285645,0,-.08289575576782227,-.12049010396003723,0,-.10535764694213867,-.13621598482131958,0,-.13020563125610352,-.14780303835868835,0,-.7589999437332153,.7080004811286926,0,-.8180971145629883,.7414076328277588,0,-.7807291150093079,.7806527614593506,0,-.8534945249557495,.7003764510154724,0,-.9388351440429688,-.08931571245193481,0,-.8926913738250732,-.15489917993545532,0,-.920002818107605,-.15728875994682312,0,-.563075065612793,-.2813156843185425,0,-.5520005226135254,-.15728875994682312,0,-.5793156623840332,-.15489917993545532,0,-.5246889591217041,-.15489917993545532,0,-.304490327835083,-.10110315680503845,0,-.3759993314743042,-.32692790031433105,0,-.3998821973800659,-.370792031288147,0,-.31806397438049316,-.11593961715698242,0,-.34984421730041504,-.27826106548309326,0,-.24901437759399414,-.235939621925354,0,-.41225504875183105,-.24093949794769287,0,-.4937293529510498,-.514792799949646,0,-.5091409683227539,-.5280426740646362,0,-.4775388240814209,-.4962872266769409,0,-.4603116512298584,-.4725712537765503,0,-.5240316390991211,-.5360053777694702,0,-.538661003112793,-.5386618375778198,0,-.25545215606689453,-.10467243194580078,0,-.2897942066192627,-.1669992208480835,0,-.2383335828781128,.019060492515563965,0,-.1931476593017578,-.06068742275238037,0,-.512230396270752,-.5380129814147949,0,-.9473142623901367,-.15489917993545532,0,-.8662068843841553,-.14780303835868835,0,-.49820756912231445,-.14780303835868835,0,-.43151116371154785,-.10110315680503845,0,-.21131277084350586,-.15489917993545532,0,-.1873149871826172,-.2813156843185425,0,-.18400096893310547,-.15728875994682312,0,-.15668964385986328,-.15489917993545532,0,-.7414801120758057,.8180172443389893,0,-.843999981880188,.5510004162788391,0,-.8868356347084045,.65765780210495,0,-.9180402159690857,.6133551001548767,0,-.9737448692321777,.5204266905784607,0,-.9470332264900208,.5675746202468872,0,-.32118499279022217,-.22490859031677246,0,-.2969999313354492,-.21399927139282227,0,-.48586320877075195,-.5360680818557739,0,-.1308431625366211,-.01670253276824951,0,-.706902027130127,-.02731270343065262,0,-.7509498596191406,-.02788832038640976,0,-.7651040554046631,-.02731270343065262,0,-.30268287658691406,-.20093953609466553,0,-.7469497919082642,-.14604133367538452,0,-.42173314094543457,-.4097479581832886,0,-.44179344177246094,-.4437016248703003,0,-1.0749012231826782,-.02731270343065262,0,-1.0715610980987549,.04958720505237579,0,-1.1027876138687134,.05417165160179138,0,-1.0200716257095337,.42248642444610596,0,-.9692755341529846,.3060002624988556,0,-1.039575457572937,.37192991375923157,0,-1.0565747022628784,.32047736644744873,0,-.9981105327606201,.4720250964164734,0,-.5716499090194702,.5840603113174438,0,-1.0404950380325317,-.10110315680503845,0,-1.0382754802703857,.194735586643219,0,-1.0678062438964844,-.05379574000835419,0,-1.0674201250076294,.09851153194904327,0,-1.0988010168075562,.10821231454610825,0,-1.0570870637893677,.1471398025751114,0,-1.0562201738357544,-.07864424586296082,0,-1.0921671390533447,.16199226677417755,0,-1.0710285902023315,.26825281977653503,0,-1.0829023122787476,.21538199484348297,0,-.672492265701294,-.10110315680503845,0,-.7509498596191406,-.10323455929756165,0,-.305999755859375,-.2209993600845337,0,-.3731050491333008,-.23512428998947144,0,-.2069997787475586,-.20299947261810303,0,-.3731050491333008,-.10323455929756165,0,-.3394804000854492,-.03088831901550293,0,-.3731050491333008,-.02788832038640976,0,-.39710140228271484,-.02731270343065262,0,-.023999691009521484,-.029999524354934692,0,-.0006499290466308594,-.026429519057273865,0,-.029102802276611328,-.02731270343065262,0,-.0025930404663085938,-.05279560387134552,0,-.026000022888183594,-.05799952149391174,0,-.036197662353515625,-.05379574000835419,0,-.03399991989135742,-.07399952411651611,0,-.005830287933349609,-.07903450727462769,0,-.047783851623535156,-.07864424586296082,0,-.7509498596191406,-.054929718375205994,0,-.6998038291931152,-.05379574000835419,0,-.7721991539001465,-.05379574000835419,0,-.7509498596191406,-.08030208945274353,0,-.6882176399230957,-.07864424586296082,0,-.7837854623794556,-.07864424586296082,0,-.32021546363830566,-.07864424586296082,0,-.3731050491333008,-.08030208945274353,0,-.4157860279083252,-.07864424586296082,0,-.3731050491333008,-.054929718375205994,0,-.3258044719696045,-.056795746088027954,0,-.40419960021972656,-.05379574000835419,0,-.03703117370605469,-.09858077764511108,0,-.06350898742675781,-.10110315680503845,0,-.4596233367919922,-.5328315496444702,0,-.43357348442077637,-.5283114910125732,0,-.4077773094177246,-.5225186347961426,0,-.382279634475708,-.5154451131820679,0,-.3571767807006836,-.5071518421173096,0,-.33250856399536133,-.4976370334625244,0,-.30834197998046875,-.48692357540130615,0,-.2847251892089844,-.4750368595123291,0,-.26172399520874023,-.462005615234375,0,-.23938655853271484,-.4478616714477539,0,-.19533395767211914,-.14892029762268066,0,-.2177720069885254,-.4326385259628296,0,-.1969308853149414,-.41637301445007324,0,-.176910400390625,-.3991048336029053,0,-.15776300430297852,-.38087499141693115,0,-.13953447341918945,-.3617277145385742,0,-.20599985122680664,-.20499950647354126,0,-.12226390838623047,-.341708779335022,0,-.10599899291992188,-.32086658477783203,0,-.0907754898071289,-.29925161600112915,0,-.07663202285766602,-.2769155502319336,0,-.12299966812133789,-.2269994616508484,0,-.06360340118408203,-.25391244888305664,0,-.05171537399291992,-.23029756546020508,0,-.041002750396728516,-.20612794160842896,0,-.03148794174194336,-.18146175146102905,0,-.023192882537841797,-.15635839104652405,0,-.04700040817260742,-.14299947023391724,0,-.010349750518798828,-.10508301854133606,0,-.01614093780517578,-.13087841868400574,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.12167060375213623,-.2107395976781845,0,-.16011357307434082,-.22866588830947876,0,0,0,0,-.08692443370819092,-.18641014397144318,0,-.4297513961791992,-.15641668438911438,0,-.33499979972839355,.06000000238418579,0,-.39975786209106445,-.18641014397144318,0,-.36501169204711914,-.2107395976781845,0,-.8516933917999268,-.2107395976781845,0,-.8864400386810303,-.18641014397144318,0,-.8350002765655518,-.029999971389770508,0,-.31999993324279785,-.010000050067901611,0,-.6083521842956543,-.2107395976781845,0,-.6467952728271484,-.22866588830947876,0,-.5736064910888672,-.18641014397144318,0,-.7300252914428711,.4214792251586914,0,-.7100000381469727,.19499993324279785,0,-.7995162010192871,.37282031774520874,0,-.6531386375427246,.45733174681663513,0,-.07999992370605469,.2800000309944153,0,-.24334287643432617,.4214792251586914,0,-.17384910583496094,.37282031774520874,0,-.32022809982299805,.45733174681663513,0,0,0,0,0,0,0,0,0,0,0,0,0,-.14333343505859375,-.017473816871643066,0,-.24334120750427246,-.24334114789962769,0,-.2855968475341797,-.23964427411556244,0,-.5470001697540283,-.05747377872467041,0,-.6877679824829102,-.23964427411556244,0,-.7300233840942383,-.24334114789962769,0,-.7722792625427246,-.23964427411556244,0,-.8595046997070312,.31283333897590637,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.20108556747436523,-.23964427411556244,0,-.3265688419342041,-.22866588830947876,0,-.8132505416870117,-.22866588830947876,0,-.9164328575134277,-.15641668438911438,0,-.5711936950683594,.47928857803344727,0,-.4766664505004883,.2995262145996094,0,-.4866824150085449,.486682265996933,0,-.40217113494873047,.47928857803344727,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.49037885665893555,-.04225574806332588,0,-.48600006103515625,-.024508334696292877,0,-.48600006103515625,0,0,-.4866819381713867,0,0,-.4829854965209961,-.04225574806332588,0,-.4866824150085449,0,0,-.2776827812194824,.02760004997253418,0,0,0,0,0,0,0,0,0,0,-.0036967992782592773,-.04225574806332588,0,.0009113550186157227,.0004747062921524048,0,-.0005533695220947266,.0004042122745886445,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.0569310188293457,-.15641668438911438,0,0,0,0,-.014675259590148926,-.08322757482528687,0,.0015821456909179688,.0004971474409103394,0,0,0,0,.0012818574905395508,.00041282176971435547,0,-.03260147571563721,-.12167057394981384,0,0,0,0,0,0,0,0,0,0,-.5436127185821533,-.15641668438911438,0,-.48600006103515625,-.09072166681289673,0,-.8450000286102295,0,0,0,0,0,0,0,0,-.9717988967895508,-.015661269426345825,0,-.9659719467163086,.08451149612665176,0,-.9717988967895508,.018766678869724274,0,-.9717988967895508,-.0011501713888719678,0,-.9733645915985107,0,0,-.9696674346923828,-.04225574806332588,0,-.9733648300170898,0,0,-.006339073181152344,.05151616036891937,0,0,0,0,0,0,0,0,0,0,0,0,0,-.007394313812255859,.08451149612665176,0,0,0,0,-.010427474975585938,.06925784051418304,0,-.029351234436035156,.16645514965057373,0,0,0,0,-.015134334564208984,.07380187511444092,0,-.06520318984985352,.24334114789962769,0,-.48600006103515625,-.04827199876308441,0,-.5013570785522461,-.08322757482528687,0,-.47200703620910645,-.08322757482528687,0,-.48600006103515625,-.07056893408298492,0,-.5192835330963135,-.12167057394981384,0,-.45408082008361816,-.12167057394981384,0,-.9717988967895508,-.012418374419212341,0,-.9081621170043945,.24334114789962769,0,-.9407627582550049,-.12167057394981384,0,-.9717988967895508,.009208470582962036,0,-.9440150260925293,.16645514965057373,0,-.9586889743804932,-.08322757482528687,0,-.017035961151123047,.07816505432128906,0,-.11386394500732422,.31283333897590637,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.12167060375213623,.2107395976781845,0,0,0,0,-.16011357307434082,.22866588830947876,0,-.08692443370819092,.18641014397144318,0,-.4297513961791992,.15641668438911438,0,-.39975786209106445,.18641014397144318,0,-.33499979972839355,-.06000000238418579,0,-.36501169204711914,.2107395976781845,0,-.8516933917999268,.2107395976781845,0,-.8350002765655518,.029999971389770508,0,-.8864400386810303,.18641014397144318,0,-.31999993324279785,.010000050067901611,0,-.6467952728271484,.22866588830947876,0,-.6083521842956543,.2107395976781845,0,-.5736064910888672,.18641014397144318,0,-.7300252914428711,-.42147916555404663,0,-.7995162010192871,-.37282025814056396,0,-.7100000381469727,-.19499993324279785,0,-.6531386375427246,-.4573318064212799,0,-.07999992370605469,-.2800000309944153,0,-.17384910583496094,-.37282025814056396,0,-.24334287643432617,-.42147916555404663,0,-.32022809982299805,-.4573318064212799,0,0,0,0,0,0,0,0,0,0,0,0,0,-.14333343505859375,.017473816871643066,0,-.2855968475341797,.23964427411556244,0,-.24334120750427246,.24334114789962769,0,-.5470001697540283,.05747377872467041,0,-.7300233840942383,.24334114789962769,0,-.6877679824829102,.23964427411556244,0,-.7722792625427246,.23964427411556244,0,-.8595046997070312,-.31283339858055115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.20108556747436523,.23964427411556244,0,-.3265688419342041,.22866588830947876,0,-.8132505416870117,.22866588830947876,0,-.9164328575134277,.15641668438911438,0,-.5711936950683594,-.4792885184288025,0,-.4766664505004883,-.2995262145996094,0,-.4866824150085449,-.48668232560157776,0,-.40217113494873047,-.4792885184288025,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.49037885665893555,.04225574806332588,0,-.48600006103515625,.024508334696292877,0,-.4829854965209961,.04225574806332588,0,0,0,0,-.2776827812194824,-.02760004997253418,0,0,0,0,0,0,0,-.0036967992782592773,.04225574806332588,0,-.0017715692520141602,.0003534853458404541,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-.0569310188293457,.15641668438911438,0,0,0,0,-.014675259590148926,.08322757482528687,0,-.002859354019165039,.0003470778465270996,0,0,0,0,-.0028954744338989258,.00036713480949401855,0,-.03260147571563721,.12167057394981384,0,0,0,0,0,0,0,0,0,0,-.5436127185821533,.15641668438911438,0,-.48600006103515625,.09072166681289673,0,0,0,0,-.8450000286102295,0,0,0,0,0,-.9717988967895508,.015661269426345825,0,-.9659719467163086,-.08451149612665176,0,-.9717988967895508,-.018766678869724274,0,-.9696674346923828,.04225574806332588,0,-.006339073181152344,-.05151616036891937,0,0,0,0,-.007394313812255859,-.08451149612665176,0,0,0,0,-.010427474975585938,-.06925784051418304,0,-.029351234436035156,-.16645514965057373,0,-.015134334564208984,-.07380187511444092,0,0,0,0,-.06520318984985352,-.24334114789962769,0,-.48600006103515625,.04827199876308441,0,-.5013570785522461,.08322757482528687,0,-.47200703620910645,.08322757482528687,0,-.48600006103515625,.07056893408298492,0,-.5192835330963135,.12167057394981384,0,-.45408082008361816,.12167057394981384,0,-.9081621170043945,-.24334114789962769,0,-.9717988967895508,.012418374419212341,0,-.9407627582550049,.12167057394981384,0,-.9717988967895508,-.009208470582962036,0,-.9440150260925293,-.16645514965057373,0,-.9586889743804932,.08322757482528687,0,-.017035961151123047,-.07816505432128906,0,-.11386394500732422,-.31283339858055115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.12154901027679443,.21052885055541992,0,.15995359420776367,.22843721508979797,0,.03839099407196045,.35279959440231323,0,.08683764934539795,.18622374534606934,0,.4293215274810791,.15626025199890137,0,.4200000762939453,.20999997854232788,0,.39935827255249023,.18622374534606934,0,.36464691162109375,.21052885055541992,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863247871398926,0,0,.36464643478393555,-.2105288952589035,0,.4099998474121094,-.15000003576278687,0,.39935874938964844,-.18622371554374695,0,.32624244689941406,-.22843724489212036,0,.037000179290771484,-.12699997425079346,0,.12154817581176758,-.2105288952589035,0,.0868377685546875,-.18622371554374695,0,.15995311737060547,-.22843724489212036,0,0,0,0,0,0,0,0,0,0,0,0,0,.21166658401489258,.21752619743347168,0,.24309802055358887,.24309781193733215,0,.2853109836578369,.2394046187400818,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863250255584717,0,0,.4293212890625,-.15626028180122375,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.20088458061218262,.2394046187400818,0,.32624220848083496,.22843721508979797,0,.4863250255584717,0,0,.4863252639770508,0,0,.285311222076416,-.23940463364124298,0,.19933366775512695,-.23747384548187256,0,.24309778213500977,-.24309782683849335,0,.20088481903076172,-.23940463364124298,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.4863252639770508,0,0,.4974551200866699,.018744654953479767,0,.4974551200866699,0,0,.4863250255584717,0,0,.48250246047973633,.04221349209547043,0,.48619556427001953,0,0,.42731738090515137,.13260000944137573,0,0,0,0,0,0,0,0,0,0,.003693103790283203,.04221349209547043,0,.0009113550186157227,.0004747062921524048,0,-.0005533695220947266,.0004042122745886445,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.05687403678894043,.15626025199890137,0,0,0,0,.014660477638244629,.08314433693885803,0,.0015821456909179688,.0004971474409103394,0,0,0,0,.0012818574905395508,.00041282176971435547,0,.032568931579589844,.12154892086982727,0,0,0,0,0,0,0,0,0,0,.4863250255584717,0,0,.4974551200866699,.06938645243644714,0,.4163331985473633,-.048500001430511475,0,0,0,0,0,0,0,.48400020599365234,-.06768932938575745,0,.4825019836425781,-.042213499546051025,0,.48400020599365234,-.01860012859106064,0,.48400020599365234,-.0004301601729821414,0,.48619532585144043,0,0,.4863252639770508,0,0,.4863252639770508,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.0036935806274414062,-.042213499546051025,0,0,0,0,0,0,0,.014660835266113281,-.08314434438943863,0,0,0,0,0,0,0,.032568931579589844,-.12154891341924667,0,.4974551200866699,.03691975772380829,0,.4863252639770508,0,0,.47153496742248535,.08314433693885803,0,.4974551200866699,.05397304892539978,0,.4863250255584717,0,0,.4536268711090088,.12154892086982727,0,.48400020599365234,-.05274850130081177,0,.4536271095275879,-.12154891341924667,0,.4863250255584717,0,0,.48400020599365234,-.03621801733970642,0,.47153449058532715,-.08314434438943863,0,.4863252639770508,0,0,0,0,0,.056873321533203125,-.15626028180122375,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.12154901027679443,-.21052885055541992,0,.03839099407196045,-.352799654006958,0,.15995359420776367,-.22843721508979797,0,.08683764934539795,-.18622374534606934,0,.4293215274810791,-.15626025199890137,0,.39935827255249023,-.18622374534606934,0,.4200000762939453,-.21000003814697266,0,.36464691162109375,-.21052885055541992,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863247871398926,0,0,.36464643478393555,.2105288952589035,0,.39935874938964844,.18622371554374695,0,.4099998474121094,.15000003576278687,0,.32624244689941406,.22843724489212036,0,.037000179290771484,.12699997425079346,0,.0868377685546875,.18622371554374695,0,.12154817581176758,.2105288952589035,0,.15995311737060547,.22843724489212036,0,0,0,0,0,0,0,0,0,0,0,0,0,.21166658401489258,-.21752619743347168,0,.2853109836578369,-.2394046187400818,0,.24309802055358887,-.24309781193733215,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863250255584717,0,0,.4863250255584717,0,0,.4293212890625,.15626028180122375,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.20088458061218262,-.2394046187400818,0,.32624220848083496,-.22843721508979797,0,.4863250255584717,0,0,.4863252639770508,0,0,.285311222076416,.23940463364124298,0,.19933366775512695,.23747384548187256,0,.24309778213500977,.24309782683849335,0,.20088481903076172,.23940463364124298,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.4863252639770508,0,0,.4974551200866699,-.018744654953479767,0,.48250246047973633,-.04221349209547043,0,0,0,0,.42731738090515137,-.1326000690460205,0,0,0,0,0,0,0,.003693103790283203,-.04221349209547043,0,-.0017715692520141602,.0003534853458404541,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.05687403678894043,-.15626025199890137,0,0,0,0,.014660477638244629,-.08314433693885803,0,-.002859354019165039,.0003470778465270996,0,0,0,0,-.0028954744338989258,.00036713480949401855,0,.032568931579589844,-.12154892086982727,0,0,0,0,0,0,0,0,0,0,.4863250255584717,0,0,.4974551200866699,-.06938645243644714,0,0,0,0,.4163331985473633,.048500001430511475,0,0,0,0,.48400020599365234,.06768932938575745,0,.4825019836425781,.042213499546051025,0,.48400020599365234,.01860012859106064,0,.4863252639770508,0,0,0,0,0,0,0,0,.0036935806274414062,.042213499546051025,0,0,0,0,0,0,0,.014660835266113281,.08314434438943863,0,0,0,0,0,0,0,.032568931579589844,.12154891341924667,0,.4974551200866699,-.03691975772380829,0,.4863252639770508,0,0,.47153496742248535,-.08314433693885803,0,.4974551200866699,-.05397304892539978,0,.4863250255584717,0,0,.4536268711090088,-.12154892086982727,0,.4536271095275879,.12154891341924667,0,.48400020599365234,.05274850130081177,0,.4863250255584717,0,0,.48400020599365234,.03621801733970642,0,.47153449058532715,.08314434438943863,0,.4863252639770508,0,0,0,0,0,.056873321533203125,.15626028180122375,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[.2197294682264328,1.481149435043335,0,.14777812361717224,1.5002686977386475,0,.14859063923358917,1.5085171461105347,0,.22243838012218475,1.4994101524353027,0,.2893359065055847,1.45444655418396,0,.2957502603530884,1.4866902828216553,0,.3557826578617096,1.420224905014038,0,.3683496117591858,1.4703893661499023,0,.4182245135307312,1.3785665035247803,0,.4400615990161896,1.4505459070205688,0,.4757751226425171,1.3295717239379883,0,.5107135772705078,1.4272083044052124,0,.5274941325187683,1.2733585834503174,0,.5801351070404053,1.4004316329956055,0,.5723733305931091,1.2100632190704346,0,.6481587290763855,1.3702819347381592,0,.6093156337738037,1.1398370265960693,0,.7146211862564087,1.3368308544158936,0,.6371104717254639,1.0628502368927002,0,.7793620228767395,1.300159215927124,0,.6544033288955688,.9792876243591309,0,.842225193977356,1.2603552341461182,0,.6596523523330688,.8893508911132812,0,.9030598998069763,1.217515230178833,0,.07843261957168579,1.5117590427398682,0,.0743848979473114,1.5139906406402588,0,0,1.515592336654663,0,0,1.5158166885375977,0,-.07438208907842636,1.5137666463851929,0,-.0743848979473114,1.5139906406402588,0,-.1485850214958191,1.5082941055297852,0,-.14859063923358917,1.5085171461105347,0,-.22242997586727142,1.4991884231567383,0,-.22243838012218475,1.4994101524353027,0,-.2957390248775482,1.4864706993103027,0,-.2957502603530884,1.4866902828216553,0,-.36833566427230835,1.47017240524292,0,-.3683496117591858,1.4703893661499023,0,-.44004496932029724,1.4503320455551147,0,-.4400615990161896,1.4505459070205688,0,-.5106942057609558,1.426997423171997,0,-.5107135772705078,1.4272083044052124,0,-.5801131129264832,1.400225043296814,0,-.5801351070404053,1.4004316329956055,0,-.6481342315673828,1.370079755783081,0,-.6481587290763855,1.3702819347381592,0,-.714594304561615,1.336633324623108,0,-.7146211862564087,1.3368308544158936,0,-.7793324589729309,1.2999670505523682,0,-.7793620228767395,1.300159215927124,0,-.8421934843063354,1.2601691484451294,0,-.842225193977356,1.2603552341461182,0,-.9030256271362305,1.2173354625701904,0,-.9030598998069763,1.217515230178833,0,-.9616818428039551,1.1715688705444336,0,-.9617183208465576,1.1717422008514404,0,-1.0180219411849976,1.1229803562164307,0,-1.0180602073669434,1.1231460571289062,0,-1.0719091892242432,1.071685552597046,0,-1.07194983959198,1.0718439817428589,0,-1.123213768005371,1.0178096294403076,0,-1.1232563257217407,1.0179600715637207,0,-1.1718133687973022,.9614818096160889,0,-1.171857476234436,.9616237878799438,0,-1.217589020729065,.902837336063385,0,-1.217634916305542,.9029708504676819,0,-1.2604318857192993,.8420178890228271,0,-1.2604795694351196,.8421424031257629,0,-1.3002382516860962,.7791703343391418,0,-1.3002873659133911,.7792854905128479,0,-1.3369123935699463,.7144455313682556,0,-1.3369625806808472,.7145510911941528,0,-1.3703646659851074,.6479992866516113,0,-1.370416522026062,.6480950117111206,0,-1.4005162715911865,.5799922347068787,0,-1.4005693197250366,.5800778865814209,0,-1.4272942543029785,.5105878114700317,0,-1.427348256111145,.5106632113456726,0,-1.4506337642669678,.43995335698127747,0,-1.4506888389587402,.4400183856487274,0,-1.4704785346984863,.36825910210609436,0,-1.4705342054367065,.36831343173980713,0,-1.4867808818817139,.2956774830818176,0,-1.4868369102478027,.2957211434841156,0,-1.4995012283325195,.22238361835479736,0,-1.4995577335357666,.2224164605140686,0,-1.5086088180541992,.14855413138866425,0,-1.5086658000946045,.1485760509967804,0,-1.5140823125839233,.07436586916446686,0,-1.5141394138336182,.07437683641910553,0,-1.5159083604812622,-7.450580596923828e-7,0,-1.5159657001495361,-7.450580596923828e-7,0,.6510725021362305,.7932562828063965,0,.9617183208465576,1.1717422008514404,0,2.637735366821289,-.35978949069976807,0,2.5721027851104736,-.3903944492340088,0,2.7731070518493652,-.6161036491394043,0,2.6970555782318115,-.3182525932788849,0,2.11175799369812,-.2670457661151886,0,2.0567619800567627,-.6203821301460266,0,2.1629655361175537,-.3182525932788849,0,2.2222867012023926,-.35978949069976807,0,1.2502825260162354,-.35978949069976807,0,1.1909615993499756,-.3182525932788849,0,1.1069352626800537,-.6161036491394043,0,1.8090770244598389,-.6244526505470276,0,1.6657304763793945,-.35978949069976807,0,1.6000981330871582,-.3903944492340088,0,1.7250514030456543,-.3182525932788849,0,.6937260627746582,-.35978949069976807,0,.8292484283447266,-.6034241318702698,0,.7530474662780762,-.3182525932788849,0,.6280937194824219,-.3903944492340088,0,.20588254928588867,-.45523205399513245,0,.2782778739929199,-.35978949069976807,0,.21895694732666016,-.3182525932788849,0,.34390974044799805,-.3903944492340088,0,1.0370213985443115,1.0687907934188843,0,1.07194983959198,1.0718439817428589,0,1.1232563257217407,1.0179600715637207,0,1.171857476234436,.9616237878799438,0,2.422696352005005,-.7294614911079407,0,2.430011034011841,-.4154490828514099,0,2.3578686714172363,-.4091375172138214,0,1.4603385925292969,-.7294614911079407,0,1.5301475524902344,-.4091375172138214,0,1.4580063819885254,-.4154490828514099,0,1.3858647346496582,-.4091375172138214,0,.8042540550231934,-.2670457661151886,0,.48331475257873535,.24241113662719727,0,.9808909893035889,-.1680145263671875,0,.4561147689819336,.16760694980621338,0,.5105149745941162,.3172152042388916,0,.8279612064361572,-.4593261480331421,0,.5362305641174316,-.6049820184707642,0,.3201141357421875,-.20641374588012695,0,.29291391372680664,-.2812178134918213,0,.34731411933898926,-.13160955905914307,0,.3745143413543701,-.05680549144744873,0,.2657136917114258,-.3560218811035156,0,.23851394653320312,-.43082594871520996,0,.5921152830123901,.5416276454925537,0,1.1691113710403442,-.032358646392822266,0,.5649151802062988,.4668233394622803,0,.619315505027771,.616431474685669,0,.25237417221069336,-.5036225318908691,0,2.50215220451355,-.4091375172138214,0,2.28791880607605,-.3903944492340088,0,1.3159146308898926,-.3903944492340088,0,1.139754295349121,-.2670457661151886,0,.5581436157226562,-.4091375172138214,0,.48598194122314453,-.7294614911079407,0,.48600196838378906,-.4154490828514099,0,.4138603210449219,-.4091375172138214,0,1.0180602073669434,1.1231460571289062,0,1.312314510345459,.8676854968070984,0,1.217634916305542,.9029708504676819,0,1.2604795694351196,.8421424031257629,0,1.3369625806808472,.7145510911941528,0,1.3002873659133911,.7792854905128479,0,.5377151966094971,.39201951026916504,0,.39203500747680664,-.7404707670211792,0,.2664320468902588,-.57240891456604,0,.6465156078338623,.6912357807159424,0,1.867143154144287,-.07214249670505524,0,1.9475038051605225,-.07231677323579788,0,1.9475038051605225,-7.450580596923828e-7,0,1.8734548091888428,-7.450580596923828e-7,0,2.0208740234375,-.07214249670505524,0,2.014561891555786,-7.450580596923828e-7,0,1.9475038051605225,-.6224358677864075,0,.8927822113037109,-.31367027759552,0,.42891478538513184,.09280276298522949,0,.401714563369751,.017998695373535156,0,2.8391480445861816,-.07214249670505524,0,1.6760122776031494,.0908341035246849,0,1.6880700588226318,-.002887637121602893,0,2.845458984375,-7.450580596923828e-7,0,1.5141394138336182,.07437761127948761,0,1.515882968902588,-7.450580596923828e-7,0,1.4005693197250366,.5800778865814209,0,1.427348256111145,.5106632113456726,0,1.5170000791549683,.5500000715255737,0,1.4506888389587402,.4400183856487274,0,1.370416522026062,.6480950117111206,0,1.2733500003814697,.12094008922576904,0,2.748262405395508,-.2670457661151886,0,1.6039998531341553,.36800000071525574,0,2.820404529571533,-.14209237694740295,0,1.656407356262207,.18360702693462372,0,1.5086658000946045,.1485760509967804,0,1.6319806575775146,.27551981806755066,0,2.789799690246582,-.20772483944892883,0,1.4995577335357666,.2224164605140686,0,1.4705342054367065,.36831343173980713,0,1.4868369102478027,.2957211434841156,0,1.7762587070465088,-.2670457661151886,0,1.9475038051605225,-.26769179105758667,0,.9677410125732422,-.6096858978271484,0,.3302426338195801,-.8515821695327759,0,.41930580139160156,-.9603173732757568,0,.9684958457946777,-.26769179105758667,0,.8951396942138672,-.07214249670505524,0,.9684619903564453,-.07231677323579788,0,.9684596061706543,-7.450580596923828e-7,0,.9014508724212646,-7.450580596923828e-7,0,1.0488700866699219,-.07214249670505524,0,1.042557716369629,-7.450580596923828e-7,0,.03499937057495117,-.07101200520992279,0,.028152942657470703,-7.450580596923828e-7,0,0,0,0,.0017132759094238281,-.06980974227190018,0,.07055377960205078,-7.450580596923828e-7,0,.07686519622802734,-.07214249670505524,0,.006850719451904297,-.13945068418979645,0,.04113149642944336,-.1399894803762436,0,.09560823440551758,-.14209237694740295,0,.015398025512695312,-.20875565707683563,0,.0468134880065918,-.20766039192676544,0,.12621307373046875,-.20772483944892883,0,1.9475038051605225,-.1424359679222107,0,1.8484001159667969,-.14209237694740295,0,2.039616823196411,-.14209237694740295,0,1.9475038051605225,-.20822730660438538,0,1.817795753479004,-.20772483944892883,0,2.0702219009399414,-.20772483944892883,0,.9684805870056152,-.20822730660438538,0,.8457908630371094,-.20772483944892883,0,1.0982177257537842,-.20772483944892883,0,.9684691429138184,-.1424359679222107,0,.8763959407806396,-.14209237694740295,0,1.067612648010254,-.14209237694740295,0,.05865049362182617,-.2739640772342682,0,.16774988174438477,-.2670457661151886,0,.29592323303222656,-.6980182528495789,0,.2808830738067627,-.6371994018554688,0,.31174707412719727,-.754899263381958,0,.32854604721069336,-.8078852891921997,0,.3465108871459961,-.8570290207862854,0,.3658285140991211,-.9023925065994263,0,.38668203353881836,-.944046676158905,0,.4092531204223633,-.9820711016654968,0,.4337158203125,-1.0165544748306274,0,.46024370193481445,-1.0475938320159912,0,.4869999885559082,-1.0399999618530273,0,.5201516151428223,-1.0997710227966309,0,.4890012741088867,-1.075294852256775,0,.46727561950683594,-1.0541598796844482,0,.4167017936706543,-1.0060091018676758,0,.36855077743530273,-.9554349184036255,0,.27050018310546875,-.8015000224113464,0,.3229403495788574,-.9025588631629944,0,.27997827529907227,-.8475084900856018,0,.23976945877075195,-.7904164791107178,0,.20241069793701172,-.7314202189445496,0,.14949989318847656,-.5665000081062317,0,.16799163818359375,-.6706618666648865,0,.1365952491760254,-.6082878708839417,0,.10829734802246094,-.5444484949111938,0,.08316516876220703,-.4792975187301636,0,.08684968948364258,-.409824013710022,0,.06126070022583008,-.41299179196357727,0,.027336597442626953,-.27755773067474365,0,.042636871337890625,-.34569117426872253,0,.2197294682264328,-1.4811509847640991,0,.22243838012218475,-1.499411702156067,0,.14859063923358917,-1.5085186958312988,0,.14777812361717224,-1.5002702474594116,0,.2893359065055847,-1.4544481039047241,0,.2957502603530884,-1.486691951751709,0,.3557826578617096,-1.4202264547348022,0,.3683496117591858,-1.470391035079956,0,.4182245135307312,-1.3785680532455444,0,.4400615990161896,-1.450547456741333,0,.4757751226425171,-1.3295732736587524,0,.5107135772705078,-1.4272096157073975,0,.5274941325187683,-1.2733598947525024,0,.5801351070404053,-1.4004331827163696,0,.5723733305931091,-1.2100647687911987,0,.6481587290763855,-1.3702834844589233,0,.6093156337738037,-1.1398385763168335,0,.7146211862564087,-1.3368322849273682,0,.6371104717254639,-1.0628515481948853,0,.7793620228767395,-1.300160527229309,0,.6544033288955688,-.9792889356613159,0,.842225193977356,-1.2603566646575928,0,.6596523523330688,-.8893522024154663,0,.9030598998069763,-1.2175167798995972,0,.0743848979473114,-1.513992190361023,0,.07843261957168579,-1.5117605924606323,0,0,-1.5158181190490723,0,0,-1.5155938863754272,0,-.0743848979473114,-1.513992190361023,0,-.07438208907842636,-1.513768196105957,0,-.14859063923358917,-1.5085186958312988,0,-.1485850214958191,-1.5082956552505493,0,-.22243838012218475,-1.499411702156067,0,-.22242997586727142,-1.4991899728775024,0,-.2957502603530884,-1.486691951751709,0,-.2957390248775482,-1.4864723682403564,0,-.3683496117591858,-1.470391035079956,0,-.36833566427230835,-1.4701738357543945,0,-.4400615990161896,-1.450547456741333,0,-.44004496932029724,-1.4503334760665894,0,-.5107135772705078,-1.4272096157073975,0,-.5106942057609558,-1.4269990921020508,0,-.5801351070404053,-1.4004331827163696,0,-.5801131129264832,-1.400226354598999,0,-.6481587290763855,-1.3702834844589233,0,-.6481342315673828,-1.3700810670852661,0,-.7146211862564087,-1.3368322849273682,0,-.714594304561615,-1.3366347551345825,0,-.7793620228767395,-1.300160527229309,0,-.7793324589729309,-1.2999687194824219,0,-.842225193977356,-1.2603566646575928,0,-.8421934843063354,-1.260170578956604,0,-.9030598998069763,-1.2175167798995972,0,-.9030256271362305,-1.217336893081665,0,-.9617183208465576,-1.1717437505722046,0,-.9616818428039551,-1.1715703010559082,0,-1.0180602073669434,-1.1231476068496704,0,-1.0180219411849976,-1.1229817867279053,0,-1.07194983959198,-1.071845293045044,0,-1.0719091892242432,-1.0716869831085205,0,-1.1232563257217407,-1.0179616212844849,0,-1.123213768005371,-1.0178110599517822,0,-1.171857476234436,-.961625337600708,0,-1.1718133687973022,-.9614832401275635,0,-1.217634916305542,-.9029723405838013,0,-1.217589020729065,-.9028388261795044,0,-1.2604795694351196,-.8421438932418823,0,-1.2604318857192993,-.8420193791389465,0,-1.3002873659133911,-.7792869806289673,0,-1.3002382516860962,-.7791718244552612,0,-1.3369625806808472,-.7145525813102722,0,-1.3369123935699463,-.714447021484375,0,-1.370416522026062,-.64809650182724,0,-1.3703646659851074,-.6480007767677307,0,-1.4005693197250366,-.5800793766975403,0,-1.4005162715911865,-.579993724822998,0,-1.427348256111145,-.510664701461792,0,-1.4272942543029785,-.5105893015861511,0,-1.4506888389587402,-.4400198757648468,0,-1.4506337642669678,-.43995484709739685,0,-1.4705342054367065,-.3683149218559265,0,-1.4704785346984863,-.36826059222221375,0,-1.4868369102478027,-.295722633600235,0,-1.4867808818817139,-.295678973197937,0,-1.4995577335357666,-.222417950630188,0,-1.4995012283325195,-.22238510847091675,0,-1.5086658000946045,-.14857754111289978,0,-1.5086088180541992,-.14855562150478363,0,-1.5141394138336182,-.07437832653522491,0,-1.5140823125839233,-.07436735928058624,0,.6510725021362305,-.7932575941085815,0,.9617183208465576,-1.1717437505722046,0,2.637735366821289,.3597880005836487,0,2.7731070518493652,.6161021590232849,0,2.5721027851104736,.3903929591178894,0,2.6970555782318115,.3182511031627655,0,2.11175799369812,.2670442759990692,0,2.1629655361175537,.3182511031627655,0,2.0567619800567627,.6203806400299072,0,2.2222867012023926,.3597880005836487,0,1.2502825260162354,.3597880005836487,0,1.1069352626800537,.6161021590232849,0,1.1909615993499756,.3182511031627655,0,1.8090770244598389,.6244511604309082,0,1.6000981330871582,.3903929591178894,0,1.6657304763793945,.3597880005836487,0,1.7250514030456543,.3182511031627655,0,.6937260627746582,.3597880005836487,0,.7530474662780762,.3182511031627655,0,.8292484283447266,.6034226417541504,0,.6280937194824219,.3903929591178894,0,.20588254928588867,.45523056387901306,0,.21895694732666016,.3182511031627655,0,.2782778739929199,.3597880005836487,0,.34390974044799805,.3903929591178894,0,1.0370213985443115,-1.0687923431396484,0,1.1232563257217407,-1.0179616212844849,0,1.07194983959198,-1.071845293045044,0,1.171857476234436,-.961625337600708,0,2.422696352005005,.7294600009918213,0,2.3578686714172363,.409136027097702,0,2.430011034011841,.4154475927352905,0,1.4603385925292969,.7294600009918213,0,1.4580063819885254,.4154475927352905,0,1.5301475524902344,.409136027097702,0,1.3858647346496582,.409136027097702,0,.8042540550231934,.2670442759990692,0,.48331475257873535,-.24241268634796143,0,.4561147689819336,-.167608380317688,0,.9808909893035889,.16801297664642334,0,.5105149745941162,-.3172166347503662,0,.8279612064361572,.4593247175216675,0,.5362305641174316,.6049805283546448,0,.3201141357421875,.2064121961593628,0,.29291391372680664,.28121626377105713,0,.34731411933898926,.13160812854766846,0,.3745143413543701,.05680394172668457,0,.2657136917114258,.35602033138275146,0,.23851394653320312,.43082451820373535,0,.5921152830123901,-.5416291952133179,0,.5649151802062988,-.46682488918304443,0,1.1691113710403442,.032357096672058105,0,.619315505027771,-.6164330244064331,0,.25237417221069336,.5036211013793945,0,2.50215220451355,.409136027097702,0,2.28791880607605,.3903929591178894,0,1.3159146308898926,.3903929591178894,0,1.139754295349121,.2670442759990692,0,.5581436157226562,.409136027097702,0,.48598194122314453,.7294600009918213,0,.48600196838378906,.4154475927352905,0,.4138603210449219,.409136027097702,0,1.0180602073669434,-1.1231476068496704,0,1.312314510345459,-.8676869869232178,0,1.217634916305542,-.9029723405838013,0,1.2604795694351196,-.8421438932418823,0,1.3369625806808472,-.7145525813102722,0,1.3002873659133911,-.7792869806289673,0,.5377151966094971,-.3920208215713501,0,.39203500747680664,.740469217300415,0,.2664320468902588,.5724073648452759,0,.6465156078338623,-.6912373304367065,0,1.867143154144287,.07214100658893585,0,1.9475038051605225,.0723152831196785,0,2.0208740234375,.07214100658893585,0,.8927822113037109,.3136688470840454,0,1.9475038051605225,.6224343776702881,0,.42891478538513184,-.0928041934967041,0,.401714563369751,-.018000245094299316,0,2.8391480445861816,.07214100658893585,0,1.6879560947418213,-.09714114665985107,0,1.5141394138336182,-.074379101395607,0,1.4005693197250366,-.5800793766975403,0,1.5170000791549683,-.5500015616416931,0,1.427348256111145,-.510664701461792,0,1.4506888389587402,-.4400198757648468,0,1.370416522026062,-.64809650182724,0,1.2733500003814697,-.12094151973724365,0,2.748262405395508,.2670442759990692,0,1.6039998531341553,-.3680014908313751,0,2.820404529571533,.14209088683128357,0,1.6761947870254517,-.1909068524837494,0,1.5086658000946045,-.14857754111289978,0,1.6488007307052612,-.28220051527023315,0,2.789799690246582,.20772334933280945,0,1.4995577335357666,-.222417950630188,0,1.4705342054367065,-.3683149218559265,0,1.4868369102478027,-.295722633600235,0,1.7762587070465088,.2670442759990692,0,1.9475038051605225,.2676903009414673,0,.3302426338195801,.8515806794166565,0,.9677410125732422,.609684407711029,0,.41930580139160156,.9603158831596375,0,.9684958457946777,.2676903009414673,0,.8951396942138672,.07214100658893585,0,.9684619903564453,.0723152831196785,0,1.0488700866699219,.07214100658893585,0,.03499937057495117,.0710105150938034,0,.0017132759094238281,.06980825215578079,0,.07686519622802734,.07214100658893585,0,.006850719451904297,.13944919407367706,0,.04113149642944336,.1399879902601242,0,.09560823440551758,.14209088683128357,0,.0468134880065918,.20765890181064606,0,.015398025512695312,.20875416696071625,0,.12621307373046875,.20772334933280945,0,1.9475038051605225,.1424344778060913,0,1.8484001159667969,.14209088683128357,0,2.039616823196411,.14209088683128357,0,1.9475038051605225,.208225816488266,0,1.817795753479004,.20772334933280945,0,2.0702219009399414,.20772334933280945,0,.8457908630371094,.20772334933280945,0,.9684805870056152,.208225816488266,0,1.0982177257537842,.20772334933280945,0,.9684691429138184,.1424344778060913,0,.8763959407806396,.14209088683128357,0,1.067612648010254,.14209088683128357,0,.05865049362182617,.2739625871181488,0,.16774988174438477,.2670442759990692,0,.2808830738067627,.6371978521347046,0,.29592323303222656,.6980167627334595,0,.31174707412719727,.7548977732658386,0,.32854604721069336,.8078837990760803,0,.3465108871459961,.857027530670166,0,.3658285140991211,.9023910164833069,0,.38668203353881836,.9440451860427856,0,.4092531204223633,.9820696115493774,0,.4337158203125,1.0165529251098633,0,.46024370193481445,1.047592282295227,0,.4869999885559082,1.0399985313415527,0,.4890012741088867,1.0752934217453003,0,.5201516151428223,1.0997694730758667,0,.46727561950683594,1.054158329963684,0,.4167017936706543,1.0060076713562012,0,.36855077743530273,.9554333686828613,0,.27050018310546875,.801498532295227,0,.3229403495788574,.902557373046875,0,.27997827529907227,.8475069999694824,0,.23976945877075195,.7904149293899536,0,.20241069793701172,.7314187288284302,0,.14949989318847656,.5664985179901123,0,.16799163818359375,.6706603765487671,0,.1365952491760254,.6082863807678223,0,.10829734802246094,.5444470047950745,0,.08316516876220703,.4792960286140442,0,.06126070022583008,.4129903018474579,0,.08684968948364258,.4098225235939026,0,.027336597442626953,.27755624055862427,0,.042636871337890625,.34568968415260315,0],[.2197294682264328,1.481149435043335,0,.14777812361717224,1.5002686977386475,0,.14859063923358917,1.5085171461105347,0,.22243838012218475,1.4994101524353027,0,.2893359065055847,1.45444655418396,0,.2957502603530884,1.4866902828216553,0,.3557826578617096,1.420224905014038,0,.3683496117591858,1.4703893661499023,0,.4182245135307312,1.3785665035247803,0,.4400615990161896,1.4505459070205688,0,.4757751226425171,1.3295717239379883,0,.5107135772705078,1.4272083044052124,0,.5274941325187683,1.2733585834503174,0,.5801351070404053,1.4004316329956055,0,.5723733305931091,1.2100632190704346,0,.6481587290763855,1.3702819347381592,0,.6093156337738037,1.1398370265960693,0,.7146211862564087,1.3368308544158936,0,.6371104717254639,1.0628502368927002,0,.7793620228767395,1.300159215927124,0,.6544033288955688,.9792876243591309,0,.842225193977356,1.2603552341461182,0,.6581543684005737,.8953964710235596,0,.9030598998069763,1.217515230178833,0,.07843261957168579,1.5117590427398682,0,.0743848979473114,1.5139906406402588,0,0,1.515592336654663,0,0,1.5158166885375977,0,-.07438208907842636,1.5137666463851929,0,-.0743848979473114,1.5139906406402588,0,-.1485850214958191,1.5082941055297852,0,-.14859063923358917,1.5085171461105347,0,-.22242997586727142,1.4991884231567383,0,-.22243838012218475,1.4994101524353027,0,-.2957390248775482,1.4864706993103027,0,-.2957502603530884,1.4866902828216553,0,-.36833566427230835,1.47017240524292,0,-.3683496117591858,1.4703893661499023,0,-.44004496932029724,1.4503320455551147,0,-.4400615990161896,1.4505459070205688,0,-.5106942057609558,1.426997423171997,0,-.5107135772705078,1.4272083044052124,0,-.5801131129264832,1.400225043296814,0,-.5801351070404053,1.4004316329956055,0,-.6481342315673828,1.370079755783081,0,-.6481587290763855,1.3702819347381592,0,-.714594304561615,1.336633324623108,0,-.7146211862564087,1.3368308544158936,0,-.7793324589729309,1.2999670505523682,0,-.7793620228767395,1.300159215927124,0,-.8421934843063354,1.2601691484451294,0,-.842225193977356,1.2603552341461182,0,-.9030256271362305,1.2173354625701904,0,-.9030598998069763,1.217515230178833,0,-.9616818428039551,1.1715688705444336,0,-.9617183208465576,1.1717422008514404,0,-1.0180219411849976,1.1229803562164307,0,-1.0180602073669434,1.1231460571289062,0,-1.0719091892242432,1.071685552597046,0,-1.07194983959198,1.0718439817428589,0,-1.123213768005371,1.0178096294403076,0,-1.1232563257217407,1.0179600715637207,0,-1.1718133687973022,.9614818096160889,0,-1.171857476234436,.9616237878799438,0,-1.217589020729065,.902837336063385,0,-1.217634916305542,.9029708504676819,0,-1.2604318857192993,.8420178890228271,0,-1.2604795694351196,.8421424031257629,0,-1.3002382516860962,.7791703343391418,0,-1.3002873659133911,.7792854905128479,0,-1.3369123935699463,.7144455313682556,0,-1.3369625806808472,.7145510911941528,0,-1.3703646659851074,.6479992866516113,0,-1.370416522026062,.6480950117111206,0,-1.4005162715911865,.5799922347068787,0,-1.4005693197250366,.5800778865814209,0,-1.4272942543029785,.5105878114700317,0,-1.427348256111145,.5106632113456726,0,-1.4506337642669678,.43995335698127747,0,-1.4506888389587402,.4400183856487274,0,-1.4704785346984863,.36825910210609436,0,-1.4705342054367065,.36831343173980713,0,-1.4867808818817139,.2956774830818176,0,-1.4868369102478027,.2957211434841156,0,-1.4995012283325195,.22238361835479736,0,-1.4995577335357666,.2224164605140686,0,-1.5086088180541992,.14855413138866425,0,-1.5086658000946045,.1485760509967804,0,-1.5140823125839233,.07436586916446686,0,-1.5141394138336182,.07437683641910553,0,-1.5159083604812622,-7.450580596923828e-7,0,-1.5159657001495361,-7.450580596923828e-7,0,.6602792739868164,.8063466548919678,0,.9617183208465576,1.1717422008514404,0,1.3713022470474243,-.1870468556880951,0,1.3371813297271729,-.20295771956443787,0,1.4444284439086914,-.32039982080459595,0,1.402141809463501,-.16545268893241882,0,1.0978572368621826,-.13883137702941895,0,1.066178798675537,-.3226248025894165,0,1.1244792938232422,-.16545268893241882,0,1.1553187370300293,-.1870468556880951,0,.6499950885772705,-.1870468556880951,0,.6191561222076416,-.16545268893241882,0,.5722286701202393,-.32039982080459595,0,.9389283657073975,-.32404983043670654,0,.8659772872924805,-.1870468556880951,0,.8318562507629395,-.20295771956443787,0,.8968169689178467,-.16545268893241882,0,.3606534004211426,-.1870468556880951,0,.42920351028442383,-.31432482600212097,0,.3914933204650879,-.16545268893241882,0,.32653236389160156,-.20295771956443787,0,.10364341735839844,-.23673981428146362,0,.1446700096130371,-.1870468556880951,0,.1138315200805664,-.16545268893241882,0,.17879104614257812,-.20295771956443787,0,1.064000129699707,1.0860000848770142,0,1.07194983959198,1.0718439817428589,0,1.1232563257217407,1.0179600715637207,0,1.171857476234436,.9616237878799438,0,1.2627203464508057,-.3793506920337677,0,1.2633106708526611,-.2159830629825592,0,1.2258052825927734,-.21270179748535156,0,.7560138702392578,-.3793506920337677,0,.7954907417297363,-.21270179748535156,0,.7579865455627441,-.2159830629825592,0,.7204813957214355,-.21270179748535156,0,.41811466217041016,-.13883137702941895,0,.4744713306427002,.35808491706848145,0,1.007335901260376,-.12987804412841797,0,.44792747497558594,.29404759407043457,0,.5010154247283936,.4221222400665283,0,.8849854469299316,-.37709009647369385,0,.6085443496704102,-.500696063041687,0,.31520795822143555,-.026139259338378906,0,.2886638641357422,-.09017658233642578,0,.3417520523071289,.03789806365966797,0,.36829566955566406,.1019355058670044,0,.26212000846862793,-.1542140245437622,0,.23557615280151367,-.21825134754180908,0,.580647349357605,.614234447479248,0,1.180266261100769,-.006272077560424805,0,.5541033744812012,.5501971244812012,0,.6071914434432983,.6782717704772949,0,.2500929832458496,-.2802811861038208,0,1.3008158206939697,-.21270179748535156,0,1.1894400119781494,-.20295771956443787,0,.6841154098510742,-.20295771956443787,0,.592534065246582,-.13883137702941895,0,.29016733169555664,-.21270179748535156,0,.24930715560913086,-.3793506920337677,0,.25266218185424805,-.2159830629825592,0,.21515655517578125,-.21270179748535156,0,1.0180602073669434,1.1231460571289062,0,1.2839999198913574,.9160000681877136,0,1.217634916305542,.9029708504676819,0,1.2604795694351196,.8421424031257629,0,1.3369625806808472,.7145510911941528,0,1.3002873659133911,.7792854905128479,0,.5275595188140869,.4861595630645752,0,.4705994129180908,-.606242299079895,0,.26480674743652344,-.3383007049560547,0,.6337354183197021,.7423090934753418,0,.9706873893737793,-.03750533610582352,0,1.0093600749969482,-.03760776296257973,0,1.0093600749969482,-7.450580596923828e-7,0,.9739689826965332,-7.450580596923828e-7,0,1.0506091117858887,-.03750533610582352,0,1.0473272800445557,-7.450580596923828e-7,0,1.0093600749969482,-.32369279861450195,0,.9345166683197021,-.25348401069641113,0,.4213836193084717,.2300102710723877,0,.3948395252227783,.16597282886505127,0,1.4760125875473022,-.03750533610582352,0,1.5278027057647705,.0019437521696090698,0,1.5240004062652588,-7.450580596923828e-7,0,1.479293942451477,-7.450580596923828e-7,0,1.5141394138336182,.07437761127948761,0,1.515882968902588,-7.450580596923828e-7,0,1.4005693197250366,.5800778865814209,0,1.427348256111145,.5106632113456726,0,1.4299999475479126,.6469999551773071,0,1.4506888389587402,.4400183856487274,0,1.370416522026062,.6480950117111206,0,1.3597257137298584,.08390522003173828,0,1.4287623167037964,-.13883137702941895,0,1.4800002574920654,.3639999330043793,0,1.4662680625915527,-.07387077808380127,0,1.5328621864318848,.0032358169555664062,0,1.5086658000946045,.1485760509967804,0,1.5322520732879639,.051729023456573486,0,1.4503566026687622,-.10799169540405273,0,1.4995577335357666,.2224164605140686,0,1.4705342054367065,.36831343173980713,0,1.4868369102478027,.2957211434841156,0,.9234387874603271,-.13883137702941895,0,1.0093600749969482,-.1392109990119934,0,.49984216690063477,-.31706228852272034,0,.3583993911743164,-.6478481888771057,0,.32419919967651367,-.6394542455673218,0,.5027446746826172,-.1392109990119934,0,.4653639793395996,-.03750533610582352,0,.5026154518127441,-.03760776296257973,0,.5026063919067383,-7.450580596923828e-7,0,.4686453342437744,-7.450580596923828e-7,0,.5452852249145508,-.03750533610582352,0,.5420036315917969,-7.450580596923828e-7,0,.015664100646972656,-.037118010222911835,0,.005298614501953125,-7.450580596923828e-7,0,0,0,0,.0008902549743652344,-.03629259392619133,0,.036679744720458984,-7.450580596923828e-7,0,.03995990753173828,-.03750533610582352,0,.0035619735717773438,-.0724974200129509,0,.016933441162109375,-.07341998815536499,0,.049704551696777344,-.07387077808380127,0,.008005142211914062,-.10852760076522827,0,.019116878509521484,-.10860654711723328,0,.06561517715454102,-.10799169540405273,0,1.0093600749969482,-.0740726888179779,0,.9609441757202148,-.07387077808380127,0,1.0603532791137695,-.07387077808380127,0,1.0093600749969482,-.10828696191310883,0,.945033073425293,-.10799169540405273,0,1.0762643814086914,-.10799169540405273,0,.5026860237121582,-.10828696191310883,0,.4397091865539551,-.10799169540405273,0,.570939302444458,-.10799169540405273,0,.5026416778564453,-.0740726888179779,0,.45561957359313965,-.07387077808380127,0,.5550289154052734,-.07387077808380127,0,.022809982299804688,-.14607708156108856,0,.08720970153808594,-.13883137702941895,0,.2956104278564453,-.44237661361694336,0,.27991414070129395,-.39232444763183594,0,.3120903968811035,-.4884908199310303,0,.3295454978942871,-.5307101011276245,0,.34816646575927734,-.569087028503418,0,.36814022064208984,-.6036838293075562,0,.3896498680114746,-.6345711946487427,0,.41287660598754883,-.6618288159370422,0,.3652958869934082,-.6371991038322449,0,.3287010192871094,-.615058183670044,0,.25330018997192383,-.5888343453407288,0,.2704153060913086,-.571747362613678,0,.29903507232666016,-.5940822958946228,0,.24292659759521484,-.5480351448059082,0,.21663475036621094,-.523002564907074,0,.19160127639770508,-.4967101812362671,0,.12843704223632812,-.4426250159740448,0,.16789007186889648,-.46922093629837036,0,.1455550193786621,-.44060152769088745,0,.12465143203735352,-.4109206199645996,0,.10522890090942383,-.3802497386932373,0,.06556272506713867,-.31537503004074097,0,.08733463287353516,-.34866276383399963,0,.07101249694824219,-.3162357807159424,0,.05630064010620117,-.2830471098423004,0,.04323530197143555,-.2491765022277832,0,.03212404251098633,-.2163746953010559,0,.03184843063354492,-.21470555663108826,0,.014211654663085938,-.1442963182926178,0,.02216625213623047,-.17971743643283844,0,.2197294682264328,-1.4811509847640991,0,.22243838012218475,-1.499411702156067,0,.14859063923358917,-1.5085186958312988,0,.14777812361717224,-1.5002702474594116,0,.2893359065055847,-1.4544481039047241,0,.2957502603530884,-1.486691951751709,0,.3557826578617096,-1.4202264547348022,0,.3683496117591858,-1.470391035079956,0,.4182245135307312,-1.3785680532455444,0,.4400615990161896,-1.450547456741333,0,.4757751226425171,-1.3295732736587524,0,.5107135772705078,-1.4272096157073975,0,.5274941325187683,-1.2733598947525024,0,.5801351070404053,-1.4004331827163696,0,.5723733305931091,-1.2100647687911987,0,.6481587290763855,-1.3702834844589233,0,.6093156337738037,-1.1398385763168335,0,.7146211862564087,-1.3368322849273682,0,.6371104717254639,-1.0628515481948853,0,.7793620228767395,-1.300160527229309,0,.6544033288955688,-.9792889356613159,0,.842225193977356,-1.2603566646575928,0,.6581543684005737,-.8953980207443237,0,.9030598998069763,-1.2175167798995972,0,.0743848979473114,-1.513992190361023,0,.07843261957168579,-1.5117605924606323,0,0,-1.5158181190490723,0,0,-1.5155938863754272,0,-.0743848979473114,-1.513992190361023,0,-.07438208907842636,-1.513768196105957,0,-.14859063923358917,-1.5085186958312988,0,-.1485850214958191,-1.5082956552505493,0,-.22243838012218475,-1.499411702156067,0,-.22242997586727142,-1.4991899728775024,0,-.2957502603530884,-1.486691951751709,0,-.2957390248775482,-1.4864723682403564,0,-.3683496117591858,-1.470391035079956,0,-.36833566427230835,-1.4701738357543945,0,-.4400615990161896,-1.450547456741333,0,-.44004496932029724,-1.4503334760665894,0,-.5107135772705078,-1.4272096157073975,0,-.5106942057609558,-1.4269990921020508,0,-.5801351070404053,-1.4004331827163696,0,-.5801131129264832,-1.400226354598999,0,-.6481587290763855,-1.3702834844589233,0,-.6481342315673828,-1.3700810670852661,0,-.7146211862564087,-1.3368322849273682,0,-.714594304561615,-1.3366347551345825,0,-.7793620228767395,-1.300160527229309,0,-.7793324589729309,-1.2999687194824219,0,-.842225193977356,-1.2603566646575928,0,-.8421934843063354,-1.260170578956604,0,-.9030598998069763,-1.2175167798995972,0,-.9030256271362305,-1.217336893081665,0,-.9617183208465576,-1.1717437505722046,0,-.9616818428039551,-1.1715703010559082,0,-1.0180602073669434,-1.1231476068496704,0,-1.0180219411849976,-1.1229817867279053,0,-1.07194983959198,-1.071845293045044,0,-1.0719091892242432,-1.0716869831085205,0,-1.1232563257217407,-1.0179616212844849,0,-1.123213768005371,-1.0178110599517822,0,-1.171857476234436,-.961625337600708,0,-1.1718133687973022,-.9614832401275635,0,-1.217634916305542,-.9029723405838013,0,-1.217589020729065,-.9028388261795044,0,-1.2604795694351196,-.8421438932418823,0,-1.2604318857192993,-.8420193791389465,0,-1.3002873659133911,-.7792869806289673,0,-1.3002382516860962,-.7791718244552612,0,-1.3369625806808472,-.7145525813102722,0,-1.3369123935699463,-.714447021484375,0,-1.370416522026062,-.64809650182724,0,-1.3703646659851074,-.6480007767677307,0,-1.4005693197250366,-.5800793766975403,0,-1.4005162715911865,-.579993724822998,0,-1.427348256111145,-.510664701461792,0,-1.4272942543029785,-.5105893015861511,0,-1.4506888389587402,-.4400198757648468,0,-1.4506337642669678,-.43995484709739685,0,-1.4705342054367065,-.3683149218559265,0,-1.4704785346984863,-.36826059222221375,0,-1.4868369102478027,-.295722633600235,0,-1.4867808818817139,-.295678973197937,0,-1.4995577335357666,-.222417950630188,0,-1.4995012283325195,-.22238510847091675,0,-1.5086658000946045,-.14857754111289978,0,-1.5086088180541992,-.14855562150478363,0,-1.5141394138336182,-.07437832653522491,0,-1.5140823125839233,-.07436735928058624,0,.6602792739868164,-.8063479661941528,0,.9617183208465576,-1.1717437505722046,0,1.3713022470474243,.1870453655719757,0,1.4444284439086914,.32039833068847656,0,1.3371813297271729,.20295622944831848,0,1.402141809463501,.16545119881629944,0,1.0978572368621826,.13882988691329956,0,1.1244792938232422,.16545119881629944,0,1.066178798675537,.3226233124732971,0,1.1553187370300293,.1870453655719757,0,.6499950885772705,.1870453655719757,0,.5722286701202393,.32039833068847656,0,.6191561222076416,.16545119881629944,0,.9389283657073975,.32404834032058716,0,.8318562507629395,.20295622944831848,0,.8659772872924805,.1870453655719757,0,.8968169689178467,.16545119881629944,0,.3606534004211426,.1870453655719757,0,.3914933204650879,.16545119881629944,0,.42920351028442383,.3143233358860016,0,.32653236389160156,.20295622944831848,0,.10364341735839844,.23673832416534424,0,.1138315200805664,.16545119881629944,0,.1446700096130371,.1870453655719757,0,.17879104614257812,.20295622944831848,0,1.064000129699707,-1.0860013961791992,0,1.1232563257217407,-1.0179616212844849,0,1.07194983959198,-1.071845293045044,0,1.171857476234436,-.961625337600708,0,1.2627203464508057,.3793492019176483,0,1.2258052825927734,.21270030736923218,0,1.2633106708526611,.21598157286643982,0,.7560138702392578,.3793492019176483,0,.7579865455627441,.21598157286643982,0,.7954907417297363,.21270030736923218,0,.7204813957214355,.21270030736923218,0,.41811466217041016,.13882988691329956,0,.4744713306427002,-.3580864667892456,0,.44792747497558594,-.29404914379119873,0,1.007335901260376,.12987661361694336,0,.5010154247283936,-.4221237897872925,0,.8849854469299316,.37708866596221924,0,.6085443496704102,.5006946325302124,0,.31520795822143555,.026137709617614746,0,.2886638641357422,.09017515182495117,0,.3417520523071289,-.03789961338043213,0,.36829566955566406,-.101936936378479,0,.26212000846862793,.15421247482299805,0,.23557615280151367,.21824991703033447,0,.580647349357605,-.6142359972000122,0,.5541033744812012,-.5501984357833862,0,1.180266261100769,.006270647048950195,0,.6071914434432983,-.6782733201980591,0,.2500929832458496,.28027963638305664,0,1.3008158206939697,.21270030736923218,0,1.1894400119781494,.20295622944831848,0,.6841154098510742,.20295622944831848,0,.592534065246582,.13882988691329956,0,.29016733169555664,.21270030736923218,0,.24930715560913086,.3793492019176483,0,.25266218185424805,.21598157286643982,0,.21515655517578125,.21270030736923218,0,1.0180602073669434,-1.1231476068496704,0,1.2839999198913574,-.916001558303833,0,1.217634916305542,-.9029723405838013,0,1.2604795694351196,-.8421438932418823,0,1.3369625806808472,-.7145525813102722,0,1.3002873659133911,-.7792869806289673,0,.5275595188140869,-.48616111278533936,0,.4705994129180908,.6062408089637756,0,.26480674743652344,.3382991552352905,0,.6337354183197021,-.742310643196106,0,.9706873893737793,.03750384598970413,0,1.0093600749969482,.03760627284646034,0,1.0506091117858887,.03750384598970413,0,.9345166683197021,.253482460975647,0,1.0093600749969482,.32369130849838257,0,.4213836193084717,-.2300117015838623,0,.3948395252227783,-.16597437858581543,0,1.4760125875473022,.03750384598970413,0,1.5278027057647705,-.0019452422857284546,0,1.5141394138336182,-.074379101395607,0,1.4005693197250366,-.5800793766975403,0,1.4299999475479126,-.6470014452934265,0,1.427348256111145,-.510664701461792,0,1.4506888389587402,-.4400198757648468,0,1.370416522026062,-.64809650182724,0,1.3597257137298584,-.08390676975250244,0,1.4287623167037964,.13882988691329956,0,1.4800002574920654,-.36400142312049866,0,1.4662680625915527,.07386928796768188,0,1.5328623056411743,-.003237307071685791,0,1.5086658000946045,-.14857754111289978,0,1.5322521924972534,-.05173051357269287,0,1.4503566026687622,.10799020528793335,0,1.4995577335357666,-.222417950630188,0,1.4705342054367065,-.3683149218559265,0,1.4868369102478027,-.295722633600235,0,.9234387874603271,.13882988691329956,0,1.0093600749969482,.13920950889587402,0,.3583993911743164,.6478466987609863,0,.49984216690063477,.31706079840660095,0,.32419919967651367,.6394528150558472,0,.5027446746826172,.13920950889587402,0,.4653639793395996,.03750384598970413,0,.5026154518127441,.03760627284646034,0,.5452852249145508,.03750384598970413,0,.015664100646972656,.03711652010679245,0,.0008902549743652344,.036291103810071945,0,.03995990753173828,.03750384598970413,0,.0035619735717773438,.07249592989683151,0,.016933441162109375,.0734184980392456,0,.049704551696777344,.07386928796768188,0,.019116878509521484,.10860505700111389,0,.008005142211914062,.10852611064910889,0,.06561517715454102,.10799020528793335,0,1.0093600749969482,.07407119870185852,0,.9609441757202148,.07386928796768188,0,1.0603532791137695,.07386928796768188,0,1.0093600749969482,.10828547179698944,0,.945033073425293,.10799020528793335,0,1.0762643814086914,.10799020528793335,0,.4397091865539551,.10799020528793335,0,.5026860237121582,.10828547179698944,0,.570939302444458,.10799020528793335,0,.5026416778564453,.07407119870185852,0,.45561957359313965,.07386928796768188,0,.5550289154052734,.07386928796768188,0,.022809982299804688,.14607559144496918,0,.08720970153808594,.13882988691329956,0,.27991414070129395,.39232301712036133,0,.2956104278564453,.4423750638961792,0,.3120903968811035,.4884892702102661,0,.3295454978942871,.5307085514068604,0,.34816646575927734,.5690855979919434,0,.36814022064208984,.6036823391914368,0,.3896498680114746,.6345696449279785,0,.41287660598754883,.6618273258209229,0,.3652958869934082,.6371976137161255,0,.3287010192871094,.6150566935539246,0,.25330018997192383,.5888328552246094,0,.29903507232666016,.5940808057785034,0,.2704153060913086,.5717458724975586,0,.24292659759521484,.5480336546897888,0,.21663475036621094,.5230010747909546,0,.19160127639770508,.49670863151550293,0,.12843704223632812,.4426235258579254,0,.16789007186889648,.469219446182251,0,.1455550193786621,.44060003757476807,0,.12465143203735352,.4109191298484802,0,.10522890090942383,.3802482485771179,0,.06556272506713867,.3153735399246216,0,.08733463287353516,.34866127371788025,0,.07101249694824219,.316234290599823,0,.05630064010620117,.28304561972618103,0,.04323530197143555,.24917501211166382,0,.03184843063354492,.21470406651496887,0,.03212404251098633,.21637320518493652,0,.014211654663085938,.1442948281764984,0,.02216625213623047,.17971594631671906,0],[.09637947380542755,-1.1260777711868286,0,.021446362137794495,-1.1154718399047852,0,-.10822245478630066,-1.0986930131912231,0,-.16200768947601318,-1.092059850692749,0,.17009270191192627,-1.136683702468872,0,-.21540266275405884,-1.0827958583831787,0,.242141991853714,-1.147289514541626,0,-.26827874779701233,-1.0709233283996582,0,.31204938888549805,-1.1578954458236694,0,-.3205084204673767,-1.0564707517623901,0,.3792908191680908,-1.1685014963150024,0,-.37196603417396545,-1.0394731760025024,0,.44328397512435913,-1.179107427597046,0,-.422527551651001,-1.019971251487732,0,.5033714175224304,-1.1897133588790894,0,-.47207111120224,-.998012363910675,0,.5587998628616333,-1.2003192901611328,0,-.5204774141311646,-.9736491441726685,0,.6086952686309814,-1.2109252214431763,0,-.5676298141479492,-.9469401240348816,0,.6520301103591919,-1.2215310335159302,0,-.6134148836135864,-.917949914932251,0,.6875805854797363,-1.2321369647979736,0,-.6577221155166626,-.8867483735084534,0,-.050129327923059464,-1.1048659086227417,0,-.05417648330330849,-1.1026790142059326,0,0,-1.104188323020935,0,0,-1.1040090322494507,0,.05417986586689949,-1.102858304977417,0,.05417648330330849,-1.1026790142059326,0,.10822921991348267,-1.0988714694976807,0,.10822245478630066,-1.0986930131912231,0,.162017822265625,-1.0922372341156006,0,.16200768947601318,-1.092059850692749,0,.21541611850261688,-1.0829716920852661,0,.21540266275405884,-1.0827958583831787,0,.2682954668998718,-1.0710973739624023,0,.26827874779701233,-1.0709233283996582,0,.32052844762802124,-1.0566424131393433,0,.3205084204673767,-1.0564707517623901,0,.37198927998542786,-1.0396418571472168,0,.37196603417396545,-1.0394731760025024,0,.4225538969039917,-1.020137071609497,0,.422527551651001,-1.019971251487732,0,.4721006453037262,-.9981744289398193,0,.47207111120224,-.998012363910675,0,.5205100178718567,-.9738072752952576,0,.5204774141311646,-.9736491441726685,0,.5676653981208801,-.9470939636230469,0,.5676298141479492,-.9469401240348816,0,.6134532690048218,-.9180991053581238,0,.6134148836135864,-.917949914932251,0,.6577632427215576,-.8868923187255859,0,.6577221155166626,-.8867483735084534,0,.7004885673522949,-.8535491228103638,0,.7004446983337402,-.8534104824066162,0,.7415264248847961,-.8181495666503906,0,.7414801120758057,-.818016767501831,0,.7807778120040894,-.7807790637016296,0,.7807291150093079,-.7806522846221924,0,.8181482553482056,-.7415276765823364,0,.8180971145629883,-.7414071559906006,0,.8535478115081787,-.7004896402359009,0,.8534945249557495,-.7003759741783142,0,.8868910074234009,-.6577642560005188,0,.8868356347084045,-.6576573252677917,0,.9180976152420044,-.6134541630744934,0,.9180402159690857,-.6133545637130737,0,.9470924735069275,-.5676663517951965,0,.9470332264900208,-.567574143409729,0,.9738056659698486,-.5205107927322388,0,.9737448692321777,-.5204262137413025,0,.9981728792190552,-.4721013307571411,0,.9981105327606201,-.4720246493816376,0,1.0201354026794434,-.422554612159729,0,1.0200716257095337,-.42248597741127014,0,1.0396403074264526,-.3719898760318756,0,1.039575457572937,-.37192943692207336,0,1.0566407442092896,-.32052895426750183,0,1.0565747022628784,-.3204768896102905,0,1.071095585823059,-.26829588413238525,0,1.0710285902023315,-.26825234293937683,0,1.0829699039459229,-.21541647613048553,0,1.0829023122787476,-.21538150310516357,0,1.0922353267669678,-.1620180904865265,0,1.0921671390533447,-.16199177503585815,0,1.0988696813583374,-.1082293912768364,0,1.0988010168075562,-.10821183770895004,0,1.1028565168380737,-.05417997017502785,0,1.1027876138687134,-.05417116731405258,0,1.1041866540908813,-6.360002089422778e-7,0,1.104117512702942,-6.360002089422778e-7,0,.7138700485229492,-1.2427430152893066,0,-.7004446983337402,-.8534104824066162,0,2.6377081871032715,-.3597858250141144,0,2.5720760822296143,-.39039045572280884,0,2.765000343322754,-.6290000081062317,0,2.6970279216766357,-.31824934482574463,0,2.111737012863159,-.26704302430152893,0,2.0389997959136963,-.6144999265670776,0,2.1629436016082764,-.31824934482574463,0,2.222263813018799,-.3597858250141144,0,1.2502696514129639,-.3597858250141144,0,1.1909492015838623,-.31824934482574463,0,1.1055352687835693,-.6146638989448547,0,1.7660000324249268,-.597000002861023,0,1.6657137870788574,-.3597858250141144,0,1.6000819206237793,-.39039045572280884,0,1.7250337600708008,-.31824934482574463,0,.6937189102172852,-.3597858250141144,0,.8280830383300781,-.6018584370613098,0,.7530393600463867,-.31824934482574463,0,.628087043762207,-.39039045572280884,0,.2065892219543457,-.4541683495044708,0,.2782745361328125,-.3597858250141144,0,.21895456314086914,-.31824934482574463,0,.3439064025878906,-.39039045572280884,0,-.6869999766349792,-.8100000023841858,0,-.7807291150093079,-.7806522846221924,0,-.8180971145629883,-.7414071559906006,0,-.8534945249557495,-.7003759741783142,0,2.4301931858062744,-.7488768696784973,0,2.429985761642456,-.41544485092163086,0,2.357844829559326,-.40913331508636475,0,1.458113193511963,-.7277568578720093,0,1.5301322937011719,-.40913331508636475,0,1.457991600036621,-.41544485092163086,0,1.385850429534912,-.40913331508636475,0,.8042459487915039,-.26704302430152893,0,.9600982666015625,-1.3169844150543213,0,1.477936029434204,-1.3460599184036255,0,.9952738285064697,-1.3275903463363647,0,.9249229431152344,-1.3063786029815674,0,1.675985336303711,-1.3920599222183228,0,1.4227449893951416,-1.3710598945617676,0,1.1711506843566895,-1.380620002746582,0,1.2063260078430176,-1.3912259340286255,0,1.1359753608703613,-1.3700140714645386,0,1.1008000373840332,-1.3594081401824951,0,1.241502046585083,-1.4018319845199585,0,1.276677131652832,-1.412437915802002,0,.8193963766098022,-1.274560809135437,0,1.0966664552688599,-1.3140599727630615,0,.8545718193054199,-1.285166621208191,0,.7842210531234741,-1.2639548778533936,0,1.3529131412506104,-1.4210362434387207,0,2.502126932144165,-.40913331508636475,0,2.287895441055298,-.39039045572280884,0,1.3159008026123047,-.39039045572280884,0,1.1397428512573242,-.26704302430152893,0,.558138370513916,-.40913331508636475,0,.48603391647338867,-.7277568578720093,0,.48599720001220703,-.41544485092163086,0,.41385650634765625,-.40913331508636475,0,-.7414801120758057,-.818016767501831,0,-.8454679250717163,-.6309999227523804,0,-.8868356347084045,-.6576573252677917,0,-.9180402159690857,-.6133545637130737,0,-.9737448692321777,-.5204262137413025,0,-.9470332264900208,-.567574143409729,0,.8897473812103271,-1.2957725524902344,0,1.18399977684021,-1.3630000352859497,0,1.2832715511322021,-1.4158990383148193,0,.7490456104278564,-1.2533488273620605,0,1.867124080657959,-.07214176654815674,0,1.9441397190093994,-.07214803248643875,0,1.9441397190093994,-6.360002089422778e-7,0,1.8734357357025146,-6.360002089422778e-7,0,2.020853042602539,-.07214176654815674,0,2.0145413875579834,-6.360002089422778e-7,0,1.9218170642852783,-.60589998960495,0,1.5153169631958008,-1.3580598831176758,0,1.0304491519927979,-1.3381963968276978,0,1.065624475479126,-1.3488022089004517,0,2.8391189575195312,-.07214176654815674,0,-1.0542360544204712,-.05123956874012947,0,-1.0563511848449707,.0005963172297924757,0,2.8454298973083496,-6.360002089422778e-7,0,-1.1027876138687134,-.05417116731405258,0,-1.104117512702942,-6.360002089422778e-7,0,-1.0200716257095337,-.42248597741127014,0,-1.039575457572937,-.37192943692207336,0,-.9839358925819397,-.39999979734420776,0,-1.0565747022628784,-.3204768896102905,0,-.9981105327606201,-.4720246493816376,0,.7133500576019287,-1.3140599727630615,0,2.748234272003174,-.26704302430152893,0,-1.0464036464691162,-.20799972116947174,0,2.820375919342041,-.14209091663360596,0,-1.0516961812973022,-.10313661396503448,0,-1.0988010168075562,-.10821183770895004,0,-1.049049735069275,-.1551274210214615,0,2.78977108001709,-.2077227234840393,0,-1.0921671390533447,-.16199177503585815,0,-1.0710285902023315,-.26825234293937683,0,-1.0829023122787476,-.21538150310516357,0,1.776240587234497,-.26704302430152893,0,1.9441397190093994,-.26706641912460327,0,.9666671752929688,-.608261227607727,0,.9110002517700195,-1.2920000553131104,0,.7160000801086426,-1.1710000038146973,0,.9666671752929688,-.26706641912460327,0,.8951301574707031,-.07214176654815674,0,.9666671752929688,-.07214803248643875,0,.9666671752929688,-6.360002089422778e-7,0,.9014418125152588,-6.360002089422778e-7,0,1.0488591194152832,-.07214176654815674,0,1.0425472259521484,-6.360002089422778e-7,0,.035805702209472656,-.07093658298254013,0,.029125213623046875,-6.360002089422778e-7,0,0,0,0,.0017132759094238281,-.06980903446674347,0,.07055330276489258,-6.360002089422778e-7,0,.07686424255371094,-.07214176654815674,0,.006850242614746094,-.13944925367832184,0,.04222297668457031,-.1404605507850647,0,.09560728073120117,-.14209091663360596,0,.015398025512695312,-.2087535262107849,0,.04835796356201172,-.20907364785671234,0,.12621164321899414,-.2077227234840393,0,1.9441397190093994,-.14210332930088043,0,1.848381519317627,-.14209091663360596,0,2.03959584236145,-.14209091663360596,0,1.9441397190093994,-.2077409029006958,0,1.817777156829834,-.2077227234840393,0,2.0702009201049805,-.2077227234840393,0,.9666671752929688,-.2077409029006958,0,.8457822799682617,-.2077227234840393,0,1.0982062816619873,-.2077227234840393,0,.9666671752929688,-.14210332930088043,0,.876387357711792,-.14209091663360596,0,1.0676021575927734,-.14209091663360596,0,.06171846389770508,-.2775159776210785,0,.16774845123291016,-.26704302430152893,0,1.1451630592346191,-1.3954122066497803,0,1.2139663696289062,-1.4073508977890015,0,1.0770297050476074,-1.3801120519638062,0,1.0097074508666992,-1.361436128616333,0,.9434027671813965,-1.3395318984985352,0,.8782529830932617,-1.314400553703308,0,.8144135475158691,-1.2861027717590332,0,.7520408630371094,-1.254706859588623,0,.6912827491760254,-1.2202879190444946,0,.6322875022888184,-1.182929277420044,0,.4759998321533203,-1.024999976158142,0,.520146369934082,-1.0997596979141235,0,.5751957893371582,-1.1427210569381714,0,.4672708511352539,-1.0541491508483887,0,.41669702529907227,-1.0059988498687744,0,.3685469627380371,-.9554252028465271,0,.26649999618530273,-.7900000810623169,0,.32293701171875,-.9025496244430542,0,.27997541427612305,-.8474998474121094,0,.23976707458496094,-.7904084324836731,0,.2024083137512207,-.7314127683639526,0,.14349985122680664,-.5609999895095825,0,.16798973083496094,-.6706550121307373,0,.13659381866455078,-.608281672000885,0,.10829591751098633,-.5444429516792297,0,.08316469192504883,-.4792926013469696,0,.08299970626831055,-.40550002455711365,0,.06126070022583008,-.41298753023147583,0,.027336597442626953,-.2775549292564392,0,.04263639450073242,-.3456876277923584,0,.09637947380542755,1.1260764598846436,0,-.16200768947601318,1.0920586585998535,0,-.10822245478630066,1.098691701889038,0,.021446362137794495,1.1154705286026,0,.17009270191192627,1.136682391166687,0,-.21540266275405884,1.0827945470809937,0,.242141991853714,1.1472883224487305,0,-.26827874779701233,1.0709220170974731,0,.31204938888549805,1.1578941345214844,0,-.3205084204673767,1.056469440460205,0,.3792908191680908,1.168500304222107,0,-.37196603417396545,1.0394718647003174,0,.44328397512435913,1.1791061162948608,0,-.422527551651001,1.0199699401855469,0,.5033714175224304,1.1897120475769043,0,-.47207111120224,.99801105260849,0,.5587998628616333,1.2003179788589478,0,-.5204774141311646,.9736478328704834,0,.6086952686309814,1.2109239101409912,0,-.5676298141479492,.9469388127326965,0,.6520301103591919,1.2215297222137451,0,-.6134148836135864,.9179486036300659,0,.6875805854797363,1.2321356534957886,0,-.6577221155166626,.8867470622062683,0,-.05417648330330849,1.1026777029037476,0,-.050129327923059464,1.1048647165298462,0,-3469446951953614e-31,1.1040078401565552,0,-3469446951953614e-31,1.10418701171875,0,.05417648330330849,1.1026777029037476,0,.05417986586689949,1.1028571128845215,0,.10822245478630066,1.098691701889038,0,.10822921991348267,1.0988701581954956,0,.16200768947601318,1.0920586585998535,0,.162017822265625,1.0922359228134155,0,.21540266275405884,1.0827945470809937,0,.21541611850261688,1.082970380783081,0,.26827874779701233,1.0709220170974731,0,.2682954668998718,1.0710960626602173,0,.3205084204673767,1.056469440460205,0,.32052844762802124,1.0566411018371582,0,.37196603417396545,1.0394718647003174,0,.37198927998542786,1.0396406650543213,0,.422527551651001,1.0199699401855469,0,.4225538969039917,1.020135760307312,0,.47207111120224,.99801105260849,0,.4721006453037262,.9981731176376343,0,.5204774141311646,.9736478328704834,0,.5205100178718567,.9738059639930725,0,.5676298141479492,.9469388127326965,0,.5676653981208801,.9470926523208618,0,.6134148836135864,.9179486036300659,0,.6134532690048218,.9180977940559387,0,.6577221155166626,.8867470622062683,0,.6577632427215576,.8868910074234009,0,.7004446983337402,.8534091711044312,0,.7004885673522949,.8535478115081787,0,.7414801120758057,.818015456199646,0,.7415264248847961,.8181482553482056,0,.7807291150093079,.7806509733200073,0,.7807778120040894,.7807778120040894,0,.8180971145629883,.7414059042930603,0,.8181482553482056,.7415263652801514,0,.8534945249557495,.7003747224807739,0,.8535478115081787,.7004883885383606,0,.8868356347084045,.6576560735702515,0,.8868910074234009,.6577629446983337,0,.9180402159690857,.6133533120155334,0,.9180976152420044,.6134528517723083,0,.9470332264900208,.567572832107544,0,.9470924735069275,.5676650404930115,0,.9737448692321777,.5204249024391174,0,.9738056659698486,.5205094814300537,0,.9981105327606201,.4720233380794525,0,.9981728792190552,.47210007905960083,0,1.0200716257095337,.42248469591140747,0,1.0201354026794434,.4225533604621887,0,1.039575457572937,.3719281852245331,0,1.0396403074264526,.37198859453201294,0,1.0565747022628784,.32047563791275024,0,1.0566407442092896,.32052770256996155,0,1.0710285902023315,.26825106143951416,0,1.071095585823059,.2682946026325226,0,1.0829023122787476,.2153802216053009,0,1.0829699039459229,.21541519463062286,0,1.0921671390533447,.16199049353599548,0,1.0922353267669678,.16201680898666382,0,1.0988010168075562,.10821057111024857,0,1.0988696813583374,.10822810977697372,0,1.1027876138687134,.054169900715351105,0,1.1028565168380737,.05417869985103607,0,.7138700485229492,1.2427417039871216,0,-.7004446983337402,.8534091711044312,0,2.6377081871032715,.3597845435142517,0,2.765000343322754,.6289987564086914,0,2.5720760822296143,.39038920402526855,0,2.6970279216766357,.31824806332588196,0,2.111737012863159,.26704174280166626,0,2.1629436016082764,.31824806332588196,0,2.0389997959136963,.6144986748695374,0,2.222263813018799,.3597845435142517,0,1.2502696514129639,.3597845435142517,0,1.1055352687835693,.6146626472473145,0,1.1909492015838623,.31824806332588196,0,1.7660000324249268,.5969987511634827,0,1.6000819206237793,.39038920402526855,0,1.6657137870788574,.3597845435142517,0,1.7250337600708008,.31824806332588196,0,.6937189102172852,.3597845435142517,0,.7530393600463867,.31824806332588196,0,.8280830383300781,.6018571853637695,0,.628087043762207,.39038920402526855,0,.2065892219543457,.45416709780693054,0,.21895456314086914,.31824806332588196,0,.2782745361328125,.3597845435142517,0,.3439064025878906,.39038920402526855,0,-.6869999766349792,.8099986910820007,0,-.8180971145629883,.7414059042930603,0,-.7807291150093079,.7806509733200073,0,-.8534945249557495,.7003747224807739,0,2.4301931858062744,.748875617980957,0,2.357844829559326,.40913206338882446,0,2.429985761642456,.4154435694217682,0,1.458113193511963,.7277555465698242,0,1.457991600036621,.4154435694217682,0,1.5301322937011719,.40913206338882446,0,1.385850429534912,.40913206338882446,0,.8042459487915039,.26704174280166626,0,.9600982666015625,1.3169831037521362,0,.9952738285064697,1.3275890350341797,0,1.477936029434204,1.3460586071014404,0,.9249229431152344,1.3063772916793823,0,1.675985336303711,1.3920586109161377,0,1.4227449893951416,1.3710585832595825,0,1.1711506843566895,1.3806188106536865,0,1.2063260078430176,1.3912246227264404,0,1.1359753608703613,1.3700127601623535,0,1.1008000373840332,1.35940682888031,0,1.241502046585083,1.4018306732177734,0,1.276677131652832,1.412436604499817,0,.8193963766098022,1.274559497833252,0,.8545718193054199,1.2851653099060059,0,1.0966664552688599,1.3140586614608765,0,.7842210531234741,1.2639535665512085,0,1.3529131412506104,1.4210349321365356,0,2.502126932144165,.40913206338882446,0,2.287895441055298,.39038920402526855,0,1.3159008026123047,.39038920402526855,0,1.1397428512573242,.26704174280166626,0,.558138370513916,.40913206338882446,0,.48603391647338867,.7277555465698242,0,.48599720001220703,.4154435694217682,0,.41385650634765625,.40913206338882446,0,-.7414801120758057,.818015456199646,0,-.8454679250717163,.6309986114501953,0,-.8868356347084045,.6576560735702515,0,-.9180402159690857,.6133533120155334,0,-.9737448692321777,.5204249024391174,0,-.9470332264900208,.567572832107544,0,.8897473812103271,1.2957712411880493,0,1.18399977684021,1.3629987239837646,0,1.2832715511322021,1.4158977270126343,0,.7490456104278564,1.253347635269165,0,1.867124080657959,.07214049249887466,0,1.9441397190093994,.07214676588773727,0,2.020853042602539,.07214049249887466,0,1.5153169631958008,1.3580585718154907,0,1.9218170642852783,.6058987379074097,0,1.0304491519927979,1.3381950855255127,0,1.065624475479126,1.3488008975982666,0,2.8391189575195312,.07214049249887466,0,-1.0570619106292725,.05241752415895462,0,-1.1027876138687134,.054169900715351105,0,-1.0200716257095337,.42248469591140747,0,-.9839358925819397,.3999984860420227,0,-1.039575457572937,.3719281852245331,0,-1.0565747022628784,.32047563791275024,0,-.9981105327606201,.4720233380794525,0,.7133500576019287,1.3140586614608765,0,2.748234272003174,.26704174280166626,0,-1.0464036464691162,.20799846947193146,0,2.820375919342041,.14208965003490448,0,-1.056502342224121,.10429912060499191,0,-1.0988010168075562,.10821057111024857,0,-1.0536071062088013,.15627716481685638,0,2.78977108001709,.20772144198417664,0,-1.0921671390533447,.16199049353599548,0,-1.0710285902023315,.26825106143951416,0,-1.0829023122787476,.2153802216053009,0,1.776240587234497,.26704174280166626,0,1.9441397190093994,.2670651376247406,0,.9110002517700195,1.2919987440109253,0,.9666671752929688,.6082599759101868,0,.7160000801086426,1.1709986925125122,0,.9666671752929688,.2670651376247406,0,.8951301574707031,.07214049249887466,0,.9666671752929688,.07214676588773727,0,1.0488591194152832,.07214049249887466,0,.035805702209472656,.07093531638383865,0,.0017132759094238281,.0698077604174614,0,.07686424255371094,.07214049249887466,0,.006850242614746094,.13944798707962036,0,.04222297668457031,.14045926928520203,0,.09560728073120117,.14208965003490448,0,.04835796356201172,.20907236635684967,0,.015398025512695312,.20875225961208344,0,.12621164321899414,.20772144198417664,0,1.9441397190093994,.14210206270217896,0,1.848381519317627,.14208965003490448,0,2.03959584236145,.14208965003490448,0,1.9441397190093994,.20773962140083313,0,1.817777156829834,.20772144198417664,0,2.0702009201049805,.20772144198417664,0,.8457822799682617,.20772144198417664,0,.9666671752929688,.20773962140083313,0,1.0982062816619873,.20772144198417664,0,.9666671752929688,.14210206270217896,0,.876387357711792,.14208965003490448,0,1.0676021575927734,.14208965003490448,0,.06171846389770508,.2775146961212158,0,.16774845123291016,.26704174280166626,0,1.2139663696289062,1.4073495864868164,0,1.1451630592346191,1.3954108953475952,0,1.0770297050476074,1.380110740661621,0,1.0097074508666992,1.361434817314148,0,.9434027671813965,1.33953058719635,0,.8782529830932617,1.314399242401123,0,.8144135475158691,1.2861015796661377,0,.7520408630371094,1.254705548286438,0,.6912827491760254,1.2202866077423096,0,.6322875022888184,1.1829280853271484,0,.4759998321533203,1.024998664855957,0,.5751957893371582,1.1427197456359863,0,.520146369934082,1.0997583866119385,0,.4672708511352539,1.0541478395462036,0,.41669702529907227,1.0059975385665894,0,.3685469627380371,.955423891544342,0,.26649999618530273,.7899987697601318,0,.32293701171875,.9025483131408691,0,.27997541427612305,.8474985361099243,0,.23976707458496094,.790407121181488,0,.2024083137512207,.7314115166664124,0,.14349985122680664,.5609987378120422,0,.16798973083496094,.670653760433197,0,.13659381866455078,.6082804203033447,0,.10829591751098633,.5444416999816895,0,.08316469192504883,.47929131984710693,0,.06126070022583008,.41298627853393555,0,.08299970626831055,.40549877285957336,0,.027336597442626953,.27755364775657654,0,.04263639450073242,.3456863462924957,0]],Md=[{id:"m_Cutout_Left",idx:0,time:10},{id:"m_Cutout_Center",idx:2,time:20},{id:"m_Cutout_Right",idx:4,time:30},{id:"m_Cutout_Stepped",idx:5,time:40},{id:"m_CoreDefault_Tip_S",idx:1,time:50},{id:"m_CoreLarge_Tip_L",idx:7,time:60},{id:"m_CoreLarge_Tip_S",idx:6,time:70},{id:"m_CoreSmall_Tip_L",idx:3,time:80},{id:"m_CoreSmall_Tip_S",idx:8,time:90}],Ad=function(t){return Math.round(1e3*t)/1e3},Pd=function(t){var e=document.createElement("div");if(Ed()?(e.innerHTML="<br>"+t,e.removeChild(e.firstChild)):e.innerHTML=t,1==e.childNodes.length)return e.removeChild(e.firstChild);for(var s=document.createDocumentFragment();e.firstChild;)s.appendChild(e.firstChild);return s},Ed=function(){var t=window.navigator.userAgent,e=t.indexOf("MSIE "),s=t.indexOf("Trident/");return e>0||s>0};class Material{constructor({...t}){const{color:e,depth:s,graphicsDevice:i}=t;this.color=new Color(Ad(e.r/255),Ad(e.g/255),Ad(e.b/255)),this.depth=s,this.graphicsDevice=i,this.init()}init(){this.createMaterial()}getMaterial(){return this.material}updateMaterial(){this.material.update()}createMaterial(){this.material=new StandardMaterial,this.material.diffuse=this.color,this.material.depthTest=!0,this.material.depthWrite=!0,this.material.cull=0,this.material.blendType=2,this.material.update()}}const Ld={blank:{r:255,g:0,b:0},blade1:{r:159,g:132,b:189},blade2:{r:235,g:195,b:219},blade3:{r:230,g:228,b:206},blade4:{r:13,g:31,b:45},blade5:{r:158,g:163,b:176},blade6:{r:228,g:195,b:173},blade7:{r:208,g:0,b:0},blade8:{r:63,g:136,b:197},blade9:{r:19,g:111,b:99},blade10:{r:214,g:246,b:221},blade11:{r:244,g:152,b:156},blade12:{r:172,g:236,b:247},blade13:{r:255,g:164,b:108},blade14:{r:105,g:221,b:255},blade15:{r:216,g:225,b:255},blade16:{r:190,g:146,b:162}};class EventHandle{constructor(t,e,s){this.owner=t,this.name=e,this.fn=s}unbind(){this.owner&&(this.owner.unbind(this.name,this.fn),this.owner=null,this.name=null,this.fn=null)}call(){this.fn&&this.fn.call(this.owner,arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}on(t,e){return this.owner.on(t,e)}}class Events{constructor(){Object.defineProperty(this,"_events",{enumerable:!1,configurable:!1,writable:!0,value:{}}),this._suspendEvents=!1,this._additionalEmitters=[]}get suspendEvents(){return this._suspendEvents}set suspendEvents(t){this._suspendEvents=!!t}on(t,e){const s=this._events[t];return void 0===s?this._events[t]=[e]:-1===s.indexOf(e)&&s.push(e),new EventHandle(this,t,e)}once(t,e){const s=this.on(t,((t,i,n,a,r,o,l,h)=>{e.call(this,t,i,n,a,r,o,l,h),s.unbind()}));return s}emit(t,e,s,i,n,a,r,o,l){if(this._suspendEvents)return;let h=this._events[t];if(h&&h.length){h=h.slice(0);for(let d=0;d<h.length;d++)if(h[d])try{h[d].call(this,e,s,i,n,a,r,o,l)}catch(c){console.info("%c%s %c(event error)","color: #06f",t,"color: #f00"),console.log(c.stack)}}if(this._additionalEmitters.length){this._additionalEmitters.slice().forEach((h=>{h.emit(t,e,s,i,n,a,r,o,l)}))}return this}unbind(t,e){if(t){const s=this._events[t];if(!s)return this;if(e){const i=s.indexOf(e);-1!==i&&(1===s.length?delete this._events[t]:s.splice(i,1))}else delete this._events[t]}else this._events={};return this}addEmitter(t){this._additionalEmitters.includes(t)||this._additionalEmitters.push(t)}removeEmitter(t){const e=this._additionalEmitters.indexOf(t);-1!==e&&this._additionalEmitters.splice(e,1)}}class Observer extends Events{constructor(t,e={}){if(super(),this._destroyed=!1,this._path="",this._keys=[],this._data={},this._pathsWithDuplicates=null,e.pathsWithDuplicates){this._pathsWithDuplicates={};for(let t=0;t<e.pathsWithDuplicates.length;t++)this._pathsWithDuplicates[e.pathsWithDuplicates[t]]=!0}this.patch(t),this._parent=e.parent||null,this._parentPath=e.parentPath||"",this._parentField=e.parentField||null,this._parentKey=e.parentKey||null,this._latestFn=e.latestFn||null,this._silent=!1;const s=function(t){return function(e,s,i,n){if(!this._parent)return;let a,r=this._parentKey;!r&&this._parentField instanceof Array&&(r=this._parentField.indexOf(this),-1===r)||(e=this._parentPath+"."+r+"."+e,this._silent&&(a=this._parent.silence()),this._parent.emit(e+":"+t,s,i,n),this._parent.emit("*:"+t,e,s,i,n),this._silent&&this._parent.silenceRestore(a))}};this.on("*:set",s("set")),this.on("*:unset",s("unset")),this.on("*:insert",s("insert")),this.on("*:remove",s("remove")),this.on("*:move",s("move"))}static _splitPath(t){const e=Observer._splitPathsCache;let s=e[t];return s?s=s.slice():(s=t.split("."),e[t]=s),s}silence(){this._silent=!0;const t=this.history&&this.history.enabled;t&&(this.history.enabled=!1);const e=this.sync&&this.sync.enabled;return e&&(this.sync.enabled=!1),[t,e]}silenceRestore(t){this._silent=!1,t[0]&&(this.history.enabled=!0),t[1]&&(this.sync.enabled=!0)}_prepare(t,e,s,i,n){let a,r;const o=(t._path?t._path+".":"")+e,l=typeof s;if(t._keys.push(e),"object"===l&&s instanceof Array){for(t._data[e]=s.slice(0),a=0;a<t._data[e].length;a++)"object"==typeof t._data[e][a]&&null!==t._data[e][a]?t._data[e][a]instanceof Array?t._data[e][a].slice(0):t._data[e][a]=new Observer(t._data[e][a],{parent:this,parentPath:o,parentField:t._data[e],parentKey:null}):(r=this.silence(),this.emit(o+"."+a+":set",t._data[e][a],null,n),this.emit("*:set",o+"."+a,t._data[e][a],null,n),this.silenceRestore(r));i&&(r=this.silence()),this.emit(o+":set",t._data[e],null,n),this.emit("*:set",o,t._data[e],null,n),i&&this.silenceRestore(r)}else if("object"===l&&s instanceof Object){for(a in"object"!=typeof t._data[e]&&(t._data[e]={_path:o,_keys:[],_data:{}}),s)"object"==typeof s[a]?this._prepare(t._data[e],a,s[a],!0,n):(r=this.silence(),t._data[e]._data[a]=s[a],t._data[e]._keys.push(a),this.emit(o+"."+a+":set",s[a],null,n),this.emit("*:set",o+"."+a,s[a],null,n),this.silenceRestore(r));i&&(r=this.silence()),this.emit(o+":set",s,void 0,n),this.emit("*:set",o,s,void 0,n),i&&this.silenceRestore(r)}else i&&(r=this.silence()),t._data[e]=s,this.emit(o+":set",s,void 0,n),this.emit("*:set",o,s,void 0,n),i&&this.silenceRestore(r);return!0}set(t,e,s,i,n){let a,r,o=Observer._splitPath(t);const l=o.length,h=o[l-1];let c,d,u=this,p="",m=this;for(a=0;a<l-1;a++)u instanceof Array?(u=u[o[a]],u instanceof Observer&&(t=o.slice(a+1).join("."),m=u)):(a<l&&"object"!=typeof u._data[o[a]]&&(u._data[o[a]]&&m.unset((u.__path?u.__path+".":"")+o[a]),u._data[o[a]]={_path:t,_keys:[],_data:{}},u._keys.push(o[a])),a===l-1&&u.__path&&(p=u.__path+"."+o[a]),u=u._data[o[a]]);if(u instanceof Array){const a=parseInt(h,10);if(u[a]===e&&!n)return;return r=u[a],r=r instanceof Observer?r.json():m.json(r),u[a]=e,e instanceof Observer&&(e._parent=m,e._parentPath=p,e._parentField=u,e._parentKey=null),s&&(c=m.silence()),m.emit(t+":set",e,r,i),m.emit("*:set",t,e,r,i),s&&m.silenceRestore(c),!0}if(u._data&&!u._data.hasOwnProperty(h))return"object"==typeof e?m._prepare(u,h,e,!1,i):(u._data[h]=e,u._keys.push(h),s&&(c=m.silence()),m.emit(t+":set",e,null,i),m.emit("*:set",t,e,null,i),s&&m.silenceRestore(c),!0);if("object"==typeof e&&e instanceof Array){if(e.equals(u._data[h])&&!n)return!1;if(r=u._data[h],r instanceof Observer||(r=m.json(r)),u._data[h]&&u._data[h].length===e.length){for(c=m.silence(),0===e.length&&(u._data[h]=e),a=0;a<u._data[h].length;a++)u._data[h][a]instanceof Observer?u._data[h][a].patch(e[a],!0):u._data[h][a]!==e[a]&&(u._data[h][a]=e[a],m.emit(t+"."+a+":set",u._data[h][a],r&&r[a]||null,i),m.emit("*:set",t+"."+a,u._data[h][a],r&&r[a]||null,i));m.silenceRestore(c)}else{for(u._data[h]=[],e.forEach((t=>{this._doInsert(u,h,t,void 0,!0)})),c=m.silence(),a=0;a<u._data[h].length;a++)m.emit(t+"."+a+":set",u._data[h][a],r&&r[a]||null,i),m.emit("*:set",t+"."+a,u._data[h][a],r&&r[a]||null,i);m.silenceRestore(c)}return s&&(c=m.silence()),m.emit(t+":set",e,r,i),m.emit("*:set",t,e,r,i),s&&m.silenceRestore(c),!0}if("object"==typeof e&&e instanceof Object){let n,l=!1;r=u._data[h],r instanceof Observer||(r=m.json(r)),o=Object.keys(e),u._data[h]&&u._data[h]._data||(u._data[h]?m.unset((u.__path?u.__path+".":"")+h):l=!0,u._data[h]={_path:t,_keys:[],_data:{}});for(const s in u._data[h]._data)e.hasOwnProperty(s)?u._data[h]._data.hasOwnProperty(s)?m._equals(u._data[h]._data[s],e[s])||(n=m.set(t+"."+s,e[s],!0),n&&(l=!0)):(n=m._prepare(u._data[h],s,e[s],!0,i),n&&(l=!0)):(n=m.unset(t+"."+s,!0),n&&(l=!0));for(a=0;a<o.length;a++)void 0===e[o[a]]&&u._data[h]._data.hasOwnProperty(o[a])?(n=m.unset(t+"."+o[a],!0),n&&(l=!0)):"object"==typeof e[o[a]]?u._data[h]._data.hasOwnProperty(o[a])?(n=m.set(t+"."+o[a],e[o[a]],!0),n&&(l=!0)):(n=m._prepare(u._data[h],o[a],e[o[a]],!0,i),n&&(l=!0)):m._equals(u._data[h]._data[o[a]],e[o[a]])||("object"==typeof e[o[a]]?(n=m.set(u._data[h]._path+"."+o[a],e[o[a]],!0),n&&(l=!0)):u._data[h]._data[o[a]]!==e[o[a]]&&(l=!0,-1===u._data[h]._keys.indexOf(o[a])&&u._data[h]._keys.push(o[a]),u._data[h]._data[o[a]]=e[o[a]],c=m.silence(),m.emit(u._data[h]._path+"."+o[a]+":set",u._data[h]._data[o[a]],null,i),m.emit("*:set",u._data[h]._path+"."+o[a],u._data[h]._data[o[a]],null,i),m.silenceRestore(c)));if(l){s&&(c=m.silence());const t=m.json(u._data[h]);return m.emit(u._data[h]._path+":set",t,r,i),m.emit("*:set",u._data[h]._path,t,r,i),s&&m.silenceRestore(c),!0}return!1}return d=!u.hasOwnProperty("_data")&&u.hasOwnProperty(h)?u:u._data,!(d[h]===e&&!n)&&(s&&(c=m.silence()),r=d[h],r instanceof Observer||(r=m.json(r)),d[h]=e,m.emit(t+":set",e,r,i),m.emit("*:set",t,e,r,i),s&&m.silenceRestore(c),!0)}has(t){const e=Observer._splitPath(t);let s=this;for(let i=0,n=e.length;i<n;i++){if(null==s)return;s=s._data?s._data[e[i]]:s[e[i]]}return void 0!==s}get(t,e){const s=Observer._splitPath(t);let i=this;for(let n=0;n<s.length;n++){if(null==i)return;i=i._data?i._data[s[n]]:i[s[n]]}return e?i:null==i?null:this.json(i)}getRaw(t){return this.get(t,!0)}_equals(t,e){return t===e||!!(t instanceof Array&&e instanceof Array&&t.equals(e))}unset(t,e,s){let i;const n=Observer._splitPath(t),a=n[n.length-1];let r=this,o=this;for(i=0;i<n.length-1;i++)r instanceof Array?(r=r[n[i]],r instanceof Observer&&(t=n.slice(i+1).join("."),o=r)):r=r._data[n[i]];if(!r._data||!r._data.hasOwnProperty(a))return!1;let l,h=r._data[a];if(h instanceof Observer||(h=o.json(h)),r._data[a]&&r._data[a]._data)for(i=r._data[a]._keys.length-1;i>=0;i--)o.unset(t+"."+r._data[a]._keys[i],!0);return r._keys.splice(r._keys.indexOf(a),1),delete r._data[a],e&&(l=o.silence()),o.emit(t+":unset",h,s),o.emit("*:unset",t,h,s),e&&o.silenceRestore(l),!0}remove(t,e,s,i){const n=Observer._splitPath(t),a=n[n.length-1];let r=this,o=this;for(let d=0;d<n.length-1;d++)if(r instanceof Array)r=r[parseInt(n[d],10)],r instanceof Observer&&(t=n.slice(d+1).join("."),o=r);else{if(!r._data||!r._data.hasOwnProperty(n[d]))return;r=r._data[n[d]]}if(!(r._data&&r._data.hasOwnProperty(a)&&r._data[a]instanceof Array))return;const l=r._data[a];if(l.length<e)return;let h,c=l[e];return c instanceof Observer?c._parent=null:c=o.json(c),l.splice(e,1),s&&(h=o.silence()),o.emit(t+":remove",c,e,i),o.emit("*:remove",t,c,e,i),s&&o.silenceRestore(h),!0}removeValue(t,e,s,i){const n=Observer._splitPath(t),a=n[n.length-1];let r=this,o=this;for(let d=0;d<n.length-1;d++)if(r instanceof Array)r=r[parseInt(n[d],10)],r instanceof Observer&&(t=n.slice(d+1).join("."),o=r);else{if(!r._data||!r._data.hasOwnProperty(n[d]))return;r=r._data[n[d]]}if(!(r._data&&r._data.hasOwnProperty(a)&&r._data[a]instanceof Array))return;const l=r._data[a],h=l.indexOf(e);if(-1===h)return;if(l.length<h)return;let c;return(e=l[h])instanceof Observer?e._parent=null:e=o.json(e),l.splice(h,1),s&&(c=o.silence()),o.emit(t+":remove",e,h,i),o.emit("*:remove",t,e,h,i),s&&o.silenceRestore(c),!0}insert(t,e,s,i,n){const a=Observer._splitPath(t),r=a[a.length-1];let o=this,l=this;for(let d=0;d<a.length-1;d++)if(o instanceof Array)o=o[parseInt(a[d],10)],o instanceof Observer&&(t=a.slice(d+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(a[d]))return;o=o._data[a[d]]}if(!(o._data&&o._data.hasOwnProperty(r)&&o._data[r]instanceof Array))return;const h=o._data[r];let c;return e=l._doInsert(o,r,e,s),void 0===s&&(s=h.length-1),i&&(c=l.silence()),l.emit(t+":insert",e,s,n),l.emit("*:insert",t,e,s,n),i&&l.silenceRestore(c),!0}_doInsert(t,e,s,i,n){const a=t._data[e];"object"!=typeof s||s instanceof Observer||null===s||(s=s instanceof Array?s.slice(0):new Observer(s));const r=t._path?`${t._path}.${e}`:e;if(null===s||n||this._pathsWithDuplicates&&this._pathsWithDuplicates[r]||-1===a.indexOf(s))return void 0===i?a.push(s):a.splice(i,0,s),s instanceof Observer?(s._parent=this,s._parentPath=r,s._parentField=a,s._parentKey=null):s=this.json(s),s}move(t,e,s,i,n){const a=Observer._splitPath(t),r=a[a.length-1];let o=this,l=this;for(let u=0;u<a.length-1;u++)if(o instanceof Array)o=o[parseInt(a[u],10)],o instanceof Observer&&(t=a.slice(u+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(a[u]))return;o=o._data[a[u]]}if(!(o._data&&o._data.hasOwnProperty(r)&&o._data[r]instanceof Array))return;const h=o._data[r];if(h.length<e||h.length<s||e===s)return;let c,d=h[e];return h.splice(e,1),-1===s&&(s=h.length),h.splice(s,0,d),d instanceof Observer||(d=l.json(d)),i&&(c=l.silence()),l.emit(t+":move",d,s,e,n),l.emit("*:move",t,d,s,e,n),i&&l.silenceRestore(c),!0}patch(t,e){if("object"==typeof t){for(const e in t)"object"!=typeof t[e]||this._data.hasOwnProperty(e)?this._data[e]!==t[e]&&this.set(e,t[e]):this._prepare(this,e,t[e]);if(e)for(const e in this._data)t.hasOwnProperty(e)||this.unset(e)}}json(t){let e,s,i={};const n=void 0===t?this:t;let a,r;if(n instanceof Object&&n._keys){a=n._keys.length;for(let t=0;t<a;t++){e=n._keys[t];const a=n._data[e],o=typeof a;if("object"===o&&a instanceof Array)for(i[e]=a.slice(0),r=i[e].length,s=0;s<r;s++)"object"==typeof i[e][s]&&(i[e][s]=this.json(i[e][s]));else i[e]="object"===o&&a instanceof Object?this.json(a):a}}else{if(null===n)return null;if("object"==typeof n&&n instanceof Array)for(i=n.slice(0),a=i.length,s=0;s<a;s++)i[s]=this.json(i[s]);else if("object"==typeof n)for(e in n)n.hasOwnProperty(e)&&(i[e]=n[e]);else i=n}return i}forEach(t,e,s=""){const i=e||this;for(let n=0;n<i._keys.length;n++){const e=i._keys[n],a=i._data[e],r=this.schema&&this.schema.has(s+e)&&this.schema.get(s+e).type.name.toLowerCase()||typeof a;"object"===r&&a instanceof Array?t(s+e,"array",a,e):"object"===r&&a instanceof Object?(t(s+e,"object",a,e),this.forEach(t,a,s+e+".")):t(s+e,r,a,e)}}latest(){return this._latestFn?this._latestFn():this}destroy(){this._destroyed||(this._destroyed=!0,this.emit("destroy"),this.unbind())}get latestFn(){return this._latestFn}set latestFn(t){this._latestFn=t}}function Rd(t){if(!t||"undefined"==typeof window)return;const e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=t,document.head.appendChild(e),t}Observer._splitPathsCache={};var Id="pcui-flex",Dd="pcui-grid",kd="pcui-hidden",Fd="pcui-scrollable",Od="pcui-resizable",Vd="pcui-readonly",Bd="pcui-disabled",zd="pcui-collapsible",Ud="pcui-collapsed",Nd="pcui-focus",Hd="pcui-multiple-values",Wd="pcui-error",Gd="flash",jd="font-bold";Rd('@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .font-icon {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular, .pcui-element {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon {\n  font-family: "pc-icon";\n}\n\n.fixedFont {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n@-webkit-keyframes pcui-flash-animation {\n  from {\n    outline-color: #f60;\n  }\n  to {\n    outline-color: rgba(255, 102, 0, 0);\n  }\n}\n@keyframes pcui-flash-animation {\n  from {\n    outline-color: #f60;\n  }\n  to {\n    outline-color: rgba(255, 102, 0, 0);\n  }\n}\n.noSelect {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-element {\n  border: 0 solid #232e30;\n}\n.pcui-element.flash {\n  outline: 1px solid #f60;\n  -webkit-animation: pcui-flash-animation 200ms ease-in-out forwards;\n  animation: pcui-flash-animation 200ms ease-in-out forwards;\n}\n.pcui-element:focus {\n  outline: none;\n}\n.pcui-element::-moz-focus-inner {\n  border: 0;\n}\n\n.pcui-element.pcui-hidden {\n  display: none;\n}');const Xd=["flexDirection","flexGrow","flexBasis","flexShrink","flexWrap","alignItems","alignSelf","justifyContent","justifySelf"],qd={};class Element$1 extends Events{constructor(t,e){if(super(),e||(e={}),this._destroyed=!1,this._parent=null,this._domEventClick=this._onClick.bind(this),this._domEventMouseOver=this._onMouseOver.bind(this),this._domEventMouseOut=this._onMouseOut.bind(this),this._eventsParent=[],this._dom=t||e.dom||document.createElement("div"),void 0!==e.id&&(this._dom.id=e.id),this._dom.ui=this,this._dom.addEventListener("click",this._domEventClick),this._dom.addEventListener("mouseover",this._domEventMouseOver),this._dom.addEventListener("mouseout",this._domEventMouseOut),this._dom.classList.add("pcui-element"),this._dom.classList.add("font-regular"),e.class)if(Array.isArray(e.class))for(let s=0;s<e.class.length;s++)this._dom.classList.add(e.class[s]);else this._dom.classList.add(e.class);this.enabled=void 0===e.enabled||e.enabled,this._hiddenParents=!e.isRoot,this.hidden=e.hidden||!1,this.readOnly=e.readOnly||!1,this.ignoreParent=e.ignoreParent||!1,void 0!==e.width&&(this.width=e.width),void 0!==e.height&&(this.height=e.height),void 0!==e.tabIndex&&(this.tabIndex=e.tabIndex);for(const s in e)void 0!==e[s]&&-1!==Xd.indexOf(s)&&(this[s]=e[s]);e.binding&&(this.binding=e.binding),this._flashTimeout=null}link(t,e){this._binding&&this._binding.link(t,e)}unlink(){this._binding&&this._binding.unlink()}flash(){this._flashTimeout||(this.classAdd(Gd),this._flashTimeout=setTimeout(function(){this._flashTimeout=null,this.classRemove(Gd)}.bind(this),200))}_onClick(t){this.enabled&&this.emit("click",t)}_onMouseOver(t){this.emit("hover",t)}_onMouseOut(t){this.emit("hoverend",t)}_onHiddenToRootChange(t){t?this.emit("hideToRoot"):this.emit("showToRoot")}_onEnabledChange(t){t?this.classRemove(Bd):this.classAdd(Bd),this.emit(t?"enable":"disable")}_onParentDestroy(){this.destroy()}_onParentDisable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!1)}_onParentEnable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!0)}_onParentShowToRoot(){const t=this.hiddenToRoot;this._hiddenParents=!1,t!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onParentHideToRoot(){const t=this.hiddenToRoot;this._hiddenParents=!0,t!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onReadOnlyChange(t){t?this.classAdd(Vd):this.classRemove(Vd),this.emit("readOnly",t)}_onParentReadOnlyChange(t){this._ignoreParent||(t?this._readOnly||this._onReadOnlyChange(!0):this._readOnly||this._onReadOnlyChange(!1))}classAdd(t){var e=this._dom.classList;e.contains(t)||e.add(t)}classRemove(t){var e=this._dom.classList;e.contains(t)&&e.remove(t)}destroy(){if(this._destroyed)return;if(this._destroyed=!0,this.binding?this.binding=null:this.unlink(),this.parent){const t=this.parent;for(let e=0;e<this._eventsParent.length;e++)this._eventsParent[e].unbind();this._eventsParent.length=0,t.remove&&!t._destroyed&&t.remove(this),this._parent=null,!t._destroyed&&this._dom&&this._dom.parentElement&&this._dom.parentElement.removeChild(this._dom)}const t=this._dom;t&&(t.removeEventListener("click",this._domEventClick),t.removeEventListener("mouseover",this._domEventMouseOver),t.removeEventListener("mouseout",this._domEventMouseOut),delete t.ui,this._dom=null),this._domEventClick=null,this._domEventMouseOver=null,this._domEventMouseOut=null,this._flashTimeout&&clearTimeout(this._flashTimeout),this.emit("destroy",t,this),this.unbind()}static register(t,e,s){qd[t]={cls:e,defaultArguments:s}}static unregister(t){delete qd[t]}static create(t,e){const s=qd[t];if(!s)return void console.error("Invalid type passed to pcui.Element#create",t);const i=s.cls,n={};return s.defaultArguments&&Object.assign(n,s.defaultArguments),e&&Object.assign(n,e),new i(n)}set enabled(t){if(this._enabled===t)return;const e=this.enabled;this._enabled=t,e!==t&&this._onEnabledChange(t)}get enabled(){return this._ignoreParent?this._enabled:this._enabled&&(!this._parent||this._parent.enabled)}set ignoreParent(t){this._ignoreParent=t,this._onEnabledChange(this.enabled),this._onReadOnlyChange(this.readOnly)}get ignoreParent(){return this._ignoreParent}get dom(){return this._dom}set parent(t){if(t===this._parent)return;const e=this.enabled,s=this.readOnly,i=this.hiddenToRoot;if(this._parent){for(let t=0;t<this._eventsParent.length;t++)this._eventsParent[t].unbind();this._eventsParent.length=0}this._parent=t,this._parent?(this._eventsParent.push(this._parent.once("destroy",this._onParentDestroy.bind(this))),this._eventsParent.push(this._parent.on("disable",this._onParentDisable.bind(this))),this._eventsParent.push(this._parent.on("enable",this._onParentEnable.bind(this))),this._eventsParent.push(this._parent.on("readOnly",this._onParentReadOnlyChange.bind(this))),this._eventsParent.push(this._parent.on("showToRoot",this._onParentShowToRoot.bind(this))),this._eventsParent.push(this._parent.on("hideToRoot",this._onParentHideToRoot.bind(this))),this._hiddenParents=this._parent.hiddenToRoot):this._hiddenParents=!0,this.emit("parent",this._parent);const n=this.enabled;n!==e&&this._onEnabledChange(n);const a=this.readOnly;a!==s&&this._onReadOnlyChange(a);const r=this.hiddenToRoot;r!==i&&this._onHiddenToRootChange(r)}get parent(){return this._parent}set hidden(t){if(t===this._hidden)return;const e=this.hiddenToRoot;this._hidden=t,t?this.classAdd(kd):this.classRemove(kd),this.emit(t?"hide":"show"),this.hiddenToRoot!==e&&this._onHiddenToRootChange(this.hiddenToRoot)}get hidden(){return this._hidden}get hiddenToRoot(){return this._hidden||this._hiddenParents}set readOnly(t){this._readOnly!==t&&(this._readOnly=t,this._onReadOnlyChange(t))}get readOnly(){return this._ignoreParent?this._readOnly:this._readOnly||!(!this._parent||!this._parent.readOnly)}set error(t){this._hasError!==t&&(this._hasError=t,t?this.classAdd(Wd):this.classRemove(Wd))}get error(){return this._hasError}get style(){return this._dom.style}get class(){return this._dom.classList}set width(t){"number"==typeof t&&(t+="px"),this.style.width=t}get width(){return this._dom.clientWidth}set height(t){"number"==typeof t&&(t+="px"),this.style.height=t}get height(){return this._dom.clientHeight}set tabIndex(t){this._dom.tabIndex=t}get tabIndex(){return this._dom.tabIndex}set binding(t){if(this._binding===t)return;let e,s;this._binding&&(e=this._binding.observers,s=this._binding.paths,this.unlink(),this._binding.element=null,this._binding=null),this._binding=t,this._binding&&(this._binding.element=this,e&&s&&this.link(e,s))}get binding(){return this._binding}get destroyed(){return this._destroyed}set disabled(t){this.enabled=!t}get disabled(){return!this.enabled}set element(t){this.dom=t}get element(){return this.dom}set innerElement(t){this.domContent=t}get innerElement(){return this.domContent}}Xd.forEach((function(t){Object.defineProperty(Element$1.prototype,t,{get:function(){return this.style[t]},set:function(e){this.style[t]=e}})})),Rd('@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .font-icon {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon {\n  font-family: "pc-icon";\n}\n\n.fixedFont, .pcui-text-input.pcui-multiple-values:before, .pcui-text-input > input {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.noSelect {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-text-input {\n  display: inline-block;\n  border: 1px solid #293538;\n  border-radius: 2px;\n  box-sizing: border-box;\n  margin: 6px;\n  min-height: 24px;\n  height: 24px;\n  background-color: #2c393c;\n  vertical-align: top;\n  transition: color 100ms, background-color 100ms, box-shadow 100ms;\n  position: relative;\n  color: #b1b8ba;\n}\n.pcui-text-input > input {\n  height: 100%;\n  width: calc(100% - 16px);\n  padding: 0 6px;\n  line-height: 1;\n  color: inherit;\n  background: transparent;\n  border: none;\n  outline: none;\n  box-shadow: none;\n}\n.pcui-text-input:before {\n  color: inherit;\n}\n\n.pcui-text-input.pcui-multiple-values:before {\n  position: absolute;\n  padding: 0 8px;\n  content: "...";\n  white-space: nowrap;\n  top: 5px;\n  font-size: 12px;\n}\n\n.pcui-text-input:not(.pcui-disabled):not(.pcui-readonly):hover {\n  background-color: #293538;\n  color: #ffffff;\n}\n.pcui-text-input:not(.pcui-disabled):not(.pcui-readonly):not(.pcui-error):hover {\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-text-input:not(.pcui-disabled):not(.pcui-readonly).pcui-focus {\n  background-color: #20292b;\n  box-shadow: 0 0 0 1px rgba(255, 102, 0, 0.3);\n}\n\n.pcui-text-input.pcui-focus:after, .pcui-text-input.pcui-focus:before, .pcui-text-input:hover:after, .pcui-text-input:hover:before {\n  display: none;\n}\n\n.pcui-text-input.pcui-readonly {\n  background-color: rgba(44, 57, 60, 0.7);\n  border-color: transparent;\n}\n\n.pcui-text-input.pcui-disabled {\n  color: #5b7073;\n}\n\n.pcui-text-input.pcui-error {\n  color: #b1b8ba;\n  box-shadow: 0 0 0 1px #d34141;\n}\n\n.pcui-text-input[placeholder] {\n  position: relative;\n}\n.pcui-text-input[placeholder]:after {\n  content: attr(placeholder);\n  background-color: #2c393c;\n  position: absolute;\n  top: 0;\n  right: 0;\n  padding: 0 8px;\n  line-height: 22px;\n  font-size: 10px;\n  font-weight: 600;\n  white-space: nowrap;\n  color: #829193;\n  pointer-events: none;\n}');class TextInput extends Element$1{constructor(t){t||(t={}),super(t.dom?t.dom:document.createElement("div"),t),this.class.add("pcui-text-input");let e=t.input;e||(e=document.createElement("input"),e.type="text"),e.ui=this,e.tabIndex=0,e.autocomplete="off",this._domInput=e,this._domEvtChange=this._onInputChange.bind(this),this._domEvtFocus=this._onInputFocus.bind(this),this._domEvtBlur=this._onInputBlur.bind(this),this._domEvtKeyDown=this._onInputKeyDown.bind(this),this._domEvtKeyUp=this._onInputKeyUp.bind(this),this._domEvtCtxMenu=this._onInputCtxMenu.bind(this),this._domInput.addEventListener("change",this._domEvtChange),this._domInput.addEventListener("focus",this._domEvtFocus),this._domInput.addEventListener("blur",this._domEvtBlur),this._domInput.addEventListener("keydown",this._domEvtKeyDown),this._domInput.addEventListener("contextmenu",this._domEvtCtxMenu,!1),this.dom.appendChild(this._domInput),this._suspendInputChangeEvt=!1,void 0!==t.value&&(this.value=t.value),this.placeholder=t.placeholder||null,this.renderChanges=t.renderChanges||!1,this.blurOnEnter=void 0===t.blurOnEnter||t.blurOnEnter,this.blurOnEscape=void 0===t.blurOnEscape||t.blurOnEscape,this.keyChange=t.keyChange||!1,this._prevValue=null,t.onValidate&&(this.onValidate=t.onValidate),this.on("change",(()=>{this.renderChanges&&this.flash()})),this.on("disable",this._updateInputReadOnly.bind(this)),this.on("enable",this._updateInputReadOnly.bind(this)),this.on("readOnly",this._updateInputReadOnly.bind(this)),this._updateInputReadOnly()}_onInputChange(t){if(!this._suspendInputChangeEvt){if(this._onValidate){const t=!this._onValidate(this.value);if(this.error=t,t)return}else this.error=!1;this.emit("change",this.value),this._binding&&this._binding.setValue(this.value)}}_onInputFocus(t){this.class.add(Nd),this.emit("focus",t),this._prevValue=this.value}_onInputBlur(t){this.class.remove(Nd),this.emit("blur",t)}_onInputKeyDown(t){if(13===t.keyCode&&this.blurOnEnter)this._suspendInputChangeEvt=this.keyChange,this._domInput.blur(),this._suspendInputChangeEvt=!1;else if(27===t.keyCode){this._suspendInputChangeEvt=!0;const e=this._domInput.value;this._domInput.value=this._prevValue,this._suspendInputChangeEvt=!1,this.keyChange&&e!==this._prevValue&&this._onInputChange(t),this.blurOnEscape&&this._domInput.blur()}this.emit("keydown",t)}_onInputKeyUp(t){27!==t.keyCode&&this._onInputChange(t),this.emit("keyup",t)}_onInputCtxMenu(t){this._domInput.select()}_updateInputReadOnly(){!this.enabled||this.readOnly?this._domInput.setAttribute("readonly",!0):this._domInput.removeAttribute("readonly")}_updateValue(t){if(this.class.remove(Hd),t&&"object"==typeof t)if(Array.isArray(t)){let e=!1;for(let s=0;s<t.length;s++)if(t[s]&&"object"==typeof t[s]){e=!0;break}t=e?"[Not available]":t.map((t=>null===t?"null":t)).join(",")}else t="[Not available]";return t!==this.value&&(this._suspendInputChangeEvt=!0,this._domInput.value=null==t?"":t,this._suspendInputChangeEvt=!1,this.emit("change",t),!0)}focus(t){this._domInput.focus(),t&&this._domInput.select()}blur(){this._domInput.blur()}destroy(){this._destroyed||(this._domInput.removeEventListener("change",this._domEvtChange),this._domInput.removeEventListener("focus",this._domEvtFocus),this._domInput.removeEventListener("blur",this._domEvtBlur),this._domInput.removeEventListener("keydown",this._domEvtKeyDown),this._domInput.removeEventListener("keyup",this._domEvtKeyUp),this._domInput.removeEventListener("contextmenu",this._domEvtCtxMenu),this._domInput=null,super.destroy())}set value(t){const e=this._updateValue(t);e&&(this.error=!1),e&&this._binding&&this._binding.setValue(t)}get value(){return this._domInput.value}set values(t){let e=!1;const s=t[0];for(let i=1;i<t.length;i++)if(t[i]!==s){e=!0;break}e?(this._updateValue(null),this.class.add(Hd)):this._updateValue(t[0])}set placeholder(t){t?this.dom.setAttribute("placeholder",t):this.dom.removeAttribute("placeholder")}get placeholder(){return this.dom.getAttribute("placeholder")}set keyChange(t){this._keyChange!==t&&(this._keyChange=t,t?this._domInput.addEventListener("keyup",this._domEvtKeyUp):this._domInput.removeEventListener("keyup",this._domEvtKeyUp))}get keyChange(){return this._keyChange}get input(){return this._domInput}set onValidate(t){this._onValidate=t}get onValidate(){return this._onValidate}}Element$1.register("string",TextInput,{renderChanges:!0}),Rd('@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .font-icon {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon {\n  font-family: "pc-icon";\n}\n\n.fixedFont, .pcui-text-area-input > textarea {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.noSelect {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-text-area-input {\n  min-height: 48px;\n  height: auto;\n}\n.pcui-text-area-input > textarea {\n  resize: none;\n  height: 100%;\n  width: calc(100% - 16px);\n  padding: 0 8px;\n  line-height: 22px;\n  color: inherit;\n  background: transparent;\n  border: none;\n  outline: none;\n  box-shadow: none;\n  min-height: 44px;\n  min-width: 172px;\n}\n\n.pcui-text-area-input.pcui-text-area-input-resizable-none > textarea {\n  resize: none;\n}\n\n.pcui-text-area-input.pcui-text-area-input-resizable-both > textarea {\n  resize: both;\n}\n\n.pcui-text-area-input.pcui-text-area-input-resizable-horizontal > textarea {\n  resize: horizontal;\n}\n\n.pcui-text-area-input.pcui-text-area-input-resizable-vertical > textarea {\n  resize: vertical;\n}');const $d="pcui-text-area-input";Element$1.register("text",class TextAreaInput extends TextInput{constructor(t){switch(super(t=Object.assign({input:document.createElement("textarea")},t)),this.class.add($d),t.resizable){case"both":this.class.add("pcui-text-area-input-resizable-both");break;case"horizontal":this.class.add("pcui-text-area-input-resizable-horizontal");break;case"vertical":this.class.add("pcui-text-area-input-resizable-vertical");break;default:this.class.add("pcui-text-area-input-resizable-none")}}_onInputKeyDown(t){(27===t.keyCode&&this.blurOnEscape||13===t.keyCode&&this.blurOnEnter&&!t.shiftKey)&&this._domInput.blur(),this.emit("keydown",t)}},{renderChanges:!0}),Rd('.pcui-numeric-input-slider-control {\n  display: none;\n  position: absolute;\n  width: 10px;\n  height: 10px;\n  right: 3px;\n  border: 2px solid #20292b;\n  background-color: #293538;\n  border-radius: 100px;\n  z-index: 9999;\n  transform: translateY(-50%);\n  top: 50%;\n  cursor: ew-resize;\n}\n\n.pcui-numeric-input-slider-control:after {\n  content: "\\e408";\n  font-size: 15px;\n  font-family: "pc-icon";\n  position: absolute;\n  left: -5px;\n  top: -5px;\n  transform: rotateZ(90deg);\n}\n\n.pcui-numeric-input-slider-control:hover {\n  opacity: 50%;\n  color: #b1b8ba;\n}\n\n.pcui-numeric-input-slider-control-active {\n  opacity: 100% !important;\n  color: #7f7 !important;\n}\n\n.pcui-numeric-input-slider-control-hidden {\n  display: none !important;\n}\n\n.pcui-numeric-input:hover .pcui-numeric-input-slider-control {\n  display: block;\n}\n\n.pcui-numeric-input.pcui-disabled:hover .pcui-numeric-input-slider-control {\n  display: none;\n}\n\n.pcui-numeric-input.pcui-disabled .pcui-numeric-input-slider-control, .pcui-numeric-input.pcui-readonly .pcui-numeric-input-slider-control {\n  display: none;\n}');const Yd="pcui-numeric-input",Kd="pcui-numeric-input-slider-control",Zd="pcui-numeric-input-slider-control-active",Qd="pcui-numeric-input-slider-control-hidden",Jd=/,/g;class NumericInput extends TextInput{constructor(t){const e=(t=Object.assign({},t)).value;delete t.value;const s=t.renderChanges||!1;if(delete t.renderChanges,super(t),this.class.add(Yd),this._min=void 0!==t.min?t.min:null,this._max=void 0!==t.max?t.max:null,this._allowNull=t.allowNull||!1,this._precision=Number.isFinite(t.precision)?t.precision:7,Number.isFinite(t.step)?this._step=t.step:Number.isFinite(t.precision)?this._step=1/Math.pow(10,t.precision):this._step=1,this._oldValue=void 0,this.value=e,this._historyCombine=!1,this._historyPostfix=null,this._sliderPrevValue=0,this.renderChanges=s,this._domEvtPointerLock=null,this._domEvtSliderMouseDown=null,this._domEvtSliderMouseUp=null,this._domEvtMouseWheel=null,!t.hideSlider){this._sliderControl=new Element$1,this._sliderControl.class.add(Kd),this.dom.append(this._sliderControl.dom);let t=!1;this._domEvtSliderMouseDown=()=>{this._sliderControl.dom.requestPointerLock(),this._sliderMovement=0,this._sliderPrevValue=this.value,t=!0,this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`)},this._domEvtSliderMouseUp=()=>{document.exitPointerLock(),t&&(t=!1,this.value=this._sliderPrevValue+this._sliderMovement,this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null))},this._domEvtPointerLock=this._pointerLockChangeAlert.bind(this),this._domEvtMouseWheel=this._updatePosition.bind(this),this._sliderControl.dom.addEventListener("mousedown",this._domEvtSliderMouseDown),this._sliderControl.dom.addEventListener("mouseup",this._domEvtSliderMouseUp),document.addEventListener("pointerlockchange",this._domEvtPointerLock,!1),document.addEventListener("mozpointerlockchange",this._domEvtPointerLock,!1)}}_updatePosition(t){let e=0;t.constructor===WheelEvent?e=t.deltaY:t.constructor===MouseEvent&&(e=t.movementX),this._sliderMovement+=e/100*this._step,this.value=this._sliderPrevValue+this._sliderMovement}_onInputChange(t){this.value=this._domInput.value}_onInputKeyDown(t){if(!this.enabled||this.readOnly)return super._onInputKeyDown(t);if(38!==t.keyCode&&40!==t.keyCode)super._onInputKeyDown(t);else{const e=(t.shiftKey?10:1)*(40===t.keyCode?-1:1);this.value+=this.step*e}}_isScrolling(){return!!this._sliderControl&&(document.pointerLockElement===this._sliderControl.dom||document.mozPointerLockElement===this._sliderControl.dom)}_pointerLockChangeAlert(){this._isScrolling()?(this._sliderControl.dom.addEventListener("mousemove",this._domEvtMouseWheel,!1),this._sliderControl.dom.addEventListener("wheel",this._domEvtMouseWheel,!1),this._sliderControl.class.add(Zd)):(this._sliderControl.dom.removeEventListener("mousemove",this._domEvtMouseWheel,!1),this._sliderControl.dom.removeEventListener("wheel",this._domEvtMouseWheel,!1),this._sliderControl.class.remove(Zd))}_normalizeValue(t){try{if("string"==typeof t&&null!==(t=(t=(t=t.replace(Jd,".")).replace(/\s/g,"")).match(/^[*/+\-0-9().]+$/))&&t[0].length<20){var e=t[0];["+","-","/","*"].forEach((t=>{var s=e.split(t);s.forEach(((t,e)=>{s[e]=s[e].replace(/^0+/,"")})),e=s.join(t)})),t=Function('"use strict";return ('+e+")")()}}catch(s){t=null}if(null===t||isNaN(t)){if(this._allowNull)return null;t=0}return null!==this.min&&t<this.min&&(t=this.min),null!==this.max&&t>this.max&&(t=this.max),null!==this.precision&&(t=parseFloat(Number(t).toFixed(this.precision))),t}_updateValue(t,e){const s=t!==this._oldValue||e;return this._oldValue=t,this._domInput.value=t,this.class.remove(Hd),s&&this.emit("change",t),s}set value(t){t=this._normalizeValue(t);const e=this.class.contains(Hd)&&null===t&&this._allowNull;this._updateValue(t,e)&&this.binding&&this.binding.setValue(t),this._sliderControl&&this._sliderControl.class.remove(Qd)}get value(){const t=super.value;return""!==t?parseFloat(t):null}set values(t){let e=!1;const s=this._normalizeValue(t[0]);for(let i=1;i<t.length;i++)if(s!==this._normalizeValue(t[i])){e=!0;break}e?(this._updateValue(null),this.class.add(Hd),this._sliderControl&&this._sliderControl.class.add(Qd)):(this._updateValue(s),this._sliderControl&&this._sliderControl.class.remove(Qd))}set min(t){this._min!==t&&(this._min=t,null!==this._min&&(this.value=this.value))}get min(){return this._min}set max(t){this._max!==t&&(this._max=t,null!==this._max&&(this.value=this.value))}get max(){return this._max}set precision(t){this._precision!==t&&(this._precision=t,null!==this._precision&&(this.value=this.value))}get precision(){return this._precision}set step(t){this._step=t}get step(){return this._step}destroy(){this.destroyed||(this._domEvtSliderMouseDown&&(this._sliderControl.dom.removeEventListener("mousedown",this._domEvtSliderMouseDown),this._sliderControl.dom.removeEventListener("mouseup",this._domEvtSliderMouseUp)),this._domEvtMouseWheel&&(this._sliderControl.dom.removeEventListener("mousemove",this._domEvtMouseWheel,!1),this._sliderControl.dom.removeEventListener("wheel",this._domEvtMouseWheel,!1)),this._domEvtPointerLock&&(document.removeEventListener("pointerlockchange",this._domEvtPointerLock,!1),document.removeEventListener("mozpointerlockchange",this._domEvtPointerLock,!1)),super.destroy())}}Element$1.register("number",NumericInput,{renderChanges:!0});var tu,eu,su,iu,nu={};nu.deepCopy=function t(e){if(null==e||"object"!=typeof e)return e;if(e instanceof Array){for(var s=[],i=0;i<e.length;i++)s[i]=t(e[i]);return s}var n={};for(var a in e)e.hasOwnProperty(a)&&(n[a]=t(e[a]));return n},nu.isMobile=function(){return/Android/i.test(navigator.userAgent)||/iPhone|iPad|iPod/i.test(navigator.userAgent)},nu.implements=function(t,e){var s=Object.getOwnPropertyDescriptors(e.prototype);for(var i in s)t.prototype.hasOwnProperty(i)&&delete s[i];Object.defineProperties(t.prototype,s)},nu.proxy=function(t,e,s){s.forEach((s=>{Object.defineProperty(t.prototype,s,{get:function(){return this[e][s]},set:function(t){this[e][s]=t}})}))},String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(t){for(var e=t.length,s=0;s<e;s++)if(this[s]!==t[s])return!1;return!0}}),String.prototype.endsWith||Object.defineProperty(String.prototype,"endsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(t){for(var e=0,s=t.length;e<s;e++)if(this[e+this.length-s]!==t[e])return!1;return!0}}),String.prototype.appendQuery||Object.defineProperty(String.prototype,"appendQuery",{enumerable:!1,configurable:!1,writable:!1,value:function(t){return this+(-1!==this.indexOf("?")?"&":"?")+t}}),nu.arrayEquals=function(t,e){if(!t)return!1;if(!e)return!1;if(t.length!==e.length)return!1;for(var s=0,i=t.length;s<i;s++)if(this[s]instanceof Array&&e[s]instanceof Array){if(!this[s].equals(e[s]))return!1}else if(this[s]!==e[s])return!1;return!0},tu=document.createElement("div"),eu=DOMTokenList.prototype,su=eu.add,iu=eu.remove,tu.classList.add("class1","class2"),tu.classList.contains("class2")||(eu.add=function(){Array.prototype.forEach.call(arguments,su.bind(this))},eu.remove=function(){Array.prototype.forEach.call(arguments,iu.bind(this))}),Rd('@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .font-icon {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon {\n  font-family: "pc-icon";\n}\n\n.fixedFont {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.noSelect, .pcui-slider {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-slider {\n  display: inline-flex;\n  height: 24px;\n  margin: 6px;\n  align-items: center;\n}\n.pcui-slider > .pcui-numeric-input {\n  flex: 1;\n  margin-left: 0;\n}\n\n.pcui-slider-container {\n  flex: 3;\n}\n\n.pcui-slider-bar {\n  position: relative;\n  width: calc(100% - 18px);\n  height: 4px;\n  margin: 9px 8px;\n  background-color: #2c393c;\n  border: 1px solid #293538;\n}\n\n.pcui-slider-handle {\n  position: absolute;\n  top: -7px;\n  left: 0;\n  margin-left: -9px;\n  width: 8px;\n  height: 16px;\n  background-color: #5b7073;\n  border: 1px solid #293538;\n  transition: left 100ms ease;\n}\n.pcui-slider-handle:hover, .pcui-slider-handle:focus {\n  outline: none;\n}\n\n.pcui-slider-active {\n  cursor: ew-resize;\n}\n.pcui-slider-active .pcui-slider-bar {\n  border-color: #20292b;\n  background-color: #20292b;\n}\n.pcui-slider-active .pcui-slider-handle {\n  border-color: #20292b;\n  background-color: #ffffff;\n  transition: none;\n}\n\n.pcui-slider:not(.pcui-disabled):not(.pcui-readonly):hover {\n  cursor: pointer;\n}\n.pcui-slider:not(.pcui-disabled):not(.pcui-readonly) .pcui-slider-handle:focus, .pcui-slider:not(.pcui-disabled):not(.pcui-readonly) .pcui-slider-handle:hover {\n  cursor: ew-resize;\n  outline: none;\n  border-color: #20292b;\n  background-color: #ffffff;\n}\n\n.pcui-slider.pcui-readonly .pcui-numeric-input {\n  flex: 1;\n}\n.pcui-slider.pcui-readonly .pcui-slider-bar {\n  display: none;\n}\n\n.pcui-slider.pcui-multiple-values .pcui-slider-handle {\n  display: none;\n}');const au="pcui-slider",ru="pcui-slider-active",ou=/Chrome\//.test(navigator.userAgent),lu=["allowNull","max","min","keyChange","placeholder","precision","renderChanges","step"];class SliderInput extends Element$1{constructor(t){t=Object.assign({},t);const e={};lu.forEach((s=>{e[s]=t[s]})),void 0===e.precision&&(e.precision=2),delete e.binding,super(t.dom?t.dom:document.createElement("div"),t),t.pre&&(this.precision=t.pre),this.class.add(au),this._historyCombine=!1,this._historyPostfix=null,this._numericInput=new NumericInput({...e,hideSlider:!0}),this._numericInput.on("change",this._onValueChange.bind(this)),this._numericInput.on("focus",(()=>{this.emit("focus")})),this._numericInput.on("blur",(()=>{this.emit("blur")})),this._sliderMin=void 0!==t.sliderMin?t.sliderMin:this.min||0,this._sliderMax=void 0!==t.sliderMax?t.sliderMax:this.max||1,this.dom.appendChild(this._numericInput.dom),this._numericInput.parent=this,this._domSlider=document.createElement("div"),this._domSlider.classList.add("pcui-slider-container"),this.dom.appendChild(this._domSlider),this._domBar=document.createElement("div"),this._domBar.classList.add("pcui-slider-bar"),this._domBar.ui=this,this._domSlider.appendChild(this._domBar),this._domHandle=document.createElement("div"),this._domHandle.ui=this,this._domHandle.tabIndex=0,this._domHandle.classList.add("pcui-slider-handle"),this._domBar.appendChild(this._domHandle),this._cursorHandleOffset=0,this._domMouseDown=this._onMouseDown.bind(this),this._domMouseMove=this._onMouseMove.bind(this),this._domMouseUp=this._onMouseUp.bind(this),this._domTouchStart=this._onTouchStart.bind(this),this._domTouchMove=this._onTouchMove.bind(this),this._domTouchEnd=this._onTouchEnd.bind(this),this._domKeyDown=this._onKeyDown.bind(this),this._touchId=null,this._domSlider.addEventListener("mousedown",this._domMouseDown),this._domSlider.addEventListener("touchstart",this._domTouchStart,{passive:!0}),this._domHandle.addEventListener("keydown",this._domKeyDown),void 0!==t.value&&(this.value=t.value),0===this.value&&this._updateHandle(0)}_onMouseDown(t){0===t.button&&this.enabled&&!this.readOnly&&this._onSlideStart(t.pageX)}_onMouseMove(t){t.stopPropagation(),t.preventDefault(),this._onSlideMove(t.pageX)}_onMouseUp(t){t.stopPropagation(),t.preventDefault(),this._onSlideEnd(t.pageX)}_onTouchStart(t){if(this.enabled&&!this.readOnly)for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];if(s.target.ui&&s.target.ui===this){this._touchId=s.identifier,this._onSlideStart(s.pageX);break}}}_onTouchMove(t){for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];if(s.identifier===this._touchId){t.stopPropagation(),t.preventDefault(),this._onSlideMove(s.pageX);break}}}_onTouchEnd(t){for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];if(s.identifier===this._touchId){t.stopPropagation(),t.preventDefault(),this._onSlideEnd(s.pageX),this._touchId=null;break}}}_onKeyDown(t){if(27===t.keyCode)return void this.blur();if(!this.enabled||this.readOnly)return;if(37!==t.keyCode&&39!==t.keyCode)return;t.stopPropagation(),t.preventDefault();let e=37===t.keyCode?-1:1;t.shiftKey&&(e*=10),this.value+=e*this.step}_updateHandle(t){const e=100*Math.max(0,Math.min(1,((t||0)-this._sliderMin)/(this._sliderMax-this._sliderMin))),s=this._domHandle.getBoundingClientRect().width;this._domHandle.style.left=`calc(${e}% + ${s/2}px)`}_onValueChange(t){this._updateHandle(t),this.emit("change",t),this._binding&&this._binding.setValue(t)}_calculateCursorHandleOffset(t){const e=ou?2:0,s=this._domHandle.getBoundingClientRect(),i=s.left-e,n=s.right;return this._cursorHandleOffset=t>=i&&t<=n?t-(i+(n-i)/2):0,this._cursorHandleOffset}_onSlideStart(t){this._domHandle.focus(),null===this._touchId?(window.addEventListener("mousemove",this._domMouseMove),window.addEventListener("mouseup",this._domMouseUp)):(window.addEventListener("touchmove",this._domTouchMove),window.addEventListener("touchend",this._domTouchEnd)),this.class.add(ru),this._calculateCursorHandleOffset(t)||this._onSlideMove(t),this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`)}_onSlideMove(t){const e=this._domBar.getBoundingClientRect();t-=this._cursorHandleOffset;let s=Math.max(0,Math.min(1,(t-e.left)/e.width))*(this._sliderMax-this._sliderMin)+this._sliderMin;s=parseFloat(s.toFixed(this.precision)),this.value=s}_onSlideEnd(t){this._calculateCursorHandleOffset(t)||this._onSlideMove(t),this.class.remove(ru),null===this._touchId?(window.removeEventListener("mousemove",this._domMouseMove),window.removeEventListener("mouseup",this._domMouseUp)):(window.removeEventListener("touchmove",this._domTouchMove),window.removeEventListener("touchend",this._domTouchEnd)),this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null)}focus(){this._numericInput.focus()}blur(){this._domHandle.blur(),this._numericInput.blur()}destroy(){this._destroyed||(this._domSlider.removeEventListener("mousedown",this._domMouseDown),this._domSlider.removeEventListener("touchstart",this._domTouchStart),this._domHandle.removeEventListener("keydown",this._domKeyDown),this.dom.removeEventListener("mouseup",this._domMouseUp),this.dom.removeEventListener("mousemove",this._domMouseMove),this.dom.removeEventListener("touchmove",this._domTouchMove),this.dom.removeEventListener("touchend",this._domTouchEnd),super.destroy())}set sliderMin(t){this._sliderMin!==t&&(this._sliderMin=t,this._updateHandle(this.value))}get sliderMin(){return this._sliderMin}set sliderMax(t){this._sliderMax!==t&&(this._sliderMax=t,this._updateHandle(this.value))}get sliderMax(){return this._sliderMax}set value(t){this._numericInput.value=t,this._numericInput.class.contains(Hd)?this.class.add(Hd):this.class.remove(Hd)}get value(){return this._numericInput.value}set values(t){this._numericInput.values=t,this._numericInput.class.contains(Hd)?this.class.add(Hd):this.class.remove(Hd)}}nu.proxy(SliderInput,"_numericInput",lu),Element$1.register("slider",SliderInput,{renderChanges:!0}),Rd('@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .font-icon {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon {\n  font-family: "pc-icon";\n}\n\n.fixedFont {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.noSelect {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex, .pcui-vector-input {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden), .pcui-vector-input:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-vector-input {\n  flex-direction: row;\n  align-items: center;\n}\n.pcui-vector-input > .pcui-numeric-input {\n  flex: 1;\n  margin: 6px 3px;\n}\n.pcui-vector-input > .pcui-numeric-input:first-child {\n  margin-left: 0;\n}\n.pcui-vector-input > .pcui-numeric-input:last-child {\n  margin-right: 0;\n}');class VectorInput extends Element$1{constructor(t){const e=(t=Object.assign({},t)).binding;delete t.binding,super(t.dom?t.dom:document.createElement("div"),t),this.class.add("pcui-vector-input");const s=Math.max(2,Math.min(4,t.dimensions||3)),i=this._onInputChange.bind(this);this._inputs=new Array(s);for(let n=0;n<this._inputs.length;n++)this._inputs[n]=new NumericInput({min:t.min,max:t.max,precision:t.precision,step:t.step,renderChanges:t.renderChanges,placeholder:t.placeholder?Array.isArray(t.placeholder)?t.placeholder[n]:t.placeholder:null}),this._inputs[n].on("change",i),this._inputs[n].on("focus",(()=>{this.emit("focus")})),this._inputs[n].on("blur",(()=>{this.emit("blur")})),this.dom.appendChild(this._inputs[n].dom),this._inputs[n].parent=this;e&&(this.binding=e),this._applyingChange=!1,void 0!==t.value&&(this.value=t.value)}_onInputChange(){if(this._applyingChange)return;let t=!1;for(let e=0;e<this._inputs.length;e++)if(this._inputs[e].class.contains(Hd)){t=!0;break}t?this.class.add(Hd):this.class.remove(Hd),this.emit("change",this.value)}_updateValue(t){if(this.class.remove(Hd),JSON.stringify(this.value)===JSON.stringify(t))return!1;this._applyingChange=!0;for(let e=0;e<this._inputs.length;e++){const s=this._inputs[e].binding;let i=!1;s&&(i=s.applyingChange,s.applyingChange=!0),this._inputs[e].value=t&&void 0!==t[e]?t[e]:null,s&&(s.applyingChange=i)}return this.emit("change",this.value),this._applyingChange=!1,!0}link(t,e){super.link(t,e),t=Array.isArray(t)?t:[t];if(1===(e=Array.isArray(e)?e:[e]).length||t.length!==e.length)for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(t,e[0]+`.${s}`);else for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(t,e.map((t=>`${t}.${s}`)))}unlink(){super.unlink();for(let t=0;t<this._inputs.length;t++)this._inputs[t].unlink()}focus(){this._inputs[0].focus()}blur(){for(let t=0;t<this._inputs.length;t++)this._inputs[t].blur()}set value(t){if("string"==typeof t)try{if(t=JSON.parse(t),Array.isArray(t)&&t.some((t=>!Number.isFinite(t))))throw new Error("VectorInput value set to string which doesn't contain an array of numbers")}catch($u){console.error($u),t=[]}Array.isArray(t)||(t=[]);this._updateValue(t)&&this._binding&&this._binding.setValue(t)}get value(){const t=new Array(this._inputs.length);for(let e=0;e<this._inputs.length;e++)t[e]=this._inputs[e].value;return t}set values(t){t=this._inputs.map(((e,s)=>t.map((t=>t?t[s]:void 0)))),this._inputs.forEach(((e,s)=>{e.values=t[s]}))}set binding(t){super.binding=t;for(let e=0;e<this._inputs.length;e++)this._inputs[e].binding=t?t.clone():null}get binding(){return super.binding}set placeholder(t){for(let e=0;e<this._inputs.length;e++)this._inputs[e].placeholder=t[e]||t||null}get placeholder(){return this._inputs.map((t=>t.placeholder))}get inputs(){return this._inputs.slice()}}["min","max","precision","step","renderChanges"].forEach((t=>{Object.defineProperty(VectorInput.prototype,t,{get:function(){return this._inputs[0][t]},set:function(e){for(let s=0;s<this._inputs.length;s++)this._inputs[s][t]=e}})})),Element$1.register("vec2",VectorInput,{dimensions:2,renderChanges:!0}),Element$1.register("vec3",VectorInput,{dimensions:3,renderChanges:!0}),Element$1.register("vec4",VectorInput,{dimensions:4,renderChanges:!0}),Rd('@charset "UTF-8";\n@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .font-icon, .pcui-boolean-input.pcui-boolean-input-ticked:after {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon, .pcui-boolean-input.pcui-boolean-input-ticked:after {\n  font-family: "pc-icon";\n}\n\n.fixedFont {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.pcui-boolean-input {\n  display: inline-block;\n  position: relative;\n  box-sizing: border-box;\n  background-color: #2c393c;\n  color: #fff;\n  width: 14px;\n  height: 14px;\n  line-height: 1;\n  overflow: hidden;\n  margin: 6px;\n  transition: opacity 100ms, background-color 100ms, box-shadow 100ms;\n}\n.pcui-boolean-input:focus {\n  outline: none;\n}\n\n.pcui-boolean-input.pcui-boolean-input-ticked {\n  background-color: #b1b8ba;\n}\n.pcui-boolean-input.pcui-boolean-input-ticked:after {\n  content: "\\e372";\n  color: #20292b;\n  background-color: inherit;\n  font-size: 19px;\n  display: block;\n  margin-top: -2px;\n  margin-left: -2px;\n}\n\n.pcui-boolean-input:not(.pcui-disabled):not(.pcui-readonly):hover, .pcui-boolean-input:not(.pcui-disabled):not(.pcui-readonly):focus {\n  cursor: pointer;\n  background-color: #293538;\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-boolean-input:not(.pcui-disabled):not(.pcui-readonly).pcui-boolean-input-ticked:hover, .pcui-boolean-input:not(.pcui-disabled):not(.pcui-readonly).pcui-boolean-input-ticked:focus {\n  background-color: #b1b8ba;\n}\n\n.pcui-boolean-input.pcui-disabled {\n  opacity: 0.4;\n}\n\n.pcui-boolean-input.pcui-multiple-values:after {\n  position: absolute;\n  font-size: 17px;\n  font-weight: bold;\n  color: #b1b8ba;\n  left: 4px;\n  top: -3px;\n  content: "-";\n}\n\n.pcui-boolean-input-toggle {\n  display: inline-block;\n  position: relative;\n  width: 30px;\n  height: 16px;\n  border-radius: 8px;\n  flex-shrink: 0;\n  border: 1px solid #293538;\n  box-sizing: border-box;\n  background-color: #364346;\n  color: #fff;\n  line-height: 1;\n  overflow: hidden;\n  margin: 6px;\n  transition: opacity 100ms, background-color 100ms, box-shadow 100ms;\n}\n.pcui-boolean-input-toggle:focus {\n  outline: none;\n}\n.pcui-boolean-input-toggle:after {\n  content: " ";\n  position: absolute;\n  top: 1px;\n  left: 1px;\n  width: 12px;\n  height: 12px;\n  border-radius: 6px;\n  background-color: #5b7073;\n  transition: left 100ms ease, background-color 100ms ease;\n}\n\n.pcui-boolean-input-toggle.pcui-boolean-input-ticked {\n  border-color: #293538;\n}\n.pcui-boolean-input-toggle.pcui-boolean-input-ticked:after {\n  left: 15px;\n  background-color: #69b875;\n}\n\n.pcui-boolean-input-toggle:not(.pcui-disabled):not(.pcui-readonly):hover, .pcui-boolean-input-toggle:not(.pcui-disabled):not(.pcui-readonly):focus {\n  cursor: pointer;\n  border-color: #20292b;\n  background-color: #20292b;\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-boolean-input-toggle:not(.pcui-disabled):not(.pcui-readonly):hover:after, .pcui-boolean-input-toggle:not(.pcui-disabled):not(.pcui-readonly):focus:after {\n  background-color: #d34141;\n}\n.pcui-boolean-input-toggle:not(.pcui-disabled):not(.pcui-readonly).pcui-boolean-input-ticked:hover, .pcui-boolean-input-toggle:not(.pcui-disabled):not(.pcui-readonly).pcui-boolean-input-ticked:focus {\n  border-color: #20292b;\n  background-color: #20292b;\n}\n.pcui-boolean-input-toggle:not(.pcui-disabled):not(.pcui-readonly).pcui-boolean-input-ticked:after {\n  background-color: #7f7;\n}\n\n.pcui-boolean-input-toggle.pcui-readonly {\n  opacity: 0.7;\n}\n\n.pcui-boolean-input-toggle.pcui-disabled {\n  opacity: 0.4;\n}\n\n.pcui-boolean-input-toggle.pcui-multiple-values:after {\n  left: 8px;\n  background-color: rgba(155, 161, 163, 0.25);\n}');const hu="pcui-boolean-input",cu="pcui-boolean-input-ticked";Element$1.register("boolean",class BooleanInput extends Element$1{constructor(t){super((t=Object.assign({tabIndex:0},t)).dom?t.dom:document.createElement("div"),t),"toggle"===t.type?this.class.add("pcui-boolean-input-toggle"):this.class.add(hu),this.class.add("pcui-not-flexible"),this._domEventKeyDown=this._onKeyDown.bind(this),this._domEventFocus=this._onFocus.bind(this),this._domEventBlur=this._onBlur.bind(this),this.dom.addEventListener("keydown",this._domEventKeyDown),this.dom.addEventListener("focus",this._domEventFocus),this.dom.addEventListener("blur",this._domEventBlur),this._value=null,void 0!==t.value&&(this.value=t.value),this.renderChanges=t.renderChanges}_onClick(t){return this.enabled&&this.focus(),this.enabled&&!this.readOnly&&(this.value=!this.value),super._onClick(t)}_onKeyDown(t){27!==t.keyCode?this.enabled&&!this.readOnly&&32===t.keyCode&&(t.stopPropagation(),t.preventDefault(),this.value=!this.value):this.blur()}_onFocus(){this.emit("focus")}_onBlur(){this.emit("blur")}_updateValue(t){return this.class.remove(Hd),t!==this.value&&(this._value=t,t?this.class.add(cu):this.class.remove(cu),this.renderChanges&&this.flash(),this.emit("change",t),!0)}focus(){this.dom.focus()}blur(){this.dom.blur()}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._domEventKeyDown),this.dom.removeEventListener("focus",this._domEventFocus),this.dom.removeEventListener("blur",this._domEventBlur),super.destroy())}set value(t){this._updateValue(t)&&this._binding&&this._binding.setValue(t)}get value(){return this._value}set values(t){let e=!1;const s=t[0];for(let i=1;i<t.length;i++)if(t[i]!==s){e=!0;break}e?(this._updateValue(null),this.class.add(Hd)):this._updateValue(t[0])}},{renderChanges:!0}),Rd('@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .font-icon {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon {\n  font-family: "pc-icon";\n}\n\n.fixedFont, .pcui-label.pcui-multiple-values:before {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.noSelect, .pcui-label.pcui-selectable:hover {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-label {\n  display: inline-block;\n  box-sizing: border-box;\n  margin: 6px;\n  vertical-align: middle;\n  transition: opacity 100ms;\n  color: #b1b8ba;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: none;\n}\n\n.pcui-label.pcui-default-mousedown {\n  user-select: initial;\n}\n\n.pcui-label.pcui-multiple-values {\n  position: relative;\n  color: transparent;\n}\n.pcui-label.pcui-multiple-values:before {\n  content: "...";\n  color: #b1b8ba;\n  white-space: nowrap;\n  font-size: 12px;\n}\n\n.pcui-label.pcui-error {\n  color: #d34141;\n}\n\n.pcui-label.pcui-selectable:hover {\n  color: #f60;\n  text-decoration: underline;\n}\n\n.pcui-label[placeholder] {\n  position: relative;\n}\n.pcui-label[placeholder]:after {\n  content: attr(placeholder);\n  position: absolute;\n  top: 0;\n  right: 0;\n  padding: 0 8px;\n  color: #999;\n  pointer-events: none;\n}');class Label extends Element$1{constructor(t){t||(t={}),super(t.dom?t.dom:document.createElement("span"),t),this.class.add("pcui-label"),this._unsafe=t.unsafe||!1,this.text=t.text||t.value||"",t.allowTextSelection&&this.class.add("pcui-default-mousedown"),t.nativeTooltip&&(this.dom.title=this.text),this.placeholder=t.placeholder||null,this.renderChanges=t.renderChanges||!1,this.on("change",(()=>{this.renderChanges&&this.flash()}))}_updateText(t){return this.class.remove(Hd),this._text!==t&&(this._text=t,this._unsafe?this._dom.innerHTML=t:this._dom.textContent=t,this.emit("change",t),!0)}set text(t){null==t&&(t="");this._updateText(t)&&this._binding&&this._binding.setValue(t)}get text(){return this._text}set value(t){this.text=t}get value(){return this.text}set values(t){let e=!1;const s=t[0];for(let i=1;i<t.length;i++)if(t[i]!==s){e=!0;break}e?(this._updateText(""),this.class.add(Hd)):this._updateText(t[0])}set placeholder(t){t?this.dom.setAttribute("placeholder",t):this.dom.removeAttribute("placeholder")}get placeholder(){return this.dom.getAttribute("placeholder")}}Element$1.register("label",Label),Rd('@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .font-icon, .pcui-button[data-icon]:before {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon, .pcui-button[data-icon]:before {\n  font-family: "pc-icon";\n}\n\n.fixedFont {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.noSelect, .pcui-button {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-button {\n  font-family: inherit;\n  display: inline-block;\n  border: 1px solid #20292b;\n  border-radius: 2px;\n  box-sizing: border-box;\n  background-color: #2c393c;\n  color: #b1b8ba;\n  padding: 0 8px;\n  margin: 6px;\n  height: 28px;\n  line-height: 28px;\n  max-height: 100%;\n  vertical-align: middle;\n  font-size: 12px;\n  font-weight: 600;\n  text-align: center;\n  white-space: nowrap;\n  cursor: pointer;\n  transition: color 100ms, opacity 100ms, box-shadow 100ms;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n.pcui-button[data-icon]:before {\n  content: attr(data-icon);\n  font-weight: 100;\n  font-size: inherit;\n  margin-right: 6px;\n  vertical-align: middle;\n}\n.pcui-button[data-icon]:empty:before {\n  margin-right: 0;\n}\n\n.pcui-button:not(.pcui-disabled):not(.pcui-readonly):hover, .pcui-button:not(.pcui-disabled):not(.pcui-readonly):focus {\n  color: #ffffff;\n  background-color: #2c393c;\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-button:not(.pcui-disabled):not(.pcui-readonly):active {\n  background-color: #20292b;\n  box-shadow: none;\n}\n\n.pcui-button.pcui-readonly {\n  opacity: 0.7;\n  cursor: default;\n}\n\n.pcui-button.pcui-disabled {\n  opacity: 0.4;\n  cursor: default;\n}\n\n.pcui-button.pcui-small {\n  height: 24px;\n  line-height: 24px;\n  font-size: 10px;\n}');class Button extends Element$1{constructor(t){t||(t={}),super(t.dom?t.dom:document.createElement("button"),t),this.class.add("pcui-button"),this._unsafe=t.unsafe||!1,this.text=t.text||"",this.size=t.size||null,this.icon=t.icon||"",this._domEventKeyDown=this._onKeyDown.bind(this),this.dom.addEventListener("keydown",this._onKeyDown.bind(this))}_onKeyDown(t){27===t.keyCode?this.blur():13===t.keyCode&&this._onClick(t)}_onClick(t){this.blur(),this.readOnly||super._onClick(t)}focus(){this.dom.focus()}blur(){this.dom.blur()}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._domEventKeyDown),super.destroy())}set text(t){this._text!==t&&(this._text=t,this._unsafe?this.dom.innerHTML=t:this.dom.textContent=t)}get text(){return this._text}set icon(t){this._icon!==t&&t.match(/^E[0-9]{0,4}$/)&&(this._icon=t,t?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(t,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set size(t){this._size!==t&&(this._size&&(this.class.remove("pcui-"+this._size),this._size=null),this._size=t,this._size&&this.class.add("pcui-"+this._size))}get size(){return this._size}}Element$1.register("button",Button),Rd(".pcui-container {\n  position: relative;\n  min-width: 0;\n  min-height: 0;\n}\n\n.pcui-container.pcui-resizable > .pcui-resizable-handle {\n  position: absolute;\n  z-index: 1;\n  opacity: 0;\n  background-color: transparent;\n}\n.pcui-container.pcui-resizable > .pcui-resizable-handle:hover {\n  opacity: 1;\n}\n.pcui-container.pcui-resizable.pcui-resizable-resizing > .pcui-resizable-handle {\n  opacity: 1;\n}\n.pcui-container.pcui-resizable.pcui-resizable-left > .pcui-resizable-handle, .pcui-container.pcui-resizable.pcui-resizable-right > .pcui-resizable-handle {\n  top: 0;\n  bottom: 0;\n  width: 1px;\n  height: auto;\n  cursor: ew-resize;\n}\n.pcui-container.pcui-resizable.pcui-resizable-left > .pcui-resizable-handle {\n  left: 0;\n  border-left: 3px solid #20292b;\n}\n.pcui-container.pcui-resizable.pcui-resizable-right > .pcui-resizable-handle {\n  right: 0;\n  border-right: 3px solid #20292b;\n}\n.pcui-container.pcui-resizable.pcui-resizable-top > .pcui-resizable-handle, .pcui-container.pcui-resizable.pcui-resizable-bottom > .pcui-resizable-handle {\n  left: 0;\n  right: 0;\n  width: auto;\n  height: 1px;\n  cursor: ns-resize;\n}\n.pcui-container.pcui-resizable.pcui-resizable-top > .pcui-resizable-handle {\n  top: 0;\n  border-top: 3px solid #20292b;\n}\n.pcui-container.pcui-resizable.pcui-resizable-bottom > .pcui-resizable-handle {\n  bottom: 0;\n  border-bottom: 3px solid #20292b;\n}\n\n.pcui-container-dragged {\n  outline: 2px solid #ffffff;\n  box-sizing: border-box;\n  opacity: 0.7;\n  z-index: 1;\n}\n\n.pcui-container-dragged-child {\n  outline: 1px dotted #f60;\n  box-sizing: border-box;\n}");const du=[null,"top","right","bottom","left"],uu=Od+"-resizing",pu="pcui-container",mu="pcui-container-dragged",_u=mu+"-child";class Container extends Element$1{constructor(t){t||(t={});super(t.dom||document.createElement("div"),t),this.class.add(pu),this._domEventScroll=this._onScroll.bind(this),this.domContent=this._dom,this._scrollable=!1,t.scrollable&&(this.scrollable=!0),this._flex=!1,this.flex=!!t.flex,this._grid=!1;let e=!!t.grid;e&&this.flex&&(console.error('Invalid pcui.Container arguments: "grid" and "flex" cannot both be true.'),e=!1),this.grid=e,this._domResizeHandle=null,this._domEventResizeStart=this._onResizeStart.bind(this),this._domEventResizeMove=this._onResizeMove.bind(this),this._domEventResizeEnd=this._onResizeEnd.bind(this),this._domEventResizeTouchStart=this._onResizeTouchStart.bind(this),this._domEventResizeTouchMove=this._onResizeTouchMove.bind(this),this._domEventResizeTouchEnd=this._onResizeTouchEnd.bind(this),this._resizeTouchId=null,this._resizeData=null,this._resizeHorizontally=!0,this.resizable=t.resizable||null,this._resizeMin=100,this._resizeMax=300,void 0!==t.resizeMin&&(this.resizeMin=t.resizeMin),void 0!==t.resizeMax&&(this.resizeMax=t.resizeMax),this._draggedStartIndex=-1}append(t){const e=this._getDomFromElement(t);this._domContent.appendChild(e),this._onAppendChild(t)}appendBefore(t,e){const s=this._getDomFromElement(t);this._domContent.appendChild(s);const i=e&&this._getDomFromElement(e);this._domContent.insertBefore(s,i),this._onAppendChild(t)}appendAfter(t,e){const s=this._getDomFromElement(t),i=e&&this._getDomFromElement(e),n=i?i.nextSibling:null;n?this._domContent.insertBefore(s,n):this._domContent.appendChild(s),this._onAppendChild(t)}prepend(t){const e=this._getDomFromElement(t),s=this._domContent.firstChild;s?this._domContent.insertBefore(e,s):this._domContent.appendChild(e),this._onAppendChild(t)}remove(t){if(t.parent!==this)return;const e=this._getDomFromElement(t);this._domContent.removeChild(e),this._onRemoveChild(t)}move(t,e){let s=-1;for(let i=0;i<this.dom.childNodes.length;i++)if(this.dom.childNodes[i].ui===t){s=i;break}-1===s?this.appendBefore(t,this.dom.childNodes[e]):e!==s&&(this.remove(t),e<s?this.appendBefore(t,this.dom.childNodes[e]):this.appendAfter(t,this.dom.childNodes[e-1]))}clear(){let t=this._domContent.childNodes.length;for(;t--;){const e=this._domContent.childNodes[t];e.ui&&e.ui!==this&&e.ui.destroy()}this._domResizeHandle&&(this._domResizeHandle.removeEventListener("mousedown",this._domEventResizeStart),this._domResizeHandle.removeEventListener("touchstart",this._domEventResizeTouchStart,{passive:!1}),this._domResizeHandle=null),this._domContent.innerHTML="",this.resizable&&(this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle))}_getDomFromElement(t){return t.dom?t.dom:t.element?t.element:t}_onAppendChild(t){t.parent=this,this.emit("append",t)}_onRemoveChild(t){t.parent=null,this.emit("remove",t)}_onScroll(t){this.emit("scroll",t)}_createResizeHandle(){const t=document.createElement("div");t.classList.add("pcui-resizable-handle"),t.ui=this,t.addEventListener("mousedown",this._domEventResizeStart),t.addEventListener("touchstart",this._domEventResizeTouchStart,{passive:!1}),this._domResizeHandle=t}_onResizeStart(t){t.preventDefault(),t.stopPropagation(),window.addEventListener("mousemove",this._domEventResizeMove),window.addEventListener("mouseup",this._domEventResizeEnd),this._resizeStart()}_onResizeMove(t){t.preventDefault(),t.stopPropagation(),this._resizeMove(t.clientX,t.clientY)}_onResizeEnd(t){t.preventDefault(),t.stopPropagation(),window.removeEventListener("mousemove",this._domEventResizeMove),window.removeEventListener("mouseup",this._domEventResizeEnd),this._resizeEnd()}_onResizeTouchStart(t){t.preventDefault(),t.stopPropagation();for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];s.target===this._domResizeHandle&&(this._resizeTouchId=s.identifier)}window.addEventListener("touchmove",this._domEventResizeTouchMove),window.addEventListener("touchend",this._domEventResizeTouchEnd),this._resizeStart()}_onResizeTouchMove(t){for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];if(s.identifier===this._resizeTouchId){t.stopPropagation(),t.preventDefault(),this._resizeMove(s.clientX,s.clientY);break}}}_onResizeTouchEnd(t){for(let e=0;e<t.changedTouches.length;e++){if(t.changedTouches[e].identifier!==this._resizeTouchId){this._resizeTouchId=null,t.preventDefault(),t.stopPropagation(),window.removeEventListener("touchmove",this._domEventResizeTouchMove),window.removeEventListener("touchend",this._domEventResizeTouchEnd),this._resizeEnd();break}}}_resizeStart(){this.class.add(uu)}_resizeMove(t,e){if(this._resizeData){if(this._resizeHorizontally){let e=this._resizeData.x-t;"right"===this._resizable&&(e=-e),this.width=4+Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.width+e))}else{let t=this._resizeData.y-e;"bottom"===this._resizable&&(t=-t),this.height=Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.height+t))}this.emit("resize")}else this._resizeData={x:t,y:e,width:this.dom.clientWidth,height:this.dom.clientHeight}}_resizeEnd(){this._resizeData=null,this.class.remove(uu)}resize(t,e){t=t||0,e=e||0,this._resizeStart(),this._resizeMove(0,0),this._resizeMove(4-t,-e),this._resizeEnd()}_getDraggedChildIndex(t){for(let e=0;e<this.dom.childNodes.length;e++)if(this.dom.childNodes[e].ui===t)return e;return-1}_onChildDragStart(t,e){this.class.add(_u),this._draggedStartIndex=this._getDraggedChildIndex(e),e.class.add(mu),this._draggedHeight=e.height,this.emit("child:dragstart",e,this._draggedStartIndex)}_onChildDragMove(t,e){const s=this.dom.getBoundingClientRect(),i=t.clientX<s.left||t.clientX>s.right||t.clientY<s.top||t.clientY>s.bottom,n=this._getDraggedChildIndex(e);if(i)return e.class.remove(mu),void(this._draggedStartIndex!==n&&(this.remove(e),this._draggedStartIndex<n?this.appendBefore(e,this.dom.childNodes[this._draggedStartIndex]):this.appendAfter(e,this.dom.childNodes[this._draggedStartIndex-1])));e.class.add(mu);const a=t.clientY-s.top;let r=null;for(let o=0;o<this.dom.childNodes.length;o++){const t=this.dom.childNodes[o].ui,s=t.dom.offsetTop;if(o<n){if(a<=s+t.header.height){r=o;break}}else if(o>n&&a+e.height>=s+t.height){r=o;break}}null!==r&&n!==r&&(this.remove(e),r<n?this.appendBefore(e,this.dom.childNodes[r]):this.appendAfter(e,this.dom.childNodes[r-1]))}_onChildDragEnd(t,e){this.class.remove(_u),e.class.remove(mu);const s=this._getDraggedChildIndex(e);this.emit("child:dragend",e,s,this._draggedStartIndex),this._draggedStartIndex=-1}forEachChild(t){for(let e=0;e<this.dom.childNodes.length;e++){const s=this.dom.childNodes[e].ui;if(s){if(!1===t(s,e))break}}}_buildDomNode(t){const e=Object.keys(t);let s;return e.includes("root")?(s=this._buildDomNode(t.root),t.children.forEach((t=>{const e=this._buildDomNode(t);null!==e&&s.append(e)}))):(s=t[e[0]],this[`_${e[0]}`]=s),s}buildDom(t){t.forEach((t=>{const e=this._buildDomNode(t);this.append(e)}))}destroy(){this._destroyed||(this.domContent=null,this._domResizeHandle&&(this._domResizeHandle.removeEventListener("mousedown",this._domEventResizeStart),window.removeEventListener("mousemove",this._domEventResizeMove),window.removeEventListener("mouseup",this._domEventResizeEnd),this._domResizeHandle.removeEventListener("touchstart",this._domEventResizeTouchStart),window.removeEventListener("touchmove",this._domEventResizeTouchMove),window.removeEventListener("touchend",this._domEventResizeTouchEnd)),this._domResizeHandle=null,this._domEventResizeStart=null,this._domEventResizeMove=null,this._domEventResizeEnd=null,this._domEventResizeTouchStart=null,this._domEventResizeTouchMove=null,this._domEventResizeTouchEnd=null,this._domEventScroll=null,super.destroy())}set flex(t){t!==this._flex&&(this._flex=t,t?this.classAdd(Id):this.classRemove(Id))}get flex(){return this._flex}set grid(t){t!==this._grid&&(this._grid=t,t?this.classAdd(Dd):this.classRemove(Dd))}get grid(){return this._grid}set scrollable(t){this._scrollable!==t&&(this._scrollable=t,t?this.classAdd(Fd):this.classRemove(Fd))}get scrollable(){return this._scrollable}set resizable(t){t!==this._resizable&&(-1!==du.indexOf(t)?(this._resizable&&this.classRemove(`${Od}-${this._resizable}`),this._resizable=t,this._resizeHorizontally="right"===t||"left"===t,t?(this.classAdd(Od),this.classAdd(`${Od}-${t}`),this._domResizeHandle||this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle)):(this.classRemove(Od),this._domResizeHandle&&this._dom.removeChild(this._domResizeHandle))):console.error("Invalid resizable value: must be one of "+du.join(",")))}get resizable(){return this._resizable}set resizeMin(t){this._resizeMin=Math.max(0,Math.min(t,this._resizeMax))}get resizeMin(){return this._resizeMin}set resizeMax(t){this._resizeMax=Math.max(this._resizeMin,t)}get resizeMax(){return this._resizeMax}set domContent(t){this._domContent!==t&&(this._domContent&&this._domContent.removeEventListener("scroll",this._domEventScroll),this._domContent=t,this._domContent&&this._domContent.addEventListener("scroll",this._domEventScroll))}get domContent(){return this._domContent}}Element$1.register("container",Container),Rd('.pcui-code {\n  background: #20292b;\n  overflow: auto;\n}\n.pcui-code .pcui-code-inner {\n  color: #f60;\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 10px;\n  white-space: pre;\n}');const fu="pcui-code";Element$1.register("code",class Code extends Container{constructor(t){t||(t={}),super(t),this.class.add(fu),this._inner=new Label,this.append(this._inner),this._inner.class.add("pcui-code-inner"),t.text&&(this.text=t.text)}set text(t){this._text=t,this._inner.text=t}get text(){return this._text}}),Rd('@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .pcui-panel-header-title, .pcui-panel-header, .font-icon, .pcui-panel.pcui-collapsible > .pcui-panel-header:before {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon, .pcui-panel.pcui-collapsible > .pcui-panel-header:before {\n  font-family: "pc-icon";\n}\n\n.fixedFont {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.noSelect {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex, .pcui-panel-header > .pcui-panel-sortable-icon {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden), .pcui-panel-header > .pcui-panel-sortable-icon:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-panel {\n  background-color: #364346;\n}\n\n.pcui-panel-header {\n  background-color: #293538;\n  color: #ffffff;\n  font-size: 12px;\n  white-space: nowrap;\n  padding-left: 10px;\n  flex-shrink: 0;\n  align-items: center;\n}\n\n.pcui-panel-header-title {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  flex: 1;\n  color: inherit;\n  font-size: inherit;\n  white-space: inherit;\n  margin: 0 auto 0 0;\n}\n\n.pcui-panel-content {\n  flex: 1;\n}\n\n.pcui-panel.pcui-collapsible {\n  transition: height 100ms, width 100ms;\n}\n.pcui-panel.pcui-collapsible > .pcui-panel-header {\n  cursor: pointer;\n}\n.pcui-panel.pcui-collapsible > .pcui-panel-header:before {\n  left: 0;\n  content: "\\e179";\n  font-size: 14px;\n  margin-right: 10px;\n  text-align: center;\n  color: #f60;\n}\n.pcui-panel.pcui-collapsible > .pcui-panel-header:hover {\n  color: #ffffff;\n}\n.pcui-panel.pcui-collapsible > .pcui-panel-header:hover:before {\n  color: #ffffff;\n}\n.pcui-panel.pcui-collapsible.pcui-panel-normal > .pcui-panel-header:before {\n  content: "\\e183";\n  font-weight: 200;\n}\n.pcui-panel.pcui-collapsible > .pcui-panel-content {\n  transition: visibility 100ms;\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed {\n  overflow: hidden;\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed > .pcui-panel-content {\n  visibility: hidden;\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed > .pcui-panel-header:before {\n  content: "\\e180";\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed.pcui-panel-normal > .pcui-panel-header:before {\n  content: "\\e184";\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed.pcui-panel-horizontal > .pcui-panel-header {\n  width: 2048px;\n  -webkit-transform: rotate(90deg);\n  -moz-transform: rotate(90deg);\n  -ms-transform: rotate(90deg);\n  -o-transform: rotate(90deg);\n  transform: rotate(90deg);\n  -webkit-transform-origin: 0% 100%;\n  -moz-transform-origin: 0% 100%;\n  -ms-transform-origin: 0% 100%;\n  -o-transform-origin: 0% 100%;\n  transform-origin: 0% 100%;\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed.pcui-panel-horizontal > .pcui-panel-header:before {\n  content: "\\e177";\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed.pcui-panel-horizontal.pcui-panel-normal > .pcui-panel-header:before {\n  content: "\\e181";\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed.pcui-panel-horizontal > .pcui-panel-content {\n  transition: none;\n}\n\n.pcui-panel.pcui-resizable.pcui-collapsible.pcui-collapsed > .pcui-resizable-handle {\n  display: none;\n}\n.pcui-panel.pcui-resizable.pcui-resizable-resizing {\n  transition: none;\n}\n.pcui-panel.pcui-resizable.pcui-resizable-resizing > .pcui-panel-content {\n  transition: none;\n}\n\n.pcui-panel-header > .pcui-panel-sortable-icon {\n  color: #5b7073;\n  transition: color 100ms;\n  flex-direction: row;\n  align-items: center;\n  margin: 0 10px 0 0;\n  height: 100%;\n}\n.pcui-panel-header > .pcui-panel-sortable-icon:before {\n  content: " ";\n  border-left: 1px solid #364346;\n  margin-right: 10px;\n  height: calc(100% - 14px);\n  flex-shrink: 0;\n}\n.pcui-panel-header > .pcui-panel-sortable-icon:after {\n  content: ".. .. ..";\n  white-space: normal;\n  width: 12px;\n  line-height: 5px;\n  overflow: hidden;\n  height: 24px;\n  font-size: 22px;\n  letter-spacing: 1px;\n  flex-shrink: 0;\n}\n\n.pcui-panel:not(.pcui-disabled):not(.pcui-readonly) > .pcui-panel-header > .pcui-panel-sortable-icon:hover {\n  color: #ffffff;\n  cursor: move;\n}\n\n.pcui-panel:not(.pcui-collapsible) > .pcui-panel-header > .pcui-panel-sortable-icon:before {\n  display: none;\n}\n\n.pcui-panel-remove {\n  align-self: flex-end;\n  order: 100;\n}\n.pcui-panel-remove:before {\n  line-height: 30px;\n}\n\n.pcui-panel.pcui-readonly .pcui-panel-remove {\n  display: none;\n}\n\n.pcui-panel-header > .pcui-button {\n  flex-shrink: 0;\n  margin: 1px;\n  background-color: transparent;\n  border: 0;\n}\n\n.pcui-panel.pcui-disabled > .pcui-panel-header {\n  background-color: #303d40;\n  color: #999;\n}\n\n.pcui-subpanel {\n  box-sizing: border-box;\n  margin: 6px;\n  border: 1px solid #293538;\n  border-radius: 2px;\n  background-color: #2c393c;\n  color: #b1b8ba;\n  font-size: 12px;\n}\n.pcui-subpanel .pcui-button {\n  background-color: #364346;\n  border-color: #293538;\n}\n.pcui-subpanel .pcui-button:not(.pcui-disabled):not(.pcui-readonly):hover, .pcui-subpanel .pcui-button:not(.pcui-disabled):not(.pcui-readonly):focus {\n  background-color: #364346;\n}\n.pcui-subpanel .pcui-button:not(.pcui-disabled):not(.pcui-readonly):active {\n  background-color: #2c393c;\n}');const gu="pcui-panel",yu="pcui-panel-header",vu="pcui-panel-horizontal";class Panel extends Container{constructor(t){t||(t={});const e=Object.assign({},t);e.flex=!0,delete e.grid,delete e.flexDirection,delete e.scrollable,super(e),this.class.add(gu),t.panelType&&this.class.add("pcui-panel-"+t.panelType),this._suspendReflow=!0,this._initializeHeader(t),this._initializeContent(t),this.headerSize=void 0!==t.headerSize?t.headerSize:32,this._domEvtDragStart=this._onDragStart.bind(this),this._domEvtDragMove=this._onDragMove.bind(this),this._domEvtDragEnd=this._onDragEnd.bind(this),this._reflowTimeout=null,this._widthBeforeCollapse=null,this._heightBeforeCollapse=null,this.collapsible=t.collapsible||!1,this.collapsed=t.collapsed||!1,this.collapseHorizontally=t.collapseHorizontally||!1,this._iconSort=null,this.sortable=t.sortable||!1,this._btnRemove=null,this.removable=t.removable||!1,this.domContent=this._containerContent.dom,this._suspendReflow=!1,this._reflow()}_initializeHeader(t){this._containerHeader=new Container({flex:!0,flexDirection:"row",class:[yu,jd]}),this._labelTitle=new Label({text:t.headerText,class:["pcui-panel-header-title",jd]}),this._containerHeader.append(this._labelTitle),this._containerHeader.dom.addEventListener("click",this._onHeaderClick.bind(this)),this.append(this._containerHeader)}_onHeaderClick(t){this._collapsible&&(t.target!==this.header.dom&&t.target!==this._labelTitle.dom||(this.collapsed=!this.collapsed))}_onClickRemove(t){t.preventDefault(),t.stopPropagation(),this.emit("click:remove")}_initializeContent(t){this._containerContent=new Container({class:"pcui-panel-content",grid:t.grid,flex:t.flex,flexDirection:t.flexDirection,scrollable:t.scrollable,dom:t.container}),this.append(this._containerContent)}_reflow(){this._suspendReflow||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),!this.hidden&&this.collapsible&&(this.collapsed&&this.collapseHorizontally?this._containerHeader.style.top=-this.headerSize+"px":this._containerHeader.style.top="",this._reflowTimeout=requestAnimationFrame((()=>{this._reflowTimeout=null,this.collapsed?(this._widthBeforeCollapse||(this._widthBeforeCollapse=this.style.width),this._heightBeforeCollapse||(this._heightBeforeCollapse=this.style.height),this._collapseHorizontally?(this.height="",this.width=this.headerSize):this.height=this.headerSize,this.class.add(Ud)):(this.class.remove(Ud),this._collapseHorizontally?(this.height="",null!==this._widthBeforeCollapse&&(this.width=this._widthBeforeCollapse)):null!==this._heightBeforeCollapse&&(this.height=this._heightBeforeCollapse),this._widthBeforeCollapse=null,this._heightBeforeCollapse=null)}))))}_onDragStart(t){this.disabled||this.readOnly||(t.stopPropagation(),t.preventDefault(),window.addEventListener("mouseup",this._domEvtDragEnd),window.addEventListener("mouseleave",this._domEvtDragEnd),window.addEventListener("mousemove",this._domEvtDragMove),this.emit("dragstart"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragStart(t,this))}_onDragMove(t){this.emit("dragmove"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragMove(t,this)}_onDragEnd(t){window.removeEventListener("mouseup",this._domEvtDragEnd),window.removeEventListener("mouseleave",this._domEvtDragEnd),window.removeEventListener("mousemove",this._domEvtDragMove),this._draggedChild===this&&(this._draggedChild=null),this.emit("dragend"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragEnd(t,this)}destroy(){this._destroyed||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),window.removeEventListener("mouseup",this._domEvtDragEnd),window.removeEventListener("mouseleave",this._domEvtDragEnd),window.removeEventListener("mousemove",this._domEvtDragMove),super.destroy())}set collapsible(t){t!==this._collapsible&&(this._collapsible=t,t?this.classAdd(zd):this.classRemove(zd),this._reflow(),this.collapsed&&this.emit(t?"collapse":"expand"))}get collapsible(){return this._collapsible}set collapsed(t){this._collapsed!==t&&(this._collapsed=t,this._reflow(),this.collapsible&&this.emit(t?"collapse":"expand"))}get collapsed(){return this._collapsed}set sortable(t){this._sortable!==t&&(this._sortable=t,t?(this._iconSort=new Label({class:"pcui-panel-sortable-icon"}),this._iconSort.dom.addEventListener("mousedown",this._domEvtDragStart),this.header.prepend(this._iconSort)):this._iconSort&&(this._iconSort.destroy(),this._iconSort=null))}get sortable(){return this._sortable}set removable(t){this.removable!==t&&(t?(this._btnRemove=new Button({icon:"E289",class:"pcui-panel-remove"}),this._btnRemove.on("click",this._onClickRemove.bind(this)),this.header.append(this._btnRemove)):(this._btnRemove.destroy(),this._btnRemove=null))}get removable(){return!!this._btnRemove}set collapseHorizontally(t){this._collapseHorizontally!==t&&(this._collapseHorizontally=t,t?this.classAdd(vu):this.classRemove(vu),this._reflow())}get collapseHorizontally(){return this._collapseHorizontally}get content(){return this._containerContent}get header(){return this._containerHeader}set headerText(t){this._labelTitle.text=t}get headerText(){return this._labelTitle.text}set headerSize(t){this._headerSize=t;const e=this._containerHeader.dom.style;e.height=Math.max(0,t)+"px",e.lineHeight=e.height,this._reflow()}get headerSize(){return this._headerSize}}Element$1.register("panel",Panel),Rd(".noSelect, .pcui-overlay-inner {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex, .pcui-overlay {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden), .pcui-overlay:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-overlay {\n  position: absolute;\n  width: auto;\n  height: auto;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  left: 0;\n  z-index: 101;\n  transition: opacity 100ms, visibility 100ms;\n  justify-content: center;\n  align-items: center;\n  position: absolute;\n}\n\n.pcui-overlay-inner {\n  position: absolute;\n  width: auto;\n  height: auto;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  left: 0;\n  background-color: rgba(32, 41, 43, 0.7);\n}\n\n.pcui-overlay-clickable > .pcui-overlay-inner {\n  cursor: pointer;\n}\n\n.pcui-overlay-transparent > .pcui-overlay-inner {\n  background-color: transparent;\n}\n\n.pcui-overlay-content {\n  background-color: #364346;\n  transition: width 100ms, height 100ms, margin-left 100ms, margin-top 100ms;\n  box-shadow: 7px 7px 7px rgba(0, 0, 0, 0.15);\n}");const bu="pcui-overlay",xu="pcui-overlay-clickable",Su="pcui-overlay-transparent";Element$1.register("overlay",class Overlay extends Container{constructor(t){t||(t={}),super(t),this.class.add(bu),this._domClickableOverlay=document.createElement("div"),this._domClickableOverlay.ui=this,this._domClickableOverlay.classList="pcui-overlay-inner",this.dom.appendChild(this._domClickableOverlay),this._domEventMouseDown=this._onMouseDown.bind(this),this._domClickableOverlay.addEventListener("mousedown",this._domEventMouseDown),this.domContent=document.createElement("div"),this.domContent.ui=this,this.domContent.classList.add("pcui-overlay-content"),this.dom.appendChild(this.domContent),this.clickable=t.clickable||!1,this.transparent=t.transparent||!1}_onMouseDown(t){this.clickable&&(document.body.blur(),requestAnimationFrame((()=>{this.hidden=!0})),t.preventDefault())}position(t,e){const s=this._domClickableOverlay.getBoundingClientRect(),i=this.domContent.getBoundingClientRect();t=Math.max(0,Math.min(s.width-i.width,t)),e=Math.max(0,Math.min(s.height-i.height,e)),this.domContent.style.position="absolute",this.domContent.style.left=`${t}px`,this.domContent.style.top=`${e}px`}destroy(){this._destroyed||(this._domClickableOverlay.removeEventListener("mousedown",this._domEventMouseDown),super.destroy())}set clickable(t){t?this.class.add(xu):this.class.remove(xu)}get clickable(){return this.class.contains(xu)}set transparent(t){t?this.class.add(Su):this.class.remove(Su)}get transparent(){return this.class.contains(Su)}}),Rd(".pcui-divider {\n  height: 1px;\n  background-color: #2c393c;\n  margin: 6px 0;\n}");Element$1.register("divider",class Divider extends Element$1{constructor(t){t||(t={}),super(t.dom?t.dom:document.createElement("div"),t),this.class.add("pcui-divider")}}),Rd('@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .font-icon, .pcui-infobox[data-icon]:not(.pcui-hidden):before {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon, .pcui-infobox[data-icon]:not(.pcui-hidden):before {\n  font-family: "pc-icon";\n}\n\n.fixedFont {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.pcui-infobox {\n  box-sizing: border-box;\n  margin: 6px;\n  padding: 12px;\n  border: 1px solid #293538;\n  border-radius: 2px;\n  background-color: #2c393c;\n  color: #b1b8ba;\n  font-size: 12px;\n}\n.pcui-infobox :first-child {\n  color: #ffffff;\n  margin-bottom: 2px;\n}\n.pcui-infobox[data-icon]:not(.pcui-hidden) {\n  display: grid;\n  grid: auto-flow/min-content 1fr;\n}\n.pcui-infobox[data-icon]:not(.pcui-hidden):before {\n  content: attr(data-icon);\n  font-weight: 100;\n  font-size: 16px;\n  margin-right: 12px;\n  vertical-align: middle;\n  grid-column: 1;\n  grid-row: 1/3;\n}');Element$1.register("infobox",class InfoBox extends Container{constructor(t){t||(t={}),super(t),this.class.add("pcui-infobox"),this._titleElement=new Element$1,this._textElement=new Element$1,this.append(this._titleElement),this.append(this._textElement),this._unsafe=t.unsafe||!1,this.icon=t.icon||"",this.title=t.title||"",this.text=t.text||""}set icon(t){this._icon!==t&&(this._icon=t,t?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(t,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set title(t){this._title!==t&&(this._title=t,this._unsafe?this._titleElement.dom.innerHTML=t:this._titleElement.dom.textContent=t)}get title(){return this._title}set text(t){this._text!==t&&(this._text=t,this._unsafe?this._textElement.dom.innerHTML=t:this._textElement.dom.textContent=t)}get text(){return this._text}});const wu=function(t,e){if(0===t.length)return e.length;if(0===e.length)return t.length;if(t===e)return 0;var s,i,n=[];for(s=0;s<=e.length;s++)n[s]=[s];for(i=0;i<=t.length;i++)n[0][i]=i;for(s=1;s<=e.length;s++)for(i=1;i<=t.length;i++)e.charAt(s-1)===t.charAt(i-1)?n[s][i]=n[s-1][i-1]:n[s][i]=Math.min(n[s-1][i-1]+1,Math.min(n[s][i-1]+1,n[s-1][i]+1));return n[e.length][t.length]},Cu=function(t,e){if(t===e)return t.length;var s,i=0,n={};for(s=0;s<e.length;s++)n[e.charAt(s)]=!0;for(s=0;s<t.length;s++)n[t.charAt(s)]&&i++;return i},Tu=function(t){for(var e=[],s=t.replace(/([^A-Z])([A-Z][^A-Z])/g,"$1 $2").replace(/([A-Z0-9]{2,})/g," $1").split(/(\s|\-|_)/g),i=0;i<s.length;i++)s[i]=s[i].toLowerCase().trim(),s[i]&&"-"!==s[i]&&"_"!==s[i]&&e.push(s[i]);return e},Mu=function(t,e,s){for(var i=[],n=0;n<t.length;n++){var a=t[n];if(a.subFull===1/0)if(a.name!==e&&0!==a.name.indexOf(e)){if(!(Cu(e,a.name)/e.length<s.containsCharsTolerance)){for(var r=1/0,o=1/0,l=0;l<a.tokens.length;l++){if(a.tokens[l]===e){r=0,o=l;break}var h=wu(e,a.tokens[l]);(o===1/0||h<r)&&-1!==a.tokens[l].indexOf(e)?(o=l,r=h):o===1/0&&h<r&&h/Math.max(e.length,a.tokens[l].length)<=s.editsDistanceTolerance&&(r=h)}r!==1/0&&(i.push(a),a.edits=a.edits===1/0?r:a.edits+r,a.sub=a.sub===1/0?o:a.sub+o)}}else i.push(a),a.edits===1/0&&(a.edits=0),a.sub===1/0&&(a.sub=0);else i.push(a),a.edits===1/0&&(a.edits=0),a.sub===1/0&&(a.sub=a.subFull)}return i};Rd('@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .font-icon, .pcui-select-input-create-new > .pcui-label:last-child:before, .pcui-select-input-list .pcui-label.pcui-selected:after, .pcui-select-input-icon:after {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon, .pcui-select-input-create-new > .pcui-label:last-child:before, .pcui-select-input-list .pcui-label.pcui-selected:after, .pcui-select-input-icon:after {\n  font-family: "pc-icon";\n}\n\n.fixedFont, .pcui-select-input-tag > .pcui-label, .pcui-select-input-list .pcui-label, .pcui-select-input-value {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.noSelect {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex, .pcui-select-input-container-value, .pcui-select-input {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden), .pcui-select-input-container-value:not(.pcui-hidden), .pcui-select-input:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-select-input {\n  box-sizing: border-box;\n  margin: 6px;\n  border-radius: 2px;\n  min-width: 0;\n}\n\n.pcui-select-input-container-value {\n  background-color: #2c393c;\n  transition: box-shadow 100ms, opacity 100ms;\n}\n\n.pcui-select-input-shadow {\n  position: absolute;\n  width: 100%;\n  height: 100%;\n  transition: box-shadow 100ms;\n  border-radius: 2px;\n  pointer-events: none;\n  z-index: 1;\n}\n\n.pcui-select-input-value {\n  margin: 0;\n  padding: 0 24px 0 8px;\n  height: 24px;\n  line-height: 24px;\n  font-size: 12px;\n  transition: background-color 100ms, color 100ms;\n}\n.pcui-select-input-value:not(.pcui-hidden) {\n  display: block;\n}\n\n.pcui-select-input-textinput {\n  margin: 0;\n}\n\n.pcui-select-input-textinput:not(.pcui-disabled):not(.pcui-readonly):not(.pcui-error).pcui-focus, .pcui-select-input-textinput:not(.pcui-disabled):not(.pcui-readonly):not(.pcui-error):hover {\n  box-shadow: none;\n}\n\n.pcui-select-input-icon {\n  position: absolute;\n  right: 6px;\n  color: #5b7073;\n  pointer-events: none;\n  transition: color 100ms;\n  margin: 0;\n  height: 24px;\n  line-height: 24px;\n}\n.pcui-select-input-icon:after {\n  content: "\\e159";\n  vertical-align: middle;\n}\n\n.pcui-select-input.pcui-open .pcui-select-input-shadow {\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-select-input.pcui-open .pcui-select-input-value {\n  color: #ffffff;\n  background-color: #20292b;\n}\n.pcui-select-input.pcui-open .pcui-select-input-icon:after {\n  color: #ffffff;\n  content: "\\e157";\n}\n\n.pcui-select-input-list {\n  position: absolute;\n  z-index: 1;\n  top: 100%;\n  width: 100%;\n  max-height: 200px;\n  overflow-y: auto;\n  background-color: #293538;\n}\n.pcui-select-input-list .pcui-label {\n  font-size: 12px;\n  height: 22px;\n  line-height: 22px;\n  padding: 0 24px 0 6px;\n  margin: 0;\n  transition: background-color 100ms, color 100ms;\n}\n.pcui-select-input-list .pcui-label:not(.pcui-hidden) {\n  display: block;\n}\n.pcui-select-input-list .pcui-label.pcui-selected {\n  color: #ffffff;\n}\n.pcui-select-input-list .pcui-label.pcui-selected:after {\n  content: "\\e133";\n  color: #5b7073;\n  position: absolute;\n  right: 6px;\n}\n\n.pcui-select-input-fit-height .pcui-select-input-list {\n  top: initial;\n  bottom: 100%;\n}\n.pcui-select-input-fit-height .pcui-select-input-shadow {\n  top: initial;\n  bottom: 0;\n}\n\n.pcui-select-input-tags:not(.pcui-select-input-tags-empty) {\n  margin-top: 1px;\n  flex-wrap: wrap;\n}\n\n.pcui-select-input-tag {\n  background-color: #293538;\n  align-items: center;\n  border-radius: 2px;\n  border: 1px solid #232e30;\n  margin-right: 2px;\n  margin-top: 2px;\n  min-width: 0;\n  height: 18px;\n}\n.pcui-select-input-tag > * {\n  margin: 0;\n  background-color: transparent;\n  border: 0;\n}\n.pcui-select-input-tag > .pcui-label {\n  padding: 0 5px 0 8px;\n}\n.pcui-select-input-tag > .pcui-button {\n  padding: 0 5px;\n  height: 18px;\n  line-height: 18px;\n  flex-shrink: 0;\n}\n.pcui-select-input-tag > .pcui-button:not(.pcui-disabled):not(.pcui-readonly):hover {\n  box-shadow: none;\n  color: #d34141;\n}\n\n.pcui-select-input-tag-not-everywhere > .pcui-label {\n  opacity: 0.5;\n}\n.pcui-select-input-tag-not-everywhere > .pcui-label:before {\n  content: "*";\n  margin-right: 5px;\n}\n\n.pcui-select-input:not(.pcui-disabled):not(.pcui-readonly) .pcui-select-input-container-value:hover .pcui-select-input-shadow {\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-select-input:not(.pcui-disabled):not(.pcui-readonly) .pcui-select-input-container-value:hover .pcui-select-input-icon {\n  color: #9ba1a3;\n}\n.pcui-select-input:not(.pcui-disabled):not(.pcui-readonly).pcui-focus .pcui-select-input-shadow {\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-select-input:not(.pcui-disabled):not(.pcui-readonly).pcui-focus .pcui-select-input-icon {\n  color: #9ba1a3;\n}\n.pcui-select-input:not(.pcui-disabled):not(.pcui-readonly) .pcui-select-input-value:hover {\n  color: #ffffff;\n  background-color: #20292b;\n  cursor: pointer;\n}\n.pcui-select-input:not(.pcui-disabled):not(.pcui-readonly) .pcui-select-input-list > *:hover, .pcui-select-input:not(.pcui-disabled):not(.pcui-readonly) .pcui-select-input-list > .pcui-select-input-label-highlighted {\n  background-color: #20292b;\n  color: #ffffff;\n  cursor: pointer;\n}\n\n.pcui-select-input-create-new > .pcui-label {\n  padding-right: 6px;\n}\n.pcui-select-input-create-new > .pcui-label:last-child {\n  flex-shrink: 0;\n  margin-left: auto;\n}\n.pcui-select-input-create-new > .pcui-label:last-child:before {\n  content: "\\e120";\n  margin-right: 6px;\n}\n\n.pcui-select-input.pcui-disabled {\n  opacity: 0.4;\n}\n\n.pcui-select-input.pcui-readonly .pcui-select-input-icon {\n  display: none;\n}\n.pcui-select-input.pcui-readonly.pcui-select-input-multi .pcui-select-input-container-value {\n  display: none;\n}\n.pcui-select-input.pcui-readonly.pcui-select-input-multi .pcui-select-input-tag > .pcui-button {\n  display: none;\n}\n.pcui-select-input.pcui-readonly.pcui-select-input-allow-input:not(.pcui-select-input-multi) {\n  opacity: 0.7;\n}\n.pcui-select-input.pcui-readonly.pcui-select-input-allow-input:not(.pcui-select-input-multi) .pcui-select-input-textinput:after {\n  display: none;\n}');const Au="pcui-select-input",Pu="pcui-select-input-multi",Eu="pcui-select-input-tags-empty",Lu="pcui-select-input-fit-height",Ru="pcui-selected",Iu="pcui-select-input-label-highlighted",Du="pcui-open";class SelectInput extends Element$1{constructor(t){t||(t={});const e=new Container({dom:t.dom});super(e.dom,t),this._container=e,this._container.parent=this,this.class.add(Au),this._containerValue=new Container({class:"pcui-select-input-container-value"}),this._container.append(this._containerValue),this._domShadow=document.createElement("div"),this._domShadow.classList.add("pcui-select-input-shadow"),this._containerValue.append(this._domShadow),this._allowInput=t.allowInput||!1,this._allowInput&&this.class.add("pcui-select-input-allow-input"),this._allowCreate=t.allowCreate||!1,this._createFn=t.createFn,this._createLabelText=t.createLabelText||null,this._labelValue=new Label({class:"pcui-select-input-value",tabIndex:0}),this._labelValue.on("click",this._onValueClick.bind(this)),this._containerValue.append(this._labelValue),this._timeoutLabelValueTabIndex=null,this._labelIcon=new Label({class:"pcui-select-input-icon",hidden:t.allowInput&&t.multiSelect}),this._containerValue.append(this._labelIcon),this._input=new TextInput({class:"pcui-select-input-textinput",blurOnEnter:!1,keyChange:!0}),this._containerValue.append(this._input),this._lastInputValue="",this._suspendInputChange=!1,this._input.on("change",this._onInputChange.bind(this)),this._input.on("keydown",this._onInputKeyDown.bind(this)),this._input.on("focus",this._onFocus.bind(this)),this._input.on("blur",this._onBlur.bind(this)),t.placeholder&&(this.placeholder=t.placeholder),this._containerOptions=new Container({class:"pcui-select-input-list",hidden:!0}),this._containerValue.append(this._containerOptions),this._containerTags=new Container({class:"pcui-select-input-tags",flex:!0,flexDirection:"row",hidden:!0}),this._container.append(this._containerTags),t.multiSelect&&(this.class.add(Pu),this._containerTags.hidden=!1),this._domEvtKeyDown=this._onKeyDown.bind(this),this._domEvtFocus=this._onFocus.bind(this),this._domEvtBlur=this._onBlur.bind(this),this._domEvtMouseDown=this._onMouseDown.bind(this),this._domEvtWindowMouseDown=this._onWindowMouseDown.bind(this),this._domEvtWheel=this._onWheel.bind(this),this._labelValue.dom.addEventListener("keydown",this._domEvtKeyDown),this._labelValue.dom.addEventListener("focus",this._domEvtFocus),this._labelValue.dom.addEventListener("blur",this._domEvtBlur),this._labelValue.dom.addEventListener("mousedown",this._domEvtMouseDown),this._containerOptions.dom.addEventListener("wheel",this._domEvtWheel,{passive:!0}),this.on("hide",this.close.bind(this)),this._type=t.type||"string",this._optionsIndex={},this._labelsIndex={},this._labelHighlighted=null,this.invalidOptions=t.invalidOptions,this.options=t.options||[],this._optionsFn=t.optionsFn,this._allowNull=t.allowNull||!1,this._values=null,void 0!==t.value?this.value=t.value:t.defaultValue?this.value=t.defaultValue:this.value=null,this.renderChanges=t.renderChanges||!1,this.on("change",(()=>{this._updateInputFieldsVisibility(),this.renderChanges&&!this.multiSelect&&this._labelValue.flash()})),this._updateInputFieldsVisibility(!1)}_initializeCreateLabel(){const t=new Container({class:"pcui-select-input-create-new",flex:!0,flexDirection:"row"}),e=new Label({text:this._input.value,tabIndex:-1});t.append(e);let s=this._input.on("change",(s=>{e.destroyed||(e.text=s,this.invalidOptions&&-1!==this.invalidOptions.indexOf(s)?t.hidden||(t.hidden=!0,this._resizeShadow()):t.hidden&&(t.hidden=!1,this._resizeShadow()))}));t.on("click",(t=>{t.stopPropagation();const s=e.text;this.focus(),this.close(),this._createFn?this._createFn(s):s&&this._onSelectValue(s)})),e.on("destroy",(()=>{s.unbind(),s=null}));const i=new Label({text:this._createLabelText});return t.append(i),this._containerOptions.append(t),t}_convertSingleValue(t){if(null===t&&this._allowNull)return t;if("string"===this._type)t=t?t.toString():"";else if("number"===this._type)t=t?parseInt(t,10):0;else if("boolean"===this._type)return!!t;return t}_convertValue(t){return null===t&&this._allowNull?t:this.multiSelect?Array.isArray(t)?t.map((t=>this._convertSingleValue(t))):t:this._convertSingleValue(t)}_onValueClick(){this.enabled&&!this.readOnly&&this.toggle()}_onSelectValue(t){if(t=this._convertSingleValue(t),this.multiSelect)if(this._values){let e=!1;this._values.forEach((s=>{s?-1===s.indexOf(t)&&(s.push(t),e=!0):(s=[t],e=!0)})),e&&(this._onMultipleValuesChange(this._values),this.emit("change",this.value),this._binding&&this._binding.addValues([t]))}else this._value&&Array.isArray(this._value)?-1===this._value.indexOf(t)&&(this._value.push(t),this._addTag(t),this.emit("change",this.value),this._binding&&this._binding.addValues([t])):this.value=[t];else this.value=t}_highlightLabel(t){if(this._labelHighlighted!==t&&(this._labelHighlighted&&this._labelHighlighted.class.remove(Iu),this._labelHighlighted=t,this._labelHighlighted)){this._labelHighlighted.class.add(Iu);const t=this._labelHighlighted.dom.offsetTop,e=this._containerOptions.dom.scrollTop;t<e?this._containerOptions.dom.scrollTop=t:t+this._labelHighlighted.height>this._containerOptions.height+e&&(this._containerOptions.dom.scrollTop=t+this._labelHighlighted.height-this._containerOptions.height)}}_onValueChange(t){if(this.multiSelect){if(this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(Eu),t&&Array.isArray(t)){t.forEach((t=>{this._addTag(t),this._labelsIndex[t]&&this._labelsIndex[t].class.add(Ru)}));for(const e in this._labelsIndex)-1!==t.indexOf(this._convertSingleValue(e))?this._labelsIndex[e].class.add(Ru):this._labelsIndex[e].class.remove(Ru)}}else for(var e in this._labelValue.value=this._optionsIndex[t]||"",t=""+t,this._labelsIndex)e===t?this._labelsIndex[e].class.add(Ru):this._labelsIndex[e].class.remove(Ru)}_onMultipleValuesChange(t){this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(Eu);const e={},s={};for(var i in t.forEach((t=>{t&&t.forEach((t=>{e[t]?s[t]++:(e[t]=this._addTag(t),s[t]=1)}))})),s)s[i]!==t.length&&(e[i].class.add("pcui-select-input-tag-not-everywhere"),this._labelsIndex[i]&&this._labelsIndex[i].class.remove(Ru))}_addTag(t){const e=new Container({flex:!0,flexDirection:"row",class:"pcui-select-input-tag"});e.append(new Label({text:this._optionsIndex[t]||t}));const s=new Button({size:"small",icon:"E132",tabIndex:-1});return e.append(s),s.on("click",(()=>this._removeTag(e,t))),this._containerTags.append(e),this._containerTags.class.remove(Eu),this._labelsIndex[t]&&this._labelsIndex[t].class.add(Ru),e.value=t,e}_removeTag(t,e){if(t.destroy(),this._labelsIndex[e]&&this._labelsIndex[e].class.remove(Ru),this._values)this._values.forEach((t=>{if(!t)return;const s=t.indexOf(e);-1!==s&&t.splice(s,1)}));else if(this._value&&Array.isArray(this._value)){const t=this._value.indexOf(e);-1!==t&&this._value.splice(t,1)}this.emit("change",this.value),this._binding&&this._binding.removeValues([e])}_onInputChange(t){this._suspendInputChange||this._lastInputValue!==t&&(this.open(),this._lastInputValue=t,this._filterOptions(t))}_filterOptions(t){const e=this._containerOptions.dom;for(;e.firstChild;)e.removeChild(e.lastChild);if(t){(function(t,e,s){let i;if(!(e=(e||"").toLowerCase().trim()))return[];var n=Tu(e);if(!n.length)return[];(s=s||{}).containsCharsTolerance=s.containsCharsTolerance||.5,s.editsDistanceTolerance=s.editsDistanceTolerance||.5;var a=[];for(i=0;i<t.length;i++){var r=t[i][0].toLowerCase().trim().indexOf(e);a.push({name:t[i][0],item:t[i][1],tokens:Tu(t[i][0]),edits:1/0,subFull:-1!==r?r:1/0,sub:1/0})}for(i=0;i<n.length;i++)a=Mu(a,n[i],s);for(a.sort(((t,e)=>t.subFull!==e.subFull?t.subFull-e.subFull:t.sub!==e.sub?t.sub-e.sub:t.edits!==e.edits?t.edits-e.edits:t.name.length-e.name.length)),i=0;i<a.length;i++)a[i]=a[i].item;return s.hasOwnProperty("limitResults")&&a.length>s.limitResults&&(a=a.slice(0,s.limitResults)),a})(this.options.map((t=>[t.t,t.v])),t).forEach((t=>{e.appendChild(this._labelsIndex[t].dom)}))}else this.options.forEach((t=>{e.appendChild(this._labelsIndex[t.v].dom)}));this._createLabelContainer&&e.appendChild(this._createLabelContainer.dom),e.firstChild&&this._highlightLabel(e.firstChild.ui),this._resizeShadow()}_onInputKeyDown(t){if(13===t.keyCode&&this.enabled&&!this.readOnly){let e;if(t.stopPropagation(),t.preventDefault(),e=this._labelHighlighted&&void 0!==this._labelHighlighted._optionValue?this._labelHighlighted._optionValue:this._input.value,void 0!==e)return this.focus(),this.close(),void(this._optionsIndex[e]?this._onSelectValue(e):this._allowCreate&&(this._createFn?this._createFn(e):this._onSelectValue(e)))}this._onKeyDown(t)}_onWindowMouseDown(t){this.dom.contains(t.target)||this.close()}_onKeyDown(t){if(27!==t.keyCode)if(9!==t.keyCode){if(this.enabled&&!this.readOnly)if(13!==t.keyCode||this._allowInput){if(-1!==[38,40].indexOf(t.keyCode))if(t.stopPropagation(),t.preventDefault(),(this._allowInput||this.multiSelect)&&this._containerOptions.hidden)this.open();else if(this._containerOptions.hidden){if(!this._options.length)return;let e=-1;for(let t=0;t<this._options.length;t++)if(this._options[t].v===this.value){e=t;break}38===t.keyCode?e--:40===t.keyCode&&e++,e>=0&&e<this._options.length&&this._onSelectValue(this._options[e].v)}else{if(!this._containerOptions.dom.childNodes.length)return;if(this._labelHighlighted){let e=this._labelHighlighted.dom;do{38===t.keyCode?e=e.previousSibling:40===t.keyCode&&(e=e.nextSibling)}while(e&&e.ui.hidden);e&&this._highlightLabel(e.ui)}else this._highlightLabel(this._containerOptions.dom.childNodes[0].ui)}}else this._labelHighlighted&&void 0!==this._labelHighlighted._optionValue&&(this._onSelectValue(this._labelHighlighted._optionValue),this.close())}else this.close();else this.close()}_resizeShadow(){this._domShadow.style.height=this._containerValue.height+this._containerOptions.height+"px"}_onMouseDown(){this._allowInput||this.focus()}_onFocus(){this.class.add(Nd),this.emit("focus"),this._input.hidden||this.open()}_onBlur(){this.class.remove(Nd),this.emit("blur")}_onWheel(t){t.stopPropagation()}_updateInputFieldsVisibility(t){let e=!1,s=!1;this._allowInput&&(t?(e=!0,s=!0):e=this.multiSelect||!this._labelsIndex[this.value]),this._labelValue.hidden=e,this._labelIcon.hidden=e,this._input.hidden=!e,s&&this._input.focus(),this._labelValue.hidden||(this._labelValue.tabIndex=-1,this._timeoutLabelValueTabIndex||(this._timeoutLabelValueTabIndex=requestAnimationFrame((()=>{this._timeoutLabelValueTabIndex=null,this._labelValue.tabIndex=0}))))}focus(){this._input.hidden?this._labelValue.dom.focus():this._input.focus()}blur(){this._allowInput?this._input.blur():this._labelValue.dom.blur()}open(){if(!this._containerOptions.hidden||!this.enabled||this.readOnly)return;if(this._updateInputFieldsVisibility(!0),this._optionsFn&&(this.options=this._optionsFn()),0===this._containerOptions.dom.childNodes.length)return;this._containerOptions.forEachChild((t=>{t.hidden=!1,t._optionValue===this.value&&this._highlightLabel(t)})),this._labelHighlighted||this._highlightLabel(this._containerOptions.dom.childNodes[0].ui),this._containerOptions.hidden=!1,this.class.add(Du),window.addEventListener("keydown",this._domEvtKeyDown),window.addEventListener("mousedown",this._domEvtWindowMouseDown);const t=(this._allowInput?this._input.dom:this._labelValue.dom).getBoundingClientRect();let e=t.bottom+this._containerOptions.height+25>=window.innerHeight;e&&t.top-this._containerOptions.height<0&&(e=!1,this._containerOptions.style.maxHeight=window.innerHeight-t.bottom-25+"px"),e?this.class.add(Lu):this.class.remove(Lu),this._resizeShadow()}close(){this._containerOptions.style.maxHeight="",this._highlightLabel(null),this._updateInputFieldsVisibility(!1),this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this._containerOptions.hidden||(this._containerOptions.hidden=!0,this._domShadow.style.height="",this.class.remove(Du),window.removeEventListener("keydown",this._domEvtKeyDown),window.removeEventListener("mousedown",this._domEvtWindowMouseDown))}toggle(){this._containerOptions.hidden?this.open():this.close()}unlink(){super.unlink(),this._containerOptions.hidden||this.close()}destroy(){this._destroyed||(this._labelValue.dom.removeEventListener("keydown",this._domEvtKeyDown),this._labelValue.dom.removeEventListener("mousedown",this._domEvtMouseDown),this._labelValue.dom.removeEventListener("focus",this._domEvtFocus),this._labelValue.dom.removeEventListener("blur",this._domEvtBlur),this._containerOptions.dom.removeEventListener("wheel",this._domEvtWheel),window.removeEventListener("keydown",this._domEvtKeyDown),window.removeEventListener("mousedown",this._domEvtWindowMouseDown),this._timeoutLabelValueTabIndex&&(cancelAnimationFrame(this._timeoutLabelValueTabIndex),this._timeoutLabelValueTabIndex=null),super.destroy())}set options(t){this._options&&this._options===t||(this._containerOptions.clear(),this._labelHighlighted=null,this._optionsIndex={},this._labelsIndex={},this._options=t,this._options.forEach((t=>{if(this._optionsIndex[t.v]=t.t,""===t.v)return;const e=new Label({text:t.t,tabIndex:-1});e._optionValue=t.v,this._labelsIndex[t.v]=e,e.on("click",(e=>{e.stopPropagation(),this._onSelectValue(t.v),this.close()})),this._containerOptions.append(e)})),this._createLabelContainer=null,this._createLabelText&&(this._createLabelContainer=this._initializeCreateLabel()),this.multiSelect&&this._values?this._onMultipleValuesChange(this._values):this._onValueChange(this.value),this._lastInputValue&&this._filterOptions(this._lastInputValue))}get options(){return this._options.slice()}set invalidOptions(t){this._invalidOptions=t||null}get invalidOptions(){return this._invalidOptions}get multiSelect(){return this.class.contains(Pu)}set value(t){this._values=null,this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this.class.remove(Hd),t=this._convertValue(t),(!(this._value===t||this.multiSelect&&this._value&&this._value.equals(t))||null===t&&this._allowNull&&this.class.contains(Hd))&&(this._value=t,this._onValueChange(t),this.emit("change",t),this._binding&&this._binding.setValue(t))}get value(){if(!this.multiSelect)return this._value;const t=[];return this._containerTags.dom.childNodes.forEach((e=>{t.push(e.ui.value)})),t}set values(t){let e=!1;const s=(t=t.map(this._convertValue.bind(this)))[0],i=this.multiSelect;this._values=null;for(let n=1;n<t.length;n++)if(!(t[n]===s||i&&t[n]&&t[n].equals(s))){e=!0;break}e?(this._labelValue.values=t,i?(this._values=t,this._value=null,this._onMultipleValuesChange(this._values),this.emit("change",this.value)):null!==this._value&&(this._value=null,this.emit("change",null)),this.class.add(Hd)):this.value=t[0]}set placeholder(t){this._input.placeholder=t}get placeholder(){return this._input.placeholder}}Element$1.register("select",SelectInput,{renderChanges:!0}),Element$1.register("multiselect",SelectInput,{multiSelect:!0,renderChanges:!0}),Element$1.register("tags",SelectInput,{allowInput:!0,allowCreate:!0,multiSelect:!0,renderChanges:!0}),Rd("@keyframes animation-spin {\n  from {\n    transform: rotate(0deg);\n  }\n  to {\n    transform: rotate(360deg);\n  }\n}\n.pcui-spinner {\n  display: inline-block;\n  margin: 6px;\n  vertical-align: middle;\n}\n.pcui-spinner > path {\n  animation-name: animation-spin;\n  animation-duration: 750ms;\n  animation-iteration-count: infinite;\n  animation-timing-function: linear;\n  transform-origin: center;\n}\n.pcui-spinner.pcui-error > path {\n  animation: none;\n  fill: #ff2020;\n}\n.pcui-spinner.pcui-error > path.pcui-spinner-highlight {\n  fill: #ff7777;\n}");class Spinner extends Element$1{constructor(t){let e=null;(t=Object.assign({type:Spinner.TYPE_SMALL_THICK},t)).type===Spinner.TYPE_SMALL_THICK&&(e=function(t,e){const s=e||document.createElementNS("http://www.w3.org/2000/svg","svg");return s.classList.add("spin"),s.setAttribute("width",t),s.setAttribute("height",t),s.setAttribute("viewBox","0 0 14 14"),s.setAttribute("fill","none"),s.innerHTML='<path d="M7 14C3.13871 14 0 10.8613 0 7C0 3.13871 3.13871 0 7 0C10.8613 0 14 3.13871 14 7C14 10.8613 10.8613 14 7 14ZM7 2.25806C4.38064 2.25806 2.25806 4.38064 2.25806 7C2.25806 9.61935 4.38064 11.7419 7 11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7C11.7419 4.38064 9.61935 2.25806 7 2.25806Z" fill="#773417"/><path class="pcui-spinner-highlight" d="M7 14V11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7H14C14 10.8613 10.8613 14 7 14Z" fill="#FF6600"/>',s}(t.size||12,t.dom)),super(e,t),this.class.add("pcui-spinner")}}Spinner.TYPE_SMALL_THICK="small-thick",Rd(".pcui-progress {\n  height: 4px;\n  background-color: #20292b;\n  transition: opacity 100ms;\n  width: 100%;\n}\n.pcui-progress .pcui-progress-inner {\n  width: 0%;\n  height: inherit;\n  background: #f60;\n  background: -webkit-gradient(left top, right bottom, color-stop(0%, #ff6600), color-stop(25%, #ff6600), color-stop(26%, #a84300), color-stop(50%, #a84300), color-stop(51%, #ff6600), color-stop(75%, #ff6600), color-stop(76%, #a84300), color-stop(100%, #a84300));\n  background: -webkit-linear-gradient(-45deg, #ff6600 0%, #ff6600 25%, #a84300 26%, #a84300 50%, #ff6600 51%, #ff6600 75%, #a84300 76%, #a84300 100%);\n  background: -moz-linear-gradient(-45deg, #ff6600 0%, #ff6600 25%, #a84300 26%, #a84300 50%, #ff6600 51%, #ff6600 75%, #a84300 76%, #a84300 100%);\n  background: -ms-linear-gradient(-45deg, #ff6600 0%, #ff6600 25%, #a84300 26%, #a84300 50%, #ff6600 51%, #ff6600 75%, #a84300 76%, #a84300 100%);\n  background: -o-linear-gradient(-45deg, #ff6600 0%, #ff6600 25%, #a84300 26%, #a84300 50%, #ff6600 51%, #ff6600 75%, #a84300 76%, #a84300 100%);\n  background: linear-gradient(135deg, #ff6600 0%, #ff6600 25%, #a84300 26%, #a84300 50%, #ff6600 51%, #ff6600 75%, #a84300 76%, #a84300 100%);\n  background-position: 0px 0px;\n  background-size: 24px 24px;\n  background-repeat: repeat;\n  -webkit-animation: pcui-progress-background 1000ms linear infinite;\n  animation: pcui-progress-background 1000ms linear infinite;\n}\n\n.pcui-progress.pcui-error .pcui-progress-inner {\n  background: #f60;\n  background: -webkit-gradient(left top, right bottom, color-stop(0%, #ff7777), color-stop(25%, #ff7777), color-stop(26%, #ff2020), color-stop(50%, #ff2020), color-stop(51%, #ff7777), color-stop(75%, #ff7777), color-stop(76%, #ff2020), color-stop(100%, #ff2020));\n  background: -webkit-linear-gradient(-45deg, #ff7777 0%, #ff7777 25%, #ff2020 26%, #ff2020 50%, #ff7777 51%, #ff7777 75%, #ff2020 76%, #ff2020 100%);\n  background: -moz-linear-gradient(-45deg, #ff7777 0%, #ff7777 25%, #ff2020 26%, #ff2020 50%, #ff7777 51%, #ff7777 75%, #ff2020 76%, #ff2020 100%);\n  background: -ms-linear-gradient(-45deg, #ff7777 0%, #ff7777 25%, #ff2020 26%, #ff2020 50%, #ff7777 51%, #ff7777 75%, #ff2020 76%, #ff2020 100%);\n  background: -o-linear-gradient(-45deg, #ff7777 0%, #ff7777 25%, #ff2020 26%, #ff2020 50%, #ff7777 51%, #ff7777 75%, #ff2020 76%, #ff2020 100%);\n  background: linear-gradient(135deg, #ff7777 0%, #ff7777 25%, #ff2020 26%, #ff2020 50%, #ff7777 51%, #ff7777 75%, #ff2020 76%, #ff2020 100%);\n  background-position: 0px 0px;\n  background-size: 24px 24px;\n  background-repeat: repeat;\n  -webkit-animation: none;\n  animation: none;\n}\n\n@-webkit-keyframes pcui-progress-background {\n  from {\n    background-position: 0px 0;\n  }\n  to {\n    background-position: 24px 0;\n  }\n}\n@keyframes pcui-progress-background {\n  from {\n    background-position: 0px 0;\n  }\n  to {\n    background-position: 24px 0;\n  }\n}");const ku="pcui-progress";Element$1.register("progress",class Progress extends Container{constructor(t){t||(t={}),super(t),this.class.add(ku),this._inner=new Element$1,this.append(this._inner),this._inner.class.add("pcui-progress-inner"),void 0!==t.value&&(this.value=t.value)}set value(t){this._value!==t&&(this._value=t,this._inner.width=`${this._value}%`,this.emit("change",t))}get value(){return this._value}}),Rd('.pcui-contextmenu {\n  box-sizing: border-box;\n  border: 1px solid #293538;\n  border-radius: 2px;\n  background-color: #2c393c;\n  color: #b1b8ba;\n  font-size: 12px;\n  font-weight: 400;\n  display: none;\n  position: fixed;\n  z-index: 9999;\n}\n\n.pcui-contextmenu-active {\n  display: block;\n}\n\n.pcui-contextmenu div {\n  background-color: #2c393c;\n  width: 150px;\n  position: absolute;\n}\n.pcui-contextmenu div:before {\n  content: "";\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  z-index: -1;\n  box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);\n}\n\n.pcui-contextmenu-parent {\n  cursor: auto !important;\n}\n.pcui-contextmenu-parent div {\n  display: none;\n}\n\n.pcui-contextmenu-parent:hover div {\n  display: block;\n}\n\n.pcui-contextmenu-parent-active div {\n  display: block;\n}\n\n.pcui-contextmenu {\n  div-font-weight: bold;\n}\n.pcui-contextmenu div:hover {\n  background-color: #364346;\n  cursor: pointer;\n}\n.pcui-contextmenu div.pcui-contextmenu-parent:after {\n  content: "\\e160";\n  font-family: "pc-icon";\n  font-size: 14px;\n  text-align: center;\n  background-color: transparent;\n  color: #9ba1a3;\n  line-height: 14px;\n  position: absolute;\n  right: 4px;\n  top: 50%;\n  transform: translateY(-50%);\n}');const Fu="pcui-contextmenu",Ou="pcui-contextmenu-active",Vu="pcui-contextmenu-parent",Bu="pcui-contextmenu-parent-active";Element$1.register("contextmenu",class ContextMenu{constructor(t){t||(t={}),this._menu=new Container({dom:t.dom}),this._menu.contextMenu=this,this.args=t,this._menu.class.add(Fu);var e,s=this._menu,i=()=>{this._menu.class.remove(Ou),document.removeEventListener("click",i)},n=t.triggerElement||t.dom.parentElement;n&&(this._contextMenuEvent=n.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation(),s.class.add(Ou);var n=27*t.items.length,a=e.clientX,r=e.clientY;n+r>window.innerHeight&&(r-=n+r-window.innerHeight);150+a>window.innerWidth&&(a-=150+a-window.innerWidth);s.dom.setAttribute("style",`left: ${a}px; top: ${r}px`),document.addEventListener("click",i)})),s.dom.addEventListener("mouseleave",(()=>{e=setTimeout((()=>{i()}),500)})),s.dom.addEventListener("mouseenter",(()=>{e&&clearTimeout(e)})));t.items&&t.items.forEach(((t,e)=>{var s=new Container;s.dom.setAttribute("style",`top: ${27*e}px`),t.onClick&&s.on("click",(e=>{e.stopPropagation(),i(),t.onClick(e)}));var n=new Label({text:t.text});s.append(n),this._menu.dom.append(s.dom),t.items&&(t.items.forEach(((t,e)=>{var n=new Container({class:"pcui-contextmenu-child"});n.dom.setAttribute("style",`top: ${27*e}px; left: 150px;`),n.on("click",(e=>{e.stopPropagation(),i(),t.onClick(e)}));var a=new Label({text:t.text});n.append(a),s.append(n)})),s.class.add(Vu)),s.dom.addEventListener("mouseover",(e=>{this._menu.forEachChild((t=>t.class.remove(Bu))),s.class.add(Bu);var i=t.items?27*t.items.length:0,n=e.clientX+150>window.innerWidth?-148:150,a=0;e.clientY+i>window.innerHeight&&(a=27-i),s.forEachChild(((t,e)=>{0!==e&&t.dom.setAttribute("style",`top: ${a+27*(e-1)}px; left: ${n}px;`)}))}))}))}}),Rd('@charset "UTF-8";\n@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .font-icon, .pcui-treeview-item:not(.pcui-treeview-item-empty) > .pcui-treeview-item-contents:before, .pcui-treeview-item-icon:after {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon, .pcui-treeview-item:not(.pcui-treeview-item-empty) > .pcui-treeview-item-contents:before, .pcui-treeview-item-icon:after {\n  font-family: "pc-icon";\n}\n\n.fixedFont {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.noSelect, .pcui-treeview {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-treeview {\n  min-width: max-content;\n}\n\n.pcui-treeview-item {\n  position: relative;\n  padding-left: 24px;\n}\n.pcui-treeview-item:before {\n  content: " ";\n  position: absolute;\n  background-color: #313e41;\n  width: 2px;\n  left: 14px;\n  top: -12px;\n  bottom: 12px;\n}\n.pcui-treeview-item:last-child:before {\n  height: 25px;\n  bottom: auto;\n}\n\n.pcui-treeview-item.pcui-disabled > .pcui-treeview-item-contents > .pcui-treeview-item-text {\n  opacity: 0.4;\n}\n\n.pcui-treeview-item-contents {\n  position: relative;\n  color: #b1b8ba;\n  margin-left: 3px;\n  border: 1px solid transparent;\n  align-items: center;\n  height: 24px;\n  box-sizing: border-box;\n}\n.pcui-treeview-item-contents:hover {\n  cursor: pointer;\n  color: #ffffff;\n  background-color: #2c393c;\n}\n.pcui-treeview-item-contents:hover > .pcui-treeview-item-icon {\n  color: #ffffff;\n}\n\n.pcui-treeview-item-icon {\n  color: #5b7073;\n  margin: 0 2px 0 0;\n  flex-shrink: 0;\n}\n.pcui-treeview-item-icon:before {\n  content: " ";\n  position: absolute;\n  background-color: #313e41;\n  left: -12px;\n  top: 10px;\n  width: 24px;\n  height: 2px;\n}\n.pcui-treeview-item-icon:after {\n  content: "\\e360";\n  display: inline-block;\n  vertical-align: sub;\n  width: 22px;\n  height: 22px;\n  position: relative;\n  z-index: 1;\n  text-align: center;\n}\n\n.pcui-treeview-item-text {\n  margin: 0;\n  flex-shrink: 0;\n  position: relative;\n  z-index: 1;\n  transition: opacity 100ms;\n  padding-right: 8px;\n  color: inherit;\n}\n\n.pcui-treeview-item-contents.pcui-treeview-item-selected {\n  background-color: #20292b;\n  color: #ffffff;\n}\n.pcui-treeview-item-contents.pcui-treeview-item-selected > .pcui-treeview-item-icon {\n  color: #ffffff;\n}\n\n.pcui-treeview-item:not(.pcui-treeview-item-empty) > .pcui-treeview-item-contents:before {\n  content: "\\e120";\n  position: absolute;\n  font-size: 10px;\n  font-weight: bold;\n  text-align: center;\n  color: #b1b8ba;\n  background-color: #2c393c;\n  top: 0;\n  left: -24px;\n  width: 16px;\n  height: 16px;\n  line-height: 16px;\n  margin: 3px;\n  cursor: pointer;\n  z-index: 1;\n}\n.pcui-treeview-item:not(.pcui-treeview-item-empty).pcui-treeview-item-open > .pcui-treeview-item-contents:before {\n  content: "\\e121";\n}\n\n.pcui-treeview > .pcui-treeview-item {\n  padding-left: 0;\n}\n.pcui-treeview > .pcui-treeview-item:before {\n  content: none;\n}\n.pcui-treeview > .pcui-treeview-item > .pcui-treeview-item-contents {\n  margin-left: 0;\n}\n.pcui-treeview > .pcui-treeview-item > .pcui-treeview-item-contents > .pcui-treeview-item-icon:before {\n  content: none;\n}\n.pcui-treeview > .pcui-treeview-item > .pcui-treeview-item-contents > .pcui-treeview-item-icon:after {\n  margin-left: 0;\n}\n.pcui-treeview > .pcui-treeview-item > .pcui-treeview-item {\n  padding-left: 21px;\n}\n.pcui-treeview > .pcui-treeview-item > .pcui-treeview-item:before {\n  left: 11px;\n}\n\n.pcui-treeview:not(.pcui-treeview-filtering) > .pcui-treeview-item .pcui-treeview-item:not(.pcui-treeview-item-open):not(.pcui-treeview-item-empty) > .pcui-treeview-item {\n  display: none;\n}\n\n.pcui-treeview-item-dragged > .pcui-treeview-item-contents {\n  background-color: rgba(44, 57, 60, 0.5);\n  color: #ffffff;\n}\n\n.pcui-treeview-drag-handle {\n  position: fixed;\n  width: 32px;\n  height: 20px;\n  top: 0;\n  bottom: 0;\n  z-index: 4;\n  margin-top: -1px;\n  margin-left: -1px;\n}\n.pcui-treeview-drag-handle.before {\n  border-top: 4px solid #f60;\n  padding-right: 8px;\n  height: 24px;\n}\n.pcui-treeview-drag-handle.inside {\n  border: 4px solid #f60;\n}\n.pcui-treeview-drag-handle.after {\n  border-bottom: 4px solid #f60;\n  padding-right: 8px;\n  height: 24px;\n}\n\n.pcui-treeview-item-contents:after {\n  content: " ";\n  display: block;\n  clear: both;\n}\n\n.pcui-treeview-item.pcui-treeview-item-rename > .pcui-treeview-item-contents > .pcui-treeview-item-text {\n  display: none;\n}\n.pcui-treeview-item.pcui-treeview-item-rename > .pcui-treeview-item-contents > .pcui-text-input {\n  margin: 0;\n  flex-grow: 1;\n  box-shadow: none !important;\n  border: 0;\n  background-color: transparent;\n}\n.pcui-treeview-item.pcui-treeview-item-rename > .pcui-treeview-item-contents > .pcui-text-input > input {\n  font-family: inherit;\n  font-size: 14px;\n  padding: 0;\n}\n\n.pcui-treeview.pcui-treeview-filtering .pcui-treeview-item {\n  padding-left: 0;\n}\n.pcui-treeview.pcui-treeview-filtering .pcui-treeview-item::before {\n  display: none;\n}\n.pcui-treeview.pcui-treeview-filtering .pcui-treeview-item:not(.pcui-treeview-filtering-result) > .pcui-treeview-item-contents {\n  display: none;\n}\n.pcui-treeview.pcui-treeview-filtering .pcui-treeview-item-contents {\n  margin-left: 0;\n}\n\n.pcui-treeview-filtering-result .pcui-treeview-item-contents:before,\n.pcui-treeview-filtering-result .pcui-treeview-item-icon:before {\n  display: none;\n}'),Rd(".noSelect {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex, .pcui-label-group {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden), .pcui-label-group:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-label-group {\n  align-items: center;\n  flex-direction: row;\n  flex-wrap: nowrap;\n  margin: 6px;\n}\n.pcui-label-group > .pcui-label:first-child {\n  width: 100px;\n  flex-shrink: 0;\n  margin: 0;\n}\n.pcui-label-group > .pcui-element:not(:first-child) {\n  margin: 0 0 0 6px;\n}\n.pcui-label-group > .pcui-element:nth-child(2):not(.pcui-not-flexible) {\n  flex: 1;\n}\n.pcui-label-group > .pcui-vector-input > .pcui-numeric-input {\n  margin-top: 0;\n  margin-bottom: 0;\n}\n\n.pcui-label-group-align-top > .pcui-label:first-child {\n  align-self: flex-start;\n  margin-top: 4px;\n}\n\n.pcui-label-group.pcui-disabled > .pcui-label:first-child {\n  opacity: 0.4;\n}");const zu="pcui-label-group",Uu="pcui-label-group-align-top";Element$1.register("labelgroup",class LabelGroup extends Container{constructor(t){t||(t={}),super(t),this.class.add(zu),this._label=new Label({text:t.text||"Label",nativeTooltip:t.nativeTooltip}),this.append(this._label),this._field=t.field,this._field&&this.append(this._field),this.labelAlignTop=t.labelAlignTop||!1}get label(){return this._label}get field(){return this._field}set text(t){this._label.text=t}get text(){return this._label.text}set labelAlignTop(t){t?this.class.add(Uu):this.class.remove(Uu)}get labelAlignTop(){return this.class.contains(Uu)}});class BindingBase extends Events{constructor(t){super(),t||(t={}),this._observers=null,this._paths=null,this._applyingChange=!1,this._element=t.element||null,this._history=t.history||null,this._historyPrefix=t.historyPrefix||null,this._historyPostfix=t.historyPostfix||null,this._historyName=t.historyName||null,this._historyCombine=t.historyCombine||!1,this._linked=!1}_pathAt(t,e){return t[e]||t[0]}link(t,e){this._observers&&this.unlink(),this._observers=Array.isArray(t)?t:[t],this._paths=Array.isArray(e)?e:[e],this._linked=!0}unlink(){this._observers=null,this._paths=null,this._linked=!1}clone(){throw new Error("pcui.BindingBase#clone: Not implemented")}setValue(t){}setValues(t){}addValue(t){}addValues(t){}removeValue(t){}removeValues(t){}set element(t){this._element=t}get element(){return this._element}set applyingChange(t){this._applyingChange!==t&&(this._applyingChange=t,this.emit("applyingChange",t))}get applyingChange(){return this._applyingChange}get linked(){return this._linked}set historyCombine(t){this._historyCombine=t}get historyCombine(){return this._historyCombine}set historyName(t){this._historyName=t}get historyName(){return this._historyName}set historyPrefix(t){this._historyPrefix=t}get historyPrefix(){return this._historyPrefix}set historyPostfix(t){this._historyPostfix=t}get historyPostfix(){return this._historyPostfix}set historyEnabled(t){this._history&&(this._history.enabled=t)}get historyEnabled(){return this._history&&this._history.enabled}get observers(){return this._observers}get paths(){return this._paths}}class BindingObserversToElement extends BindingBase{constructor({customUpdate:t,...e}={}){super(e),this._customUpdate=t,this._events=[],this._updateElementHandler=this._updateElement.bind(this),this._updateTimeout=null}_linkObserver(t,e){this._events.push(t.on(e+":set",this._deferUpdateElement.bind(this))),this._events.push(t.on(e+":unset",this._deferUpdateElement.bind(this))),this._events.push(t.on(e+":insert",this._deferUpdateElement.bind(this))),this._events.push(t.on(e+":remove",this._deferUpdateElement.bind(this)))}_deferUpdateElement(){this.applyingChange||(this.applyingChange=!0,this._updateTimeout=setTimeout(this._updateElementHandler))}_updateElement(){this._updateTimeout&&(clearTimeout(this._updateTimeout),this._updateTimeout=null),this._updateTimeout=null,this.applyingChange=!0,"function"==typeof this._customUpdate?this._customUpdate(this._element,this._observers,this._paths):1===this._observers.length?this._paths.length>1?this._element.value=this._paths.map((t=>this._observers[0].has(t)?this._observers[0].get(t):void 0)):this._element.value=this._observers[0].has(this._paths[0])?this._observers[0].get(this._paths[0]):void 0:this._element.values=this._observers.map(((t,e)=>{const s=this._pathAt(this._paths,e);return t.has(s)?t.get(s):void 0})),this.applyingChange=!1}link(t,e){super.link(t,e);const s=this._element.renderChanges;if(s&&(this._element.renderChanges=!1),this._updateElement(),s&&(this._element.renderChanges=s),1===this._observers.length&&this._paths.length>1)for(let i=0;i<this._paths.length;i++)this._linkObserver(this._observers[0],this._paths[i]);else for(let i=0;i<this._observers.length;i++)this._linkObserver(this._observers[i],this._pathAt(this._paths,i))}unlink(){for(let t=0;t<this._events.length;t++)this._events[t].unbind();this._events.length=0,this._updateTimeout&&(clearTimeout(this._updateTimeout),this._updateTimeout=null),super.unlink()}clone(){return new BindingObserversToElement({customUpdate:this._customUpdate})}}Rd(".noSelect {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex, .pcui-gridview-item {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden), .pcui-gridview-item:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-gridview-item {\n  box-sizing: border-box;\n  justify-content: center;\n  align-items: center;\n  flex-shrink: 0;\n  width: 104px;\n}\n.pcui-gridview-item:not(.pcui-disabled) {\n  cursor: pointer;\n}\n.pcui-gridview-item:not(.pcui-disabled):not(.pcui-gridview-item-selected):hover {\n  background-color: #293538;\n}\n\n.pcui-gridview-item-selected {\n  background-color: #20292b;\n}\n\n.pcui-gridview-item-text {\n  max-width: 100px;\n  font-size: 12px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  margin: 0;\n  padding: 0 2px;\n}"),Rd(".noSelect {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex, .pcui-gridview {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden), .pcui-gridview:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-gridview {\n  flex-direction: row;\n  flex-wrap: wrap;\n  align-content: flex-start;\n}"),Rd(".pcui-array-input {\n  margin: 6px;\n  min-width: 0;\n}\n.pcui-array-input > .pcui-numeric-input {\n  margin: 0 0 6px 0;\n}\n\n.pcui-array-input.pcui-array-empty > .pcui-numeric-input {\n  margin: 0;\n}\n\n.pcui-array-input-item > * {\n  margin-top: 1px;\n  margin-bottom: 1px;\n}\n.pcui-array-input-item > *:first-child:not(.pcui-not-flexible):not(.pcui-panel-header) {\n  flex: 1;\n}\n.pcui-array-input-item > .pcui-button {\n  margin-left: -3px;\n  margin-right: 0;\n  background-color: transparent;\n  border: 0;\n}\n\n.pcui-array-input-item-asset > .pcui-button {\n  margin-top: 36px;\n}\n\n.pcui-array-input.pcui-readonly .pcui-array-input-item-delete {\n  display: none;\n}");const Nu="pcui-array-input",Hu="pcui-array-empty",Wu="pcui-array-input-item";class ArrayInput extends Element$1{constructor(t){const e=(t=Object.assign({},t)).binding;delete t.binding;const s=new Container({dom:t.dom,flex:!0});super(s.dom,t),this._container=s,this._container.parent=this,this.class.add(Nu,Hu),this._usePanels=t.usePanels||!1,this._fixedSize=!!t.fixedSize,this._inputSize=new NumericInput({class:["pcui-array-input-size"],placeholder:"Array Size",value:0,hideSlider:!0,step:1,precision:0,min:0,readOnly:this._fixedSize}),this._inputSize.on("change",this._onSizeChange.bind(this)),this._inputSize.on("focus",this._onFocus.bind(this)),this._inputSize.on("blur",this._onBlur.bind(this)),this._suspendSizeChangeEvt=!1,this._container.append(this._inputSize),this._containerArray=new Container({class:"pcui-array-input-items",hidden:!0}),this._containerArray.on("append",(()=>{this._containerArray.hidden=!1})),this._containerArray.on("remove",(()=>{this._containerArray.hidden=0==this._arrayElements.length})),this._container.append(this._containerArray),this._suspendArrayElementEvts=!1,this._arrayElementChangeTimeout=null,this._getDefaultFn=t.getDefaultFn||null;let i=t.elementArgs&&t.elementArgs.type||t.type;ArrayInput.DEFAULTS.hasOwnProperty(i)||(i="string"),delete t.dom,this._valueType=i,this._elementType=t.type,this._elementArgs=t.elementArgs||t,this._arrayElements=[],this.binding=e,this._values=[],t.value&&(this.value=t.value),this.renderChanges=t.renderChanges||!1}_onSizeChange(t){if(0===t?this.class.add(Hu):this.class.remove(Hu),null===t)return;if(this._suspendSizeChangeEvt)return;let e;const s=()=>{if(this._getDefaultFn)e=this._getDefaultFn();else if(e=ArrayInput.DEFAULTS[this._valueType],"curveset"===this._valueType){if(e=nu.deepCopy(e),Array.isArray(this._elementArgs.curves))for(let t=0;t<this._elementArgs.curves.length;t++)e.keys.push([0,0])}else if("gradient"===this._valueType&&(e=nu.deepCopy(e),this._elementArgs.channels))for(let t=0;t<this._elementArgs.channels;t++)e.keys.push([0,1])},i=this._values.map((i=>{if(i)if(i.length<t){const n=new Array(t-i.length);for(let t=0;t<n.length;t++)n[t]=nu.deepCopy(ArrayInput.DEFAULTS[this._valueType]),void 0===e&&s(),n[t]=nu.deepCopy(e);i=i.concat(n)}else{const e=new Array(t);for(let s=0;s<t;s++)e[s]=nu.deepCopy(i[s]);i=e}else{i=new Array(t);for(let n=0;n<t;n++)i[n]=nu.deepCopy(ArrayInput.DEFAULTS[this._valueType]),void 0===e&&s(),i[n]=nu.deepCopy(e)}return i}));if(!i.length){const n=new Array(t);for(let i=0;i<t;i++)n[i]=nu.deepCopy(ArrayInput.DEFAULTS[this._valueType]),void 0===e&&s(),n[i]=nu.deepCopy(e);i.push(n)}this._updateValues(i,!0)}_onFocus(){this.emit("focus")}_onBlur(){this.emit("blur")}_createArrayElement(){const t=Object.assign({},this._elementArgs);let e;t.binding?t.binding=t.binding.clone():this._binding&&(t.binding=this._binding.clone()),t.renderChanges=!1,e=this._usePanels?new Panel({headerText:`[${this._arrayElements.length}]`,removable:!this._fixedSize,collapsible:!0,class:[Wu,Wu+"-"+this._elementType]}):new Container({flex:!0,flexDirection:"row",alignItems:"center",class:[Wu,Wu+"-"+this._elementType]}),"json"===this._elementType&&t.attributes&&(t.attributes=t.attributes.map((t=>{if(!t.path)return t;const e=(t=Object.assign({},t)).path.split(".");return e.splice(e.length-1,0,this._arrayElements.length),t.path=e.join("."),t})));const s=Element$1.create(this._elementType,t);e.append(s),s.renderChanges=this.renderChanges;const i={container:e,element:s};if(this._arrayElements.push(i),this._usePanels)e.on("click:remove",(()=>{this._removeArrayElement(i)}));else if(!this._fixedSize){const t=new Button({icon:"E289",size:"small",class:"pcui-array-input-item-delete",tabIndex:-1});t.on("click",(()=>{this._removeArrayElement(i)})),e.append(t)}return s.on("change",(t=>{this._onArrayElementChange(i,t)})),this._containerArray.append(e),i}_removeArrayElement(t){const e=this._arrayElements.indexOf(t);if(-1===e)return;const s=this._values.map((t=>t?(t.splice(e,1),t):null));this._updateValues(s,!0)}_onArrayElementChange(t,e){if(this._suspendArrayElementEvts)return;const s=this._arrayElements.indexOf(t);-1!==s&&(this._values.forEach((t=>{t&&t.length>s&&(t[s]=e)})),this._arrayElementChangeTimeout=setTimeout((()=>{this._arrayElementChangeTimeout=null,this.emit("change",this.value)})))}_linkArrayElement(t,e){const s=this._binding.observers,i=this._binding.paths,n=1===i.length||s.length!==i.length;t.unlink(),t.value=null,this.emit("unlinkElement",t,e);const a=n?i[0]+`.${e}`:i.map((t=>`${t}.${e}`));t.link(s,a),this.emit("linkElement",t,e,a)}_updateValues(t,e){this._values=t||[],this._suspendArrayElementEvts=!0,this._suspendSizeChangeEvt=!0,e&&this._binding&&this._binding.setValues(t);const s=[],i=[];t.forEach((t=>{t&&(i.push(t.length),t.forEach(((t,e)=>{s[e]||(s[e]=[]),s[e].push(t)})))}));let n=-1;for(let a=0;a<s.length&&s[a].length===t.length;a++)this._arrayElements[a]||this._createArrayElement(),this._binding&&this._binding.observers?this._linkArrayElement(this._arrayElements[a].element,a):s[a].length>1?this._arrayElements[a].element.values=s[a]:this._arrayElements[a].element.value=s[a][0],n=a;for(let a=this._arrayElements.length-1;a>n;a--)this._arrayElements[a].container.destroy(),this._arrayElements.splice(a,1);this._inputSize.values=i,this._suspendSizeChangeEvt=!1,this._suspendArrayElementEvts=!1,this._arrayElementChangeTimeout&&(clearTimeout(this._arrayElementChangeTimeout),this._arrayElementChangeTimeout=null),this.emit("change",this.value)}focus(){this._inputSize.focus()}blur(){this._inputSize.blur()}forEachArrayElement(t){this._containerArray.forEachChild(((e,s)=>t(e.dom.firstChild.ui,s)))}destroy(){this._destroyed||(this._arrayElements.length=0,super.destroy())}set binding(t){super.binding=t,this._arrayElements.forEach((e=>{e.element.binding=t?t.clone():null}))}get binding(){return super.binding}set value(t){Array.isArray(t)||(t=[]);const e=this.value||[];nu.arrayEquals(e,t)||this._updateValues(new Array(this._values.length||1).fill(t),!0)}get value(){return this._arrayElements.map((t=>t.element.value))}set values(t){nu.arrayEquals(this._values,t)||this._updateValues(t,!1)}set renderChanges(t){this._renderChanges=t,this._arrayElements.forEach((e=>{e.element.renderChanges=t}))}get renderChanges(){return this._renderChanges}}ArrayInput.DEFAULTS={boolean:!1,number:0,string:"",vec2:[0,0],vec3:[0,0,0],vec4:[0,0,0,0]};for(const Yu in ArrayInput.DEFAULTS)Element$1.register(`array:${Yu}`,ArrayInput,{type:Yu,renderChanges:!0});Element$1.register("array:select",ArrayInput,{type:"select",renderChanges:!0}),Rd('@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .font-icon, .pcui-menu-item-content > .pcui-label[data-icon]:before, .pcui-menu-item-has-children > .pcui-menu-item-content > .pcui-label:after {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon, .pcui-menu-item-content > .pcui-label[data-icon]:before, .pcui-menu-item-has-children > .pcui-menu-item-content > .pcui-label:after {\n  font-family: "pc-icon";\n}\n\n.fixedFont {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.noSelect {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-menu-item {\n  position: relative;\n  background-color: #20292b;\n  width: auto;\n}\n\n.pcui-menu-item-children {\n  box-shadow: 0px 0px 8px rgba(0, 0, 0, 0.6);\n  position: absolute;\n  z-index: 1;\n  left: 100%;\n  top: 0;\n  opacity: 0;\n  transition: opacity 100ms, visibility 100ms;\n  visibility: hidden;\n}\n\n.pcui-menu-item:hover > .pcui-menu-item-children {\n  opacity: 1;\n  visibility: visible;\n}\n\n.pcui-menu-item-has-children > .pcui-menu-item-content > .pcui-label {\n  padding-right: 32px;\n}\n.pcui-menu-item-has-children > .pcui-menu-item-content > .pcui-label:after {\n  content: "\\e160";\n  position: absolute;\n  right: 6px;\n}\n\n.pcui-menu-item-content {\n  min-width: 158px;\n  color: #9ba1a3;\n  border-bottom: 1px solid #263134;\n  cursor: pointer;\n}\n.pcui-menu-item-content:hover {\n  color: #ffffff;\n  background-color: #5b7073;\n}\n.pcui-menu-item-content > .pcui-label {\n  transition: none;\n}\n\n.pcui-menu-item:last-child > .pcui-menu-item-content {\n  border-bottom: none;\n}\n\n.pcui-menu-item-content > .pcui-label {\n  color: inherit;\n}\n.pcui-menu-item-content > .pcui-label[data-icon]:before {\n  content: attr(data-icon);\n  font-weight: 100;\n  font-size: inherit;\n  margin-right: 6px;\n  vertical-align: middle;\n}\n\n.pcui-menu-item.pcui-disabled .pcui-menu-item-content {\n  cursor: default;\n}\n.pcui-menu-item.pcui-disabled .pcui-menu-item-content:hover {\n  color: #9ba1a3;\n  background-color: transparent;\n}\n.pcui-menu-item.pcui-disabled .pcui-menu-item-content > .pcui-label {\n  cursor: default;\n  opacity: 0.4;\n}'),Rd('@font-face {\n  font-family: "pc-icon";\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot");\n  src: url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.eot?#iefix") format("embedded-opentype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff2") format("woff2"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.woff") format("woff"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.ttf") format("truetype"), url("https://playcanvas.com/static-assets/fonts/PlayIcons-Regular.svg") format("svg");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-smooth, .font-icon {\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  font-smoothing: antialiased;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.font-icon {\n  font-family: "pc-icon";\n}\n\n.fixedFont {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.noSelect {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.pcui-flex {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden) {\n  display: -webkit-flex;\n  display: flex;\n}\n\n.pcui-grid {\n  display: -ms-grid;\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n.pcui-menu {\n  position: absolute;\n  z-index: 401;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  left: 0;\n  width: auto;\n  height: auto;\n}\n\n.pcui-menu-items {\n  position: fixed;\n  top: 0;\n  left: 0;\n}');class BindingElementToObservers extends BindingBase{clone(){return new BindingElementToObservers({history:this._history,historyPrefix:this._historyPrefix,historyPostfix:this._historyPostfix,historyName:this._historyName,historyCombine:this._historyCombine})}_getHistoryActionName(t){return`${this._historyPrefix||""}${this._historyName||t[0]}${this._historyPostfix||""}`}_setValue(t,e){if(this.applyingChange)return;if(!this._observers)return;this.applyingChange=!0;const s=this._observers.slice(),i=this._paths.slice(),n={observers:s,paths:i},a=()=>{this._setValueToObservers(s,i,t,e),this.emit("history:redo",n)};if(this._history){let t=[];t=1===s.length&&i.length>1?i.map((t=>s[0].has(t)?s[0].get(t):void 0)):s.map(((t,e)=>{const s=this._pathAt(i,e);return t.has(s)?t.get(s):void 0})),this.emit("history:init",n),this._history.add({name:this._getHistoryActionName(i),redo:a,combine:this._historyCombine,undo:()=>{this._setValueToObservers(s,i,t,!0),this.emit("history:undo",n)}})}a(),this.applyingChange=!1}_setValueToObservers(t,e,s,i){if(1===t.length&&e.length>1)for(let n=0;n<e.length;n++){const i=t[0].latest();if(!i)continue;let a=!1;i.history&&(a=i.history.enabled,i.history.enabled=!1);const r=e[n],o=s[n];void 0!==s?this._observerSet(i,r,o):i.unset(r),a&&(i.history.enabled=!0)}else for(let n=0;n<t.length;n++){const a=t[n].latest();if(!a)continue;let r=!1;a.history&&(r=a.history.enabled,a.history.enabled=!1);const o=this._pathAt(e,n),l=i?s[n]:s;void 0!==s?this._observerSet(a,o,l):a.unset(o),r&&(a.history.enabled=!0)}}_observerSet(t,e,s){const i=e.lastIndexOf(".");if(i>0&&!t.has(e.substring(0,i)))return;const n=Array.isArray(s);t.set(e,n&&s?s.slice():s)}_addValues(t){if(this.applyingChange)return;if(!this._observers)return;this.applyingChange=!0;const e=this._observers.slice(),s=this._paths.slice(),i=[];for(let a=0;a<e.length;a++){const n=this._pathAt(s,a),r=e[a];t.forEach((t=>{-1===r.get(n).indexOf(t)&&i.push({observer:r,path:n,value:t})}))}const n=()=>{for(let t=0;t<i.length;t++){const e=i[t].observer.latest();if(!e)continue;const s=i[t].path;let n=!1;e.history&&(n=e.history.enabled,e.history.enabled=!1),e.insert(s,i[t].value),n&&(e.history.enabled=!0)}};this._history&&i.length&&this._history.add({name:this._getHistoryActionName(s),redo:n,combine:this._historyCombine,undo:()=>{for(let t=0;t<i.length;t++){const e=i[t].observer.latest();if(!e)continue;const s=i[t].path;let n=!1;e.history&&(n=e.history.enabled,e.history.enabled=!1),e.removeValue(s,i[t].value),n&&(e.history.enabled=!0)}}}),n(),this.applyingChange=!1}_removeValues(t){if(this.applyingChange)return;if(!this._observers)return;this.applyingChange=!0;const e=this._observers.slice(),s=this._paths.slice(),i=[];for(let a=0;a<e.length;a++){const n=this._pathAt(s,a),r=e[a];t.forEach((t=>{const e=r.get(n).indexOf(t);-1!==e&&i.push({observer:r,path:n,value:t,index:e})}))}const n=()=>{for(let t=0;t<i.length;t++){const e=i[t].observer.latest();if(!e)continue;const s=i[t].path;let n=!1;e.history&&(n=e.history.enabled,e.history.enabled=!1),e.removeValue(s,i[t].value),n&&(e.history.enabled=!0)}};this._history&&i.length&&this._history.add({name:this._getHistoryActionName(s),redo:n,combine:this._historyCombine,undo:()=>{for(let t=0;t<i.length;t++){const e=i[t].observer.latest();if(!e)continue;const s=i[t].path;let n=!1;e.history&&(n=e.history.enabled,e.history.enabled=!1),-1===e.get(s).indexOf(i[t].value)&&e.insert(s,i[t].value,i[t].index),n&&(e.history.enabled=!0)}}}),n(),this.applyingChange=!1}setValue(t){this._setValue(t,!1)}setValues(t){t=t.slice().map((t=>Array.isArray(t)?t.slice():t)),this._setValue(t,!0)}addValue(t){this._addValues([t])}addValues(t){this._addValues(t)}removeValue(t){this._removeValues([t])}removeValues(t){this._removeValues(t)}}class BindingTwoWay extends BindingBase{constructor(t){t||(t={}),super(t),this._bindingElementToObservers=t.bindingElementToObservers||new BindingElementToObservers(t),this._bindingObserversToElement=t.bindingObserversToElement||new BindingObserversToElement(t),this._applyingChange=!1,this._bindingElementToObservers.on("applyingChange",(t=>{this.applyingChange=t})),this._bindingElementToObservers.on("history:init",(t=>{this.emit("history:init",t)})),this._bindingElementToObservers.on("history:undo",(t=>{this.emit("history:undo",t)})),this._bindingElementToObservers.on("history:redo",(t=>{this.emit("history:redo",t)})),this._bindingObserversToElement.on("applyingChange",(t=>{this.applyingChange=t}))}link(t,e){super.link(t,e),this._bindingElementToObservers.link(t,e),this._bindingObserversToElement.link(t,e)}unlink(){this._bindingElementToObservers.unlink(),this._bindingObserversToElement.unlink(),super.unlink()}clone(){return new BindingTwoWay({bindingElementToObservers:this._bindingElementToObservers.clone(),bindingObserversToElement:this._bindingObserversToElement.clone()})}setValue(t){this._bindingElementToObservers.setValue(t)}setValues(t){this._bindingElementToObservers.setValues(t)}addValue(t){this._bindingElementToObservers.addValue(t)}addValues(t){this._bindingElementToObservers.addValues(t)}removeValue(t){this._bindingElementToObservers.removeValue(t)}removeValues(t){this._bindingElementToObservers.removeValues(t)}set element(t){this._element=t,this._bindingElementToObservers.element=t,this._bindingObserversToElement.element=t}get element(){return this._element}set applyingChange(t){super.applyingChange!==t&&(this._bindingElementToObservers.applyingChange=t,this._bindingObserversToElement.applyingChange=t,super.applyingChange=t)}get applyingChange(){return super.applyingChange}set historyCombine(t){this._bindingElementToObservers.historyCombine=t}get historyCombine(){return this._bindingElementToObservers.historyCombine}set historyPrefix(t){this._bindingElementToObservers.historyPrefix=t}get historyPrefix(){return this._bindingElementToObservers.historyPrefix}set historyPostfix(t){this._bindingElementToObservers.historyPostfix=t}get historyPostfix(){return this._bindingElementToObservers.historyPostfix}set historyEnabled(t){this._bindingElementToObservers.historyEnabled=t}get historyEnabled(){return this._bindingElementToObservers.historyEnabled}}class BladeControls{constructor({...t}){const{name:e,meshMorphsIndex:s,bladeRotationOffset:i,bladeRotation:n}=t;this.name=e,this.meshMorphsIndex=s||[],this.bladeRotationOffset=i||0,this.bladeRotation=n||{},this.controls={ui:Pd("<div></div>"),observers:{}},this.init()}init(){this.createControls()}getControls(t){return t?this.controls[t]:this.controls}createControls(){const t=document.createElement("DIV"),e=document.createElement("DIV"),s=new Label({enabled:!0,height:null,text:this.name.toUpperCase(),tabIndex:0,width:null});e.appendChild(s.dom),s.dom.style.color="#FF0000",e.style.marginTop=e.style.marginBottom="15px",t.appendChild(e);const i=document.createElement("DIV"),n=this.meshMorphsIndex;for(var a=0;a<n.length;a++){const t=document.createElement("DIV"),e=new Label({enabled:!0,height:null,text:"morph: "+n[a].id,tabIndex:0,width:null});t.appendChild(e.dom),i.appendChild(t);const s=new Observer({progress:0}),r=new SliderInput({enabled:!0,height:null,max:1,min:0,binding:new BindingTwoWay,pre:0,sliderMax:1,sliderMin:0,step:0,tabIndex:0,width:null});r.link(s,"progress"),i.appendChild(r.dom),this.controls.observers[n[a].id]={idx:n[a].idx,observer:s,type:"morph"}}t.appendChild(i);const r=document.createElement("DIV");for(let o in this.bladeRotation){const t=document.createElement("DIV"),e=new Label({enabled:!0,height:null,text:"rot: "+o,tabIndex:0,width:null});t.appendChild(e.dom),r.appendChild(t);const s=new Observer({progress:this.bladeRotation[o]}),i=new SliderInput({enabled:!0,height:null,max:360,min:0,binding:new BindingTwoWay,pre:0,value:this.bladeRotation[o],sliderMax:360,sliderMin:0,step:0,tabIndex:0,width:null});i.link(s,"progress"),r.appendChild(i.dom),this.controls.observers[o]={idx:o,observer:s,type:"rotation"}}t.appendChild(r),this.controls.ui.appendChild(t)}}class Blade{constructor({...t}){const{name:e,index:s,layers:i,graphicsDevice:n,controls:a,meshMorphsIndex:r,bladeRotationOffset:o,bladeRotation:l}=t;this.name=e,this.index=s,this.layers=i,this.graphicsDevice=n,this.meshMorphsIndex=r,this.bladeRotationOffset=o,this.bladeRotation=l,this.material=new Material({color:Ld[this.name]||Ld.blank,depth:this.index,graphicsDevice:this.graphicsDevice}),this.morphing=this.meshMorphsIndex.reduce(((t,e)=>(t[e.id]=0,t)),{}),this.rotation={x:0,y:0,z:0},this.quads={x:new Quat,y:new Quat,z:new Quat,f:new Quat},this.hasControls=!0===a,this.controls=null,this.init()}init(){this.createMesh(),this.createMorphTargets(),this.createMorphInstance(),this.createMeshInstance(),this.createEntity(),this.setRotation(this.bladeRotation),this.createControls()}getEntity(){return this.entity}getMorphTargetsCount(){return this.morphTargets.length}getMeshMorphsIndex(){return this.meshMorphsIndex}getControls(t){return this.controls.getControls(t)}setRotation(t,e){if(void 0!==e&&this.hasControls)if(Array.isArray(e))for(var s=0;s<e.length;s++)this.controls.getControls().observers[e[s]].observer.set("progress",t[e[s]]);else this.controls.getControls().observers[e].observer.set("progress",t[e]);else this.rotation={...this.rotation,...t},this.quads.y.setFromEulerAngles(0,this.rotation.y,0),this.quads.x.setFromEulerAngles(this.rotation.x,0,0),this.quads.z.setFromEulerAngles(0,0,this.rotation.z),this.quads.f.setFromEulerAngles(0,0,0),this.quads.f.mul(this.quads.y).mul(this.quads.x).mul(this.quads.z),this.entity.setLocalRotation(this.quads.f)}getRotation(t){return void 0!==t?this.rotation[t]:this.rotation}getBladeRotation(t){return void 0!==t?this.bladeRotation[t]:this.bladeRotation}getStateRotation(){return this.rotation}getStateMorphing(){return this.morphing}updateMorphtarget(t,e,s){void 0!==s&&this.hasControls?this.controls.getControls().observers[s].observer.set("progress",e):(this.morphing[this.meshMorphsIndex.find((({idx:e})=>e===t)).id]=e,this.morphInstance.setWeight(t,e))}createMesh(){const t=new Float32Array(Sd),e=new Float32Array(Cd);this.mesh=new Mesh(this.graphicsDevice),this.mesh.clear(!0,!1),this.mesh.setPositions(t),this.mesh.setNormals(oi(t,wd)),this.mesh.setUvs(0,e),this.mesh.setIndices(wd),this.mesh.update(4)}createMorphTargets(){this.morphTargets=[];for(var t=0;t<Td.length;t++){const e=new Float32Array(Td[t]),s=new Float32Array(oi(e,wd)),i=new MorphTarget({deltaPositions:e,deltaNormals:s,defaultWeight:0});this.morphTargets.push(i)}}createMorphInstance(){this.mesh.morph=new Morph(this.morphTargets,this.graphicsDevice),this.morphInstance=new MorphInstance(this.mesh.morph)}createMeshInstance(){this.meshInstance=new MeshInstance(this.mesh,this.material.getMaterial()),this.meshInstance.morphInstance=this.morphInstance}createEntity(){this.entity=new Entity,this.entity.name=this.name,this.entity.addComponent("render",{meshInstances:[this.meshInstance]}),this.entity.translate(0,0,-Ad(this.index/1e3))}createControls(){!0===this.hasControls&&(this.controls=new BladeControls({name:this.name,meshMorphsIndex:this.meshMorphsIndex,bladeRotationOffset:this.bladeRotationOffset,bladeRotation:this.bladeRotation}))}}const Gu=({...t})=>{const{app:e,count:s,defaultZoom:i,canZoom:n}=t;var a=Hc("orbitCamera",e);return a.attributes.add("layerCount",{type:"number",default:s,title:"Custom layers count"}),a.attributes.add("distanceDefault",{type:"number",default:i,title:"Distance Default"}),a.attributes.add("distanceMax",{type:"number",default:!0===n&&null!==i?0:i,title:"Distance Max",description:"Setting this at 0 will give an infinite distance limit"}),a.attributes.add("distanceMin",{type:"number",default:!0===n&&null!==i?0:i,title:"Distance Min"}),a.attributes.add("inertiaFactor",{type:"number",default:0,title:"Inertia Factor",description:"Higher value means that the camera will continue moving after the user has stopped dragging. 0 is fully responsive."}),a.attributes.add("focusEntity",{type:"entity",title:"Focus Entity",description:"Entity for the camera to focus on. If blank, then the camera will use the whole scene"}),a.attributes.add("frameOnStart",{type:"boolean",default:!0,title:"Frame on Start",description:'Frames the entity or scene at the start of the application."'}),Object.defineProperty(a.prototype,"distance",{get:function(){return this._targetDistance},set:function(t){this._targetDistance=this._clampDistance(t)}}),Object.defineProperty(a.prototype,"pitch",{get:function(){return this._targetPitch},set:function(t){this._targetPitch=this._clampPitchAngle(t)}}),Object.defineProperty(a.prototype,"yaw",{get:function(){return this._targetYaw},set:function(t){this._targetYaw=t;var e=(this._targetYaw-this._yaw)%360;this._targetYaw=e>180?this._yaw-(360-e):e<-180?this._yaw+(360+e):this._yaw+e}}),Object.defineProperty(a.prototype,"pivotPoint",{get:function(){return this._pivotPoint},set:function(t){this._pivotPoint.copy(t)}}),a.prototype.focus=function(t){this._buildAabb(t,0);var e=this._modelsAabb.halfExtents;if(null!==this.distanceDefault)this.distance=this.distanceDefault;else{var s=Math.max(e.x,Math.max(e.y,e.z));s/=Math.tan(.5*this.entity.camera.fov*O.DEG_TO_RAD),s*=2,this.distance=s}this._removeInertia(),this._pivotPoint.copy(this._modelsAabb.center)},a.distanceBetween=new Vec3,a.prototype.resetAndLookAtPoint=function(t,e){this.pivotPoint.copy(e),this.entity.setPosition(t),this.entity.lookAt(e);var s=a.distanceBetween;s.sub2(e,t),this.distance=s.length(),this.pivotPoint.copy(e);var i=this.entity.getRotation();this.yaw=this._calcYaw(i),this.pitch=this._calcPitch(i,this.yaw),this._removeInertia(),this._updatePosition()},a.prototype.resetAndLookAtEntity=function(t,e){this._buildAabb(e,0),this.resetAndLookAtPoint(t,this._modelsAabb.center)},a.prototype.reset=function(t,e,s){this.pitch=e,this.yaw=t,this.distance=s,this._removeInertia()},a.prototype.initialize=function(){this.entity.addComponent("camera",{clearColorBuffer:!1,clearDepthBuffer:!1});var t=this,e=function(){t._checkAspectRatio()};window.addEventListener("resize",e,!1),this._checkAspectRatio(),this._modelsAabb=new BoundingBox,this._buildAabb(this.focusEntity||this.app.root,0),this.entity.lookAt(this._modelsAabb.center),this._pivotPoint=new Vec3,this._pivotPoint.copy(this._modelsAabb.center);var s=this.entity.getRotation();if(this._yaw=this._calcYaw(s),this._pitch=this._clampPitchAngle(this._calcPitch(s,this._yaw)),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0),this._distance=0,this._targetYaw=this._yaw,this._targetPitch=this._pitch,this.frameOnStart)this.focus(this.focusEntity||this.app.root);else{var i=new Vec3;i.sub2(this.entity.getPosition(),this._pivotPoint),this._distance=this._clampDistance(i.length())}this._targetDistance=this._distance,this.on("attr:distanceMin",(function(t,e){this._targetDistance=this._clampDistance(this._distance)})),this.on("attr:distanceMax",(function(t,e){this._targetDistance=this._clampDistance(this._distance)})),this.on("attr:pitchAngleMin",(function(t,e){this._targetPitch=this._clampPitchAngle(this._pitch)})),this.on("attr:pitchAngleMax",(function(t,e){this._targetPitch=this._clampPitchAngle(this._pitch)})),this.on("attr:focusEntity",(function(t,e){this.frameOnStart?this.focus(t||this.app.root):this.resetAndLookAtEntity(this.entity.getPosition(),t||this.app.root)})),this.on("attr:frameOnStart",(function(t,e){t&&this.focus(this.focusEntity||this.app.root)})),this.on("destroy",(function(){window.removeEventListener("resize",e,!1)})),this.on("reset",(function(){this._resetPosition()}))},a.prototype.update=function(t){var e=0===this.inertiaFactor?1:Math.min(t/this.inertiaFactor,1);this._distance=O.lerp(this._distance,this._targetDistance,e),this._yaw=O.lerp(this._yaw,this._targetYaw,e),this._pitch=O.lerp(this._pitch,this._targetPitch,e),this._updatePosition()},a.prototype._updatePosition=function(){this.entity.setLocalPosition(0,0,0),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0);var t=this.entity.getPosition();t.copy(this.entity.forward),t.scale(-this._distance),t.add(this.pivotPoint),this.entity.setPosition(t)},a.prototype._resetPosition=function(){this._targetPitch=0,this._targetYaw=-0,this._targetDistance=this.distanceDefault},a.prototype._removeInertia=function(){this._yaw=this._targetYaw,this._pitch=this._targetPitch,this._distance=this._targetDistance},a.prototype._checkAspectRatio=function(){var t=this.app.graphicsDevice.height,e=this.app.graphicsDevice.width;this.entity.camera.horizontalFov=t>e},a.prototype._buildAabb=function(t,e){var s=0,i=0,n=null,a=[],r=t.findComponents("render");for(s=0;s<r.length;++s)for(n=r[s].meshInstances,i=0;i<n.length;i++)a.push(n[i]);var o=t.findComponents("model");for(s=0;s<o.length;++s)for(n=o[s].meshInstances,i=0;i<n.length;i++)a.push(n[i]);for(s=0;s<a.length;s++)0===e?this._modelsAabb.copy(a[s].aabb):this._modelsAabb.add(a[s].aabb),e+=1;return e},a.prototype._calcYaw=function(t){var e=new Vec3;return t.transformVector(Vec3.FORWARD,e),Math.atan2(-e.x,-e.z)*O.RAD_TO_DEG},a.prototype._clampDistance=function(t){return this.distanceMax>0?O.clamp(t,this.distanceMin,this.distanceMax):Math.max(t,this.distanceMin)},a.prototype._clampPitchAngle=function(t){return O.clamp(t,-this.pitchAngleMax,-this.pitchAngleMin)},a.quatWithoutYaw=new Quat,a.yawOffset=new Quat,a.prototype._calcPitch=function(t,e){var s=a.quatWithoutYaw,i=a.yawOffset;i.setFromEulerAngles(0,-e,0),s.mul2(i,t);var n=new Vec3;return s.transformVector(Vec3.FORWARD,n),Math.atan2(n.y,-n.z)*O.RAD_TO_DEG},a},ju=({...t})=>{const{app:e}=t;var s=Hc("mouseInput",e);return s.attributes.add("orbitSensitivity",{type:"number",default:.3,title:"Orbit Sensitivity",description:"How fast the camera moves around the orbit. Higher is faster"}),s.attributes.add("distanceSensitivity",{type:"number",default:.15,title:"Distance Sensitivity",description:"How fast the camera moves in and out. Higher is faster"}),s.prototype.initialize=function(){if(this.orbitCamera=this.entity.script.orbitCamera,this.orbitCamera){var t=this,e=function(e){t.onMouseOut(e)};this.app.mouse.on(pc,this.onMouseDown,this),this.app.mouse.on(_c,this.onMouseUp,this),this.app.mouse.on(mc,this.onMouseMove,this),this.app.mouse.on(fc,this.onMouseWheel,this),window.addEventListener("mouseout",e,!1),this.on("destroy",(function(){this.app.mouse.off(pc,this.onMouseDown,this),this.app.mouse.off(_c,this.onMouseUp,this),this.app.mouse.off(mc,this.onMouseMove,this),this.app.mouse.off(fc,this.onMouseWheel,this),window.removeEventListener("mouseout",e,!1)}))}this.app.mouse.disableContextMenu(),this.lookButtonDown=!1,this.panButtonDown=!1,this.lastPoint=new Vec2},s.fromWorldPoint=new Vec3,s.toWorldPoint=new Vec3,s.worldDiff=new Vec3,s.prototype.pan=function(t){var e=s.fromWorldPoint,i=s.toWorldPoint,n=s.worldDiff,a=this.entity.camera,r=this.orbitCamera.distance;a.screenToWorld(t.x,t.y,r,e),a.screenToWorld(this.lastPoint.x,this.lastPoint.y,r,i),n.sub2(i,e),this.orbitCamera.pivotPoint.add(n)},s.prototype.onMouseDown=function(t){if("CANVAS"===t.event.target.tagName)switch(t.button){case 0:this.lookButtonDown=!0;break;case 1:case 2:this.panButtonDown=!0}},s.prototype.onMouseUp=function(t){switch(t.button){case 0:this.lookButtonDown=!1;break;case 1:case 2:this.panButtonDown=!1}},s.prototype.onMouseMove=function(t){Fc.mouse,this.lookButtonDown?(this.orbitCamera.pitch-=t.dy*this.orbitSensitivity,this.orbitCamera.yaw-=t.dx*this.orbitSensitivity):this.panButtonDown&&this.pan(t),this.lastPoint.set(t.x,t.y)},s.prototype.onMouseWheel=function(t){this.orbitCamera.distance-=t.wheel*this.distanceSensitivity*(.1*this.orbitCamera.distance),t.event.preventDefault()},s.prototype.onMouseOut=function(t){this.lookButtonDown=!1,this.panButtonDown=!1},s},Xu=({...t})=>{const{app:e}=t;var s=Hc("touchInput",e);return s.attributes.add("orbitSensitivity",{type:"number",default:.4,title:"Orbit Sensitivity",description:"How fast the camera moves around the orbit. Higher is faster"}),s.attributes.add("distanceSensitivity",{type:"number",default:.2,title:"Distance Sensitivity",description:"How fast the camera moves in and out. Higher is faster"}),s.prototype.initialize=function(){this.orbitCamera=this.entity.script.orbitCamera,this.lastTouchPoint=new Vec2,this.lastPinchMidPoint=new Vec2,this.lastPinchDistance=0,this.orbitCamera&&this.app.touch&&(this.app.touch.on(gc,this.onTouchStartEndCancel,this),this.app.touch.on(yc,this.onTouchStartEndCancel,this),this.app.touch.on(bc,this.onTouchStartEndCancel,this),this.app.touch.on(vc,this.onTouchMove,this),this.on("destroy",(function(){this.app.touch.off(gc,this.onTouchStartEndCancel,this),this.app.touch.off(yc,this.onTouchStartEndCancel,this),this.app.touch.off(bc,this.onTouchStartEndCancel,this),this.app.touch.off(vc,this.onTouchMove,this)})))},s.prototype.getPinchDistance=function(t,e){var s=t.x-e.x,i=t.y-e.y;return Math.sqrt(s*s+i*i)},s.prototype.calcMidPoint=function(t,e,s){s.set(e.x-t.x,e.y-t.y),s.scale(.5),s.x+=t.x,s.y+=t.y},s.prototype.onTouchStartEndCancel=function(t){var e=t.touches;1==e.length?this.lastTouchPoint.set(e[0].x,e[0].y):2==e.length&&(this.lastPinchDistance=this.getPinchDistance(e[0],e[1]),this.calcMidPoint(e[0],e[1],this.lastPinchMidPoint))},s.fromWorldPoint=new Vec3,s.toWorldPoint=new Vec3,s.worldDiff=new Vec3,s.prototype.pan=function(t){var e=s.fromWorldPoint,i=s.toWorldPoint,n=s.worldDiff,a=this.entity.camera,r=this.orbitCamera.distance;a.screenToWorld(t.x,t.y,r,e),a.screenToWorld(this.lastPinchMidPoint.x,this.lastPinchMidPoint.y,r,i),n.sub2(i,e),this.orbitCamera.pivotPoint.add(n)},s.pinchMidPoint=new Vec2,s.prototype.onTouchMove=function(t){var e=s.pinchMidPoint,i=t.touches;if(1==i.length){var n=i[0];this.orbitCamera.pitch-=(n.y-this.lastTouchPoint.y)*this.orbitSensitivity,this.orbitCamera.yaw-=(n.x-this.lastTouchPoint.x)*this.orbitSensitivity,this.lastTouchPoint.set(n.x,n.y)}else if(2==i.length){var a=this.getPinchDistance(i[0],i[1]),r=a-this.lastPinchDistance;this.lastPinchDistance=a,this.orbitCamera.distance-=r*this.distanceSensitivity*.1*(.1*this.orbitCamera.distance),this.calcMidPoint(i[0],i[1],e),this.pan(e),this.lastPinchMidPoint.copy(e)}},s};class SceneControls{constructor({...t}){const{name:e,camera:s}=t;this.name=e,this.camera=s||!1,this.controls={ui:Pd("<div></div>"),observers:{}},this.init()}init(){this.createControls()}getControls(t){return t?this.controls[t]:this.controls}createControls(){const t=document.createElement("DIV"),e=document.createElement("DIV"),s=new Label({enabled:!0,height:null,text:this.name.toUpperCase(),tabIndex:0,width:null});e.appendChild(s.dom),s.dom.style.color="#FF0000",e.style.marginTop=e.style.marginBottom="15px",t.appendChild(e);const i=document.createElement("DIV");if(!1!==this.camera){const t=document.createElement("DIV"),e=new Label({enabled:!0,height:null,text:"orbit camera",tabIndex:0,width:null});t.appendChild(e.dom),i.appendChild(t);const s=new Observer({progress:1}),n=new Button({enabled:!0,height:null,icon:"E401",size:"",tabIndex:0,text:"Reset",width:null});n.link(s,"progress"),i.appendChild(n.dom),n.on("click",(function(t){const e=s.get("progress");s.set("progress",-1*e)})),this.controls.observers.camera={idx:"camera",observer:s,type:"camera"}}t.appendChild(i),this.controls.ui.appendChild(t)}}class Scene{constructor({...t}){const{controls:e,app:s,count:i}=t;this.count=i,this.app=s,this.hasControls=!0===e,this.controls=null,this.init()}init(){this.createLight(),this.createScripts(),this.createControls()}getCamera(){return this.scripts.script.orbitCamera.entity}getLight(){return this.light}getScripts(){return this.scripts}resetCamera(){this.scripts.script.orbitCamera.fire("reset")}getControls(t){return this.controls.getControls(t)}createLight(){this.light=new Entity,this.light.name="light",this.light.addComponent("light",{type:"omni",color:new Color(1,1,1),castShadows:!1})}createScripts(){this.scripts=new Entity,this.scripts.name="scripts",this.scripts.addComponent("script"),this.scripts.script.create("orbitCamera",Gu({app:this.app,count:this.count,defaultZoom:20.1,canZoom:!1})),this.scripts.script.create("mouseInput",ju({app:this.app})),this.scripts.script.create("touchInput",Xu({app:this.app}))}createControls(){!0===this.hasControls&&(this.controls=new SceneControls({name:"scene",camera:void 0!==this.scripts.script.orbitCamera}))}}const qu={base:{blade1:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:0}},blade2:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:22.5}},blade3:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:45}},blade4:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:67.5}},blade5:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:90}},blade6:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:112.5}},blade7:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:135}},blade8:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:157.5}},blade9:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:180}},blade10:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:202.5}},blade11:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:225}},blade12:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:247.5}},blade13:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:270}},blade14:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:292.5}},blade15:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:315}},blade16:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:337.5}}},test_1:{blade1:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:0}},blade2:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:22.5}},blade3:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:45}},blade4:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:67.5}},blade5:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:90}},blade6:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:112.5}},blade7:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:135}},blade8:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:157.5}},blade9:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:180}},blade10:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:202.5}},blade11:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:225}},blade12:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:247.5}},blade13:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:270}},blade14:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:292.5}},blade15:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:315}},blade16:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:1,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:180,y:0,z:337.5}}},test_2:{blade1:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:.44,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:-21.5}},blade2:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:.44,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:-8.99}},blade3:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:.44,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:5.04}},blade4:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:.44,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:16.98}},blade5:{morphing:{m_Cutout_Left:0,m_Cutout_Center:.44,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:67.17}},blade6:{morphing:{m_Cutout_Left:0,m_Cutout_Center:.44,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:80.15}},blade7:{morphing:{m_Cutout_Left:0,m_Cutout_Center:.44,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:96.18}},blade8:{morphing:{m_Cutout_Left:0,m_Cutout_Center:.44,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:109.17}},blade9:{morphing:{m_Cutout_Left:.44,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:158.69}},blade10:{morphing:{m_Cutout_Left:.44,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:168.63}},blade11:{morphing:{m_Cutout_Left:.44,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:187.56}},blade12:{morphing:{m_Cutout_Left:.44,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:203.74}},blade13:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:.44,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:253.26}},blade14:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:.44,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:263.2}},blade15:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:.44,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:277.47}},blade16:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:.44,m_CoreDefault_Tip_S:.62,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:146.13,y:155.26,z:292.21}}},test_3:{blade1:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:.71,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:.6,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:164.4}},blade2:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-337.5}},blade3:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-315}},blade4:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-292.5}},blade5:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-270}},blade6:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-247.5}},blade7:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-225}},blade8:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-202.5}},blade9:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-180}},blade10:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-157.5}},blade11:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-135}},blade12:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-112.5}},blade13:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-90}},blade14:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-67.5}},blade15:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-45}},blade16:{morphing:{m_Cutout_Left:0,m_Cutout_Center:0,m_Cutout_Right:0,m_Cutout_Stepped:0,m_CoreDefault_Tip_S:0,m_CoreLarge_Tip_L:0,m_CoreLarge_Tip_S:0,m_CoreSmall_Tip_L:0,m_CoreSmall_Tip_S:0},rotation:{x:0,y:0,z:-22.5}}}};class StatesControls{constructor({...t}){const{name:e,states:s,bladeRotationOffset:i,bladeRotation:n}=t;this.name=e,this.states=s||{},this.controls={ui:Pd("<div></div>"),observers:{}},this.init()}init(){this.createControls()}getControls(t){return t?this.controls[t]:this.controls}createControls(){const t=document.createElement("DIV"),e=document.createElement("DIV"),s=new Label({enabled:!0,height:null,text:this.name.toUpperCase(),tabIndex:0,width:null});e.appendChild(s.dom),s.dom.style.color="#FF0000",e.style.marginTop=e.style.marginBottom="15px",t.appendChild(e);const i=document.createElement("DIV"),n=this.states;for(let c in n){const t=document.createElement("DIV"),e=new Label({enabled:!0,height:null,text:"preset state: "+c,tabIndex:0,width:null});t.appendChild(e.dom),i.appendChild(t);const s=new Observer({progress:1}),n=new Button({enabled:!0,height:null,icon:"E401",size:"",tabIndex:0,text:"Run",width:null});n.link(s,"progress"),i.appendChild(n.dom),n.on("click",(function(t){const e=s.get("progress");s.set("progress",-1*e)})),this.controls.observers[c]={idx:c,observer:s,type:"state"}}t.appendChild(i);const a=document.createElement("DIV"),r=new Label({enabled:!0,height:null,text:"new state:",tabIndex:0,width:null});a.appendChild(r.dom),r.dom.style.color="#00FF00",a.style.marginTop="15px",t.appendChild(a);const o=new Observer({progress:1}),l=document.createElement("DIV"),h=new Button({enabled:!0,height:null,icon:"E401",size:"",tabIndex:0,text:"Add current",width:null});h.link(o,"progress"),l.style.marginBottom="15px",l.appendChild(h.dom),t.appendChild(l),h.on("click",(function(t){const e=o.get("progress");o.set("progress",-1*e)})),this.controls.observers.append={idx:0,observer:o,type:"append"},this.controls.ui.appendChild(t)}addStateControl(t){const e=document.createElement("DIV"),s=document.createElement("DIV"),i=document.createElement("DIV"),n=new Label({enabled:!0,height:null,text:"new state: "+t,tabIndex:0,width:null});i.appendChild(n.dom),s.appendChild(i);const a=new Observer({progress:1,tojson:1}),r=new Button({enabled:!0,height:null,icon:"E401",size:"",tabIndex:0,text:"Run",width:null});r.link(a,"progress"),s.appendChild(r.dom),r.on("click",(function(t){const e=a.get("progress");a.set("progress",-1*e)})),this.controls.observers[t]={idx:t,observer:a,type:"state"};const o=new Button({enabled:!0,height:null,icon:"E401",size:"",tabIndex:0,text:"Export",width:null});o.link(a,"tojson"),s.appendChild(o.dom),o.on("click",(function(t){const e=a.get("tojson");a.set("tojson",-1*e)})),this.controls.observers[t]={idx:t,observer:a,type:"state"},e.appendChild(s),this.controls.ui.appendChild(e)}}class States{constructor({...t}){const{controls:e}=t;var s,i;this.states=(s=qu,i=function(t){return{preset:t,time:0,duration:500}},Object.fromEntries(Object.entries(s).map((([t,e],s)=>[t,i(e,t,s)])))),this.hasControls=!0===e,this.controls=null,this.init()}init(){this.createControls()}setState(t,e){this.states[t]={preset:e,time:0,duration:500},!0===this.hasControls&&this.controls.addStateControl(t)}getState(t){return this.states[t]}getControls(t){return this.controls.getControls(t)}createControls(){!0===this.hasControls&&(this.controls=new StatesControls({name:"states",states:this.states}))}}return class MetaWim{constructor({...t}){const{canvas:e,ui:s,count:i}=t;this.ui=s||null;const n=e.getContext("webgl2",{alpha:!0,antialias:!0,powerPreference:"high-performance"});this.app=new Application(e,{mouse:new Mouse(e),touch:new TouchDevice(e),graphicsDeviceOptions:n}),this.app.root.name="MetaWim",this.count=i||16,this.rotationOffset=90,this.rotationStep=Ad(360/this.count),this.scene=new Scene({app:this.app,count:this.count,controls:null!==this.ui}),this.app.scene.ambientLight=new Color(1,1,1),this.blades={},this.meshMorphsIndex=Md,this.allcontrols=null,this.states=new States({controls:null!==this.ui}),this.lastState={},this.init(),this.start()}init(){this.setupCanvas(),this.createBlades(),this.createAllControls()}start(){this.app.root.addChild(this.scene.getLight()),this.app.root.addChild(this.scene.getScripts()),this.addBlades(),this.addControls(),this.app.start()}update(t){}setupCanvas(){this.app.setCanvasFillMode("NONE"),this.app.setCanvasResolution(Po)}createBlades(){let t,e,s=0;for(var i=1;i<=this.count;i++)e="blade"+i,t=new Blade({name:e,index:i,layers:this.app.scene.layers,graphicsDevice:this.app.graphicsDevice,controls:null!==this.ui,meshMorphsIndex:this.meshMorphsIndex,bladeRotationStep:this.rotationStep,bladeRotationOffset:this.rotationOffset,bladeRotation:{x:0,y:0,z:s}}),s+=this.rotationStep,this.blades[e]=t}createAllControls(){null!==this.ui&&(this.allcontrols=new BladeControls({name:"all",meshMorphsIndex:this.meshMorphsIndex,bladeRotationOffset:this.rotationOffset,bladeRotation:{x:0,y:0,z:0}}))}addBlades(){for(let t in this.blades)this.app.root.addChild(this.blades[t].getEntity())}addControls(){if(null!==this.ui){const e=this.scene.getControls("observers");for(let t in e)e[t].observer.on("progress:set",function(t,e){if("camera"===this.type)this.scope.scene.resetCamera()}.bind({scope:this,type:e[t].type,idx:e[t].idx,id:t}));this.ui.appendChild(this.scene.getControls("ui"));const s=this.states.getControls("observers");for(let t in s)s[t].observer.on("progress:set",function(t,e){switch(this.type){case"append":this.scope.addCurrentState();break;case"state":this.scope.setupStateCallback(this.idx)}}.bind({scope:this,type:s[t].type,idx:s[t].idx,id:t}));this.ui.appendChild(this.states.getControls("ui"));const i=this.allcontrols.getControls("observers");for(let t in i)i[t].observer.on("progress:set",function(t,e){switch(this.type){case"morph":for(let e in this.scope.blades)this.scope.blades[e].updateMorphtarget(this.idx,t,this.id);break;case"rotation":for(let e in this.scope.blades){const s=Ad((this.scope.blades[e].getBladeRotation(this.idx)+t)%360);this.scope.blades[e].setRotation({[this.idx]:s},this.id)}}}.bind({scope:this,type:i[t].type,idx:i[t].idx,id:t}));this.ui.appendChild(this.allcontrols.getControls("ui"));const n=function(t,e){const s="desc"===e.toLowerCase()?-1:1;return t.sort(((t,e)=>t>e?1*s:-1*s))}(Object.keys(this.blades).map((t=>parseInt(t.replace("blade","")))),"DESC");for(var t=n.length-1;t>=0;t--){const e="blade"+n[t].toString(),s=this.blades[e].getControls("observers");for(let t in s)s[t].observer.on("progress:set",function(t,s){switch(this.type){case"morph":this.scope.blades[e].updateMorphtarget(this.idx,t);break;case"rotation":this.scope.blades[e].setRotation({[this.idx]:t})}}.bind({scope:this,type:s[t].type,idx:s[t].idx}));this.ui.appendChild(this.blades[e].getControls("ui"))}}}getCurrentState(){const t={};for(let e in this.blades){const s=this.blades[e].getStateRotation(),i=this.blades[e].getStateMorphing();t[e]={morphing:{...i},rotation:{...s}}}return t}addCurrentState(){const t={};for(let n in this.blades){const e=this.blades[n].getStateRotation(),s=this.blades[n].getStateMorphing();t[n]={morphing:{...s},rotation:{...e}}}const e="_"+Math.floor((new Date).getTime()/1e3);this.states.setState(e,t);const s=this.states.getControls("observers"),i=e;s[i].observer.on("tojson:set",function(t,e){this.scope.exportState(this.id)}.bind({scope:this,id:i})),s[i].observer.on("progress:set",function(t,e){if("state"===this.type)this.scope.setupStateCallback(this.idx)}.bind({scope:this,type:s[i].type,idx:s[i].idx,id:i}))}exportState(t){const e=this.states.getState(t);console.info("Copy the object to some key (e.g.: "+t+") of the presetStates object in the ./presets module\n",e),function(t,e){const s=document.createElement("a");s.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),s.target="_blank",s.download=t+".json",s.click()}(t,{[t]:e})}setupStateCallback(t){this.app.off();const e=this.getCurrentState(),s=this.states.getState(t);this.app.on("update",(function(t){try{this.time=Math.min(Ad(this.time+1e3*t),this.state.duration);const e=this.time/this.state.duration;for(let t in this.state.preset)for(let s in this.state.preset[t])switch(s){case"morphing":for(let n in this.state.preset[t][s]){const i=this.origin[t].morphing[n],a=this.state.preset[t][s][n];let r=Ad(a-i);const o=Ad(e*r),l=Ad(i+o);this.scope.blades[t].updateMorphtarget(n,l,n)}break;case"rotation":const i={};for(let n in this.state.preset[t][s]){const a=this.origin[t].rotation[n],r=this.state.preset[t][s][n];let o=Ad(r-a);o>0&&(o=Ad(r-(360+a)));const l=Ad(e*o),h=Ad((a+l)%360);i[n]=h}this.scope.blades[t].setRotation(i,Object.keys(i))}this.time>=this.state.duration&&this.scope.app.off()}catch(e){console.warn("state timer error",e),this.scope.app.off()}}),{scope:this,time:0,state:s,origin:e})}}}();
